<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>EPhone</title>
    <style>
              @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
        html {
            -webkit-text-size-adjust: 100%;
            height: 100%; 
        }
        body {
            margin: 0;
            font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: normal;
            background-color: #f0f2f5;
            height: 100%; 
            overflow: hidden; 
        }
        #phone-screen {
            width: 100%;
            height: 100vh; 
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #ffffff; 
        }
        #chat-input-area {
            flex-shrink: 0;
            padding: 8px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
#status-bar {
    display: none;
    padding: 0 20px;
    height: 40px;
    color: white;
    background-color: transparent; 
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    z-index: 100;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    pointer-events: none; 
}
#phone-screen.status-bar-visible #status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
        .header, .qzone-header {
            position: relative;
            z-index: 15;
            flex-shrink: 0;
            padding: 15px 20px;
            padding-top: calc(15px + env(safe-area-inset-top)); 
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }
        #status-bar { 
            display: none; 
        }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { 
    display: flex; 
    align-items: center; 
    gap: 15px; 
    position: relative; /* Êñ∞Â¢ûÔºöÂàõÂª∫Â†ÜÂè†‰∏ä‰∏ãÊñá */
    z-index: 1;         /* Êñ∞Â¢ûÔºöÁ°Æ‰øùÂÆÉÂú®Ê†áÈ¢òspan‰πã‰∏ä */
}
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }
        .header .action-btn {
            font-size: 16px; 
            font-weight: 600; 
        }
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            padding-left: 20px;
            padding-right: 20px;
        }
        #clock-container {
            text-align: center;
            color: white;
            text-shadow: 0 3px 8px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            flex-shrink: 0;
            margin-top: calc(60px + env(safe-area-inset-top));
        }
        #app-grid {
            margin-top: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 20px;
            margin-bottom: calc(30px + env(safe-area-inset-bottom)); 
        }
        #main-time {
            font-size: 88px; 
            font-weight: 600; 
            letter-spacing: -2px; 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif;
        }
        #main-date { 
            font-size: 22px; 
            font-weight: normal; 
        }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        #world-book-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            padding-top: 80px;
            margin-top: -80px;
        }
        #chat-list {
            flex-grow: 1;
            background-color: var(--secondary-bg);
            padding-top: 80px; 
            padding-bottom: 90px; 
            box-sizing: border-box;
        }
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden; 
            padding: 10px 15px; 
            padding-top: 110px;
            margin-top: -80px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box; 
        }
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        .message-wrapper.ai .sender-name {
            margin-left: 50px; 
            margin-bottom: 3px;
            position: absolute; 
            top: -16px;       
            left: 0;
        }
        .message-wrapper {
            display: flex;          
            gap: 8px;               
            align-items: flex-end;  
            position: relative;
            max-width: 90%;         
        }
        .message-wrapper.ai {
            align-self: flex-start;
            flex-direction: row; 
        }
        .message-wrapper.user {
            align-self: flex-end;
            flex-direction: row-reverse; 
        }
        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
            min-width: 0; 
        }
        .timestamp {
            font-size: 11px;
            color: #999;
            text-shadow: 0 0 3px rgba(255,255,255,0.6);
            white-space: nowrap; 
            margin-bottom: 5px;  
            flex-shrink: 0;      
        }
        .message-bubble.selected::after { content: '‚úî'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-list-bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 15;
            display: flex;
            border-top: 1px solid var(--border-color);
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding-bottom: env(safe-area-inset-bottom);
        }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
#chat-input {
    flex-grow: 1;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    background-color: var(--secondary-bg);
    font-size: 16px;
    height: 40px; 
    resize: none;
    overflow-y: auto; 
    box-sizing: border-box; 
}
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: 0; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            visibility: hidden;
        }
        #notification-bar.visible {
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
.sticker-item {
    position: relative;
    display: flex;
    flex-direction: column; 
    align-items: center;    
    gap: 6px;               
    cursor: pointer;
}
.sticker-image-container {
    width: 100%;
    aspect-ratio: 1 / 1;    
    background-color: white;
    border-radius: 10px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.sticker-name {
    font-size: 12px;           
    color: var(--text-secondary); 
    width: 100%;               
    text-align: center;        
    white-space: nowrap;       
    overflow: hidden;          
    text-overflow: ellipsis;   
}
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: var(--secondary-bg); width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input {
            width: 100%;
            padding: 8px 12px; 
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px; 
            box-sizing: border-box;
        }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect {
            position: relative;
            -webkit-user-select: none; 
            user-select: none;
        }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: var(--secondary-bg); cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
       .checkboxes-container {
    display: none;
    position: absolute;
    top: 100%; 
    margin-top: 5px; 
    left: 0;
    right: 0;
    max-height: 150px;
    overflow-y: auto;
    background-color: var(--secondary-bg); /* <-- ‰øÆÊîπÂêé */
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        .checkboxes-container label {
            display: block;
            padding: 12px 15px; 
            cursor: pointer;
            font-weight: normal;
            color: var(--text-primary);
            font-size: 15px; 
        }
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: var(--secondary-bg); border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        /* RealImag/NovelAIÂõæÁâáÂú®ÁßÅËÅä/Áæ§ËÅäÊ∂àÊÅØÊ∞îÊ≥°ÈáåÁöÑÊ†∑Âºè */
        .realimag-image {
            max-width: 250px;
            max-height: 250px;
            width: auto;
            height: auto;
            display: block;
            border-radius: 10px;
            object-fit: cover;
            background-color: #f8f8f8;
            min-width: 100px;
            min-height: 100px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .realimag-image:hover {
            transform: scale(1.02);
        }
        
        .message-bubble.is-realimag .content {
            padding: 5px;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration {
            font-size: var(--chat-font-size, 13px);
            font-weight: 500;
            color: var(--text-secondary);
        }
        .message-bubble.user .voice-duration { color: #3e6224; }
        .message-bubble .content {
            position: relative;
            font-size: var(--chat-font-size, 16px);
            padding: 8px 12px;
            line-height: 1.5;
            word-break: break-word; 
        }
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
        .message-bubble::after {
            content: "";
            position: absolute;
            width: 20px;  
            height: 20px; 
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 1; 
            z-index: 1;
        }
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: var(--secondary-bg); font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'üêæ'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
       .playlist-body {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px 0 80px 0;
    box-sizing: border-box;
}
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }
        #font-preview {
            transition: font-family 0.3s ease;}
        #chat-list-screen {
        }
        .chat-list-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1; 
        }
        .chat-list-view.active {
            opacity: 1;
            visibility: visible;
            z-index: 2; 
        }
        #messages-view {
            overflow-y: auto; 
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--accent-color);
            font-weight: 600;
        }
        #qzone-screen {
            background-color: #f0f2f5;
        }
        .qzone-header {
            position: relative;
            z-index: 10; 
            flex-shrink: 0; 
            padding: 15px 20px;
            padding-top: 45px;
            background-color: rgba(247, 247, 247, 0.7); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }
        .qzone-header .back-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--accent-color);
        }
        .qzone-header span:nth-child(2) { 
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .qzone-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .qzone-profile-header {
            position: relative;
            margin-bottom: 20px;
        }
        .qzone-banner-container {
            width: 100%;
            height: 180px; 
            position: relative;
        }
        #qzone-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .qzone-user-info {
            position: absolute;
            bottom: -30px; 
            left: 20px;
            display: flex;
            align-items: flex-end; 
            gap: 10px;
        }
        .qzone-avatar-container {
            position: relative;
        }
        #qzone-avatar-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: cover;
        }
        #qzone-nickname {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            padding-bottom: 5px; 
        }
        .qzone-edit-btn {
            position: absolute;
            background-color: rgba(0,0,0,0.4);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        #change-qzone-banner-btn {
            bottom: 10px;
            right: 10px;
        }
        #change-qzone-avatar-btn {
            bottom: 5px;
            right: 5px;
        }
        #change-qzone-nickname-btn {
            font-size: 14px;
            padding: 2px 6px;
            margin-left: 5px; 
            color: var(--text-primary);
            background-color: rgba(255,255,255,0.7);
            border-radius: 5px;
            position: relative; 
            bottom: 5px; 
        }
        #qzone-banner-container,
        #qzone-avatar-container,
        #qzone-nickname {
            cursor: pointer; 
            transition: opacity 0.2s;
        }
        #qzone-banner-container:hover,
        #qzone-avatar-container:hover,
        #qzone-nickname:hover {
            opacity: 0.85; 
        }
        .qzone-edit-btn {
            display: none;
        }
        #qzone-screen .qzone-header {
            display: none;
        }
        #qzone-screen.active .qzone-header {
            display: flex;
        }
        #chat-list-screen.in-qzone-view > .header,
        #chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
            display: none;
        }
        .chat-list-item:first-child,
        .chat-group-container:first-child {
            margin-top: 10px; 
        }
        .qzone-actions-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            margin: 40px 15px 15px 15px; 
            background-color: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .action-item {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 0;
            position: relative;
        }
        .action-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 20px;
            background-color: var(--border-color);
        }
        #qzone-posts-list {
            padding: 0 15px 20px 15px; 
            display: flex;
            flex-direction: column;
            gap: 20px; 
        }
        .qzone-post-item {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .post-header .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .post-info {
            display: flex;
            flex-direction: column;
        }
        .post-info .post-nickname {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        .post-info .post-timestamp {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .post-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap; 
            word-break: break-word; 
        }
        #post-public-text {
            min-height: 80px; 
            resize: vertical;
        }
        .post-image-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9; 
            background-color: #f0f2f5;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            display: none; 
            justify-content: center;
            align-items: center;
        }
        .post-image-preview-container.visible {
            display: flex; 
        }
        #post-image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        #post-remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff3b30;
            color: white;
            border: 2px solid white;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        .post-image-upload-options {
            display: flex;
            gap: 10px;
        }
        .post-image-upload-options button {
            flex: 1;
            margin-top: 0;
        }
        .post-mode-switcher {
            display: flex;
            margin-bottom: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 4px;
        }
        .mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background-color: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .mode-btn.active {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .post-mode-content {
            display: none; 
        }
        .post-mode-content.active {
            display: block; 
        }
        #album-screen {
            background-color: #f0f2f5; 
        }
        #album-grid-page {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
        }
        .album-item {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 8px; 
        }
        .album-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .album-cover {
            aspect-ratio: 1 / 1; 
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f0f2f5; 
        }
        .album-info {
            text-align: center;
        }
        .album-name {
            font-weight: 500;
            margin: 0 0 4px 0;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .album-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        #album-photos-screen {
            background-color: #f0f2f5;
        }
        #photos-grid-page {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .photo-item {
            position: relative; 
            aspect-ratio: 1 / 1; 
            border-radius: 6px;
            overflow: hidden; 
            background-color: #e9ecef; 
        }
        .photo-item .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            cursor: pointer;
        }
        .photo-item .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0; 
            transition: opacity 0.2s ease;
        }
        .photo-item:hover .photo-delete-btn {
            opacity: 1;
        }
        #photo-viewer-modal {
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1002;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }
        .photo-viewer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        #photo-viewer-image {
            max-width: 90vw;  
            max-height: 85vh; 
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: opacity 0.2s ease-in-out;
        }
        #photo-viewer-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            font-weight: 200;
            cursor: pointer;
            line-height: 1;
            text-shadow: 0 0 5px black;
        }
        #photo-viewer-modal .nav-arrow {
            position: absolute; 
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 50px; 
            font-weight: 100;
            cursor: pointer;
            padding: 10px; 
        -webkit-user-select: none; 
            user-select: none;
            transition: color 0.2s;
            z-index: 1003; 
        }
        #photo-viewer-prev-btn {
            left: 5px; 
        }
        #photo-viewer-next-btn {
            right: 5px; 
        }
        #photo-viewer-modal .nav-arrow:hover {
            color: white;
        }
        #photo-viewer-modal .nav-arrow:disabled {
            color: rgba(255, 255, 255, 0.2);
            cursor: default;
        }
        .post-main-content {
        }
        .post-feedback-icons {
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            gap: 12px;
            padding: 8px 0; 
        }
        .action-icon {
            cursor: pointer;
            color: var(--text-secondary); 
            transition: all 0.2s ease-in-out;
        }
        .action-icon svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .action-icon.active {
            color: #ff5252; 
            transform: scale(1.1); 
        }
        .action-icon.active.favorite {
            color: #ffc107; 
        }
        .action-icon.active svg {
            fill: currentColor; 
        }
        .animate-like {
            animation: like-bounce 0.4s ease-in-out;
        }
        @keyframes like-bounce {
            0%   { transform: scale(1); }
            25%  { transform: scale(0.8); }
            50%  { transform: scale(1.2); }
            75%  { transform: scale(1.05); }
            100% { transform: scale(1.1); }
        }
        .post-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0; 
            display: flex;
            align-items: center;
            gap: 8px; 
        }
        .comment-section {
            flex-grow: 1; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .comment-section .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .comment-section {
            position: relative; 
        }
        .comment-section .comment-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background-color: #f0f2f5;
            border-radius: 14px;
            font-size: 16px; 
            outline: none;
        }
        .comment-send-btn {
            flex-shrink: 0; 
            padding: 8px 15px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 14px;
            font-size: 16px; 
            font-weight: 500;
            cursor: pointer;
        }
        .unread-indicator {
            position: absolute;
            top: -8px;      
            right: -15px;    
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background-color: #ff3b30;
            color: white;
            font-size: 11px;
            font-weight: bold;
            line-height: 18px;
            text-align: center;
            border-radius: 9px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            display: none;
            z-index: 1;
        }
        .back-btn-indicator {
            top: 0;
            right: -8px; 
            width: 10px;
            height: 10px;
            min-width: 10px;
            padding: 0;
            border-radius: 50%;
        }
        .post-comments-container {
            padding: 10px 0; 
            display: flex;
            flex-direction: column;
            gap: 8px; 
            font-size: 13px; 
        }
        .comment-item {
            line-height: 1.5;
        }
        .comment-item .commenter-name {
            font-weight: 600;
            color: var(--accent-color);
            cursor: pointer;
            margin-right: 5px; 
        }
        .comment-item .comment-text {
            color: var(--text-primary);
            word-break: break-word;
        }
        .post-likes-section {
            display: flex;
            align-items: center;
            gap: 6px; 
            padding: 8px 10px; 
            font-size: 13px;
            color: var(--accent-color); 
            background-color: #f0f5fa; 
            border-top: 1px solid #e9eef3;
            border-bottom: 1px solid #e9eef3;
            margin-top: 5px; 
        }
        .post-likes-section .like-icon {
            width: 16px;
            height: 16px;
            fill: currentColor; 
            flex-shrink: 0; 
        }
        .at-mention-popup {
            position: absolute; 
            bottom: 100%; 
            left: 40px; 
            width: calc(100% - 40px); 
            max-height: 120px;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            z-index: 10;
            display: none; 
        }
        .at-mention-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-primary);
            border-bottom: 1px solid #f0f0f0;
        }
        .at-mention-item:last-child {
            border-bottom: none;
        }
        .at-mention-item:hover {
            background-color: #f5f5f5;
        }
        #favorites-view {
            display: flex;
            flex-direction: column;
        }
        #favorites-view > .header {
            flex-shrink: 0;
        }
        #favorites-list {
            flex-grow: 1; 
            overflow-y: auto; 
            overflow-x: hidden; 
            padding: 15px; 
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }
        .favorite-item-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            position: relative; 
        }
        .fav-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .fav-card-header .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        .fav-card-header .info {
            flex-grow: 1;
        }
        .fav-card-header .name {
            font-weight: 600;
            font-size: 15px;
        }
        .fav-card-header .source {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .fav-card-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .fav-card-content .chat-image {
            margin-top: 8px; 
        }
        .fav-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: #f0f2f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 28px;
            text-align: center;
        }
        .fav-delete-btn:hover {
            background-color: #e9ecef;
            color: #ff3b30;
        }
        .search-bar-container {
            padding: 10px 15px;
            background-color: #f9f9f9; 
            position: relative; 
            flex-shrink: 0;
        }
        #favorites-search-input {
            width: 100%;
            padding: 10px 30px 10px 15px; 
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 18px; 
            background-color: var(--secondary-bg);
            box-sizing: border-box;
            outline: none;
        }
        #favorites-search-input:focus {
            border-color: var(--accent-color);
        }
        .search-clear-btn {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }
        #chat-interface-screen .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #chat-interface-screen .selection-controls .action-btn {
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 5px;
        }
        #favorites-view.selection-mode .favorite-item-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .favorite-item-card::before {
            content: '';
            position: absolute;
            left: -25px; 
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            background-color: white;
            transition: all 0.2s ease;
            opacity: 0; 
        }
        #favorites-view.selection-mode .favorite-item-card {
            transform: translateX(35px);
        }
        #favorites-view.selection-mode .favorite-item-card::before {
            opacity: 1;
        }
        #favorites-view.selection-mode .favorite-item-card.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: '‚úî';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        #favorites-action-bar {
            position: absolute; 
            bottom: 0;
            left: 0;
            right: 0;           
            width: auto;        
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            box-sizing: border-box;
            z-index: 5;
            display: none;
        }
        #favorites-action-bar .action-bar-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        #chat-interface-screen .header .selection-controls {
            display: none;
        }
        #chat-interface-screen .header .default-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #chat-interface-screen.selection-mode .header .default-controls {
            display: none;
        }
        #chat-interface-screen.selection-mode .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #add-chat-btn,
        #add-world-book-btn,
        #create-album-btn-page {
            font-size: 28px;   
            font-weight: 300;  
            position: relative;
            top: -1px;         
        }
        #settings-preview-area {
            width: 100%;
            height: 180px; 
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            border: 1px solid var(--border-color);
            position: relative; 
        }
        #settings-preview-area::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
            opacity: 0.8;
        }
        #settings-preview-area .message-wrapper {
            position: relative;
            z-index: 2;
        }
        #settings-preview-area .message-bubble .avatar {
            width: 30px;
            height: 30px;
        }
        #settings-preview-area .message-bubble .timestamp {
            display: none; 
        }
        .existing-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .existing-group-item .group-name {
            font-weight: 500;
        }
        .existing-group-item .delete-group-btn {
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        .chat-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .chat-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        .chat-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        .chat-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        .chat-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        .chat-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        .chat-group-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .chat-group-content.collapsed {
            max-height: 0;
        }
        .format-helpers {
            display: flex;
            gap: 10px;
            margin-bottom: 15px; 
            flex-wrap: wrap; 
        }
        .format-btn {
            background-color: #e9ecef;
            color: var(--text-primary);
            border: none;
            padding: 6px 12px;
            border-radius: 16px; 
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .format-btn:hover {
            background-color: #dcdfe3;
        }
        .post-actions-btn {
            margin-left: auto; 
            padding: 5px 10px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            line-height: 1;
        }
        .post-actions-btn:hover {
            background-color: #f0f0f0;
        }
        #post-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            border-bottom: 1px solid #dbdbdb;
            padding: 14px;
            font-size: 18px;
        }
        #post-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }
        #post-actions-modal #cancel-post-action-btn {
            margin-top: 8px;
            border-radius: 8px;
            background-color: #f0f0f0;
        }
        #chat-messages .transfer-card .transfer-title,
        #chat-messages .transfer-card .transfer-amount,
        #chat-messages .transfer-card .transfer-note {
            text-shadow: none !important; 
            color: white !important;      
        }
        #chat-messages .transfer-card .transfer-title {
            font-size: 16px !important;
            font-weight: 600 !important;
        }
        #chat-messages .transfer-card .transfer-amount {
            font-size: 28px !important;
            font-weight: bold !important;
        }
        #chat-messages .transfer-card .transfer-note {
            font-size: 13px !important;
            opacity: 0.9 !important;
        }
        .header > span:nth-child(2),
        #chat-header-title {
            position: absolute;
            left: 50%;
            transform: translateX(calc(-50% - 2px)); 
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #message-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        .message-editor-block textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .message-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; 
        }
        .message-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: '‚úî';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .contact-picker-item .name {
            font-weight: 500;
        }
        #member-management-list {
            padding: 0; 
        }
        .member-management-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .member-management-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        .member-management-item .name {
            flex-grow: 1;
            font-weight: 500;
        }
        .member-management-item .remove-member-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        #member-management-actions {
            flex-shrink: 0;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #member-management-actions button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        #member-management-actions #create-new-member-btn {
            background-color: #4cd964; 
        }
        .waimai-card {
            width: 240px;
            border-radius: 12px;
            overflow: hidden;
            background-color: var(--secondary-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .waimai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .waimai-header .icon {
            width: 20px;
            height: 20px;
        }
        .waimai-header .title-group {
            display: flex;
            align-items: baseline;
            font-size: 14px;
            color: #8a8a8a;
        }
        .waimai-header .title-group .brand {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }
        .waimai-header .title-group .separator {
            margin: 0 5px;
        }
        .waimai-catchphrase {
            font-size: 13px;
            color: #1f1f1f;
            padding: 12px;
        }
        .waimai-main {
            background-color: #FFD66B; 
            padding: 12px;
            text-align: center;
        }
        .waimai-main .request-title {
            font-size: 12px;
            color: #856404;
            margin-bottom: 8px;
        }
        .waimai-main .payment-box {
            background-color: var(--secondary-bg);
            border-radius: 8px;
            padding: 15px 10px;
        }
        .waimai-main .payment-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        .waimai-main .amount {
            font-size: 32px;
            font-weight: 700;
            color: #1f1f1f;
            margin: 4px 0 12px 0;
        }
        .waimai-main .countdown-label {
            font-size: 13px;
            color: #8a8a8a;
        }
        .waimai-main .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 5px;
        }
        .waimai-main .countdown-timer span {
            background-color: #333;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
            font-size: 12px;
        }
        .waimai-details-btn {
            width: 100%;
            padding: 10px 0;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            background-color: #FFC33A;
            color: #49380a;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .message-bubble.status-paid .waimai-card {
            border: 2px solid #28a745; 
        }
        .message-bubble.status-paid .waimai-main .request-title::before {
            content: '‚úÖ  ';
        }
        .message-bubble.status-paid .waimai-main .request-title {
            color: #155724;
            font-weight: 600;
            content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû" !important;
            display: block;
            margin-bottom: 15px;
        }
        .message-bubble.status-paid .payment-box {
            display: none; 
        }
        .message-bubble.status-paid .waimai-details-btn {
            background-color: #28a745;
            color: white;
        }
        .message-bubble.status-rejected .waimai-card {
            border: 2px solid #dc3545; 
            opacity: 0.8;
        }
        .message-bubble.status-rejected .waimai-main {
            background-color: #e9ecef;
        }
        .message-bubble.status-rejected .waimai-main .request-title::before {
            content: '‚ùå ';
        }
        .message-bubble.status-rejected .waimai-main .request-title {
            color: #721c24;
            font-weight: 600;
            content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç" !important;
            display: block;
            margin-bottom: 15px;
        }
        .message-bubble.status-rejected .payment-box {
            display: none; 
        }
         .message-bubble.status-rejected .waimai-details-btn {
            background-color: #6c757d;
            color: white;
        }
        .message-bubble[class*="status-"] .request-title {
            font-size: 0; 
        }
        .message-bubble[class*="status-"] .request-title::after {
            font-size: 14px; 
        }
        .message-bubble.status-paid .request-title::after {
            content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû";
        }
        .message-bubble.status-rejected .request-title::after {
            content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç";
        }
        .waimai-user-actions {
            display: flex;
            gap: 10px;
            padding: 0 12px 12px 12px; 
            background-color: var(--secondary-bg);
        }
        .waimai-user-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .waimai-pay-btn {
            background-color: #28a745;
            border-color: #1f7a33;
            color: white;
        }
        .waimai-pay-btn:hover {
            background-color: #218838;
        }
        .waimai-decline-btn {
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #495057;
        }
        .waimai-decline-btn:hover {
            background-color: #e2e6ea;
        }
        #api-settings-screen,
        #font-settings-screen,
        #wallpaper-screen,
        #memories-view,
        #contact-picker-screen,
        #member-management-screen,
        #world-book-editor-screen {  
            background-color: var(--secondary-bg);
        }
        #api-settings-screen .form-container,
        #font-settings-screen .form-container,
        #wallpaper-screen .form-container {
            padding-top: 100px;
            margin-top: -80px;
            background-color: var(--secondary-bg);
        }
        #wallpaper-screen .form-container {
            align-items: center; 
        }
        #incoming-call-modal .incoming-call-content {
            background-color: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 280px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .caller-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid rgba(255,255,255,0.5);
        }
        .caller-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .caller-text {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
        }
        .incoming-call-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .action-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        .call-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .call-action-btn:active {
            transform: scale(0.9);
        }
        .call-action-btn.decline {
            background-color: #ff3b30;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }
        .call-action-btn.accept {
            background-color: #4cd964;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
        }
        /* 1. ËßÜÈ¢ëÈÄöËØù‰∏ªÂ±èÂπïÔºàÊõøÊç¢ÂéüÊ∑±Ëâ≤ËÉåÊôØÔºâ */
        #video-call-screen {
            background-color: #ffffff !important; 
            color: #333333 !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05) !important;
        }
        
        /* 2. È°∂ÈÉ®Áä∂ÊÄÅÊ†èÔºàÊîπ‰∏∫ÁôΩËâ≤ÊûÅÁÆÄÔºâ */
        .video-call-top-bar {
            background: linear-gradient(to bottom, rgba(255,255,255,0.9), transparent) !important;
            padding: 12px 16px !important;
            padding-top: 40px !important;
        }
        #call-timer {
            font-size: 14px !important;
            color: #666666 !important;
            font-weight: 400 !important;
        }
        
        /* 3. ÂèÇ‰∏éËÄÖÂ§¥ÂÉèÂå∫ÂüüÔºàÁÆÄÂåñÈ£éÊ†ºÔºâ */
        .video-call-avatar-area {
            padding: 15px !important;
            padding-top: 70px !important;
        }
        #participant-avatars-grid {
            gap: 12px !important;
        }
        .participant-avatar-wrapper {
            text-align: left !important;
        }
        .participant-avatar {
            width: 60px !important;
            height: 60px !important;
            border: 2px solid #f0f0f0 !important;
            border-radius: 12px !important; /* ‰ªéÂúÜÂΩ¢Êîπ‰∏∫ÂúÜËßíÁü©ÂΩ¢ÔºåÊõ¥Ins */
        }
        .participant-name {
            margin-top: 6px !important;
            font-size: 13px !important;
            color: #555555 !important;
        }
        /* ËØ¥ËØùËÄÖÈ´ò‰∫ÆÔºàÊîπ‰∏∫ÊµÖÁÅ∞ËæπÊ°Ü+ËΩªÂæÆÈò¥ÂΩ±Ôºâ */
        .participant-avatar.speaking {
            border-color: #e0e0e0 !important;
            box-shadow: 0 0 10px rgba(0,0,0,0.08) !important;
            transform: scale(1.03) !important;
        }
        
        /* 4. ÈÄöËØùÊ∂àÊÅØÂå∫ÂüüÔºàÁÆÄÂåñÊ∞îÊ≥°Ôºâ */
        #video-call-main {
            height: 35% !important;
            margin: 12px 12px 120px 12px !important;
            background-color: #f8f8f8 !important;
            border-radius: 16px !important;
            padding: 12px !important;
            gap: 12px !important;
        }
        .call-message-bubble {
            padding: 8px 12px !important;
            border-radius: 10px !important;
            max-width: 90% !important;
            font-size: 14px !important;
        }
        .call-message-bubble.ai-speech {
            background-color: #ffffff !important;
            border: 1px solid #f0f0f0 !important;
            align-self: flex-start !important;
        }
        .call-message-bubble.user-speech {
            background-color: #f0f0f0 !important;
            color: #333333 !important;
            align-self: flex-end !important;
        }
        
        /* 5. Â∫ïÈÉ®ÊéßÂà∂Ê†èÔºàÊûÅÁÆÄÊåâÈíÆÔºâ */
        .video-call-controls {
            background: linear-gradient(to top, rgba(255,255,255,0.95), transparent) !important;
            padding: 15px !important;
            padding-bottom: 30px !important;
        }
        .control-btn {
            width: 55px !important;
            height: 55px !important;
            border-radius: 14px !important; /* ÂúÜËßíÁü©ÂΩ¢ÊåâÈíÆ */
            background-color: #f0f0f0 !important;
        }
        /* È∫¶ÂÖãÈ£éÊåâÈíÆ */
        .control-btn.speak-btn {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23666" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>') !important;
        }
        /* ÊåÇÊñ≠ÊåâÈíÆÔºà‰ΩéÈ•±ÂíåÁ∫¢Ëâ≤Ôºâ */
        .control-btn.hangup-btn {
            background-color: #ffe5e5 !important;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23e57373" stroke="%23e57373" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>') !important;
        }
        /* Âä†ÂÖ•ÊåâÈíÆÔºà‰ΩéÈ•±ÂíåËìùËâ≤Ôºâ */
        .control-btn.join-btn {
            background-color: #e3f2fd !important;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%2364b5f6" stroke="%2364b5f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>') !important;
        }

        /* ÂæÆ‰ø°È£éÊ†ºËßÜÈ¢ëÈÄöËØùÂÆπÂô® */
        .wechat-video-call-container {
            display: none !important;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #f0f0f0;
            z-index: 20;
        }
        #video-call-screen.wechat-style .wechat-video-call-container {
            display: flex !important;
            flex-direction: column;
        }
        #video-call-screen.wechat-style .video-call-avatar-area,
        #video-call-screen.wechat-style .video-call-main {
            display: none !important;
        }
        #video-call-screen.wechat-style .video-call-top-bar {
            display: none !important;
        }
        #video-call-screen.wechat-style .video-call-controls {
            display: none !important;
        }

        /* ÂæÆ‰ø°È£éÊ†ºÈ°∂ÈÉ®‰ø°ÊÅØÊ†è */
        .wechat-call-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 50px 20px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .wechat-call-name {
            font-size: 18px;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .wechat-call-status {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* ÂæÆ‰ø°È£éÊ†ºÂ§ßËßÜÈ¢ëÂå∫ÂüüÔºàÂØπÊñπÔºâ */
        .wechat-main-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #2c2c2e;
            overflow: hidden;
        }
        .wechat-main-video img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ÂæÆ‰ø°È£éÊ†ºÂ∞èËßÜÈ¢ëÁ™óÂè£ÔºàËá™Â∑±Ôºâ */
        .wechat-small-video {
            position: absolute;
            top: 80px;
            right: 15px;
            width: 100px;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 11;
            background-color: #1c1c1e;
        }
        .wechat-small-video img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ÂæÆ‰ø°È£éÊ†ºÊ∂àÊÅØÊòæÁ§∫Âå∫Âüü */
        .wechat-call-messages {
            position: absolute;
            bottom: 120px;
            left: 15px;
            right: 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 12;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
        }
        .wechat-call-message {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .wechat-call-message.ai {
            background-color: white;
            align-self: flex-start;
            color: #333;
        }
        .wechat-call-message.user {
            background-color: #95ec69;
            align-self: flex-end;
            color: #333;
        }

        /* ÂæÆ‰ø°È£éÊ†ºÂ∫ïÈÉ®ÊéßÂà∂Ê†è */
        .wechat-call-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 20px;
            padding-bottom: 50px;
            background: linear-gradient(to top, rgba(0,0,0,0.4), transparent);
            display: flex;
            justify-content: center;
            gap: 50px;
            z-index: 10;
        }
        .wechat-control-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: none;
            background-color: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }
        .wechat-control-btn:active {
            transform: scale(0.9);
        }
        .wechat-hangup-btn {
            background-color: #ff3b30;
        }
        .wechat-speak-btn {
            background-color: rgba(255,255,255,0.25);
        }
        .wechat-regenerate-btn {
            background-color: rgba(255,255,255,0.25);
        }
        .wechat-camera-btn {
            background-color: rgba(255,255,255,0.25);
        }
        .wechat-camera-btn.active {
            background-color: #4cd964;
        }
        
        /* 6. ÊúÄÂ∞èÂåñ/ÊÅ¢Â§çÊåâÈíÆÔºàÊûÅÁÆÄÈ£éÊ†ºÔºâ */
        .video-call-top-bar #minimize-call-btn {
            color: #666666 !important;
            font-size: 18px !important;
            top: 38px !important;
        }
        #video-call-restore-btn {
            background-color: #f0f0f0 !important;
            border: none !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08) !important;
            animation: none !important; /* ÂéªÊéâÂëºÂê∏Âä®ÁîªÔºåÊõ¥ÊûÅÁÆÄ */
        }
        #outgoing-call-screen {
            background-color: #1c1c1e;
            color: white;
            justify-content: center; 
            align-items: center;   
        }
        .outgoing-call-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .outgoing-call-actions {
            margin-top: 50px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }
        .qzone-post-container {
            position: relative; 
            overflow: hidden;   
            border-radius: 12px;
        }
        .qzone-post-item {
            transition: transform 0.3s ease;
            background-color: var(--secondary-bg); 
            position: relative; 
            z-index: 2;
        }
        .qzone-post-delete-action {
            position: absolute; 
            top: 0;
            right: 0;
            bottom: 0;
            width: 90px; 
            background-color: #ff3b30; 
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            z-index: 1; 
        }
        .qzone-post-item.swiped {
            transform: translateX(-90px); 
        }
        @keyframes pat-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }
        .pat-animation {
            animation: pat-shake 0.4s ease-in-out;
        }
        .system-message {
            align-self: center; 
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }
        .message-wrapper.system-pat {
            justify-content: center;
            align-self: center;
            margin: 5px 0;
            max-width: 80%;
        }
        .message-bubble.system-bubble {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 10px;
        }
        #chat-input-actions-top {
            display: flex;
            gap: 8px;
            padding: 0 5px;
            overflow-x: auto;      
            flex-wrap: nowrap;     
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        #chat-input-actions-top::-webkit-scrollbar {
            display: none; 
        }
        #chat-header-title-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; 
            gap: 2px; 
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            max-width: 60%;
        }
        #chat-header-title {
            font-size: 16px; 
            font-weight: 600;
            position: static; 
            transform: none;  
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        #chat-header-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #4cd964; 
            transition: background-color 0.3s ease;
        }
        #chat-header-status.busy .status-dot {
            background-color: #cccccc;
        }
        .status-text {
            font-weight: 500;
        }
        .memory-card {
            background-color: #fffaf0; 
            border-radius: 12px;
            padding: 15px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
            border-left: 5px solid #ffb74d; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        .memory-card .header {
            border-bottom: 1px solid rgba(217, 129, 0, 0.15); 
            padding-bottom: 8px; 
        }
        .memory-card .header .date {
            font-size: 11px;
            color: #a1887f;
            margin-bottom: 4px; 
        }
        .memory-card .header .author {
            font-weight: 600;
            color: #d98100;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .memory-card .content {
            font-size: 14px;
            line-height: 1.7;
            color: #5d4037;
            white-space: pre-wrap;
        }
        .countdown-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        .countdown-card::before {
            content: '‚ú®';
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 50px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }
        .countdown-card .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .countdown-card .timer {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }
        .countdown-card .target-date {
            font-size: 12px;
            opacity: 0.8;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 10px;
        }
        #chat-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 150; 
            display: none; 
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        #chat-lock-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #chat-lock-content .lock-text {
            color: var(--text-secondary);
            font-size: 14px;
        }
        #chat-lock-content .lock-action-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
        }
        #chat-lock-content .lock-action-btn.secondary {
            background-color: transparent;
            color: var(--accent-color);
        }
        .red-packet-card {
            width: 220px;
            border-radius: 8px;
            background: linear-gradient(160deg, #F96259, #E44D44);
            color: #ffd700; 
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .red-packet-card.opened {
            background: linear-gradient(160deg, #d3c4a0, #c4b693);
            cursor: default;
        }
        .red-packet-card::before {
            content: 'üßß';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 30px;
            opacity: 0.2;
            transform: rotate(-10deg);
        }
        .rp-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .rp-icon {
            width: 20px;
            height: 20px;
        }
        .rp-greeting {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .rp-type {
            font-size: 11px;
            color: white;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }
        .rp-claimed-info {
            font-size: 13px;
            color: white;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        .rp-details-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .rp-details-item:last-child {
            border-bottom: none;
        }
        .rp-details-item .name {
            flex-grow: 1;
            font-weight: 500;
            color: #333;
        }
        .rp-details-item .amount {
            font-weight: 500;
            color: #555;
        }
        .rp-details-item .lucky-king-tag {
            font-size: 10px;
            background-color: #ffd700;
            color: #a67c00;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }
        .poll-card {
            width: 250px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .poll-card.closed {
            background-color: #e9ecef; 
        }
        .poll-question {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            line-height: 1.4;
            word-break: break-word;
        }
        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .poll-option-item {
            background-color: white;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s;
        }
        .poll-card:not(.closed) .poll-option-item:hover {
            background-color: #f0f8ff;
        }
        .poll-option-item.voted {
            border-color: var(--accent-color);
            background-color: #e7f3ff;
            font-weight: 500;
        }
        .poll-option-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: rgba(0, 123, 255, 0.1);
            z-index: 1;
            transition: width 0.3s ease-in-out;
        }
        .poll-option-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .poll-option-text {
            font-size: 14px;
        }
        .poll-option-votes {
            font-size: 13px;
            color: #8a8a8a;
            font-weight: 500;
        }
        .poll-footer {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #e9e9e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .poll-total-votes {
            font-weight: 500;
        }
        .poll-action-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        .poll-card.closed .poll-action-btn {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        .poll-option-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .poll-option-input-wrapper input {
            flex-grow: 1;
        }
        .poll-option-input-wrapper .remove-option-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #ff3b30;
            border: none;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            text-align: center;
            flex-shrink: 0;
        }
        #chat-header-title.typing-status {
            color: var(--text-secondary);
            animation: typing-pulse 1.5s infinite;
            font-style: italic;
        }
        @keyframes typing-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        #chat-header-title {
            transition: opacity 0.2s ease-in-out;
        }
        @keyframes message-pop-in {
          from {
            opacity: 0;
            transform: translateY(15px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .message-wrapper.animate-in {
          animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
          }
#icon-settings-grid,
#cphone-icon-settings-grid { 
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}
        .icon-setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .change-icon-btn {
            padding: 4px 10px;
            font-size: 12px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
        }
        #wallpaper-screen .form-container {
            min-height: 0; 
        }
        #wallpaper-preview {
            flex-shrink: 0; 
        }
        #browser-screen {
            background-color: #f8f9fa;
        }
        #browser-content {
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        #browser-content .article-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        #browser-content .article-meta {
            font-size: 13px;
            color: #8a8a8a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        #browser-content .article-body {
            white-space: pre-wrap;
            word-break: break-word;
        }
        #browser-content .article-body p {
            margin-bottom: 1em;
        }
        .link-share-card {
            width: 210px; 
            background-color: var(--secondary-bg);
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .link-share-card:hover {
            background-color: #f9f9f9;
        }
        .link-share-card .title {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
            color: #1f1f1f;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link-share-card .description {
            font-size: 13px;
            color: #8a8a8a;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link-share-card .footer {
            display: flex; 
            align-items: center;
            gap: 6px; 
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px; 
        }
        .link-share-card .footer-icon{
            width: 14px;
            height: 14px;
            flex-shrink: 0; 
        }
        .comment-item {
            position: relative;
            padding-right: 25px; 
        }
        .comment-delete-btn {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            line-height: 22px;
            text-align: center;
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0; 
        }
        .comment-item:hover .comment-delete-btn {
            opacity: 1;
        }
        .comment-delete-btn:hover {
            background-color: #f0f0f0;
            color: #ff3b30;
        }
        #phone-screen.dark-mode {
            --secondary-bg: #1c1c1e; 
            --border-color: #38383a;  
            --text-primary: #ffffff;   
            --text-secondary: #8d8d92; 
        }
        #phone-screen.dark-mode #chat-list-screen,
        #phone-screen.dark-mode #qzone-screen .qzone-content,
        #phone-screen.dark-mode #memories-view {
            background-color: #000000;
        }
        #phone-screen.dark-mode #chat-list {
            background-color: #000000;
        }
        #phone-screen.dark-mode .chat-list-item {
            border-bottom-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .chat-group-header {
            background-color: #1c1c1e; 
            border-bottom: 1px solid #38383a; 
        }
        #phone-screen.dark-mode .chat-list-item .name,
        #phone-screen.dark-mode .chat-group-header .group-name {
            color: #ffffff;
        }
        #phone-screen.dark-mode .chat-list-item:hover {
            background-color: #1c1c1e;
        }
        #phone-screen.dark-mode .header,
        #phone-screen.dark-mode .qzone-header {
            background-color: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom-color: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }
        #phone-screen.dark-mode .header .back-btn,
        #phone-screen.dark-mode .header .action-btn,
        #phone-screen.dark-mode .header .save-btn {
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-list-bottom-nav {
            background-color: rgba(25, 25, 25, 0.9);
            border-top-color: rgba(255, 255, 255, 0.15);
        }
        #phone-screen.dark-mode .nav-item.active {
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-input-area {
            background-color: rgba(5, 5, 5, 0.8);
            border-top: none;
        }
        #phone-screen.dark-mode #chat-input {
            background-color: #3e3e42;
            color: #ffffff;
        }
        #phone-screen.dark-mode #chat-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .chat-action-icon-btn {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
        }
        #phone-screen.dark-mode #send-btn {
            background-color: var(--accent-color);
        }
        #phone-screen.dark-mode .qzone-actions-bar,
        #phone-screen.dark-mode .qzone-post-item {
            background-color: #1c1c1e;
            border: 1px solid #333;
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
        }
        #phone-screen.dark-mode .action-item:not(:last-child)::after {
            background-color: #333;
        }
        #phone-screen.dark-mode .post-footer,
        #phone-screen.dark-mode .post-likes-section {
            border-top-color: #333;
        }
        #phone-screen.dark-mode .post-likes-section {
            background-color: rgba(0, 123, 255, 0.1);
        }
        #phone-screen.dark-mode .comment-input {
            background-color: #333;
            color: #ffffff;
        }
        #phone-screen.dark-mode .comment-input::placeholder {
            color: #8d8d92;
        }
        #phone-screen.dark-mode .post-actions-btn:hover {
            background-color: #333;
        }
        #phone-screen.dark-mode .at-mention-popup {
            background-color: #1c1c1e;
            border-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item {
            border-bottom-color: #333;
        }
        #phone-screen.dark-mode .at-mention-item:hover {
            background-color: #333;
        }
        #phone-screen.dark-mode .memory-card {
            background-color: #1c1c1e;
            border-left-color: #e6a753;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
        }
        #phone-screen.dark-mode .memory-card .header {
            background-color: #2c2c2e;
            border-bottom-color: #38383a;
            margin: -15px -15px 8px -15px;
            padding: 12px 15px;
            border-radius: 12px 12px 0 0;
        }
        #phone-screen.dark-mode .memory-card .header .date,
        #phone-screen.dark-mode .memory-card .header .author,
        #phone-screen.dark-mode .memory-card .content {
            color: #e0e0e0;
        }
        #phone-screen.dark-mode #api-settings-screen,
        #phone-screen.dark-mode #font-settings-screen,
        #phone-screen.dark-mode #wallpaper-screen,
        #phone-screen.dark-mode #contact-picker-screen,
        #phone-screen.dark-mode #member-management-screen,
        #phone-screen.dark-mode #world-book-editor-screen,
        #phone-screen.dark-mode #world-book-list,
        #phone-screen.dark-mode .list-item:hover,
        #phone-screen.dark-mode .list-container,
        #phone-screen.dark-mode .form-container {
            background-color: #000000;
        }
        #phone-screen.dark-mode .form-group input, 
        #phone-screen.dark-mode .form-group select, 
        #phone-screen.dark-mode .form-group textarea {
            background-color: #1c1c1e;
            color: #ffffff;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .form-button-secondary {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        #phone-screen.dark-mode .qzone-post-item .post-nickname,
        #phone-screen.dark-mode .qzone-post-item .post-content {
            color: #f0f0f0; 
        }
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
        #phone-screen.dark-mode .favorite-item-card .fav-card-content {
            color: #f0f0f0; 
        }
        #phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
            color: #8d8d92; 
        }
        #phone-screen.dark-mode .search-bar-container {
            background-color: #000000; 
        }
        #phone-screen.dark-mode #favorites-search-input {
            background-color: #1c1c1e; 
            border-color: #38383a;     
            color: #ffffff;            
        }
        #phone-screen.dark-mode #favorites-search-input::placeholder {
            color: #8d8d92; 
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e9e9eb; 
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        input:checked + .slider {
            background-color: #34c759; 
        }
        input:checked + .slider:before {
            transform: translateX(20px); 
        }
        #reply-preview-bar {
            display: none; 
            padding: 8px 12px;
            margin: 0 8px 8px 8px; 
            background-color: rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--accent-color);
            border-radius: 6px;
            position: relative;
            font-size: 13px;
            color: var(--text-secondary);
        }
        #phone-screen.dark-mode #reply-preview-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .reply-preview-content .sender {
            font-weight: 600;
            color: var(--text-primary);
        }
        .reply-preview-content .text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; 
            max-width: 95%;
        }
        #cancel-reply-btn {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 14px;
        }
        .quoted-message {
            padding: 6px 10px;
            margin-bottom: 6px;
            background-color: rgba(0, 0, 0, 0.04);
            border-left: 2px solid var(--accent-color);
            border-radius: 4px;
            font-size: 0.9em; 
            opacity: 0.8;
        }
        #phone-screen.dark-mode .quoted-message {
            background-color: rgba(255, 255, 255, 0.08);
            border-left-color: #a0cff1;
        }
        .quoted-message .quoted-sender {
            font-weight: 600;
            color: var(--accent-color);
        }
        #phone-screen.dark-mode .quoted-message .quoted-sender {
            color: #a0cff1;
        }
        .quoted-message .quoted-content {
            color: var(--text-secondary);
            white-space: normal;     
            word-break: break-word;  
            display: block;
        }
        #font-preview {
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        #font-preview p {
            color: var(--text-primary);
        }
        #phone-screen.dark-mode #font-preview {
            background-color: #1c1c1e; 
            border-color: #38383a;     
        }
        #phone-screen.dark-mode #font-preview p {
            color: #ffffff;
        }
        .transfer-actions-content {
            background-color: #fff0f5; 
            border-radius: 20px;
            width: 290px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); 
            text-align: center;
            position: relative;
            border: 1px solid #ffcce0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .transfer-actions-header {
            font-size: 20px;
            font-weight: bold;
            color: #a35c7b; 
            margin-bottom: 15px;
        }
        .transfer-actions-body p {
            font-size: 15px;
            color: #555;
            margin: 0 0 25px 0;
            line-height: 1.5;
        }
        .transfer-actions-footer {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        .transfer-actions-footer .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }
        .transfer-actions-footer .action-btn:active {
            transform: scale(0.95);
        }
        .transfer-actions-footer .action-btn.accept {
            background: linear-gradient(135deg, #ff85b3, #ff69b4);
            box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
        }
        .transfer-actions-footer .action-btn.decline {
            background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .transfer-actions-content .cancel-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: rgba(0, 0, 0, 0.1);
            color: #a35c7b;
            font-size: 20px;
            line-height: 28px;
            cursor: pointer;
        }
        .unread-count-wrapper {
            flex-shrink: 0;
            width: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px; 
        }
        .unread-count {
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background-color: #ff3b30; 
            color: white;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            text-align: center;
            border-radius: 10px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            display: none; 
            justify-content: center;
            align-items: center;
        }
        #call-history-screen {
            background-color: #f0f2f5;
        }
        .call-record-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-left: 5px solid var(--accent-color);
        }
        .call-record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .call-record-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .call-record-card .card-header .duration {
            font-weight: 500;
            color: var(--text-primary);
        }
        .call-record-card .card-body {
            display: flex;
            align-items: center;
        }
        .call-record-card .participants-avatars {
            display: flex;
            align-items: center;
        }
        .call-record-card .participant-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .call-record-card .participant-avatar:not(:first-child) {
            margin-left: -12px;
        }
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }
        #transcript-modal-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
        }
        .transcript-entry {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 85%;
            line-height: 1.5;
            word-break: break-word;
        }
        .transcript-entry.user {
            background-color: #dcf8c6; 
            align-self: flex-end;
        }
        .transcript-entry.assistant {
            background-color: #ffffff;
            align-self: flex-start;
        }
        #chat-list-title {
            cursor: pointer;
        }
        .call-record-card .card-body {
            display: flex;
            flex-direction: column;
            gap: 8px; 
        }
        .call-record-card .custom-title {
            font-size: 16px;
            font-weight: 600; 
            color: var(--text-primary);
            padding-bottom: 8px; 
            border-bottom: 1px solid var(--border-color); 
            margin-bottom: 4px; 
        }
        .call-record-card .participants-info {
            display: flex;
            align-items: center;
        }
        .call-record-card .participants-names {
            margin-left: 12px;
            font-weight: 500; 
            font-size: 14px; 
            color: var(--text-secondary); 
        }
        .voice-transcript {
            font-size: 14px;         
            line-height: 1.6;        
            color: var(--text-secondary); 
            padding: 8px 12px;       
            margin-top: 6px;         
            background-color: rgba(0, 0, 0, 0.04); 
            border-radius: 6px;      
            word-break: break-word;  
            display: none;           
        }
        #phone-screen.dark-mode .voice-transcript {
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .loading-spinner {
            display: none; 
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-top-color: var(--accent-color); 
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 8px; 
        }
        @keyframes spin {
            to {
        transform: rotate(360deg);
            }
        }
        #shared-history-viewer-content {
            display: flex;
            flex-direction: column; 
            gap: 20px; 
            padding: 15px; 
        }
        #music-player-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 60px;
            background-color: rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-50px);
            transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #music-player-overlay.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .music-player-window { 
            width: 70%; 
            min-height: 420px;
            background-color: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border-radius: 25px; 
            box-shadow: 0 8px 32px 0 rgba(25, 25, 25, 0.37); 
            border: 1px solid rgba(255, 255, 255, 0.18); 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #1f1f1f; 
            position: relative;
            justify-content: space-between;
            padding-bottom: 15px;
        }
        .music-player-top-actions {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            width: calc(100% - 30px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-left-cluster {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #music-return-btn, #music-exit-btn {
            background: none;
            border: none;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            color: #555;
            padding: 5px;
            line-height: 1;
        }
        #music-exit-btn {
            font-size: 24px;
            font-weight: 400;
        }
        .music-progress-bar-container {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .time-display {
            font-size: 11px;
            color: #888;
            width: 35px;
            text-align: center;
            flex-shrink: 0;
            font-family: 'SF Mono', 'Menlo', monospace;
        }
        .progress-bar {
            flex-grow: 1;
            height: 5px;
            background-color: #e5e5e5;
            border-radius: 2.5px;
            cursor: pointer;
        }
        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background-color: #333;
            border-radius: 2.5px;
        }
        #music-lyrics-container {
            width: 100%;
            height: 192px;
            overflow: hidden;
            position: relative;
            -webkit-mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
            mask-image: linear-gradient(transparent, black 20%, black 80%, transparent);
        }
        #music-lyrics-list {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .lyric-line {
            padding: 4px 0;
            font-size: 14px;
            color: #666;
            text-align: center;
            line-height: 1.5;
            transition: all 0.5s ease;
            opacity: 0.7;
            transform: scale(0.95);
        }
        .lyric-line.active {
            font-size: 16px;
            color: #000;
            opacity: 1;
            transform: scale(1);
        }
        .music-player-controls-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .music-controls {
            margin-top: 0;
        }
        #music-return-btn, #music-exit-btn, #music-playlist-btn {
            position: relative;
        }
        #music-return-btn { top: -2px; }
        #music-playlist-btn { top: -3px; }
        .playlist-item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .playlist-action-btn {
            font-size: 18px;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }
        .playlist-action-btn:hover { color: #000; }
        .delete-track-btn { font-size: 24px; color: #ff3b30; }
        .delete-track-btn:hover { color: #c00; }
        .lyrics-btn { font-weight: 500; }
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%;
            object-fit: cover;
            flex-shrink: 0; 
        }
        .recalled-message-placeholder {
            align-self: center; 
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; 
        }
        #phone-screen.dark-mode .recalled-message-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        @keyframes recall-animation {
          from {
            opacity: 1;
            transform: scale(1);
          }
          to {
            opacity: 0;
            transform: scale(0.8);
          }
        }
        .message-wrapper.recalled-animation {
          animation: recall-animation 0.3s ease-out forwards;
        }
        .recalled-message-placeholder {
            white-space: nowrap; 
            display: inline-block; 
            padding: 4px 12px;
        }
        .world-book-group-container {
            border-bottom: 1px solid var(--border-color);
        }
        .world-book-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }
        .world-book-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }
        .world-book-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }
        .world-book-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }
        .world-book-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }
        .world-book-group-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .world-book-group-content.collapsed {
            max-height: 0;
        }
        #phone-screen.dark-mode .world-book-group-header {
            background-color: #1c1c1e;
        }
        .chat-list-item.pinned {
            background-color: #f0f2f5; 
        }
        #phone-screen.dark-mode .chat-list-item.pinned {
            background-color: #2c2c2e; 
        }
        #chat-input-area {
            display: flex;
            flex-direction: column;
            flex-shrink: 0; 
            background-color: var(--secondary-bg); 
        }
        #chat-input-actions-top {
            flex-shrink: 0; 
            padding-bottom: 8px; 
        }
        #chat-input-main-row {
            flex-shrink: 0; 
        }
        #chat-input-area {
            position: relative; 
            z-index: 20;      
            flex-shrink: 0;
            padding: 8px;
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        #chat-at-mention-popup {
            bottom: 100%; 
            left: 8px;    
            right: 8px;   
            width: auto;  
            margin-bottom: 5px; 
        }
        #announcement-board-modal .modal-content {
            height: 70%;
            background-color: #f0f2f5;
        }
        #announcement-board-content {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px; 
        }
        #announcement-board-content .message-wrapper {
            max-width: 100%; 
            align-self: center;
        }
        #announcement-board-content .timestamp {
            display: none; 
        }
        .announcement-item-wrapper {
            position: relative; 
            padding: 10px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .announcement-item-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            border-radius: 50%;
        }
        .announcement-item-actions:hover {
            background-color: #f0f0f0;
        }
        .pinned-indicator {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 28px;
            height: 28px;
            background-color: #ffc107;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        .reposted-content-wrapper {
            background-color: #f7f7f8;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        #phone-screen.dark-mode .reposted-content-wrapper {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        .reposted-content-wrapper .post-footer,
        .reposted-content-wrapper .post-feedback-icons,
        .reposted-content-wrapper .post-likes-section {
            display: none;
        }
        .reposted-content-wrapper .post-header {
            margin-bottom: 8px;
        }
        .reposted-content-wrapper .post-avatar {
            width: 32px;
            height: 32px;
        }
        .reposted-content-wrapper .post-nickname {
            font-size: 14px;
        }
        .location-share-card {
            width: 230px;
            border-radius: 10px;
            overflow: hidden; 
            background-color: var(--secondary-bg);
            border: 1px solid #f0f0f0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            cursor: pointer; 
        }
        .card-text-area {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .card-text-primary {
            font-size: 16px;
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-text-secondary {
            font-size: 12px;
            color: #a0a0a0;
        }
        .card-map-area {
            height: 100px; 
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: cover;
            background-position: center;
            background-color: #FFF0F5; 
        }
        .message-bubble.user .location-share-card .card-map-area {
            background-color: #F0FFF8;
        }
        .card-pin-icon {
            font-size: 40px;
            color: #FF6B6B; 
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
        }
        @keyframes breathing-light {
            0% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
            50% {
        box-shadow: 0 0 18px 4px rgba(0, 123, 255, 0.8);
            }
            100% {
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            }
        }
        .chat-list-item .avatar.is-acting {
            animation: breathing-light 2s ease-in-out infinite;
            border: 1.5px solid rgba(0, 123, 255, 0.7);
        }
        .comment-sticker-btn {
            background: none;
            border: none;
            padding: 5px; 
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .comment-sticker-btn:hover {
            color: var(--text-primary); 
        }
        .comment-sticker-btn svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        #qzone-sticker-panel {
            position: absolute; 
            width: 280px;
            height: 200px;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1010; 
            display: none; 
            flex-direction: column;
            overflow: hidden;
        }
        #qzone-sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
        }
        #qzone-sticker-grid .sticker-item {
            position: relative;
            aspect-ratio: 1 / 1;
            background-color: white;
            border-radius: 8px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .comment-text .comment-sticker {
            max-width: 100px;  
            max-height: 100px; 
            display: block;
            background-color: transparent;
        }
        .comment-item .comment-text:has(.comment-sticker) {
            line-height: 1;
        }
        .change-frame-btn {
            padding: 6px 10px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        #avatar-frame-modal .modal-content {
            height: 70%;
        }
        #avatar-frame-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        .frame-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .frame-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
        }
        .frame-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .frame-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }
        .frame-item {
            aspect-ratio: 1 / 1;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            background-color: #f0f0f0;
            background-size: cover;
            background-position: center;
            padding: 5px;
            transition: all 0.2s ease;
            position: relative;
        }
        .frame-item.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        .frame-item .preview-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .frame-item .preview-frame {
            position: absolute;
            top: -7px;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .avatar-group {
            width: 34px;
            flex-shrink: 0; 
            position: relative;
            transition: width 0.2s ease;
        }
        .avatar-group.has-frame {
            width: 34px; 
        }
        .message-bubble .avatar {
            width: 34px;
            height: 34px;
            border-radius: 20%; 
            object-fit: cover;
        }
        .avatar-with-frame {
            position: relative; 
            width: 38px;
            height: 38px;
            margin: 0 auto;
            transition: all 0.2s ease;
        }
        .avatar-group.has-frame .avatar-with-frame {
            width: 43px;
            height: 43px;
        }
        .avatar-with-frame .avatar-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; 
            height: 100%;
            border-radius: 50%; 
            object-fit: cover;
            z-index: 1; 
        }
        .avatar-with-frame .avatar-frame {
            position: absolute;
            width: 120%;  
            height: 120%; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2; 
            pointer-events: none; 
        }
.message-bubble {
    flex: 1;
    min-width: 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}
.message-bubble.user { 
    flex-direction: row-reverse; 
}
.message-bubble .content {
    flex: 1;
    min-width: 0;
    overflow-wrap: break-word; 
    word-wrap: break-word;     
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
}
.message-bubble .avatar-group {
    flex-shrink: 0 !important;
}
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 34px !important;
            height: 34px !important;
        }
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #chat-list-screen .avatar-frame {
            display: none;
        }
        #chat-list-screen .avatar-group {
            width: 45px;
            height: 45px;
        }
        #chat-list-screen .avatar-group.has-frame .avatar-with-frame,
        #chat-list-screen .avatar-group.has-frame .avatar-img {
            width: 45px;
            height: 45px;
        }
        #chat-list-screen .avatar-img,
        #chat-list-screen .avatar {
            border-radius: 50%;
        }
        #chat-list .chat-list-item .avatar-group {
            margin-right: 15px !important; 
        }
        #chat-list .chat-list-item .avatar {
            margin-right: 0; 
        }
        .comment-item {
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px; 
            padding: 4px 6px; 
            margin: 0 -6px; 
            border-radius: 4px;
        }
        .comment-item:hover {
            background-color: #f0f2f5;
        }
        #phone-screen.dark-mode .comment-item:hover {
            background-color: #2c2c2e;
        }
        .comment-item .comment-text {
            flex-grow: 1; 
            word-break: break-word; 
        }
        .legacy-comment-item {
            line-height: 1.5;
            padding: 4px 6px; 
            color: var(--text-secondary); 
        }
        .message-bubble.is-link-share .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-location-share .content,
        .message-bubble.is-sticker .content,
        .message-bubble.is-ai-image .content {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #chat-interface-screen .message-bubble .avatar-group.has-frame .avatar-with-frame {
            width: 34px !important;
            height: 34px !important;
        }
        #chat-interface-screen .message-bubble .avatar-with-frame .avatar-img {
            width: 100% !important;
            height: 100% !important;
        }
        .message-bubble.is-sticker,
        .message-bubble.is-voice-message,
        .message-bubble.is-transfer,
        .message-bubble.is-ai-image,
        .message-bubble.is-waimai-request,
        .message-bubble.is-red-packet,
        .message-bubble.is-poll,
        .message-bubble.is-link-share,
        .message-bubble.is-location-share {
            flex: initial; 
            min-width: auto; 
        }
        .message-bubble.is-sticker .content,
        .message-bubble.is-voice-message .content,
        .message-bubble.is-transfer .content,
        .message-bubble.is-ai-image .content,
        .message-bubble.is-waimai-request .content,
        .message-bubble.is-red-packet .content,
        .message-bubble.is-poll .content,
        .message-bubble.is-link-share .content,
        .message-bubble.is-location-share .content {
            flex: initial; 
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        #announcement-board-content .message-wrapper {
            align-self: flex-start !important;
        }
        #announcement-board-content .message-bubble.user {
            flex-direction: row !important;
        }
        #announcement-board-content .message-wrapper.user {
            flex-direction: row !important;
        }
        #chat-interface-screen > .header {
            position: absolute !important; 
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100 !important; 
        }
        #chat-interface-screen #chat-messages {
            margin-top: 0 !important; 
        }
        #music-player-overlay {
            z-index: 200 !important;
        }
        #chat-interface-screen {
            position: relative !important;
            height: 100%;
            width: 100%;
            overflow: hidden; 
        }
        #chat-interface-screen > .header {
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0; 
            width: auto !important; 
            z-index: 100 !important; 
        }
        #chat-interface-screen #chat-input-area {
            position: absolute !important;
            bottom: 0;
            left: 0;
            right: 0;
            width: auto !important;
            z-index: 100 !important;
            padding-bottom: calc(8px + env(safe-area-inset-bottom)); 
        }
        #chat-interface-screen #chat-messages {
            height: 100% !important; 
            width: 100% !important;
            overflow-y: auto !important; 
            box-sizing: border-box !important; 
            margin-top: 0 !important; 
            padding-top: calc(120px + env(safe-area-inset-top)) !important; 
            padding-bottom: calc(120px + env(safe-area-inset-bottom)) !important;
        }
        .post-deleted-placeholder {
            align-self: center;
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer; 
        }
        #phone-screen.dark-mode .post-deleted-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .spoiler {
            background-color: #333; 
            color: #333;           
            padding: 0 4px;         
            border-radius: 4px;     
            cursor: pointer;        
            transition: all 0.2s ease-in-out; 
        }
        .spoiler:hover, .spoiler:active {
            background-color: #e0e0e0; 
            color: inherit;           
        }
        .memory-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px; 
            border-radius: 50%; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .memory-action-btn svg {
            width: 18px;  
            height: 18px;
            stroke: var(--text-secondary); 
            transition: stroke 0.2s;
        }
        .memory-action-btn:hover {
            background-color: #e9ecef; 
        }
        #phone-screen.dark-mode .memory-action-btn:hover {
            background-color: #38383a;
        }
        .memory-action-btn.edit-memory-btn:hover svg {
            stroke: var(--accent-color);
        }
        .memory-action-btn.delete-memory-btn:hover svg {
            stroke: #ff3b30;
        }
        #sticker-grid.management-mode .sticker-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        #sticker-grid.management-mode .sticker-item.selected::after {
            border-color: var(--accent-color);
        }
        #sticker-grid.management-mode .sticker-item .delete-btn {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
        }
        #sticker-action-bar {
            display: none; 
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
        }
        #sticker-action-bar button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
        #ai-response-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .ai-response-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }
        .ai-response-editor-block textarea {
            width: 100%;
            min-height: 80px; 
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px; 
            font-family: monospace; 
            box-sizing: border-box;
        }
        .ai-response-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0; 
        }
        .ai-response-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }
        #phone-screen.dark-mode .ai-response-editor-block {
            background-color: #2c2c2e;
            border-color: #38383a;
        }
        #phone-screen.dark-mode .ai-response-editor-block textarea {
            background-color: #1c1c1e;
            color: #f0f0f0;
            border-color: #4a4a4e;
        }
.offline-dialogue {
    font-weight: 500;
}
.offline-description {
    display: block; 
    color: inherit; 
    font-style: normal; 
    margin-top: 4px; 
    white-space: pre-wrap; 
    line-height: 1.6;
}
.offline-description em {
    color: var(--text-secondary); 
}
#phone-screen.dark-mode .offline-description {
    color: inherit; 
}
        .message-bubble .content {
            transition: background-color 0.5s ease-out;
        }
        .message-bubble.highlighted .content {
            background-color: rgba(0, 123, 255, 0.2) !important;
        }
        #gomoku-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 350px;
            z-index: 50;
            pointer-events: none; 
            overflow: hidden;     
            display: none;        
        }
        #gomoku-content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            box-sizing: border-box;
            transition: transform 0.3s ease-out;
            transform: translateY(-100%);
            pointer-events: auto;
        }
        #phone-screen.dark-mode #gomoku-content-wrapper {
            background-color: rgba(28, 28, 30, 0.9);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        #gomoku-overlay.visible #gomoku-content-wrapper {
            transform: translateY(0);
        }
        #chat-messages {
            transition: padding-top 0.3s ease-out;
        }
        #gomoku-board {
            background-color: #e4b591;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer;
        }
        #gomoku-controls {
            width: 100%;
            text-align: center;
            flex-shrink: 0;
        }
        #close-gomoku-btn {
            padding: 6px 15px;
            border-radius: 15px;
            border: 1px solid var(--text-secondary);
            background-color: rgba(255,255,255,0.5);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
        }
        #phone-screen.dark-mode #close-gomoku-btn {
            background-color: rgba(0,0,0,0.2);
            border-color: var(--text-secondary);
        }
        #gomoku-overlay {
            pointer-events: none;
        }
        #gomoku-board,
        #gomoku-controls {
            pointer-events: auto;
        }
        #product-grid {
            flex-grow: 1; 
            overflow-y: auto; 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
            padding-bottom: 80px;
        }
        .product-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            display: flex;         
            flex-direction: column;
            cursor: pointer;
            position: relative;
        }
        .product-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }
        .product-info {
            padding: 12px 10px;
            flex-grow: 1;      
            display: flex;
            flex-direction: column;
        }
        .product-name {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
            min-height: 36px;
        }
        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;      
        }
        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: #ff5722;
        }
        .product-price::before { content: '¬•'; font-size: 12px; }
        .add-to-cart-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }
        .product-management-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 7;
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        #shopping-screen.management-mode .product-footer {
            display: none;
        }
        #cart-title {
            position: static;
            transform: none;
        }
        #cart-items-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .cart-item {
            display: flex; align-items: flex-start; gap: 12px; background-color: white;
            padding: 12px; border-radius: 12px;
        }
        .cart-item-checkbox { margin-top: 28px; }
        .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .cart-item-info { flex-grow: 1; display: flex; flex-direction: column; }
        .cart-item-name { font-weight: 500; font-size: 14px; line-height: 1.4; }
        .cart-item-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px;}
        .cart-item-price { color: #ff5722; font-weight: bold; font-size: 16px; }
        .quantity-control { display: flex; align-items: center; gap: 4px; }
        .quantity-btn {
            width: 26px; height: 26px; border: none; background-color: #f7f8fa;
            border-radius: 4px; font-weight: 500; cursor: pointer; color: #666;
        }
        .quantity-display { font-weight: 500; min-width: 30px; text-align: center; }
        #cart-footer {
            position: absolute; bottom: 0; left: 0; width: 100%; display: flex;
            justify-content: space-between; align-items: center; padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: white; border-top: 1px solid var(--border-color); box-sizing: border-box;
        }
        #cart-footer .select-all-label { display: flex; align-items: center; gap: 5px; }
        #cart-footer .cart-summary { text-align: right; }
        #cart-footer .cart-subtext { font-size: 11px; color: #999; }
        #checkout-btn {
            padding: 10px 25px; border: none; border-radius: 20px;
            background: linear-gradient(90deg, #ff9800, #ff5722);
            color: white; font-size: 15px; font-weight: 500; cursor: pointer;
        }
        .gift-card {
            width: 220px; 
            box-sizing: border-box; 
            border-radius: 12px; 
            background-color: var(--secondary-bg); 
            border: 1px solid #eee; 
            padding: 12px;
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .gift-header { display: flex; align-items: center; gap: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .gift-header-icon { width: 20px; height: 20px; color: #ff9800; }
        .gift-header-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
        .gift-items-preview { padding: 12px 0; display: flex; flex-direction: column; gap: 8px; }
        .gift-preview-item { display: flex; align-items: center; gap: 8px; }
        .gift-preview-img { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .gift-preview-name { flex-grow: 1; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gift-preview-quantity { font-size: 12px; color: var(--text-secondary); }
        .gift-footer { font-size: 12px; color: var(--text-secondary); text-align: right; }
        #gift-receipt-body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 15px; background-color: #f7f8fa; }
        .receipt-header { text-align: center; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .receipt-header h3 { margin: 0 0 5px 0; font-size: 20px; }
        .receipt-header p { margin: 0; font-size: 12px; color: #888; }
        .receipt-items-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .receipt-items-table th, .receipt-items-table td { padding: 10px 5px; font-size: 13px; }
        .receipt-items-table thead th { border-bottom: 1px solid #333; text-align: left; }
        .receipt-items-table .item-name { width: 50%; }
        .receipt-items-table .item-qty { text-align: center; }
        .receipt-items-table .item-price, .receipt-items-table .item-subtotal { text-align: right; }
        .receipt-total { padding-top: 15px; border-top: 1px solid #333; text-align: right; font-size: 16px; font-weight: bold; }
        .receipt-footer { text-align: center; margin-top: 25px; font-size: 12px; color: #888; }
        .product-item {
            position: relative; 
        }
.product-management-overlay {
    position: absolute;
    bottom: 0; 
    left: 0;
    width: 100%;
    background-color: rgba(0,0,0,0.6); 
    display: none; 
    justify-content: center; 
    align-items: center;
    gap: 15px; 
    padding: 10px 0; 
    border-radius: 0 0 8px 8px; 
    z-index: 5; 
    transition: opacity 0.2s;
}
        #shopping-screen.management-mode .product-management-overlay {
            display: flex; 
        }
        .product-management-overlay button {
            padding: 8px 20px;
            border: 1px solid white;
            background-color: rgba(255,255,255,0.2);
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }
        .product-management-overlay .delete-product-btn {
            border-color: #ff8a80;
            color: #ff8a80;
        }
        #shopping-screen.management-mode .add-to-cart-btn {
            display: none;
        }
        .message-bubble.is-card-like {
            flex: initial; 
            min-width: auto; 
        }
        .message-bubble.is-card-like .content {
            flex: initial; 
            padding: 0;
            background: transparent;
        }
        #go-to-cart-btn {
            display: flex;
            align-items: center; 
            gap: 4px; 
        }
        #gift-recipient-list .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        #gift-recipient-list .contact-picker-item:last-child {
            border-bottom: none;
        }
        #gift-recipient-list .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }
        #gift-recipient-list .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        #gift-recipient-list .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }
        #gift-recipient-list .contact-picker-item .name {
            font-weight: 500;
        }
        #ai-heart-rate-display {
            display: none !important;
        }
        #global-lyrics-bar {
            position: absolute;
            z-index: 20;
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.05);
            padding: 4px 12px;
            border-radius: 12px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease, top 0.3s ease, bottom 0.3s ease, left 0.3s ease, right 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 65%;
        }
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        #global-lyrics-bar.visible {
            opacity: 1;
            visibility: visible;
        }
        #phone-screen.dark-mode #global-lyrics-bar {
            color: #a0a0a0;
            background-color: rgba(255, 255, 255, 0.1);
        }
        #world-book-screen {
            background-color: #f0f2f5;
            display: flex; 
            flex-direction: column;
        }
        #phone-screen.dark-mode #world-book-screen {
            background-color: #000000;
        }
        #world-book-tabs {
            display: flex;
            overflow-x: auto; 
            padding: 10px 15px 0 15px;
            flex-shrink: 0; 
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        #world-book-tabs::-webkit-scrollbar {
            display: none; 
        }
        .world-book-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; 
            transition: all 0.2s ease-in-out;
            white-space: nowrap; 
        }
        .world-book-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .world-book-tab.active {
            color: #ffffff;
        }
        #world-book-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .world-book-category-pane {
            display: none; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            padding: 15px;
        }
        .world-book-category-pane.active {
            display: grid;
        }
.world-book-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0;
    word-break: break-all;
}
        .world-book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .world-book-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        .world-book-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .world-book-card .card-content-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3; 
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        #rendering-rules-screen {
            background-color: #f0f2f5;
            display: flex; 
            flex-direction: column;
        }
        #phone-screen.dark-mode #rendering-rules-screen {
            background-color: #000000;
        }
        #rules-tabs {
            display: flex;
            overflow-x: auto;
            padding: 10px 15px 0 15px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #rules-tabs::-webkit-scrollbar {
            display: none;
        }
        .rules-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .rules-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .rules-tab.active {
            color: #ffffff;
        }
        #rules-content-container {
            flex-grow: 1;
            overflow-y: auto;
        }
        .rules-category-pane {
            display: none; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            padding: 15px;
        }
        .rules-category-pane.active {
            display: grid;
        }
        .rule-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 8px; 
            border-left: 5px solid #6c757d; 
        }
        .rule-card.enabled {
            border-left-color: #28a745; 
        }
        .rule-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        #phone-screen.dark-mode .rule-card {
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        .rule-card .card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .rule-card .card-content-preview {
            font-size: 12px;
            font-family: monospace; 
            color: var(--text-secondary);
            background-color: #f0f2f5;
            padding: 5px 8px;
            border-radius: 4px;
            word-break: break-all;
        }
        #phone-screen.dark-mode .rule-card .card-content-preview {
            background-color: #2c2c2e;
        }
        .control-btn.regenerate-btn {
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%; 
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>');
        }
        .control-btn.propel-btn {
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>');
        }
.message-bubble.is-raw-html .content {
    padding: 0 !important; 
    background: transparent !important; 
    border: none !important; 
    box-shadow: none !important; 
}
#phone-screen {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
}
#home-screen #clock-container,
#home-screen #app-grid,
#home-screen #home-widgets-container {
    display: none !important;
}
#home-screen {
    background: linear-gradient(135deg, #6DD5FA, #2980B9);
    background-size: cover;
    background-position: center;
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between; 
    align-items: center;
    height: 100%;
}
#main-content-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 30px; 
    align-items: center;
    margin-top: 20px; 
}
#profile-widget {
    position: relative; 
    width: 100%;
    max-width: 380px;
    flex-shrink: 0;
}
#profile-banner-img {
    display: block; 
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 24px 24px 0 0; 
    position: relative;
    z-index: 1; 
}
#profile-widget .profile-avatar-container {
    position: absolute;
    top: 80px; 
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: white; 
    padding: 4px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 3; 
}
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
#profile-widget .profile-info {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    margin-top: -24px; 
    padding-top: 44px; 
    min-height: 120px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-left: 15px;
    padding-right: 15px;
    padding-bottom: 15px;
    text-align: center;
    color: #1c1c1e;
    position: relative;
    z-index: 2; 
}
#profile-widget::before {
    display: none !important;
}
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
#profile-widget::before {
    display: none !important;
}
#profile-avatar-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
#profile-username { font-size: 18px; font-weight: 600; margin: 0 0 2px 0; }
#profile-sub-username { font-size: 13px; color: #8a8a8a; margin: 0 0 10px 0; }
#profile-bio { font-size: 14px; margin: 0 0 12px 0; color: #333; }
#profile-location {
    font-size: 12px; color: #8a8a8a; margin: 0 auto; display: inline-flex;
    align-items: center; gap: 4px; background-color: rgba(0,0,0,0.05);
    padding: 3px 9px; border-radius: 10px;
}
#desktop-layout {
    display: grid;
    grid-template-columns: 1fr 1.1fr;
    gap: 20px;
    width: 100%;
    align-items: start;
}
#desktop-widget-column {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.widget-header {
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.8);
    margin: 0 0 5px 5px;
}
.desktop-widget {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 18px;
    padding: 12px 15px;
    color: #1f1f1f; 
    font-weight: 500;
    font-size: 13px;
    display: flex;
    align-items: center;
}
.desktop-widget.text-only {
    background-color: transparent; 
    border: none;                  
    padding: 0;                    
    box-shadow: none;              
}
.desktop-widget.icon-left { justify-content: flex-start; gap: 10px; }
.desktop-widget.icon-right {
    justify-content: flex-end; 
    gap: 10px;                 
}
.desktop-widget img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }
.desktop-widget p, .desktop-widget span { margin: 0; }
#desktop-app-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    align-content: start;
}
#desktop-dock {
    background-color: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    justify-content: center;
    gap: 30px;
    width: fit-content;
    flex-shrink: 0;
    margin-bottom: calc(20px + env(safe-area-inset-bottom));
}
.desktop-app-icon {
    display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center;
}
.icon-bg-desktop {
    width: 55px; height: 55px; border-radius: 14px; background-color: #f0f2f5; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; overflow: hidden;
}
.icon-bg-desktop img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 0;
}
.desktop-app-icon .label {
    color: #333; font-size: 13px; font-weight: 500;
}
.desktop-app-icon:active .icon-bg-desktop {
    transform: scale(0.9);
}
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    cursor: pointer;
    opacity: 0.9;
}
.editable-text, .editable-image {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.editable-text:hover, .editable-image:hover {
    outline: 2px dashed rgba(255, 255, 255, 0.8);
    opacity: 0.9;
    border-radius: 4px; 
}
#profile-widget .profile-info {
    background: transparent !important;
    position: relative;
    z-index: 1; 
}
#profile-widget .profile-info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 24px;
    mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    z-index: -1;
}
#chat-settings-screen {
    display: flex;
    flex-direction: column;
    background-color: #f0f2f5; 
}
#phone-screen.dark-mode #chat-settings-screen {
     background-color: #000000; 
}
#chat-settings-screen .form-container {
    flex-grow: 1;      
    overflow-y: auto;  
    padding-top: 100px;  
    margin-top: -80px;   
}
.search-result-item {
    display: flex;
    flex-direction: column;
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}
.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.1);
}
#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
.search-result-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
}
.search-result-item .artist {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}
.search-result-item .source {
    font-size: 10px;
    color: var(--accent-color);
    background-color: rgba(0, 123, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 8px;
}
#music-player-cover {
    width: 180px;
    height: 180px;
    border-radius: 15px;
    object-fit: cover;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    margin-bottom: 25px; 
    transition: opacity 0.5s ease-in-out; 
}
#music-visual-container {
    position: relative;
    width: 220px;
    height: 220px;
    margin-bottom: 25px;
    cursor: pointer;
}
#vinyl-view, #inline-lyrics-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s ease, transform 0.5s ease;
}
#vinyl-view {
    background-color: #222;
    border-radius: 50%;
    padding: 18px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
}
#vinyl-view #music-player-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    margin: 0; 
}
#inline-lyrics-view {
    opacity: 0;
    transform: scale(1.1);
    pointer-events: none;
    padding: 10px;
    box-sizing: border-box;
}
#music-visual-container.lyrics-active #vinyl-view {
    opacity: 0;
    transform: scale(0.9);
}
#music-visual-container.lyrics-active #inline-lyrics-view {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}
#inline-lyrics-view #music-lyrics-container {
    width: 100%;
    height: 100%;
}
#music-info-top {
    text-align: center; 
    flex-shrink: 0;
    margin-bottom: 20px; 
}
#music-player-song-title,
#music-player-artist,
#music-time-counter {
    margin-bottom: 5px; 
}
#music-visual-container {
    margin-bottom: 15px; 
}
@keyframes spin-vinyl {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
#vinyl-view.spinning {
  animation: spin-vinyl 12s linear infinite;
}
#single-lyric-display {
    height: 40px;          
    line-height: 40px;     
    width: 100%;           
    margin-top: 15px;      
    text-align: center;    
    font-size: 14px;       
    color: #333;           
    font-weight: 500;      
    transition: opacity 0.3s ease; 
    white-space: nowrap;           
    overflow: hidden;              
    text-overflow: ellipsis;       
}
#music-visual-container.lyrics-active + #single-lyric-display {
    display: none;
}
#character-profile-modal {
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}
.character-profile-content {
    width: 320px;
    height: 75vh;
    max-height: 580px;
    background-color: #f0f2f5;
    border-radius: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    position: relative;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
     overflow: visible; 
    padding-top: 40px; 
}
.profile-history-icon-btn { /* <--- Ê†∏ÂøÉ‰øÆÊîπ1Ôºö‰ªé ID (#) Êîπ‰∏∫Á±ª (.) */
    /* Ê†∏ÂøÉ‰øÆÊîπ2ÔºöÁßªÈô§‰∫Ü position, top, right, z-index Ëøô‰∫õÁªùÂØπÂÆö‰ΩçÂ±ûÊÄß */
    width: 36px;
    height: 36px;
    background: none;
    border: none;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
    padding: 0;
}
#profile-history-icon-btn:hover { background-color: rgba(0,0,0,0.05); }
.profile-history-icon-btn svg { width: 20px; height: 20px; stroke: #b0b0b0; stroke-width: 2; }
#profile-main-content, #profile-thoughts-history-view {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
}
#profile-main-content {
    padding: 0 25px 25px 25px; 
    gap: 20px; 
    flex-grow: 1;
    overflow-y: auto;
}
.profile-header {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
    margin-bottom: 10px; 
}
#profile-avatar { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
.profile-info { display: flex; flex-direction: column; }
#profile-name { font-size: 20px; font-weight: 600; color: #1f1f1f; }
#profile-id { font-size: 14px; color: #8a8a8a; }
.profile-section {
    background-color: #ffffff; 
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06); 
    display: flex;
    flex-direction: column;
    gap: 12px; 
    flex-shrink: 0;
}
.profile-section-header {
    display: flex;
    align-items: center;
    gap: 10px; 
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0; 
}
.profile-section-icon {
    font-size: 20px;
    opacity: 0.5;
}
.profile-section label {
    font-size: 15px;
    font-weight: 600;
    color: #555; 
    margin: 0; 
}
.profile-section p {
    font-size: 15px;
    color: #333;
    line-height: 1.7;
    margin: 0;
    white-space: pre-wrap;
}
#profile-thoughts-history-view { display: none; padding: 0 25px 25px 25px; }
#profile-thoughts-history-view .profile-header { justify-content: space-between; padding-bottom: 15px; }
#profile-thoughts-history-view .profile-header span { font-size: 18px; font-weight: 600; }
#history-back-btn { width: 36px; height: 36px; background: none; border: none; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; padding: 0; }
#history-back-btn:hover { background-color: rgba(0,0,0,0.05); }
#history-back-btn svg { width: 22px; height: 22px; stroke: #a0a0a0; stroke-width: 2.5; }
#thoughts-history-list {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 5px;
    margin-right: -10px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.thought-card { background-color: #ffffff; border-radius: 16px; padding: 15px 20px; border: 1px solid #eee; }
.thought-header { font-size: 12px; color: #b0b0b0; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
.thought-content .label { display: flex; align-items: center; gap: 6px; font-weight: 600; color: #a0a0a0; font-size: 13px; margin-bottom: 6px; }
.thought-content .label svg { width: 16px; height: 16px; }
.thought-content .text { font-size: 14px; color: #555; line-height: 1.7; white-space: pre-wrap; padding-left: 22px; }
.thought-content .jottings { margin-top: 15px; }
#profile-main-content::-webkit-scrollbar,
#thoughts-history-list::-webkit-scrollbar { display: none; }
#profile-main-content, #thoughts-history-list { -ms-overflow-style: none; scrollbar-width: none; }
.character-profile-content {
    background-color: #ffffff !important;
}
#character-profile-modal .jottings .label {
    display: none;
}
#character-profile-modal .thought-content .text {
    padding-left: 0;
}
#qzone-more-actions-btn {
    font-size: 24px;      
    font-weight: bold;    
    padding: 0 10px;      
    border-radius: 50%;   
    line-height: 1;       
    position: relative;
    top: -2px;            
    transition: background-color 0.2s;
}
#qzone-more-actions-btn:hover {
    background-color: rgba(0,0,0,0.05); 
}
#phone-screen.dark-mode #qzone-more-actions-btn:hover {
    background-color: rgba(255,255,255,0.1);
}
#clear-posts-list {
    overflow-y: auto; 
    flex-grow: 1;
}
.clear-posts-item {
    display: flex;
    align-items: center;
    padding: 12px 18px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s;
}
.clear-posts-item:hover {
    background-color: #f5f5f5;
}
.clear-posts-item .checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
.clear-posts-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}
.clear-posts-item.selected .checkbox::after {
    content: '‚úî';
    font-size: 14px;
    font-weight: bold;
}
.clear-posts-item .name {
    font-weight: 500;
}
.clear-posts-item.danger-option .name {
    color: #ff3b30;
    font-weight: 600;
}
.thought-card {
    position: relative; 
}
.thought-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0,0,0,0.05);
    color: var(--text-secondary);
    font-size: 20px;
    line-height: 26px;
    text-align: center;
    cursor: pointer;
    opacity: 0; 
    transition: all 0.2s ease-in-out;
}
.thought-card:hover .thought-delete-btn {
    opacity: 1;
}
.thought-delete-btn:hover {
    background-color: #ff3b30;
    color: white;
}
.search-result-item {
    display: flex;       
    align-items: center; 
    padding: 12px 18px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s;
}
.search-result-item:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
#phone-screen.dark-mode .search-result-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
.search-result-item .search-result-info {
    flex-grow: 1;
    pointer-events: none; 
}
.search-result-item .music-search-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    flex-shrink: 0;
}
#music-search-results-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#music-search-results-modal .modal-footer {
    display: flex;
    justify-content: space-around;
}
#music-search-results-modal .modal-footer button {
    width: 45%; 
}
.bg-upload-container {
    width: 100%;
    justify-content: center;
    gap: 15px; 
}
.bg-upload-container .form-button-secondary {
    flex-grow: 1; 
    flex-basis: 0; 
    max-width: 180px; 
    margin-top: 0;
    padding: 12px; 
    font-size: 15px;
    font-weight: 600; 
    border-radius: 8px; 
    border: none; 
    background-color: #e9e9eb; 
    color: #1c1c1e; 
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}
.bg-upload-container .form-button-secondary:active {
    transform: scale(0.98); 
}
#remove-global-bg-btn {
    background-color: #ffebee;
    color: #c62828;
}
#character-profile-modal .character-profile-content {
    position: relative; 
    overflow: visible;  
    padding-bottom: 35px; 
}
#character-profile-modal .character-profile-content::before {
    content: '';
    position: absolute;
    top: -10px; 
    left: 0;
    right: 0;
    height: 20px; 
    background-image: radial-gradient(circle at 50% 0, transparent 8px, #f0f2f5 8px);
    background-size: 25px 20px; 
    background-repeat: repeat-x;
}
#character-profile-modal .character-profile-content::after {
    content: '';
    position: absolute;
    bottom: -10px; 
    left: 0;
    right: 0;
    height: 20px; 
    background-image: radial-gradient(circle at 50% 100%, transparent 8px, #f0f2f5 8px);
    background-size: 25px 20px; 
    background-repeat: repeat-x;
}
#character-profile-modal .character-profile-content {
    border-radius: 0;         
    background-color: #ffffff; 
}
#character-profile-modal .character-profile-content::before {
    background-image: radial-gradient(circle at 50% 0, transparent 8px, #ffffff 8px);
}
#character-profile-modal .character-profile-content::after {
    background-image: radial-gradient(circle at 50% 100%, transparent 8px, #ffffff 8px);
}
#character-profile-modal .thought-header {
    position: relative;
    width: 100%;
    padding-bottom: 15px; 
    margin-bottom: 25px; 
    border-bottom: 2px dashed #e0e0e0; 
}
#character-profile-modal .thought-header::before {
    content: '';
    position: absolute;
    bottom: -11px;
    left: -35px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color:  rgba(0, 0, 0, 0.3);
}
#character-profile-modal .thought-header::after {
    content: '';
    position: absolute;
    bottom: -11px;
    right: -35px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color:  rgba(0, 0, 0, 0.3);
}
#character-profile-modal .thought-header {
    height: 140px;         
    flex-shrink: 0;
    padding: 10px;         
    padding-bottom: 25px;  
    box-sizing: border-box;
    border-bottom: 2px dashed #e0e0e0; 
    margin-bottom: 25px;
    position: relative;     
    background-image: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758340625111_qdqqd_zqr2cl.jpeg'); 
    background-size: cover;
    background-position: center top;
    border-radius: 0;      
}
#profile-photo-slot {
    display: none; 
}
#character-profile-modal #profile-main-content .thought-header {
    box-sizing: border-box;
    background-image: url('https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758340625111_qdqqd_zqr2cl.jpeg');
    background-size: cover;
    background-position: center top;
    border-bottom: 2px dashed #e0e0e0;
    margin-bottom: 15px;
    background-clip: content-box; 
    -webkit-background-clip: content-box; 
}
#character-profile-modal #profile-main-content .thought-header::before,
#character-profile-modal #profile-main-content .thought-header::after {
    content: '';
    position: absolute;
    bottom: -11px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.3);
}
#character-profile-modal #profile-main-content .thought-header::before {
    left: -35px;
}
#character-profile-modal #profile-main-content .thought-header::after {
    right: -35px;
}
#character-profile-modal #thoughts-history-list .thought-card .thought-header {
    height: auto;
    padding: 0;
    padding-bottom: 8px; 
    margin-bottom: 12px;
    background-image: none; 
    border: none; 
    border-bottom: 1px solid #f0f0f0; 
}
#character-profile-modal #thoughts-history-list .thought-card .thought-header::before,
#character-profile-modal #thoughts-history-list .thought-card .thought-header::after {
    display: none !important; 
}
#character-profile-modal #profile-main-content .label {
    display: flex !important;
}
#character-profile-modal #profile-main-content .text {
    font-family: "SimSun", "Songti SC", serif; 
    font-size: 16px; 
}
#character-profile-modal .thought-content .label {
    color: #000000 !important;
}
#character-profile-modal .thought-content .text {
    color: #000000 !important;
}
#character-profile-modal #profile-main-content {
    overflow-x: hidden;
}
        #sticker-category-tabs {
            display: flex;
            overflow-x: auto;
            padding: 0 15px; 
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #sticker-category-tabs::-webkit-scrollbar {
            display: none;
        }
        .sticker-category-tab {
            padding: 10px 16px; 
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px; 
            transition: all 0.2s ease-in-out;
            white-space: nowrap; 
        }
        .sticker-category-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            font-weight: 600;
        }
        #phone-screen.dark-mode .sticker-category-tab.active {
            color: #ffffff;
        }
        #sticker-grid.management-mode .sticker-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s;
            pointer-events: none; 
        }
        #sticker-grid.management-mode .sticker-item.selected::after {
            border-color: var(--accent-color);
        }
        #sticker-grid.management-mode .sticker-item .delete-btn {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid white;
        }
        #sticker-action-bar {
            display: none; 
            flex-shrink: 0;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            justify-content: space-between; 
            align-items: center;
        }
        #sticker-action-bar .select-all-label {
            font-size: 16px;
            color: var(--text-primary);
            cursor: pointer;
        }
        #sticker-action-bar button {
            padding: 10px 25px;
            border-radius: 20px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
#character-selection-screen { background-color: #f0f2f5; }
#phone-screen.dark-mode #character-selection-screen { background-color: #000; }
#character-grid {
    padding: 0; 
    overflow-y: auto; 
    flex-grow: 1;
}
.character-select-item {
    display: flex;
    flex-direction: row;     
    align-items: center;     
    cursor: pointer;
    padding: 12px 20px;      
    border-bottom: 1px solid var(--border-color); 
    gap: 15px;               
    transition: background-color 0.2s; 
}
.character-select-item:hover {
    background-color: #f5f5f5; 
}
.character-select-item .avatar {
    width: 45px;             
    height: 45px;
    border-radius: 50%;      
    object-fit: cover;
    margin-bottom: 0;        
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
    flex-shrink: 0;          
}
.character-select-item .name {
    font-weight: 500;
    font-size: 16px;         
    color: var(--text-primary);
}
#character-phone-screen { background-size: cover; background-position: center; }
.char-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
.char-screen.active { opacity: 1; visibility: visible; z-index: 2; }
#char-home-screen { justify-content: flex-start; align-items: center; box-sizing: border-box; padding: 0 20px; }
#char-clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-top: calc(60px + env(safe-area-inset-top)); flex-shrink: 0; margin-bottom: 100px; }
#char-main-time { font-size: 88px; font-weight: 600; letter-spacing: -2px; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; }
#char-main-date { font-size: 22px; font-weight: normal; }
#char-app-grid { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
#char-qq-screen, #char-memo-screen, #char-diary-screen, #char-usage-screen, 
#char-album-screen, #char-browser-screen, #char-taobao-screen {
     background-color: var(--secondary-bg);
}
.memo-item, .diary-item, .usage-item { padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
.memo-item .content, .diary-item .content { font-size: 16px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.diary-item .date, .usage-item .timestamp { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
.usage-item .action { font-size: 15px; color: var(--text-primary); }
#char-album-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); 
    gap: 5px;
    padding: 5px;
}
.char-photo-item {
    aspect-ratio: 1 / 1; 
    background-size: cover;
    background-position: center;
    background-color: #e9ecef;
}
.char-browser-item {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border-color);
}
.char-browser-item .title {
    font-weight: 500;
    font-size: 15px;
    color: var(--text-primary);
    margin-bottom: 4px;
}
.char-browser-item .url {
    font-size: 12px;
    color: var(--accent-color);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#char-product-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    padding: 10px;
}
.char-product-item {
    background-color: var(--secondary-bg);
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
}
.char-product-item .product-image {
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
}
.char-product-item .product-info {
    padding: 12px 10px;
    flex-grow: 1;
}
.char-product-item .product-name {
    font-size: 13px;
    color: #333;
    line-height: 1.4;
    min-height: 36px;
}
.char-product-item .product-price {
    font-size: 16px;
    font-weight: 700;
    color: #ff5722;
    margin-top: 8px;
}
.char-product-item .product-price::before { content: '¬•'; font-size: 12px; }
#char-qq-screen .list-container {
    padding: 0; 
}
#transcript-modal-body {
    display: flex;
    flex-direction: column;
    gap: 20px; 
    padding: 15px; 
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #transcript-modal-body {
    background-color: #000000;
}
#chat-list .chat-list-item,
#char-chat-list .chat-list-item {
    display: flex;
    align-items: center;
    gap: 15px; 
}
#chat-list .chat-list-item .avatar-group,
#char-chat-list .chat-list-item .avatar-group {
    flex-shrink: 0;
}
#chat-list .chat-list-item .info,
#char-chat-list .chat-list-item .info {
    flex-grow: 1;
    min-width: 0; 
}
#char-qq-conversation-screen .list-container {
    display: flex;
    flex-direction: column;
    gap: 20px; 
    padding: 15px; 
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-qq-conversation-screen .list-container {
    background-color: #000000;
}
#char-qq-screen, 
#char-memo-screen, 
#char-diary-screen, 
#char-usage-screen, 
#char-album-screen, 
#char-browser-screen, 
#char-taobao-screen,
#char-browser-article-screen,
#char-wallet-screen {
     background-color: var(--secondary-bg);
}
#char-memo-detail-content {
    width: 100%;
    height: 100%;
    border: none;
    background-color: transparent;
    font-size: 16px;
    line-height: 1.7; 
    padding: 15px 20px; 
    box-sizing: border-box;
    resize: none; 
    outline: none; 
    font-family: inherit; 
    color: var(--text-primary); 
}
#char-memo-detail-screen {
    background-color: var(--secondary-bg);
}
#char-memo-detail-screen .header {
    background-color: var(--secondary-bg); 
    border-bottom: 1px solid var(--border-color); 
    padding-bottom: 10px;
}
#char-memo-detail-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-weight: 600; 
}
#char-memo-detail-screen .form-container {
    padding: 0;
}
#char-memo-detail-content {
    background-color: var(--secondary-bg); 
    padding: 15px 20px; 
    font-size: 17px; 
    line-height: 1.7; 
    color: var(--text-primary);
}
#char-diary-detail-screen {
    background-color: #FDFBF5; 
}
#phone-screen.dark-mode #char-diary-detail-screen {
    background-color: #2c2c2e; 
}
#char-diary-detail-content-wrapper {
    padding: 0;
    overflow-y: auto; 
}
#char-diary-detail-content {
    padding: 25px 20px; 
    font-family: Georgia, 'Times New Roman', Times, serif; 
    font-size: 16px;
    line-height: 1.8; 
    color: #383838; 
}
#phone-screen.dark-mode #char-diary-detail-content {
    color: #e0e0e0;
}
#char-diary-detail-content > p:first-of-type {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
    text-align: center;
}
#char-diary-detail-content strong {
    font-weight: 600; 
}
#char-diary-detail-content .spoiler {
    background-color: #333;
    color: #333;
    padding: 0 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
#char-diary-detail-content .spoiler:hover {
    background-color: #e0e0e0;
    color: inherit;
}
@import url('https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap');
#char-diary-detail-content .diary-highlight {
    background-color: #FFFACD; 
    padding: 1px 4px;
    border-radius: 3px;
    margin: 0 2px;
}
#char-diary-detail-content .diary-underline {
    border-bottom: 2px dotted #FFB6C1; 
    text-decoration: none; 
    padding-bottom: 1px;
}
#char-diary-detail-content .diary-emphasis {
    color: #DB7093; 
    font-weight: bold;
}
#char-diary-detail-content .diary-handwritten {
    font-family: 'Zhi Mang Xing', cursive; 
    font-size: 1.1em; 
    color: #1a1a1a; 
}
#char-diary-detail-content .diary-messy {
    font-family: 'Zhi Mang Xing', cursive;
    font-size: 1.1em;
    color: #1a1a1a;
    transform: rotate(-2deg); 
    display: inline-block; 
    margin: 0 2px;
}
#char-diary-detail-content .diary-censored {
    background-color: #222;
    color: #222; 
    user-select: none; 
    padding: 0 3px;
    border-radius: 2px;
}
.diary-censored:hover, .diary-censored:active {
  background-color: #E0E0E0; 
  color: inherit; 
  cursor: pointer; 
}
#char-amap-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-amap-screen {
    background-color: #000000;
}
#char-amap-list {
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 18px; 
}
.char-amap-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    display: flex;
    flex-direction: column; 
}
.amap-item-header {
    display: flex;
    align-items: flex-start; 
    gap: 12px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 12px;
    margin-bottom: 12px;
}
.amap-item-icon {
    font-size: 24px;
    color: var(--accent-color);
    margin-top: 2px;
}
.amap-item-info {
    flex-grow: 1;
}
.amap-item-title {
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 4px;
}
.amap-item-address {
    font-size: 13px;
    color: var(--text-secondary);
}
.amap-item-body {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.amap-item-comment {
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap; 
}
.amap-item-photo {
    width: 100%;
    height: 150px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    cursor: pointer;
}
.amap-item-footer {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 10px;
    text-align: right;
}
#char-usage-list {
    padding: 10px 0; 
}
.char-usage-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 20px;
    transition: background-color 0.2s;
}
.char-usage-item:hover {
    background-color: rgba(0,0,0,0.03);
}
.usage-item-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px; 
    object-fit: cover;
    flex-shrink: 0;
    background-color: #e9ecef;
}
.usage-item-info {
    flex-grow: 1; 
}
.usage-item-name {
    font-weight: 500;
    font-size: 16px;
}
.usage-item-category {
    font-size: 12px;
    color: var(--text-secondary);
}
.usage-item-time {
    font-size: 15px;
    color: var(--text-secondary);
    font-weight: 500;
    flex-shrink: 0;
}
#char-music-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-music-screen {
    background-color: #000000;
}
#char-music-list {
    padding: 0;
}
.char-music-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.char-music-item:hover {
    background-color: rgba(0,0,0,0.03);
}
.music-item-cover {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}
.music-item-info {
    flex-grow: 1;
    overflow: hidden; 
}
.music-item-name {
    font-weight: 500;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.music-item-artist {
    font-size: 12px;
    color: var(--text-secondary);
}
#char-music-player-modal .modal-content {
    width: 400px !important; 
    height: auto !important; 
    max-height: 90vh;
    background-color: #f7f8fa !important; 
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
}
#char-music-player-modal .char-player-header {
    flex-shrink: 0;
    padding: 12px 15px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
}
#char-music-player-modal .char-player-close-btn {
    background: none;
    border: none;
    font-size: 20px;
    color: #aaa;
    cursor: pointer;
}
#char-music-player-modal .char-player-close-btn:hover {
    color: #333;
}
#char-music-player-modal .char-player-body {
    padding: 30px 35px 20px 35px;
    text-align: center;
}
#char-music-player-modal #char-music-cover {
    width: 220px;
    height: 220px;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    margin-bottom: 20px;
    object-fit: cover;
}
#char-music-player-modal .char-player-progress-bar-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1;
    height: 4px;
    background-color: #e0e0e0;
    border-radius: 2px;
    cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%;
    height: 100%;
    background-color: #555;
    border-radius: 2px;
}
#char-music-player-modal .char-player-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none;
    border: none;
    color: #555;
    cursor: pointer;
    transition: color 0.2s;
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover {
    color: #000;
}
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px;
    height: 50px;
    background-color: #f0f1f3;
    border-radius: 50%;
    color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px;
    font-weight: 500;
    width: 50px;
}
#char-music-player-modal #char-music-lyrics {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 35px 25px 35px;
    font-size: 14px;
    line-height: 2;
    color: #888;
    text-align: center;
}
#char-music-player-modal #char-music-lyrics p.active {
    color: #000;
    font-weight: 600;
}
#char-music-player-modal #char-music-lyrics::-webkit-scrollbar {
    display: none;
}
#char-music-player-modal #char-music-lyrics {
    -ms-overflow-style: none;
    scrollbar-width: none;
}
@keyframes spin-vinyl {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
#char-music-player-modal .modal-content {
    width: 340px !important; 
    height: auto !important;
    background-color: #f0f1f3 !important; 
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
    padding: 20px; 
    position: relative;
}
#char-music-player-modal .modal-header {
    display: none !important;
}
#char-music-player-modal .char-player-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    font-weight: 300;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
}
#char-music-player-modal .char-player-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
}
#char-music-player-modal .char-player-song-info {
    text-align: center;
    margin-bottom: 25px;
}
#char-music-player-modal #char-music-player-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 5px 0;
}
#char-music-player-modal #char-music-artist {
    font-size: 14px;
    color: #888;
    margin: 0;
}
#char-music-player-modal #char-vinyl-container {
    width: 210px;
    height: 210px;
    border-radius: 50%;
    background-color: #222;
    padding: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
    margin-bottom: 25px;
}
#char-music-player-modal #char-vinyl-container.spinning {
    animation: spin-vinyl 12s linear infinite;
}
#char-music-player-modal #char-music-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
#char-music-player-modal #char-lyric-placeholder {
    color: #aaa;
    font-size: 18px;
    letter-spacing: 5px;
    margin-bottom: 25px;
}
#char-music-player-modal .char-player-footer {
    width: 100%;
    margin-top: auto; 
}
#char-music-player-modal .char-player-progress-bar-container {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1; height: 4px; background-color: #e0e0e0; border-radius: 2px; cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%; height: 100%; background-color: #555; border-radius: 2px;
}
#char-music-player-modal .char-player-controls {
    display: flex; align-items: center; justify-content: center; gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none; border: none; color: #555; cursor: pointer; transition: color 0.2s; padding: 5px;
    display: flex; align-items: center; justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover { color: #000; }
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px; height: 50px; background-color: #e0e1e3; border-radius: 50%; color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px; font-weight: 500; width: 50px;
}
#char-music-player-modal #char-music-lyrics {
    /* display: none; */
}
@keyframes spin-vinyl {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
#char-music-player-modal .modal-content {
    width: 340px !important; 
    height: auto !important;
    background-color: #f0f1f3 !important; 
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important;
    color: #333 !important;
    display: flex;
    flex-direction: column;
    padding: 20px; 
    position: relative;
}
#char-music-player-modal .modal-header {
    display: none !important;
}
#char-music-player-modal .char-player-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    font-weight: 300;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
}
#char-music-player-modal .char-player-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-grow: 1;
}
#char-music-player-modal .char-player-song-info {
    text-align: center;
    margin-bottom: 25px;
}
#char-music-player-modal #char-music-player-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 5px 0;
}
#char-music-player-modal #char-music-artist {
    font-size: 14px;
    color: #888;
    margin: 0;
}
#char-music-player-modal #char-vinyl-container {
    width: 210px;
    height: 210px;
    border-radius: 50%;
    background-color: #222;
    padding: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2), 
                inset 0 0 0 2px rgba(255, 255, 255, 0.05);
    background-image: repeating-radial-gradient(circle, #333, #333 1px, #222 1px, #222 2px);
    box-sizing: border-box;
    margin-bottom: 25px;
}
#char-music-player-modal #char-vinyl-container.spinning {
    animation: spin-vinyl 12s linear infinite;
}
#char-music-player-modal #char-music-cover {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}
#char-music-player-modal #char-music-lyrics {
    width: 100%;
    height: 50px; 
    overflow: hidden; 
    position: relative;
    margin-bottom: 25px;
    font-size: 14px;
    line-height: 25px; 
    color: #888;
    text-align: center;
    transition: all 0.3s ease;
}
#char-music-player-modal #char-music-lyrics p {
    margin: 0;
    transition: all 0.3s ease;
}
#char-music-player-modal #char-music-lyrics p.active {
    color: #000;
    font-weight: 600;
    font-size: 16px; 
}
#char-music-player-modal .char-player-footer {
    width: 100%;
    margin-top: auto; 
}
#char-music-player-modal .char-player-progress-bar-container {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
}
#char-music-player-modal .char-player-progress-bar {
    flex-grow: 1; height: 4px; background-color: #e0e0e0; border-radius: 2px; cursor: pointer;
}
#char-music-player-modal #char-music-progress-fill {
    width: 0%; height: 100%; background-color: #555; border-radius: 2px;
}
#char-music-player-modal .char-player-controls {
    display: flex; align-items: center; justify-content: center; gap: 20px;
}
#char-music-player-modal .char-player-controls .control-btn {
    background: none; border: none; color: #555; cursor: pointer; transition: color 0.2s; padding: 5px;
    display: flex; align-items: center; justify-content: center;
}
#char-music-player-modal .char-player-controls .control-btn:hover { color: #000; }
#char-music-player-modal .char-player-controls .control-btn.play {
    width: 50px; height: 50px; background-color: #e0e1e3; border-radius: 50%; color: #333;
}
#char-music-player-modal .char-player-controls .control-btn.mode {
    font-size: 14px; font-weight: 500; width: 50px;
}
#chat-list .chat-list-item {
    gap: 15px !important;
    justify-content: flex-start !important;
}
#chat-list .chat-list-item .avatar-group {
    margin-right: 0 !important;
}
#douban-screen {
    background-color: #F6F6F1; 
}
#phone-screen.dark-mode #douban-screen {
    background-color: #1a1a1a;
}
#douban-posts-list {
    padding: 0; 
    display: flex;
    flex-direction: column;
}
.douban-post-item {
    background-color: var(--secondary-bg);
    padding: 12px 15px;
    border: none;
    box-shadow: none;
    border-bottom: 1px solid var(--border-color); 
    cursor: pointer;
    transition: background-color 0.2s;
}
.douban-post-item:hover {
    background-color: #f9f9f9;
}
#phone-screen.dark-mode .douban-post-item:hover {
    background-color: #2c2c2e;
}
.douban-post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}
.douban-post-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
}
.douban-author-info {
    flex-grow: 1;
}
.douban-author-name {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 14px;
}
.douban-group-name {
    font-size: 12px;
    color: #007722; 
    font-weight: 500;
}
.douban-post-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}
.douban-post-content {
    font-size: 14px;
    color: #555;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
#phone-screen.dark-mode .douban-post-content {
    color: #dcdcdc;
}
.douban-post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
}
.douban-post-actions {
    display: flex;
    gap: 20px;
}
.douban-post-actions span {
    display: flex;
    align-items: center;
    gap: 6px; 
    color: var(--text-secondary); 
}
.douban-post-actions svg {
    width: 18px;
    height: 18px;
    fill: currentColor; 
    position: relative;
    top: -1px; 
}
.douban-feather-btn {
    font-size: 24px;
    padding: 0;
    width: 38px;
    height: 38px;
    line-height: 38px;
    text-align: center;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0; 
    margin-right: 8px; 
    background-color: #f0f2f5;
    color: #555;
    transition: background-color 0.2s;
}
.douban-feather-btn:hover {
    background-color: #e2e6ea;
}
.douban-feather-btn svg {
    width: 20px;
    height: 20px;
}
#douban-post-detail-screen {
    background-color: #F6F6F1; 
}
#phone-screen.dark-mode #douban-post-detail-screen {
    background-color: #1a1a1a;
}
#douban-detail-content-wrapper {
    background-color: var(--secondary-bg);
    padding: 0; 
    padding-bottom: 80px; 
}
#douban-post-detail-body {
    padding: 20px 18px 25px 18px; 
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode #douban-post-detail-body {
    border-bottom-color: #38383a;
}
.douban-post-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    line-height: 1.5;
}
.douban-detail-content {
    white-space: pre-wrap;
    line-height: 1.8;
    font-size: 15px;
    color: #333;
}
#phone-screen.dark-mode .douban-detail-content {
    color: #dcdcdc;
}
.douban-comments-section {
    margin-top: 0;
    padding: 15px 18px;
}
.douban-comments-section h4 {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    margin: 0 0 15px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
#phone-screen.dark-mode .douban-comments-section h4 {
    border-bottom-color: #38383a;
}
.douban-comment-item {
    display: flex;
    gap: 12px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}
.douban-comment-item:last-child {
    border-bottom: none;
}
#phone-screen.dark-mode .douban-comment-item {
    border-bottom-color: #38383a;
}
.douban-comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
}
.douban-comment-body {
    flex-grow: 1;
}
.douban-comment-author {
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
}
.douban-comment-text {
    font-size: 14px;
    color: #555;
    margin-top: 6px;
    line-height: 1.7;
    word-break: break-word;
}
#phone-screen.dark-mode .douban-comment-text {
    color: #b0b0b0;
}
#douban-comment-footer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 10px 18px; 
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    box-sizing: border-box; 
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color); 
}
#douban-send-comment-btn {
    background-color: #007722; 
}
#douban-screen .header .header-actions {
    flex-shrink: 0;
    display: flex;       
    align-items: center; 
}
.header .action-btn svg {
    width: 24px;   
    height: 24px;
    display: block; 
}
.header .action-btn {
    min-width: 30px; 
    display: flex;
    align-items: center;
    justify-content: center;
}
.header .header-left-actions {
    display: flex;
    align-items: center;
    gap: 15px; 
}
        .char-photo-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px; 
            box-sizing: border-box;
        }
        .char-photo-description {
            font-size: 13px;
            color: var(--text-secondary); 
            text-align: center;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 5; 
            overflow: hidden;
            word-break: break-all; 
        }
        .char-product-description-overlay {
            width: 100%;
            aspect-ratio: 1 / 1; 
            background-color: #f7f8fa; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px; 
            box-sizing: border-box;
            border-bottom: 1px solid #eee; 
            border-radius: 8px 8px 0 0; 
        }
        .char-product-description-overlay .char-photo-description,
        .char-browser-image-description { 
            font-size: 14px; 
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 6; 
            overflow: hidden;
            word-break: break-all;
        }
        .char-browser-image-description {
            padding: 40px 20px; 
        }
.char-product-status {
    font-size: 12px;
    color: #8a8a8a; 
    background-color: #f0f2f5; 
    padding: 3px 8px;
    border-radius: 10px;
}
#search-history-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #search-history-screen {
    background-color: #000000;
}
#search-results-list {
    flex-grow: 1;
    overflow-y: auto;
}
.date-separator {
    text-align: center;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 10px 0;
    font-weight: 500;
}
#phone-screen.dark-mode #search-bar input {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
        #home-screen {
            flex-direction: column;
            padding: 0; 
        }
        #home-screen-pages-container {
            flex-grow: 1; 
            width: 100%;
            overflow: hidden; 
            position: relative;
        }
        #home-screen-pages {
            display: flex;
            width: 300%; 
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .home-screen-page {
            width: 33.333333%; 
            height: 100%;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: 0; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #home-screen-pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom) / 2);
            flex-shrink: 0;
        }
        .pagination-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }
        .pagination-dot.active {
            background-color: white;
            transform: scale(1.1);
        }
.draggable-button-item {
    padding: 8px 12px;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    cursor: grab;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s, box-shadow 0.2s;
    user-select: none;
}
.draggable-button-item:active {
    cursor: grabbing;
}
.draggable-button-item svg {
    width: 18px;
    height: 18px;
    stroke-width: 2;
}
.draggable-button-item.dragging {
    opacity: 0.5;
    background-color: #e0e0e0;
}
.draggable-button-item.drag-over {
    background-color: #d0eaff;
    box-shadow: 0 0 0 2px var(--accent-color);
}
.draggable-button-item.dragging {
    opacity: 0.5;
    background-color: #e0e0e0;
    position: relative; 
    z-index: 10;
}
#button-order-editor {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.scrollable-content-preview {
    max-height: 35vh;
    overflow-y: auto;
    background-color: #f0f2f5;
    padding: 10px 15px;
    border-radius: 8px;
    text-align: left;
    white-space: pre-wrap; 
    border: 1px solid var(--border-color);
}
.wizard-step {
    display: none; 
    flex-direction: column;
    width: 100%;
    height: 100%;
}
.wizard-step.active {
    display: flex; 
}
#data-clear-char-list .clear-posts-item,
#data-clear-type-list .clear-posts-item {
    padding: 12px 18px;
}
#data-clear-wizard-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#data-clear-wizard-modal .modal-header label {
    font-size: 14px;
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}
#tutorial-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #tutorial-screen {
    background-color: #000000;
}
.entry-content-container {
    display: none; 
    margin-top: 8px; 
}
.toggle-content-btn {
    background: none;
    border: 1px solid #ccc;
    color: var(--text-secondary);
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 5px;
    cursor: pointer;
}
#update-notice-modal {
    position: fixed; 
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    display: none; 
    align-items: center;
    justify-content: center;
    z-index: 2000; 
    opacity: 0;
    transition: opacity 0.3s ease;
}
#update-notice-modal.visible {
    display: flex;
    opacity: 1;
}
.update-notice-content {
    background-color: var(--secondary-bg);
    width: 300px;
    border-radius: 14px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
#update-notice-modal.visible .update-notice-content {
    transform: scale(1);
}
.update-notice-body {
    padding: 20px;
    font-size: 15px;
    line-height: 1.6;
    color: #333;
    max-height: 60vh; 
    overflow-y: auto; 
}
.update-notice-footer {
    border-top: 1px solid #dbdbdb;
    display: flex;
}
.update-notice-footer button {
    flex: 1;
    background: none;
    border: none;
    padding: 14px;
    font-size: 17px;
    cursor: pointer;
    color: var(--accent-color);
}
.update-notice-footer button:first-child {
    border-right: 1px solid #dbdbdb;
    font-weight: 600;
}
#message-actions-modal .custom-modal-footer {
    flex-wrap: wrap; 
    padding: 10px;   
    gap: 10px;       
    justify-content: flex-start; 
}
#message-actions-modal .custom-modal-footer button:not(#cancel-message-action-btn) {
    flex-grow: 1;
    flex-basis: 75px; 
    border: none;
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 12px 5px; 
    font-size: 16px;
    font-weight: 500;
}
#message-actions-modal #cancel-message-action-btn {
    width: 100%; 
    flex-basis: 100%; 
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f2f5;
    font-weight: 600;
}
input, textarea, select {
    font-size: 16px !important;
}
#favorite-diary-btn.active svg {
    fill: #ffc107; 
    color: #ffc107;
}
.favorite-item-card .diary-title {
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
    font-size: 15px;
}
.favorite-item-card .diary-content-preview {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3; 
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.favorite-item-card .diary-content-preview {
    font-size: 13px;
    opacity: 0.8;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3; 
    -webkit-box-orient: vertical;
    overflow: hidden;
}
#npc-list-view {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #npc-list-view {
    background-color: #000;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px; 
}
.spectator-actions-container {
    display: flex;
    gap: 12px; 
    align-items: center;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent; 
    color: var(--accent-color);   
    border: 1px solid var(--accent-color); 
    padding: 8px 18px; 
    font-size: 14px;
}
.spectator-actions-container .lock-action-btn.secondary svg {
    width: 20px;  
    height: 20px; 
    stroke: currentColor; 
}
.music-player-window {
    position: relative;
    background-color: rgba(255, 255, 255, 0.75);
}
.music-player-window::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: var(--music-bg-image);
    background-size: cover;
    background-position: center;
    filter: blur(15px) brightness(0.8);
    z-index: -1;
    border-radius: inherit; 
    transition: background-image 0.5s ease-in-out;
}
.music-player-window.bg-clear::before {
    filter: none;
}
#toggle-blur-btn {
    background: none;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    color: #333;
    width: 44px;
    height: 44px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.05);
}
#toggle-blur-btn.active {
    background-color: var(--accent-color); 
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.music-player-window.fullscreen {
    width: 100%;
    height: 100%;
    max-height: 100%; 
    border-radius: 0; 
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
}
#music-player-overlay.fullscreen-active {
    padding-top: 0;
    align-items: stretch; 
}
#toggle-fullscreen-btn {
    background: none;
    border: none;
    font-size: 22px; 
    cursor: pointer;
    color: #555;
    padding: 5px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s;
}
#toggle-fullscreen-btn:hover {
    color: #000;
}
#toggle-fullscreen-btn .icon-minimize {
    display: none;
}
.music-player-window.fullscreen #toggle-fullscreen-btn .icon-maximize {
    display: none;
}
.music-player-window.fullscreen #toggle-fullscreen-btn .icon-minimize {
    display: block;
}
#music-player-avatar-display {
    display: none; 
    width: 100%;
    padding: 15px 20px;
    box-sizing: border-box;
    justify-content: space-between; 
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1); 
    margin-bottom: 10px;
}
.music-player-window.fullscreen #music-player-avatar-display.visible {
    display: flex;
}
.participant-display-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
#show-avatars-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    display: none; 
    align-items: center;
    justify-content: center;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.music-player-window.fullscreen #show-avatars-btn {
    display: flex;
}
#show-avatars-btn:hover {
    opacity: 1;
}
#show-avatars-btn.active {
    opacity: 1;
}
.douban-settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.douban-settings-item label {
    margin-bottom: 0;
    flex-grow: 1; 
}
.douban-settings-controls {
    display: flex;
    align-items: center;
    gap: 8px; 
    flex-shrink: 0; 
}
.douban-settings-controls input {
    width: 60px;
    text-align: center;
}
#time-zone-search-input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 8px; 
    border: 1px solid var(--border-color);
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 16px; 
}
#phone-screen.dark-mode #time-zone-search-input {
    background-color: #1c1c1e;
    color: #ffffff;
    border-color: #38383a;
}
#werewolf-game-screen {
    background-color: #2c2c2e; 
    color: white;
}
#werewolf-player-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 15px;
    padding: 15px;
    flex-shrink: 0;
    border-bottom: 1px solid #444;
}
.werewolf-player-avatar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    position: relative;
}
.werewolf-player-avatar img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid #888;
    transition: all 0.3s;
}
.werewolf-player-avatar .player-name {
    font-size: 12px;
    font-weight: 500;
    text-shadow: 0 1px 2px black;
}
.werewolf-player-avatar.dead img {
    filter: grayscale(100%);
    border-color: #ff3b30;
}
.werewolf-player-avatar.dead .player-name {
    color: #ff3b30;
    text-decoration: line-through;
}
#werewolf-log {
    padding: 15px;
    background: none;
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.werewolf-log-entry {
    background-color: rgba(255, 255, 255, 0.08);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
}
.werewolf-log-entry.system {
    text-align: center;
    color: #ffc107;
    font-style: italic;
    background-color: rgba(255, 193, 7, 0.1);
}
.werewolf-log-entry .speaker {
    font-weight: bold;
}
#werewolf-action-bar {
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(0,0,0,0.3);
    flex-shrink: 0;
    text-align: center;
}
#werewolf-next-step-btn {
    width: 100%;
}
#werewolf-role-card {
    background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
    border: 1px solid #666;
    border-radius: 12px;
    padding: 20px;
    color: white;
}
#werewolf-role-name {
    font-size: 22px;
    font-weight: bold;
    color: #ffc107;
    margin-bottom: 10px;
}
#werewolf-role-description {
    font-size: 14px;
    line-height: 1.6;
}
.werewolf-selection-item {
    display: flex;
    align-items: center;
    padding: 12px 18px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.werewolf-selection-item.selected {
    background-color: var(--accent-color);
    color: white;
}
.werewolf-selection-item img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 15px;
}
.werewolf-selection-item .name {
    font-weight: 500;
}
        #werewolf-game-screen #werewolf-action-bar {
            background-color: rgba(0, 0, 0, 0.3); 
            border-top: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 10px 15px; 
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
        }
        #werewolf-game-screen #werewolf-user-input {
            flex-grow: 1; 
            border: none;
            padding: 10px 15px;
            border-radius: 20px; 
            background-color: rgba(255, 255, 255, 0.1); 
            color: #f0f0f0; 
            font-size: 16px; 
            resize: none; 
            height: 40px; 
            box-sizing: border-box;
        }
        #werewolf-game-screen #werewolf-user-input::placeholder {
            color: #8d8d92; 
        }
        #werewolf-game-screen #input-actions-wrapper button {
            height: 40px;
            padding: 0 15px;
            border-radius: 20px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0; 
        }
        #werewolf-game-screen #werewolf-wait-reply-btn {
            background-color: #555; 
        }
        #werewolf-game-screen #werewolf-finish-speech-btn {
            background-color: #c62828; 
        }
#sticker-search-container {
    padding: 10px 15px; 
    flex-shrink: 0; 
    border-bottom: 1px solid var(--border-color); 
    background-color: var(--secondary-bg); 
}
#sticker-search-input {
    width: 100%;
    padding: 10px 15px;
    font-size: 16px; 
    border: 1px solid var(--border-color);
    border-radius: 18px; 
    background-color: #f0f2f5; 
    box-sizing: border-box;
    outline: none; 
    -webkit-appearance: none; 
}
#sticker-search-input:focus {
    border-color: var(--accent-color); 
    background-color: var(--secondary-bg); 
}
#phone-screen.dark-mode #sticker-search-input {
    background-color: #2c2c2e;
    color: #f0f0f0;
    border-color: #38383a;
}
#phone-screen.dark-mode #sticker-search-input:focus {
    background-color: #38383a;
}
.message-bubble .content {
    transition: background-color 0.5s ease-out;
}
.message-bubble.highlighted .content {
    background-color: rgba(0, 123, 255, 0.2) !important;
}
.loader-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px 0;
    width: 100%;
    height: 44px; 
    box-sizing: border-box;
}
.spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(0, 0, 0, 0.1); 
    border-top-color: var(--accent-color); 
    border-radius: 50%;
    animation: spin 1s linear infinite; 
}
#phone-screen.dark-mode .spinner {
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top-color: #fff; 
}
#reading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 150; 
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none; 
    display: none; 
}
#reading-window {
    width: 90%;
    max-width: 340px;
    height: 60vh;
    max-height: 480px;
    background-color: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.18);
    display: flex;
    flex-direction: column;
    pointer-events: auto; 
    position: absolute; 
    transition: transform 0.3s ease, opacity 0.3s ease, visibility 0s 0.3s; 
}
#phone-screen.dark-mode #reading-window {
    background-color: rgba(40, 40, 42, 0.7);
}
.reading-header {
    cursor: move;
    user-select: none;
    -webkit-user-select: none;
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    gap: 10px;
    flex-wrap: nowrap;
}
#reading-title {
    font-weight: 600;
    flex: 1;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.reading-controls {
    flex-shrink: 0;
}
.reading-controls button {
    background: none; border: none; color: var(--text-secondary); padding: 4px 8px;
    border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.2s;
}
.reading-controls button:hover {
    background-color: rgba(0,0,0,0.1);
}
#minimize-reading-btn {
    font-weight: bold; font-size: 16px; line-height: 1;
}
#reading-window.minimized {
    transform: scale(0.8); 
    opacity: 0;           
    pointer-events: none; 
    visibility: hidden;   
}
#reading-restore-btn {
    position: absolute;
    top: 50%;
    right: 15px; 
    transform: translateY(-50%); 
    width: 50px; 
    height: 50px;
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px; 
    cursor: move; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    pointer-events: auto; 
    z-index: 160; 
    transition: transform 0.2s; 
}
#reading-restore-btn:active {
    transform: translateY(-50%) scale(0.95);
}
#phone-screen.dark-mode #reading-restore-btn {
    background-color: rgba(50, 50, 52, 0.8);
}
#reading-content {
    flex-grow: 1; 
    overflow-y: auto; 
    padding: 15px;
    font-size: 15px; 
    line-height: 1.8;
    white-space: pre-wrap; 
    word-break: break-word;  
}
.reading-footer {
    flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
    padding: 12px 15px; border-top: 1px solid var(--border-color);
}
#page-indicator {
    font-size: 14px; 
    color: var(--text-secondary);
    cursor: pointer; 
    transition: color 0.2s;
}
#page-indicator:hover {
    color: var(--accent-color); 
}
.reading-footer button {
    padding: 6px 15px; border-radius: 15px; border: none;
    background-color: var(--accent-color); color: white; cursor: pointer;
}
.reading-footer button:disabled {
    background-color: #ccc;
}
#phone-screen.dark-mode .reading-footer button:disabled {
    background-color: #555;
}
#reading-library-search-container {
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0; 
}
#reading-library-search-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 16px; 
    -webkit-appearance: none; 
}
#phone-screen.dark-mode #reading-library-search-input {
    background-color: #2c2c2e;
    color: #f0f0f0;
    border-color: #38383a;
}
.voice-message-body {
    display: flex;
    align-items: center;
    cursor: pointer;
    min-width: 80px;
    max-width: 220px;
    padding: 8px 12px;
}
.message-bubble.user .voice-message-body {
    color: #1a3d00;
    flex-direction: row-reverse;
}
.message-bubble.ai .voice-message-body {
    color: var(--text-primary);
}
.voice-play-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: rgba(0, 0, 0, 0.1);
    color: currentColor;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: background-color 0.2s;
}
.voice-play-btn:hover {
    background-color: rgba(0, 0, 0, 0.2);
}
.voice-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-top-color: var(--accent-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: none; 
    margin: 4px;
}
.voice-duration {
    font-size: 14px;
    font-weight: 500;
    margin: 0 10px;
    flex-shrink: 0;
}
.message-bubble.user .voice-duration {
    color: #3e6224;
}
#product-category-tabs {
    display: flex;
    overflow-x: auto; 
    padding: 10px 15px 0 15px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
    -ms-overflow-style: none;  
    scrollbar-width: none;  
}
#product-category-tabs::-webkit-scrollbar {
    display: none; 
}
.product-category-tab {
    padding: 8px 16px;
    cursor: pointer;
    border: none;
    background-color: transparent;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent; 
    margin-bottom: -1px; 
    transition: all 0.2s ease-in-out;
    white-space: nowrap; 
    flex-shrink: 0; 
}
.product-category-tab.active {
    color: #FF5722; 
    border-bottom-color: #FF5722; 
    font-weight: 600; 
}
#phone-screen.dark-mode .product-category-tab.active {
    color: #FF8A65; 
    border-bottom-color: #FF8A65;
}
#product-category-tabs {
    overflow-x: auto;      
    white-space: nowrap;   
    -webkit-overflow-scrolling: touch; 
    scrollbar-width: none;             
    -ms-overflow-style: none;          
}
#product-category-tabs::-webkit-scrollbar {
    display: none; 
}
.product-category-tab {
    flex-shrink: 0;
}
        #shopping-screen.management-mode .product-item {
            cursor: pointer;
        }
        #shopping-screen.management-mode .product-management-overlay {
            display: none;
        }
        #shopping-screen.management-mode .product-item::before {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 22px;
            height: 22px;
            border: 2px solid #ccc;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
            z-index: 6; 
        }
        #shopping-screen.management-mode .product-item.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: '‚úî';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 22px;
        }
        #shopping-screen.management-mode .product-item:not(.selected) {
            opacity: 0.8;
        }
        #shopping-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: auto;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            box-sizing: border-box;
            z-index: 5;
            display: none; 
            justify-content: space-between;
            align-items: center;
        }
        #shopping-action-bar .select-all-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            color: var(--text-primary);
            cursor: pointer;
        }
        #shopping-action-bar .action-bar-btn {
            padding: 10px 25px;
            border-radius: 20px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }
.polaroid-widget-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px; 
    flex-shrink: 0;
    margin-top: 20px; 
}
.polaroid-photos {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px; 
}
.polaroid-photo {
    background-color: white;
    padding: 8px 8px 15px 8px; 
    border-radius: 4px;
    box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2); 
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.25s;
    width: 80px; 
    flex-shrink: 0;
}
.polaroid-photo:hover {
    transform: scale(1.1) rotate(0deg) !important; 
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    z-index: 10; 
}
.polaroid-photo img {
    width: 100%;
    display: block;
    aspect-ratio: 1 / 1; 
    object-fit: cover;
}
.polaroid-widget-title {
    margin-top: 15px;
    font-size: 13px;
    font-weight: 500;
    color: white; 
    text-shadow: 0 1px 3px rgba(0,0,0,0.4); 
}
#page-2-app-container {
    display: grid;
    grid-template-columns: 155px 1fr; 
    gap: 15px;
    width: 100%;
    padding-top: 20px;
    align-items: start;
}
.app-subgrid {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 15px; 
}
.large-widget {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px; 
}
.large-widget-img {
    width: 100%;
    aspect-ratio: 1 / 1; 
    border-radius: 22px; 
    object-fit: cover;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.large-widget-label {
    color: white;
    font-size: 13px;
    font-weight: 500;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.small-widget {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}
.small-widget-icon-wrapper {
    width: 55px;
    height: 55px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.small-widget-img {
    width: 100%;     
    height: 100%;    
    object-fit: cover; 
    border-radius: 14px; 
}
.small-widget-label {
    color: white;
    font-size: 13px;
    font-weight: 500;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
#page-2-app-container .small-widget-label {
    color: #000 !important;       
    text-shadow: none !important; 
}
#phone-screen.dark-mode #char-diary-list .list-item .item-title,
#phone-screen.dark-mode #char-diary-list .list-item .item-content,
#phone-screen.dark-mode #char-memo-list .list-item .item-title,
#phone-screen.dark-mode #char-memo-list .list-item .item-content,
#phone-screen.dark-mode #char-browser-history .char-browser-item .title,
#phone-screen.dark-mode #char-usage-list .usage-item-name,
#phone-screen.dark-mode #char-music-list .music-item-name {
    color: #f0f0f0; 
}
#phone-screen.dark-mode #char-diary-list .list-item .item-content,
#phone-screen.dark-mode #char-browser-history .char-browser-item .url,
#phone-screen.dark-mode #char-usage-list .usage-item-category,
#phone-screen.dark-mode #char-music-list .music-item-artist {
    color: #a0a0a0; 
}
#phone-screen.dark-mode #char-diary-detail-content .diary-highlight {
    background-color: rgba(255, 223, 100, 0.2); 
    color: #FFD700; 
}
#phone-screen.dark-mode #char-diary-detail-content .diary-underline {
    border-bottom-color: #FF85B3; 
}
#phone-screen.dark-mode #char-diary-detail-content .diary-emphasis {
    color: #FF85B3; 
}
#phone-screen.dark-mode #char-diary-detail-content .diary-handwritten,
#phone-screen.dark-mode #char-diary-detail-content .diary-messy {
    color: #dcdcdc; 
}
#phone-screen.dark-mode .spoiler {
    background-color: #444; 
    color: #444;           
}
#phone-screen.dark-mode .spoiler:hover, 
#phone-screen.dark-mode .spoiler:active {
    background-color: #555; 
    color: #fff;           
}
#avatar-frame-modal .frame-grid.management-mode .frame-item {
    cursor: pointer;
}
#avatar-frame-modal .frame-grid.management-mode .frame-item:has(.delete-btn)::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    width: calc(100% + 4px);
    height: calc(100% + 4px);
    border: 3px solid transparent;
    border-radius: 12px;
    box-sizing: border-box;
    transition: border-color 0.2s;
    pointer-events: none; 
}
#avatar-frame-modal .frame-grid.management-mode .frame-item.selected::after {
    border-color: var(--accent-color);
}
#frame-action-bar {
    display: none; 
    flex-shrink: 0;
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    justify-content: space-between;
    align-items: center;
}
#frame-action-bar .select-all-label {
    font-size: 16px;
    color: var(--text-primary);
    cursor: pointer;
}
#frame-action-bar .action-bar-btn {
    padding: 10px 25px;
    border-radius: 20px;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}
#favorite-memo-btn.active svg {
    fill: #ffc107; 
    color: #ffc107;
}
.favorite-item-card .memo-title {
    font-weight: 600;
    display: block;
    margin-bottom: 8px;
    font-size: 15px;
}
#chat-interface-screen .back-btn {
    position: relative; 
}
.back-btn .unread-indicator {
    position: absolute;
    top: -2px;
    right: -10px;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 20; 
    transform: scale(0.8);
}
#phone-screen.dark-mode .back-btn .unread-indicator {
    border: 1px solid #333;
}
#favorite-article-btn.active svg {
    fill: #ffc107; 
    color: #ffc107;
}
.modal,
#custom-modal-overlay,
#transfer-modal,
#battery-alert-modal,
#photo-viewer-modal,
#character-profile-modal,
#update-notice-modal {
    background-color: transparent !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
}
#character-profile-modal .jottings .label {
    display: flex !important;
}
#total-image-size-display{ /* <--- Âú®ËøôÈáåÊ∑ªÂä†‰∫Ü ID */
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 15px;
    padding: 8px 12px;
    background-color: #f0f2f5;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

#phone-screen.dark-mode #total-image-size-display{ /* <--- Âú®ËøôÈáåÊ∑ªÂä†‰∫Ü ID */
    background-color: #2c2c2e; 
    border-color: #38383a;
}

#total-image-size-display #image-size-label{ /* <--- Êñ∞Â¢û */
    font-weight: 500;
}

#total-image-size-display #image-size-value,
#token-count-display #token-count-value,
#message-count-display #message-count-value { /* <--- Êñ∞Â¢û */
    font-weight: 600;
    color: var(--text-primary);
}

/* ‚ñº‚ñº‚ñº RealImagÂ§öÂõæÂ∏ÉÂ±ÄÊ†∑Âºè ‚ñº‚ñº‚ñº */
/* Â§öÂõæÂÆπÂô® */
.post-images-grid {
    display: grid;
    gap: 8px;  /* ÂõæÁâá‰πãÈó¥ÁöÑÂõ∫ÂÆöÈó¥Ë∑ù */
    margin-top: 10px;
}

/* ÂçïÂº†ÂõæÁâá - Â§ßÂõæÔºåÁ≠âÊØî‰æãÁº©Êîæ */
.post-images-grid.grid-1 {
    grid-template-columns: 1fr;
    justify-items: start;
}
.post-images-grid.grid-1 .realimag-image,
.post-images-grid.grid-1 .naiimag-image {
    max-width: 280px;
    max-height: 280px;
    width: auto;
    height: auto;
}

/* 2Âº†ÂõæÁâá - Ê®™ÂêëÂπ∂ÊéíÔºåÁ≠âÊØî‰æãÁº©Êîæ */
.post-images-grid.grid-2 {
    grid-template-columns: auto auto;
    gap: 5px;
    justify-content: start;
}
.post-images-grid.grid-2 .realimag-image,
.post-images-grid.grid-2 .naiimag-image {
    max-width: 135px;
    max-height: 135px;
    width: auto;
    height: auto;
}

/* 3Âº†ÂõæÁâá - Ê®™ÂêëÊéíÂàóÔºåÁ≠âÊØî‰æãÁº©Êîæ */
.post-images-grid.grid-3 {
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
}
.post-images-grid.grid-3 .realimag-image {
    max-width: 130px;
    max-height: 130px;
    width: auto;
    height: auto;
}

/* 4Âº†ÂõæÁâá - 2x2ÊñπÊ†ºÔºåÁ≠âÊØî‰æãÁº©Êîæ */
.post-images-grid.grid-4 {
    grid-template-columns: repeat(2, 1fr);
    gap: 5px;
}
.post-images-grid.grid-4 .realimag-image {
    max-width: 195px;
    max-height: 195px;
    width: auto;
    height: auto;
}

/* 5Âº†ÂõæÁâá - ‰∏ä2‰∏ã3ÔºåÁ≠âÊØî‰æãÁº©Êîæ */
.post-images-grid.grid-5 {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 5px;
}
.post-images-grid.grid-5 .realimag-image:nth-child(1),
.post-images-grid.grid-5 .realimag-image:nth-child(2) {
    grid-column: span 3;
    max-width: 195px;
    max-height: 195px;
    width: auto;
    height: auto;
}
.post-images-grid.grid-5 .realimag-image:nth-child(n+3) {
    grid-column: span 2;
    max-width: 130px;
    max-height: 130px;
    width: auto;
    height: auto;
}

/* 6Âº†ÂõæÁâá - 3x2ÁΩëÊ†ºÔºåÁ≠âÊØî‰æãÁº©Êîæ */
.post-images-grid.grid-6 {
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
}
.post-images-grid.grid-6 .realimag-image {
    max-width: 130px;
    max-height: 130px;
    width: auto;
    height: auto;
}

/* 7-9Âº†ÂõæÁâá - 3x3‰πùÂÆ´Ê†ºÔºåÁ≠âÊØî‰æãÁº©Êîæ */
.post-images-grid.grid-7,
.post-images-grid.grid-8,
.post-images-grid.grid-9 {
    grid-template-columns: repeat(3, 1fr);
    gap: 5px;
}
.post-images-grid.grid-7 .realimag-image,
.post-images-grid.grid-8 .realimag-image,
.post-images-grid.grid-9 .realimag-image {
    max-width: 130px;
    max-height: 130px;
    width: auto;
    height: auto;
}

/* ÂõæÁâáÂü∫Á°ÄÊ†∑Âºè - ÂÆåÊï¥ÊòæÁ§∫ÔºåÁ≠âÊØî‰æãÁº©ÊîæÔºå‰∏çË£ÅÂâ™ */
.post-images-grid .realimag-image,
.post-images-grid .naiimag-image {
    object-fit: contain;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}
.post-images-grid .realimag-image:hover,
.post-images-grid .naiimag-image:hover {
    transform: scale(1.05);
}
/* ‚ñ≤‚ñ≤‚ñ≤ RealImagÂ§öÂõæÂ∏ÉÂ±ÄÊ†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
/* „Äê‰øÆÂ§ç„ÄëËß£ÂÜ≥Â§úÈó¥Ê®°Âºè‰∏ãÊµèËßàÂô®ÂíåË∂≥ËøπÈ°µÈù¢ÊñáÂ≠óÈ¢úËâ≤‰∏çÊ≠£Á°ÆÁöÑÈóÆÈ¢ò */
#phone-screen.dark-mode #browser-content {
    color: #dcdcdc; /* ÊµèËßàÂô®ÊñáÁ´†Ê≠£ÊñáÈ¢úËâ≤ */
}
#phone-screen.dark-mode #browser-content .article-title {
    color: #ffffff; /* ÊµèËßàÂô®ÊñáÁ´†Ê†áÈ¢òÈ¢úËâ≤ */
}
#phone-screen.dark-mode #browser-content .article-meta {
    color: #8d8d92; /* ÊµèËßàÂô®ÊñáÁ´†ÂÖÉÊï∞ÊçÆÔºàÊù•Ê∫êÔºâÈ¢úËâ≤ */
    border-bottom-color: #38383a;
}
#phone-screen.dark-mode .amap-item-title {
    color: #f0f0f0; /* Ë∂≥Ëøπ - Âú∞ÁÇπÊ†áÈ¢òÈ¢úËâ≤ */
}
#phone-screen.dark-mode .amap-item-comment {
    color: #dcdcdc; /* Ë∂≥Ëøπ - ËØÑËÆ∫ÂÜÖÂÆπÈ¢úËâ≤ */
}
/* „Äê‰øÆÂ§ç„ÄëCPhone ÊµèËßàÂô®ËØ¶ÊÉÖÈ°µÂú®Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÊñáÂ≠óÈ¢úËâ≤ */
#phone-screen.dark-mode #char-article-content {
    color: #dcdcdc; /* ËÆæÁΩÆ‰∏∫ÊµÖÁÅ∞Ëâ≤Ôºå‰ΩøÂÖ∂Âú®Ê∑±Ëâ≤ËÉåÊôØ‰∏äÂèØËßÅ */
}
#char-article-content {
    color: #333; /* CPhone ÊµèËßàÂô®ÊñáÁ´†Ê≠£Êñá - ÁôΩÂ§©Ê®°ÂºèÈªòËÆ§È¢úËâ≤ */
}

#open-nai-gallery-btn svg path {
    fill: currentColor;
    stroke: none;
}

#nai-gallery-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 65%; /* ÁîªÂªäÈù¢ÊùøÈ´òÂ∫¶ */
    background-color: rgba(242, 242, 247, 0.85);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-top: 1px solid var(--border-color);
    border-radius: 20px 20px 0 0;
    z-index: 200;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    visibility: hidden;
}

#nai-gallery-panel.visible {
    transform: translateY(0);
    visibility: visible;
}

#nai-gallery-panel-header {
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
}
#nai-gallery-panel-header .title {
    font-weight: 600;
}
#nai-gallery-panel-header .panel-btn {
    font-size: 16px;
    padding: 5px 10px;
    cursor: pointer;
    color: var(--accent-color);
}

#nai-gallery-grid {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
}

.nai-gallery-item {
    position: relative;
    display: flex;
    flex-direction: column; 
    align-items: center;    
    gap: 6px;               
    cursor: pointer;
    /* ÁßªÈô§‰∫ÜËÉåÊôØ„ÄÅÈò¥ÂΩ±Á≠âÂ±ûÊÄßÔºåÂõ†‰∏∫ÂÆÉ‰ª¨Â∞ÜÁßªÂà∞Â≠êÂÖÉÁ¥†‰∏ä */
}
/* Êñ∞Â¢ûÔºöNAIÁöÑÂõæÁâáÂÆπÂô®ÔºåÊ†∑ÂºèÊ®°‰ªø .sticker-image-container */
.nai-image-container {
    position: relative; /* Áî®‰∫éÂÆö‰ΩçÂÜÖÈÉ®ÁöÑ controls */
    width: 100%;
    aspect-ratio: 1 / 1;
    background-color: white;
    border-radius: 10px;
    background-size: contain; /* Ê†∏ÂøÉ‰øÆÊîπÔºö‰øùÊåÅÂõæÁâáÂÆåÊï¥ */
    background-repeat: no-repeat;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    overflow: hidden; /* ÈöêËóèÊ∫¢Âá∫ÁöÑ controls */
}

/* Êñ∞Â¢ûÔºöNAIÁöÑÊñáÂ≠óÊ†áÁ≠æÔºåÊ†∑ÂºèÊ®°‰ªø .sticker-name */
.nai-gallery-name {
    font-size: 12px;
    color: var(--text-secondary);
    width: 100%;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.nai-image-container .nai-gallery-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 4px;
    background: rgba(0,0,0,0.4);
    display: none; /* ‰ªÖÂú®ÁÆ°ÁêÜÊ®°Âºè‰∏ãÊòæÁ§∫ */
    justify-content: space-around;
    align-items: center;
}

.nai-gallery-controls button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 2px;
}
.nai-gallery-controls svg {
    width: 16px;
    height: 16px;
}

#nai-gallery-grid.management-mode .nai-gallery-controls {
    display: flex;
}

#nai-gallery-grid.management-mode .nai-gallery-item::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 4px solid transparent;
    border-radius: 10px;
    box-sizing: border-box;
    transition: border-color 0.2s;
    pointer-events: none; 
}

#nai-gallery-grid.management-mode .nai-gallery-item.selected::after {
    border-color: var(--accent-color);
}

#nai-gallery-action-bar {
    display: none; 
    flex-shrink: 0;
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    justify-content: space-between; 
    align-items: center;
    gap: 10px; /* <-- Êñ∞Â¢û‰∫ÜÈó¥Ë∑ù */
}

#nai-gallery-action-bar .select-all-label {
    font-size: 16px;
    color: var(--text-primary);
    cursor: pointer;
    flex-grow: 1; /* <-- Êñ∞Â¢ûÔºåËÆ©‚ÄúÂÖ®ÈÄâ‚ÄùÂç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ */
}
#nai-gallery-action-bar .action-bar-btn {
    padding: 10px 15px; /* <-- ‰øÆÊîπ‰∫ÜÂÜÖËæπË∑ù */
    border-radius: 20px;
    border: none;
    font-size: 14px; /* <-- ‰øÆÊîπ‰∫ÜÂ≠óÂè∑ */
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
    flex-shrink: 0; /* <-- Êñ∞Â¢ûÔºåÈò≤Ê≠¢ÊåâÈíÆË¢´ÂéãÁº© */
}

/* ÈÄÇÈÖçÊöóÈªëÊ®°Âºè */
#phone-screen.dark-mode #nai-gallery-panel {
    background-color: rgba(28, 28, 30, 0.85);
    border-top-color: #38383a;
}
#phone-screen.dark-mode #nai-gallery-panel-header {
    border-bottom-color: #38383a;
}
#phone-screen.dark-mode #nai-gallery-grid {
    background-color: #000;
}
#phone-screen.dark-mode #nai-gallery-action-bar {
    background-color: rgba(28, 28, 30, 0.9);
    border-top-color: #38383a;
}
#phone-screen.dark-mode #nai-gallery-action-bar .select-all-label {
    color: #f0f0f0;
}
/* --- NAI ÂõæÁâáÈáçÊñ∞ÁîüÊàêÊåâÈíÆ (V3 - ÊÇ¨ÂÅúÊòæÁ§∫‰øÆÂ§çÁâà) --- */
.nai-image-wrapper {
    position: relative; /* ÂÖ≥ÈîÆÔºöÂøÖÈ°ªÊúâËøôË°åÔºåÁî®‰∫éÊåâÈíÆÂÆö‰ΩçÔºÅ */
    display: inline-block;
    line-height: 0;
}

.nai-regenerate-btn {
    position: absolute;
    bottom: 10px; /* ‰ªéÂ∫ïÈÉ®ÂÅèÁßª 10px */
    right: 10px;  /* ‰ªéÂè≥‰æßÂÅèÁßª 10px */
    width: 32px;
    height: 32px;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    
    /* Ê†∏ÂøÉ‰øÆÂ§çÔºöÈªòËÆ§ËÆæÁΩÆ‰∏∫ÈÄèÊòéÔºåÂç≥ÈöêËóè */
    opacity: 0; 
    
    transition: opacity 0.2s ease-in-out;
    z-index: 5;
}

/* Ê†∏ÂøÉ‰øÆÂ§çÔºöÂΩìÈº†Ê†áÊÇ¨ÂÅúÂú® *ÂõæÁâáÂåÖË£πÂ±Ç* ‰∏äÊó∂ÔºåÊâçÊòæÁ§∫ÊåâÈíÆ */
.nai-image-wrapper:hover .nai-regenerate-btn {
    opacity: 0.85; /* ÊÇ¨ÂÅúÊó∂ÊòæÁ§∫ */
}

/* ÊåâÈíÆÊú¨Ë∫´ÁöÑÊÇ¨ÂÅúÊïàÊûúÔºàÂèò‰∫ÆÔºâ */
.nai-regenerate-btn:hover {
    opacity: 1 !important; /* Á°Æ‰øùÊÇ¨ÂÅúÂú®ÊåâÈíÆ‰∏äÊó∂Êõ¥‰∫Æ */
    background-color: rgba(0, 0, 0, 0.8);
}

.nai-regenerate-btn svg {
    width: 16px;
    height: 16px;
}

/* Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ */
.nai-regenerate-btn.loading {
    pointer-events: none;
    opacity: 1; /* Âä†ËΩΩÊó∂Âº∫Âà∂ÊòæÁ§∫ */
}
.nai-regenerate-btn.loading svg {
    animation: spin 1s linear infinite;
}

/* ‰øÆÂ§çÊöóÈªëÊ®°Âºè‰∏ãÁöÑÊ†∑Âºè */
#phone-screen.dark-mode .nai-regenerate-btn {
    background-color: rgba(30, 30, 30, 0.7);
    border-color: rgba(255, 255, 255, 0.2);
}
/* --- NAI ÂõæÁâáÈáçÊñ∞ÁîüÊàêÊåâÈíÆ ÁªìÊùü --- */
/* ‚ñº‚ñº‚ñº „ÄêÊñ∞ÂäüËÉΩ„ÄëÊâãÊú∫Â§ñÊ°ÜÊ†∑Âºè (374x674px Á≤æÁ°ÆÁâà) ‚ñº‚ñº‚ñº */

/* 1. ÊâãÊú∫Â§ñÊ°ÜÁöÑËÉåÊôØ (‰Ω†ÊÉ≥Ë¶ÅÁöÑÁôΩËâ≤) */
body.frame-mode-active {
    background-color: #f0f2f5; /* ‰øùÊåÅÁôΩËâ≤ËÉåÊôØ */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    overflow: hidden; 
}

/* Âú®ÊöóÈªëÊ®°Âºè‰∏ãÔºåËÉåÊôØÂàô‰∏∫ÊµÖÁÅ∞Ëâ≤ */
body.dark-mode.frame-mode-active {
    background-color: #f0f2f5;
}

/* 2. ÊâãÊú∫Â§ñÊ°ÜÊú¨Ë∫´ (‰ΩøÁî®‰Ω†ËÆ°ÁÆóÁöÑÁ≤æÁ°ÆÂ∞∫ÂØ∏) */
body.frame-mode-active #phone-screen {
    /* ÊÄªÂÆΩÂ∫¶: 374px
      ÊÄªÈ´òÂ∫¶: 674px
      (Ëøô‰ºö‰ΩøÂÜÖÈÉ®ÂÜÖÂÆπÂå∫ÂüüÁ≤æÁ°Æ‰∏∫ 350x650px)
    */
    width: 374px;
    height: 700px;
    
    /* 12px ÁöÑÈªëËâ≤ËæπÊ°Ü */
    border: 12px solid #ffffff;
    
    /* ÈÄÇÈÖçÁöÑÂúÜËßí */
    border-radius: 54px; 
    
    /* ÁßªÈô§ÂÜÖËæπË∑ù (padding) Êù•ÂåπÈÖç‰Ω†ÁöÑËÆ°ÁÆó */
    /* padding: 0; (ÁßªÈô§) */

    /* Ë¶ÜÁõñÂÖ®Â±èÊ†∑Âºè */
    min-height: auto; 
    max-width: 100%;
    max-height: 95vh; /* ÊúÄÂ§ßÈ´òÂ∫¶ÔºåÈò≤Ê≠¢Ê∫¢Âá∫ */
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
    box-sizing: border-box; 
    position: relative; 
    overflow: hidden; 
}

/* 3. Â±èÂπïÂÜÖÈÉ®ÁöÑÂúÜËßíÈÅÆÁΩ© */
body.frame-mode-active #phone-screen::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    
    /* ÂÜÖÈÉ®ÂúÜËßí (ÊØî 54px Â∞è 12px) */
    border-radius: 42px; 
    
    /* ÁßªÈô§ÂÜÖËæπÊ°ÜÔºåÂõ†‰∏∫ÂÆÉ‰∏çÂÜçÈúÄË¶Å */
    /* border: 0; (ÁßªÈô§) */
    
    pointer-events: none;
    z-index: 1000; 
    
    /* Ê∑ªÂä†‰∏Ä‰∏™ÈùûÂ∏∏ÁªÜÂæÆÁöÑÂÜÖÈò¥ÂΩ±ÔºåÊ®°ÊãüÂ±èÂπïÁéªÁíÉÊÑü */
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
}

/* 4. Ê®°ÊãüÁÅµÂä®Â≤õ (Dynamic Island) */
body.frame-mode-active #phone-screen::after {
    content: '';
    position: absolute;
    top: 22px; 
    left: 50%;
    transform: translateX(-50%);
    /* Ë∞ÉÊï¥‰∏∫Êõ¥ÂçèË∞ÉÁöÑÁÅµÂä®Â≤õÂ∞∫ÂØ∏ (Â∑≤Áº©Â∞è) */
    width: 100px;  /* <-- Â∑≤‰ªé 120px ÂáèÂ∞è */
    height: 25px;  /* <-- Â∑≤‰ªé 28px ÂáèÂ∞è */
    background-color: #000; 
    border-radius: 12.5px; /* <-- Ë∞ÉÊï¥ÂúÜËßí‰ª•‰øùÊåÅÂΩ¢Áä∂ */
    z-index: 1002; 
}

/* [Êñ∞Â¢û] ÂΩìÊâãÊú∫Â§ñÊ°ÜÊøÄÊ¥ªÊó∂ÔºåÁ≠âÊØîÁº©Â∞è‰∏ªÂ±èÂπïÂíåCPhoneÂÜÖÂÆπ‰ª•ÈÄÇÂ∫îÂ±èÂπï (V3 - ÊúÄÁªàÂ∏ÉÂ±Ä‰øÆÂ§çÁâà) */
body.frame-mode-active #home-screen-pages-container,
body.frame-mode-active #char-clock-container,
body.frame-mode-active #char-app-grid {
    transform: scale(0.9);
    transform-origin: top center;
    transition: transform 0.3s ease, margin-top 0.3s ease, margin-bottom 0.3s ease; /* Ê∑ªÂä†ËøáÊ∏°ÊïàÊûú */
}

/* EPhone ‰∏ªÂ±èÂπïÁöÑÂ∏ÉÂ±Ä‰øÆÊ≠£ */
body.frame-mode-active #home-screen-pages-container {
    margin-bottom: -55px;
}
body.frame-mode-active #home-screen-pagination {
    transform: scale(0.9);
}
body.frame-mode-active #desktop-dock {
    transform: scale(0.9);
    margin-bottom: -5px;
}

/* ‚ñº‚ñº‚ñº CPhone Â∏ÉÂ±ÄÁöÑÊ†∏ÂøÉ‰øÆÊ≠£ ‚ñº‚ñº‚ñº */
body.frame-mode-active #char-clock-container {
    /* ÊõøÊç¢ÈªòËÆ§ÁöÑÂ§ßÈó¥Ë∑ùÔºåÁªô‰∏Ä‰∏™ÈÄÇÂêàÊ°ÜÂÜÖËßÜÂõæÁöÑ‰∏äËæπË∑ù */
    margin-top: 60px;
    /* Â§ßÂπÖÂáèÂ∞è‰∏ãËæπË∑ùÔºåÊää‰∏ãÈù¢ÁöÑAppÂõæÊ†áÊãâ‰∏äÊù• */
    margin-bottom: 50px;
}

body.frame-mode-active #char-app-grid {
    /* ÁßªÈô§‰πãÂâçËøá‰∫éÊøÄËøõÁöÑË¥üËæπË∑ùÔºåËÆ©ÂÆÉËá™ÁÑ∂ÊéíÂàóÂú®Êó∂Èíü‰∏ãÊñπ */
    margin-top: 0;
}
/* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
#dynamic-island-content {
    position: absolute;
    top: 22px; /* ‰∏éÊâãÊú∫Â§ñÊ°ÜÁöÑÂàòÊµ∑‰º™ÂÖÉÁ¥†‰ΩçÁΩÆÂÆåÂÖ®ÈáçÂêà */
    left: 50%;
    transform: translateX(-50%);
    width: 120px; /* ÈªòËÆ§ÂÆΩÂ∫¶Ôºå‰∏éÂàòÊµ∑‰∏ÄËá¥ */
    height: 28px; /* ÈªòËÆ§È´òÂ∫¶Ôºå‰∏éÂàòÊµ∑‰∏ÄËá¥ */
    background-color: #000;
    border-radius: 14px;
    z-index: 1003; /* Á°Æ‰øùÂú®ÂàòÊµ∑‰º™ÂÖÉÁ¥†‰πã‰∏ä */
    
    display: flex;
    align-items: center;
    padding: 3px;
    box-sizing: border-box;
    
    /* Ê†∏ÂøÉÂä®ÁîªÔºöÂÆΩÂ∫¶„ÄÅÈÄèÊòéÂ∫¶ÁöÑÂèòÂåñÈÉΩÂ∏¶ËøáÊ∏°ÊïàÊûú */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    
    /* ÈªòËÆ§Áä∂ÊÄÅÔºöÂÆåÂÖ®ÈÄèÊòéÔºå‰∏çÂèØËßÅÔºå‰∏çÂìçÂ∫îÁÇπÂáª */
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
    overflow: hidden; /* ÈöêËóèÂÜÖÈÉ®Ê∫¢Âá∫ÁöÑÂÜÖÂÆπ */
}

/* 2. ÂΩìÈü≥‰πêÊí≠ÊîæÊó∂ÔºåÁÅµÂä®Â≤õ‚ÄúÂ±ïÂºÄ‚Äù */
/* ËßÑÂàô 1: Âú®ÊúâÊ°ÜÊ®°Âºè‰∏ãÔºåË∞ÉÊï¥ÂõûÂàòÊµ∑ÁöÑ‰ΩçÁΩÆÂπ∂Â±ïÂºÄ */
body.frame-mode-active #phone-screen.dynamic-island-active #dynamic-island-content {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    width: 190px;
    top: 22px; /* Ë¶ÜÁõñÈªòËÆ§ÂÄºÔºåÂØπÈΩêÂàòÊµ∑ */
}

/* ËßÑÂàô 2: Âú®Êó†Ê°ÜÊ®°Âºè‰∏ãÔºåÂú®È°∂ÈÉ®Â±ïÂºÄ */
body:not(.frame-mode-active) #phone-screen.dynamic-island-active #dynamic-island-content {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    width: 190px;
    /* (ËøôÈáå‰ºö‰ΩøÁî®Êàë‰ª¨Âú®Á¨¨6303Ë°åËÆæÁΩÆÁöÑÊñ∞topÂÄº) */
}

/* 3. ÂêåÊó∂ÔºåÈöêËóèÊéâÂéüÊù•ÁöÑÂàòÊµ∑‰º™ÂÖÉÁ¥†ÔºåÈò≤Ê≠¢ÈáçÂè† */
body.frame-mode-active #phone-screen.dynamic-island-active::after {
    opacity: 0;
}

/* 4. Â≤õÂÜÖÁöÑ‰∏ìËæëÂ∞ÅÈù¢ */
#island-album-art {
    width: 22px; /* È´òÂ∫¶28px - ‰∏ä‰∏ãÂêÑ3pxÂÜÖËæπË∑ù = 22px */
    height: 22px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
    flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
}

/* 5. Ê≠åËØçÁöÑÂÆπÂô®ÔºåÁî®‰∫éË£ÅÂâ™ÊªöÂä®ÊñáÂ≠ó */
#island-lyric-container {
    flex-grow: 1; /* Âç†ÊçÆÂâ©‰ΩôÊâÄÊúâÁ©∫Èó¥ */
    overflow: hidden; /* „ÄêÂÖ≥ÈîÆ„ÄëË£ÅÂâ™ÊéâË∂ÖÂá∫ÈÉ®ÂàÜÁöÑÊ≠åËØç */
    white-space: nowrap; /* „ÄêÂÖ≥ÈîÆ„ÄëÂº∫Âà∂Ê≠åËØç‰∏çÊç¢Ë°å */
}
#island-lyric-container.center-content {
    display: flex;
    justify-content: center;
}
/* 6. Ê≠åËØçÊñáÂ≠óÊú¨Ë∫´ */
#island-lyric-text {
    color: #aeaeae; /* ÊüîÂíåÁöÑÁÅ∞Ëâ≤ */
    font-size: 13px;
    font-weight: 500;
    display: inline-block; /* Âä®ÁîªÈúÄË¶Å */
    transition: opacity 0.2s ease-in-out;
}
/* ÊÇ®ÂèØ‰ª•Âú® L2910 ÈôÑËøëÊâæÂà∞ .frame-mode-active ÁöÑÁõ∏ÂÖ≥Ê†∑Âºè
   ÁÑ∂ÂêéÂú®ËøôÈôÑËøëÊ∑ªÂä†‰∏ãÈù¢ÁöÑÊñ∞ËßÑÂàô
*/

body.frame-mode-active #main-content-area {
    /* * Âú®ËøôÈáå‰øÆÊîπÊÇ®ÊÉ≥Ë¶ÅÁöÑË∑ùÁ¶ª„ÄÇ
     * ÂéüÊú¨ÊòØ 30pxÔºåÊÇ®ÂèØ‰ª•ÊîπÊàê 40px Êàñ 50px Êù•Â¢ûÂ§ßÈó¥Ë∑ù„ÄÇ
     * * ËØ∑Ê≥®ÊÑèÔºöÂú®ÊúâÊ°ÜÊ®°Âºè‰∏ãÔºåÊï¥‰∏™‰∏ªÈ°µË¢´ transform: scale(0.9) Áº©Â∞è‰∫ÜÔºå
     * ÊâÄ‰ª•ÊÇ®ËÆæÁΩÆ 50pxÔºåËßÜËßâ‰∏äÁúãËµ∑Êù•‰ºöÊòØ 45px„ÄÇ
     */
    gap:10px; 
}
/* ‰ªÖÂú®ÊúâÊ°ÜÊ®°Âºè‰∏ãÔºå‰øÆÊîπÁªÑ‰ª∂Ë∑ùÁ¶ªÈ°∂ÈÉ®ÁöÑÈó¥Ë∑ù */
body.frame-mode-active #main-content-area {
    /* * ÂéüÊú¨ÊòØ 20px„ÄÇ
     * ÊÇ®ÂèØ‰ª•ÊîπÊàê 0px Êù•ËÆ©ÂÆÉÊõ¥Èù†‰∏äÔºå
     * ÊàñËÄÖÊîπÊàê 40px Êù•ËÆ©ÂÆÉÊõ¥Èù†‰∏ã„ÄÇ
     */
    margin-top: 0px; 
}
/* ‰ªÖÂú®ÊúâÊ°ÜÊ®°Âºè‰∏ãÔºåË∞ÉÊï¥„ÄêÁ¨¨‰∫åÈ°µ„ÄëÁöÑÈó¥Ë∑ù */
body.frame-mode-active .home-screen-page:nth-child(2) .polaroid-widget-container {
    
    /* 1. ‰øÆÊîπËøô‰∏™Êù•Ë∞ÉÊï¥ [ÊãçÁ´ãÂæó] ‰∏é [Â±èÂπïÈ°∂ÈÉ®] ÁöÑË∑ùÁ¶ª (Âéü‰∏∫ 20px) */
    /* ÊÇ®ÂèØ‰ª•ÊîπÊàê 0px Êàñ 10px Êù•ËÆ©ÂÆÉÊõ¥Èù†‰∏ä */
    margin-top: 0px;

    /* 2. ‰øÆÊîπËøô‰∏™Êù•Ë∞ÉÊï¥ [ÊãçÁ´ãÂæó] ‰∏é [‰∏ãÊñπÂ∫îÁî®/Â∞èÁªÑ‰ª∂] ÁöÑË∑ùÁ¶ª (Âéü‰∏∫ 30px) */
    /* ÊÇ®ÂèØ‰ª•ÊîπÊàê 40px Êàñ 50px Êù•Â¢ûÂ§ßÂÆÉ‰ª¨‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    margin-bottom: 10px;
}
/* „Äê‰øÆÂ§ç„ÄëÂú®ÊúâÊ°ÜÊ®°Âºè‰∏ãÔºåÂ¢ûÂä†ËÅäÂ§©È°µÈù¢Â§¥ÈÉ®ÁöÑÈ°∂ÈÉ®ÂÜÖËæπË∑ùÔºå‰ª•ÈÅøÂºÄÁÅµÂä®Â≤õ */
body.frame-mode-active #chat-interface-screen > .header {
    /* * ÁÅµÂä®Â≤õÂå∫ÂüüÂ§ßÁ∫¶Âú® 22px + 25px = 47px ÁªìÊùü„ÄÇ
     * Êàë‰ª¨ÂèØ‰ª•ËÆæÁΩÆ 55px Êàñ 60px Êù•ÁªôÂÆÉÁïôÂá∫‰∏Ä‰∫õÂëºÂê∏Á©∫Èó¥„ÄÇ
     */
    padding-top: 48px !important; 
}
body:not(.frame-mode-active) #phone-screen.dynamic-island-active #chat-interface-screen > .header {
    padding-top: 48px !important;
}
/* --- Ê≠åËØçÂæ™ÁéØÊªöÂä® (Marquee) Âä®Áîª --- */

/* 1. ÈªòËÆ§Áä∂ÊÄÅÔºöÂ±Ö‰∏≠ (Áî®‰∫éÁü≠Ê≠åËØç) */
#island-lyric-container.center-content {
    display: flex;
    justify-content: center;
}
#island-lyric-container.center-content #island-lyric-text.scrolling {
    animation: none; /* Áü≠Ê≠åËØç‰∏çÈúÄË¶ÅÊªöÂä® */
}
#island-lyric-container.center-content #island-lyric-text span + span {
    display: none; /* Áü≠Ê≠åËØçÂè™ÊòæÁ§∫‰∏Ä‰∏™ */
}

/* 2. ÊªöÂä®ÂÆπÂô®ÔºöÂÜÖÈÉ®Êúâ‰∏§‰∏™span */
#island-lyric-text.scrolling {
    /* ‰ΩøÁî® --marquee-duration ÂèòÈáè‰Ωú‰∏∫Âä®ÁîªÊó∂ÈïøÔºå‰ªéJS‰º†ÂÖ• */
    animation: marquee var(--marquee-duration, 10s) linear infinite;
    display: block; /* ÂøÖÈ°ªÊòØ block ÊâçËÉΩÂ∫îÁî® transform */
    width: fit-content; /* Á°Æ‰øùÂÆΩÂ∫¶Áî±ÂÜÖÂÆπÊíëÂºÄ */
}

/* 3. ‰∏§‰∏™spanÂπ∂Êéí */
#island-lyric-text.scrolling span {
    display: inline-block;
    padding-right: 50px; /* ‰∏§‰∏™Ê≠åËØç‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    white-space: nowrap;
}

/* 4. ÂÆö‰πâÂä®Áîª */
@keyframes marquee {
    0% {
        transform: translateX(0%);
    }
    100% {
        /* * ÊªöÂä® 50% ÁöÑÂÆΩÂ∫¶„ÄÇ
         * Âõ†‰∏∫Êàë‰ª¨ÁöÑÊÄªÂÆΩÂ∫¶ÊòØ‰∏§‰∏™ <span>ÔºåÊâÄ‰ª•ÊªöÂä® 50% 
         * ÊÑèÂë≥ÁùÄÁ¨¨‰∏Ä‰∏™ <span> ÂàöÂ•ΩÂÆåÂÖ®ÁßªÂá∫ÔºåÁ¨¨‰∫å‰∏™ <span> ÂÆåÁæéÊé•‰∏ä„ÄÇ
         */
        transform: translateX(-50%); 
    }
}

/* „ÄêÊñ∞ÂäüËÉΩ„ÄëÂàÜÁ¶ªÁä∂ÊÄÅÊ†è / Áúü¬∑ÂÖ®Â±èÊ®°Âºè v2.0 */

/* ÂΩì body Ê†áÁ≠æÊã•Êúâ detach-mode-active Á±ªÊó∂ÔºåÂ∫îÁî®‰ª•‰∏ãÊ†∑Âºè */
body.detach-mode-active #phone-screen {
    /* Ê†∏ÂøÉ‰øÆÊîπ1Ôºö‰øùÊåÅÂõ∫ÂÆöÂÆö‰ΩçÔºå‰ΩÜÂè™ÂÆö‰πâ‰∏âËæπ */
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;

    /* Ê†∏ÂøÉ‰øÆÊîπ2ÔºöËøôÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰∏ÄÊ≠•ÔºÅ
       ËÆ©ÂÖÉÁ¥†ÁöÑÈ°∂ÈÉ®‰ªé‚ÄúÂÆâÂÖ®Âå∫ÂüüÁöÑÂ∫ïÈÉ®‚ÄùÂºÄÂßãÔºåËÄå‰∏çÊòØÂ±èÂπïÁöÑÁªùÂØπÈ°∂ÈÉ®„ÄÇ
       env(safe-area-inset-top) ‰ºöËá™Âä®Ëé∑ÂèñÂàòÊµ∑ÊàñÁä∂ÊÄÅÊ†èÁöÑÈ´òÂ∫¶„ÄÇ*/
    top: env(safe-area-inset-top);

    /* Ê†∏ÂøÉ‰øÆÊîπ3ÔºöÁßªÈô§Âõ∫ÂÆöÁöÑ height Â±ûÊÄßÔºåËÆ© top Âíå bottom Ëá™Âä®ÂÜ≥ÂÆöÈ´òÂ∫¶ */
    height: auto;
    width: auto; /* ÂêåÊ†∑ÁßªÈô§Âõ∫ÂÆöÁöÑ width */

    /* ÁßªÈô§ÊâãÊú∫Â§ñÊ°ÜÊ†∑ÂºèÔºåÂÆûÁé∞ÁúüÊ≠£ÁöÑÂÖ®Â±èÊÑü */
    border-radius: 0;
    border: none;
    box-shadow: none;

    /* ÂÖ∂‰ªñÂ∏ÉÂ±ÄÂ±ûÊÄß‰øùÊåÅ‰∏çÂèò */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: var(--secondary-bg);
}

/* Âú®Ê≠§Ê®°Âºè‰∏ãÔºåÈöêËóèÊ®°ÊãüÁöÑÂàòÊµ∑ÂíåÂ±èÂπïÂúÜËßíÈÅÆÁΩ©ÔºåÂõ†‰∏∫Êàë‰ª¨Ë¶ÅÊòæÁ§∫Áâ©ÁêÜÁöÑ */
body.detach-mode-active #phone-screen::after,
body.detach-mode-active #phone-screen::before {
    display: none;
}
/* „ÄêÂÖ®Â±Ä‰øÆÂ§ç„ÄëÂ∞ÜDockÊ†èÂíåÂàÜÈ°µÁÇπÁöÑ‰ΩçÁΩÆÂõ∫ÂÆöÂú®Êõ¥‰ΩéÁöÑ‰ΩçÁΩÆÔºåÂøΩÁï•Â∫ïÈÉ®ÂÆâÂÖ®Âå∫ */
#home-screen-pagination {
    /* ÁßªÈô§ calc Âíå env() */
    padding-bottom: 10px;
}

#desktop-dock {
    /* ÁßªÈô§ calc Âíå env() */
    margin-bottom: 20px;
}
/* ======================================= */
/* ‚ñº‚ñº‚ñº „ÄêÊñ∞ÂäüËÉΩ„ÄëÁÆÄÊ¥ÅËÅäÂ§©ÁïåÈù¢ (Minimal Chat UI) ‚ñº‚ñº‚ñº */
/* ======================================= */

/* 1. ÈªòËÆ§ÈöêËóè‚Äú+‚ÄùÂè∑Â±ïÂºÄÊåâÈíÆ */
#chat-expand-btn {
    display: none;
    flex-shrink: 0;
    width: 40px; /* ‰∏éÂèëÈÄÅÊåâÈíÆÂêåÈ´ò */
    height: 40px;
    font-size: 28px;
    font-weight: 300;
    line-height: 38px; /* ÂûÇÁõ¥Â±Ö‰∏≠ */
    padding: 0;
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    transition: transform 0.3s ease, background-color 0.2s, color 0.2s;
}

/* 2. ÂΩìÁÆÄÊ¥ÅÊ®°ÂºèÂºÄÂêØÊó∂ (body‰∏ä‰ºöÊúâËøô‰∏™class) */
body.minimal-chat-ui-active #chat-input-actions-top {
    /* ÈªòËÆ§ÈöêËóèÂ∑•ÂÖ∑Ê†è */
    display: none;
}
body.minimal-chat-ui-active #chat-input-main-row {
    /* Á°Æ‰øù‚Äú+‚ÄùÊåâÈíÆÂíåËæìÂÖ•Ê°ÜÂ∫ïÂØπÈΩê */
    align-items: flex-end;
}
body.minimal-chat-ui-active #chat-expand-btn {
    /* ÊòæÁ§∫‚Äú+‚ÄùÊåâÈíÆ */
    display: flex;
    justify-content: center;
    align-items: center;
}
body.minimal-chat-ui-active #chat-input {
    /* ‰øÆÂ§ç‚Äú+‚ÄùÊåâÈíÆÂá∫Áé∞ÂêéÔºåËæìÂÖ•Ê°ÜÊ≤°ÊúâËá™Âä®ÈÄÇÂ∫îÂÆΩÂ∫¶ÁöÑÈóÆÈ¢ò */
    flex-grow: 1;
}

/* 3. ÂΩìÁî®Êà∑ÁÇπÂáª‚Äú+‚ÄùÂè∑ÔºåÂ∑•ÂÖ∑Ê†èÂ±ïÂºÄÊó∂ (body‰∏ä‰ºö‰∏¥Êó∂Ê∑ªÂä†Ëøô‰∏™class) */
body.minimal-chat-ui-active.chat-actions-expanded #chat-input-actions-top {
    /* ÈáçÊñ∞ÊòæÁ§∫Â∑•ÂÖ∑Ê†è */
    display: flex;
}
body.minimal-chat-ui-active.chat-actions-expanded #chat-expand-btn {
    /* ‚Äú+‚ÄùÂè∑ÊóãËΩ¨45Â∫¶ÂèòÊàê‚Äúx‚ÄùÂè∑ */
    transform: rotate(45deg);
    background-color: #f0f2f5;
    color: #8a8a8a;
}
#phone-screen.dark-mode body.minimal-chat-ui-active.chat-actions-expanded #chat-expand-btn {
    background-color: #3e3e42;
    color: #8d8d92;
}

/* 4. ÊöóÈªëÊ®°Âºè‰∏ãÁöÑ‚Äú+‚ÄùÊåâÈíÆ */
#phone-screen.dark-mode #chat-expand-btn {
    background-color: #3e3e42;
    color: #f0f0f0;
    border: 1px solid #38383a;
}
/* ‚ñ≤‚ñ≤‚ñ≤ ÁÆÄÊ¥ÅËÅäÂ§©ÁïåÈù¢Ê†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */


/* 1. ÂΩìÁÆÄÊ¥ÅÊ®°ÂºèÂºÄÂêØ (‰∏îÂ∑•ÂÖ∑Ê†èÊäòÂè†Êó∂)ÔºåÂáèÂ∞èËÅäÂ§©ÂàóË°®ÁöÑÂ∫ïÈÉ®ÂÜÖËæπË∑ù */
body.minimal-chat-ui-active #chat-interface-screen #chat-messages {
    /* ÂéüÊú¨ÊòØ 150pxÔºåÊàë‰ª¨ÊääÂÆÉÁº©Â∞èÂà∞ 80pxÔºåÂàöÂ•ΩÂÆπÁ∫≥ÂçïË°åËæìÂÖ•Ê°Ü */
    padding-bottom: calc(80px + env(safe-area-inset-bottom)) !important;
    /* Á°Æ‰øùËøáÊ∏°Âπ≥Êªë */
    transition: padding-bottom 0.3s ease;
}

/* 2. ÂΩìÁÆÄÊ¥ÅÊ®°ÂºèÂºÄÂêØ (‰∏îÂ∑•ÂÖ∑Ê†èÂ±ïÂºÄÊó∂)ÔºåÊÅ¢Â§çÂéüÊù•ÁöÑÂÜÖËæπË∑ù */
body.minimal-chat-ui-active.chat-actions-expanded #chat-interface-screen #chat-messages {
    /* ÊÅ¢Â§ç 150pxÔºå‰∏∫Â±ïÂºÄÁöÑÂõæÊ†áË°åËÖæÂá∫Á©∫Èó¥ */
    padding-bottom: calc(120px + env(safe-area-inset-bottom)) !important;
}
/* --- Êñ∞Â¢ûÔºöÂäüËÉΩÈîÅÂÆöÊ†∑Âºè --- */
.locked-feature {
    opacity: 0.7; /* ËÆ©ÊåâÈíÆÁúãËµ∑Êù•ÊúâÁÇπÁÅ∞ */
    position: relative; /* ‰∏∫ÂõæÊ†áÂÆö‰Ωç */
    cursor: help; /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫Â∏ÆÂä©ÂõæÊ†á */
}



/* Âú®ÊöóÈªëÊ®°Âºè‰∏ãËÆ©ÈîÅÊõ¥Ê∏ÖÊô∞ */
#phone-screen.dark-mode .locked-feature::after {
    background-color: rgba(0, 0, 0, 0.5);
}
/* „ÄêÊñ∞ÂäüËÉΩ„ÄëPINÁ†ÅÊøÄÊ¥ªÂºπÁ™óÊ†∑Âºè */
#pin-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
    display: none; /* ÈªòËÆ§ÈöêËóè */
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

#pin-modal-overlay.visible {
    display: flex; /* ÊøÄÊ¥ªÊó∂ÊòæÁ§∫ */
}

#pin-modal-content .form-group {
    margin-bottom: 15px;
}

/* Ëß£ÂÜ≥ÊÇ®Êó†Ê≥ïÂ§çÂà∂ÁöÑÈóÆÈ¢òÔºöËÆ©Ëøô‰∏™ËæìÂÖ•Ê°ÜÁúãËµ∑Êù•ÂÉè‰∏™ÊòæÁ§∫Ê°ÜÔºå‰ΩÜÂÜÖÂÆπÂèØÈÄâ */
#pin-device-id-display {
    -webkit-user-select: text; /* ÂÖºÂÆπ Safari */
    user-select: text; /* Ê†áÂáÜ */
    cursor: text;
    background-color: #f0f2f5;
    color: #555;
    border: 1px dashed #ccc;
    font-size: 14px !important; /* Á°Æ‰øùÂ≠ó‰ΩìÂ§ßÂ∞èÊ≠£Á°Æ */
    padding: 10px !important;
}

#phone-screen.dark-mode #pin-device-id-display {
    background-color: #2c2c2e;
    color: #f0f0f0;
    border-color: #38383a;
}

#character-profile-modal .thought-content .text:has(div),
#character-profile-modal .thought-content .text:has(table) {
    padding: 0 !important;
    font-family: inherit !important; /* ÊÅ¢Â§çÈªòËÆ§Â≠ó‰ΩìÔºåËÆ©Âç°ÁâáËá™Â∑±ÊéßÂà∂ */
    font-size: inherit !important;
    line-height: normal !important; /* ÊÅ¢Â§çÊ≠£Â∏∏ÁöÑË°åÈ´ò */
    color: inherit !important;
    background: none !important;
    white-space: normal !important; /* ÂÖÅËÆ∏Âç°ÁâáÊ≠£Â∏∏Êç¢Ë°åÂíåÂ∏ÉÂ±Ä */
}
.quick-reply-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0; /* Èò≤Ê≠¢Âú®flexÂ∏ÉÂ±Ä‰∏≠Ë¢´ÂéãÁº© */
}

.quick-reply-item:last-child {
    border-bottom: none;
}

.quick-reply-text {
    font-size: 16px;
    color: var(--text-primary);
    cursor: pointer;
    flex-grow: 1; /* Âç†ÊçÆ‰∏ªË¶ÅÁ©∫Èó¥ */
    padding-right: 15px; /* ÂíåÊåâÈíÆ‰øùÊåÅË∑ùÁ¶ª */
    word-break: break-all; /* ‰øÆÂ§çÈïøÊñáÊú¨Ê∫¢Âá∫ */
    white-space: pre-wrap; /* ÊîØÊåÅÊç¢Ë°åÁ¨¶ÊòæÁ§∫ */
}

.quick-reply-text:hover {
    color: var(--accent-color);
}

.quick-reply-actions {
    display: flex;
    gap: 10px;
    flex-shrink: 0; /* Èò≤Ê≠¢ÊåâÈíÆË¢´ÂéãÁº© */
}

.quick-reply-edit-btn,
.quick-reply-delete-btn {
    background: none;
    border: none;
    padding: 5px;
    cursor: pointer;
    color: var(--text-secondary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.quick-reply-edit-btn:hover {
    background-color: #e9e9eb;
    color: var(--accent-color);
}
.quick-reply-delete-btn:hover {
    background-color: #ffebee;
    color: #ff3b30;
}

#phone-screen.dark-mode .quick-reply-item {
    border-bottom-color: #38383a;
}
#phone-screen.dark-mode .quick-reply-text:hover {
    color: #58a6ff;
}
#phone-screen.dark-mode .quick-reply-edit-btn:hover {
    background-color: #3a3a3c;
    color: #58a6ff;
}
#phone-screen.dark-mode .quick-reply-delete-btn:hover {
    background-color: #5c1f24;
    color: #ff8080;
}

/* Á°Æ‰øù modal-body ÂèØ‰ª•ÊªöÂä® */
#quick-reply-modal .modal-body {
    overflow-y: auto;
}
#char-music-player-modal #char-music-lyrics {
    /* display: none;  <-- Âà†Èô§Ëøô‰∏ÄË°åÔºåÊàñËÄÖÊîπ‰∏∫‰∏ãÈù¢ËøôÊ†∑: */
    display: block; 
    width: 100%;
    height: 60px; /* Áªô‰∏™Âõ∫ÂÆöÈ´òÂ∫¶ */
    overflow: hidden;
    position: relative;
    margin-bottom: 20px;
    font-size: 14px;
    line-height: 20px;
    color: #888;
    text-align: center;
    transition: all 0.3s ease;
    mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
    -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);
}

.char-player-minimize-btn {
    position: absolute;
    top: 15px;
    right: 85px; /* ÊîæÂú®ÂÖ≥Èó≠ÊåâÈíÆÂ∑¶Ëæπ */
    background: none;
    border: none;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
    padding: 5px; /* Áªô‰∫àÁÇπÂáªÂå∫Âüü */
    display: flex; /* Áî®‰∫éÂ±Ö‰∏≠SVG */
    align-items: center; /* Áî®‰∫éÂ±Ö‰∏≠SVG */
    justify-content: center; /* Áî®‰∫éÂ±Ö‰∏≠SVG */
}
.char-player-minimize-btn:hover {
    color: #333;
}

/* 3. Ê∑ªÂä†ÊÇ¨ÊµÆÊÅ¢Â§çÁêÉÊ†∑Âºè */
#char-music-restore-btn {
    position: absolute;
    top: 120px;
    right: 15px;
    width: 45px;
    height: 45px;
    background: transparent; /* 1. Êîπ‰∏∫ÂÆåÂÖ®ÈÄèÊòé */
    backdrop-filter: none; /* 2. ÁßªÈô§ÊØõÁéªÁíÉ */
    -webkit-backdrop-filter: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: none; /* 3. ÁßªÈô§Èò¥ÂΩ± */
    z-index: 900; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
    cursor: pointer;
    animation: float-music 3s ease-in-out infinite;
    border: none; /* 4. ÁßªÈô§ËæπÊ°Ü */
}

@keyframes float-music {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
.video-call-top-bar #minimize-call-btn {
    position: absolute;
    left: 20px;
    top: 48px; /* ÈÄÇÈÖçÈ°∂ÈÉ®ÁöÑ padding-top */
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    z-index: 11;
    opacity: 0.7;
    transition: opacity 0.2s;
    pointer-events: auto;
}
.video-call-top-bar #minimize-call-btn:hover {
    opacity: 1;
}
#video-call-restore-btn {
    position: absolute;
    top: 120px; /* ÈªòËÆ§ÊòæÁ§∫‰ΩçÁΩÆÔºåÂíåÈü≥‰πêÊåâÈíÆÈîôÂºÄ‰∏ÄÁÇπ */
    right: 15px;
    width: 45px;
    height: 45px;
    background-color: #4cd964; /* ÁªøËâ≤Ôºå‰ª£Ë°®ÈÄöËØù‰∏≠ */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 900; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
    cursor: pointer;
    animation: pulse 1.5s infinite; /* Â§çÁî®ÂÖÖÁîµ/Êù•ÁîµÁöÑÂëºÂê∏Âä®Áîª */
    border: 2px solid rgba(255, 255, 255, 0.3);
}
.nai-image-wrapper {
    position: relative; 
    display: inline-block;
    line-height: 0;
}

/* DING: Âú®ËøôÈáåÊ∑ªÂä†Êñ∞ËßÑÂàô */
.bubble-image-controls {
    position: absolute;
    bottom: 10px;
    right: 10px;
    display: flex;
    gap: 8px;
    z-index: 5;
}

/* DING: ÊâæÂà∞Á∫¶ 10235 Ë°åÁöÑ .nai-regenerate-btn ËßÑÂàôÂπ∂Â∞ÜÂÖ∂‰øÆÊîπ‰∏∫Ôºö */
.nai-regenerate-btn,
.nai-upload-imgbb-btn {
    position: static; 
    width: 32px;
    height: 32px;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    
  
    opacity: 0; 
    
    transition: opacity 0.2s ease-in-out;
}

/* DING: ÊâæÂà∞Á∫¶ 10260 Ë°åÁöÑ hover ËßÑÂàôÂπ∂‰øÆÊîπÈÄâÊã©Âô®Ôºö */
.nai-image-wrapper:hover .nai-regenerate-btn,
.nai-image-wrapper:hover .nai-upload-imgbb-btn {
    opacity: 1; 
}

/* DING: ÊâæÂà∞Á∫¶ 10266 Ë°åÁöÑ hover ËßÑÂàôÂπ∂‰øÆÊîπÈÄâÊã©Âô®Ôºö */
.nai-regenerate-btn:hover,
.nai-upload-imgbb-btn:hover {
    opacity: 1 ; 
    background-color: rgba(0, 0, 0, 0.8);
}

/* DING: ÊâæÂà∞Á∫¶ 10272 Ë°åÁöÑ loading ËßÑÂàôÂπ∂‰øÆÊîπÈÄâÊã©Âô®Ôºö */
.nai-regenerate-btn.loading,
.nai-upload-imgbb-btn.loading {
    pointer-events: none;
    opacity: 1; 
}
.nai-regenerate-btn.loading svg,
.nai-upload-imgbb-btn.loading svg,
.nai-save-local-btn.loading svg{ /* DING: ÂêåÊ†∑‰øÆÊîπËøôÈáå */
    animation: spin 1s linear infinite;
}
/* DING: Âú® .nai-image-wrapper ËßÑÂàôÂêéÊ∑ªÂä† */
.bubble-image-wrapper {
    position: relative;
    display: inline-block; /* Á°Æ‰øù wrapper ÂåÖË£πÂõæÁâá */
    line-height: 0; /* ÁßªÈô§ÂõæÁâá‰∏ãÁöÑÁ©∫Èöô */
}

/* DING: Âú® .bubble-image-controls ËßÑÂàô (Á∫¶ 10243 Ë°å) ÂêéÊ∑ªÂä† */
.bubble-image-controls.user-controls {
    left: 10px; /* DING: Áî®Êà∑ÊåâÈíÆÂú®Â∑¶‰æß */
    right: auto;
}

/* DING: Âú® .nai-regenerate-btn, .nai-upload-imgbb-btn ËßÑÂàô (Á∫¶ 10250 Ë°å) ÂêéÊ∑ªÂä† */
.user-upload-imgbb-btn {
    position: static; 
    width: 32px;
    height: 32px;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    opacity: 0; /* DING: ÈªòËÆ§ÊòæÁ§∫ */
    transition: opacity 0.2s ease-in-out;
}

/* DING: Âú® .nai-image-wrapper:hover ... ËßÑÂàô (Á∫¶ 10271 Ë°å) ÂêéÊ∑ªÂä† */
.user-image-wrapper:hover .user-upload-imgbb-btn {
    opacity: 1; 
}

/* DING: Âú® .nai-regenerate-btn:hover, ... ËßÑÂàô (Á∫¶ 10277 Ë°å) ÂêéÊ∑ªÂä† */
.user-upload-imgbb-btn:hover {
    opacity: 1; 
    background-color: rgba(0, 0, 0, 0.8);
}

/* DING: Âú® .nai-regenerate-btn.loading, ... ËßÑÂàô (Á∫¶ 10283 Ë°å) ÂêéÊ∑ªÂä† */
.user-upload-imgbb-btn.loading {
    pointer-events: none;
    opacity: 1;
}
.user-upload-imgbb-btn.loading svg {
    animation: spin 1s linear infinite;
}
#nai-gallery-tabs {
    display: flex;
    justify-content: center;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(128, 128, 128, 0.15);
    border-radius: 8px;
    padding: 2px;
}

.nai-gallery-tab {
    padding: 5px 25px;
    border-radius: 7px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.nai-gallery-tab.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

#phone-screen.dark-mode .nai-gallery-tabs {
    background-color: rgba(80, 80, 80, 0.5);
}
#phone-screen.dark-mode .nai-gallery-tab.active {
    background-color: #3e3e42;
}

/* NAIÁîªÂªä - È°µÈù¢ÂíåÁΩëÊ†ºÂÆπÂô® */
#nai-gallery-grid-container {
    flex-grow: 1;
    position: relative;
    overflow: hidden; /* ÈöêËóèÊú™ÊøÄÊ¥ªÁöÑÈ°µÈù¢ */
}

.nai-gallery-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding: 15px;
    box-sizing: border-box;
    
    display: grid; /* ‰∏§‰∏™È°µÈù¢ÈÉΩ‰ΩøÁî® grid Â∏ÉÂ±Ä */
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    align-content: flex-start; /* Á°Æ‰øùÂÜÖÂÆπ‰ªéÈ°∂ÈÉ®ÂºÄÂßãÊéíÂàó */
    
    /* ÈªòËÆ§ÈöêËóè */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s;
}

.nai-gallery-page.active {
    opacity: 1;
    visibility: visible;
    z-index: 1;
}

/* ÁßªÈô§ÊóßÁöÑ #nai-gallery-grid Â∏ÉÂ±ÄÔºåÂõ†‰∏∫ÂÆÉÁé∞Âú®Ë¢´ .nai-gallery-page Êõø‰ª£‰∫Ü */
#nai-gallery-grid {
    padding: 0;
    display: contents; /* ËÆ©ÊóßIDÂ§±ÊïàÔºåÂ∏ÉÂ±ÄÁî±Áà∂Á∫ß .nai-gallery-page ÊéßÂà∂ */
}
.nai-gallery-page.management-mode .nai-image-container {
    position: relative; /* ÂÖ≥ÈîÆÔºö‰∏∫‰º™ÂÖÉÁ¥†Êèê‰æõÂÆö‰ΩçÈîöÁÇπ */
}

/* ÈÄâ‰∏≠È°πÁöÑËìùËâ≤ÂçäÈÄèÊòéÈÅÆÁΩ© */
.nai-gallery-page.management-mode .nai-gallery-item.selected .nai-image-container::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 122, 255, 0.4); /* ÂçäÈÄèÊòéËìùËâ≤ */
    border: 3px solid #007aff; /* ËìùËâ≤ÂÆûÁ∫øËæπÊ°Ü */
    box-sizing: border-box; 
    border-radius: 8px; /* ÂåπÈÖç .nai-image-container ÁöÑÂúÜËßí */
    z-index: 1;
}

/* ÈÄâ‰∏≠È°πÂè≥‰∏äËßíÁöÑ‚Äú‚úî‚ÄùÂØπÂãæ */
.nai-gallery-page.management-mode .nai-gallery-item.selected .nai-image-container::before {
    content: '‚úî'; /* ‰ΩøÁî® Unicode ÂØπÂãæ */
    position: absolute;
    top: 6px;
    right: 6px;
    width: 22px;
    height: 22px;
    background-color: #007aff; /* ËìùËâ≤ËÉåÊôØ */
    color: white; /* ÁôΩËâ≤ÂØπÂãæ */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    z-index: 2; /* Á°Æ‰øùÂú®ÈÅÆÁΩ©‰πã‰∏ä */
    border: 2px solid white; /* ÁôΩËâ≤ÊèèËæπÔºåÊõ¥Ê∏ÖÊô∞ */
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
#playlist-action-bar {
    display: none; 
    flex-shrink: 0;
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    justify-content: space-between; 
    align-items: center;
}
#playlist-action-bar .select-all-label {
    font-size: 16px;
    color: var(--text-primary);
    cursor: pointer;
}
#playlist-action-bar .action-bar-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    background-color: #007bff;
    color: white;
}

/* Êí≠ÊîæÂàóË°®ÈÄâÊã©Ê®°ÂºèÊ†∑Âºè */
#music-playlist-panel.management-mode .playlist-item-checkbox {
    display: block;
    margin-right: 10px;
    flex-shrink: 0;
    width: 18px;
    height: 18px;
}
#music-playlist-panel.management-mode .playlist-item-actions {
    display: none; /* ÁÆ°ÁêÜÊ®°Âºè‰∏ãÈöêËóèÊ≠åÊõ≤ÁöÑÂçïÁã¨Êìç‰ΩúÊåâÈíÆ */
}
#music-playlist-panel.management-mode .playlist-item.selected {
    background-color: rgba(0, 123, 255, 0.2);
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #playlist-action-bar {
    background-color: rgba(28, 28, 30, 0.9);
    border-top-color: #38383a;
}
#phone-screen.dark-mode #playlist-action-bar .select-all-label {
    color: #f0f0f0;
}
#phone-screen.dark-mode #music-playlist-panel.management-mode .playlist-item.selected {
    background-color: rgba(0, 123, 255, 0.3);
}
.playlist-header > span {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-weight: 600;
}

/* 2. Á°Æ‰øùÂ∑¶Âè≥‰∏§‰æßÁöÑÊåâÈíÆÂÆπÂô®‰∏ç‰ºöÈÅÆÊå°Ê†áÈ¢ò */
.playlist-header > div {
    z-index: 1; /* ‰øùÊåÅÊåâÈíÆÂú®Ê†áÈ¢òÁöÑ‚ÄúÁ©∫Èó¥‚Äù‰πã‰∏ä */
}

/* 3. ÂÆö‰πâÊàë‰ª¨Êñ∞Ê∑ªÂä†ÁöÑÂ∑¶‰æßÊåâÈíÆÂÆπÂô® */
.playlist-header .header-left-actions {
    display: flex;
    align-items: center;
    gap: 10px; /* ‚ÄúËøîÂõû‚ÄùÂíå‚ÄúÁÆ°ÁêÜ‚Äù‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    z-index: 1;
}

/* 4. ËÆ©‚ÄúÁÆ°ÁêÜ‚Äù/‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÁúãËµ∑Êù•Êõ¥ÂÉè‰∏Ä‰∏™ËæÖÂä©Êìç‰ΩúÔºåËÄå‰∏çÊòØÂØºËà™ */
.playlist-header #manage-playlist-btn {
    font-weight: 400; /* Ê≠£Â∏∏Â≠óÈáç */
    font-size: 15px;   /* Á®çÂ∞è‰∏ÄÁÇπ */
    color: var(--accent-color); /* ‰øùÊåÅÈ´ò‰∫ÆËâ≤ */
}

/* 5. ÔºàÂèØÈÄâÔºâ‰øÆÂ§çÊöóÈªëÊ®°Âºè‰∏ãÁöÑÈ¢úËâ≤ */
#phone-screen.dark-mode .playlist-header #manage-playlist-btn {
    color: #f0f0f0;
}

#phone-screen.dark-mode .playlist-header .panel-btn {
    color: #f0f0f0;
}
#sticker-action-bar button {
    width: auto; /* ‰øÆÊîπÔºö‰∏çÂÜçÊòØ100%ÂÆΩÂ∫¶ */
    padding: 10px 20px; /* ‰øÆÊîπÔºö‰ΩøÁî®ÂÜÖËæπË∑ùÊù•Ëá™Âä®Ë∞ÉÊï¥ÂÆΩÂ∫¶ */
    border-radius: 20px; /* ‰øÆÊîπÔºöÊîπ‰∏∫ÂúÜËßíÊåâÈíÆÔºåÊõ¥ÁæéËßÇ */
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}


#sticker-action-bar #export-selected-stickers-btn {
    background-color: #007bff; /* ÂØºÂá∫ÊåâÈíÆËÆæ‰∏∫ËìùËâ≤ */
}
#sticker-action-bar #delete-selected-stickers-btn {
    background-color: #ff3b30; /* Âà†Èô§ÊåâÈíÆ‰øùÊåÅÁ∫¢Ëâ≤ */
}
/* Bilibili ÂàóË°®Ê†∑Âºè */
#char-bilibili-screen {
    background-color: #f0f2f5;
}
#phone-screen.dark-mode #char-bilibili-screen {
    background-color: #000;
}

.bilibili-item {
    display: flex;
    gap: 10px;
    padding: 10px;
    background-color: var(--secondary-bg);
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.1s;
}
.bilibili-item:active {
    transform: scale(0.98);
}

.bili-cover {
    width: 120px;
    height: 75px;
    background-size: cover;
    background-position: center;
    border-radius: 6px;
    flex-shrink: 0;
    position: relative;
    background-color: #ddd;
}
.bili-duration {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background-color: rgba(0,0,0,0.6);
    color: white;
    font-size: 10px;
    padding: 1px 4px;
    border-radius: 4px;
}

.bili-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.bili-title {
    font-size: 14px;
    font-weight: 500;
    line-height: 1.4;
    color: var(--text-primary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.bili-author {
    font-size: 12px;
    color: var(--text-secondary);
}

/* ÊêúÁ¥¢Ê°ÜÈÄÇÈÖç */
#char-bilibili-search-input:focus {
    border-color: #FB7299;
    outline: none;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #char-bilibili-player-screen .list-container {
    background-color: #1c1c1e;
}
#lock-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 3000; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
    background-color: #000;
    background-size: cover;
    background-position: center;
    color: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
    visibility: hidden;
    opacity: 0;
    transform: translateY(-100%); /* ÈªòËÆ§ËóèÂú®‰∏äÈù¢ÊàñËÄÖÈöêËóè */
}

#lock-screen.active {
    visibility: visible;
    opacity: 1;
    transform: translateY(0);
}

#lock-screen.unlocking {
    transform: translateY(-100%);
    opacity: 0;
}

#lock-screen-content {
    width: 100%;
    height: 100%;
    backdrop-filter: blur(0px);
    transition: backdrop-filter 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 60px;
    box-sizing: border-box;
    background: rgba(0,0,0,0.2); /* ËΩªÂæÆÈÅÆÁΩ©ËÆ©ÊñáÂ≠óÊõ¥Ê∏ÖÊô∞ */
}

#lock-screen.input-mode #lock-screen-content {
    backdrop-filter: blur(20px);
    background: rgba(0,0,0,0.4);
}

.lock-icon {
    font-size: 20px;
    margin-bottom: 10px;
    opacity: 0;
    transition: opacity 0.3s;
}
#lock-screen.input-mode .lock-icon { opacity: 0; } 

.lock-time-container {
    text-align: center;
    transition: transform 0.3s, opacity 0.3s;
}
#lock-screen.input-mode .lock-time-container {
    transform: scale(0.8) translateY(-20px);
    opacity: 0; /* ËæìÂÖ•ÂØÜÁ†ÅÊó∂ÈöêËóèÊó∂Èó¥ */
    pointer-events: none;
}

#lock-date {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 5px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

#lock-time {
    font-size: 80px;
    font-weight: 600;
    line-height: 1;
    letter-spacing: -2px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

/* ÂØÜÁ†ÅËæìÂÖ•Âå∫Âüü */
#lock-password-area {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin-top: 20px;
    animation: fadeIn 0.3s ease;
}

.lock-instruction {
    font-size: 16px;
    margin-bottom: 20px;
    font-weight: 500;
}

.lock-dots {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid white;
    box-sizing: border-box;
    transition: background-color 0.2s;
}

.dot.filled {
    background-color: white;
}

.lock-keypad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    column-gap: 25px;
    row-gap: 15px;
    margin-bottom: 20px;
}

.key {
    width: 75px;
    height: 75px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 400;
    line-height: 1;
    cursor: pointer;
    transition: background-color 0.1s;
    user-select: none;
}

.key:active {
    background-color: rgba(255, 255, 255, 0.4);
}

.key span {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 2px;
    margin-top: 2px;
    opacity: 0.8;
}

.key.empty {
    background: transparent;
    cursor: default;
}
.key.delete {
    background: transparent;
    font-size: 24px;
}
.lock-cancel-btn {
    margin-top: 20px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}

/* Â∫ïÈÉ®ÊªëÂä®Êù° */
#lock-swipe-area {
    position: absolute;
    bottom: 25px; /* Ë∞ÉÊï¥Ëøô‰∏™ÂÄºÊù•ÊéßÂà∂Á¶ªÂ∫ïËæπÁöÑË∑ùÁ¶ª */
    left: 0;
    width: 100%;
    height: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20;
    cursor: grab;
    
}
@keyframes swipe-hint {
    0%, 100% { transform: translateY(0); opacity: 0.8; }
    50% { transform: translateY(-10px); opacity: 1; }
}
/* Á°Æ‰øùÊ®™Êù°Ê†∑ÂºèÊ≠£Á°Æ */
.swipe-bar {
    width: 130px;
    height: 5px;
    background-color: white;
    border-radius: 100px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-10px); }
    40%, 80% { transform: translateX(10px); }
}
.shake-animation {
    animation: shake 0.4s ease;
}/* --- ËÅäÂ§©ËÆæÁΩÆÈ°µ (Chat Settings) QQÈ£éÊ†ºÈáçÊûÑ --- */

/* ËÉåÊôØËâ≤ */
#chat-settings-screen {
    background-color: #f2f2f7 !important; /* ÊµÖÁÅ∞Â∫ïËâ≤ */
}
#phone-screen.dark-mode #chat-settings-screen {
    background-color: #000 !important;
}

/* ÂÆπÂô® */
.settings-container {
    padding: 16px;
    padding-top: calc(80px + env(safe-area-inset-top));
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    overflow-y: auto;
    height: 100%;
    box-sizing: border-box;
}

/* ÂàÜÁªÑÂç°Áâá */
.settings-section {
    background-color: #ffffff;
    border-radius: 12px;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    
    /* „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÁßªÈô§ overflow: hiddenÔºåÂÖÅËÆ∏‰∏ãÊãâÊ°ÜÊ∫¢Âá∫ */
    /* overflow: hidden;  <-- Âà†Èô§ËøôË°å */
    position: relative; /* Á°Æ‰øùÂÜÖÈÉ®ÂÆö‰ΩçÊ≠£Â∏∏ */
}
#phone-screen.dark-mode .settings-section {
    background-color: #1c1c1e;
}

/* ÊâãÂä®Â§ÑÁêÜÂúÜËßíÔºåÊõø‰ª£ overflow: hidden */
.settings-section > .settings-item:first-child,
.settings-section > .settings-item-block:first-child {
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}
.settings-section > .settings-item:last-child,
.settings-section > .settings-item-block:last-child {
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
    border-bottom: none; /* ÂéªÈô§ÊúÄÂêé‰∏ÄÊù°Á∫ø */
}

/* ÂçïË°åËÆæÁΩÆÈ°π */
.settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background-color: #fff;
    border-bottom: 0.5px solid #ebedf0;
    min-height: 24px;
    transition: background-color 0.2s;
    position: relative; /* Á°Æ‰øùÁÇπÂáªÂèçÈ¶àÊ≠£Â∏∏ */
}
#phone-screen.dark-mode .settings-item {
    background-color: #1c1c1e;
    border-bottom-color: #2c2c2e;
}

/* ÂèØÁÇπÂáªÈ°πÂèçÈ¶à */
.settings-item.clickable:active {
    background-color: #f5f5f5;
}
#phone-screen.dark-mode .settings-item.clickable:active {
    background-color: #2c2c2e;
}

/* ÂùóÁ∫ßËÆæÁΩÆÈ°π (Áî®‰∫éÂ§öË°åÂÜÖÂÆπ) */
.settings-item-block {
    padding: 14px 16px;
    background-color: #fff;
    border-bottom: 0.5px solid #ebedf0;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
}
#phone-screen.dark-mode .settings-item-block {
    background-color: #1c1c1e;
    border-bottom-color: #2c2c2e;
}

/* Ê†áÁ≠æÊñáÊú¨ */
.settings-item label, .settings-item-block label {
    font-size: 16px;
    color: #000;
    font-weight: 400;
    margin: 0;
    flex-shrink: 0;
}
#phone-screen.dark-mode .settings-item label,
#phone-screen.dark-mode .settings-item-block label {
    color: #fff;
}

/* ÊèèËø∞ÊñáÊú¨ (Â∞èÂ≠ó) */
.settings-desc {
    font-size: 12px;
    color: #8a8a8a;
    margin-top: 2px;
}

/* Âè≥‰æßÂå∫Âüü (ËæìÂÖ•Ê°Ü„ÄÅÊåâÈíÆÁ≠â) */
.settings-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-grow: 1;
    justify-content: flex-end;
    min-width: 0; /* Èò≤Ê≠¢Ê∫¢Âá∫ */
}

/* ËæìÂÖ•Ê°ÜÊ†∑Âºè (Êó†ËæπÊ°ÜÔºåÂè≥ÂØπÈΩê) */
.settings-item input[type="text"],
.settings-item input[type="number"] {
    text-align: right;
    border: none;
    background: transparent;
    font-size: 15px;
    color: #666;
    width: 100%;
    padding: 0;
    outline: none;
}
#phone-screen.dark-mode .settings-item input {
    color: #aaa;
}
.settings-item input::placeholder {
    color: #ccc;
}

/* ÊñáÊú¨ÂüüÊ†∑Âºè */
.settings-textarea {
    width: 100%;
    border: 1px solid #f0f0f0;
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
    resize: vertical;
    box-sizing: border-box;
    color: #333;
}
#phone-screen.dark-mode .settings-textarea {
    background-color: #2c2c2e;
    border-color: #38383a;
    color: #eee;
}

/* Â§¥ÂÉèÈ¢ÑËßà */
.settings-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #eee;
}

/* Á∫ØÊñáÊú¨ÊåâÈíÆ (ËìùËâ≤Â∞èÂ≠ó) */
.settings-text-btn {
    background: none;
    border: none;
    color: #007bff;
    font-size: 14px;
    padding: 4px 8px;
    cursor: pointer;
}
.settings-text-btn:active {
    opacity: 0.7;
}

/* ÂùóÁ∫ßÊåâÈíÆ (ÁÅ∞Ëâ≤ËÉåÊôØ) */
.settings-full-btn {
    width: 100%;
    padding: 10px;
    background-color: #f5f5f7;
    color: #333;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
}
#phone-screen.dark-mode .settings-full-btn {
    background-color: #2c2c2e;
    color: #fff;
}

/* ‰∏ãÊãâÊ°Ü */
.settings-select {
    padding: 6px 20px 6px 10px;
    border-radius: 6px;
    border: none;
    background-color: #f2f2f7;
    font-size: 14px;
    color: #333;
    appearance: none;
    -webkit-appearance: none;
    /* ËøôÈáåÂèØ‰ª•Âä†‰∏™ÁÆ≠Â§¥ÂõæÊ†ábase64 */
}
#phone-screen.dark-mode .settings-select {
    background-color: #3a3a3c;
    color: #fff;
}

/* Êï∞Â≠óËæìÂÖ•Ê°Ü (Â∞è) */
.settings-num-input {
    width: 60px !important;
    text-align: center !important;
    background-color: #f2f2f7 !important;
    border-radius: 6px;
    padding: 4px !important;
}
#phone-screen.dark-mode .settings-num-input {
    background-color: #3a3a3c !important;
    color: #fff !important;
}

/* Â§¥ÈÉ®Âè≥‰æßÊåâÈíÆ */
.header .save-btn {
    font-size: 16px;
    background-color: #4cd964; /* ÁªøËâ≤ÂÆåÊàêÊåâÈíÆ */
    color: white !important;
    padding: 5px 12px;
    border-radius: 6px;
    font-weight: 500;
}

/* Â§¥ÂÉèÊìç‰ΩúÂå∫ */
.avatar-action-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ËÉåÊôØÈ¢ÑËßàÂõæ */
.settings-bg-preview {
    width: 30px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #eee;
    display: none; /* JS ÊéßÂà∂ÊòæÁ§∫ */
}

/* ‰øÆÂ§çÂ§öÈÄâÊ°ÜÂú®ËÆæÁΩÆÈ°µÁöÑÊ†∑Âºè */
.settings-item-block .custom-multiselect .select-box {
    background-color: #f5f5f7;
    border: none;
}
#phone-screen.dark-mode .settings-item-block .custom-multiselect .select-box {
    background-color: #2c2c2e;
}

/* „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÂ§öÈÄâ‰∏ãÊãâÊ°ÜÂ±ÇÁ∫ßÈóÆÈ¢ò */
.checkboxes-container {
    z-index: 1000 !important; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
    background-color: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 8px;
    max-height: 200px; /* ÈôêÂà∂È´òÂ∫¶ */
    overflow-y: auto;
}
#phone-screen.dark-mode .checkboxes-container {
    background-color: #2c2c2e;
    border: 1px solid #38383a;
}

/* Ê®™ÂêëÊªöÂä®ÂàóË°® (Áæ§ÊàêÂëò) */
.horizontal-scroll-list {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding-bottom: 5px;
}
.horizontal-scroll-list .member-editor {
    flex-shrink: 0;
}
/* Ê∞îÊ≥°‰∏ªÈ¢òÈÄâÊã©Âô®ÁæéÂåñ */
.theme-selector label {
    display: inline-flex;
    align-items: center;
    font-size: 14px;
    color: #333;
    cursor: pointer;
    padding: 4px 8px;
    background-color: #f5f5f7;
    border-radius: 6px;
    transition: background-color 0.2s;
}
#phone-screen.dark-mode .theme-selector label {
    background-color: #2c2c2e;
    color: #fff;
}
.theme-selector label:has(input:checked) {
    background-color: #e7f3ff; /* ÈÄâ‰∏≠ÊÄÅÈ´ò‰∫Æ */
    color: #007bff;
    font-weight: 500;
}
#phone-screen.dark-mode .theme-selector label:has(input:checked) {
    background-color: #0a84ff33;
    color: #0a84ff;
}
.theme-selector input[type="radio"] {
    margin-right: 6px;
    accent-color: #007bff;
}
/* --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂Á∫†Ê≠£‚ÄúÊ≥®ÂÖ•ÂøÉÂ£∞‚ÄùÁöÑÂ∏ÉÂ±Ä --- */
#inject-thought-group {
    display: flex !important;       /* Âº∫Âà∂Â∑¶Âè≥Ê®™ÂêëÊéíÂàóÔºåË¶ÜÁõñ JS ÁöÑ block */
    justify-content: space-between; /* Â∑¶Âè≥ÊíëÂºÄ */
    align-items: center;            /* ÂûÇÁõ¥Â±Ö‰∏≠ */
}

/* ÈíàÂØπËØ•ÈÄâÈ°π‰∏ãÁöÑÊñáÂ≠óÂå∫ÂüüÔºåÈò≤Ê≠¢Ë¢´ÂéãÁº© */
#inject-thought-group > div:first-child {
    flex: 1;            /* Âç†ÊçÆÂ∑¶‰æßÊâÄÊúâÁ©∫Èó¥ */
    padding-right: 10px; /* ÂíåÂºÄÂÖ≥‰øùÊåÅË∑ùÁ¶ª */
}
/* --- Â§¥ÂÉèËÆæÁΩÆÊ†è‰∏ìÁî®Ê†∑Âºè‰øÆÂ§ç --- */

/* ËÆ©Âè≥‰æßÂÆπÂô®Âç†Êª°Ââ©‰ΩôÁ©∫Èó¥ */
.settings-right.full-width {
    flex: 1;
    width: 100%;
    margin-left: 15px; /* ËÆ©Â§¥ÂÉèÂíåÂ∑¶ËæπÊ†áÁ≠æ‰øùÊåÅ‰∏ÄÁÇπË∑ùÁ¶ª */
}

/* Â§¥ÂÉèÊìç‰ΩúÂå∫ÂÆπÂô®Ôºö‰∏§Á´ØÂØπÈΩê */
.avatar-action-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between; /* ÂÖ≥ÈîÆÔºöÂ§¥ÂÉèÈù†Â∑¶ÔºåÊåâÈíÆÈù†Âè≥ */
    width: 100%;
}

/* ÊåâÈíÆÁªÑÂÆπÂô® */
.avatar-btn-group {
    display: flex;
    gap: 8px; /* ÊåâÈíÆ‰πãÈó¥ÁöÑÈó¥Ë∑ù */
}

/* Êñ∞ÁöÑÂÆû‰ΩìÂ∞èÊåâÈíÆÊ†∑Âºè (ÊúâÊ°ÜÊ°Ü‰∫ÜÔºÅ) */
.settings-mini-btn {
    background-color: #f2f2f7; /* ÊµÖÁÅ∞ËÉåÊôØ */
    border: 1px solid #e5e5ea; /* Ê∑°Ê∑°ÁöÑËæπÊ°Ü */
    color: #333;
    padding: 5px 12px;
    border-radius: 6px; /* ÂúÜËßí */
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    line-height: 1.2;
}

/* ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú */
.settings-mini-btn:active {
    background-color: #e5e5ea;
    transform: scale(0.95);
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .settings-mini-btn {
    background-color: #3a3a3c;
    border-color: #48484a;
    color: #fff;
}
#phone-screen.dark-mode .settings-mini-btn:active {
    background-color: #48484a;
}

/* ËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°È¢ÑËßàÊ†∑Âºè */
.video-call-image-preview {
    width: 100%;
    height: 180px;
    border: 2px dashed #e5e5ea;
    border-radius: 12px;
    background-color: #f9f9f9;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    position: relative;
}
.video-call-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
#phone-screen.dark-mode .video-call-image-preview {
    background-color: #2c2c2e;
    border-color: #48484a;
}

/* ‰øÆÂ§çÂ§¥ÂÉèÂ§ßÂ∞èÔºåÁ°Æ‰øù‰∏ç‰ºöËøáÂ§ß */
.settings-avatar {
    width: 44px;
    height: 44px;
    border-radius: 6px; /* ÂæÆ‰ø°È£éÊ†ºÁöÑÂ∞èÂúÜËßíÔºåÊàñËÄÖ50%ÂèòÊàêÂúÜÂΩ¢ */
    object-fit: cover;
    border: 1px solid #eee;
    flex-shrink: 0;
}
#phone-screen.dark-mode .settings-avatar {
    border-color: #333;
}
/* --- 1. ‰øÆÂ§çÈ°∂ÈÉ®Á©∫ÁôΩËøáÂ§ßÁöÑÈóÆÈ¢ò --- */
.settings-container {
    /* ÂéüÊù•ÊòØ 80pxÔºåÊîπ‰∏∫ 10px Âç≥ÂèØÔºåÂõ†‰∏∫ header Â∑≤ÁªèÂç†ÊçÆ‰∫ÜÁ©∫Èó¥ */
    padding-top: 10px !important; 
    /* ‰øùÊåÅÂ∫ïÈÉ® padding */
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
}

/* --- 2. ‰ºòÂåñÂ§¥ÂÉèÂè≥‰æßÊåâÈíÆÁöÑÈó¥Ë∑ùÂíåÊ†∑Âºè --- */

/* ÊåâÈíÆÁªÑÂÆπÂô®ÔºöÁ®çÂæÆÁº©Â∞èÊåâÈíÆ‰πãÈó¥ÁöÑË∑ùÁ¶ª */
.avatar-btn-group {
    display: flex;
    gap: 6px; /* ‰ªé 8px ÂáèÂ∞èÂà∞ 6pxÔºåÊõ¥Á¥ßÂáë */
    align-items: center;
}

/* ÊåâÈíÆÊ†∑ÂºèÂæÆË∞ÉÔºöËÆ©ÊåâÈíÆÊõ¥Á≤æËá¥ */
.settings-mini-btn {
    /* Á®çÂæÆÂáèÂ∞èÂÜÖËæπË∑ùÔºåËÆ©ÊåâÈíÆ‰∏çÈÇ£‰πà‚ÄúËÉñ‚Äù */
    padding: 4px 10px !important; 
    
    /* Â≠ó‰ΩìÁ®çÂæÆË∞ÉÂ∞è‰∏ÄÁÇπÁÇπÔºåÊõ¥ÊòæÁ≤æËá¥ */
    font-size: 12px !important; 
    
    /* Â¢ûÂä†‰∏ÄÁÇπËæπÊ°ÜÈ¢úËâ≤Ê∑±Â∫¶ÔºåÊõ¥ÊúâË¥®ÊÑü */
    border: 1px solid #d1d1d6 !important;
    
    /* Á®çÂæÆÁº©Â∞èÂúÜËßí */
    border-radius: 4px !important;
    
    /* Á°Æ‰øùËÉåÊôØËâ≤ */
    background-color: #fff !important;
    
    /* Á°Æ‰øùÊñáÂ≠óÈ¢úËâ≤ */
    color: #333 !important;
    
    /* Èò≤Ê≠¢Êç¢Ë°å */
    white-space: nowrap;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .settings-mini-btn {
    background-color: #2c2c2e !important;
    border-color: #48484a !important;
    color: #fff !important;
}

/* Â§¥ÈÉ®Ê†∑ÂºèÂæÆË∞ÉÔºöÁ°Æ‰øù Header Âíå ÂÜÖÂÆπÁöÑËøûÊé•Â§ÑËá™ÁÑ∂ */
#chat-settings-screen .header {
    /* Á°Æ‰øùÂ§¥ÈÉ®ËÉåÊôØËâ≤‰∏é body ‰∏ÄËá¥Êàñ‰∏∫ÁôΩËâ≤ÔºåÂéªÈô§Â§ö‰ΩôÈò¥ÂΩ± */
    background-color: #f2f2f7 !important;
    border-bottom: none !important; /* ÂéªÊéâÂàÜÂâ≤Á∫øÔºåÁúãËµ∑Êù•Êõ¥ÂÉèÂéüÁîüËÆæÁΩÆÈ°µ */
    box-shadow: none !important;
    padding-bottom: 0 !important; /* ÂáèÂ∞èÂ§¥ÈÉ®‰∏ãÊñπÁöÑÁïôÁôΩ */
}
#phone-screen.dark-mode #chat-settings-screen .header {
    background-color: #000 !important;
}
.settings-mini-btn {
    /* Âº∫Âà∂ÂéªÊéâÊóß‰ª£Á†ÅÂèØËÉΩÊÆãÁïôÁöÑÂ§ñËæπË∑ùÔºåËß£ÂÜ≥Èó¥Ë∑ù‰∏ç‰∏ÄËá¥ÈóÆÈ¢ò */
    margin: 0 !important; 
    
    /* Êîπ‰∏∫ÊµÖÁÅ∞Ëâ≤ËÉåÊôØÔºåËÆ©ÊåâÈíÆÂú®ÁôΩËâ≤Âç°Áâá‰∏äÊõ¥ÊòæÁúºÔºåÊõ¥Êúâ‚ÄúÊ°Ü‚ÄùÁöÑÊÑüËßâ */
    background-color: #f5f5f7 !important; 
    
    /* Á®çÂæÆÂä†Ê∑±‰∏ÄÁÇπËæπÊ°Ü */
    border: 1px solid #e0e0e0 !important; 
    
    /* Á®çÂæÆÂ¢ûÂä†ÂÜÖËæπË∑ùÔºå‰∏çÈÇ£‰πàÊå§ */
    padding: 6px 12px !important;
}

/* 2. Áªü‰∏ÄË∞ÉÊï¥ÊåâÈíÆ‰πãÈó¥ÁöÑÈó¥Ë∑ù */
.avatar-btn-group {
    /* Â¢ûÂ§ßÈó¥Ë∑ùÔºå‰∏çÂÜç‚ÄúË¥¥ÁùÄ‚Äù */
    gap: 12px !important; 
}

/* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÈÄÇÈÖç */
#phone-screen.dark-mode .settings-mini-btn {
    background-color: #2c2c2e !important;
    border-color: #3a3a3c !important;
}
/* --- ÁªàÊûÅ‰øÆÂ§ç V2ÔºöÂÆåÁæéËß£ÂÜ≥ÊòæÈöêÂÜ≤Á™Å‰∏éÂ∏ÉÂ±ÄÈóÆÈ¢ò --- */

/* 1. Âü∫Á°ÄÂ∏ÉÂ±ÄÔºöÂéªÊéâ display ÁöÑ !important */
/* ËøôÊ†∑ÂΩì JS ËÆæÁΩÆ display: none Êó∂ÔºåÂÖÉÁ¥†Â∞±ËÉΩÊ≠£Â∏∏ÈöêËóè‰∫Ü */
.settings-item {
    display: flex; 
    align-items: center !important;
    justify-content: space-between !important;
    flex-direction: row !important; 
}

/* 2. ÂÖ≥ÈîÆÊã¶Êà™ÔºöÂΩì JS ÊääÂÆÉËÆæ‰∏∫ÊòæÁ§∫(block)Êó∂ÔºåÂº∫Âà∂ËΩ¨‰∏∫ flex */
/* Ëß£ÈáäÔºöJS ÈªòËÆ§‰ºöÁî® display: block Êù•ÊòæÁ§∫ÂÖÉÁ¥†ÔºåËøô‰ºöÂØºËá¥Êç¢Ë°å„ÄÇ
   Êàë‰ª¨Áî®Â±ûÊÄßÈÄâÊã©Âô®ÊçïËé∑ËøôÁßçÊÉÖÂÜµÔºåÂπ∂Âº∫Âà∂Êîπ‰∏∫ flex Â∏ÉÂ±Ä */
.settings-item[style*="display: block"],
.settings-item[style*="display:block"] {
    display: flex !important;
}

/* 3. ‰øÆÂ§ç‚ÄúÊåâÈíÆË¥¥Ëæπ‚ÄùÈóÆÈ¢ò (‰øùÊåÅ‰∏çÂèò) */
.settings-right.full-width {
    width: auto !important; 
    flex: 1; 
    margin-left: 15px;
    padding-right: 4px !important; 
}

/* 4. Á°Æ‰øùÂ§¥ÂÉèÊìç‰ΩúÂå∫Â∏ÉÂ±Ä (‰øùÊåÅ‰∏çÂèò) */
.avatar-action-wrapper {
    width: 100%;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
/* --- ÁªàÊûÅÂúÜËßí‰øÆÂ§çÊñπÊ°à --- */

/* 1. ÂÖ®Â±ÄÂº∫Âà∂Âç°ÁâáÂúÜËßíË£ÅÂâ™ */
/* Ëøô‰ºöËÆ©ÊâÄÊúâÂç°ÁâáÔºàÂåÖÊã¨Êó∂Âå∫ËÆæÁΩÆÈÇ£‰∏ÄÁªÑÔºâÁöÑÂ§¥Â∞æËá™Âä®ÂèòÊàêÂúÜËßíÔºåÊó†ËÆ∫ÂÜÖÈÉ®ÊòØÂê¶ÊúâÈöêËóèÂÖÉÁ¥† */
.settings-section {
    overflow: hidden !important;
    border-radius: 12px !important;
}

/* 2. Áâπ‰æãË±ÅÂÖçÔºöÂè™ÊúâÂåÖÂê´‚ÄúËá™ÂÆö‰πâÂ§öÈÄâ‰∏ãÊãâÊ°Ü‚ÄùÁöÑÂç°ÁâáÊâçÂÖÅËÆ∏ÂÜÖÂÆπÊ∫¢Âá∫ */
/* ËøôÊòØ‰∏∫‰∫ÜÈò≤Ê≠¢‚ÄúÂÖ≥ËÅî‰∏ñÁïå‰π¶‚ÄùÊàñ‚ÄúÊåÇËΩΩËÆ∞ÂøÜ‚ÄùÁöÑ‰∏ãÊãâËèúÂçïË¢´Âç°ÁâáËæπÁºòÂàáÊñ≠ */
/* Ê≥®ÊÑèÔºöÊó∂Âå∫ËÆæÁΩÆ‰ΩøÁî®ÁöÑÊòØÂéüÁîü‰∏ãÊãâÊ°ÜÔºå‰∏çÂèó overflow ÂΩ±ÂìçÔºåÊâÄ‰ª•‰∏çÈúÄË¶ÅË±ÅÂÖç */
.settings-section:has(.custom-multiselect) {
    overflow: visible !important;
}

/* 3. ÈíàÂØπ‰∏äËø∞‚ÄúË±ÅÂÖç‚ÄùÁöÑÂç°ÁâáÔºåÊâãÂä®‰øÆË°•È¶ñÂ∞æÂúÜËßí */
/* Âõ†‰∏∫ÂÖÅËÆ∏Ê∫¢Âá∫‰∫ÜÔºåÊâÄ‰ª•ÂøÖÈ°ªÊâãÂä®ÁªôÁ¨¨‰∏Ä‰∏™ÂíåÊúÄÂêé‰∏Ä‰∏™ÂÖÉÁ¥†Âä†ÂúÜËßí */
.settings-section:has(.custom-multiselect) > div:first-child {
    border-top-left-radius: 12px !important;
    border-top-right-radius: 12px !important;
}

.settings-section:has(.custom-multiselect) > div:last-child {
    border-bottom-left-radius: 12px !important;
    border-bottom-right-radius: 12px !important;
    border-bottom: none !important;
}
/* --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÁªôÂµåÂ•óÂú®ÈÄèÊòéÂÆπÂô®ÈáåÁöÑ‚ÄúÊ≥®ÂÖ•ÂøÉÂ£∞‚ÄùË°•ÂúÜËßí --- */

/* ÂΩìÂç°ÁâáÂÖÅËÆ∏Ê∫¢Âá∫Êó∂ÔºåÂ¶ÇÊûúÁ¨¨‰∏Ä‰∏™Â≠©Â≠êÊòØÂåÖË£πÂÆπÂô®Ôºå
   ÈÇ£‰πàÂåÖË£πÂÆπÂô®ÈáåÁöÑÁ¨¨‰∏Ä‰∏™ .settings-item ÂøÖÈ°ªÊúâÈ°∂ÈÉ®ÂúÜËßí */
.settings-section:has(.custom-multiselect) > div:first-child > .settings-item:first-child {
    border-top-left-radius: 12px !important;
    border-top-right-radius: 12px !important;
}

/* --- Ë°•ÂÖÖ‰øÆÂ§çÔºöÁæ§ËÅäÊ®°Âºè‰∏ãÁöÑÈ°∂ÈÉ®ÂúÜËßí --- */
/* Â¶ÇÊûúÁ¨¨‰∏Ä‰∏™Â≠©Â≠êÔºàÂçïËÅäËÆæÁΩÆÔºâÈöêËóè‰∫ÜÔºåÈÇ£‰πàÁ¨¨‰∫å‰∏™Â≠©Â≠êÔºàÁæ§ËÅäËÆæÁΩÆÔºâÂ∞±ÊòØËßÜËßâ‰∏äÁöÑÁ¨¨‰∏Ä‰∏™Ôºå
   ÂÆÉ‰πüÈúÄË¶ÅÂúÜËßí„ÄÇCSSÊó†Ê≥ïÁõ¥Êé•Ê£ÄÊµã display:noneÔºå
   ÊâÄ‰ª•Êàë‰ª¨Áõ¥Êé•Áªô‚ÄúÁæ§ËÅäÂêéÂè∞Ê¥ªÂä®‚Äù‰πüÂä†‰∏äÊù°‰ª∂ÊÄßÁöÑÂúÜËßí */
#group-background-activity-group {
    /* Âè™ÊúâÂΩìÂÆÉ‰∏äÈù¢ÈÇ£‰∏™ÂÖÑÂºüÈöêËóèÊó∂ÊâçÈúÄË¶ÅÂúÜËßíÔºå‰ΩÜÂú®Á∫ØCSSÈáåÂæàÈöæÂà§Êñ≠„ÄÇ
       ËøôÈáåÂÅö‰∏Ä‰∏™ÊùÉË°°ÔºöÂ¶ÇÊûúÂÆÉÊòØËØ•ÁªÑÁ¨¨‰∏Ä‰∏™ÂèØËßÅÂÖÉÁ¥†ÔºåËµã‰∫àÂÆÉÂúÜËßí */
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}
/* --- ‰øÆÂ§çÁæ§ËÅäÊ®°Âºè‰∏ã‚ÄúÊàëÁöÑ‰∫∫ËÆæ‚ÄùÁõ¥ËßíÈóÆÈ¢ò --- */

/* ÂΩì AI‰∫∫ËÆæË¢´ JS ËÆæÁΩÆ‰∏∫ÈöêËóè(display: none)Êó∂Ôºå
   Á¥ßÈöèÂÖ∂ÂêéÁöÑ ÊàëÁöÑ‰∫∫ËÆæ ÂøÖÈ°ªÂèòÊàêÈ°∂ÈÉ®ÂúÜËßí */
#ai-persona-group[style*="none"] + #my-persona-group {
    border-top-left-radius: 12px !important;
    border-top-right-radius: 12px !important;
}

/* --- ‰øÆÂ§çÁæ§ÊàêÂëòÁÆ°ÁêÜÂú®ÁâπÊÆäÊÉÖÂÜµ‰∏ãÁöÑÂúÜËßí --- */
/* Â¶ÇÊûúÁæ§ËÅä‰∏≠ ÊàëÁöÑ‰∫∫ËÆæ ‰πüÊòØÈöêËóèÁöÑÔºàËôΩÁÑ∂‰∏ÄËà¨‰∏ç‰ºöÔºâÔºåÂÖúÂ∫ïÁªôÁæ§ÊàêÂëòÁÆ°ÁêÜÂä†ÂúÜËßí */
#my-persona-group[style*="none"] + #group-members-group {
    border-top-left-radius: 12px !important;
    border-top-right-radius: 12px !important;
}
/* Â§öÈÄâÊ®°Âºè‰∏ãÁöÑÂ§¥ÈÉ®ÂõæÊ†áÊ†∑ÂºèË∞ÉÊï¥ */
#chat-interface-screen .selection-controls .header-actions {
    gap: 8px; /* [‰øÆÊîπ] ÂáèÂ∞èÂõæÊ†á‰πãÈó¥ÁöÑÈó¥Ë∑ù (Âéü 15px) */
}

#chat-interface-screen .selection-controls .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px; /* [‰øÆÊîπ] Á®çÂæÆË∞ÉÊï¥ÁÇπÂáªÂå∫Âüü */
    cursor: pointer;
    transition: opacity 0.2s;
    /* [Êñ∞Â¢û] ÈôêÂà∂ÊåâÈíÆÊú¨Ë∫´ÁöÑÂ§ßÂ∞èÔºåÈò≤Ê≠¢ËøáÂ§ß */
    width: 32px; 
    height: 32px;
    border-radius: 50%; /* ‰øùÊåÅÂúÜÂΩ¢ */
}

#chat-interface-screen .selection-controls .action-btn:hover {
    opacity: 0.7;
    background-color: rgba(0,0,0,0.05); /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÁöÑËΩªÂæÆËÉåÊôØ */
}

#chat-interface-screen .selection-controls .action-btn svg {
    width: 18px;  /* [‰øÆÊîπ] ÂáèÂ∞èÂõæÊ†áÂÆΩÂ∫¶ (Âéü 24px) */
    height: 18px; /* [‰øÆÊîπ] ÂáèÂ∞èÂõæÊ†áÈ´òÂ∫¶ (Âéü 24px) */
    stroke-width: 2; /* Á°Æ‰øùÁ∫øÊù°Á≤óÁªÜÈÄÇ‰∏≠ */
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç (‰øùÊåÅ‰∏çÂèòÔºåÂè™ÊòØ‰∏∫‰∫ÜÂÆåÊï¥ÊÄßÂàóÂá∫) */
#phone-screen.dark-mode #chat-interface-screen .selection-controls .action-btn:hover {
    background-color: rgba(255,255,255,0.1);
}
/* --- Êñ∞Â¢ûÔºö‰∏ìÈó®ÈíàÂØπÂ∑¶‰æßÂèñÊ∂àÊåâÈíÆÁöÑÊ†∑Âºè --- */
#chat-interface-screen .selection-controls #selection-cancel-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px;
    cursor: pointer;
    
    /* ÈôêÂà∂Â§ßÂ∞è‰∏∫ 32pxÔºå‰∏éÂè≥‰æß‰øùÊåÅ‰∏ÄËá¥ */
    width: 32px;
    height: 32px;
    border-radius: 50%;
    transition: opacity 0.2s;
    
    /* Á°Æ‰øùÊ≤°ÊúâÈ¢ùÂ§ñÁöÑÊñáÂ≠óÂ§ßÂ∞èÂπ≤Êâ∞ */
    font-size: 0; 
}

#chat-interface-screen .selection-controls #selection-cancel-btn:hover {
    background-color: rgba(0,0,0,0.05);
}

/* Áº©Â∞èÂÜÖÈÉ®ÁöÑ SVG ÂõæÊ†á */
#chat-interface-screen .selection-controls #selection-cancel-btn svg {
    width: 18px;
    height: 18px;
    stroke-width: 2.5; /* Á®çÂæÆÂä†Á≤ó‰∏ÄÁÇπÔºåÂõ†‰∏∫ÂõæÊ†áÂèòÂ∞è‰∫Ü */
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #chat-interface-screen .selection-controls #selection-cancel-btn:hover {
    background-color: rgba(255,255,255,0.1);
}
#contact-picker-screen .header #cancel-contact-picker-btn {
    font-size: 16px;       /* Â∞ÜÂ≠ó‰ΩìÊîπÂõûÊ≠£Â∏∏ÁöÑ 16px */
    width: auto;           /* ÂèñÊ∂àÂõæÊ†á‰∏ìÁî®ÁöÑÂõ∫ÂÆöÂÆΩÂ∫¶ÔºåËÆ©ÊñáÂ≠óËá™ÁÑ∂ÊíëÂºÄ */
    font-weight: normal;   /* ‰∏çÈúÄË¶ÅÂ§™Á≤ó */
    padding: 0 5px;        /* Â¢ûÂä†‰∏ÄÁÇπÁÇπÂáªÂå∫Âüü */
}/* --- iOS Settings UI Transformation --- */

/* --- iOS Settings UI Transformation --- */

/* ËÉåÊôØËâ≤ */
#api-settings-screen.ios-settings-screen {
    background-color: #f2f2f7 !important;
}
#phone-screen.dark-mode #api-settings-screen.ios-settings-screen {
    background-color: #000 !important;
}

/* Â§¥ÈÉ®Ë∞ÉÊï¥ */
#api-settings-screen .header {
    background-color: #f2f2f7 !important;
    border-bottom: none !important;
    box-shadow: none !important;
}
#phone-screen.dark-mode #api-settings-screen .header {
    background-color: #000 !important;
}

/* ÊªöÂä®ÂÆπÂô® */
.ios-scroll-container {
    padding: 20px 16px;
    overflow-y: auto;
    height: 100%;
    box-sizing: border-box;
}

/* ÂàÜÁªÑÊ†áÈ¢ò */
.settings-header {
    font-size: 13px;
    color: #6d6d72;
    margin: 24px 0 8px 16px;
    text-transform: uppercase;
}
#phone-screen.dark-mode .settings-header {
    color: #8d8d93;
}

/* ÊèèËø∞ÊñáÊú¨ */
.settings-desc {
    font-size: 13px;
    color: #6d6d72;
    margin: 8px 16px 0 16px;
    line-height: 1.4;
}

/* Âç°ÁâáÂàÜÁªÑ (Settings Section) */
.settings-section {
    background-color: #ffffff;
    border-radius: 10px;
    overflow: hidden; /* ÂÖ≥ÈîÆÔºöÂàáÂúÜËßí */
    margin-bottom: 20px;
}
#phone-screen.dark-mode .settings-section {
    background-color: #1c1c1e;
}

/* ÂàóË°®È°π (Settings Item) */
.settings-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 11px 16px; /* iOS Ê†áÂáÜÈ´òÂ∫¶ */
    background-color: #fff;
    border-bottom: 0.5px solid #c6c6c8;
    min-height: 44px;
    box-sizing: border-box;
}
#phone-screen.dark-mode .settings-item {
    background-color: #1c1c1e;
    border-bottom-color: #38383a;
}

/* ÂéªÊéâÊØèÁªÑÊúÄÂêé‰∏Ä‰∏™ÂÖÉÁ¥†ÁöÑ‰∏ãËæπÊ°Ü */
.settings-section > .settings-item:last-child {
    border-bottom: none;
}
/* ÈíàÂØπÈöêËóèÁöÑËØ¶ÊÉÖÂùó (Â¶Ç ImgBB, NovelAI) */
#novelai-details, #imgbb-settings-details, #catbox-settings-details, #github-settings-details {
    background-color: #f9f9f9; /* Á®çÂæÆÊ∑±‰∏ÄÁÇπÂå∫ÂàÜÂ±ÇÁ∫ß */
}
#phone-screen.dark-mode #novelai-details, 
#phone-screen.dark-mode #imgbb-settings-details, 
#phone-screen.dark-mode #catbox-settings-details, 
#phone-screen.dark-mode #github-settings-details {
    background-color: #252527;
}

/* Ê†áÁ≠æÊñáÊú¨ */
.settings-item label {
    font-size: 17px;
    color: #000;
    flex-shrink: 0;
    margin: 0;
}
#phone-screen.dark-mode .settings-item label {
    color: #fff;
}

/* Âè≥‰æßÊéß‰ª∂Âå∫Âüü */
.settings-right {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    flex-grow: 1;
    margin-left: 16px;
    min-width: 0;
}

/* ËæìÂÖ•Ê°Ü & ÈÄâÊã©Ê°Ü (Êó†ËæπÊ°ÜÈ£éÊ†º) */
.settings-item input[type="text"],
.settings-item input[type="password"],
.settings-item input[type="number"],
.settings-select {
    width: 100%;
    border: none;
    background: transparent;
    text-align: right;
    font-size: 17px;
    color: #3c3c4399; /* iOS ÁÅ∞Ëâ≤Âç†‰ΩçÁ¨¶Ëâ≤ */
    padding: 0;
    outline: none;
}
/* ÊúâÂÄºÊó∂ÁöÑÈ¢úËâ≤ */
/* --- ‰øÆÂ§ç 1: Â∞ÜËæìÂÖ•Ê°ÜÂíåÈÄâÊã©Ê°ÜÁöÑÊñáÂ≠óÈ¢úËâ≤Êîπ‰∏∫ÈªëËâ≤ --- */
.settings-item input:not(:placeholder-shown),
.settings-select {
    color: #000000 !important; /* Êîπ‰∏∫ÈªëËâ≤ */
}

/* ÊöóÈªëÊ®°Âºè‰∏ãÊîπ‰∏∫ÁôΩËâ≤ */
#phone-screen.dark-mode .settings-item input:not(:placeholder-shown),
#phone-screen.dark-mode .settings-select {
    color: #ffffff !important;
}

/* Âç†‰ΩçÁ¨¶È¢úËâ≤ */
.settings-item input::placeholder {
    color: #c7c7cc;
}

/* ÊåâÈíÆÊ†∑Âºè */
.settings-text-btn {
    background: none;
    border: none;
    font-size: 17px;
    color: #007aff;
    cursor: pointer;
    padding: 4px 0;
}
.settings-text-btn.destructive {
    color: #ff3b30;
}

/* --- ‰øÆÂ§ç 2: ‰ºòÂåñÂÖ®ÂÆΩÊåâÈíÆÔºåÂéªÈô§Â•áÊÄ™ÁöÑÈªëÁ∫øÈóÆÈ¢ò --- */
.settings-full-btn {
    width: 100%;
    background: #fff; /* Á°Æ‰øùÊúâËÉåÊôØËâ≤ */
    border: none;
    border-top: 0.5px solid #c6c6c8; /* ÂàÜÂâ≤Á∫ø */
    padding: 14px;
    font-size: 17px;
    color: #007aff;
    cursor: pointer;
    font-weight: 400; /* iOS ÊåâÈíÆÂ≠ó‰ΩìÈÄöÂ∏∏‰∏çÈúÄË¶ÅÂä†Á≤ó */
    margin: 0; /* Ê∏ÖÈô§Â§ñËæπË∑ù */
    display: block; /* Á°Æ‰øùÊòØÂùóÁ∫ßÂÖÉÁ¥† */
}

#phone-screen.dark-mode .settings-full-btn {
    background: #1c1c1e;
    border-top-color: #38383a;
    color: #0a84ff;
}

/* Â¶ÇÊûúÊåâÈíÆÊòØÂàÜÁªÑÈáåÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºåÂéªÊéâÈ°∂ÈÉ®ÂàÜÂâ≤Á∫ø */
.settings-section .settings-full-btn:first-child {
    border-top: none;
}
.settings-full-btn:active {
    background-color: #e5e5ea;
}
#phone-screen.dark-mode .settings-full-btn:active {
    background-color: #3a3a3c;
}

/* ÂèØÁÇπÂáªÈ°π (Clickable Rows) */
.settings-item.clickable {
    cursor: pointer;
    justify-content: center; /* Â±Ö‰∏≠ÊñáÂ≠ó */
}
.settings-item.clickable:active {
    background-color: #e5e5ea;
}
#phone-screen.dark-mode .settings-item.clickable:active {
    background-color: #3a3a3c;
}

/* ‰øÆÂ§ç Slider */
input[type=range] {
    height: 24px;
    margin: 0;
}

/* ‰øÆÂ§ç Toggle Switch (Â§çÁî®‰πãÂâçÁöÑÔºåÂè™ÈúÄÁ°Æ‰øù vertical-align) */
.toggle-switch {
    display: flex;
    align-items: center;
}

/* Â∞èÊåâÈíÆ (Mini Btn) */
.settings-mini-btn {
    background-color: #f2f2f7;
    color: #007aff;
    border: none;
    border-radius: 14px;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;
}
#phone-screen.dark-mode .settings-mini-btn {
    background-color: #3a3a3c;
    color: #0a84ff;
}

/* Êï∞Â≠óËæìÂÖ•Ê°ÜÁâπÊÆäÂ§ÑÁêÜ */
.settings-num-input {
    max-width: 80px;
    background-color: #f2f2f7 !important;
    border-radius: 6px !important;
    text-align: center !important;
    padding: 4px !important;
    color: #000 !important;
}
#phone-screen.dark-mode .settings-num-input {
    background-color: #3a3a3c !important;
    color: #fff !important;
}

/* Block Item (Áî®‰∫éÂõæÁâáÂ§ßÂ∞èËÆ°ÁÆóÁ≠â) */
.settings-item-block {
    padding: 11px 16px;
    background-color: #fff;
}
#phone-screen.dark-mode .settings-item-block {
    background-color: #1c1c1e;
}
/* --- ‰øÆÂ§ç 1: ‰∏ãÊãâÊ°ÜÂØπÈΩêÈÄªËæë (Èó≠ÂêàÂè≥ÂØπÈΩêÔºåÂ±ïÂºÄÂ∑¶ÂØπÈΩê) --- */
.settings-select {
    text-align: right !important;       /* Èó≠ÂêàÁä∂ÊÄÅÔºöÊñáÂ≠óÈù†Âè≥ */
    text-align-last: right !important;  /* Âº∫Âà∂ÊúÄÂêé‰∏ÄË°åÈù†Âè≥ (ÈíàÂØπÈÉ®ÂàÜÊµèËßàÂô®) */
    direction: ltr !important;          /* ‰øùÊåÅ‰ªéÂ∑¶Âà∞Âè≥ÁöÑÊñáÂ≠óÊñπÂêë */
    padding-right: 24px;                /* ÁïôÂá∫Âè≥‰æßÁ©∫Èó¥ÁªôÁÆ≠Â§¥ÊàñÂêéÈù¢Âä†ÁöÑÊåâÈíÆ */
    background-position: right center;  /* Á°Æ‰øùÂéüÁîüÁÆ≠Â§¥Âú®Âè≥‰æß */
}

/* Â±ïÂºÄÂêéÁöÑÈÄâÈ°πÂº∫Âà∂Â∑¶ÂØπÈΩê */
.settings-select option {
    text-align: left !important;
    direction: ltr !important;
}

/* --- ‰øÆÂ§ç 2: ÊåâÈíÆÊîπ‰∏∫Ë°åÂÜÖÁÆÄÁ∫¶È£éÊ†º (ÂéªËÉåÊôØ) --- */
/* ÂÆö‰πâ‰∏Ä‰∏™Êñ∞ÁöÑË°åÂÜÖÊåâÈíÆÊ†∑Âºè */
.settings-inline-btn {
    background: none !important;     /* ÂéªÊéâÁÅ∞Ëâ≤ËÉåÊôØ */
    border: none !important;         /* ÂéªÊéâËæπÊ°Ü */
    font-size: 15px !important;      /* Â≠ó‰ΩìÂ§ßÂ∞è */
    font-weight: 500 !important;
    padding: 4px 8px !important;     /* ÂáèÂ∞èÂÜÖËæπË∑ù */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 30px;                 /* ‰øùËØÅËß¶Êë∏Âå∫Âüü */
}

/* ‰øùÂ≠òÊåâÈíÆ (ËìùËâ≤) */
.settings-inline-btn.save-btn {
    color: #007aff !important;
}

/* Âà†Èô§ÊåâÈíÆ (Á∫¢Ëâ≤) */
.settings-inline-btn.delete-btn {
    color: #ff3b30 !important;
    border-left: 1px solid #c6c6c8 !important; /* Âä†‰∏™Â∑¶ËæπÊ°ÜÂàÜÈöîÁ∫ø */
    padding-left: 12px !important;
    margin-left: 4px;
}

/* ÊåâÈíÆÁÇπÂáªÊÄÅ */
.settings-inline-btn:active {
    opacity: 0.5;
}

/* Ë∞ÉÊï¥Âè≥‰æßÂÆπÂô®ÔºåËÆ©‰∏ãÊãâÊ°ÜÂíåÊåâÈíÆÊéíÊàê‰∏ÄË°å */
.settings-right {
    gap: 2px !important; /* ÂáèÂ∞èÂÖÉÁ¥†Èó¥Ë∑ù */
}
/* --- ‰øÆÂ§ç 1: Êà™ÂõæÂêåÊ¨æ‚ÄúÊõ¥Êç¢‚ÄùÊåâÈíÆÊ†∑Âºè --- */
.settings-mini-btn {
    background-color: #f2f2f7 !important; /* ÊµÖÁÅ∞ËÉåÊôØ */
    border: 1px solid #e5e5ea !important; /* ÊûÅÊ∑°ÁöÑËæπÊ°Ü */
    color: #007aff !important;            /* iOS ËìùËâ≤ÊñáÂ≠ó */
    border-radius: 6px !important;        /* Â∞èÂúÜËßí */
    padding: 5px 12px !important;         /* ÂÜÖËæπË∑ù */
    font-size: 13px !important;           /* Â≠ó‰ΩìÁ®çÂ∞è */
    font-weight: 500 !important;          /* ÈÄÇ‰∏≠Â≠óÈáç */
    cursor: pointer;
    white-space: nowrap;                  /* Èò≤Ê≠¢Êç¢Ë°å */
    margin-left: 8px;                     /* ‰∏éÂ∑¶ËæπÁöÑËæìÂÖ•Ê°Ü‰øùÊåÅË∑ùÁ¶ª */
    transition: opacity 0.2s;
}

/* ÁÇπÂáªÊó∂ÁöÑÂèçÈ¶à */
.settings-mini-btn:active {
    opacity: 0.6;
    background-color: #e5e5ea !important;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .settings-mini-btn {
    background-color: #2c2c2e !important;
    border-color: #3a3a3c !important;
    color: #0a84ff !important;
}
#phone-screen.dark-mode .settings-mini-btn:active {
    background-color: #3a3a3c !important;
}
/* --- ‰øÆÊ≠£ 1: Êï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆÊîπ‰∏∫ iOS Ê†áÂáÜÂàóË°®È£éÊ†º (ÈªëÂ≠ó„ÄÅÂ∑¶ÂØπÈΩê) --- */
.settings-full-btn {
    width: 100%;
    background-color: #fff !important;
    border: none;
    border-top: 0.5px solid #c6c6c8 !important; /* ÁªÜÂàÜÂâ≤Á∫ø */
    padding: 14px 16px !important; /* Ê†áÂáÜÂÜÖËæπË∑ù */
    font-size: 17px !important;
    color: #000000 !important; /* Êîπ‰∏∫ÈªëËâ≤ */
    font-weight: 400 !important; /* Ê≠£Â∏∏Â≠óÈáç */
    text-align: left !important; /* Âº∫Âà∂Â∑¶ÂØπÈΩê */
    cursor: pointer;
    margin: 0 !important;
    display: block;
    border-radius: 0 !important;
}

/* Âç±Èô©ÊåâÈíÆ‰øùÊåÅÁ∫¢Ëâ≤Ôºå‰ΩÜ‰æùÁÑ∂Â∑¶ÂØπÈΩê */
.settings-full-btn[style*="color: #ff3b30"],
.settings-full-btn[style*="color:#ff3b30"] {
    color: #ff3b30 !important;
}

/* ÊåâÈíÆÁÇπÂáªÊÄÅ */
.settings-full-btn:active {
    background-color: #e5e5ea !important;
}

/* --- ‰øÆÊ≠£ 2: Ê∏ÖÈô§‚ÄúÂõæÁâáÂç†Áî®Â§ßÂ∞è‚ÄùÊóßÊ†∑ÂºèÁöÑÁÅ∞Ê°ÜÂíåÈªëÁ∫ø --- */
#total-image-size-display {
    background: transparent !important; /* ÂéªÊéâÁÅ∞Ëâ≤ËÉåÊôØ */
    border: none !important;            /* ÂéªÊéâËæπÊ°Ü */
    padding: 0 !important;
    margin: 0 !important;
    color: #8a8a8a;
    font-size: 17px;
}

/* --- ‰øÆÊ≠£ 3: ËÆ©È¢ÑËÆæÈÉ®ÂàÜÁöÑ‰∏ãÊãâÊ°ÜÂíåÊåâÈíÆÂ∏ÉÂ±ÄÊõ¥Á¥ßÂáë --- */
/* ÈíàÂØπÈ¢ÑËÆæÁÆ°ÁêÜÈÇ£‰∏ÄË°åÁöÑÁâπÊÆäÂæÆË∞É */
#api-settings-screen .settings-item .settings-right {
    gap: 8px !important; /* Â¢ûÂä†‰∏ÄÁÇπÈó¥Ë∑ù */
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .settings-full-btn {
    background-color: #1c1c1e !important;
    border-top-color: #38383a !important;
    color: #ffffff !important;
}
#phone-screen.dark-mode .settings-full-btn:active {
    background-color: #2c2c2e !important;
}
/* --- ‰øÆÊ≠£ 1: ‰∏ãÊãâÊ°ÜÂÆåÂÖ®Â∑¶ÂØπÈΩêÔºåÂéªÈô§Âè≥‰æßÂÜÖËæπË∑ù --- */
.settings-select {
    text-align: left !important;
    padding-left: 0 !important; /* Á¥ßË¥¥Â∑¶‰æß */
    direction: ltr !important;
}

/* --- ‰øÆÊ≠£ 2: ÂàóË°®ÊåâÈíÆÈ¢úËâ≤Áªü‰∏Ä (Âº∫Âà∂ÈªëËâ≤) --- */
.settings-full-btn {
    color: #000000 !important; /* Áªü‰∏Ä‰∏∫ÈªëËâ≤ */
}

/* ÊöóÈªëÊ®°Âºè‰∏ãÁªü‰∏Ä‰∏∫ÁôΩËâ≤ */
#phone-screen.dark-mode .settings-full-btn {
    color: #ffffff !important;
}
/* --- ‰øÆÊ≠£ 1: ÊåâÈíÆÈ¢úËâ≤Áªü‰∏Ä‰∏∫ÈªëËâ≤ (ÂéªËìùÂéªÁ∫¢) --- */
/* Â∞èÊåâÈíÆ (‰øùÂ≠ò„ÄÅÂà†Èô§„ÄÅÂéãÁº©) */
.settings-mini-btn {
    color: #333333 !important; /* ÈªëËâ≤ÊñáÂ≠ó */
    background-color: #f2f2f7 !important;
    border: 1px solid #e5e5ea !important;
    margin-left: 8px;
}

/* Â§ßÂàóË°®ÊåâÈíÆ (ÂØºÂá∫„ÄÅÂØºÂÖ•„ÄÅÊ∏ÖÁêÜ) */
.settings-full-btn {
    color: #333333 !important; /* ÈªëËâ≤ÊñáÂ≠ó */
    text-align: left !important;
    justify-content: flex-start !important;
    padding-left: 16px !important;
}

/* ÊöóÈªëÊ®°Âºè‰∏ãÊîπ‰∏∫ÁôΩËâ≤ */
#phone-screen.dark-mode .settings-mini-btn,
#phone-screen.dark-mode .settings-full-btn {
    color: #ffffff !important;
}

/* --- ‰øÆÊ≠£ 2: Âº∫Âà∂Ê∏ÖÊ¥ó JS ÁîüÊàêÁöÑÂÜó‰ΩôÊñáÊú¨ --- */
/* ÈöêËóè JS ÁîüÊàêÁöÑ "Êú¨Âú∞ÂõæÁâá(Â§¥ÂÉè/Ë°®ÊÉÖ...):" Ëøô‰∏≤ÈïøÂ≠ó */
#total-image-size-display #image-size-label {
    display: none !important;
}

/* Âè™ÊòæÁ§∫Â§ßÂ∞èÊï∞ÂÄºÔºåÂπ∂Ë∞ÉÊï¥Ê†∑Âºè */
#total-image-size-display #image-size-value {
    font-size: 13px;
    color: #8a8a8a; /* Ê¨°Ë¶Å‰ø°ÊÅØÁÅ∞Ëâ≤ */
    margin-top: 2px;
    display: block;
    text-align: left;
}

/* ÁßªÈô§Â§ñÂ±ÇÂÆπÂô®ÁöÑÂπ≤Êâ∞Ê†∑Âºè */
#total-image-size-display {
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: flex-start !important;
}

/* --- ‰øÆÊ≠£ 3: ‰∏ãÊãâÊ°ÜÂØπÈΩêË∞ÉÊï¥ --- */
/* ËÆ©‰∏ãÊãâÊ°ÜÊñáÂ≠óÁ¥ßË¥¥Â∑¶‰æß */
.settings-select {
    text-align: left !important;
    padding-left: 0 !important;
}
/* --- ‰øÆÂ§ç 1: Êö¥ÂäõÊ∏ÖÈô§‰∏ãÊãâÊ°ÜÁöÑÊâÄÊúâÈó¥Èöô --- */
.settings-select {
    appearance: none !important;        /* Ê∏ÖÈô§Á≥ªÁªüÈªòËÆ§Â§ñËßÇ */
    -webkit-appearance: none !important;
    background: transparent !important; /* ÂéªÈô§ËÉåÊôØ */
    border: none !important;            /* ÂéªÈô§ËæπÊ°Ü */
    padding: 0 !important;              /* Ê∏ÖÈô§ÂÜÖËæπË∑ù */
    margin: 0 !important;               /* Ê∏ÖÈô§Â§ñËæπË∑ù */
    text-indent: 0 !important;          /* Ê∏ÖÈô§È¶ñË°åÁº©Ëøõ */
    text-align: left !important;        /* Âº∫Âà∂Â∑¶ÂØπÈΩê */
    font-size: 17px !important;
    line-height: normal !important;
    color: #000 !important;
    width: 100%;
}

/* ÊöóÈªëÊ®°ÂºèÊñáÂ≠óÈ¢úËâ≤ */
#phone-screen.dark-mode .settings-select {
    color: #fff !important;
}

/* --- ‰øÆÂ§ç 2: Êï∞ÊçÆÁÆ°ÁêÜË°åÂ∏ÉÂ±Ä (ÂÆûÁé∞ÔºöÊ†áÈ¢ò------Êï∞ÂÄº [ÊåâÈíÆ]) --- */
/* ËÆ©Âè≥‰æßÂÆπÂô®ÈáåÁöÑÂÜÖÂÆπÁ¥ßÂáëÊéíÂàó */
.data-row-right {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px; /* Êï∞ÂÄºÂíåÊåâÈíÆ‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    flex-grow: 1;
}

/* Á∫ØÂáÄÊòæÁ§∫Êï∞ÂÄºÔºåÂéªÊéâJSÁîüÊàêÁöÑÊ†áÁ≠æÊñáÂ≠ó */
#total-image-size-display {
    font-size: 15px !important;
    color: #8a8a8a !important; /* Ê¨°Ë¶Å‰ø°ÊÅØÁî®ÁÅ∞Ëâ≤ */
    background: none !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
}
/* ÈöêËóèÊéâ JS Ëá™Âä®ÁîüÊàêÁöÑ "Êú¨Âú∞ÂõæÁâá(xxx):" ËøôÁßçÈïøÊñáÊú¨ÔºåÂè™ÁïôÊï∞Â≠ó */
#total-image-size-display #image-size-label {
    display: none !important;
}
#total-image-size-display #image-size-value {
    font-weight: 400 !important;
    color: #8a8a8a !important;
}
#api-preset-select.settings-select {
    text-align: left !important;       /* Âº∫Âà∂Â∑¶ÂØπÈΩê */
    text-align-last: left !important;  /* ÈíàÂØπÈÄâ‰∏≠ÂÄºÁöÑÂº∫Âà∂Â∑¶ÂØπÈΩê (ÂÖ≥ÈîÆ) */
    padding-left: 0 !important;        /* ÂéªÈô§Â∑¶‰æßÂÜÖËæπË∑ù */
    direction: ltr !important;         /* ‰ªéÂ∑¶Âà∞Âè≥ÊéíÂàó */
    width: 100% !important;            /* Âç†Êª°ÂÆπÂô® */
    display: block !important;
}
/* --- ‰øÆÂ§ç: ËøòÂéüÁÅ∞Ëâ≤ÁöÑËØ¥Êòé/ÊïôÁ®ãÊù° --- */
/* ËøôÊòØ‰∏Ä‰∏™ÂàóË°®È°πÂÆπÂô®ÔºåÁ°Æ‰øùÂÆÉÂú®ÁôΩËâ≤Âç°ÁâáÂÜÖÂç†‰Ωç */
.settings-tip-wrapper {
    padding: 10px 16px;
    background-color: #fff;
    border-bottom: 0.5px solid #c6c6c8;
}

/* ËøôÊòØÈáåÈù¢ÁöÑÁÅ∞Ëâ≤ÂúÜËßíÊ°Ü (ÂØπÂ∫î‰Ω†Êà™ÂõæÁöÑÊ†∑Â≠ê) */
.settings-tip-content {
    background-color: #f0f0f0; /* ÊµÖÁÅ∞ËÉåÊôØ */
    color: #666666;            /* Ê∑±ÁÅ∞ÊñáÂ≠ó */
    font-size: 13px;
    padding: 10px;
    border-radius: 8px;        /* ÂúÜËßí */
    line-height: 1.5;          /* Ë°åÈ´òÔºåÊòìËØª */
}
/* Âº∫Ë∞ÉÊñáÂ≠ó (Á∫¢Ëâ≤Ë≠¶Âëä) */
.settings-tip-content strong {
    color: #ff3b30;
    font-weight: 600;
}
/* ÈìæÊé•Ê†∑Âºè */
.settings-tip-content a {
    color: #007aff;
    text-decoration: none;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .settings-tip-wrapper {
    background-color: #1c1c1e;
    border-bottom-color: #38383a;
}
#phone-screen.dark-mode .settings-tip-content {
    background-color: #2c2c2e; /* Ê∑±Ëâ≤ËÉåÊôØ */
    color: #aeaeb2;
}
/* ============================================================
   „ÄêÁã¨Á´ã‰øÆÂ§ç„ÄëËÅäÂ§©ËØ¶ÊÉÖÈ°µ‰∏ãÊãâÊ°Ü (‰∏çÂΩ±Âìç API ËÆæÁΩÆÈ°µ)
   ============================================================ */

/* 1. Â∞ÜÈÄâÊã©Âô®ÈôêÂÆöÂú® #chat-settings-screen ÂÜÖ */
#chat-settings-screen .settings-select {
    /* ÊÅ¢Â§çÁÅ∞Ëâ≤ËÉåÊôØÊù° */
    background-color: #f2f2f7 !important;
    
    /* Âä†ÂõûËæπÊ°ÜÂíåÂúÜËßíÔºåËÆ©ÂÆÉÁúãËµ∑Êù•ÂÉè‰∏™ÊåâÈíÆ */
    border: 1px solid #e5e5ea !important;
    border-radius: 6px !important;
    
    /* Ë∞ÉÊï¥ÂÜÖËæπË∑ùÔºö‰∏ä‰∏ã 6px ‰øùËØÅÈ´òÂ∫¶‰∏éÊóÅËæπÁöÑ‚ÄúÊõ¥Êç¢‚ÄùÊåâÈíÆ‰∏ÄËá¥ */
    padding: 6px 25px 6px 12px !important; 
    
    /* ÊÅ¢Â§çÈªëËâ≤ÊñáÂ≠ó */
    color: #333 !important;
    
    /* ÈªòËÆ§ÔºöÂº∫Âà∂Â∑¶ÂØπÈΩê */
    text-align: left !important;
    text-align-last: left !important;
    
    /* Ê∑ªÂä†‰∏Ä‰∏™Â∞èÁÆ≠Â§¥ÂõæÊ†áÔºåËÆ©ÂÆÉÁúãËµ∑Êù•Êõ¥ÂÉè‰∏ãÊãâÊ°Ü */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238a8a8a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 8px center !important;
    background-size: 12px !important;
    
    /* Á°Æ‰øùÈ´òÂ∫¶ÊíëÂºÄ */
    min-height: 28px !important;
    line-height: normal !important;
}

/* 2. „ÄêÁâπ‰æã„ÄëËØ≠Èü≥ËØ≠Ë®ÄÈÄâÊã©ÔºöÂº∫Âà∂Âè≥ÂØπÈΩê */
#chat-settings-screen #ai-voice-lang-select {
    text-align: right !important;
    text-align-last: right !important;
    direction: ltr !important;
    /* Âè≥‰æßÁïôÂá∫‰∏ÄÁÇπÁ©∫Èó¥ÁªôÁÆ≠Â§¥Ôºå‰ΩÜÊñáÂ≠óÈù†Âè≥ */
    padding-right: 30px !important; 
    padding-left: 0 !important;
}

/* 3. ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç (‰ªÖÈíàÂØπËÅäÂ§©ËÆæÁΩÆÈ°µ) */
#phone-screen.dark-mode #chat-settings-screen .settings-select {
    background-color: #3a3a3c !important;
    border-color: #48484a !important;
    color: #fff !important;
    
    /* ÊöóÈªëÊ®°Âºè‰∏ãÁÆ≠Â§¥ÂèòÁôΩ‰∏ÄÁÇπ */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
}
#ai-avatar-group,
#group-avatar-group,
#my-avatar-group {
    /* 1. ÊîπÂèò‰∏ªËΩ¥ÊñπÂêë‰∏∫ÂûÇÁõ¥ÔºåËÆ©Ê†áÁ≠æÂíåÂÜÖÂÆπÊç¢Ë°å */
    flex-direction: column !important;
    
    /* 2. ËÆ©Â≠êÂÖÉÁ¥†Êãâ‰º∏Â°´Êª°ÂÆΩÂ∫¶ */
    align-items: stretch !important;
    
    /* 3. Â¢ûÂä†Ê†áÁ≠æÂíå‰∏ãÊñπÂÜÖÂÆπ‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    gap: 8px !important;
    
    /* 4. Á°Æ‰øùÈ´òÂ∫¶Ëá™ÈÄÇÂ∫î */
    height: auto !important;
    padding-bottom: 12px !important;
}

/* ‰øÆÊ≠£‰∏ãÊñπÂÜÖÂÆπÂå∫ÂüüÁöÑËæπË∑ù */
#ai-avatar-group .settings-right,
#group-avatar-group .settings-right,
#my-avatar-group .settings-right {
    /* Êç¢Ë°åÂêé‰∏çÂÜçÈúÄË¶ÅÂ∑¶ËæπË∑ù */
    margin-left: 0 !important; 
    
    /* Á°Æ‰øùÂç†Êª°Êï¥Ë°åÂÆΩÂ∫¶ */
    width: 100% !important;
}

/* Á°Æ‰øùÂ§¥ÂÉèÊìç‰ΩúÂå∫‰∏§Á´ØÂØπÈΩê (Â§¥ÂÉèÂú®Â∑¶ÔºåÊåâÈíÆÂú®Âè≥) */
#ai-avatar-group .avatar-action-wrapper,
#group-avatar-group .avatar-action-wrapper,
#my-avatar-group .avatar-action-wrapper {
    justify-content: space-between !important;
    width: 100% !important;
}
#toggle-reading-fullscreen-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 4px 8px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}
#toggle-reading-fullscreen-btn:hover {
    background-color: rgba(0,0,0,0.1);
}

/* 2. ÂΩìÁ™óÂè£ÂÖ®Â±èÊó∂ÔºåÂàáÊç¢ÊåâÈíÆÂÜÖÁöÑÂõæÊ†á */
#reading-window.fullscreen #toggle-reading-fullscreen-btn .icon-maximize {
    display: none;
}
#reading-window.fullscreen #toggle-reading-fullscreen-btn .icon-minimize {
    display: block;
}

/* 3. Á™óÂè£ÂÖ®Â±èÊó∂ÁöÑÊ†∏ÂøÉÊ†∑Âºè */
#reading-window.fullscreen {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    top: 0 !important;
    left: 0 !important;
    border-radius: 0;
    box-shadow: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 4. ÈÅÆÁΩ©Â±ÇÂú®ÂÖ®Â±èÊó∂ÁöÑÊ†∑Âºè */
#reading-overlay.fullscreen-active {
    align-items: stretch;
    justify-content: stretch;
}
/* --- ‚Äú‰∏ÄËµ∑ËØª‰π¶‚ÄùÂÖ®Â±èÂäüËÉΩÊ†∑Âºè ‰ºòÂåñÁâà --- */

/* 1. ‰øÆÂ§çÂ§¥ÈÉ®Â∏ÉÂ±ÄÔºåÈò≤Ê≠¢Ê†áÈ¢òËøáÈïøÊääÊåâÈíÆÊå§‰∏ãÂéª */
.reading-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px; /* Ê†áÈ¢òÂíåÊåâÈíÆÁªÑ‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    flex-wrap: nowrap; /* Âº∫Âà∂‰∏çÊç¢Ë°å */
}

#reading-title {
    flex: 1; /* Âç†ÊçÆÂèØÁî®Á©∫Èó¥ */
    min-width: 0; /* ÂÖÅËÆ∏Ë¢´ÂéãÁº© */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Ê†áÈ¢òËøáÈïøÊó∂ÊòæÁ§∫ÁúÅÁï•Âè∑ */
}

.reading-controls {
    flex-shrink: 0; /* Èò≤Ê≠¢ÊåâÈíÆÁªÑË¢´ÂéãÁº© */
    display: flex; /* Á°Æ‰øùÂÜÖÈÉ®ÊåâÈíÆÊ∞¥Âπ≥ÊéíÂàó */
    align-items: center;
}

/* 2. ÁæéÂåñÊñ∞ÁöÑÂÖ®Â±è/ÊúÄÂ∞èÂåñÊåâÈíÆ */
#toggle-reading-fullscreen-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 4px 8px; /* Ë∞ÉÊï¥ÁÇπÂáªÂå∫Âüü */
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}
#toggle-reading-fullscreen-btn:hover {
    background-color: rgba(0,0,0,0.1);
}

/* 3. ÂΩìÁ™óÂè£ÂÖ®Â±èÊó∂ÔºåÂàáÊç¢ÊåâÈíÆÂÜÖÁöÑÂõæÊ†áÊòæÁ§∫ */
#reading-window.fullscreen #toggle-reading-fullscreen-btn .icon-maximize {
    display: none;
}
#reading-window.fullscreen #toggle-reading-fullscreen-btn .icon-minimize {
    display: block;
}

/* 4. Á™óÂè£ÂÖ®Â±èÊó∂ÁöÑÊ†∏ÂøÉÊ†∑Âºè (‰∏é‰∏äÊ¨°Áõ∏Âêå) */
#reading-window.fullscreen {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    top: 0 !important;
    left: 0 !important;
    border-radius: 0;
    box-shadow: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 5. ÈÅÆÁΩ©Â±ÇÂú®ÂÖ®Â±èÊó∂ÁöÑÊ†∑Âºè (‰∏é‰∏äÊ¨°Áõ∏Âêå) */
#reading-overlay.fullscreen-active {
    align-items: stretch;
    justify-content: stretch;
}/* =========================================== */
/* ‚ñº‚ñº‚ñº ÈòÖËØªÊ®°ÂºèÂÖ®Â±è/Â§¥ÈÉ®‰øÆÂ§çË°•‰∏Å ‚ñº‚ñº‚ñº */
/* =========================================== */

/* 1. ‰øÆÂ§çÂÖ®Â±èÁä∂ÊÄÅ‰∏ãÁöÑÂõæÊ†áÂàáÊç¢ÈÄªËæë */
/* ÈªòËÆ§Áä∂ÊÄÅÔºöÊòæÁ§∫ÊúÄÂ§ßÂåñÂõæÊ†áÔºåÈöêËóèËøòÂéüÂõæÊ†á */
#toggle-reading-fullscreen-btn .icon-maximize {
    display: block !important;
}
#toggle-reading-fullscreen-btn .icon-minimize {
    display: none !important;
}

/* ÂÖ®Â±èÁä∂ÊÄÅÔºöÈöêËóèÊúÄÂ§ßÂåñÂõæÊ†áÔºåÊòæÁ§∫ËøòÂéüÂõæÊ†á */
#reading-window.fullscreen #toggle-reading-fullscreen-btn .icon-maximize {
    display: none !important;
}
#reading-window.fullscreen #toggle-reading-fullscreen-btn .icon-minimize {
    display: block !important;
}

/* 2. ‰øÆÂ§çÂÖ®Â±èÊó∂ÁöÑÂ§¥ÈÉ®Â∏ÉÂ±Ä‰∏éÈó¥Ë∑ù (Ëß£ÂÜ≥ÈáçÂè†ÈóÆÈ¢ò) */
#reading-window.fullscreen .reading-header {
    /* „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ¢ûÂä†È°∂ÈÉ®ÂÜÖËæπË∑ùÔºö
       45px ÊòØÈÅøËÆ©Áä∂ÊÄÅÊ†èÁöÑÂü∫Á°ÄÈ´òÂ∫¶Ôºå
       env(safe-area-inset-top) ÊòØÈÄÇÈÖçÂàòÊµ∑Â±è/ÁÅµÂä®Â≤õ
    */
    padding-top: calc(45px + env(safe-area-inset-top)) !important;
    padding-bottom: 15px !important;
    padding-left: 20px !important;
    padding-right: 20px !important;

    /* Âº∫Âà∂È´òÂ∫¶Ëá™ÈÄÇÂ∫î */
    height: auto !important;
    min-height: 80px !important; /* ‰øùËØÅÊúâË∂≥Â§üÁöÑÈ´òÂ∫¶ */

    /* ‰øÆÂ§çËÉåÊôØËâ≤ÔºöÂÖ®Â±èÊó∂ÂøÖÈ°ªÊúâ‰∏çÈÄèÊòéËÉåÊôØÔºåÂê¶ÂàôÂÜÖÂÆπ‰ºöÈÄèÂá∫Êù• */
    background-color: #fff !important; 
    /* Âä†‰∏äÂ∫ïÈÉ®ËæπÊ°ÜÁ∫ø */
    border-bottom: 1px solid var(--border-color) !important;
    
    /* Á°Æ‰øùÂ§¥ÈÉ®Âú®ÊúÄ‰∏äÂ±Ç */
    z-index: 10 !important;
    
    /* Âº∫Âà∂‰∏îÁªùÂØπÁöÑÈ°∂ÈÉ®ÂÆö‰ΩçÔºåÈò≤Ê≠¢Ë¢´Áà∂Á∫ßflexÂΩ±Âìç */
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* 3. ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #reading-window.fullscreen .reading-header {
    background-color: #1c1c1e !important; /* ÊöóÈªëÊ®°ÂºèËÉåÊôØËâ≤ */
    border-bottom-color: #38383a !important;
}

/* 4. ‰øÆÂ§çÂÖ®Â±èÊó∂ÁöÑÂÜÖÂÆπÂå∫ÂüüÔºåÈò≤Ê≠¢Ë¢´Âä†È´òÁöÑÂ§¥ÈÉ®ÈÅÆÊå° */
#reading-window.fullscreen #reading-content {
    /* ÁªôÂÜÖÂÆπÈ°∂ÈÉ®Â¢ûÂä†Êõ¥Â§öÁöÑÂÜÖËæπË∑ùÔºåÂõ†‰∏∫Â§¥ÈÉ®ÂèòÈ´ò‰∫Ü */
    padding-top: calc(100px + env(safe-area-inset-top)) !important;
}
/* --- iOS È£éÊ†ºÈÄöÁî®ÂåñÈÄÇÈÖç (ÈÄÇÈÖçÂ§ñËßÇËÆæÁΩÆÈ°µ) --- */

/* ËÆ©‰∏§‰∏™È°µÈù¢ÈÉΩ‰ΩøÁî® iOS ËÉåÊôØËâ≤ */
#api-settings-screen.ios-settings-screen,
#wallpaper-screen {
    background-color: #f2f2f7 !important;
}
#phone-screen.dark-mode #api-settings-screen.ios-settings-screen,
#phone-screen.dark-mode #wallpaper-screen {
    background-color: #000 !important;
}

/* Â§¥ÈÉ®ÈÄÇÈÖç */
#wallpaper-screen .header {
    background-color: #f2f2f7 !important;
    border-bottom: none !important;
    box-shadow: none !important;
}
#phone-screen.dark-mode #wallpaper-screen .header {
    background-color: #000 !important;
}

/* Á°Æ‰øùÂ§ñËßÇËÆæÁΩÆÈ°µ‰ΩøÁî®ÊªöÂä®ÂÆπÂô®Ê†∑Âºè */
#wallpaper-screen .settings-container {
    padding: 10px 16px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    box-sizing: border-box;
    overflow-y: auto;
}

/* Â£ÅÁ∫∏È¢ÑËßàÂõæÊ†∑Âºè‰ºòÂåñ (Â∞èÂõæÊ®°Âºè) */
.wallpaper-thumbnail {
    width: 40px;
    height: 70px; /* 9:16 ÊØî‰æã */
    border-radius: 6px;
    background-color: #eee;
    background-size: cover;
    background-position: center;
    border: 1px solid #d1d1d6;
    margin-right: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #999;
    overflow: hidden;
    text-align: center;
    line-height: 1.2;
}
#phone-screen.dark-mode .wallpaper-thumbnail {
    background-color: #2c2c2e;
    border-color: #3a3a3c;
}

/* ÊåâÈíÆÁªÑÂæÆË∞É */
.action-btn-group {
    display: flex;
    gap: 6px;
}

/* ÈöêËóèÁöÑ Input ‰øùÊåÅÈöêËóè */
.hidden-input {
    display: none !important;
}

/* ÂõæÊ†áÁΩëÊ†ºÂú®ÁôΩËâ≤Âç°ÁâáÂÜÖÁöÑÈÄÇÈÖç */
.settings-icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 15px;
    padding: 10px 0;
}
.settings-icon-grid .icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
}
.settings-icon-grid .icon-preview {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.1);
}

/* ÊãñÊãΩÊéíÂ∫èÂå∫ÂüüÈÄÇÈÖç */
#button-order-editor {
    background-color: transparent !important; /* ÁßªÈô§ÂéüÊúâÁöÑÁÅ∞Ëâ≤ËÉåÊôØ */
    border: none !important;
    padding: 0 !important;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.draggable-button-item {
    background-color: #f2f2f7;
    border: 1px solid #e5e5ea;
    border-radius: 8px;
    padding: 6px 10px;
}
#phone-screen.dark-mode .draggable-button-item {
    background-color: #2c2c2e;
    border-color: #3a3a3c;
}

/* ÈîÅÂ±èÂØÜÁ†ÅËæìÂÖ•Ê°ÜÈÄÇÈÖç */
#lock-screen-password-input {
    letter-spacing: 8px !important;
    font-weight: bold !important;
    font-size: 20px !important;
    text-align: center !important;
    background-color: #f2f2f7 !important;
    border-radius: 8px;
    height: 40px;
}
#phone-screen.dark-mode #lock-screen-password-input {
    background-color: #2c2c2e !important;
}

/* ÊñáÊú¨ÂüüÈÄÇÈÖç */
#global-css-input {
    font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    font-size: 12px;
    background-color: #f2f2f7;
    border: none;
    border-radius: 8px;
    padding: 10px;
    min-height: 100px;
}
#phone-screen.dark-mode #global-css-input {
    background-color: #2c2c2e;
    color: #fff;
}
/* --- ‰øÆÂ§çÔºöÂ£ÅÁ∫∏È¢ÑËßàÂõæÊ†∑Âºè (Â∏¶Âº∫Âà∂Ë¶ÜÁõñ) --- */
.wallpaper-thumbnail {
    /* ‰ΩøÁî® !important Âº∫Âà∂Ë¶ÜÁõñÊóßÁöÑ #wallpaper-preview Ê†∑Âºè */
    width: 40px !important;
    height: 70px !important; /* 9:16 ÊØî‰æã */
    
    border-radius: 6px;
    background-color: #eee;
    background-size: cover;
    background-position: center;
    
    /* Ë¶ÜÁõñÊóßÁöÑËæπÊ°ÜÊ†∑Âºè */
    border: 1px solid #d1d1d6 !important;
    margin: 0 !important;
    margin-right: 8px !important;
    
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #999;
    overflow: hidden;
    text-align: center;
    line-height: 1.2;
    flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´Êå§Âéã */
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .wallpaper-thumbnail {
    background-color: #2c2c2e;
    border-color: #3a3a3c !important;
}
/* Â§©Ê∞îËÆæÁΩÆ‰∏ìÁî®Ê†∑Âºè - ‰øùÊåÅÂéüÁîüÈ£éÊ†º */
.weather-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    width: 100%;
}

.weather-input {
    flex: 1; /* ËÆ©ËæìÂÖ•Ê°ÜÂπ≥ÂàÜÂÆΩÂ∫¶ */
    background-color: #f2f2f7; /* ‰∏éÂéüÁîüËæìÂÖ•Ê°ÜËÉåÊôØ‰∏ÄËá¥ */
    border: none;
    border-radius: 6px;
    padding: 8px 10px;
    font-size: 14px;
    color: #333;
    outline: none;
    min-width: 0; /* Èò≤Ê≠¢Ê∫¢Âá∫ */
}

.weather-result-text {
    font-size: 12px;
    color: #8a8a8a;
    margin-top: 6px;
    text-align: left; /* Â∑¶ÂØπÈΩêÁúãËµ∑Êù•Êõ¥Êï¥ÈΩê */
    padding-left: 2px;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .weather-input {
    background-color: #3a3a3c;
    color: #fff;
}
/* --- ‰∏ªÂ±èÂπïÁ¨¨‰∫åÈ°µÂ∏ÉÂ±ÄË∞ÉÊï¥ --- */
#page-2-app-container {
    display: grid;
    grid-template-columns: 155px 1fr; /* ‰øùÊåÅÂéüÊù•ÁöÑÂàóÂÆΩÊØî‰æã */
    gap: 15px;
    width: 100%;
    padding-top: 20px;
    align-items: start;
}

.left-column-stack {
    display: flex;
    flex-direction: column;
    gap: 15px; /* ÁªÑ‰ª∂Âíå‰∏ãÊñπAppÁöÑÈó¥Ë∑ù */
}

.left-app-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* Â∑¶‰æß‰∏ãÊñπ‰πüÊòØ‰∏§Âàó */
    gap: 15px;
    justify-items: center;
}

/* ÊîØ‰ªòÂÆùÂõæÊ†á‰∏ìÁî®Ê†∑Âºè */
.alipay-icon-bg {
    background-color: #1677ff; /* ÊîØ‰ªòÂÆùËìù */
    display: flex;
    align-items: center;
    justify-content: center;
}
.alipay-icon-bg img {
    width: 80%;
    height: 80%;
    object-fit: contain;
}

/* --- ÊîØ‰ªòÂÆù App ÁïåÈù¢Ê†∑Âºè --- */
#alipay-screen {
    background-color: #f5f5f5;
    display: flex;
    flex-direction: column;
    transition: background-color 0.5s;
}

/* ÈªòËÆ§ËìùËâ≤‰∏ªÈ¢ò */
#alipay-screen {
    --alipay-primary: #1677ff;
    --alipay-text: #ffffff;
    --alipay-card-bg: #1677ff;
    --alipay-bill-bg: #ffffff;
    --alipay-bill-text: #333333;
}

/* ÈªëÈáë‰∏ªÈ¢ò (ÈÄöËøáJSÊ∑ªÂä† class .theme-blackgold) */
#alipay-screen.theme-blackgold {
    --alipay-primary: #1a1a1a;
    --alipay-text: #d4af37; /* ÈáëËâ≤ */
    --alipay-card-bg: linear-gradient(135deg, #2b2b2b, #000000);
    --alipay-bill-bg: #1c1c1e;
    --alipay-bill-text: #e0e0e0;
    background-color: #121212 !important;
}

.alipay-header-area {
    background-color: var(--alipay-primary);
    color: var(--alipay-text);
    padding-bottom: 60px; /* ‰∏∫Âç°ÁâáÁïôÂá∫Á©∫Èó¥ */
    padding-top: calc(50px + env(safe-area-inset-top));
    transition: background-color 0.5s;
}

.alipay-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    font-size: 18px;
}

.alipay-action {
    font-size: 14px;
    cursor: pointer;
}

.alipay-card-container {
    padding: 0 15px;
    margin-top: -50px; /* ‰∏äÊµÆÊïàÊûú */
}

.alipay-balance-card {
    background: var(--alipay-card-bg);
    color: var(--alipay-text);
    border-radius: 12px;
    padding: 25px 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.5s;
}

#alipay-screen.theme-blackgold .alipay-balance-card {
    box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2); /* ÈáëËâ≤ÂÖâÊôï */
    border: 1px solid #333;
}

.balance-label {
    font-size: 13px;
    opacity: 0.8;
}

.balance-amount {
    font-size: 42px;
    font-weight: 700;
    margin: 5px 0 10px 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

.balance-status-tag {
    display: inline-block;
    padding: 2px 8px;
    border: 1px solid currentColor;
    border-radius: 4px;
    font-size: 11px;
    opacity: 0.8;
}

.alipay-bill-container {
    flex-grow: 1;
    background-color: var(--alipay-bill-bg);
    margin-top: 20px;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    color: var(--alipay-bill-text);
}

.bill-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-weight: 600;
    font-size: 16px;
}

/* Ë¥¶ÂçïÂàóË°®È°π */
.bill-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
#alipay-screen.theme-blackgold .bill-item {
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.bill-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.bill-title { font-size: 15px; font-weight: 500; }
.bill-time { font-size: 12px; opacity: 0.6; }

.bill-amount { font-size: 17px; font-weight: 600; }
.bill-amount.income { color: #ff3b30; } /* Êî∂ÂÖ•Á∫¢Ëâ≤ */
.bill-amount.expense { color: #1f1f1f; } /* ÊîØÂá∫ÈªëËâ≤ */

#alipay-screen.theme-blackgold .bill-amount.expense { color: #e0e0e0; }
#alipay-screen.theme-blackgold .bill-amount.income { color: #ff4d4f; }
.kinship-invite-card {
    width: 250px; /* Á®çÂæÆÂä†ÂÆΩ‰∏ÄÁÇπ */
    background-color: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Êõ¥ÊüîÂíåÁöÑÈò¥ÂΩ± */
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    border: none; /* ÂéªÊéâÈªòËÆ§ËæπÊ°Ü */
}

/* Â§¥ÈÉ®ÔºöÊ∏êÂèòËÉåÊôØ + Ë£ÖÈ•∞ */
.kinship-invite-header {
    background: linear-gradient(135deg, #FF6B6B, #EE0979); /* Êõ¥Âä†Áé∞‰ª£ÁöÑÁ∫¢Á≤âÊ∏êÂèò */
    padding: 20px 15px;
    color: white;
    text-align: center;
    position: relative;
    overflow: hidden;
}

/* Â§¥ÈÉ®ËÉåÊôØË£ÖÈ•∞ÂúÜÂúàÔºàÁ∫ØCSSÁîªÁöÑÔºâ */
.kinship-invite-header::before {
    content: '';
    position: absolute;
    top: -20px;
    right: -20px;
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
}
.kinship-invite-header::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: -10px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 50%;
}

.kinship-title {
    font-size: 17px;
    font-weight: 600;
    letter-spacing: 0.5px;
    position: relative;
    z-index: 2;
}

.kinship-subtitle {
    font-size: 12px;
    opacity: 0.9;
    margin-top: 4px;
    position: relative;
    z-index: 2;
}

/* ‰∏ª‰ΩìÂÜÖÂÆπÔºöÈáëÈ¢ùÊòæÁ§∫ */
.kinship-invite-body {
    padding: 25px 15px;
    text-align: center;
    background-color: #fff;
}

.kinship-limit-label {
    font-size: 13px;
    color: #888;
    margin-bottom: 8px;
}

.kinship-limit-amount {
    font-size: 36px;
    font-weight: 700;
    color: #333; /* Êîπ‰∏∫Ê∑±Ëâ≤ÔºåÊõ¥ÊúâÈáëËûçË¥®ÊÑü */
    font-family: "DIN Alternate", "Roboto", sans-serif; /* Â¶ÇÊûúÁ≥ªÁªüÊîØÊåÅÔºåÊï∞Â≠ó‰ºöÊõ¥Â•ΩÁúã */
    line-height: 1;
}

.kinship-limit-amount::first-letter {
    font-size: 20px; /* Ë¥ßÂ∏ÅÁ¨¶Âè∑Á®çÂæÆÂ∞è‰∏ÄÁÇπ */
    margin-right: 2px;
    font-weight: 500;
}

/* Â∫ïÈÉ®Áä∂ÊÄÅÊ†è */
.kinship-status {
    font-size: 12px;
    padding: 12px 15px;
    background: #F9F9F9; /* ÂæàÊµÖÁöÑÁÅ∞Ëâ≤ */
    color: #999;
    text-align: left; /* Â∑¶ÂØπÈΩêÁúãËµ∑Êù•Êõ¥ÂÉèÁ≥ªÁªüÂçïÊçÆ */
    border-top: 1px solid #eee;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Áä∂ÊÄÅÁÇπ (ÂèØÈÄâ) */
.kinship-status::before {
    content: '';
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #ccc;
}

/* ‰∏çÂêåÁä∂ÊÄÅÁöÑÈ¢úËâ≤‰øÆÈ•∞ */
.kinship-status[data-status="pending"]::before { background-color: #ff9800; }
.kinship-status[data-status="accepted"]::before { background-color: #52c41a; }
.kinship-status[data-status="rejected"]::before { background-color: #ff4d4f; }

/* ËÅäÂ§©‰∏≠ÁöÑ‰∫≤Â±ûÂç°Ê∞îÊ≥°ÂéªËÉåÊôØ */
.message-bubble.is-kinship-request .content {
    padding: 0;
    background: transparent !important;
    box-shadow: none;
}
/* --- ÊîØ‰ªòÂÆùÈí±ÂåÖÈ°µÈù¢ÁöÑ‰∫≤Â±ûÂç°ÂàóË°®Ê†∑Âºè (Ë°•Âõû) --- */
.kinship-card-entry {
    background: linear-gradient(135deg, #ff5252, #ff1744);
    border-radius: 12px;
    padding: 15px;
    color: white;
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(255, 23, 68, 0.3);
    cursor: pointer;
}

/* Âè≥‰∏ãËßíÁöÑË£ÖÈ•∞Áà±ÂøÉ */
.kinship-card-entry::after {
    content: '‚ù§Ô∏è';
    position: absolute;
    right: -10px;
    bottom: -20px;
    font-size: 80px;
    opacity: 0.2;
    transform: rotate(-15deg);
}

.kinship-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
    z-index: 2;
}

.kinship-provider {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 600;
}

/* ËøôÈáåÂ∞±ÊòØÊéßÂà∂ÈÇ£Âº†Â§ßÂõæÂèòÂõûÂ∞èÂ§¥ÂÉèÁöÑÂÖ≥ÈîÆ‰ª£Á†Å */
.kinship-provider img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.5);
    object-fit: cover;
}

.kinship-limit {
    font-size: 24px;
    font-weight: bold;
    position: relative;
    z-index: 2;
    font-family: "DIN Alternate", sans-serif;
}

.kinship-label {
    font-size: 12px;
    opacity: 0.8;
    position: relative;
    z-index: 2;
}
/* ÊîØ‰ªòÂÆù‰∫≤Â±ûÂç°Âç°ÁâáÂÜÖÁöÑËß£ÁªëÊåâÈíÆ */
.kinship-card-entry .alipay-unbind-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.2); /* ÂçäÈÄèÊòéÈªëÂ∫ï */
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.5);
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    cursor: pointer;
    z-index: 10; /* ‰øùËØÅÁÇπÂæóÂà∞ */
    transition: background 0.2s;
}

.kinship-card-entry .alipay-unbind-btn:hover {
    background: rgba(0, 0, 0, 0.4);
}
/* --- ÊîØ‰ªòÂÆùÈªëÈáëÊ®°ÂºèÈÄÇÈÖçË°•‰∏Å --- */

/* ÊöÇÊó†‰∫≤Â±ûÂç°ÁöÑÁ©∫Áä∂ÊÄÅÊ†∑Âºè */
.kinship-empty-state {
    text-align: center; 
    padding: 20px; 
    background: white; 
    border-radius: 12px; 
    color: #999; 
    font-size: 13px;
    transition: all 0.3s;
}

/* ÈªëÈáëÊ®°Âºè‰∏ãÁöÑÁ©∫Áä∂ÊÄÅ */
.theme-blackgold .kinship-empty-state {
    background: rgba(255, 255, 255, 0.1) !important; /* ÂçäÈÄèÊòéÊ∑±Ëâ≤ */
    color: #d4af37 !important; /* ÈáëËâ≤ÊñáÂ≠ó */
    border: 1px solid rgba(212, 175, 55, 0.3); /* ÈáëËâ≤ËæπÊ°Ü */
}

/* ÈªëÈáëÊ®°Âºè‰∏ãÁöÑÊ∑ªÂä†ÊåâÈíÆ */
.theme-blackgold #add-kinship-btn {
    color: #d4af37 !important; /* ÊåâÈíÆÂèòÈáë */
}

/* ÈªëÈáëÊ®°Âºè‰∏ãÁöÑÊ†áÈ¢òÊñáÂ≠ó */
.theme-blackgold #alipay-kinship-section span {
    color: #d4af37 !important; /* Ê†áÈ¢òÂèòÈáë */
}
/* --- ÊîØ‰ªòÊî∂Èì∂Âè∞ÂºπÁ™óÁæéÂåñ --- */

/* 1. ÂºπÁ™óÂÜÖÁöÑÊåâÈíÆÂÆπÂô® */
#custom-modal .custom-modal-footer {
    /* ËÆ©ÂàóË°®Êõ¥Á¥ßÂáëÔºåÂéªÊéâÈªòËÆ§ÁöÑÂ±Ö‰∏≠ */
    display: flex;
    flex-direction: column;
    padding: 0;
    max-height: 60vh;
    overflow-y: auto;
}

/* 2. ÊîØ‰ªòÈÄâÈ°πÊåâÈíÆ (ÂéüÊù•ÈÇ£‰∫õËìùËâ≤ÁöÑÂ≠ó) */
.payment-option-item {
    display: flex !important;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 15px 20px !important;
    background-color: #fff !important;
    border: none !important;
    border-bottom: 1px solid #f5f5f5 !important;
    cursor: pointer;
    text-decoration: none !important;
    transition: background-color 0.2s;
    margin: 0 !important;
    height: auto !important;
}

.payment-option-item:active {
    background-color: #f9f9f9 !important;
}

/* ÊúÄÂêé‰∏ÄÈ°πÂéªÊéâËæπÊ°Ü */
.payment-option-item:last-child {
    border-bottom: none !important;
}

/* 3. ÂÜÖÈÉ®ÂÖÉÁ¥†Â∏ÉÂ±Ä */
.pay-opt-left {
    display: flex;
    align-items: center;
    gap: 12px;
    text-align: left;
}

/* ÂõæÊ†áÊ†∑Âºè */
.pay-opt-icon {
    width: 28px;
    height: 28px;
    border-radius: 4px;
}

/* ÊñáÂ≠ó‰ø°ÊÅØ */
.pay-opt-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.pay-opt-title {
    font-size: 16px;
    color: #333;
    font-weight: 500;
}

.pay-opt-desc {
    font-size: 12px;
    color: #999;
}

/* ‰ΩôÈ¢ù‰∏çË∂≥Êó∂ÁöÑÊ†∑Âºè (ÂèØÈÄâ) */
.payment-option-item.disabled {
    opacity: 0.6;
    pointer-events: none;
}

/* ÈÄÇÈÖçÊöóÈªëÊ®°Âºè */
#phone-screen.dark-mode .payment-option-item {
    background-color: #1c1c1e !important;
    border-bottom-color: #2c2c2e !important;
}
#phone-screen.dark-mode .pay-opt-title { color: #fff; }
#phone-screen.dark-mode .pay-opt-desc { color: #666; }
/* --- ÊîØ‰ªòÂÆù‰∫≤Â±ûÂç°Â∏ÉÂ±ÄÁªàÊûÅ‰øÆÂ§ç --- */

/* 1. ÊªöÂä®ÂÆπÂô® */
#alipay-kinship-section {
    display: flex !important;
    flex-direction: row !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    gap: 15px;
    padding: 5px 5px 15px 5px; /* Â¢ûÂä†ÂÜÖËæπË∑ùÔºåÈò≤Ê≠¢Èò¥ÂΩ±Ë¢´Âàá */
    
    /* ÂÖ≥ÈîÆÔºöËÆ©ÂÜÖÂÆπÂú®Âè™Êúâ‰∏ÄÂº†Âç°Êó∂‰πüËÉΩÊíëÂºÄÂÆπÂô® */
    width: 100%; 
    box-sizing: border-box;
    
    /* ÈöêËóèÊªöÂä®Êù° */
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; 
}
#alipay-kinship-section::-webkit-scrollbar {
    display: none; 
}

/* 2. ÂçïÂç°Ê†∑Âºè‰ºòÂåñ */
.kinship-card-entry {
    /* Ê†∏ÂøÉ‰øÆÊîπÔºö‰ΩøÁî® flex-shrink: 0 Èò≤Ê≠¢Ë¢´Êå§Âéã */
    flex-shrink: 0;
    
    /* Ê†∏ÂøÉ‰øÆÊîπÔºöÂÆΩÂ∫¶ÈÄªËæë */
    /* ÈªòËÆ§ÂÆΩÂ∫¶ÔºåÈÄÇÂêàÂ§öÂç°Âπ∂Êéí */
    width: 85vw; 
    max-width: 320px; 
    min-width: 260px;

    margin-bottom: 0 !important;
    
    /* ËßÜËßâÁæéÂåñ */
    box-shadow: 0 4px 15px rgba(255, 23, 68, 0.25);
    border-radius: 16px;
}


/* 1. ‰øÆÂ§ç‰∫≤Â±ûÂç°ÂÆΩÂ∫¶ÈóÆÈ¢ò */
/* ÈÄªËæëÔºöÂ¶ÇÊûúÂàóË°®ÈáåÂè™Êúâ‰∏ÄÂº†Âç°ÔºåÂº∫Âà∂Âç†Êª°ÂÆπÂô®ÂÆΩÂ∫¶ÔºåÂíå‰ΩôÈ¢ùÂç°ÂØπÈΩê */
#alipay-kinship-section:has(.kinship-card-entry:only-child) .kinship-card-entry {
    width: 100% !important;
    max-width: none !important;
    min-width: 0 !important;
    margin-right: 0 !important;
}

/* Á°Æ‰øùÂÆπÂô®Êú¨Ë∫´ÁöÑÂÜÖËæπË∑ù‰∏ç‰ºöÂØºËá¥ÂØπÈΩêÂÅèÂ∑Æ */
#alipay-kinship-section {
    padding-left: 0 !important; /* ÁßªÈô§Â∑¶ËæπË∑ùÔºå‰æùÈù†Áà∂ÂÆπÂô®ÂØπÈΩê */
    padding-right: 0 !important;
}

/* 2. ‰øÆÂ§çÊîØ‰ªòÂÆùÂõæÊ†á‰∏çÈì∫Êª°ÁöÑÈóÆÈ¢ò */
/* ÂéªÊéâÂéüÊú¨ÁªôÊîØ‰ªòÂÆùÁâπÊÑèÁïôÁöÑËæπË∑ùÔºåËÆ©ÂõæÁâáÂº∫Âà∂ÊíëÊª° */
.alipay-icon-bg {
    padding: 0 !important; /* ÂéªÊéâÂÜÖËæπË∑ù */
    display: block !important; /* Á°Æ‰øùÊòØÂùóÁ∫ßÂ∏ÉÂ±Ä */
}

.alipay-icon-bg img {
    width: 100% !important;  /* ÂÆΩÂ∫¶ÊíëÊª° */
    height: 100% !important; /* È´òÂ∫¶ÊíëÊª° */
    object-fit: cover !important; /* Ë£ÅÂâ™‰ª•Èì∫Êª°Ôºå‰∏çÁïôÁôΩËæπ */
    border-radius: inherit !important; /* ÁªßÊâøÁà∂Á∫ßÁöÑÂúÜËßí */
    margin: 0 !important;
}

/* 4. Á©∫Áä∂ÊÄÅ‰ºòÂåñ */
.kinship-empty-state {
    width: 100%;
    flex-shrink: 0;
    padding: 30px 20px;
    background-color: #fff;
    border-radius: 12px;
    text-align: center;
    color: #999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
#alipay-kinship-section:has(.kinship-card-entry:only-child) {
    display: block !important;        /* ÂÖ≥ÈîÆÔºöÂèñÊ∂à Flex */
    overflow: visible !important;     /* ÂÖ≥ÈîÆÔºö‰∏çÈúÄË¶ÅÊªöÂä® */
    white-space: normal !important;
    padding-right: 5px !important;    /* ‰øùÊåÅ‰∏ÄÁÇπÂè≥ËæπË∑ùÁæéËßÇ */
}

/* 2. ÈíàÂØπÂè™Êúâ‰∏ÄÂº†Âç°ÁöÑÊÉÖÂÜµÔºöÂç°ÁâáÊ†∑ÂºèÈáçÁΩÆ */
#alipay-kinship-section:has(.kinship-card-entry:only-child) .kinship-card-entry {
    width: auto !important;           /* ÂÖ≥ÈîÆÔºöËá™Âä®ÂÆΩÂ∫¶ (BlockÂ∏ÉÂ±Ä‰∏ãÁ≠â‰∫éÂç†Êª°) */
    max-width: 100% !important;       /* ÂèåÈáç‰øùÈô©ÔºöÁªù‰∏çË∂ÖËøáÁà∂ÂÆπÂô® */
    min-width: 0 !important;          /* Ê∏ÖÈô§‰πãÂâçËÆæÁΩÆÁöÑ 260px ÊúÄÂ∞èÂÆΩÂ∫¶ */
    margin: 0 !important;             /* Ê∏ÖÈô§ËæπË∑ù */
    flex: none !important;            /* Á¶ÅÁî® flex Â±ûÊÄß */
    transform: none !important;       /* Èò≤Ê≠¢ÂèòÊç¢ÂØºËá¥ÁöÑ‰ΩçÁΩÆÂÅèÁßª */
}

/* 3. Á°Æ‰øùÂ§öÂº†Âç°ÁâáÊó∂ÔºàFlexÂ∏ÉÂ±ÄÔºâ‰æùÁÑ∂Ê≠£Â∏∏ */
#alipay-kinship-section {
    /* ËøôÈáå‰øùÊåÅ‰πãÂâçÁöÑËÆæÁΩÆÔºåÁ°Æ‰øùÂ§öÂº†Âç°Êó∂Ê®™ÂêëÊªöÂä® */
    box-sizing: border-box; 
}

/* 4. ÂÜçÊ¨°Á°Æ‰øùÂõæÊ†áÈì∫Êª° (‰ª•Èò≤Ë¢´Ë¶ÜÁõñ) */
.alipay-icon-bg {
    padding: 0 !important;
    display: block !important;
}
.alipay-icon-bg img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: inherit !important;
    margin: 0 !important;
}
/* --- ÊîØ‰ªòÂÆùË¥¶ÂçïÁ≠õÈÄâ‰∏éÂàÜÈ°µÊ†∑Âºè --- */
.alipay-bill-container {
    padding: 0 !important; /*‰ª•Ê≠§Ë¶ÜÁõñÊóßpaddingÔºåÁî±ÂÜÖÈÉ®ÂÖÉÁ¥†ÊéßÂà∂ */
    background-color: #f5f5f5;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* ÂÆπÂô®Êú¨Ë∫´‰∏çÊªöÂä®ÔºåÂÜÖÈÉ®ÂàóË°®ÊªöÂä® */
}

/* Á≠õÈÄâÊ†èÂ§¥ÈÉ® */
.bill-filter-header {
    background-color: #fff;
    padding: 10px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    flex-shrink: 0;
    z-index: 10;
}

/* Êó•ÊúüÈÄâÊã©Âô®ÁæéÂåñ */
.bill-date-picker-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    background-color: #f5f5f5;
    border-radius: 20px;
    padding: 5px 12px;
}

.bill-date-input {
    border: none;
    background: transparent;
    font-size: 14px;
    color: #333;
    font-weight: 500;
    outline: none;
    width: 110px;
}

/* Á±ªÂûãÂàáÊç¢Ê†áÁ≠æ */
.bill-type-tabs {
    display: flex;
    gap: 15px;
}

.bill-type-tab {
    font-size: 14px;
    color: #666;
    cursor: pointer;
    padding: 4px 0;
    position: relative;
    transition: color 0.2s;
}

.bill-type-tab.active {
    color: #1677ff; /* ÊîØ‰ªòÂÆùËìù */
    font-weight: 600;
}
/* ÈªëÈáëÊ®°Âºè‰∏ãÁöÑÈÄâ‰∏≠ÊÄÅ */
.theme-blackgold .bill-type-tab.active {
    color: #d4af37;
}

.bill-type-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    height: 2px;
    background-color: currentColor;
    border-radius: 2px;
}

/* ÊªöÂä®ÂàóË°®Âå∫Âüü */
#bill-scroll-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0 15px;
    background-color: #fff;
}

/* ÂàóË°®Êúà‰ªΩÂàÜÂâ≤Á∫ø */
.bill-month-separator {
    padding: 15px 0 5px 0;
    font-size: 13px;
    color: #999;
    background-color: #fff;
    position: sticky;
    top: 0;
    z-index: 5;
}

/* Âä†ËΩΩÊõ¥Â§öÊèêÁ§∫ */
.bill-loading-more {
    text-align: center;
    padding: 15px;
    color: #999;
    font-size: 12px;
}
.bill-loading-more.hidden {
    display: none;
}
/* 1. ÂÆπÂô®‰∏éËÉåÊôØÂèòÈªë */
#alipay-screen.theme-blackgold .alipay-bill-container,
#alipay-screen.theme-blackgold .bill-filter-header,
#alipay-screen.theme-blackgold #bill-scroll-list {
    background-color: #121212 !important; /* Ê∑±ÈªëËÉåÊôØ */
    border-color: #333 !important;
}

/* 2. Á≠õÈÄâÊ†èÂ§¥ÈÉ® */
#alipay-screen.theme-blackgold .bill-filter-header {
    border-bottom: 1px solid #2c2c2e;
}

/* 3. Êó•ÊúüÈÄâÊã©Âô®ÁæéÂåñ */
#alipay-screen.theme-blackgold .bill-date-picker-wrapper {
    background-color: #2c2c2e !important; /* ÊØîËÉåÊôØÁ®ç‰∫ÆÁöÑÁÅ∞Ëâ≤ */
    border: 1px solid #444;
}

#alipay-screen.theme-blackgold .bill-date-input {
    color: #d4af37 !important; /* ÈáëËâ≤ÊñáÂ≠ó */
    color-scheme: dark; /* ËÆ©ÊµèËßàÂô®Ëá™Â∏¶ÁöÑÊó•ÊúüÂºπÁ™ó‰πüÂèòÊàêÊ∑±Ëâ≤ */
}

/* 4. Á±ªÂûãÂàáÊç¢Ê†áÁ≠æ */
#alipay-screen.theme-blackgold .bill-type-tab {
    color: #888;
}

#alipay-screen.theme-blackgold .bill-type-tab.active {
    color: #d4af37 !important; /* ÈÄâ‰∏≠Âèò‰∏∫ÈáëËâ≤ */
}

/* 5. ÂàóË°®ÂÜÖÂÆπÈÄÇÈÖç */
#alipay-screen.theme-blackgold .bill-month-separator {
    background-color: #121212 !important; /* ‰∏éËÉåÊôØÂêåËâ≤ */
    color: #d4af37 !important; /* Êúà‰ªΩÊ†áÈ¢òÂèòÈáë */
}

#alipay-screen.theme-blackgold .bill-item {
    border-bottom-color: #2c2c2e !important;
}

/* Ë¥¶ÂçïÊ†áÈ¢ò */
#alipay-screen.theme-blackgold .bill-title {
    color: #e0e0e0 !important; /* ÊµÖÁÅ∞ÂÅèÁôΩ */
}

/* Ë¥¶ÂçïÊó∂Èó¥ */
#alipay-screen.theme-blackgold .bill-time {
    color: #666 !important;
}

/* ÊîØÂá∫ÈáëÈ¢ù (ÂéüÊú¨ÊòØÈªëËâ≤ÔºåÁé∞Âú®ÂèòÁôΩ) */
#alipay-screen.theme-blackgold .bill-amount.expense {
    color: #ffffff !important;
}

/* Êî∂ÂÖ•ÈáëÈ¢ù (ÂéüÊú¨ÊòØÁ∫¢Ëâ≤ÔºåÁé∞Âú®ÂèòÈáëÊàñËÄÖÊ∑°Á∫¢ÔºåËøôÈáåÈÄâÈáëËâ≤ÂëºÂ∫î‰∏ªÈ¢ò) */
#alipay-screen.theme-blackgold .bill-amount.income {
    color: #d4af37 !important; 
}

/* Â∫ïÈÉ®Âä†ËΩΩÊèêÁ§∫ */
#alipay-screen.theme-blackgold .bill-loading-more {
    color: #666 !important;
}

/* Â¶ÇÊûúÂàóË°®‰∏∫Á©∫ÁöÑÊèêÁ§∫ÊñáÂ≠ó */
#alipay-screen.theme-blackgold .bill-empty-msg {
    color: #666 !important;
}
.alipay-bill-container {
    border-radius: 5px 5px 0 0 !important;
}

/* 2. ËÆ©Á≠õÈÄâÊ†èÂ§¥ÈÉ®‰πüÊã•ÊúâÂúÜËßíÔºå‰∏éÂÆπÂô®Ë¥¥Âêà */
.bill-filter-header {
    border-radius: 5px 5px 0 0;
    /* Á®çÂæÆÂ¢ûÂä†‰∏ÄÁÇπÂ∑¶‰æßÂÜÖËæπË∑ùÔºåËÆ©ÊñáÂ≠óÁ¶ªËæπÁºòËøú‰∏ÄÁÇπ */
    padding-left: 20px !important; 
}

/* --- Âü∫ÈáëÁêÜË¥¢Ê®°ÂùóÊ†∑Âºè --- */
.fund-item {
    background-color: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
    transition: transform 0.1s;
}
.fund-item:active {
    transform: scale(0.98);
    background-color: #f9f9f9;
}

.fund-info h4 {
    margin: 0 0 4px 0;
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.fund-tags {
    display: flex;
    gap: 5px;
}

.fund-tag {
    font-size: 10px;
    padding: 1px 4px;
    border-radius: 3px;
    background-color: #f0f2f5;
    color: #666;
}
.fund-tag.high-risk {
    background-color: #fff1f0;
    color: #ff4d4f;
}

.fund-data {
    text-align: right;
}

.fund-change {
    font-size: 18px;
    font-weight: 600;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

/* Á∫¢Ê∂®ÁªøË∑å */
.fund-up { color: #ff3b30; }
.fund-down { color: #4cd964; }
.fund-flat { color: #999; }

.fund-nav {
    font-size: 12px;
    color: #999;
    margin-top: 2px;
}

/* ÈªëÈáëÊ®°ÂºèÈÄÇÈÖç */
#alipay-screen.theme-blackgold .alipay-grid-menu .alipay-menu-item {
    background-color: #1c1c1e;
    color: #e0e0e0;
    box-shadow: none;
    border: 1px solid #333;
}
#alipay-screen.theme-blackgold #fund-market-trend-preview {
    color: #d4af37 !important;
}
/* --- ÊîØ‰ªòÂÆùÂ∏ÉÂ±Ä‰øÆÂ§çÔºöÁ°Æ‰øùË¥¶Âçï‰∏çË¢´Êå§Âéã --- */
#alipay-screen {
    display: flex;
    flex-direction: column;
    height: 100%; /* Âº∫Âà∂Âç†Êª°Â±èÂπï */
    overflow: hidden; /* Á¶ÅÊ≠¢Êï¥‰∏™Â±èÂπïÊªöÂä®ÔºåÂè™ËÆ©ÂÜÖÈÉ®Âå∫ÂüüÊªöÂä® */
}

/* Â§¥ÈÉ®Âå∫Âüü (ÂåÖÂê´ËìùËâ≤ËÉåÊôØ„ÄÅ‰ΩôÈ¢ù„ÄÅ‰∫≤Â±ûÂç°„ÄÅÂü∫ÈáëÂÖ•Âè£) */
.alipay-header-area {
    flex-shrink: 0; /* Á¶ÅÊ≠¢Â§¥ÈÉ®Ë¢´ÂéãÁº© */
    background-color: var(--alipay-primary);
    /* Ê≥®ÊÑèÔºöËøôÈáåÂéªÊéâ‰∫Ü padding-bottomÔºåÁî±ÂÜÖÂÆπÊíëÂºÄ */
    padding-bottom: 20px; 
    transition: background-color 0.5s;
}

/* Âç°ÁâáÂÆπÂô® */
.alipay-card-container {
    margin-top: 0; /* Ë∞ÉÊï¥Èó¥Ë∑ù */
    padding: 0 15px;
}

/* --- Âü∫ÈáëÂÖ•Âè£Ê†∑Âºè‰ºòÂåñ (Êõ¥Á¥ßÂáë) --- */
.alipay-grid-menu {
    padding: 0 15px;
    margin-top: 10px;     /* ‰∏é‰∏äÊñπÂç°Áâá‰øùÊåÅË∑ùÁ¶ª */
    margin-bottom: 10px;  /* ‰∏é‰∏ãÊñπË¥¶Âçï‰øùÊåÅË∑ùÁ¶ª */
}

.alipay-menu-item {
    background: white;
    padding: 12px 15px;   /* ÂáèÂ∞èÂÜÖËæπË∑ùÔºåÊõ¥ÊâÅÂπ≥ */
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid transparent; /* È¢ÑÁïôËæπÊ°Ü‰Ωç */
}

.alipay-menu-item:active {
    transform: scale(0.98);
}

.menu-icon {
    width: 36px;
    height: 36px;
    background: #FFF5E5;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.menu-info {
    flex-grow: 1;
}

.menu-title {
    font-weight: 600;
    font-size: 15px;
    color: #333;
}

.menu-trend {
    font-size: 11px;
    color: #ff3b30;
    margin-top: 2px;
}

.menu-arrow {
    color: #ccc;
    font-size: 18px;
    font-weight: 300;
}

/* --- Ë¥¶ÂçïÂÆπÂô®Ëá™ÈÄÇÂ∫î (ÂÖ≥ÈîÆÔºÅ) --- */
.alipay-bill-container {
    flex-grow: 1;  /* Âç†ÊçÆÂâ©‰ΩôÊâÄÊúâÁ©∫Èó¥ */
    min-height: 0; /* ÂÖÅËÆ∏ Flex Â≠êÂÖÉÁ¥†Êî∂Áº©ÔºåÈò≤Ê≠¢Ê∫¢Âá∫ */
    margin-top: 0; /* Á¥ßË¥¥‰∏äÊñπ */
    background-color: var(--alipay-bill-bg);
    border-radius: 20px 20px 0 0;
    padding: 0;    /* ÂÜÖÈÉ®ÂÖÉÁ¥†Â§ÑÁêÜ padding */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* ÂÆπÂô®Êú¨Ë∫´‰∏çÊªö */
    box-shadow: 0 -5px 15px rgba(0,0,0,0.05); /* Â¢ûÂä†È°∂ÈÉ®Èò¥ÂΩ±Ôºå‰∫ßÁîüÂ±ÇÊ¨°ÊÑü */
}

/* Ë¥¶ÂçïÂàóË°®ÊªöÂä®Âå∫Âüü */
#bill-scroll-list {
    flex-grow: 1;
    overflow-y: auto; /* Âè™ÊúâËøôÈáåÊªöÂä® */
    padding: 0 15px 20px 15px;
    -webkit-overflow-scrolling: touch;
}


/* --- ÊîØ‰ªòÂÆùÂ∏ÉÂ±Ä‰øÆÂ§çÔºöÁ°Æ‰øùË¥¶Âçï‰∏çË¢´Êå§Âéã --- */
#alipay-screen {
    display: flex;
    flex-direction: column;
    height: 100%; /* Âº∫Âà∂Âç†Êª°Â±èÂπï */
    overflow: hidden; /* Á¶ÅÊ≠¢Êï¥‰∏™Â±èÂπïÊªöÂä®ÔºåÂè™ËÆ©ÂÜÖÈÉ®Âå∫ÂüüÊªöÂä® */
}

/* Â§¥ÈÉ®Âå∫Âüü (ÂåÖÂê´ËìùËâ≤ËÉåÊôØ„ÄÅ‰ΩôÈ¢ù„ÄÅ‰∫≤Â±ûÂç°„ÄÅÂü∫ÈáëÂÖ•Âè£) */
.alipay-header-area {
    flex-shrink: 0; /* Á¶ÅÊ≠¢Â§¥ÈÉ®Ë¢´ÂéãÁº© */
    background-color: var(--alipay-primary);
    /* Ê≥®ÊÑèÔºöËøôÈáåÂéªÊéâ‰∫Ü padding-bottomÔºåÁî±ÂÜÖÂÆπÊíëÂºÄ */
    padding-bottom: 20px; 
    transition: background-color 0.5s;
}

/* Âç°ÁâáÂÆπÂô® */
.alipay-card-container {
    margin-top: 0; /* Ë∞ÉÊï¥Èó¥Ë∑ù */
    padding: 0 15px;
}

/* --- Âü∫ÈáëÂÖ•Âè£Ê†∑Âºè‰ºòÂåñ (Êõ¥Á¥ßÂáë) --- */
.alipay-grid-menu {
    padding: 0 15px;
    margin-top: 10px;     /* ‰∏é‰∏äÊñπÂç°Áâá‰øùÊåÅË∑ùÁ¶ª */
    margin-bottom: 10px;  /* ‰∏é‰∏ãÊñπË¥¶Âçï‰øùÊåÅË∑ùÁ¶ª */
}

.alipay-menu-item {
    background: white;
    padding: 12px 15px;   /* ÂáèÂ∞èÂÜÖËæπË∑ùÔºåÊõ¥ÊâÅÂπ≥ */
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid transparent; /* È¢ÑÁïôËæπÊ°Ü‰Ωç */
}

.alipay-menu-item:active {
    transform: scale(0.98);
}

.menu-icon {
    width: 36px;
    height: 36px;
    background: #FFF5E5;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.menu-info {
    flex-grow: 1;
}

.menu-title {
    font-weight: 600;
    font-size: 15px;
    color: #333;
}

.menu-trend {
    font-size: 11px;
    color: #ff3b30;
    margin-top: 2px;
}

.menu-arrow {
    color: #ccc;
    font-size: 18px;
    font-weight: 300;
}

/* --- Ë¥¶ÂçïÂÆπÂô®Ëá™ÈÄÇÂ∫î (ÂÖ≥ÈîÆÔºÅ) --- */
.alipay-bill-container {
    flex-grow: 1;  /* Âç†ÊçÆÂâ©‰ΩôÊâÄÊúâÁ©∫Èó¥ */
    min-height: 0; /* ÂÖÅËÆ∏ Flex Â≠êÂÖÉÁ¥†Êî∂Áº©ÔºåÈò≤Ê≠¢Ê∫¢Âá∫ */
    margin-top: 0; /* Á¥ßË¥¥‰∏äÊñπ */
    background-color: var(--alipay-bill-bg);
    border-radius: 20px 20px 0 0;
    padding: 0;    /* ÂÜÖÈÉ®ÂÖÉÁ¥†Â§ÑÁêÜ padding */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* ÂÆπÂô®Êú¨Ë∫´‰∏çÊªö */
    box-shadow: 0 -5px 15px rgba(0,0,0,0.05); /* Â¢ûÂä†È°∂ÈÉ®Èò¥ÂΩ±Ôºå‰∫ßÁîüÂ±ÇÊ¨°ÊÑü */
}

/* Ë¥¶ÂçïÂàóË°®ÊªöÂä®Âå∫Âüü */
#bill-scroll-list {
    flex-grow: 1;
    overflow-y: auto; /* Âè™ÊúâËøôÈáåÊªöÂä® */
    padding: 0 15px 20px 15px;
    -webkit-overflow-scrolling: touch;
}



/* 1. Âü∫ÈáëÂÖ•Âè£ÈªëÈáëÂåñ */
#alipay-screen.theme-blackgold .alipay-menu-item {
    background-color: #1c1c1e; /* Ê∑±Ëâ≤ËÉåÊôØ */
    border: 1px solid #333;    /* ÂæÆÂº±ËæπÊ°Ü */
    box-shadow: none;
}

#alipay-screen.theme-blackgold .menu-icon {
    background-color: #2c2c2e; /* ÂõæÊ†áËÉåÊôØÂèòÊ∑± */
    border: 1px solid #444;
}

#alipay-screen.theme-blackgold .menu-title {
    color: #e0e0e0; /* Ê†áÈ¢òÂèòÁôΩ/ÁÅ∞ */
}

#alipay-screen.theme-blackgold .menu-trend {
    color: #d4af37 !important; /* Ê∂®Ë∑åÂπÖÂèòÈáëËâ≤ */
}

#alipay-screen.theme-blackgold .menu-arrow {
    color: #666;
}

/* 2. Ë¥¶ÂçïÂå∫ÂüüÈªëÈáëÂåñÂÆåÂñÑ */
#alipay-screen.theme-blackgold .alipay-bill-container {
    background-color: #000000; /* Ë¥¶ÂçïËÉåÊôØÂÖ®Èªë */
    border-top: 1px solid #222;
}

#alipay-screen.theme-blackgold #bill-scroll-list {
    background-color: #000000;
}

/* --- Âü∫ÈáëÈ°µÈù¢‰∏ªÈ¢òÈÄÇÈÖç --- */

/* 1. ÈªòËÆ§ËìùËâ≤‰∏ªÈ¢ò */
.fund-header-area {
    background-color: #1677ff;
    color: white;
    border-bottom: none;
}

.fund-asset-card {
    background-color: #1677ff;
    color: white;
    padding: 10px 20px 40px 20px; /* Â¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ù */
    margin-bottom: -20px; /* ËÆ©‰∏ãÊñπÂàóË°®‰∏äÊµÆË¶ÜÁõñ */
    transition: background-color 0.5s;
}

/* 2. ÈªëÈáëÊ®°ÂºèÈÄÇÈÖç (ÂΩì fund-screen Êã•Êúâ .theme-blackgold Á±ªÊó∂) */
#fund-screen.theme-blackgold {
    background-color: #121212 !important;
}

#fund-screen.theme-blackgold .fund-header-area {
    background-color: #1a1a1a; /* Â§¥ÈÉ®ÂèòÊ∑±Èªë */
    color: #d4af37; /* ÈáëËâ≤ÊñáÂ≠ó */
}

#fund-screen.theme-blackgold .fund-asset-card {
    background: linear-gradient(180deg, #1a1a1a 0%, #000000 100%); /* ÈªëÈáëÊ∏êÂèò */
    color: #d4af37;
}

#fund-screen.theme-blackgold .list-container {
    background-color: #121212 !important; /* ÂàóË°®ËÉåÊôØÂèòÈªë */
}

#fund-screen.theme-blackgold .frame-tabs {
    background-color: #1c1c1e !important;
    box-shadow: none;
    border: 1px solid #333;
}

#fund-screen.theme-blackgold .frame-tab {
    color: #888;
}
#fund-screen.theme-blackgold .frame-tab.active {
    background-color: #333 !important;
    color: #d4af37 !important;
}

#fund-screen.theme-blackgold .fund-item {
    background-color: #1c1c1e;
    border: 1px solid #2c2c2e;
    color: #e0e0e0;
}

#fund-screen.theme-blackgold .fund-info h4 {
    color: #e0e0e0;
}
/* --- ‰∫≤Â±ûÂç°Ê†áÈ¢òÈÄÇÈÖç --- */
.kinship-section-title {
    color: #333; /* ÈªòËÆ§Ê®°ÂºèÔºöÊ∑±ÁÅ∞Ëâ≤ */
    transition: color 0.3s;
}

/* ÈªëÈáëÊ®°Âºè‰∏ãÔºåÊ†áÈ¢òÂèòÈáë */
#alipay-screen.theme-blackgold .kinship-section-title {
    color: #d4af37 !important;
}

/* ÈªëÈáëÊ®°Âºè‰∏ãÔºåÊ∑ªÂä†ÊåâÈíÆ‰πüÂèòÈáë */
#alipay-screen.theme-blackgold #add-kinship-btn {
    color: #d4af37 !important;
}


/* ============================================================ */
/* ‚ñº‚ñº‚ñº ÁªàÊûÅ‰øÆÂ§çÔºöÊ∂àÊÅØÈïøÊåâËèúÂçï (ËøòÂéü‰πùÂÆ´Ê†º + Ëá™Âä®Â°´Êª°) ‚ñº‚ñº‚ñº */
/* ============================================================ */

/* 1. ÂÆπÂô®Â∏ÉÂ±ÄÔºöÊ®™ÂêëÊéíÂàóÔºåÂÖÅËÆ∏Êç¢Ë°åÔºåÊåâÈíÆ‰πãÈó¥ÊúâÈó¥Èöô */
#message-actions-modal .custom-modal-footer {
    display: flex !important;
    flex-direction: row !important; /* Âº∫Âà∂Ê®™Âêë */
    flex-wrap: wrap !important;     /* ÂÖÅËÆ∏Êç¢Ë°å */
    justify-content: space-between !important;
    padding: 10px !important;
    gap: 10px !important;           /* ÊåâÈíÆÈó¥Ë∑ù */
    background-color: transparent !important;
    max-height: none !important;
    overflow: visible !important;
}

/* 2. ÂäüËÉΩÊåâÈíÆÔºöÁÅ∞Ëâ≤ÊñπÂùóÔºåËá™Âä®Â°´Êª° */
#message-actions-modal .custom-modal-footer button:not(#cancel-message-action-btn) {
    /* Âü∫Á°ÄÂÆΩÂ∫¶ÔºöÁ∫¶‰∏ÄÂçäÂáèÂéªÈó¥Èöô */
    width: 48% !important;
    /* „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÔºöÂÖÅËÆ∏ÊåâÈíÆËá™Âä®Êãâ‰º∏ÔºÅËøôÊ†∑Â¶ÇÊûúÊòØÂ•áÊï∞‰∏™ÔºåÊúÄÂêé‰∏Ä‰∏™‰ºöËá™Âä®Âç†Êª°‰∏ÄË°å */
    flex-grow: 1 !important; 
    
    /* „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÔºöÁßªÈô§ display: ... !importantÔºåËÆ© JS ÁöÑÈöêËóèÈÄªËæëÁîüÊïà */
    display: flex; 
    align-items: center;
    justify-content: center;
    
    margin: 0 !important;
    padding: 15px 0 !important; /* ‰øùÊåÅÈ´òÂ∫¶ */
    
    /* Â§ñËßÇÔºöÊµÖÁÅ∞Ëâ≤ÂúÜËßí */
    background-color: #f2f2f7 !important; 
    color: #007aff !important;
    border-radius: 10px !important;
    border: none !important;
    font-size: 16px !important;
    font-weight: 500 !important;
    
    /* Ê∏ÖÈô§Âπ≤Êâ∞ */
    border-bottom: none !important;
}

/* 3. Âº∫Âà∂ÈöêËóèË¢´ JS ËÆæÁΩÆ‰∏∫ÈöêËóèÁöÑÊåâÈíÆ (Ëß£ÂÜ≥ÂçïËÅäÊòæÁ§∫Áæ§ËÅäÊåâÈíÆÁöÑÈóÆÈ¢ò) */
#message-actions-modal .custom-modal-footer button[style*="display: none"] {
    display: none !important;
}

/* 4. ÂèñÊ∂àÊåâÈíÆÔºöÊ†∑ÂºèÂÆåÂÖ®Áªü‰∏ÄÔºàÁÅ∞Ëâ≤ËÉåÊôØ„ÄÅÊ≠£Â∏∏Â≠ó‰ΩìÔºâ */
#message-actions-modal #cancel-message-action-btn {
    width: 100% !important;
    flex-grow: 0 !important;
    margin-top: 5px !important;
    padding: 15px 0 !important;
    
    /* „Äê‰øÆÊîπ„ÄëËÉåÊôØËâ≤Êîπ‰∏∫ÂíåÂÖ∂‰ªñÊåâÈíÆ‰∏ÄÊ†∑ÁöÑÊµÖÁÅ∞ */
    background-color: #f2f2f7 !important; 
    
    color: #007aff !important;
    
    /* „Äê‰øÆÊîπ„ÄëÂ≠ó‰ΩìÁ≤óÁªÜÊîπ‰∏∫Ê≠£Â∏∏Ôºå‰∏çÂÜçÂä†Á≤ó */
    font-weight: 500 !important; 
    
    border-radius: 10px !important;
    border: none !important;
    box-shadow: none !important; /* ÂéªÊéâÈò¥ÂΩ± */
}

/* 5. ÈªëÈáë/Â§úÈó¥Ê®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #message-actions-modal .custom-modal-footer button:not(#cancel-message-action-btn),
#phone-screen.dark-mode #message-actions-modal #cancel-message-action-btn {
    background-color: #2c2c2e !important; /* Áªü‰∏ÄÊ∑±ÁÅ∞Âùó */
    color: #0a84ff !important;
}
/* ========================================= */
/* ‚ñº‚ñº‚ñº ÊîØ‰ªòÂÆù UI ÁæéÂåñÁâà (Modern Fintech) ‚ñº‚ñº‚ñº */
/* ========================================= */

/* 1. Â±èÂπïÊï¥‰ΩìÂÆπÂô® */
#alipay-screen {
    /* ÂÆö‰πâÂèòÈáèÔºöÈªòËÆ§Ë¥¢ÂØåËìù‰∏ªÈ¢ò */
    --alipay-header-bg: linear-gradient(180deg, #1677ff 0%, #0a5ad3 100%);
    --alipay-bg-color: #f5f7fa; /* Êõ¥ÊüîÂíåÁöÑÊµÖÁÅ∞Â∫ïËâ≤ */
    --alipay-card-bg: #ffffff;
    --alipay-text-primary: #1f1f1f;
    --alipay-text-secondary: #8a8a8a;
    --alipay-money-font: -apple-system, BlinkMacSystemFont, "DIN Alternate", "Roboto", sans-serif;
    
    background-color: var(--alipay-bg-color);
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
}

/* 2. Â§¥ÈÉ®Âå∫Âüü (ÂåÖÂê´ÂØºËà™Ê†èÂíåËìùËâ≤ËÉåÊôØÂ±Ç) */
.alipay-header-area {
    background: var(--alipay-header-bg);
    color: white;
    padding-top: calc(10px + env(safe-area-inset-top));
    padding-bottom: 60px; /* ÁïôÂá∫Á©∫Èó¥ÁªôÂç°Áâá‰∏äÊµÆ */
    border-radius: 0 0 20px 20px; /* Â∫ïÈÉ®ÂæÆÂúÜËßí */
    flex-shrink: 0;
    position: relative;
    z-index: 1;
}

/* ÂØºËà™Ê†è */
.alipay-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    height: 44px;
    font-size: 17px;
    font-weight: 500;
}

.alipay-nav .back-btn {
    font-size: 24px;
    font-weight: 300;
    cursor: pointer;
    width: 30px;
    opacity: 0.9;
}

.alipay-action {
    font-size: 15px;
    opacity: 0.9;
    cursor: pointer;
    padding: 4px 10px;
    background: rgba(255,255,255,0.15);
    border-radius: 15px;
    backdrop-filter: blur(5px);
    transition: background 0.2s;
}
.alipay-action:active {
    background: rgba(255,255,255,0.3);
}

/* 3. Âç°ÁâáÂÆπÂô® (Ë¥üË¥£‰∏äÊµÆÂ∏ÉÂ±Ä) */
.alipay-card-container {
    flex-grow: 1;
    overflow-y: auto; /* ËÆ©Âç°ÁâáÂíå‰∏ãÊñπÂÜÖÂÆπÊï¥‰ΩìÊªöÂä® */
    padding: 0 12px;
    margin-top: -50px; /* Ê†∏ÂøÉÔºöÂç°Áâá‰∏äÊµÆË¶ÜÁõñËìùËâ≤ËÉåÊôØ */
    position: relative;
    z-index: 2;
    /* ÈöêËóèÊªöÂä®Êù° */
    -webkit-overflow-scrolling: touch;
}
.alipay-card-container::-webkit-scrollbar { display: none; }

/* 4. ÊÄªËµÑ‰∫ßÂç°Áâá (Ê∑±Ëâ≤Ë¥®ÊÑüÂç°Áâá) */
.alipay-balance-card {
    background: linear-gradient(180deg, #1677ff 0%, #0a5ad3 100%);
    color: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 20px rgba(22, 119, 255, 0.2);
    position: relative;
    overflow: hidden;
    margin-bottom: 12px;
}

/* Âç°ÁâáÂÜÖÈÉ®Ë£ÖÈ•∞ÂÖâÁ∫π */
.alipay-balance-card::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
    pointer-events: none;
}

.balance-label {
    font-size: 13px;
    opacity: 0.7;
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.balance-amount {
    font-family: var(--alipay-money-font);
    font-size: 38px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.balance-status-tag {
    font-size: 11px;
    padding: 2px 8px;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 4px;
    color: rgba(255,255,255,0.9);
    backdrop-filter: blur(4px);
}

/* 5. ÂäüËÉΩËèúÂçïÁΩëÊ†º (Funds, etc.) */
.alipay-grid-menu {
    display: grid;
    grid-template-columns: 1fr; /* ‰øùÊåÅÂçïË°åÔºå‰πüÂèØ‰ª•ÊîπÊàê 1fr 1fr */
    gap: 10px;
    margin-bottom: 12px;
}

.alipay-menu-item {
    background: var(--alipay-card-bg);
    padding: 16px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    cursor: pointer;
    transition: transform 0.1s;
}
.alipay-menu-item:active {
    transform: scale(0.98);
}

.menu-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: #eff4ff; /* ÊµÖËìùÂ∫ï */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.menu-info {
    flex-grow: 1;
}

.menu-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--alipay-text-primary);
    margin-bottom: 2px;
}

.menu-trend {
    font-size: 12px;
    color: #ff3b30; /* Á∫¢Ê∂® */
    font-family: var(--alipay-money-font);
    font-weight: 500;
}

.menu-arrow {
    color: #ccc;
    font-size: 16px;
}

/* 6. ‰∫≤Â±ûÂç°Âå∫Âüü */
#alipay-kinship-section-wrapper {
    margin-bottom: 15px;
}
.kinship-section-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--alipay-text-primary);
    margin-left: 5px;
}

/* ‰∫≤Â±ûÂç°ÂÆπÂô® */
#alipay-kinship-section {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding: 10px 5px 15px 5px; /* ÁïôÂá∫Èò¥ÂΩ±Á©∫Èó¥ */
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}
#alipay-kinship-section::-webkit-scrollbar { display: none; }

/* ‰∫≤Â±ûÂç°ÂçïÂç° */
.kinship-card-entry {
    flex-shrink: 0;
    width: 85%; /* Á®çÂæÆÈú≤Âá∫‰∏ã‰∏ÄÂº† */
    max-width: 300px;
    background: linear-gradient(135deg, #ff5252, #e00f38);
    border-radius: 12px;
    padding: 16px;
    color: white;
    position: relative;
    box-shadow: 0 4px 12px rgba(255, 82, 82, 0.3);
    overflow: hidden;
}

.kinship-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}
.kinship-provider {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    background: rgba(0,0,0,0.1);
    padding: 4px 10px 4px 4px;
    border-radius: 20px;
}
.kinship-provider img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.6);
}
.kinship-limit {
    font-family: var(--alipay-money-font);
    font-size: 26px;
    font-weight: 700;
}
.kinship-label {
    font-size: 11px;
    opacity: 0.8;
    margin-bottom: 2px;
}

/* 7. Ë¥¶ÂçïÂå∫Âüü */
.alipay-bill-container {
    background-color: var(--alipay-card-bg);
    border-radius: 16px;
    padding: 0;
    overflow: hidden; /* ÂÜÖÈÉ®ÊªöÂä® */
    box-shadow: 0 2px 15px rgba(0,0,0,0.04);
    margin-bottom: 20px; /* Â∫ïÈÉ®ÁïôÁôΩ */
    min-height: 300px;
}

/* Ë¥¶ÂçïÁ≠õÈÄâÂ§¥ */
.bill-filter-header {
    padding: 15px;
    background: var(--alipay-card-bg);
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Ë¥¶ÂçïÂàóË°® */
#bill-scroll-list {
    max-height: 500px; /* Áªô‰∏™ÊúÄÂ§ßÈ´òÂ∫¶ÔºåÈò≤Ê≠¢ÊíëÁ†¥È°µÈù¢ */
    overflow-y: auto;
}

.bill-month-separator {
    background-color: #f9f9f9;
    padding: 8px 15px;
    font-size: 12px;
    color: #999;
    font-weight: 500;
    position: sticky;
    top: 0;
}

.bill-item {
    padding: 16px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f7f7f7;
}
.bill-item:last-child { border-bottom: none; }

.bill-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.bill-title {
    font-size: 15px;
    color: var(--alipay-text-primary);
    font-weight: 500;
}
.bill-time {
    font-size: 12px;
    color: #ccc;
}
.bill-amount {
    font-family: var(--alipay-money-font);
    font-size: 17px;
    font-weight: 600;
}
.bill-amount.income { color: #ff3b30; }
.bill-amount.expense { color: var(--alipay-text-primary); }


/* 8. ÈªëÈáë‰∏ªÈ¢òÈÄÇÈÖç (Black Gold Theme) */
#alipay-screen.theme-blackgold {
    --alipay-header-bg: #1a1a1a; /* Á∫ØÈªëÂ§¥ÈÉ® */
    --alipay-bg-color: #121212;
    --alipay-card-bg: #1c1c1e;
    --alipay-text-primary: #e5e5e5;
    --alipay-text-secondary: #888;
}

#alipay-screen.theme-blackgold .alipay-balance-card {
    background: linear-gradient(135deg, #2a2a2a, #000);
    border: 1px solid #333;
    color: #d4af37; /* ÈáëËâ≤ */
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
}
#alipay-screen.theme-blackgold .balance-label,
#alipay-screen.theme-blackgold .balance-status-tag {
    color: rgba(212, 175, 55, 0.8);
    border-color: rgba(212, 175, 55, 0.3);
}

#alipay-screen.theme-blackgold .menu-icon {
    background: #2c2c2e;
    color: #d4af37;
}
#alipay-screen.theme-blackgold .menu-trend {
    color: #d4af37; /* ‰πüÊòØÈáëËâ≤ */
}

#alipay-screen.theme-blackgold .bill-filter-header {
    border-bottom-color: #333;
}
#alipay-screen.theme-blackgold .bill-month-separator {
    background-color: #121212;
    color: #666;
}
#alipay-screen.theme-blackgold .bill-item {
    border-bottom-color: #333;
}
#alipay-screen.theme-blackgold .bill-amount.expense {
    color: #fff;
}
#alipay-screen.theme-blackgold .bill-amount.income {
    color: #d4af37;
}
#alipay-screen.theme-blackgold .kinship-section-title {
    color: #d4af37;
}
#alipay-screen.theme-blackgold #add-kinship-btn {
    color: #d4af37 !important;
}
/* ========================================= */
/* ‚ñº‚ñº‚ñº ËµõÂçöÈªëÂ∏ÇÊãçÂçñË°å 2.0 (UI ÈáçÊûÑ) ‚ñº‚ñº‚ñº */
/* ========================================= */

/* 1. ÂÖ®Â±èËÉåÊôØÔºöÊ∑±ÈÇÉÁöÑÁΩëÊ†ºËÉåÊôØ */
#auction-screen {
    background-color: #050505 !important;
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 30px 30px;
    color: #e0e0e0;
    font-family: 'Courier New', Courier, monospace; /* ÁªàÁ´ØÂ≠ó‰ΩìÊÑü */
}

/* 2. Â§¥ÈÉ®ÔºöÈúìËôπËæπÊ°Ü */
#auction-screen .header {
    background-color: rgba(20, 20, 20, 0.9) !important;
    border-bottom: 1px solid #333;
    box-shadow: 0 0 15px rgba(0, 255, 242, 0.1);
}
#auction-screen .header span {
    color: #00f3ff !important;
    text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
    font-weight: 800;
    letter-spacing: 1px;
}

/* 3. ÊãçÂìÅÂ±ïÁ§∫Âå∫ÔºöÂÖ®ÊÅØÊäïÂΩ±ÊÑü */
#auction-main-display {
    height: auto !important;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: radial-gradient(circle at center, #1a1a2e 0%, #000000 80%);
}

#auction-item-image-container {
    border: 2px solid #00f3ff !important;
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.2), inset 0 0 20px rgba(0, 243, 255, 0.1) !important;
    border-radius: 4px !important; /* Á°¨ÊúóÁöÑËßí */
    position: relative;
}
/* Êâ´ÊèèÁ∫øÂä®Áîª */
#auction-item-image-container::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 255, 0.1) 51%, transparent 52%);
    background-size: 100% 10px;
    animation: scanline 5s linear infinite;
    pointer-events: none;
}
@keyframes scanline { 0% {background-position: 0 0;} 100% {background-position: 0 100%;} }

#auction-item-name {
    font-family: -apple-system, sans-serif;
    font-weight: 900;
    font-size: 24px !important;
    color: #fff !important;
    text-shadow: 2px 2px 0px #ff0055; /* ÊïÖÈöúÈ£éÈò¥ÂΩ± */
    margin-top: 15px !important;
}

#auction-item-desc {
    color: #00f3ff !important;
    opacity: 0.8;
    border: 1px dashed #00f3ff;
    padding: 8px;
    background: rgba(0, 243, 255, 0.05);
    margin-top: 10px !important;
    max-width: 90%;
}

/* 4. Á´û‰ª∑Èù¢ÊùøÔºöÊéßÂà∂Âè∞È£éÊ†º */
#auction-screen > div:last-child { /* ÊåáÂêëÂ∫ïÈÉ®ÁöÑÁôΩËâ≤Èù¢Êùø */
    background-color: #111 !important;
    border-top: 2px solid #ff0055; /* ÊíûËâ≤ËæπÊ°Ü */
    border-radius: 0 !important; /* ÊñπÊ≠£ */
    box-shadow: 0 -5px 30px rgba(255, 0, 85, 0.15) !important;
}

/* ÂΩìÂâç‰ª∑Ê†ºÂ§ßÂ≠ó */
#auction-current-price {
    color: #ff0055 !important;
    text-shadow: 0 0 10px rgba(255, 0, 85, 0.5);
    font-family: 'DIN Alternate', sans-serif; /* Êï∞Â≠óÂ≠ó‰Ωì */
}

/* ÂÄíËÆ°Êó∂ */
#auction-timer {
    color: #f0ad4e !important; /* Ë≠¶ÂëäÈªÑ */
    font-family: monospace;
}

/* 5. ÊªöÂä®Êó•ÂøóÔºöÁªàÁ´ØÊï∞ÊçÆÊµÅ */
#auction-log {
    background: #000;
    border: 1px solid #333;
    font-family: monospace;
    padding: 5px;
    margin-bottom: 15px;
}
#auction-log div {
    border-bottom: none !important;
    padding: 2px 5px !important;
    font-size: 12px;
}
#auction-log .bid-me { color: #00ff00 !important; text-shadow: 0 0 5px #00ff00; } /* ÊàëÂá∫‰ª∑ÁªøËâ≤È´ò‰∫Æ */
#auction-log .bid-friend { color: #00f3ff !important; }
#auction-log .bid-npc { color: #666 !important; }

/* 6. ÊåâÈíÆÁªÑÔºöÊú∫Ê¢∞ÊÑü */
#auction-controls {
    gap: 8px !important;
}
#auction-controls button {
    border-radius: 2px !important; /* ÊñπÂΩ¢ÊåâÈíÆ */
    text-transform: uppercase;
    font-weight: 800 !important;
    letter-spacing: 1px;
    transition: all 0.1s;
}

/* Âä†‰ª∑ÊåâÈíÆ */
#auction-controls .form-button-secondary {
    background: #222 !important;
    border: 1px solid #444 !important;
    color: #ccc !important;
}
#auction-controls .form-button-secondary:active {
    background: #fff !important;
    color: #000 !important;
}

/* Ê†∏ÂøÉÂá∫‰ª∑ÊåâÈíÆ */
#auction-controls .form-button {
    background: #ff0055 !important; /* ÈúìËôπÁ∫¢ */
    color: #fff !important;
    box-shadow: 0 0 15px rgba(255, 0, 85, 0.4);
    border: none !important;
}
#auction-controls .form-button:active {
    transform: scale(0.95);
    box-shadow: 0 0 5px rgba(255, 0, 85, 0.8);
}
#auction-log .bid-friend { 
    color: #ff00ff !important; /* ‰∫ÆÁ≤âËâ≤ */
    font-weight: 900 !important;
    font-size: 14px !important;
    border-left: 3px solid #ff00ff; /* Â∑¶‰æßÂä†‰∏™Á≤âÊù° */
    padding-left: 8px !important;
    background: rgba(255, 0, 255, 0.1); /* ÂæÆÂº±ËÉåÊôØ */
    text-shadow: 0 0 5px #ff00ff; /* ÈúìËôπÂÖâÊôï */
}
/* 1. Â§¥ÈÉ®Ôºö‰∏çÂÜçÊ†πÊçÆÊâãÊú∫ÂàòÊµ∑Ëá™Âä®ÂèòÈ´òÔºåÂº∫Âà∂Âõ∫ÂÆö */
.alipay-header-area {
    /* Ê†∏ÂøÉÔºöÁõ¥Êé•ÂÜôÊ≠ªÊï∞Â≠óÔºå‰∏ç‰ΩøÁî® env() ÂèòÈáè */
    padding-top: 25px !important; 
    
    /* ‰øùÊåÅ‰∏ãÊñπÁïôÁôΩÁªôÂç°Áâá‰∏äÊµÆ */
    padding-bottom: 50px !important; 
    
    /* Ê∏ÖÈô§ÊâÄÊúâË¥üËæπË∑ùÂπ≤Êâ∞ÔºåÂõûÂΩíÊ†áÂáÜ‰ΩçÁΩÆ */
    margin-top: 0 !important; 
}

/* 2. ÂØºËà™Ê†èÔºöÂæÆË∞É‰ΩçÁΩÆÔºåÁ°Æ‰øùÊñáÂ≠óÂûÇÁõ¥Â±Ö‰∏≠ */
.alipay-nav {
    /* ‰∏çÈúÄË¶ÅË¥üËæπË∑ù‰∫ÜÔºåÂõ†‰∏∫Â§¥ÈÉ® padding Â∑≤ÁªèÂõ∫ÂÆö */
    transform: none !important; 
    padding-top: 5px !important;
}

/* 3. Âç°ÁâáÂÆπÂô®ÔºöÊ†áÂáÜÁöÑ‰∏äÊµÆË∑ùÁ¶ª */
.alipay-card-container {
    /* ËÆ©Âç°ÁâáÂæÄ‰∏äÁõñ‰ΩèËìùËâ≤ËÉåÊôØ 40px */
    margin-top: -40px !important; 
    position: relative;
    z-index: 5;
}

/* 4. Ë¥¶ÂçïÂàóË°®ÔºöÊ†πÊçÆ‰Ω†ÁöÑÂñúÂ•ΩÔºåÁ¥ßË¥¥‰∫≤Â±ûÂç° */
.alipay-bill-container {
    /* ËøôÈáå‰øùÁïô‰Ω†‰πãÂâçÂñúÊ¨¢ÁöÑÁ¥ßÂáëÊÑü */
    margin-top: -50px !important; 
    
    /* Ê†∏ÂøÉÔºöÂéªÊéâÊâãÊú∫Â∫ïÈÉ®ÁöÑÂÆâÂÖ®Âå∫ÁïôÁôΩÔºåÂº∫Âà∂Áªü‰∏Ä */
    padding-bottom: 20px !important; 
    margin-bottom: 0 !important;
    border-radius: 16px 16px 0 0 !important;
}

/* 5. ‰øÆÊ≠£‰∫≤Â±ûÂç°ÁöÑÈ´òÂ∫¶Èò≤Ê≠¢Ë¢´ÂéãÊâÅ */
#alipay-kinship-section {
    margin-bottom: 0 !important;
    padding-bottom: 10px !important;
    min-height: auto !important;
}
/* 1. Âº∫Âà∂ËÉåÊôØÈÄèÊòéÔºåÂéªÊéâÈò¥ÂΩ± */
.icon-bg-desktop.transparent-mode {
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
}

/* 2. ËÆ©ÂÜÖÈÉ®ÂõæÁâáÊíëÊª°ÔºåÂπ∂‰∏çÂº∫Âà∂ÂúÜËßíÔºà‰øùÊåÅPNGÂéüÂΩ¢Ôºâ */
.icon-bg-desktop.transparent-mode img {
    width: 100% !important;
    height: 100% !important;
    border-radius: 0 !important; /* ‰∏çÂàáÂúÜËßíÔºå‰øùÊåÅÂõæÁâáÂéüÊ†∑ */
    object-fit: contain !important; /* ‰øùÊåÅÊØî‰æãÔºå‰∏çÊãâ‰º∏ */
    transform: scale(1.1); /*Á®çÂæÆÊîæÂ§ß‰∏ÄÁÇπÁÇπËßÜËßâË°•ÂÅøÔºåÂõ†‰∏∫Ê≤°ÊúâËÉåÊôØÊ°Ü‰∫Ü */
}
/* --- È°µÈù¢Â∏ÉÂ±ÄË∞ÉÊï¥ --- */

/* 1. ÂÆö‰πâÂè≥‰æßÂàóÁöÑÂ†ÜÂè†ÊñπÂºè (ÂûÇÁõ¥ÊéíÂàó) */
.right-column-stack {
    display: flex;
    flex-direction: column;
    gap: 15px; /* ‰∏ä‰∏ãÁªÑ‰ª∂ÁöÑÈó¥Ë∑ù */
    min-width: 0; /* Èò≤Ê≠¢Ë¢´Êå§Âéã */
}

/* --- ÈªëËÉ∂Âî±ÁâáÊú∫ÁªÑ‰ª∂Ê†∑Âºè --- */

/* 2. ÁªÑ‰ª∂Âç°ÁâáÂ§ñÊ°Ü */
.vinyl-widget-card {
    width: 155px !important;  /* Âº∫Âà∂Âõ∫ÂÆöÂÆΩÂ∫¶ÔºåÂíåÂ∑¶‰æßÂ§ßÁªÑ‰ª∂‰∏ÄËá¥ */
    height: 155px !important; /* Âº∫Âà∂Âõ∫ÂÆöÈ´òÂ∫¶Ôºå‰øùÊåÅÊ≠£ÊñπÂΩ¢ */
    background-color: white;
    border-radius: 20px;
    padding: 15px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    flex-shrink: 0; /* Èò≤Ê≠¢Ë¢´Êå§Âéã */
}

/* 3. È°∂ÈÉ®ÂºÄÂÖ≥Ë£ÖÈ•∞ */
.vinyl-header {
    height: 20px;
    display: flex;
    align-items: center;
}
.vinyl-switch {
    width: 46px;
    height: 20px;
    position: relative;
}
.switch-track {
    background-color: #f0f0f0;
    border-radius: 10px;
    width: 100%;
    height: 100%;
    font-size: 10px;
    color: #ccc;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 6px;
    box-sizing: border-box;
    font-weight: bold;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.switch-circle {
    width: 16px;
    height: 16px;
    background-color: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* 4. ‰∏≠Èó¥ÈÉ®ÂàÜÂ∏ÉÂ±Ä */
.vinyl-body {
    flex-grow: 1;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* 5. ÈªëËÉ∂Âî±ÁâáÁ∫πÁêÜ */
.vinyl-disc-bg {
    width: 100px; /* Âî±ÁâáÂ§ßÂ∞è */
    height: 100px;
    border-radius: 50%;
    background: repeating-radial-gradient(
      #111 0, 
      #111 2px, 
      #222 3px, 
      #222 4px
    ); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 1;
    border: 4px solid #f5f5f5; /* ÁôΩËâ≤Â§ñÂúà */
}

/* 6. ‰∏≠Èó¥ÂèØÊç¢ÂõæÁâá (ÂúÜÂΩ¢Â∞ÅÈù¢) */
.vinyl-cover {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #111;
    cursor: pointer;
    transition: opacity 0.2s;
}
.vinyl-cover:active {
    opacity: 0.7;
}

/* 7. Âî±ÈíàË£ÖÈ•∞ */
.vinyl-arm-wrapper {
    position: absolute;
    right: -10px;
    top: -10px;
    width: 50px;
    height: 120px;
    z-index: 2;
    pointer-events: none;
    filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.1));
    transform: rotate(0deg); /* ÂèØË∞ÉÊï¥ËßíÂ∫¶ */
}

/* 8. Â∫ïÈÉ®ÊñáÂ≠ó */
.vinyl-footer {
    text-align: center;
    font-size: 12px;
    color: #666;
    font-weight: 500;
    margin-top: 5px;
}

/* --- ÈÄÇÈÖçÊöóÈªëÊ®°Âºè --- */
#phone-screen.dark-mode .vinyl-widget-card {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode .vinyl-disc-bg {
    border-color: #3a3a3c;
}
#phone-screen.dark-mode .vinyl-footer {
    color: #aaa;
}
#phone-screen.dark-mode .switch-track {
    background-color: #3a3a3c;
    color: #666;
}


/* --- ÈÄèÊòéÈªëËÉ∂Âî±ÁâáÊú∫Ê†∑Âºè --- */

/* 1. ÈÄèÊòéÂÆπÂô®ÔºöÂéªÊéâÁôΩËâ≤ËÉåÊôØÂíåÈò¥ÂΩ±ÔºåÂè™ÂÅöÂÆö‰Ωç */
.vinyl-transparent-widget {
    width: 155px !important; /* ‰øùÊåÅÂíåÂÖ∂‰ªñÁªÑ‰ª∂‰∏ÄÊ†∑Â§ß */
    height: 155px !important;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    /* ÂÖ≥ÈîÆÔºöËÉåÊôØÈÄèÊòéÔºåÊó†ËæπÊ°ÜÔºåÊó†Èò¥ÂΩ± */
    background-color: transparent !important;
    border: none !important;
    box-shadow: none !important;
    flex-shrink: 0;
}

/* 2. ÈªëËÉ∂Âî±ÁâáÁ∫πÁêÜ */
.vinyl-disc-bg {
    width: 135px; /* Á®çÂæÆË∞ÉÂ§ß‰∏ÄÁÇπ */
    height: 135px;
    border-radius: 50%;
    background: repeating-radial-gradient(
      #111 0, 
      #111 2px, 
      #222 3px, 
      #222 4px
    ); 
    /* Âä†Âº∫Èò¥ÂΩ±ÔºåËÆ©ÂÆÉÊúâÊµÆËµ∑Êù•ÁöÑÊÑüËßâ */
    box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    z-index: 1;
    border: 3px solid #f5f5f5;
}

/* 3. ‰∏≠Èó¥ÂèØÊç¢ÂõæÁâá */
.vinyl-cover {
    width: 75px;
    height: 75px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #111;
    cursor: pointer;
    transition: opacity 0.2s;
}
.vinyl-cover:active {
    opacity: 0.7;
}

/* 4. Âî±ÈíàË£ÖÈ•∞ (Ë∞ÉÊï¥‰ΩçÁΩÆ‰ª•ÈÄÇÂ∫îÊó†ËæπÊ°Ü) */
.vinyl-arm-wrapper {
    position: absolute;
    right: 0px; 
    top: 0px;   
    width: 50px;
    height: 120px;
    z-index: 2;
    pointer-events: none;
    filter: drop-shadow(3px 6px 8px rgba(0,0,0,0.3)); /* Âä†Âº∫Èò¥ÂΩ± */
}

/* --- ÁßªÈô§ÂéüÊù•ÁöÑÊöóÈªëÊ®°ÂºèÈÄÇÈÖç (Âõ†‰∏∫Áé∞Âú®ÊòØÈÄèÊòéÁöÑ‰∫Ü) --- */
/* Âè™‰øùÁïôÂî±ÁâáÂ§ñÂúàÈ¢úËâ≤ÁöÑÈÄÇÈÖç */
#phone-screen.dark-mode .vinyl-disc-bg {
    border-color: #3a3a3c;
}

.left-column-stack {
    display: flex;
    flex-direction: column;
    gap: 30px; /* <--- ÊääËøôÈáåÁöÑ 15px ÊîπÂ§ßÔºåÊØîÂ¶Ç 30px */
}

/* --- 1. Âè≥‰æßÂàóÂÆπÂô®Â∏ÉÂ±Ä --- */
.right-column-stack {
    display: flex;
    flex-direction: column;
    gap: 30px; /* ‰∏ä‰∏ãÈó¥Ë∑ù */
    min-width: 0;
    
    /* „ÄêÂÖ≥ÈîÆ„ÄëËÆ©ÂÜÖÈÉ®ÂÖÉÁ¥†Èù†Âè≥ÂØπÈΩê (Ë¥¥ËøëÂ±èÂπïÂè≥‰æß) */
    /* Â¶ÇÊûúÊÇ®ÂñúÊ¨¢Èù†Â∑¶Ë¥¥ÁùÄ‰∏≠Èó¥ÁºùÈöôÔºåÊîπÊàê flex-start */
    align-items: flex-end; 
}

/* --- 2. Âè≥‰æß 4‰∏™APP ÁöÑÁΩëÊ†ºÂ∏ÉÂ±Ä --- */
.app-subgrid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px; /* ÂõæÊ†áÈó¥Ë∑ù */
    
    /* „ÄêÂÖ≥ÈîÆ„ÄëÂº∫Âà∂Âõ∫ÂÆöÂÆΩÂ∫¶Ôºå‰∏éÂ∑¶‰æßÂ§ßÁªÑ‰ª∂/Âî±ÁâáÊú∫‰∏ÄËá¥ */
    width: 155px !important; 
    
    /* ËÆ©ÂõæÊ†áÂú®Ê†ºÂ≠êÈáåÂ±Ö‰∏≠ */
    justify-items: center;
}

/* --- 3. ÂÜçÊ¨°Á°Æ‰øùÈÄèÊòéÂî±ÁâáÊú∫‰πüÊòØÂõ∫ÂÆöÂ§ßÂ∞è --- */
.vinyl-transparent-widget {
    width: 155px !important;
    height: 155px !important;
    /* ...ÂÖ∂‰ªñÊ†∑Âºè‰øùÊåÅ‰∏çÂèò... */
}
/* ÂêàÊàêÈü≥‰πêÂç°ÁâáÊ†∑Âºè */
.message-bubble.is-music-synth .content {
    padding: 0 !important;
    background: transparent !important;
}

.synth-music-card {
    background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%); /* Ê∏ÖÊñ∞ÁöÑÊ∏êÂèòËâ≤ */
    border-radius: 12px;
    padding: 12px 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    width: 220px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.5);
}

#phone-screen.dark-mode .synth-music-card {
    background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
    border-color: #444;
}

.synth-icon {
    font-size: 24px;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
}

.synth-info {
    flex-grow: 1;
    overflow: hidden;
}

.synth-title {
    font-weight: 600;
    font-size: 15px;
    color: #333;
    margin-bottom: 2px;
}

#phone-screen.dark-mode .synth-title {
    color: #fff;
}

.synth-reason {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#phone-screen.dark-mode .synth-reason {
    color: #ddd;
}

.synth-play-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background-color: rgba(255,255,255,0.6);
    color: #007bff;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.synth-play-btn:active {
    transform: scale(0.9);
}

.synth-play-btn.playing {
    background-color: #007bff;
    color: white;
    animation: pulse-play 1s infinite;
}

@keyframes pulse-play {
    0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(0, 123, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
}
/* --- ‰øÆÂ§çÈªëÂ∏ÇÂ§¥ÈÉ®Â∏ÉÂ±ÄÈîôËØØ --- */

/* 1. Ëß£Èô§ÊåâÈíÆÂÆΩÂ∫¶ÈôêÂà∂ÔºåËÆ©ÊñáÂ≠óÊ®™ÂêëÊòæÁ§∫ */
#auction-screen .header .action-btn {
    width: auto !important;      /* ÂèñÊ∂àÂõ∫ÂÆö30px */
    min-width: 30px;
    padding: 4px 12px !important; /* Â¢ûÂä†ÂÜÖËæπË∑ù */
    font-size: 14px !important;
    white-space: nowrap;         /* Âº∫Âà∂‰∏çÊç¢Ë°å */
}

/* 2. Á°Æ‰øùÂè≥‰∏äËßíÊåâÈíÆÁªÑÊ®™ÂêëÊéíÂàó */
#auction-screen .header .header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    z-index: 20; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±ÇÔºåÂèØÁÇπÂáª */
}

/* 3. ‰ªìÂ∫ìÂºπÁ™óÁöÑÊ†∑Âºè */
.inventory-item {
    display: flex;
    gap: 12px;
    background-color: #252525;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
    border: 1px solid #333;
    position: relative;
}

.inventory-img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #444;
    background-color: #000;
}

.inventory-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.inventory-name {
    font-size: 16px;
    font-weight: bold;
    color: #d4af37;
    margin-bottom: 4px;
}

.inventory-desc {
    font-size: 12px;
    color: #999;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
}

.inventory-price {
    font-size: 12px;
    color: #555;
    margin-top: 4px;
    font-family: monospace;
}

.inventory-use-btn {
    position: absolute;
    right: 10px;
    bottom: 10px;
    background: linear-gradient(135deg, #d4af37, #f2d06b);
    color: #000;
    border: none;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
}
/* --- To-Do List Ê†∑Âºè --- */

/* Êó•ÊúüÂØºËà™Ê†è */
.todo-date-navigator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background-color: #fff;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}
.todo-date-navigator button {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--accent-color);
    cursor: pointer;
    padding: 0 10px;
}
#todo-current-date-display {
    font-size: 17px;
    font-weight: 600;
    color: var(--text-primary);
}

/* ‰ªªÂä°Âç°Áâá */
.todo-item {
    background-color: #fff;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    display: flex;
    align-items: flex-start; /* ÂØπÈΩêÈ°∂ÈÉ®ÔºåÈÄÇÂ∫îÂ§öË°åÊñáÊú¨ */
    gap: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}
.todo-item.completed {
    opacity: 0.6;
    background-color: #f9f9f9;
}

/* Â§çÈÄâÊ°ÜÊ†∑Âºè */
.todo-checkbox {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #c7c7cc;
    flex-shrink: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    margin-top: 2px; /* ÂæÆË∞ÉÂØπÈΩê */
}
.todo-item.completed .todo-checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}
.todo-item.completed .todo-checkbox::after {
    content: '‚úî';
    color: white;
    font-size: 14px;
}

/* ‰ªªÂä°ÂÜÖÂÆπ */
.todo-info {
    flex-grow: 1;
    min-width: 0;
}
.todo-content {
    font-size: 16px;
    color: var(--text-primary);
    margin-bottom: 6px;
    line-height: 1.4;
    word-break: break-word;
}
.todo-item.completed .todo-content {
    text-decoration: line-through;
    color: var(--text-secondary);
}
.todo-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

/* Ê†áÁ≠æ Tag */
.todo-tag {
    padding: 2px 8px;
    border-radius: 6px;
    color: white;
    font-weight: 500;
    font-size: 11px;
    background-color: var(--tag-color, #8e8e93);
}

/* Êó∂Èó¥ÊòæÁ§∫ */
.todo-time {
    color: #ff3b30; /* Á∫¢Ëâ≤Âº∫Ë∞ÉÊó∂Èó¥ */
    font-weight: 500;
}
.todo-item.completed .todo-time {
    color: var(--text-secondary);
}

/* Âà†Èô§ÊåâÈíÆ */
.todo-delete-btn {
    padding: 5px 10px;
    color: #ff3b30;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    margin-left: 5px;
}

/* Á©∫Áä∂ÊÄÅ */
.todo-empty-state {
    text-align: center;
    color: var(--text-secondary);
    margin-top: 50px;
}

/* --- Á±ªÂûãÈÄâÊã©Âô®Ê†∑Âºè --- */
.todo-type-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.todo-type-option {
    padding: 6px 12px;
    border-radius: 15px;
    border: 1px solid #e5e5ea;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    background-color: #fff;
    transition: all 0.2s;
}
.todo-type-option.active {
    background-color: var(--tag-color);
    color: white;
    border-color: var(--tag-color);
}

/* --- ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç --- */
#phone-screen.dark-mode #todo-list-screen {
    background-color: #000 !important;
}
#phone-screen.dark-mode .todo-date-navigator {
    background-color: #1c1c1e;
    border-bottom-color: #38383a;
}
#phone-screen.dark-mode .todo-item {
    background-color: #1c1c1e;
}
#phone-screen.dark-mode .todo-item.completed {
    background-color: #121212;
}
#phone-screen.dark-mode .todo-type-option {
    background-color: #2c2c2e;
    border-color: #38383a;
    color: #fff;
}
/* --- ÂæÖÂäû‰∫ãÈ°πÔºöÂ∑¶Âè≥ÂàÜÊ†èÂ∏ÉÂ±Ä (Chat Style) --- */

/* 1. AI ÂàõÂª∫ÁöÑ (ÈªòËÆ§Èù†Â∑¶) - ‰øùÊåÅÂéüÊ†∑ÔºåÂæÆË∞ÉÈó¥Ë∑ù */
.todo-item.is-char {
    flex-direction: row; /* ÈªòËÆ§ÊñπÂêëÔºöÂ§öÈÄâÊ°Ü -> ÂÜÖÂÆπ -> Âà†Èô§ */
}

/* 2. Áî®Êà∑ÂàõÂª∫ÁöÑ (Èù†Âè≥) - ‰ΩøÁî® row-reverse ÁøªËΩ¨Â∏ÉÂ±Ä */
.todo-item.is-user {
    flex-direction: row-reverse; /* ÁøªËΩ¨ÊñπÂêëÔºöÂà†Èô§ -> ÂÜÖÂÆπ -> Â§öÈÄâÊ°Ü */
    background-color: #e7f3ff;   /* ÂèØÈÄâÔºöÁªôÁî®Êà∑ÂèëÁöÑÊ∞îÊ≥°Âä†‰∏ÄÁÇπÊ∑°Ê∑°ÁöÑËìùËâ≤ËÉåÊôØÔºåÂå∫ÂàÜÊõ¥ÊòéÊòæ */
}

/* 3. Áî®Êà∑ÂÜÖÂÆπÁöÑÊñáÂ≠óÂØπÈΩê */
.todo-item.is-user .todo-info {
    text-align: right;       /* ÊñáÂ≠óÈù†Âè≥ */
    align-items: flex-end;   /* Â¶ÇÊûúÂÜÖÈÉ®ÊòØ flexÔºåÂàôÈù†Âè≥ÂØπÈΩê */
}

/* 4. Ê†áÁ≠æÂíåÊó∂Èó¥ÁöÑÂØπÈΩê */
.todo-item.is-user .todo-meta {
    justify-content: flex-end; /* Ê†áÁ≠æÂíåÊó∂Èó¥Èù†Âè≥ÊéíÂàó */
}

/* 5. Èó¥Ë∑ù‰øÆÊ≠£ (Âõ†‰∏∫ÁøªËΩ¨‰∫ÜÔºåmarginÊñπÂêë‰πüË¶ÅÂèçËøáÊù•) */
.todo-item.is-user .todo-checkbox {
    margin-right: 0;
    margin-left: 12px; /* Checkbox Âú®ÊúÄÂè≥ËæπÔºåÁªôÂ∑¶ËæπÁïôÁ©∫Èöô */
}

.todo-item.is-user .todo-delete-btn {
    margin-left: 0;
    margin-right: 5px; /* Âà†Èô§ÊåâÈíÆÂú®ÊúÄÂ∑¶ËæπÔºåÁªôÂè≥ËæπÁïôÁ©∫Èöô */
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .todo-item.is-user {
    background-color: #1a2a3a; /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÊ∑±ËìùËâ≤ËÉåÊôØ */
}
#todo-current-date-display {
    cursor: pointer;       /* Èº†Ê†áÊÇ¨ÂÅúÂèòÂ∞èÊâã */
    user-select: none;     /* Èò≤Ê≠¢ÂèåÂáªÈÄâ‰∏≠ÊñáÂ≠ó */
    transition: opacity 0.2s;
    padding: 5px 10px;     /* Â¢ûÂä†‰∏ÄÁÇπÁÇπÂáªÂå∫Âüü */
    border-radius: 8px;
}

#todo-current-date-display:active {
    background-color: rgba(0, 0, 0, 0.05); /* ÁÇπÂáªÊó∂ÁöÑÈ´ò‰∫ÆÂèçÈ¶à */
    opacity: 0.6;
}
/* --- Green River (ÁªøÊ±ü) ÊûÅÁÆÄÈ´òÁ´ØÈ£éÊ†º --- */
:root {
    --gr-primary: #1B4F3E;       /* Ê∑±Â¢®Áªø */
    --gr-accent: #2E7D32;        /* Âº∫Ë∞ÉÁªø */
    --gr-bg: #FAFAF9;            /* ÊöñÁôΩ/Ë±°ÁâôÁôΩ */
    --gr-surface: #FFFFFF;       /* Á∫ØÁôΩÂç°Áâá */
    --gr-text-main: #1C1C1E;     /* Ê∑±Èªë */
    --gr-text-sub: #8E8E93;      /* ‰∏≠ÁÅ∞ */
    --gr-border: #E5E5E5;        /* ÊûÅÁªÜËæπÊ°Ü */
    --gr-shadow: 0 4px 20px rgba(0,0,0,0.03);
}

/* ÂÖ®Â±Ä‰∏ªÈ¢ò */
.gr-theme {
    background-color: var(--gr-bg) !important;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--gr-text-main);
}

/* Â§¥ÈÉ®Ê†∑Âºè - ÊûÅËá¥ÁÆÄÁ∫¶ */
.gr-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 24px;
    padding-top: calc(15px + env(safe-area-inset-top));
    background-color: rgba(250, 250, 249, 0.95); /* Á£®Á†ÇËÉåÊôØ */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 1px solid transparent; /* ÈªòËÆ§Êó†ËæπÊ°Ü */
}

.gr-title {
    font-family: "Georgia", serif; /* Ë°¨Á∫ø‰ΩìÂ¢ûÂä†ÊñáÂ≠¶ÊÑü */
    font-size: 20px;
    font-weight: 600;
    color: var(--gr-primary);
    letter-spacing: 0.5px;
}

.gr-icon-btn {
    background: none;
    border: none;
    color: var(--gr-text-main);
    padding: 8px;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}
.gr-icon-btn:hover {
    opacity: 1;
    background-color: rgba(0,0,0,0.03);
}

/* ÂÜÖÂÆπÂå∫Âüü */
.gr-content-area {
    padding: 24px;
    overflow-y: auto;
    flex-grow: 1;
}

/* Ê†áÈ¢ò‰∏éÂàÜÂâ≤ */
.gr-section-header {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}
.gr-section-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gr-text-sub);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* ‰π¶Á±çÂàóË°® (Grid) */
.gr-grid-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 20px;
}

/* ‰π¶Á±çÂç°Áâá */
.gr-book-card {
    background: var(--gr-surface);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--gr-shadow);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid var(--gr-border);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 120px;
}
.gr-book-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.06);
    border-color: var(--gr-primary);
}

.gr-book-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--gr-text-main);
    margin-bottom: 8px;
    line-height: 1.4;
}
.gr-book-meta {
    font-size: 12px;
    color: var(--gr-text-sub);
    display: flex;
    align-items: center;
    gap: 5px;
}

/* ‰ΩúËÄÖÂàóË°®È°π */
.gr-author-item {
    background: var(--gr-surface);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--gr-shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--gr-border);
}
.gr-author-info h3 {
    margin: 0 0 4px 0;
    font-size: 16px;
    color: var(--gr-text-main);
}
.gr-author-info p {
    margin: 0;
    font-size: 13px;
    color: var(--gr-text-sub);
    max-width: 250px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ÈòÖËØªÂô®Ê≠£Êñá */
.gr-reader-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 30px 24px 100px 24px; /* Â∫ïÈÉ®ÁïôÁôΩÁªôËæìÂÖ•Ê°Ü */
    font-family: "Georgia", "Songti SC", serif; /* Ë°¨Á∫ø‰ΩìÈÄÇÂêàÈòÖËØª */
    font-size: 17px;
    line-height: 1.8;
    color: #333;
}

.gr-chapter {
    margin-bottom: 40px;
}
.gr-chapter-text {
    white-space: pre-wrap;
    margin-bottom: 15px;
}

/* ÊëòË¶ÅÊäòÂè†Âùó */
.gr-summary-box {
    background-color: #F4F4F5;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 20px;
    font-family: sans-serif;
}
.gr-summary-box summary {
    cursor: pointer;
    font-size: 13px;
    color: var(--gr-text-sub);
    font-weight: 500;
    list-style: none; /* ÈöêËóèÈªòËÆ§‰∏âËßí */
    display: flex;
    align-items: center;
    gap: 6px;
}
.gr-summary-box summary::before {
    content: '‚ñ∏'; 
    display: inline-block;
    transition: transform 0.2s;
}
.gr-summary-box[open] summary::before {
    transform: rotate(90deg);
}
.gr-summary-content {
    font-size: 14px;
    color: #666;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #E5E5E5;
    line-height: 1.6;
}

/* Â∫ïÈÉ®ÊéßÂà∂Ê†è */
.gr-control-panel {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    padding: 16px 24px;
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
    border-top: 1px solid var(--gr-border);
    box-sizing: border-box;
}

.gr-input-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.gr-input {
    flex-grow: 1;
    background: #F4F4F5;
    border: 1px solid transparent;
    border-radius: 20px;
    padding: 12px 16px;
    font-size: 15px;
    outline: none;
    transition: all 0.2s;
}
.gr-input:focus {
    background: #FFF;
    border-color: var(--gr-primary);
    box-shadow: 0 0 0 3px rgba(27, 79, 62, 0.1);
}

.gr-main-btn {
    background-color: var(--gr-primary);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: transform 0.1s, opacity 0.2s;
    flex-shrink: 0;
}
.gr-main-btn:active {
    transform: scale(0.96);
}
.gr-main-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* ÂºπÁ™óÂÜÖË°®ÂçïÂÖÉÁ¥† */
.gr-form-group {
    margin-bottom: 20px;
}
.gr-form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--gr-text-main);
    margin-bottom: 8px;
}
.gr-select {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 15px;
    outline: none;
}
.gr-checkbox-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #fff;
    padding: 5px;
}
.gr-checkbox-item {
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    border-radius: 6px;
}
.gr-checkbox-item:hover {
    background-color: #F5F5F7;
}
.gr-checkbox-item input {
    accent-color: var(--gr-primary);
    width: 16px;
    height: 16px;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .gr-theme,
#phone-screen.dark-mode .gr-header,
#phone-screen.dark-mode .gr-control-panel,
#phone-screen.dark-mode .gr-book-card,
#phone-screen.dark-mode .gr-author-item,
#phone-screen.dark-mode .modal-content {
    background-color: #1C1C1E !important;
    color: #FFFFFF;
}
#phone-screen.dark-mode .gr-title,
#phone-screen.dark-mode .gr-section-title,
#phone-screen.dark-mode .gr-book-title,
#phone-screen.dark-mode .gr-author-info h3,
#phone-screen.dark-mode .gr-form-group label {
    color: #FFFFFF;
}
#phone-screen.dark-mode .gr-reader-content {
    color: #E0E0E0;
}
#phone-screen.dark-mode .gr-summary-box {
    background-color: #2C2C2E;
}
#phone-screen.dark-mode .gr-summary-content {
    color: #AAAAAA;
    border-top-color: #38383A;
}
#phone-screen.dark-mode .gr-input,
#phone-screen.dark-mode .gr-select,
#phone-screen.dark-mode .gr-checkbox-list {
    background-color: #2C2C2E;
    border-color: #38383A;
    color: #FFFFFF;
}
#phone-screen.dark-mode .gr-icon-btn {
    color: #FFFFFF;
}
#phone-screen.dark-mode .gr-book-card:hover {
    border-color: #2E7D32; /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÁªøËâ≤È´ò‰∫Æ */
}
/* ÁªøÊ±üÔºöÊëòË¶ÅÁºñËæëÊ°ÜÊ†∑Âºè */
.gr-summary-input {
    width: 100%;
    background-color: transparent;
    border: 1px dashed transparent; /* ÈªòËÆ§Êó†ËæπÊ°Ü */
    font-family: inherit;
    font-size: 13px;
    color: #333;
    resize: vertical;
    padding: 5px;
    box-sizing: border-box;
    transition: all 0.2s;
    min-height: 60px;
}

/* ÂΩìÂÆÉÊòØÂèØÁºñËæëÁä∂ÊÄÅÔºàÊúÄÂêé‰∏ÄÁ´†ÔºâÊó∂ */
.gr-summary-box.editable {
    background-color: #fffbe6; /* Ê∑°ÈªÑËâ≤ËÉåÊôØÔºåÊèêÁ§∫ËøôÊòØÂ≠òÊ°£Âå∫ */
    border: 1px solid #e0e0e0;
}

.gr-summary-box.editable .gr-summary-input {
    border-color: #ddd; /* ÊòæÁ§∫ËôöÁ∫øÊ°Ü */
    background-color: rgba(255, 255, 255, 0.5);
}

.gr-summary-box.editable .gr-summary-input:focus {
    background-color: #fff;
    border-color: var(--gr-primary);
    outline: none;
}

.gr-mini-btn {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    border: 1px solid var(--gr-primary);
    background-color: var(--gr-primary);
    color: white;
    cursor: pointer;
}
/* --- ÁªøÊ±üÈòÖËØªÂô®Êñ∞Ê†∑Âºè (Jinjiang Style) --- */

/* 1. ‰æßËæπÊ†è (Drawer) */
#gr-sidebar-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(2px);
    z-index: 90;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}
#gr-sidebar-overlay.visible {
    opacity: 1;
    visibility: visible;
}

#gr-chapter-sidebar {
    position: absolute;
    top: 0;
    left: 0;
    width: 75%; /* ‰æßËæπÊ†èÂÆΩÂ∫¶ */
    height: 100%;
    background: var(--gr-bg);
    z-index: 100;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 2px 0 15px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}
#gr-chapter-sidebar.visible {
    transform: translateX(0);
}

.gr-sidebar-header {
    padding: 20px;
    padding-top: calc(20px + env(safe-area-inset-top));
    border-bottom: 1px solid var(--gr-border);
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#gr-chapter-list-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px 0;
}

.gr-sidebar-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    transition: background 0.2s;
}
.gr-sidebar-item:hover {
    background-color: rgba(0,0,0,0.02);
}
.gr-sidebar-item.active {
    color: var(--gr-primary);
    font-weight: 600;
    background-color: rgba(27, 79, 62, 0.05);
}
.gr-sidebar-item span {
    margin-left: 10px;
}

/* 2. Â∫ïÈÉ®ÊéßÂà∂Ê†èË∞ÉÊï¥ */
.gr-control-panel {
    display: flex;
    flex-direction: column;
    gap: 10px;
    /* Á°Æ‰øùÂõ∫ÂÆöÂú®Â∫ïÈÉ® */
    position: absolute;
    bottom: 0;
}

.gr-text-btn {
    background: transparent;
    border: none;
    color: var(--gr-primary);
    font-size: 14px;
    font-weight: 600;
    padding: 10px 20px;
    cursor: pointer;
}
.gr-text-btn:disabled {
    color: #ccc;
    cursor: default;
}

/* 3. Ê≠£ÊñáÂå∫ÂüüÂæÆË∞É */
.gr-reader-content {
    padding-bottom: 120px; /* ÁªôÂ∫ïÈÉ®Ê†èÁïôÂá∫Ë∂≥Â§üÁ©∫Èó¥ */
}
.gr-chapter-title-large {
    font-family: "Georgia", serif;
    font-size: 22px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0 30px 0;
    color: #111;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #gr-chapter-sidebar {
    background-color: #1c1c1e;
    border-right: 1px solid #333;
}
#phone-screen.dark-mode .gr-sidebar-item {
    color: #ddd;
    border-bottom-color: #2c2c2e;
}
#phone-screen.dark-mode .gr-sidebar-item.active {
    background-color: rgba(255,255,255,0.1);
    color: #fff;
}
/* --- ÁªøÊ±üÔºöÈ´òÁ´ØÊëòË¶ÅÂç°ÁâáÈáçÊûÑ --- */

/* 1. Âç°ÁâáÂÆπÂô®ÔºöÂπ≤ÂáÄ„ÄÅÊÇ¨ÊµÆÊÑü */
.gr-summary-card.editable {
    background-color: #FFFFFF; /* Á∫ØÂáÄÁôΩÂ∫ï */
    border: 1px solid rgba(0,0,0,0.05); /* Âá†‰πé‰∏çÂèØËßÅÁöÑÊûÅÁªÜËæπÊ°Ü */
    border-radius: 12px; /* Êõ¥Â§ßÁöÑÂúÜËßíÔºåÁé∞‰ª£ÊÑü */
    padding: 24px; /* ÂÖÖË∂≥ÁöÑÂÜÖÈÉ®ÁïôÁôΩÔºåÂëºÂê∏ÊÑü */
    box-shadow: 0 8px 30px rgba(0,0,0,0.04); /* ÊûÅËΩªÊüîÁöÑÈ´òÁ∫ßÁÅ∞Èò¥ÂΩ± */
    margin-top: 40px; /* ‰∏éÊ≠£ÊñáÊãâÂºÄÊõ¥Â§ßË∑ùÁ¶ªÔºåÂΩ∞ÊòæÈáçË¶ÅÊÄß */
    transition: all 0.3s ease;
}
/* Èº†Ê†áÊÇ¨ÂÅúÊó∂Á®çÂæÆÂº∫Ë∞É‰∏Ä‰∏ã */
.gr-summary-card.editable:hover {
    box-shadow: 0 10px 40px rgba(0,0,0,0.06);
    border-color: rgba(27, 79, 62, 0.1);
}

/* 2. Âç°ÁâáÂ§¥ÈÉ® */
.gr-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

/* Ê†áÈ¢òÔºö‰ΩøÁî®‰ºòÈõÖÁöÑË°¨Á∫ø‰ΩìÔºåÂìÅÁâåËâ≤ */
.gr-summary-title {
    font-family: "Georgia", "Songti SC", serif; /* Ë°¨Á∫ø‰Ωì */
    color: var(--gr-primary); /* Ê∑±Â¢®Áªø */
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* 3. ËæìÂÖ•Ê°ÜÊú¨‰ΩìÔºöÊûÅÁÆÄ„ÄÅËûçÂÖ•ËÉåÊôØ */
.gr-summary-input {
    width: 100%;
    box-sizing: border-box; /* ÂÖ≥ÈîÆÔºöÈò≤Ê≠¢paddingÊíëÁ†¥ÂÆΩÂ∫¶ */
    background-color: #F9F9F9; /* ÊûÅÊ∑°ÁöÑÁÅ∞Ôºå‰∏éÁ∫ØÁôΩÂç°ÁâáÂΩ¢ÊàêÂæÆÂº±ÂØπÊØî */
    border: 1px solid #EAEAEA; /* ÊûÅÁªÜÊ∑°ÁÅ∞ËæπÊ°Ü */
    border-radius: 8px;
    padding: 16px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; /* ËæìÂÖ•ÂÜÖÂÆπÁî®Êó†Ë°¨Á∫ø‰ΩìÊõ¥Ê∏ÖÊô∞ */
    font-size: 14px;
    color: #333;
    line-height: 1.7;
    resize: vertical;
    min-height: 100px;
    outline: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ËæìÂÖ•Ê°ÜËÅöÁÑ¶Áä∂ÊÄÅÔºöÊòæÁé∞ÂìÅÁâåÊÑü */
.gr-summary-input:focus {
    background-color: #FFFFFF; /* ËÅöÁÑ¶ÂèòÁ∫ØÁôΩ */
    border-color: var(--gr-primary); /* ËæπÊ°ÜÂèòÂìÅÁâåÁªø */
    box-shadow: 0 0 0 4px rgba(27, 79, 62, 0.05); /* ÊûÅÂæÆÂº±ÁöÑÁªøËâ≤ÂÖâÊôï */
}
.gr-summary-input::placeholder {
    color: #CCC;
}

/* 4. Â∫ïÈÉ®ÊèêÁ§∫Â∞èÂ≠óÔºöÂº±ÂåñÂ§ÑÁêÜ */
.gr-summary-footer {
    font-size: 12px;
    color: #AAA; /* Êõ¥ÊµÖÁöÑÁÅ∞Ëâ≤ */
    margin-top: 12px;
    text-align: right; /* Âè≥ÂØπÈΩêÔºå‰∏çÂπ≤Êâ∞ËßÜÁ∫ø */
    font-weight: 400;
}

/* ‰øùÂ≠òÊåâÈíÆÂæÆË∞É */
.gr-mini-btn.save-summary-btn {
    background-color: transparent;
    color: var(--gr-primary);
    border: 1px solid var(--gr-primary);
    padding: 6px 12px;
    font-weight: 500;
    opacity: 0; /* ÈªòËÆ§ÈöêËóèÔºåËæìÂÖ•Êó∂JS‰ºöËÆ©ÂÆÉÊòæÁ§∫ÔºåËøôÈáåÈÖçÂêàJS */
    transition: all 0.2s;
}
/* JSÊéßÂà∂ÊòæÁ§∫Êó∂ÁöÑÊ†∑Âºè */
.gr-mini-btn.save-summary-btn[style*="display: block"] {
    opacity: 1;
}
.gr-mini-btn.save-summary-btn:hover {
    background-color: var(--gr-primary);
    color: white;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .gr-summary-card.editable {
    background-color: #2C2C2E;
    border-color: #3A3A3C;
}
#phone-screen.dark-mode .gr-summary-title {
    color: #FFFFFF;
}
#phone-screen.dark-mode .gr-summary-input {
    background-color: #1C1C1E;
    border-color: #3A3A3C;
    color: #EEE;
}
#phone-screen.dark-mode .gr-summary-input:focus {
    background-color: #000;
    border-color: var(--gr-primary);
}
#phone-screen.dark-mode .gr-summary-footer {
    color: #666;
}
/* ‰ΩúËÄÖÂàóË°®È°πÁöÑÊìç‰ΩúÊåâÈíÆÂÆπÂô® */
.gr-author-actions {
    display: flex;
    gap: 10px; /* ÊåâÈíÆ‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    align-items: center;
}

/* Â¶ÇÊûú‰πãÂâçÊ≤°ÊúâÂÆö‰πâ gr-inputÔºåË°•ÂÖÖ‰∏Ä‰∏ã‰ª•Èò≤‰∏á‰∏Ä */
.gr-input {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #f9f9f9;
    font-size: 15px;
    outline: none;
    box-sizing: border-box;
}
.gr-input:focus {
    background: #fff;
    border-color: #1B4F3E;
}
/* ========================================== */
/* ‚ñº‚ñº‚ñº ÁªøÊ±ü (Green River) È£éÊ†ºÁªàÊûÅ‰øÆÊ≠£ ‚ñº‚ñº‚ñº */
/* ========================================== */

/* 1. È°∂Ê†èÂ∏ÉÂ±Ä‰∏éÂÆΩÂ∫¶Áªü‰∏Ä (ÂØπÈΩêQQÈ£éÊ†º) */
.gr-header {
    /* 1. Â∏ÉÂ±Ä‰∏éÂ∞∫ÂØ∏ÔºöÂº∫Âà∂Âç†Êª°ÂÆΩÂ∫¶ */
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    width: 100% !important;
    box-sizing: border-box !important;
    
    /* 2. È´òÂ∫¶Ê†∏ÂøÉ‰øÆÂ§çÔºöÂØπÈΩê QQ Â§¥ÈÉ®È´òÂ∫¶ */
    /* QQ Â§¥ÈÉ®Ê†∑Âºè‰∏∫: padding: 15px 20px; padding-top: 45px; */
    padding: 15px 20px !important; 
    padding-top: 45px !important; /* ÂÖ≥ÈîÆÔºöÂº∫Âà∂È¢ÑÁïô 45px Áä∂ÊÄÅÊ†èÈ´òÂ∫¶ */
    
    /* 3. ÂÆö‰Ωç‰∏éÂ§ñËßÇ */
    position: sticky !important;
    top: 0 !important;
    z-index: 100 !important;
    background-color: rgba(250, 250, 249, 0.98) !important;
    border-bottom: 1px solid #E5E5E5 !important;
    flex-shrink: 0 !important; /* Èò≤Ê≠¢Ë¢´ÂÜÖÂÆπÊå§Âéã */
}

/* Á°Æ‰øùÊ†áÈ¢òÂ≠ó‰Ωì‰∏é QQ Â§¥ÈÉ®Â§ßÂ∞èÁõ∏ËøëÔºå‰ΩÜ‰øùÊåÅÁªøÊ±üÈ£éÊ†º */
.gr-title {
    font-family: "Georgia", "Songti SC", serif !important;
    font-size: 20px !important; /* Á®çÂæÆÂ§ß‰∏ÄÁÇπÁÇπÔºåÊòæÂæóÊõ¥ÊúâÊñáÂ≠¶ÊÑüÔºå‰ΩçÁΩÆÂ±Ö‰∏≠ */
    font-weight: 700 !important;
    color: #1B4F3E !important;
    /* ÁªùÂØπÂÆö‰ΩçÂ±Ö‰∏≠ (ÂèØÈÄâÔºåÂ¶ÇÊûúÊÉ≥Ë¶ÅÁªùÂØπÂ±Ö‰∏≠ÂØπÈΩêËØ∑Ëß£ÂºÄ‰∏ãÈù¢Ê≥®ÈáäÔºåÂê¶Âàô‰øùÊåÅ Flex Â±Ö‰∏≠) */
    /* position: absolute;
    left: 50%;
    transform: translateX(-50%);
    */
}

/* ‰øÆÂ§çÂè≥‰æßÊåâÈíÆÂÆπÂô®ÔºåÁ°Æ‰øùÊ®™ÂêëÊéíÂàó */
.gr-header-actions {
    display: flex !important;
    flex-direction: row !important;
    gap: 15px !important;
    align-items: center !important;
    /* Á°Æ‰øùÂÆÉÂú®ÊúÄ‰∏äÂ±ÇÔºåÂ¶ÇÊûú‰ΩøÁî®‰∫ÜÊ†áÈ¢òÁªùÂØπÂÆö‰Ωç */
    z-index: 10 !important; 
}

/* ‰øÆÊ≠£ÊåâÈíÆÊú¨Ë∫´ÁöÑÂ§ßÂ∞èÂíåÂØπÈΩê */
.gr-header .gr-icon-btn {
    width: 32px !important;
    height: 32px !important;
    padding: 6px !important;
    margin: 0 !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    /* ÂéªÊéâÂèØËÉΩÂØºËá¥Êç¢Ë°åÁöÑÂ±ûÊÄß */
    flex: none !important; 
}

/* 3. ‰ΩúËÄÖÂàóË°®È°πÂÜÖÊåâÈíÆÂº∫Âà∂Ê®™Âêë */
.gr-author-actions {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 10px !important;
}

/* 4. ÁªøÊ±ü‰∏ìÂ±ûÊ®°ÊÄÅÁ™óÊ†∑Âºè (Áªü‰∏Ä‰∏∫‚ÄúÊ∑ªÂä†‰π¶‚ÄùÁöÑÈ´òÁ´ØÈ£éÊ†º) */
#gr-author-editor-modal .modal-content {
    background-color: #FAFAF9 !important; /* ÊöñÁôΩËÉåÊôØ */
    border-radius: 16px !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
    padding: 0 !important;
    overflow: hidden !important;
}

/* ÂºπÁ™óÂ§¥ÈÉ® */
#gr-author-editor-modal .modal-header {
    background: transparent !important;
    border-bottom: none !important;
    padding: 25px 25px 10px 25px !important;
    justify-content: flex-start !important; /* Ê†áÈ¢òÈù†Â∑¶ÊàñÂ±Ö‰∏≠ÔºåËøôÈáåÈÄâÈù†Â∑¶Êõ¥ÂÉè‰π¶ */
}

#gr-author-editor-modal .modal-header span {
    font-family: "Georgia", "Songti SC", serif !important;
    color: #1B4F3E !important; /* Â¢®ÁªøËâ≤ */
    font-size: 22px !important;
    font-weight: 700 !important;
}

/* ÂºπÁ™ó‰∏ª‰Ωì */
#gr-author-editor-modal .modal-body {
    padding: 10px 25px 30px 25px !important;
}

/* ËæìÂÖ•Ê°ÜÁªÑ */
#gr-author-editor-modal .form-group {
    margin-bottom: 20px !important;
}

/* Ê†áÁ≠æ */
#gr-author-editor-modal label {
    color: #1B4F3E !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    margin-bottom: 8px !important;
    display: block !important;
    opacity: 0.8;
}

/* ËæìÂÖ•Ê°ÜÊú¨‰Ωì */
#gr-author-editor-modal input,
#gr-author-editor-modal textarea {
    background-color: #FFFFFF !important;
    border: 1px solid #E5E5E5 !important;
    border-radius: 10px !important;
    padding: 15px !important;
    font-size: 16px !important;
    color: #333 !important;
    width: 100% !important;
    box-sizing: border-box !important;
    font-family: -apple-system, sans-serif !important;
    transition: all 0.2s !important;
}

#gr-author-editor-modal input:focus,
#gr-author-editor-modal textarea:focus {
    border-color: #1B4F3E !important;
    box-shadow: 0 0 0 3px rgba(27, 79, 62, 0.05) !important;
    outline: none !important;
}

/* ÂºπÁ™óÂ∫ïÈÉ® */
#gr-author-editor-modal .modal-footer {
    border-top: 1px solid #E5E5E5 !important;
    padding: 15px 25px !important;
    background-color: #FFFFFF !important;
    gap: 15px !important;
}

/* ÊåâÈíÆ */
#gr-author-editor-modal .modal-footer button {
    border-radius: 25px !important;
    padding: 12px 0 !important;
    font-size: 15px !important;
    font-weight: 600 !important;
    border: none !important;
}

#gr-author-editor-modal .modal-footer .cancel {
    background-color: #F5F5F7 !important;
    color: #8E8E93 !important;
    width: 30% !important;
}

#gr-author-editor-modal .modal-footer .save {
    background-color: #1B4F3E !important;
    color: #FFFFFF !important;
    width: 70% !important;
    box-shadow: 0 4px 15px rgba(27, 79, 62, 0.2) !important;
}
/* === Mail App Theme (‰øÆÂ§çÁâà) === */
:root {
    --mail-bg: #F2F2F7;
    --mail-surface: #FFFFFF;
    --mail-text-primary: #000000;
    --mail-text-secondary: #8E8E93;
    --mail-accent: #007AFF;
    --mail-separator: #C6C6C8;
    --mail-border-radius: 12px;
}

/* ‰∏ªÂ±èÂπïËÉåÊôØ */
#email-screen {
    background-color: var(--mail-bg);
    color: var(--mail-text-primary);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    display: flex;         /* Êñ∞Â¢ûÔºöÊîπ‰∏∫FlexÂ∏ÉÂ±Ä‰ª•‰æøÊéßÂà∂ÊªöÂä® */
    flex-direction: column;
}

/* --- 1. Â§¥ÈÉ®Âå∫Âüü (Áªü‰∏ÄQQÈ£éÊ†º) --- */
.mail-header, .mail-detail-header {
    /* Ê†∏ÂøÉ‰øÆÂ§çÔºöÈ´òÂ∫¶ÂíåÂÜÖËæπË∑ù‰∏é QQ ‰øùÊåÅ‰∏ÄËá¥ */
    padding: 15px 20px !important;
    padding-top: 45px !important; /* ÈÅøÂºÄÂàòÊµ∑ */
    background-color: rgba(242, 242, 247, 0.95); /* Áï•Â∏¶ÈÄèÊòéËÉåÊôØ */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 0.5px solid #C6C6C8;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    min-height: 40px;
}

/* ËØ¶ÊÉÖÈ°µÂ§¥ÈÉ®ËÉåÊôØÊîπ‰∏∫Á∫ØÁôΩÔºå‰∏éËØ¶ÊÉÖÈ°µ‰∏ÄËá¥ */
.mail-detail-header {
    background-color: rgba(255, 255, 255, 0.95);
}

/* Â§¥ÈÉ®‰∏äÊñπÁöÑÂÆπÂô® (Áî®‰∫éÂÆπÁ∫≥ËøîÂõûÊåâÈíÆÂíåÊ†áÈ¢ò) */
.mail-header-top {
    display: contents; /* ÂèñÊ∂àËøôÂ±ÇÂÆπÂô®ÁöÑÂ∏ÉÂ±ÄÂΩ±ÂìçÔºåÁõ¥Êé•ËÆ©Â≠êÂÖÉÁ¥†ÂèÇ‰∏é Grid/Flex */
}

/* 2. ÊåâÈíÆÊ†∑ÂºèÁªü‰∏Ä */
.mail-icon-btn {
    background: none;
    border: none;
    color: var(--mail-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 5px; /* Â¢ûÂä†ÁÇπÂáªÂå∫Âüü */
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: opacity 0.2s;
}
.mail-icon-btn:active { opacity: 0.6; }
.mail-icon-btn svg {
    width: 24px;
    height: 24px;
}

/* Âè≥‰∏äËßíÊìç‰ΩúÂå∫ */
.mail-header-actions {
    display: flex;
    align-items: center;
    gap: 15px; /* ÊåâÈíÆÈó¥Ë∑ù */
}

/* 3. Êî∂‰ª∂ÁÆ±Â§ßÊ†áÈ¢ò (‰∏ãÁßªÔºå‰∏çÂç†Áî®È°∂Ê†è) */
.mail-large-title {
    font-size: 30px;
    font-weight: 700;
    margin: 10px 20px 10px 20px; /* Â∑¶Âè≥ËæπË∑ùÂØπÈΩêÂàóË°® */
    letter-spacing: -0.5px;
    color: #000;
}

/* 4. ÊêúÁ¥¢Ê†è */
.mail-search-bar {
    background-color: rgba(118, 118, 128, 0.12);
    border-radius: 10px;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 16px 10px 16px; /* Â¢ûÂä†Â§ñËæπË∑ù */
}
.mail-search-bar input {
    background: transparent;
    border: none;
    font-size: 16px;
    width: 100%;
    outline: none;
    color: #000;
}

/* 5. ÂàóË°®ÂÆπÂô® */
.mail-list-container {
    background-color: var(--mail-surface);
    border-radius: var(--mail-border-radius);
    margin: 0 16px; /* ‰∏§‰æßÁïôÁôΩ */
    flex-grow: 1;
    overflow-y: auto;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    padding-bottom: 20px;
}

/* 6. ËØ¶ÊÉÖÈ°µÂÜÖÂÆπË∞ÉÊï¥ */
.mail-detail-content {
    padding: 20px;
    overflow-y: auto;
    flex-grow: 1; /* Âç†Êª°Ââ©‰ΩôÁ©∫Èó¥ */
    height: auto; /* ÂèñÊ∂àÂõ∫ÂÆöÈ´òÂ∫¶ËÆ°ÁÆó */
    background-color: #fff;
}

/* 7. ÈöêËóèÂ∫ïÈÉ®Â∑•ÂÖ∑Ê†è */
.mail-toolbar {
    display: none !important;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .mail-header,
#phone-screen.dark-mode .mail-detail-header {
    background-color: #000;
    border-bottom-color: #38383A;
}
#phone-screen.dark-mode .mail-detail-content {
    background-color: #000;
}
#phone-screen.dark-mode .mail-large-title { color: #fff; }


/* ========================================= */
/* ‚ñº‚ñº‚ñº Swiss Minimalist Mail Theme ‚ñº‚ñº‚ñº */
/* ========================================= */

:root {
    /* Ê†∏ÂøÉËâ≤Êùø - ÊûÅÁÆÄ„ÄÅÂÜ∑Ê∑°„ÄÅÈ´òÁ∫ß */
    --mail-bg: #F2F2F7;            /* iOSÁ≥ªÁªüÁ∫ßÊµÖÁÅ∞ËÉåÊôØ */
    --mail-surface: #FFFFFF;       /* Á∫ØÂáÄÁôΩ */
    --mail-text-main: #1C1C1E;     /* Ê∑±ÁÇ≠ÈªëÔºåÈùûÁ∫ØÈªë */
    --mail-text-sub: #8E8E93;      /* ‰∏≠ÊÄßÁÅ∞ */
    --mail-accent: #007AFF;        /* ÁëûÂ£´Ëìù (Swiss Blue) */
    --mail-border: rgba(0, 0, 0, 0.04); /* ÊûÅÁªÜÂæÆÁöÑËæπÁïå */
    --mail-divider: #C6C6C8;       /* ÂàÜÂâ≤Á∫ø */
    --mail-radius-l: 16px;         /* Â§ßÂúÜËßí */
    --mail-radius-m: 10px;         /* ‰∏≠ÂúÜËßí */
    --mail-radius-s: 6px;          /* Â∞èÂúÜËßí */
    --mail-shadow: 0 4px 24px rgba(0, 0, 0, 0.03); /* ÊºÇÊµÆÊÑüÈò¥ÂΩ± */
}

/* ÊöóÈªëÊ®°ÂºèÂèòÈáèÈáçÂÜô */
#phone-screen.dark-mode {
    --mail-bg: #000000;
    --mail-surface: #1C1C1E;
    --mail-text-main: #FFFFFF;
    --mail-text-sub: #98989D;
    --mail-border: rgba(255, 255, 255, 0.1);
    --mail-divider: #38383A;
    --mail-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
}

/* ÈÇÆÁÆ±‰∏ªÂÆπÂô® */
#email-screen, #email-detail-screen {
    background-color: var(--mail-bg) !important;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    letter-spacing: -0.01em; /* Êî∂Á¥ßÂ≠óÈó¥Ë∑ùÔºåÊõ¥Á≤æËá¥ */
}



/* --- 2. Ê†áÈ¢ò‰∏éÊêúÁ¥¢Ê†è --- */
.mail-large-title {
    font-size: 34px;
    font-weight: 700;
    color: var(--mail-text-main);
    margin: 10px 20px 15px 20px !important;
    letter-spacing: 0.01em;
}

.mail-search-bar {
    background-color: rgba(118, 118, 128, 0.12);
    border-radius: 10px;
    margin: 0 16px 16px 16px;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s;
}
.mail-search-bar:focus-within {
    background-color: rgba(118, 118, 128, 0.18);
}
.mail-search-bar input {
    font-size: 17px;
    color: var(--mail-text-main);
    height: auto;
}
.mail-search-bar input::placeholder {
    color: var(--mail-text-sub);
}

/* --- 3. ÈÇÆ‰ª∂ÂàóË°® (List) --- */
.mail-list-container {
    background-color: var(--mail-bg) !important; /* ËÉåÊôØÈÄèÊòéÔºåÊòæÁ§∫Â±ÇÁ∫ß */
    padding: 0 16px !important; /* ‰∏§‰æßÁïôÁôΩ */
    border-radius: 0 !important;
    box-shadow: none !important;
    margin: 0 !important;
    gap: 12px; /* ÂàóË°®È°πÈó¥Ë∑ù */
    display: flex;
    flex-direction: column;
}

.mail-item {
    background-color: var(--mail-surface);
    border-radius: var(--mail-radius-m);
    padding: 16px !important;
    margin-bottom: 0 !important; /* Áî± gap ÊéßÂà∂ */
    border: 1px solid var(--mail-border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.02); /* ÊûÅËΩªÁöÑÈò¥ÂΩ± */
    position: relative;
    transition: transform 0.1s, background-color 0.2s;
}

.mail-item:active {
    transform: scale(0.98);
    background-color: var(--mail-bg);
}

/* Êú™ËØªÁä∂ÊÄÅÔºöÂ∑¶‰æßËìùÁÇπ */
.mail-item.unread::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 20px;
    width: 8px;
    height: 8px;
    background-color: var(--mail-accent);
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(0, 122, 255, 0.4);
}
.mail-item.unread {
    padding-left: 26px !important; /* ‰∏∫ËìùÁÇπÁïôÂá∫Á©∫Èó¥ */
}

/* ÂàóË°®ÊéíÁâà‰ºòÂåñ */
.mail-item-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
}

.mail-sender {
    font-size: 16px;
    font-weight: 600;
    color: var(--mail-text-main);
}

.mail-date {
    font-size: 13px;
    color: var(--mail-text-sub);
    font-weight: 400;
}

.mail-subject {
    font-size: 15px;
    font-weight: 500;
    color: var(--mail-text-main);
    margin-bottom: 4px;
}

.mail-preview {
    font-size: 14px;
    color: var(--mail-text-sub);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* --- 4. ÈÇÆ‰ª∂ËØ¶ÊÉÖÈ°µ (Detail) --- */
#email-detail-screen {
    background-color: var(--mail-surface) !important;
}

.mail-detail-content {
    padding: 24px 20px !important;
    max-width: 600px;
    margin: 0 auto;
    background-color: transparent !important;
}

/* ËØ¶ÊÉÖÈ°µÂ§¥ÈÉ®‰ø°ÊÅØÂùó */
.mail-meta-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--mail-border);
}

.mail-subject-line {
    font-size: 22px;
    font-weight: 700;
    color: var(--mail-text-main);
    line-height: 1.3;
    margin-bottom: 16px;
}

.mail-meta-row {
    display: flex;
    align-items: center;
    gap: 12px;
}

.mail-sender-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8E8E93, #636366);
    color: white;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.mail-meta-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.mail-from-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
}

.mail-from-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--mail-text-main);
}

.mail-time {
    font-size: 12px;
    color: var(--mail-text-sub);
}

.mail-to-row {
    font-size: 13px;
    color: var(--mail-text-sub);
    margin-top: 2px;
}

/* ÈÇÆ‰ª∂Ê≠£Êñá */
.mail-body-text {
    font-size: 16px;
    line-height: 1.6;
    color: var(--mail-text-main);
    white-space: pre-wrap;
}

/* --- 5. ÁîüÊàêÂô®ÂºπÁ™ó (The "Ugly" Fix) --- */
#email-generator-modal .modal-content {
    background-color: var(--mail-bg) !important;
    border-radius: var(--mail-radius-l) !important;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2) !important;
    border: 1px solid rgba(255,255,255,0.1);
    max-width: 400px;
    width: 92%;
}

.mail-modal-header {
    padding: 20px 24px !important;
    border-bottom: 1px solid var(--mail-border);
}
.mail-modal-header span {
    font-size: 18px;
    font-weight: 600;
    color: var(--mail-text-main);
}

/* Ë°®ÂçïÊéß‰ª∂‰ºòÂåñ */
.gr-form-group {
    background-color: var(--mail-surface);
    border-radius: var(--mail-radius-m);
    padding: 16px;
    margin-bottom: 16px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
}

.gr-form-group label {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--mail-text-sub) !important;
    margin-bottom: 10px !important;
    display: block;
    font-weight: 600;
}

.gr-input, textarea.gr-input {
    width: 100%;
    background-color: var(--mail-bg);
    border: none;
    border-radius: 8px;
    padding: 12px;
    font-size: 15px;
    color: var(--mail-text-main);
    outline: none;
    transition: box-shadow 0.2s;
}
.gr-input:focus {
    box-shadow: 0 0 0 2px var(--mail-accent);
    background-color: var(--mail-surface);
}

/* Checkbox ÂàóË°®‰ºòÂåñ */
.gr-checkbox-list {
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.gr-checkbox-item {
    display: flex;
    align-items: center;
    padding: 10px;
    background-color: var(--mail-bg); /* ÊµÖÁÅ∞Â∫ïËâ≤ */
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.gr-checkbox-item:hover {
    background-color: #E5E5EA; /* ÊÇ¨ÂÅúÂä†Ê∑± */
}
#phone-screen.dark-mode .gr-checkbox-item:hover {
    background-color: #3A3A3C;
}

/* Â§çÈÄâÊ°ÜÁæéÂåñ */
.gr-checkbox-item input[type="checkbox"] {
    appearance: none;
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #C7C7CC;
    border-radius: 50%; /* ÂúÜÂΩ¢Â§çÈÄâÊ°ÜÔºåÂÉèÈÄâÊã©ÂàóË°® */
    margin-right: 12px;
    position: relative;
    transition: all 0.2s;
}
.gr-checkbox-item input[type="checkbox"]:checked {
    background-color: var(--mail-accent);
    border-color: var(--mail-accent);
}
.gr-checkbox-item input[type="checkbox"]:checked::after {
    content: '‚úî';
    font-size: 12px;
    color: white;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* ÂºπÁ™óÂ∫ïÈÉ®ÊåâÈíÆ */
.modal-footer {
    padding: 16px 24px !important;
    background-color: var(--mail-surface) !important;
}
.modal-footer button {
    padding: 12px 0 !important;
    border-radius: 10px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
}
/* Â∫ïÈÉ®Êìç‰ΩúÊ†èÊ†∑Âºè */
#mail-action-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(242, 242, 247, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 0.5px solid #c6c6c8;
    padding: 10px 20px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
    z-index: 20;
}

.select-all-btn {
    color: var(--mail-accent);
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
}

.mail-delete-action-btn {
    color: #ff3b30;
    background: none;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
.mail-delete-action-btn:disabled {
    color: #999;
    pointer-events: none;
}

/* ÈÇÆ‰ª∂ÂàóË°®È°πÁöÑÈÄâÊã©Áä∂ÊÄÅÊ†∑Âºè */
.mail-item {
    transition: transform 0.2s ease, padding-left 0.2s ease;
    position: relative;
    overflow: visible !important; /* ÂÖÅËÆ∏ÈÄâ‰∏≠ÂúàÊòæÁ§∫Âú®Â∑¶‰æß */
}

/* ÁºñËæëÊ®°Âºè‰∏ãÔºåÁªôÂ∑¶‰æßÁïôÂá∫Á©∫Èó¥ */
.mail-item.editing {
    transform: translateX(40px); /* Êï¥‰ΩìÂè≥Áßª */
    width: calc(100% - 40px); /* ÂÆΩÂ∫¶Ëá™ÈÄÇÂ∫î */
}

/* ÈÄâÊã©Âúà (Checkbox) */
.mail-select-checkbox {
    position: absolute;
    left: -30px; /* ÊîæÂú®Âç°ÁâáÂ∑¶‰æß */
    top: 50%;
    transform: translateY(-50%);
    width: 22px;
    height: 22px;
    border: 2px solid #c7c7cc;
    border-radius: 50%;
    box-sizing: border-box;
    background-color: transparent;
    transition: all 0.2s;
    display: none; /* ÈªòËÆ§ÈöêËóè */
}

/* ÁºñËæëÊ®°Âºè‰∏ãÊòæÁ§∫ÈÄâÊã©Âúà */
.mail-item.editing .mail-select-checkbox {
    display: block;
}

/* ÈÄâ‰∏≠Áä∂ÊÄÅ */
.mail-item.selected .mail-select-checkbox {
    background-color: var(--mail-accent);
    border-color: var(--mail-accent);
}
.mail-item.selected .mail-select-checkbox::after {
    content: '‚úî';
    color: white;
    font-size: 14px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #mail-action-bar {
    background-color: rgba(28, 28, 30, 0.95);
    border-top-color: #38383a;
}


/* === ÈÇÆ‰ª∂ËΩ¨ÂèëÂç°ÁâáÊ†∑Âºè === */
.email-share-card {
    width: 240px;
    background-color: #ffffff;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s;
    overflow: hidden;
}
.email-share-card:active {
    transform: scale(0.98);
    background-color: #f9f9f9;
}

/* È°∂ÈÉ®ÔºöÂõæÊ†á + Ê†áÈ¢ò‰ø°ÊÅØ */
.email-card-top {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: flex-start;
}

/* ËìùËâ≤ÂõæÊ†áÂùó */
.email-icon-box {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, #007aff, #0056b3);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0, 122, 255, 0.2);
}

.email-card-header-text {
    flex: 1;
    overflow: hidden;
}

.email-card-subject {
    font-size: 15px;
    font-weight: 600;
    color: #1f1f1f;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
    margin-bottom: 3px;
}

.email-card-sender {
    font-size: 12px;
    color: #8a8a8a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ‰∏≠Èó¥ÔºöÊëòË¶ÅÈ¢ÑËßà */
.email-card-preview {
    font-size: 13px;
    color: #666;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
    background-color: #f7f7f9;
    padding: 8px;
    border-radius: 6px;
}

/* Â∫ïÈÉ®ÔºöËÑöÊ†á */
.email-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #f0f0f0;
    padding-top: 8px;
    font-size: 11px;
    color: #999;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .email-share-card {
    background-color: #1c1c1e;
    border-color: #333;
}
#phone-screen.dark-mode .email-share-card:active {
    background-color: #2c2c2e;
}
#phone-screen.dark-mode .email-card-subject {
    color: #fff;
}
#phone-screen.dark-mode .email-card-preview {
    background-color: #2c2c2e;
    color: #aaa;
}
#phone-screen.dark-mode .email-card-footer {
    border-top-color: #333;
}
/* --- Ê∏≤ÊüìËßÑÂàôÁªëÂÆöËåÉÂõ¥ÁæéÂåñ --- */

/* 1. ÂÆπÂô®ÁæéÂåñÔºöÁ±ª‰ºº iOS ÂàÜÁªÑÂç°Áâá */
#rule-scope-checkboxes {
    max-height: 250px;
    overflow-y: auto;
    background-color: var(--secondary-bg); /* ÈÄÇÈÖçÊöóÈªëÊ®°Âºè */
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 5px;
    margin-top: 5px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* 2. ÂçïË°åÂàóË°®È°πÁæéÂåñ */
.rule-scope-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    user-select: none; /* Èò≤Ê≠¢ÂèåÂáªÈÄâ‰∏≠ÊñáÂ≠ó */
}

/* ÊÇ¨ÂÅúÂíåÁÇπÂáªÊïàÊûú */
.rule-scope-item:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
.rule-scope-item:active {
    background-color: rgba(0, 0, 0, 0.1);
}

/* 3. Â§çÈÄâÊ°ÜÁæéÂåñÔºöÂèòÂ§ß‰∏ÄÁÇπÔºåÂπ∂Â¢ûÂä†Âè≥ËæπË∑ù */
.rule-scope-item input[type="checkbox"] {
    appearance: none; /* ÁßªÈô§ÈªòËÆ§Ê†∑Âºè */
    -webkit-appearance: none;
    width: 22px;
    height: 22px;
    border: 2px solid #c7c7cc;
    border-radius: 50%; /* ÂúÜÂΩ¢Â§çÈÄâÊ°ÜÔºåÂÉèÈÄâÊã©ÂàóË°® */
    margin-right: 12px;
    position: relative;
    transition: all 0.2s;
    flex-shrink: 0;
}

/* ÈÄâ‰∏≠Áä∂ÊÄÅ */
.rule-scope-item input[type="checkbox"]:checked {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

/* ÈÄâ‰∏≠Êó∂ÁöÑÂØπÂãæ */
.rule-scope-item input[type="checkbox"]:checked::after {
    content: '‚úî';
    font-size: 14px;
    color: white;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
}

/* 4. Â§¥ÂÉèÊ†∑Âºè */
.rule-scope-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 12px;
    border: 1px solid rgba(0,0,0,0.1);
    flex-shrink: 0;
}

/* ÂÖ¨Áî®ÂõæÊ†áÁöÑÁâπÊÆäÊ†∑Âºè */
.rule-scope-icon-box {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #007aff; /* ËìùËâ≤ËÉåÊôØ */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 18px;
    flex-shrink: 0;
}

/* 5. ÊñáÂ≠óÊéíÁâà */
.rule-scope-info {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow: hidden;
}

.rule-scope-name {
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rule-scope-desc {
    font-size: 12px;
    color: var(--text-secondary);
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #rule-scope-checkboxes {
    background-color: #1c1c1e;
    border-color: #38383a;
}
#phone-screen.dark-mode .rule-scope-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
/* --- Ê∏≤ÊüìËßÑÂàôÁÆ°ÁêÜÊ®°ÂºèÊ†∑Âºè --- */

/* 1. ËßÑÂàôÂç°ÁâáÂÆπÂô®Ë∞ÉÊï¥ */
.rule-card {
    position: relative; /* ‰∏∫Â§çÈÄâÊ°ÜÂÆö‰Ωç */
    transition: transform 0.2s ease, border-color 0.2s;
}

/* 2. ÈöêËóèÁöÑÂ§çÈÄâÊ°Ü */
.rule-select-checkbox {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 22px;
    height: 22px;
    border: 2px solid #c7c7cc;
    border-radius: 50%;
    appearance: none;
    -webkit-appearance: none;
    background-color: transparent;
    display: none; /* ÈªòËÆ§ÈöêËóè */
    z-index: 5;
    transition: all 0.2s;
}

/* 3. ÈÄâ‰∏≠Áä∂ÊÄÅ */
.rule-select-checkbox:checked {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}
.rule-select-checkbox:checked::after {
    content: '‚úî';
    color: white;
    font-size: 14px;
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-weight: bold;
}

/* 4. ÁÆ°ÁêÜÊ®°ÂºèÊøÄÊ¥ªÊó∂ */
#rules-content-container.management-mode {
    padding-bottom: 80px; /* ‰∏∫Â∫ïÈÉ®Ê†èÁïôÁ©∫ */
}

#rules-content-container.management-mode .rule-select-checkbox {
    display: block; /* ÊòæÁ§∫Â§çÈÄâÊ°Ü */
}

#rules-content-container.management-mode .rule-card {
    border-right: 30px solid transparent; /* Á®çÂæÆÊå§Âéã‰∏ÄÁÇπÂÜÖÂÆπ */
}

#rules-content-container.management-mode .rule-card.selected {
    background-color: rgba(0, 122, 255, 0.05);
    border-color: var(--accent-color);
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #rules-action-bar {
    background-color: rgba(28, 28, 30, 0.95);
    border-top-color: #38383a;
    color: #fff;
}
/* --- START: ËÅäÂ§©ÂõæÁâáÁº©Áï•Âõæ‰∏éÊîæÂ§ßÊ†∑Âºè --- */

/* 1. Âº∫Âà∂Áº©Â∞èËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÁöÑÂõæÁâáÂ∞∫ÂØ∏ */
.message-bubble .chat-image {
    max-width: 140px !important;  /* Áº©Áï•ÂõæÊúÄÂ§ßÂÆΩÂ∫¶ */
    max-height: 180px !important; /* Áº©Áï•ÂõæÊúÄÂ§ßÈ´òÂ∫¶ */
    width: auto !important;
    height: auto !important;
    border-radius: 8px !important;
    cursor: zoom-in !important;   /* Èº†Ê†áÁßª‰∏äÂéªÊòæÁ§∫ÊîæÂ§ßÂõæÊ†á */
    object-fit: cover !important;
    display: block;
}

/* 2. ÁÆÄÂçïÁöÑÂÖ®Â±èÊîæÂ§ßÈÅÆÁΩ©Â±Ç (‰∏ç‰æùËµñÁõ∏ÂÜåÁªÑ‰ª∂) */
#simple-image-zoom-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.85); /* Ê∑±Ëâ≤ÂçäÈÄèÊòéËÉåÊôØ */
    z-index: 99999; /* ‰øùËØÅÂú®ÊúÄ‰∏äÂ±Ç */
    display: none; /* ÈªòËÆ§ÈöêËóè */
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.25s ease; /* Ê∏êÂèòÂä®Áîª */
    backdrop-filter: blur(5px);
}

#simple-image-zoom-overlay.visible {
    display: flex;
    opacity: 1;
}

/* ÊîæÂ§ßÂêéÁöÑÂõæÁâáÊú¨‰Ωì */
#simple-image-zoom-overlay img {
    max-width: 95%;
    max-height: 90%;
    border-radius: 4px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transform: scale(0.9);
    transition: transform 0.25s ease;
    object-fit: contain;
}

#simple-image-zoom-overlay.visible img {
    transform: scale(1);
}
/* --- END: ËÅäÂ§©ÂõæÁâáÁº©Áï•Âõæ‰∏éÊîæÂ§ßÊ†∑Âºè --- */
/* ÈÄöÁî®ÊåâÈíÆÊ†∑Âºè */
.nai-regenerate-btn,
.nai-upload-imgbb-btn,
.nai-save-local-btn {
    width: 32px;
    height: 32px;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    opacity: 0;
    transition: all 0.2s ease-in-out;
}

/* ÊÇ¨ÂÅúÊòæÁ§∫ */
.nai-image-wrapper:hover .nai-regenerate-btn,
.nai-image-wrapper:hover .nai-upload-imgbb-btn,
.nai-image-wrapper:hover .nai-save-local-btn {
    opacity: 1;
}

/* ÊåâÈíÆÈ´ò‰∫Æ */
.nai-regenerate-btn:hover,
.nai-upload-imgbb-btn:hover,
.nai-save-local-btn:hover {
    background-color: rgba(0, 0, 0, 0.85);
    transform: scale(1.1);
}
/* --- Reddit App Ê†∑Âºè --- */
.reddit-post-item {
    background-color: #fff;
    margin-bottom: 10px;
    padding: 10px 15px;
    cursor: pointer;
    display: flex;
    gap: 10px;
    border-bottom: 1px solid #eee;
}

.reddit-post-item:active {
    background-color: #f0f0f0;
}

.reddit-vote-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 30px;
    font-size: 12px;
    color: #1a1a1b;
    font-weight: 700;
}

.reddit-content-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
    min-width: 0;
}

.reddit-meta {
    font-size: 11px;
    color: #787c7e;
    display: flex;
    align-items: center;
    gap: 5px;
}

.reddit-sub-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #0079d3;
}

.reddit-title {
    font-size: 15px;
    font-weight: 600;
    color: #222;
    line-height: 1.4;
}

.reddit-preview-img {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #edeff1;
    margin-top: 5px;
}

.reddit-forward-btn {
    margin-top: 8px;
    background-color: #f0f0f0;
    color: #555;
    border: none;
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 12px;
    cursor: pointer;
    align-self: flex-start;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* --- ËÅäÂ§©Ê∞îÊ≥°‰∏≠ÁöÑÁ≤æÁæé Reddit Âç°ÁâáÊ†∑Âºè --- */
.message-bubble.is-reddit-card {
    flex: initial;
    min-width: auto;
}

.message-bubble.is-reddit-card .content {
    padding: 0;
    background: transparent !important;
    box-shadow: none;
}

.reddit-share-card {
    width: 240px;
    background-color: #ffffff;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    cursor: pointer;
}

.reddit-card-header {
    padding: 8px 12px;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    gap: 6px;
    border-bottom: 1px solid #eee;
}

.reddit-card-logo {
    width: 16px;
    height: 16px;
}

.reddit-card-sub {
    font-size: 11px;
    color: #1c1c1c;
    font-weight: 700;
}

.reddit-card-user {
    font-size: 11px;
    color: #787c7e;
}

.reddit-card-body {
    padding: 10px 12px;
}

.reddit-card-title {
    font-size: 14px;
    font-weight: 600;
    color: #222;
    margin-bottom: 8px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.reddit-card-img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 5px;
    background-color: #eee;
}

.reddit-card-footer {
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #f0f0f0;
    font-size: 11px;
    color: #878a8c;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #char-reddit-screen { background-color: #000; }
#phone-screen.dark-mode #char-reddit-list { background-color: #121212; }
#phone-screen.dark-mode .reddit-post-item { background-color: #1a1a1b; border-bottom-color: #343536; }
#phone-screen.dark-mode .reddit-title { color: #d7dadc; }
#phone-screen.dark-mode .reddit-share-card { background-color: #1a1a1b; border-color: #343536; }
#phone-screen.dark-mode .reddit-card-header { background-color: #272729; border-bottom-color: #343536; }
#phone-screen.dark-mode .reddit-card-sub { color: #d7dadc; }
#phone-screen.dark-mode .reddit-card-title { color: #d7dadc; }
#phone-screen.dark-mode .reddit-card-footer { border-top-color: #343536; }
/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç Reddit ËØ¶ÊÉÖ */
#phone-screen.dark-mode #char-article-content h2 { color: #e0e0e0 !important; }
#phone-screen.dark-mode #char-article-content div { color: #ccc !important; }
#phone-screen.dark-mode .reddit-comment-item { border-bottom-color: #333 !important; }
/* ÁªøÊ±ü‰π¶Á±çÂç°Áâá‰∏äÁöÑÂä†ÂÖ•‰π¶Êû∂ÊåâÈíÆ */
.gr-add-shelf-btn {
    background: none;
    border: 1px solid var(--gr-primary);
    color: var(--gr-primary);
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
    z-index: 2; /* Á°Æ‰øùÂú®Âç°ÁâáÁÇπÂáªÂ±Ç‰πã‰∏ä */
}
.gr-add-shelf-btn:hover {
    background-color: var(--gr-primary);
    color: white;
}
/* Â∑≤Âä†ÂÖ•Áä∂ÊÄÅÔºöÂÆûÂøÉËÉåÊôØÔºåÊòæÁ§∫‰∏∫Â∑≤ÂÆåÊàê */
.gr-add-shelf-btn.added {
    background-color: rgba(0,0,0,0.05);
    border-color: transparent;
    color: #888;
    cursor: pointer; /* ‰øùÊåÅÂèØÁÇπÂáª */
}
/* Â∑≤Âä†ÂÖ•Áä∂ÊÄÅÊÇ¨ÂÅúÔºöÂèòÊàêÁ∫¢Ëâ≤ÔºåÊèêÁ§∫ÁßªÈô§ */
.gr-add-shelf-btn.added:hover {
    background-color: #ffebee;
    color: #ff3b30;
    border-color: #ff3b30;
}
/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .gr-add-shelf-btn.added {
    background-color: rgba(255,255,255,0.1);
    color: #aaa;
}
#phone-screen.dark-mode .gr-add-shelf-btn.added:hover {
    background-color: rgba(255, 59, 48, 0.2);
    color: #ff453a;
    border-color: #ff453a;
}
/* ========================================= */
/* ‚ñº‚ñº‚ñº ÁëûÂ£´ÊûÅÁÆÄ‰∏ª‰πâÈÄöÁü•Á≥ªÁªü (Swiss Toast) ‚ñº‚ñº‚ñº */
/* ========================================= */

.toast-container {
    position: fixed;
    top: 12px; /* È°∂ÈÉ®ÁïôÂá∫Áä∂ÊÄÅÊ†èÂëºÂê∏ÊÑü */
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none; /* ÂÖÅËÆ∏ÁÇπÂáªÁ©øÈÄè */
}

.toast-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px 12px 16px;
    background-color: rgba(255, 255, 255, 0.92); /* ÊûÅÈ´òÁ∫ØÂ∫¶ÁöÑÁôΩ */
    backdrop-filter: blur(20px); /* Á£®Á†ÇÁéªÁíÉË¥®ÊÑü */
    -webkit-backdrop-filter: blur(20px);
    border-radius: 50px; /* ÂÆåÂÖ®ËÉ∂ÂõäÁä∂ */
    box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.06), /* Âº•Êï£Èò¥ÂΩ± */
        0 1px 2px rgba(0, 0, 0, 0.04),  /* ÈîêÂà©Èò¥ÂΩ± */
        inset 0 0 0 0.5px rgba(0, 0, 0, 0.05); /* ÂÜÖÊèèËæπ‰ª£ÊõøËæπÊ°Ü */
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    font-size: 14px;
    font-weight: 500;
    color: #1d1d1f; /* Ê∑±ÁÇ≠ÁÅ∞ÔºåÈùûÁ∫ØÈªë */
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); /* iOS Áâ©ÁêÜÂä®ÊïàÊõ≤Á∫ø */
}

.toast-item.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
}

.toast-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    color: #0071e3; /* ËãπÊûúËìù */
}

.toast-icon svg {
    width: 100%;
    height: 100%;
    stroke-width: 2;
}

/* Âä†ËΩΩ‰∏≠Âä®Áîª */
.toast-icon.spinning svg {
    animation: toast-spin 1s linear infinite;
}

@keyframes toast-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç - Ê∑±ÈÇÉËÄåÈÄöÈÄè */
#phone-screen.dark-mode .toast-item {
    background-color: rgba(28, 28, 30, 0.92);
    color: #f5f5f7;
    box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.2),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.1);
}
#phone-screen.dark-mode .toast-icon {
    color: #0a84ff;
}

/* ========================================= */
/* ‚ñº‚ñº‚ñº ËÆæÁΩÆÈ°µÈù¢Â∏ÉÂ±Ä‰ºòÂåñ (Spa Aesthetics) ‚ñº‚ñº‚ñº */
/* ========================================= */

/* 1. Â¢ûÂä†ÂëºÂê∏ÊÑü */
.settings-container {
    padding: 24px 20px !important; /* Â¢ûÂä†Êï¥‰ΩìÂÜÖËæπË∑ù */
}

/* 2. Âç°ÁâáÈó¥Ë∑ù‰∏éË¥®ÊÑü */
.settings-section {
    margin-bottom: 24px !important; /* Âç°ÁâáÈó¥Ë∑ùÂ¢ûÂ§ß */
    border-radius: 16px !important; /* Êõ¥ÂúÜÊ∂¶ÁöÑËßí */
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.02) !important; /* ÊûÅËΩªÂæÆÁöÑÊÇ¨ÊµÆÊÑü */
    border: 1px solid rgba(0,0,0,0.03); /* ÊûÅÂÖ∂ÂæÆÂ¶ôÁöÑËæπÁïå */
    overflow: hidden !important;
}

/* 3. ÂàóË°®È°πÈ´òÂ∫¶‰∏éÂàÜÂâ≤Á∫ø */
.settings-item, .settings-item-block {
    padding: 18px 20px !important; /* Â¢ûÂä†ÂçïË°åÈ´òÂ∫¶Ôºå‰∏ç‰ªÖÊòØÁÇπÂáªÂå∫ÂüüÔºåÊõ¥ÊòØËßÜËßâÁïôÁôΩ */
    min-height: 56px !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05) !important; /* Á∫øÊù°Êõ¥ÁªÜÊõ¥Ê∑° */
}

/* 4. Â≠ó‰Ωì‰ºòÂåñ */
.settings-item label {
    font-size: 16px !important;
    font-weight: 500 !important; /* Áï•ÂæÆÂä†Á≤óÔºåÊèêÂçáÂ±ÇÁ∫ß */
    letter-spacing: -0.01em;
    color: #1d1d1f !important;
}

.settings-header {
    font-size: 13px !important;
    font-weight: 600 !important;
    color: #86868b !important; /* È´òÁ∫ßÁÅ∞ */
    margin: 30px 0 10px 20px !important; /* Ê†áÈ¢ò‰∏éÂç°ÁâáÁöÑË∑ùÁ¶ª */
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* 5. ÊöóÈªëÊ®°ÂºèÂæÆË∞É */
#phone-screen.dark-mode .settings-section {
    border: 1px solid rgba(255,255,255,0.05);
    background-color: #1c1c1e !important;
}
#phone-screen.dark-mode .settings-item {
    border-bottom-color: rgba(255, 255, 255, 0.08) !important;
}
#phone-screen.dark-mode .settings-item label {
    color: #f5f5f7 !important;
}
/* ========================================= */
/* ‚ñº‚ñº‚ñº CPhone Browser È´òÁ´ØÈáçÊûÑ (Swiss Style) ‚ñº‚ñº‚ñº */
/* ========================================= */

/* 1. ÊµèËßàÂô®Êï¥‰ΩìÂÆπÂô®ËÉåÊôØ */
#char-browser-screen, 
#char-browser-article-screen {
    background-color: #F2F2F7 !important; /* iOS È´òÁ∫ßÁÅ∞Â∫ïËâ≤ */
}
#phone-screen.dark-mode #char-browser-screen,
#phone-screen.dark-mode #char-browser-article-screen {
    background-color: #000000 !important;
}

/* 2. ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®ÂÆπÂô® */
#char-browser-history {
    padding: 20px !important; /* Â¢ûÂä†Â§ñËæπË∑ùÔºåËÆ©ÂÜÖÂÆπÂëºÂê∏ */
    display: flex;
    flex-direction: column;
    gap: 12px; /* Âç°Áâá‰πãÈó¥ÁöÑÂÆåÁæéÈó¥Ë∑ù */
}

/* 3. Âçï‰∏™ÂéÜÂè≤ËÆ∞ÂΩïÂç°Áâá */
.char-browser-item {
    background-color: #FFFFFF;
    padding: 16px 20px !important; /* ÂÜÖÈÉ®ÁïôÁôΩ */
    border-radius: 12px; /* Áé∞‰ª£ÊÑüÂúÜËßí */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02); /* ÊûÅËΩªÂæÆÁöÑÊÇ¨ÊµÆÊÑü */
    border: 1px solid rgba(0, 0, 0, 0.03); /* Âá†‰πé‰∏çÂèØËßÅÁöÑËæπÁïå */
    display: flex;
    align-items: center;
    gap: 16px; /* ÂõæÊ†á‰∏éÊñáÂ≠óÁöÑÈó¥Ë∑ù */
    transition: transform 0.1s, background-color 0.2s;
}
.char-browser-item:active {
    transform: scale(0.98);
    background-color: #F9F9F9;
}

/* 4. ÂàóË°®È°πÂ∑¶‰æßÂõæÊ†áÂÆπÂô® (Êõø‰ª£ Emoji) */
.char-browser-icon-box {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background-color: #F2F2F7; /* ÊµÖÁÅ∞ËÉåÊôØË°¨ÊâòÂõæÊ†á */
    display: flex;
    align-items: center;
    justify-content: center;
    color: #007AFF; /* ÁëûÂ£´Ëìù Accent Color */
    flex-shrink: 0;
}
.char-browser-icon-box svg {
    width: 20px;
    height: 20px;
    stroke-width: 2;
}

/* 5. ÂàóË°®È°πÊñáÂ≠óÂÜÖÂÆπ */
.char-browser-info {
    flex-grow: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 4px; /* Ê†áÈ¢ò‰∏éURLÁöÑÈó¥Ë∑ù */
}

.char-browser-item .title {
    font-size: 16px !important;
    font-weight: 600 !important;
    color: #1C1C1E;
    margin: 0 !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: -0.01em;
}

.char-browser-item .url {
    font-size: 12px !important;
    color: #8E8E93 !important; /* Ê¨°Ë¶Å‰ø°ÊÅØÁÅ∞Ëâ≤ */
    font-weight: 400;
    font-family: -apple-system, BlinkMacSystemFont, "SF Mono", monospace; /* ÁΩëÂùÄÁî®Á≠âÂÆΩÂ≠ó‰ΩìÊõ¥ÊúâÁßëÊäÄÊÑü */
}

/* 6. ÂàóË°®È°πÂè≥‰æßÁÆ≠Â§¥ */
.char-browser-arrow {
    color: #C7C7CC;
    flex-shrink: 0;
}

/* 7. ÊñáÁ´†ËØ¶ÊÉÖÈ°µÊéíÁâà (ÈòÖËØª‰ΩìÈ™å‰ºòÂåñ) */
#char-article-content {
    padding: 30px 24px !important; /* ÂÆΩÊïûÁöÑÈòÖËØªËæπË∑ù */
    background-color: #FFFFFF !important; /* Á∫ØÁôΩÈòÖËØªËÉåÊôØ */
    
    /* --- ‰øÆÂ§çÂºÄÂßã --- */
    /* 1. Âà†Èô§ÊàñÊ≥®ÈáäÊéâ min-height: 100%; */
    /* min-height: 100%; */ 
    
    /* 2. Ê∑ªÂä† height: 0; ÈÖçÂêà flex-grow ‰ΩøÁî®ÔºåÂº∫Âà∂ÂÆÉÂú® flex ÂÆπÂô®ÂÜÖÊªöÂä® */
    height: 0 !important; 
    
    /* 3. Á°Æ‰øù flex Â±ûÊÄßÂíåÊªöÂä®ÂºÄÂêØ */
    flex-grow: 1;
    overflow-y: auto !important;
    /* --- ‰øÆÂ§çÁªìÊùü --- */
}

/* ÊñáÁ´†Ê†áÈ¢ò */
#char-article-title {
    font-size: 17px !important; /* ÂØºËà™Ê†èÊ†áÈ¢òÂ§ßÂ∞è */
    font-weight: 600;
}

/* ÊñáÁ´†Ê≠£ÊñáÂÆπÂô®ÂÜÖÁöÑÂ§ßÊ†áÈ¢ò (Â¶ÇÊûúÊúâ) */
.article-large-title {
    font-size: 24px;
    font-weight: 700;
    color: #1C1C1E;
    margin-bottom: 16px;
    line-height: 1.3;
    letter-spacing: -0.02em;
}

/* ÊñáÁ´†Ê≠£ÊñáÊñáÂ≠ó */
#char-article-content p {
    font-size: 17px; /* ÊúÄ‰Ω≥ÈòÖËØªÂ≠óÂè∑ */
    line-height: 1.6; /* ÈªÑÈáëÊØî‰æãË°åÈ´ò */
    color: #333333;
    margin-bottom: 20px; /* ÊÆµËêΩÈó¥Ë∑ù */
    text-align: justify; /* ‰∏§Á´ØÂØπÈΩê */
}

/* ÊñáÁ´†ÂõæÁâá */
.char-browser-image-description {
    margin-top: 40px;
    padding: 40px 20px;
    background-color: #F9F9F9;
    border-radius: 12px;
    color: #666;
    font-style: italic;
    text-align: center;
    border: 1px dashed #E5E5E5;
}

/* --- ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç --- */
#phone-screen.dark-mode .char-browser-item {
    background-color: #1C1C1E;
    border-color: #333;
}
#phone-screen.dark-mode .char-browser-icon-box {
    background-color: #2C2C2E;
    color: #0A84FF;
}
#phone-screen.dark-mode .char-browser-item .title {
    color: #FFFFFF;
}
#phone-screen.dark-mode #char-article-content {
    background-color: #000000 !important;
}
#phone-screen.dark-mode .article-large-title {
    color: #FFFFFF;
}
#phone-screen.dark-mode #char-article-content p {
    color: #E0E0E0;
}
#phone-screen.dark-mode .char-browser-image-description {
    background-color: #1C1C1E;
    border-color: #333;
    color: #AAA;
}
/* ========================================= */
/* ‚ñº‚ñº‚ñº CPhone Â§áÂøòÂΩï & Êó•ËÆ∞ È´òÁ´ØÈáçÊûÑ ‚ñº‚ñº‚ñº */
/* ========================================= */

/* 1. ÂàóË°®ÂÆπÂô®ËÉåÊôØ */
#char-memo-list, #char-diary-list {
    padding: 20px !important; /* Áªü‰∏ÄÂ§ñËæπË∑ù */
    display: flex;
    flex-direction: column;
    gap: 12px; /* Âç°ÁâáÈó¥Ë∑ù */
    background-color: #F2F2F7 !important; /* Áªü‰∏ÄÂ∫ïËâ≤ */
}
#phone-screen.dark-mode #char-memo-list, 
#phone-screen.dark-mode #char-diary-list {
    background-color: #000000 !important;
}

/* 2. ÂàóË°®È°πÂç°ÁâáÊ†∑Âºè */
.memo-item, .diary-item {
    background-color: #FFFFFF;
    padding: 16px 20px !important;
    border-radius: 12px; /* Áé∞‰ª£ÊÑüÂúÜËßí */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
    border: 1px solid rgba(0, 0, 0, 0.03);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.1s, background-color 0.2s;
    cursor: pointer;
    border-bottom: 1px solid rgba(0,0,0,0.03) !important; /* Ë¶ÜÁõñÊóßÊ†∑ÂºèÁöÑËæπÊ°Ü */
}
.memo-item:active, .diary-item:active {
    transform: scale(0.98);
    background-color: #F9F9F9;
}

/* 3. ÂõæÊ†áÂÆπÂô® (Â∑¶‰æßÊñπÂΩ¢Âå∫Âüü) */
.cphone-item-icon-box {
    width: 42px;
    height: 42px;
    border-radius: 10px; /* iOS È£éÊ†ºÂúÜËßí */
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.cphone-item-icon-box svg {
    width: 22px;
    height: 22px;
    stroke-width: 2;
}

/* Â§áÂøòÂΩï‰∏ìÂ±ûÈÖçËâ≤ (ÊöñÈªÑ) */
.memo-icon-style {
    background-color: #FFF8E1; /* ÊûÅÊ∑°ÈªÑÂ∫ï */
    color: #FF9500; /* Ê¥ªÂäõÊ©ôÈªÑ */
}

/* Êó•ËÆ∞‰∏ìÂ±ûÈÖçËâ≤ (Ê∏ÖÊñ∞Áªø) */
.diary-icon-style {
    background-color: #E8F5E9; /* ÊûÅÊ∑°ÁªøÂ∫ï */
    color: #34C759; /* ËãπÊûúÁªø */
}

/* 4. ‰∏≠Èó¥ÊñáÂ≠óÂå∫Âüü */
.cphone-item-info {
    flex-grow: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.cphone-item-title {
    font-size: 16px !important;
    font-weight: 600 !important;
    color: #1C1C1E;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: -0.01em;
}

.cphone-item-preview {
    font-size: 13px !important;
    color: #8E8E93 !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 400;
    line-height: 1.3;
}

/* 5. Âè≥‰æßÂÖÉÁ¥† (ÁÆ≠Â§¥ÊàñÊó∂Èó¥) */
.cphone-item-arrow {
    color: #C7C7CC;
    flex-shrink: 0;
}

/* --- ËØ¶ÊÉÖÈ°µÈáçÊûÑ --- */

/* Â§áÂøòÂΩïËØ¶ÊÉÖÈ°µ */
#char-memo-detail-screen .form-container {
    padding: 20px !important;
    background-color: #F2F2F7 !important;
    height: 100%;
    box-sizing: border-box;
}
#char-memo-detail-content {
    background-color: #FFFFFF !important;
    border-radius: 12px;
    padding: 24px !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: #1C1C1E !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.02);
    border: 1px solid rgba(0,0,0,0.03);
    height: 100% !important;
    resize: none;
    outline: none;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
}

/* Êó•ËÆ∞ËØ¶ÊÉÖÈ°µ */
#char-diary-detail-screen {
    background-color: #F2F2F7 !important;
}
#char-diary-detail-content-wrapper {
    padding: 20px !important;
    background: transparent !important;
}
#char-diary-detail-content {
    /* Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂È´òÂ∫¶Ëá™Âä®ÔºåÈöèÊñáÂ≠óÊíëÂºÄ */
    height: auto !important; 
    
    /* ‰øùÊåÅÊúÄÂ∞èÈ´òÂ∫¶ÔºåÂÜÖÂÆπÂ∞ëÊó∂‰πüÂ•ΩÁúã */
    min-height: 80vh; 
    
    /* Á°Æ‰øùËÉåÊôØËâ≤ÂíåÂúÜËßíÂÆåÊï¥ÂåÖË£πÂÜÖÂÆπ */
    background-color: #FFFFFF !important;
    border-radius: 12px;
    
    /* ‰ºòÂåñÂÜÖËæπË∑ù */
    padding: 32px 28px 60px 28px !important; /* Â∫ïÈÉ®Â¢ûÂä†ÂÜÖËæπË∑ùÔºåÈò≤Ê≠¢ÊñáÂ≠óË¥¥Â∫ï */
    
    /* ËßÜËßâÊ†∑Âºè */
    box-shadow: 0 2px 15px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.03);
    font-family: "Georgia", "Songti SC", serif !important;
    color: #333 !important;
    line-height: 1.8 !important;
    
    /* Èò≤Ê≠¢ÂÆΩÂ∫¶Ê∫¢Âá∫ */
    width: 100%;
    box-sizing: border-box;
    overflow: visible !important;
}

/* Á°Æ‰øùÂ§ñÂ±ÇÂÆπÂô®ÂÖÅËÆ∏ÊªöÂä®‰∏îÂ∏ÉÂ±ÄÊ≠£Á°Æ */
#char-diary-detail-content-wrapper {
    padding: 20px !important;
    background: transparent !important;
    overflow-y: auto !important; /* Á°Æ‰øùÁ´ñÂêëÊªöÂä®Êù°Âú® wrapper ‰∏ä */
    display: block !important;    /* Èò≤Ê≠¢ Flex Â∏ÉÂ±ÄÊüê‰∫õÊÉÖÂÜµ‰∏ãÂéãÁº©Â≠êÂÖÉÁ¥†È´òÂ∫¶ */
}

/* --- ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç --- */
#phone-screen.dark-mode .memo-item,
#phone-screen.dark-mode .diary-item {
    background-color: #1C1C1E;
    border-color: #333;
}
#phone-screen.dark-mode .cphone-item-title {
    color: #FFFFFF;
}
#phone-screen.dark-mode .memo-icon-style {
    background-color: #332A15; /* Ê∑±ÈªÑËÉåÊôØ */
    color: #FFD60A;
}
#phone-screen.dark-mode .diary-icon-style {
    background-color: #1A3021; /* Ê∑±ÁªøËÉåÊôØ */
    color: #30D158;
}
#phone-screen.dark-mode #char-memo-detail-screen .form-container,
#phone-screen.dark-mode #char-diary-detail-screen {
    background-color: #000000 !important;
}
#phone-screen.dark-mode #char-memo-detail-content,
#phone-screen.dark-mode #char-diary-detail-content {
    background-color: #1C1C1E !important;
    color: #E0E0E0 !important;
    border-color: #333;
}
#phone-screen.dark-mode #char-diary-detail-content > p:first-of-type {
    color: #FFFFFF !important;
    border-bottom-color: #333;
}
/* 1. Â§ñÂ±ÇÂÆπÂô®ÔºöËê•ÈÄ†Ê≤âÊµ∏ÂºèÈòÖËØªÁéØÂ¢É */
#char-diary-detail-screen {
    background-color: #F2F2F7 !important; /* iOS Á≥ªÁªüÁ∫ßÊµÖÁÅ∞ËÉåÊôØÔºåÊèê‰æõËßÜËßâÊîØÊíë */
}
#phone-screen.dark-mode #char-diary-detail-screen {
    background-color: #000000 !important;
}

/* 2. ÊªöÂä®Âå∫Âüü */
#char-diary-detail-content-wrapper {
    padding: 20px 16px !important; /* ÁßªÂä®Á´Ø‰∏§‰æßÁïôÂá∫ÂêàÈÄÇÁöÑÂëºÂê∏Á©∫Èó¥ */
    background: transparent !important;
    box-sizing: border-box;
}

/* 3. Êó•ËÆ∞Á∫∏Âº†Êú¨‰Ωì (Ê†∏ÂøÉ‰øÆÊîπ) */
#char-diary-detail-content {
    background-color: #FFFFFF !important;
    border-radius: 16px; /* Êõ¥ÂúÜÊ∂¶„ÄÅÂèãÂ•ΩÁöÑÂúÜËßí */
    /* ÁßªÈô§ÊòæÁúºÁöÑËæπÊ°ÜÔºåÊîπÁî®ÊûÅËΩªÊüîÁöÑÂº•Êï£Èò¥ÂΩ±ÔºåËê•ÈÄ†ÊÇ¨ÊµÆÊÑü */
    border: none !important;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
    
    /* ÂÜÖÈÉ®ÁïôÁôΩÔºöÂÉèÈ´òÁ∫ßÊùÇÂøó‰∏ÄÊ†∑ÁöÑÊéíÁâà */
    padding: 32px 24px 48px 24px !important;
    
    /* Â≠ó‰ΩìËÆæÁΩÆÔºöÂõûÂΩíÁ≥ªÁªüÂéüÁîüÔºåËøΩÊ±ÇÊûÅËá¥Ê∏ÖÊô∞ */
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Songti SC", serif !important; 
    color: #1D1D1F !important; /* Apple Ê∑±ÁÇ≠ÁÅ∞ÔºåÊØîÁ∫ØÈªëÊõ¥Êä§Áúº */
    
    min-height: 85vh; /* ‰øùËØÅÁ∫∏Âº†ÈïøÂ∫¶ÔºåÂç≥‰ΩøÂÜÖÂÆπÂ∞ë‰πü‰∏çÊòæÂæóÂçïËñÑ */
    box-sizing: border-box;
}

/* 4. Ê†áÈ¢ò/Êó•Êúü (ÊÇ®ËßâÂæóÂ§™Â§ßÁöÑÈÇ£‰∏™Â≠ó) - ÈáçÊûÑ‰∏∫‚ÄúÁúâÊâπ‚ÄùÈ£éÊ†º */
#char-diary-detail-content > p:first-of-type {
    /* Âç≥‰ΩøÊòØÊ†áÈ¢òÔºå‰πü‰∏çÈúÄË¶ÅÂ∑®Â§ß„ÄÇÁ≤æËá¥ > Â∑®Â§ß */
    font-size: 15px !important; 
    font-weight: 600 !important;
    color: #86868B !important; /* ‰ΩøÁî®È´òÁ∫ß‰∏≠ÁÅ∞Ëâ≤ÔºåÈôç‰ΩéËßÜËßâÂπ≤Êâ∞ */
    text-transform: uppercase; /* Â¢ûÂä†‰∏ÄÁÇπÂΩ¢ÂºèÊÑü */
    letter-spacing: 0.05em; /* Â¢ûÂä†Â≠óÈó¥Ë∑ùÔºåÂ¢ûÂä†ÈÄèÊ∞îÊÑü */
    
    margin-top: 0 !important;
    margin-bottom: 24px !important; /* Ê†áÈ¢ò‰∏éÊ≠£ÊñáÁöÑÂÆåÁæéË∑ùÁ¶ª */
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05); /* ÊûÅÁªÜÁöÑÂàÜÈöîÁ∫ø */
    text-align: left !important;
}

#char-diary-detail-content p {
     
    line-height: 1.6 !important; 
    
    /* Ê†∏ÂøÉ‰øÆÊîπÔºöÂáèÂ∞èÊÆµËêΩÈó¥Ë∑ù */
    margin-bottom: 1px !important; /* ‰ªé 16px ÂáèÂ∞èÂà∞ 8pxÔºåÊõ¥Âä†Á¥ßÂáë */
    margin-top: 0 !important;      /* Âº∫Âà∂ÂéªÈô§È°∂ÈÉ®Èó¥Ë∑ùÔºåÈò≤Ê≠¢Âè†Âä† */
    
    text-align: justify; 
    letter-spacing: -0.01em; 
}

/* 6. ÁâπÊÆäÊ†ºÂºè‰øÆÈ•∞ (‰øùÊåÅÈ£éÊ†ºÁªü‰∏Ä) */
#char-diary-detail-content strong {
    font-weight: 600;
    color: #000;
}

/* ÈáçÁÇπÈ´ò‰∫ÆÔºöÊîπ‰∏∫ËçßÂÖâÁ¨îÈ£éÊ†ºÔºåËÄåÈùûÁÆÄÂçïÁöÑËÉåÊôØËâ≤ */
#char-diary-detail-content .diary-highlight {
    background: linear-gradient(120deg, rgba(255, 214, 10, 0.3) 0%, rgba(255, 214, 10, 0.3) 100%);
    background-position: 0 88%;
    background-size: 100% 0.4em; /* Âè™È´ò‰∫Æ‰∏ãÂçäÈÉ®ÂàÜ */
    background-repeat: no-repeat;
    padding: 0;
    border-radius: 0;
}

/* --- ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç (Ê∑±ÈÇÉÊ®°Âºè) --- */
#phone-screen.dark-mode #char-diary-detail-content {
    background-color: #1C1C1E !important; /* Ê∑±ÁÅ∞Âç°Áâá */
    color: #F5F5F7 !important; /* ÊüîÁôΩÊñáÂ≠ó */
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
}

#phone-screen.dark-mode #char-diary-detail-content > p:first-of-type {
    color: #98989D !important;
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

#phone-screen.dark-mode #char-diary-detail-content .diary-highlight {
    background: rgba(255, 214, 10, 0.2); /* ÊöóÈªëÊ®°Âºè‰∏ãÊîπ‰∏∫ÂÖ®ËÉåÊôØÊ∑°Ê∑°È´ò‰∫Æ */
    background-size: 100% 100%;
    border-radius: 4px;
}
/* =================================================== */
/* ‚ñº‚ñº‚ñº CPhone ÁªàÊûÅÂõ∫ÂÆöÂ∏ÉÂ±Ä (‰ªø iOS È´òÁ∫ßË¥®ÊÑü) ‚ñº‚ñº‚ñº */
/* =================================================== */

#cphone-layout-container {
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    gap: 25px; /* Ë°å‰∏éË°å‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    width: 100%;
    box-sizing: border-box;
    align-items: center; /* Êï¥‰ΩìÂ±Ö‰∏≠ */
}

/* --- ÈÄöÁî®Ë°åÂ∏ÉÂ±ÄÔºöÂ∑¶Âè≥ÊéíÂàó --- */
.cphone-fixed-row {
    display: flex;
    justify-content: space-between;
    width: 100%;
    max-width: 340px; /* ÈôêÂà∂ÊúÄÂ§ßÂÆΩÂ∫¶ÔºåÈò≤Ê≠¢Âú®Â§ßÂ±è‰∏äÊï£ÂºÄ */
}

/* --- 1. È°∂ÈÉ®ÈîôËêΩÊ∞îÊ≥° --- */
.cphone-staggered-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 340px;
}

.cphone-bubble-pill {
    width: 85%; /* ‰∏çÂç†Êª°ÔºåÁïôÂá∫Á©∫ÈöôÊòæÁ§∫ÈîôËêΩÊÑü */
    height: 55px;
    border-radius: 28px;
    padding: 5px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-sizing: border-box;
    
    /* ÁéªÁíÉÊãüÊÄÅ */
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* Â∑¶‰æßÊ∞îÊ≥°Èù†Â∑¶ */
.cphone-bubble-pill.left {
    align-self: flex-start;
    border-bottom-left-radius: 4px; /* Á®çÂæÆÊîπÂèò‰∏ÄÁÇπÂΩ¢Áä∂Â¢ûÂä†ËÆæËÆ°ÊÑü */
}

/* Âè≥‰æßÊ∞îÊ≥°Èù†Âè≥ */
.cphone-bubble-pill.right {
    align-self: flex-end;
    flex-direction: row-reverse; /* Â§¥ÂÉèÂú®Âè≥Ëæπ */
    border-top-right-radius: 4px;
}

.bubble-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.8);
    object-fit: cover;
    flex-shrink: 0;
}
.bubble-content {
    flex-grow: 1;
    overflow: hidden;
}
.bubble-content p {
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 13px;
    font-weight: 500;
}

/* --- 2. Âõ∫ÂÆöÂ§ßÂ∞èÁöÑ App ÁΩëÊ†º (2x2) --- */
.cphone-fixed-app-grid {
    width: 155px;  /* Âº∫Âà∂Âõ∫ÂÆöÂÆΩÂ∫¶ÔºÅ */
    height: 155px; /* Âº∫Âà∂Âõ∫ÂÆöÈ´òÂ∫¶ÔºÅ */
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 10px 15px; /* Ë°åÈó¥Ë∑ù10ÔºåÂàóÈó¥Ë∑ù15 */
    justify-items: center;
    align-items: center;
}

/* Ë∞ÉÊï¥ÂõæÊ†áÂ§ßÂ∞è‰ª•ÈÄÇÂ∫îÁ¥ßÂáëÂ∏ÉÂ±Ä */
.cphone-fixed-app-grid .app-icon.small {
    width: 60px; /* ÈôêÂà∂Êï¥‰ΩìÁÇπÂáªÂå∫Âüü */
}
.cphone-fixed-app-grid .app-icon.small .icon-bg {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    margin-bottom: 4px;
    /* Á°Æ‰øùÂõæÊ†á‰∏ç‰ºöË¢´Êãâ‰º∏ */
    min-width: 56px; 
}
.cphone-fixed-app-grid .app-icon.small .label {
    font-size: 11px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.6);
}

/* --- 3. Â†ÜÂè†ÊãçÁ´ãÂæóÁªÑ‰ª∂ --- */
.cphone-stack-polaroid-widget {
    width: 155px; /* Âõ∫ÂÆöÂ§ßÂ∞è */
    height: 155px;
    position: relative; /* Áî®‰∫éÁªùÂØπÂÆö‰ΩçÂ≠êÂÖÉÁ¥† */
}

.polaroid-stack-layer {
    width: 140px;
    height: 160px;
    background-color: #fff;
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 8px 25px 8px; /* Â∫ïÈÉ®ÁïôÁôΩ */
    box-sizing: border-box;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    border-radius: 2px;
    transition: transform 0.3s ease;
}

/* Â∫ïÂ±ÇÁÖßÁâáÔºöÊóãËΩ¨ */
.polaroid-stack-layer.back {
    transform: translateX(-50%) rotate(-6deg);
    z-index: 1;
    background-color: #f0f0f0; /* Á®çÂæÆÊöó‰∏ÄÁÇπ */
}

/* È°∂Â±ÇÁÖßÁâáÔºöÁ®çÂæÆÂèçÂêëÊóãËΩ¨ */
.polaroid-stack-layer.front {
    transform: translateX(-50%) rotate(3deg) translateY(-5px);
    z-index: 2;
}

/* ÊÇ¨ÂÅúÊïàÊûúÔºöÊï£ÂºÄ */
.cphone-stack-polaroid-widget:hover .polaroid-stack-layer.back {
    transform: translateX(-65%) rotate(-12deg);
}
.cphone-stack-polaroid-widget:hover .polaroid-stack-layer.front {
    transform: translateX(-35%) rotate(8deg) scale(1.05);
}

.polaroid-inner {
    width: 100%;
    height: 100%;
    background: #eee;
    overflow: hidden;
}
.polaroid-inner img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* --- 4. ÂúÜÂΩ¢ÁªÑ‰ª∂ --- */
.cphone-circle-widget-container {
    width: 155px;
    height: 155px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    
    /* ËÉåÊôØÊùø */
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.3);
}

.cphone-circle-widget {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid rgba(255,255,255,0.9);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-bottom: 8px;
}
.cphone-circle-widget img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.circle-deco-text p {
    margin: 0;
    font-size: 12px;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.4);
    font-family: "Georgia", serif; /* Ë°¨Á∫ø‰ΩìÊõ¥ÊñáËâ∫ */
    font-style: italic;
}
.circle-deco-line {
    width: 30px;
    height: 2px;
    background: rgba(255,255,255,0.6);
    margin: 4px auto 0 auto;
    border-radius: 2px;
}

/* --- Dock Ê†è‰ºòÂåñ --- */
.cphone-dock-container {
    padding: 0 15px;
    margin-bottom: calc(25px + env(safe-area-inset-bottom));
    margin-top: auto;
    width: 100%;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
}

.cphone-dock.glass {
    background: rgba(40, 40, 40, 0.4); /* Ê∑±Ëâ≤ÂçäÈÄèÊòéDockÔºåÂÉèiOS */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 32px;
    padding: 18px 20px;
    width: 100%;
    max-width: 340px; /* ÈôêÂà∂DockÊúÄÂ§ßÂÆΩÂ∫¶ */
    display: flex;
    justify-content: space-between;
}

.cphone-dock .app-icon .icon-bg {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    margin-bottom: 0; /* DockÈáå‰∏çË¶ÅÊñáÂ≠óÔºåÊâÄ‰ª•‰∏çÈúÄË¶Å‰∏ãËæπË∑ù */
}
.cphone-dock .app-icon .label {
    display: none; /* ÈöêËóèDockÊñáÂ≠ó */
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .cphone-bubble-pill {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.1);
}
#phone-screen.dark-mode .polaroid-stack-layer {
    background-color: #333; /* ÊãçÁ´ãÂæóÁôΩËæπÂèòÈªë */
}
/* =================================================== */
/* ‚ñº‚ñº‚ñº CPhone È´òÁ∫ßÂõ∫ÂÆöÂ∏ÉÂ±Ä V3 (ÂÆåÁæéÂ§çÂàªÁâà) ‚ñº‚ñº‚ñº */
/* =================================================== */

#cphone-layout-container {
    display: flex;
    flex-direction: column;
    align-items: center; /* Âº∫Âà∂Â±Ö‰∏≠ */
    gap: 20px;
    width: 100%;
}

/* --- 1. ÈîôËêΩÊ∞îÊ≥°ÁªÑ --- */
.cphone-staggered-group {
    display: flex;
    flex-direction: column;
    gap: 8px; /* ‰∏§‰∏™Ê∞îÊ≥°‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    width: 330px; /* ÈîÅÂÆöÊÄªÂÆΩÂ∫¶ */
}

.cphone-bubble-pill {
    width: 290px; /* Âõ∫ÂÆöÊ∞îÊ≥°ÈïøÂ∫¶ */
    height: 60px; /* Âõ∫ÂÆöÊ∞îÊ≥°È´òÂ∫¶ */
    border-radius: 30px; /* ËÉ∂ÂõäÂΩ¢Áä∂ */
    display: flex;
    align-items: center;
    padding: 5px 8px;
    box-sizing: border-box;
    
    /* ÁéªÁíÉË¥®ÊÑüÂ§çÂàª */
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.35);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

/* ‰∏äÊñπÊ∞îÊ≥°ÔºöÈù†Â∑¶ */
.cphone-bubble-pill.top {
    align-self: flex-start; 
}

/* ‰∏ãÊñπÊ∞îÊ≥°ÔºöÈù†Âè≥ */
.cphone-bubble-pill.bottom {
    align-self: flex-end;
    justify-content: flex-end; /* ÂÜÖÂÆπÈù†Âè≥ */
}

/* Â§¥ÂÉèÂÆπÂô® (Â∏¶ÁôΩËæπ) */
.bubble-avatar-container {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: rgba(255,255,255,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.bubble-avatar-container img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
}

/* Ê∞îÊ≥°ÊñáÂ≠óÂÜÖÂÆπÂå∫Âüü */
.bubble-content {
    flex-grow: 1;
    display: flex;
    align-items: center;
    padding: 0 10px;
    gap: 5px;
    overflow: hidden;
}

.bubble-content.left-align {
    justify-content: flex-start;
}
.bubble-content.right-align {
    justify-content: flex-end;
    text-align: right;
}

.bubble-content p {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.bubble-deco-icon {
    font-size: 16px;
    opacity: 0.9;
}

/* --- ÈÄöÁî®Âõ∫ÂÆöË°å (ÈîÅÊ≠ªÂÆΩÂ∫¶) --- */
.cphone-fixed-row {
    display: flex;
    justify-content: space-between;
    width: 330px; /* ÈîÅÊ≠ªË°åÂÆΩ */
}

/* --- 2. App ÁΩëÊ†º (2x2 Âõ∫ÂÆö) --- */
.cphone-fixed-app-grid {
    width: 150px;
    height: 150px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 8px 15px;
    justify-items: center;
    align-items: start;
}
.app-icon.small .icon-bg {
    width: 54px;
    height: 54px;
    border-radius: 13px;
    margin-bottom: 3px;
    min-width: 54px; /* Èò≤Ê≠¢ÂéãÁº© */
}
.app-icon.small .label {
    font-size: 11px;
}

/* --- 3. Â†ÜÂè†ÊãçÁ´ãÂæó (Â§çÂàª) --- */
.cphone-stack-polaroid {
    width: 150px;
    height: 150px;
    position: relative;
}

/* Â∫ïÂ±ÇÁÖßÁâá (ÂÄæÊñú) */
.polaroid-bg-layer {
    width: 125px;
    height: 140px;
    background-color: #fff;
    position: absolute;
    top: 5px;
    left: 10px;
    transform: rotate(-6deg);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 3px;
    z-index: 1;
}

/* È°∂Â±ÇÁÖßÁâá (‰∏ªÂõæ) */
.polaroid-main-layer {
    width: 125px;
    height: 145px;
    background-color: #fff;
    position: absolute;
    top: 0;
    left: 15px; /* Á®çÂæÆÈîô‰Ωç */
    transform: rotate(3deg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    border-radius: 3px;
    z-index: 2;
    padding: 8px 8px 25px 8px; /* ÁªèÂÖ∏ÁöÑÊãçÁ´ãÂæóÁïôÁôΩ */
    box-sizing: border-box;
    transition: transform 0.2s;
}

.polaroid-main-layer:hover {
    transform: rotate(0deg) scale(1.05) translateY(-5px);
    z-index: 10;
}

.polaroid-photo-frame {
    width: 100%;
    height: 100%;
    background-color: #eee;
    overflow: hidden;
}
.polaroid-photo-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* --- 4. ÂúÜÂΩ¢ÁªÑ‰ª∂ (Â§çÂàª) --- */
.cphone-circle-widget-wrapper {
    width: 150px;
    height: 150px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
}

.cphone-circle-bg {
    width: 75px;
    height: 75px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid rgba(255,255,255,0.9);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    margin-bottom: 8px;
}
.cphone-circle-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.circle-text-area p {
    margin: 0;
    font-size: 12px;
    color: #fff;
    font-family: "Georgia", serif;
    font-style: italic;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.line-deco {
    width: 40px;
    height: 2px;
    background: rgba(255,255,255,0.5);
    margin: 4px auto 0 auto;
    border-radius: 2px;
    position: relative;
}
/* Âä†‰∏§‰∏™Â∞èÁÇπÂú®Ë£ÖÈ•∞Á∫ø‰∏§Á´Ø */
.line-deco::before, .line-deco::after {
    content: '';
    position: absolute;
    width: 4px;
    height: 4px;
    background: white;
    border-radius: 50%;
    top: -1px;
}
.line-deco::before { left: -2px; }
.line-deco::after { right: -2px; }

/* --- Dock Ê†è (‰øùÊåÅ‰∏çÂèò‰ΩÜÁ°Æ‰øùÂÆΩÂ∫¶) --- */
.cphone-dock-container {
    padding: 0;
    margin-top: auto;
    margin-bottom: calc(25px + env(safe-area-inset-bottom));
    width: 100%;
    display: flex;
    justify-content: center;
}

.cphone-dock {
    width: 330px; /* ÈîÅÊ≠ªÂÆΩÂ∫¶ */
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .cphone-bubble-pill,
#phone-screen.dark-mode .cphone-circle-widget-wrapper {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.1);
}
#phone-screen.dark-mode .polaroid-bg-layer,
#phone-screen.dark-mode .polaroid-main-layer {
    background-color: #2c2c2e;
}
/* --- 1. ÈîôËêΩÊ∞îÊ≥°ÁªÑ (Â∏¶ÂÄæÊñú) --- */
.cphone-staggered-group {
    display: flex;
    flex-direction: column;
    /* gap: 8px;  <-- ÁßªÈô§Ëøô‰∏™ gapÔºåÊîπÁî® margin ÊéßÂà∂ */
    width: 330px;
    padding: 10px 0; /* Â¢ûÂä†‰∏ä‰∏ãÂÜÖËæπË∑ùÔºåÁªôÂÄæÊñúÁïôÁ©∫Èó¥ */
}

.cphone-bubble-pill {
    width: 290px;
    height: 60px;
    border-radius: 30px;
    display: flex;
    align-items: center;
    padding: 5px 8px;
    box-sizing: border-box;
    
    /* ÁéªÁíÉË¥®ÊÑü */
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.35);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.15);
    
    /* ËÆ©ÊóãËΩ¨Êõ¥Âπ≥Êªë */
    transform-origin: center center;
    backface-visibility: hidden; 
}

/* ‰∏äÊñπÊ∞îÊ≥°ÔºöÈù†Â∑¶ + Âêë‰∏äÂÄæÊñú */
.cphone-bubble-pill.top {
    align-self: flex-start;
    transform: rotate(-3deg); /* ÂÖ≥ÈîÆÔºöÊóãËΩ¨ËßíÂ∫¶ */
    margin-bottom: -8px; /* Âêë‰∏äÊãâËøëË∑ùÁ¶ª */
    z-index: 2; /* Á®çÂæÆÂè†Âú®‰∏äÈù¢‰∏ÄÁÇπ */
}

/* ‰∏ãÊñπÊ∞îÊ≥°ÔºöÈù†Âè≥ + Âêë‰∏ãÂÄæÊñú */
.cphone-bubble-pill.bottom {
    align-self: flex-end;
    justify-content: flex-end;
    transform: rotate(2deg); /* ÂÖ≥ÈîÆÔºöÊóãËΩ¨ËßíÂ∫¶ */
    margin-top: -5px;
    z-index: 1;
}

/* ... (Â§¥ÂÉèÂÆπÂô®ÈÉ®ÂàÜ‰øùÊåÅ‰∏çÂèò) ... */
.bubble-avatar-container {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: rgba(255,255,255,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.bubble-avatar-container img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
}

/* Ê∞îÊ≥°ÊñáÂ≠óÂÜÖÂÆπÂå∫Âüü */
.bubble-content {
    flex-grow: 1;
    display: flex;
    align-items: center;
    padding: 0 10px;
    gap: 5px;
    overflow: hidden;
    cursor: text; /* Èº†Ê†áÊîæ‰∏äÂéªÊòæÁ§∫ÂèØËæìÂÖ•Áä∂ÊÄÅ */
}

/* ÁºñËæëÊó∂ÁöÑËæìÂÖ•Ê°ÜÊ†∑Âºè */
.bubble-edit-input {
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 4px;
    color: #fff;
    padding: 4px;
    width: 100%;
    outline: none;
    text-shadow: none;
}
/* =================================================== */
/* ‚ñº‚ñº‚ñº CPhone Â∏ÉÂ±Ä‰øÆÊ≠£ V4 (ÂÄæÊñú+Â§ñÊ°Ü+ÁºñËæë‰øÆÂ§ç) ‚ñº‚ñº‚ñº */
/* =================================================== */

#cphone-layout-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
}

/* --- 1. È°∂ÈÉ®Ê∞îÊ≥° (ÂÄæÊñú‰øÆÊ≠£) --- */
.cphone-staggered-group {
    display: flex;
    flex-direction: column;
    width: 330px;
    /* ÁªôÊóãËΩ¨ÁïôÂá∫‰∏ä‰∏ãÁ©∫Èó¥ÔºåÈò≤Ê≠¢Ë¢´ÂàáÊéâ */
    padding: 15px 0; 
    position: relative;
}

.cphone-bubble-pill {
    width: 290px;
    height: 60px;
    border-radius: 35px; /* Êõ¥ÂúÜÊ∂¶ */
    display: flex;
    align-items: center;
    padding: 5px 8px;
    box-sizing: border-box;
    
    /* ÁéªÁíÉË¥®ÊÑü */
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    
    /* Ê†∏ÂøÉÔºöÊóãËΩ¨Âü∫ÁÇπ */
    transform-origin: center;
    transition: transform 0.3s ease;
}

/* ‰∏äÊñπÊ∞îÊ≥°ÔºöÂêëÂ∑¶‰∏äÂÄæÊñú (-3Â∫¶) */
.cphone-bubble-pill.top {
    align-self: flex-start;
    transform: rotate(-3deg); 
    margin-bottom: -10px; /* ÊãâËøëË∑ùÁ¶ª */
    z-index: 2;
    margin-left: 5px;
}

/* ‰∏ãÊñπÊ∞îÊ≥°ÔºöÂêëÂè≥‰∏ãÂÄæÊñú (2Â∫¶) */
.cphone-bubble-pill.bottom {
    align-self: flex-end;
    justify-content: flex-end; /* ÂÜÖÂÆπÈù†Âè≥ */
    transform: rotate(2deg); 
    margin-top: -5px;
    z-index: 1;
    margin-right: 5px;
}

/* ÁºñËæëÊó∂ÁöÑËæìÂÖ•Ê°ÜÊ†∑Âºè (‰øÆÂ§çÊñáÂ≠óÊó†Ê≥ï‰øÆÊîπÁöÑÈóÆÈ¢ò) */
.bubble-edit-input {
    background: rgba(0, 0, 0, 0.1);
    border: none;
    border-radius: 4px;
    color: #fff;
    padding: 2px 5px;
    font-size: inherit;
    font-family: inherit;
    width: 100%;
    outline: none;
}

/* Â§¥ÂÉèÂÆπÂô® */
.bubble-avatar-container {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(255,255,255,0.7); /* ÂçäÈÄèÊòéÁôΩÂ∫ï */
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.8);
}
.bubble-avatar-container img {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
}

/* ÊñáÂ≠óÂå∫Âüü */
.bubble-content {
    flex-grow: 1;
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 6px;
    overflow: hidden;
    cursor: text; /* ÊèêÁ§∫ÂèØÁºñËæë */
}
.bubble-content.left-align { justify-content: flex-start; }
.bubble-content.right-align { justify-content: flex-end; text-align: right; }

.bubble-content p {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    pointer-events: none; /* ËÆ©ÁÇπÂáªÁ©øÈÄèÂà∞Áà∂ÂÆπÂô®ÔºåËß¶Âèëonclick */
}

.bubble-deco-icon { font-size: 14px; opacity: 0.9; }

/* --- 2. App ÁΩëÊ†º (‰øùÊåÅÂõ∫ÂÆö) --- */
.cphone-fixed-row {
    display: flex;
    justify-content: space-between;
    width: 330px;
}
.cphone-fixed-app-grid {
    width: 150px;
    height: 150px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 8px 15px;
    justify-items: center;
    align-items: start;
}
.app-icon.small .icon-bg {
    width: 54px;
    height: 54px;
    border-radius: 13px;
    margin-bottom: 3px;
    min-width: 54px;
}
.app-icon.small .label { font-size: 11px; }

/* --- 3. ÊãçÁ´ãÂæó (‰øùÊåÅÂ†ÜÂè†) --- */
.cphone-stack-polaroid {
    width: 150px;
    height: 150px;
    position: relative;
}
.polaroid-bg-layer {
    width: 125px;
    height: 140px;
    background-color: #f5f5f5;
    position: absolute;
    top: 5px;
    left: 10px;
    transform: rotate(-6deg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 2px;
    z-index: 1;
    border: 1px solid #eee;
}
.polaroid-main-layer {
    width: 125px;
    height: 145px;
    background-color: #fff;
    position: absolute;
    top: 0;
    left: 15px;
    transform: rotate(4deg);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    border-radius: 2px;
    z-index: 2;
    padding: 8px 8px 25px 8px;
    box-sizing: border-box;
    transition: transform 0.2s;
}
.polaroid-main-layer:hover {
    transform: rotate(0deg) scale(1.05) translateY(-5px);
    z-index: 10;
}
.polaroid-photo-frame {
    width: 100%;
    height: 100%;
    background-color: #eee;
    overflow: hidden;
}
.polaroid-photo-frame img { width: 100%; height: 100%; object-fit: cover; }

/* --- 4. ÂúÜÂΩ¢ÁªÑ‰ª∂ (Â§ñÊ°Ü‰øÆÂ§ç) --- */
.cphone-circle-widget-wrapper {
    width: 150px;
    height: 150px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* „Äê‰øÆÂ§ç„ÄëÂúÜÂΩ¢ÂõæÁâáÁöÑÂ§ñÊ°Ü */
.cphone-circle-bg {
    width: 75px;
    height: 75px;
    border-radius: 50%;
    overflow: hidden;
    /* ËøôÈáåÂä†Á≤ó‰∫ÜËæπÊ°ÜÔºåÂπ∂‰∏î‰ΩøÁî®‰∫ÜÁ∫ØÁôΩËâ≤ */
    border: 3px solid #ffffff; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* Â¢ûÂä†Èò¥ÂΩ±ËÆ©ÁôΩËæπÊõ¥ÊòéÊòæ */
    margin-bottom: 8px;
    background-color: #fff;
}
.cphone-circle-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.circle-text-area p {
    margin: 0;
    font-size: 12px;
    color: #fff;
    font-family: "Georgia", serif;
    font-style: italic;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.line-deco {
    width: 30px;
    height: 2px;
    background: rgba(255,255,255,0.8);
    margin: 5px auto 0 auto;
    border-radius: 2px;
    position: relative;
}
.line-deco::before, .line-deco::after {
    content: '';
    position: absolute;
    width: 4px;
    height: 4px;
    background: white;
    border-radius: 50%;
    top: -1px;
}
.line-deco::before { left: -3px; }
.line-deco::after { right: -3px; }

/* --- Dock --- */
.cphone-dock-container {
    padding: 0;
    margin-top: auto;
    margin-bottom: calc(25px + env(safe-area-inset-bottom));
    width: 100%;
    display: flex;
    justify-content: center;
}
.cphone-dock { width: 330px; }

/* ÊöóÈªëÊ®°Âºè */
#phone-screen.dark-mode .cphone-bubble-pill,
#phone-screen.dark-mode .cphone-circle-widget-wrapper {
    background: rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.1);
}
#phone-screen.dark-mode .cphone-circle-bg {
    border-color: rgba(255, 255, 255, 0.8); /* ÊöóÈªëÊ®°Âºè‰∏ãÁ®çÂæÆÊöó‰∏ÄÁÇπÁöÑÁôΩ */
}
/* ================================================== */
/* ‚ñº‚ñº‚ñº CPhone ÁïåÈù¢Áªü‰∏ÄÂåñ‰øÆÂ§çË°•‰∏Å (ÂéªÈô§Â§ñÊ°Ü + ÊîæÂ§ßÂõæÊ†á) ‚ñº‚ñº‚ñº */
/* ================================================== */

/* 1. „ÄêÂ∑¶‰æßÁªÑ‰ª∂„ÄëÂéªÈô§ÂúÜÂΩ¢ÁªÑ‰ª∂ÁöÑ"‰∏ë"Â§ñÊ°Ü */
.cphone-circle-widget-wrapper {
    background: transparent !important;       /* ÂéªÊéâËÉåÊôØËâ≤ */
    border: none !important;                  /* ÂéªÊéâËæπÊ°ÜÁ∫ø */
    backdrop-filter: none !important;         /* ÂéªÊéâÁ£®Á†ÇÁéªÁíÉ */
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;              /* ÂéªÊéâÈò¥ÂΩ± */
}

/* ‰ºòÂåñÂéªÈô§Â§ñÊ°ÜÂêéÁöÑÊñáÂ≠óÊòæÁ§∫ (Âä†Âº∫Èò¥ÂΩ±ÔºåÈò≤Ê≠¢Áúã‰∏çÊ∏Ö) */
.circle-text-area p {
    text-shadow: 0 1px 4px rgba(0,0,0,0.8) !important;
    font-weight: 500 !important;
}
/* ÂéªÈô§Ë£ÖÈ•∞Á∫ø (Êó¢ÁÑ∂‰∏çË¶ÅÊ°Ü‰∫ÜÔºåË£ÖÈ•∞Á∫øÊÇ¨Á©∫‰ºöÂæàÊÄ™) */
.line-deco {
    display: none !important; 
}

/* 2. „ÄêÂõæÊ†áÂ§ßÂ∞è„ÄëÊîæÂ§ß CPhone ÂõæÊ†á (ÂØπÈΩê EPhone) */
/* Ë∞ÉÊï¥ÁΩëÊ†ºÈó¥Ë∑ùÔºåÁªôÂ§ßÂõæÊ†áËÖæÂá∫Á©∫Èó¥ */
.cphone-fixed-app-grid {
    gap: 2px 15px !important; /* ÂáèÂ∞èË°åÈó¥Ë∑ù */
}

/* Âº∫Âà∂ÊîæÂ§ßÂõæÊ†áËÉåÊôØ */
.app-icon.small .icon-bg {
    width: 62px !important;      /* Âéü‰∏∫ 54px -> Êîπ‰∏∫ 62px */
    height: 62px !important;
    min-width: 62px !important;
    border-radius: 16px !important; /* Á®çÂæÆÂúÜÊ∂¶‰∏ÄÁÇπ */
    margin-bottom: 5px !important;
}

/* 3. „ÄêÂ≠ó‰ΩìÁªü‰∏Ä„Äë‰øÆÊ≠£ CPhone Â≠ó‰ΩìÈ¢úËâ≤ÂíåÂ§ßÂ∞è */
.app-icon.small .label {
    font-size: 13px !important;  /* Âéü‰∏∫ 11px -> Êîπ‰∏∫ EPhone Ê†áÂáÜÁöÑ 13px */
    color: #ffffff !important;   /* Á∫ØÁôΩÊñáÂ≠ó */
    font-weight: 500 !important;
    /* Áªü‰∏Ä‰ΩøÁî® EPhone ÁöÑÂº∫Èò¥ÂΩ±Ôºå‰øùËØÅÂú®‰∫ÆËâ≤Â£ÅÁ∫∏‰∏ä‰πüÊ∏ÖÊô∞ */
    text-shadow: 0 1px 3px rgba(0,0,0,0.6) !important; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
}

/* 4. „ÄêDockÊ†è„ÄëÊîπ‰∏∫ EPhone È£éÊ†º (ÊµÖËâ≤ÈÄèÊòé) */
.cphone-dock.glass {
    /* Âéü‰∏∫Ê∑±ÁÅ∞Ëâ≤ rgba(40, 40, 40, 0.4) -> Êîπ‰∏∫ÊµÖÁôΩÈÄèÊòé */
    background: rgba(255, 255, 255, 0.2) !important; 
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    /* Á®çÂæÆË∞ÉÊï¥ÂúÜËßíÔºå‰ΩøÂÖ∂‰∏çÈÇ£‰πàÂúÜÔºåÊõ¥ÂÉè EPhone ÁöÑ Dock */
    border-radius: 24px !important; 
}

/* 5. „ÄêDockÂõæÊ†á„ÄëÁ°Æ‰øù Dock ÈáåÁöÑÂõæÊ†á‰πüÂ§üÂ§ß */
.cphone-dock .app-icon .icon-bg {
    width: 60px !important;
    height: 60px !important;
}

/* --- ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÈÄÇÈÖç‰øÆÊ≠£ --- */
#phone-screen.dark-mode .cphone-dock.glass {
    /* ÊöóÈªëÊ®°Âºè‰∏ãÁ®çÂæÆÊ∑±‰∏ÄÁÇπÔºå‰ΩÜ‰øùÊåÅÈÄöÈÄè */
    background: rgba(50, 50, 50, 0.4) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
}
/* ================================================== */
/* ‚ñº‚ñº‚ñº CPhone ÁïåÈù¢Áªü‰∏ÄÂåñ‰øÆÂ§çË°•‰∏Å (ÂéªÈô§Â§ñÊ°Ü + ÊîæÂ§ßÂõæÊ†á) ‚ñº‚ñº‚ñº */
/* ================================================== */

/* 1. „ÄêÂ∑¶‰æßÁªÑ‰ª∂„ÄëÂéªÈô§ÂúÜÂΩ¢ÁªÑ‰ª∂ÁöÑ"‰∏ë"Â§ñÊ°Ü */
.cphone-circle-widget-wrapper {
    background: transparent !important;       /* ÂéªÊéâËÉåÊôØËâ≤ */
    border: none !important;                  /* ÂéªÊéâËæπÊ°ÜÁ∫ø */
    backdrop-filter: none !important;         /* ÂéªÊéâÁ£®Á†ÇÁéªÁíÉ */
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;              /* ÂéªÊéâÈò¥ÂΩ± */
}

/* ‰ºòÂåñÂéªÈô§Â§ñÊ°ÜÂêéÁöÑÊñáÂ≠óÊòæÁ§∫ (Âä†Âº∫Èò¥ÂΩ±ÔºåÈò≤Ê≠¢Áúã‰∏çÊ∏Ö) */
.circle-text-area p {
    text-shadow: 0 1px 4px rgba(0,0,0,0.8) !important;
    font-weight: 500 !important;
}
/* ÂéªÈô§Ë£ÖÈ•∞Á∫ø (Êó¢ÁÑ∂‰∏çË¶ÅÊ°Ü‰∫ÜÔºåË£ÖÈ•∞Á∫øÊÇ¨Á©∫‰ºöÂæàÊÄ™) */
.line-deco {
    display: none !important; 
}

/* 2. „ÄêÂõæÊ†áÂ§ßÂ∞è„ÄëÊîæÂ§ß CPhone ÂõæÊ†á (ÂØπÈΩê EPhone) */
/* Ë∞ÉÊï¥ÁΩëÊ†ºÈó¥Ë∑ùÔºåÁªôÂ§ßÂõæÊ†áËÖæÂá∫Á©∫Èó¥ */
.cphone-fixed-app-grid {
    gap: 2px 15px !important; /* ÂáèÂ∞èË°åÈó¥Ë∑ù */
}

/* Âº∫Âà∂ÊîæÂ§ßÂõæÊ†áËÉåÊôØ */
.app-icon.small .icon-bg {
    width: 62px !important;      /* Âéü‰∏∫ 54px -> Êîπ‰∏∫ 62px */
    height: 62px !important;
    min-width: 62px !important;
    border-radius: 16px !important; /* Á®çÂæÆÂúÜÊ∂¶‰∏ÄÁÇπ */
    margin-bottom: 5px !important;
}

/* 3. „ÄêÂ≠ó‰ΩìÁªü‰∏Ä„Äë‰øÆÊ≠£ CPhone Â≠ó‰ΩìÈ¢úËâ≤ÂíåÂ§ßÂ∞è */
.app-icon.small .label {
    font-size: 13px !important;  /* Âéü‰∏∫ 11px -> Êîπ‰∏∫ EPhone Ê†áÂáÜÁöÑ 13px */
    color: #ffffff !important;   /* Á∫ØÁôΩÊñáÂ≠ó */
    font-weight: 500 !important;
    /* Áªü‰∏Ä‰ΩøÁî® EPhone ÁöÑÂº∫Èò¥ÂΩ±Ôºå‰øùËØÅÂú®‰∫ÆËâ≤Â£ÅÁ∫∏‰∏ä‰πüÊ∏ÖÊô∞ */
    text-shadow: 0 1px 3px rgba(0,0,0,0.6) !important; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
}

/* 4. „ÄêDockÊ†è„ÄëÊîπ‰∏∫ EPhone È£éÊ†º (ÊµÖËâ≤ÈÄèÊòé) */
.cphone-dock.glass {
    /* Âéü‰∏∫Ê∑±ÁÅ∞Ëâ≤ rgba(40, 40, 40, 0.4) -> Êîπ‰∏∫ÊµÖÁôΩÈÄèÊòé */
    background: rgba(255, 255, 255, 0.2) !important; 
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
    /* Á®çÂæÆË∞ÉÊï¥ÂúÜËßíÔºå‰ΩøÂÖ∂‰∏çÈÇ£‰πàÂúÜÔºåÊõ¥ÂÉè EPhone ÁöÑ Dock */
    border-radius: 24px !important; 
}

/* 5. „ÄêDockÂõæÊ†á„ÄëÁ°Æ‰øù Dock ÈáåÁöÑÂõæÊ†á‰πüÂ§üÂ§ß */
.cphone-dock .app-icon .icon-bg {
    width: 60px !important;
    height: 60px !important;
}

/* --- ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÈÄÇÈÖç‰øÆÊ≠£ --- */
#phone-screen.dark-mode .cphone-dock.glass {
    /* ÊöóÈªëÊ®°Âºè‰∏ãÁ®çÂæÆÊ∑±‰∏ÄÁÇπÔºå‰ΩÜ‰øùÊåÅÈÄöÈÄè */
    background: rgba(50, 50, 50, 0.4) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
}
/* ========================================================= */
/* ‚ñº‚ñº‚ñº CPhone Â∏ÉÂ±ÄÂæÆË∞ÉË°•‰∏Å V2 (Ê∞îÊ≥°ÂØπÈΩê + ÂúÜÂΩ¢‰∏ãÁßª) ‚ñº‚ñº‚ñº */
/* ========================================================= */

/* 1. „ÄêÂúÜÂΩ¢ÁªÑ‰ª∂„Äë‰ΩçÁΩÆ‰∏ãÁßª‰øÆÊ≠£ */
.cphone-circle-widget-wrapper {
    /* ÂéüÊù•ÊòØÈù†È°∂ÂØπÈΩêÔºåÁé∞Âú®ÂæÄ‰∏ãÊé® 30pxÔºåËßÜËßâ‰∏äÊõ¥Âπ≥Ë°° */
    margin-top: 30px !important; 
    
    /* Êó¢ÁÑ∂ÂéªÊéâ‰∫ÜÂ§ñÊ°ÜÔºåÁ°Æ‰øùÂÆÉÊòØÈÄèÊòéÁöÑ */
    background: transparent !important;
    border: none !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;
}

/* 2. „ÄêÁ¨¨‰∏ÄË°åÊ∞îÊ≥°„ÄëÂÆπÂô®Ë∞ÉÊï¥ */
.cphone-staggered-group {
    width: 100% !important; /* Âç†Êª°Êï¥Ë°å */
    max-width: 360px !important; /* ÈôêÂà∂ÊúÄÂ§ßÂÆΩ */
    padding: 10px 5px !important; /* Â∑¶Âè≥ÁïôÁÇπÂëºÂê∏Á©∫Èó¥ */
    box-sizing: border-box !important;
    display: flex !important;
    flex-direction: column !important;
    /* ÂéªÊéâ gapÔºåÂÆåÂÖ®Èù† margin ÊéßÂà∂‰ΩçÁΩÆ */
    gap: 0 !important; 
}

/* 3. „Äê‰∏äÊñπÊ∞îÊ≥°„Äë‰∏•Ê†ºÂ∑¶ÂØπÈΩê + ÂêëÂ∑¶‰∏äÂÄæÊñú */
.cphone-bubble-pill.top {
    /* Á®çÂæÆÁº©Áü≠ÂÆΩÂ∫¶ÔºåËÆ©‚ÄúÈù†Â∑¶‚ÄùÊõ¥ÊòéÊòæ */
    width: 275px !important; 
    
    /* Ê†∏ÂøÉÂØπÈΩê‰ª£Á†Å */
    align-self: flex-start !important; 
    margin-right: auto !important; /* Âº∫Âà∂ÊääÂè≥ËæπÁ©∫Âá∫Êù• */
    margin-left: 5px !important;   /* Á¶ªÂ∑¶ËæπÁºò‰∏ÄÁÇπÁÇπË∑ùÁ¶ª */
    
    /* ÂÄæÊñú‰∏éÈáçÂè†ÊéßÂà∂ */
    transform: rotate(-3deg) !important;
    margin-bottom: -10px !important; /* Âè™ÊòØËΩªÂæÆÈáçÂè†Ôºå‰∏çÂÜçÊòØÂ§ßÈù¢ÁßØÈáçÂêà */
    z-index: 2 !important; /* ÂéãÂú®‰∏ãÈù¢ÈÇ£‰∏™‰∏äÈù¢ */
}

/* 4. „Äê‰∏ãÊñπÊ∞îÊ≥°„Äë‰∏•Ê†ºÂè≥ÂØπÈΩê + ÂêëÂè≥‰∏ãÂÄæÊñú */
.cphone-bubble-pill.bottom {
    /* ÂÆΩÂ∫¶‰øùÊåÅ‰∏ÄËá¥ */
    width: 275px !important;
    
    /* Ê†∏ÂøÉÂØπÈΩê‰ª£Á†Å */
    align-self: flex-end !important;
    margin-left: auto !important;  /* Âº∫Âà∂ÊääÂ∑¶ËæπÁ©∫Âá∫Êù• */
    margin-right: 5px !important;  /* Á¶ªÂè≥ËæπÁºò‰∏ÄÁÇπÁÇπË∑ùÁ¶ª */
    
    /* ÂÄæÊñú‰∏éÈáçÂè†ÊéßÂà∂ */
    transform: rotate(2deg) !important;
    margin-top: 0 !important;
    z-index: 1 !important;
}

/* 5. Á°Æ‰øùÊ∞îÊ≥°ÂÜÖÁöÑÊñáÂ≠óËÉΩÂÆåÊï¥ÊòæÁ§∫ */
.bubble-content {
    /* ‰øÆÂ§çÂèØËÉΩË¢´ÂéãÁº©ÁöÑÈóÆÈ¢ò */
    flex-shrink: 1 !important;
    min-width: 0 !important;
}
/* ================================================================= */
/* ‚ñº‚ñº‚ñº Swiss Style ÁªàÊûÅÁâàÂºè‰øÆÊ≠£ (Steve Jobs Approved) ‚ñº‚ñº‚ñº */
/* ================================================================= */

/* --- 1. ÂÖ®Â±ÄÂ∏ÉÂ±ÄÂÆπÂô®ÔºöÂ¢ûÂä†ÂëºÂê∏ÊÑü --- */
#cphone-layout-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    /* Â¢ûÂä†ÂûÇÁõ¥Èó¥Ë∑ùÔºåËøôÂ∞±ÊòØ‚ÄúÊï∞ÂçÉÁæéÂÖÉ‚ÄùÁöÑÈ´òÁ∫ßÊÑüÊù•Ê∫ê */
    gap: 35px !important; 
    padding-top: 10px; /* Á®çÂæÆÂæÄ‰∏ãÂéã‰∏ÄÁÇπÔºå‰∏çÈ°∂Â§¥ */
}

/* Áªü‰∏ÄÊâÄÊúâË°åÁöÑÂÆΩÂ∫¶ÔºåÁ°Æ‰øùËßÜËßâËæπÁºòÂûÇÁõ¥ÂØπÈΩê */
.cphone-staggered-group,
.cphone-fixed-row,
.cphone-dock {
    width: 330px !important; /* ÈªÑÈáëÂÆΩÂ∫¶ÔºåÈÄÇÈÖçÂ§ßÈÉ®ÂàÜÊâãÊú∫Â±è */
    max-width: 100% !important;
}

/* --- 2. ÈîôËêΩÊ∞îÊ≥°ÔºöÁ≤æÂáÜÂØπÈΩêÁÆóÊ≥ï --- */
.cphone-staggered-group {
    padding: 5px 0 !important;
    gap: 0 !important; /* ÈáçÂè†Áî± margin ÊéßÂà∂ */
    position: relative;
    /* Á°Æ‰øùÂÆπÂô®Êú¨Ë∫´‰∏çË£ÅÂâ™Èò¥ÂΩ± */
    overflow: visible !important; 
}

.cphone-bubble-pill {
    /* Á®çÂæÆÁº©Áü≠ÂÆΩÂ∫¶Ôºå‰∏∫ÊóãËΩ¨ÁïôÂá∫‰ΩôÈáèÔºåÈò≤Ê≠¢ËßÜËßâÊ∫¢Âá∫ */
    width: 285px !important; 
    height: 58px !important;
    border-radius: 29px !important;
    
    /* ÁéªÁíÉË¥®ÊÑüÂ¢ûÂº∫ÔºöÊõ¥ÈÄöÈÄè */
    background: rgba(255, 255, 255, 0.2) !important;
    backdrop-filter: blur(25px) !important;
    -webkit-backdrop-filter: blur(25px) !important;
    border: 1px solid rgba(255, 255, 255, 0.25) !important;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05) !important;
}

/* ‰∏äÊñπÊ∞îÊ≥°ÔºöÂ∑¶ÂØπÈΩê + ÁªïÂ∑¶‰æßÊóãËΩ¨ */
.cphone-bubble-pill.top {
    align-self: flex-start !important; /* Áâ©ÁêÜÈù†Â∑¶ */
    margin-right: auto !important;
    
    /* Ê†∏ÂøÉÔºöËΩ¥ÂøÉËÆæÂú®Â∑¶‰æßÔºåÊóãËΩ¨Êó∂Â∑¶Ëæπ‰∏çÂä®ÔºåÂè≥ËæπÁøòËµ∑ */
    transform-origin: center left !important; 
    transform: rotate(-4deg) translateY(0px) !important;
    
    margin-bottom: -18px !important; /* Âêë‰∏ãÊå§ÂéãÔºåÂàõÈÄ†Â±ÇÂè†ÊÑü */
    margin-left: 2px !important; /* ÂæÆË∞ÉËßÜËßâËæπÁºò */
    z-index: 2;
}

/* ‰∏ãÊñπÊ∞îÊ≥°ÔºöÂè≥ÂØπÈΩê + ÁªïÂè≥‰æßÊóãËΩ¨ */
.cphone-bubble-pill.bottom {
    align-self: flex-end !important; /* Áâ©ÁêÜÈù†Âè≥ */
    margin-left: auto !important;
    
    /* Ê†∏ÂøÉÔºöËΩ¥ÂøÉËÆæÂú®Âè≥‰æßÔºåÊóãËΩ¨Êó∂Âè≥Ëæπ‰∏çÂä®ÔºåÂ∑¶ËæπÂûÇ‰∏ã */
    transform-origin: center right !important;
    transform: rotate(3deg) translateY(0px) !important;
    
    margin-top: 0 !important;
    margin-right: 2px !important; /* ÂæÆË∞ÉËßÜËßâËæπÁºò */
    z-index: 1;
}

/* --- 3. ÂúÜÂΩ¢ÁªÑ‰ª∂ÊñáÂ≠ó‰ºòÂåñÔºöÂ¢ûÂä†Èó¥Ë∑ù --- */
.cphone-circle-widget-wrapper {
    /* ÁßªÈô§ËÉåÊôØÂíåËæπÊ°ÜÔºå‰øùÊåÅÈÄèÊòé */
    background: transparent !important;
    border: none !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;
    
    /* ÂûÇÁõ¥Â∏ÉÂ±Ä */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.cphone-circle-bg {
    /* ÂõæÁâáÂÆπÂô® */
    margin-bottom: 0 !important; /* ÁßªÈô§ÊóßËæπË∑ùÔºåÁî± text-area ÁöÑ margin-top ÊéßÂà∂ */
}

.circle-text-area {
    /* ÂºÄÂêØ Flex Â∏ÉÂ±ÄÊù•ÊéßÂà∂‰∏§Ë°åÂ≠óÁöÑÈó¥Ë∑ù */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    
    /* ËøôÈáåÊéßÂà∂‰∏§Ë°åÊñáÂ≠ó‰∏≠Èó¥ÁöÑË∑ùÁ¶ªÔºåËøôÂ∞±ÊòØ‰Ω†Ë¶ÅÁöÑ */
    gap: 6px !important; 
    
    /* ÊéßÂà∂ÊñáÂ≠óÊï¥‰Ωì‰∏éÂúÜÂõæÁöÑË∑ùÁ¶ª */
    margin-top: 15px !important; 
}

/* Á¨¨‰∏ÄË°åÂ≠óÔºö‰∏ªÊ†áÈ¢ò */
#cphone-circle-text {
    font-size: 15px !important;
    font-weight: 600 !important;
    letter-spacing: 0.5px !important; /* Â≠óÈó¥Ë∑ùÂæÆË∞É */
    color: #ffffff !important;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5) !important;
    line-height: 1 !important;
    margin: 0 !important;
}

/* Á¨¨‰∫åË°åÂ≠óÔºöÂâØÊ†áÈ¢ò */
#cphone-circle-subtext {
    font-size: 12px !important;
    font-weight: 400 !important;
    opacity: 0.85 !important;
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
    font-family: "Georgia", serif !important; /* Ë°¨Á∫ø‰ΩìÔºå‰ºòÈõÖ */
    font-style: italic !important;
    line-height: 1 !important;
    margin: 0 !important;
}

/* --- 4. ÂÜçÊ¨°Á°Æ‰øùÂõæÊ†áÂ§ßÂ∞èÁªü‰∏Ä (Èò≤Ê≠¢Ë¢´Ë¶ÜÁõñ) --- */
.cphone-fixed-app-grid {
    gap: 8px 15px !important; /* ÂæÆË∞ÉÁΩëÊ†ºÈó¥Ë∑ù */
}
.app-icon.small .icon-bg {
    width: 62px !important;
    height: 62px !important;
    min-width: 62px !important;
    border-radius: 15px !important; /* iOS Ê†áÂáÜÂúÜËßí */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1) !important;
}
.app-icon.small .label {
    margin-top: 4px !important;
    font-size: 12px !important;
    font-weight: 500 !important;
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5) !important;
}

/* --- 5. ÊãçÁ´ãÂæóÂ†ÜÂè†‰ºòÂåñ (Âè≥‰æßÁªÑ‰ª∂) --- */
/* ËÆ©ÊãçÁ´ãÂæó‰πüÁ®çÂæÆÂÄæÊñú‰∏ÄÁÇπÁÇπÔºåÂ¢ûÂä†ÈöèÊÑèÊÑü */
.cphone-stack-polaroid {
    transform: rotate(2deg);
}


/* --- CPhone Ê∞îÊ≥°ÔºöÂº∫Âà∂ÂØπÈΩêÂ§çÂàªÁâà --- */

/* 1. ÂÆπÂô®ÔºöÂº∫Âà∂Â±Ö‰∏≠ÔºåÈîÅÊ≠ªÂÆΩÂ∫¶ */
.cphone-staggered-group {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important; /* Ê†∏ÂøÉÔºöÂûÇÁõ¥Â±Ö‰∏≠ÂØπÈΩê */
    width: 330px !important;        /* Ê†∏ÂøÉÔºöÂõ∫ÂÆöÂÆΩÂ∫¶ */
    margin: 0 auto !important;
    padding: 10px 0 !important;
    gap: 0 !important;              /* ÂéªÊéâÈó¥ÈöôÔºåÁî® margin ÊéßÂà∂Â†ÜÂè† */
}

/* 2. Ê∞îÊ≥°ÈÄöÁî®ÔºöÂ°´Êª°ÂÆπÂô®Ôºå‰øùÊåÅ‰∏ÄËá¥ */
.cphone-bubble-pill {
    width: 100% !important;         /* Âº∫Âà∂Âç†Êª° 330pxÔºå‰øùËØÅ‰∏ä‰∏ã‰∏ÄÊ†∑ÂÆΩ */
    height: 60px !important;
    border-radius: 35px !important; /* Êõ¥ÂúÜÊ∂¶‰∏ÄÁÇπ */
    box-sizing: border-box !important;
    transition: transform 0.3s ease !important;
    
    /* Ê†∏ÂøÉÔºöÂÖ®ÈÉ®Áªï‰∏≠ÂøÉÊóãËΩ¨Ôºå‰øùËØÅ‰∏ç‰ºöÊ≠™Âà∞Ê≤°Ëæπ */
    transform-origin: center center !important; 
}

/* 3. ‰∏äÊñπÊ∞îÊ≥°ÔºöÂ∑¶‰ΩéÂè≥È´ò (-3deg) */
.cphone-bubble-pill.top {
    align-self: center !important;  /* Âº∫Âà∂Â±Ö‰∏≠Ôºå‰∏çË¶ÅÈù†Â∑¶ */
    transform: rotate(-3deg) !important;
    
    margin-bottom: -12px !important; /* Âêë‰∏ãÊå§ÂéãÔºå‰∫ßÁîüÂ†ÜÂè†ÊÑü */
    z-index: 2 !important;           /* ÂéãÂú®‰∏ãÈù¢ÈÇ£‰∏™‰∏äÈù¢ */
    
    /* Ê∏ÖÈô§ÊóßÁöÑÂπ≤Êâ∞ */
    margin-left: 0 !important;
    margin-right: 0 !important;
}

/* 4. ‰∏ãÊñπÊ∞îÊ≥°ÔºöÂêåÊ†∑Â∑¶‰ΩéÂè≥È´ò (-3deg)Ôºå‰øùÊåÅÂπ≥Ë°å */
/* Ê†πÊçÆÂéüÂõæÔºåÂÆÉ‰ª¨ÊòØÂπ≥Ë°åÁöÑÔºåËøôÊ†∑ËßÜËßâ‰∏äÊúÄÊï¥ÈΩê */
.cphone-bubble-pill.bottom {
    align-self: center !important;  /* Âº∫Âà∂Â±Ö‰∏≠Ôºå‰∏çË¶ÅÈù†Âè≥ */
    transform: rotate(-3deg) !important; 
    
    margin-top: 0 !important;
    z-index: 1 !important;
    
    /* Ê∏ÖÈô§ÊóßÁöÑÂπ≤Êâ∞ */
    margin-left: 0 !important;
    margin-right: 0 !important;
}

/* 5. ‰øÆÂ§ç Dock Ê†èÊñáÂ≠óÊòæÁ§∫ */
.cphone-dock .app-icon .label {
    display: block !important;
    margin-top: 4px !important;
    font-size: 11px !important;
    font-weight: 500 !important;
    color: #ffffff !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.6) !important;
    text-align: center !important;
}
/* --- CPhone Ê∞îÊ≥°ÔºöÂ±Ö‰∏≠ÂØπÈΩê + ÂèçÂêëÂÄæÊñú + Â¢ûÂä†Èó¥Ë∑ùÁâà --- */

/* 1. ÂÆπÂô®ÔºöÊéßÂà∂Êï¥‰ΩìÈó¥Ë∑ù */
.cphone-staggered-group {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important; /* ÂûÇÁõ¥Â±Ö‰∏≠ */
    width: 330px !important;
    margin: 0 auto !important;
    padding: 10px 0 !important;
    
    /* „ÄêÂÖ≥ÈîÆ‰øÆÊîπ 1„ÄëÂ¢ûÂä†Ê∞îÊ≥°‰πãÈó¥ÁöÑÁâ©ÁêÜÈó¥Ë∑ù */
    gap: 5px !important; 
}

/* 2. Ê∞îÊ≥°ÈÄöÁî®ËÆæÁΩÆ */
.cphone-bubble-pill {
    width: 100% !important;
    height: 60px !important;
    border-radius: 35px !important;
    box-sizing: border-box !important;
    transition: transform 0.3s ease !important;
    transform-origin: center center !important;
}

/* 3. ‰∏äÊñπÊ∞îÊ≥°ÔºöÂ∑¶‰ΩéÂè≥È´ò (-3deg) */
.cphone-bubble-pill.top {
    align-self: center !important;
    transform: rotate(-3deg) !important;
    
    /* „ÄêÂÖ≥ÈîÆ‰øÆÊîπ 2„ÄëÁßªÈô§Ë¥üËæπË∑ùÔºå‰∏çÂÜçÊå§Âéã */
    margin-bottom: 0 !important; 
    
    z-index: 2 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
}

/* 4. ‰∏ãÊñπÊ∞îÊ≥°ÔºöÂ∑¶È´òÂè≥‰Ωé (3deg) */
.cphone-bubble-pill.bottom {
    align-self: center !important;
    transform: rotate(3deg) !important; 
    
    margin-top: 0 !important;
    z-index: 1 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
}

/* 5. Á°Æ‰øùDockÊñáÂ≠óÊòæÁ§∫ */
.cphone-dock .app-icon .label {
    display: block !important;
}
/* --- CPhone ÂÖ®Â±ÄÂ∏ÉÂ±ÄË∞ÉÊï¥ÔºöÁ¥ßÂáëÁâà --- */

#cphone-layout-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    
    /* „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÂáèÂ∞èË°å‰∏éË°å‰πãÈó¥ÁöÑÈó¥Ë∑ù */
    /* ÂéüÊù•ÊòØ 35pxÔºåÁé∞Âú®Êîπ‰∏∫ 10pxÔºåÁ´ãÂàªÂèòÁ¥ßÂáë */
    gap: 35px !important; 
    
    /* È°∂ÈÉ®Á®çÂæÆÁïô‰∏ÄÁÇπÁÇπÂëºÂê∏Á©∫Èó¥ÔºåÈò≤Ê≠¢Ê∞îÊ≥°È°∂Âà∞ÂàòÊµ∑ */
    padding-top: 15px !important;
}

/* Á°Æ‰øùÈîôËêΩÊ∞îÊ≥°ÁªÑÊú¨Ë∫´Ê≤°ÊúâÂ§ö‰ΩôÁöÑÂ§ñÈÉ®ËæπË∑ù */
.cphone-staggered-group {
    margin-bottom: 0 !important;
    padding-bottom: 5px !important; /* Á®çÂæÆÂáèÂ∞è‰∏ÄÁÇπÂ∫ïÈÉ®ÂÜÖËæπË∑ù */
}

.cphone-dock-container {
    /* Ê†∏ÂøÉ‰øÆÊîπÔºöÁßªÈô§ env() ËÆ°ÁÆóÔºåÁõ¥Êé•‰ΩøÁî®Âõ∫ÂÆöÊï∞ÂÄº */
    /* 20px ÊòØÊØîËæÉÊ†áÂáÜÁöÑË∑ùÁ¶ªÔºåÂ¶ÇÊûúÊÇ®ÊÉ≥ËÆ©ÂÆÉÊõ¥Èù†‰∏ãÔºåÂèØ‰ª•Êîπ‰∏∫ 10px */
    margin-bottom: 20px !important;
    
    /* Á°Æ‰øùÊ≤°ÊúâÈ¢ùÂ§ñÁöÑÂ∫ïÈÉ®ÂÜÖËæπË∑ùÂπ≤Êâ∞ */
    padding-bottom: 0 !important;
    
    /* Á°Æ‰øùÂÆÉÊòØÈÄöËøá margin-top: auto Ë¢´Êé®Âà∞Â∫ïÈÉ®ÁöÑ (‰øùÊåÅÂéüÊúâÈÄªËæë) */
    margin-top: auto !important;
}

/* Â¶ÇÊûúÊÇ®ÂºÄÂêØ‰∫Ü„ÄêÊâãÊú∫Â§ñÊ°ÜÊ®°Âºè„ÄëÔºåÂèØËÉΩÈúÄË¶ÅÁ®çÂæÆÊä¨È´ò‰∏ÄÁÇπÁÇπÈò≤Ê≠¢Ë¥¥ËæπÂ§™Á¥ß */
body.frame-mode-active .cphone-dock-container {
    margin-bottom: 25px !important;
}
.nai-binding-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%; /* ÂúÜÂΩ¢ */
    appearance: none;
    -webkit-appearance: none;
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
}
.nai-binding-checkbox:checked {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}
.nai-binding-checkbox:checked::after {
    content: '‚úî';
    color: white;
    font-size: 12px;
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
}
/* Âø´Êç∑ÂõûÂ§çÁÆ°ÁêÜÊ®°ÂºèÊ†∑Âºè */
.quick-reply-item {
    position: relative;
    transition: background-color 0.2s;
}

/* ÈöêËóèÁöÑÂ§çÈÄâÊ°Ü */
.quick-reply-checkbox {
    display: none;
    margin-right: 15px;
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    appearance: none;
    -webkit-appearance: none;
    flex-shrink: 0;
    position: relative;
}

.quick-reply-checkbox:checked {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

.quick-reply-checkbox:checked::after {
    content: '‚úî';
    color: white;
    font-size: 12px;
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
}

/* ÁÆ°ÁêÜÊ®°Âºè‰∏ãÊòæÁ§∫Â§çÈÄâÊ°Ü */
#quick-reply-list.management-mode .quick-reply-checkbox {
    display: block;
}

#quick-reply-list.management-mode .quick-reply-actions {
    display: none; /* ÁÆ°ÁêÜÊ®°Âºè‰∏ãÈöêËóèÂçïË°åÊìç‰ΩúÊåâÈíÆ */
}

/* ÈÄâ‰∏≠Áä∂ÊÄÅÈ´ò‰∫Æ */
.quick-reply-item.selected {
    background-color: rgba(0, 123, 255, 0.05);
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode #quick-reply-action-bar {
    background-color: rgba(28, 28, 30, 0.95);
    border-top-color: #38383a;
    color: #fff;
}/* --- ÈöêËóèÂ±ÇÊ∂àÊÅØÊòæÂΩ¢Ê†∑Âºè (ÂÆåÁæé‰º™Ë£ÖÊàêÁ≥ªÁªüÊèêÁ§∫) --- */

/* 1. Â∏ÉÂ±ÄÈáçÁΩÆÔºöÂº∫Âà∂Â±Ö‰∏≠ */
.message-wrapper.hidden-revealed {
    justify-content: center !important;
    align-self: center !important;
    width: 100%;
    margin: 5px 0; /* ‰øùÊåÅÁ≥ªÁªüÊ∂àÊÅØÁöÑÈó¥Ë∑ù */
    padding: 0;
    border: none !important;
    background: transparent !important;
    flex-direction: row !important;
}

/* 2. ÈöêËóèÊó†ÂÖ≥ÂÖÉÁ¥† (Â§¥ÂÉè„ÄÅÂêçÂ≠ó„ÄÅÊó∂Èó¥„ÄÅÂºïÁî®„ÄÅÂ∞èÂ∞ñËßí) */
.message-wrapper.hidden-revealed .avatar-group,
.message-wrapper.hidden-revealed .sender-name,
.message-wrapper.hidden-revealed .timestamp,
.message-wrapper.hidden-revealed .quoted-message,
.message-wrapper.hidden-revealed .message-bubble::after, /* ÂéªÊéâÊ∞îÊ≥°Â∞ñËßí */
.message-wrapper.hidden-revealed .message-bubble::before {
    display: none !important;
}

/* 3. Â§ñÂ±ÇÊ∞îÊ≥°ÔºöÂèòÊàêÁÅ∞Ëâ≤Â∞èËÉ∂Âõä */
.message-wrapper.hidden-revealed .message-bubble {
    /* Ê†∏ÂøÉÂ§ñËßÇÔºöÊ®°‰ªøÁ≥ªÁªüÊ∂àÊÅØ */
    background-color: rgba(0, 0, 0, 0.1) !important; 
    color: #8a8a8a !important; /* ÁÅ∞Ëâ≤ÊñáÂ≠ó */
    font-size: 12px !important;
    padding: 4px 12px !important;
    border-radius: 10px !important;
    
    /* Â∏ÉÂ±ÄÈáçÁΩÆ */
    flex: initial !important; /* ‰∏çË¶ÅËá™Âä®‰º∏Áº© */
    min-width: auto !important;
    max-width: 85% !important;
    width: fit-content !important; /* ÂÆΩÂ∫¶ÈöèÂÜÖÂÆπ */
    display: inline-block !important;
    margin: 0 auto !important; /* Ëá™Ë∫´Â±Ö‰∏≠ */
    border: none !important;
    box-shadow: none !important;
    text-align: center;
}

/* 4. „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂΩªÂ∫ïÂâ•Á¶ªÂÜÖÈÉ® .content ÁöÑÊ†∑Âºè */
/* ËøôÂ∞±ÊòØÂØºËá¥‚ÄúËÉ∂ÂõäÈáåÊúâÊ∞îÊ≥°‚ÄùÁöÑÂÖÉÂá∂ÔºåÊàë‰ª¨ÊääÂÆÉÂèòÈÄèÊòé */
.message-wrapper.hidden-revealed .message-bubble .content {
    background-color: transparent !important; /* ÂéªÊéâÁôΩËâ≤ËÉåÊôØ */
    box-shadow: none !important;              /* ÂéªÊéâÈò¥ÂΩ± */
    border: none !important;
    padding: 0 !important;                    /* ÂéªÊéâÂÜÖËæπË∑ù */
    margin: 0 !important;
    
    /* Â≠ó‰ΩìÈáçÁΩÆ */
    color: inherit !important;                /* ÁªßÊâøÂ§ñÂ±ÇÁöÑÁÅ∞Ëâ≤ */
    font-size: inherit !important;            /* ÁªßÊâøÂ∞èÂ≠óÂè∑ */
    line-height: 1.4 !important;
    font-weight: normal !important;
    
    /* Â∏ÉÂ±Ä */
    display: inline !important;               /* ÂèòÊàêË°åÂÜÖÂÖÉÁ¥†ÔºåÁ¥ßË¥¥ÊñáÂ≠ó */
    width: auto !important;
    min-width: 0 !important;
}

/* 5. ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
#phone-screen.dark-mode .message-wrapper.hidden-revealed .message-bubble {
    background-color: rgba(255, 255, 255, 0.15) !important; /* Ê∑±Ëâ≤‰∏ãÁöÑÂçäÈÄèÊòéÁôΩ */
    color: #8d8d92 !important; /* ÊµÖÁÅ∞Â≠ó */
}

/* Ë°®ÊÉÖÂåÖÈ°µÈù¢Ê†∑Âºè */
.sticker-page {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: #ffffff;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.4s ease;
}
.sticker-page.active {
    transform: translateX(0);
}
.sticker-header {
    background-color: #FFF2F8;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #e89ab0;
}
.sticker-header-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-color);
}
.sticker-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}
.sticker-generate-area {
    background: #f9f9f9;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}
.sticker-preview-area {
    margin-top: 20px;
}
.sticker-preview {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.sticker-preview img {
    width: 100%;
    display: block;
}
.sticker-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    justify-content: center;
}
.test-btn {
    border: none;
    border-radius: 8px;
    background: var(--pure-pink, #FFC0CB);
    color: var(--deep-pink, #FF1493);
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
    padding: 10px;
}
.test-btn:active {
    transform: scale(0.98);
    opacity: 0.9;
}
.settings-textarea {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    font-family: inherit;
    resize: none;
}
.settings-textarea:focus {
    outline: none;
    border-color: var(--deep-pink, #FF1493);
}
        /* ÂΩ±ËßÜÊêúÁ¥¢Ê†∑ÂºèÔºàËßÇÂΩ±ÂÆ§Ôºâ */
        .movie-search-container {
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        .movie-search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .movie-search-input {
            flex: 1;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            outline: none;
            -webkit-appearance: none;
        }
        .movie-search-input:focus {
            border-color: #007bff;
        }
        .movie-search-btn {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            background-color: #007bff;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .movie-search-btn:hover {
            background-color: #0056b3;
        }
        .movie-search-btn:active {
            transform: scale(0.95);
        }
        .movie-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .movie-card {
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 8px;
            overflow: hidden;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .movie-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .movie-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            display: block;
        }
        .movie-title {
            padding: 8px;
            font-size: 13px;
            color: #1f1f1f;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .movie-platform-tag {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 10px;
            font-weight: bold;
            z-index: 2;
        }
        .movie-platform-tag.bilibili {
            background-color: #00a1d6;
        }
        .movie-platform-tag.yinghua {
            background-color: #ff8eb3;
        }
        .movie-player-container {
            display: none;
            position: relative;
            width: 100%;
            margin-top: 20px;
            background-color: transparent;
            z-index: 100;
        }
        .movie-player-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .movie-iframe {
            width: 100%;
            aspect-ratio: 16/9;
            border: none;
            display: block;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            background-color: #000;
        }
        .movie-video {
            width: 100%;
            aspect-ratio: 16/9;
            border: none;
            display: none;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            background-color: #000;
            pointer-events: auto;
        }
        .movie-video.active {
            display: block;
        }
        .movie-video::-webkit-media-controls-fullscreen-button {
            display: none !important;
        }
        .movie-video::--webkit-media-controls-fullscreen-button {
            display: none !important;
        }
        .close-player-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background-color: rgba(0,0,0,0.6);
            color: #ffffff;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .close-player-btn:hover {
            background-color: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }
        .login-hint {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(4px);
        }
        .login-hint a {
            color: #4da6ff;
            text-decoration: underline;
            cursor: pointer;
        }
        .login-hint a:hover {
            color: #66b3ff;
        }
        .fullscreen-toggle-btn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 8002;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .fullscreen-toggle-btn:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }
        .fullscreen-toggle-btn:active {
            transform: scale(0.95);
        }
        /* ËßÇÂΩ±ÂÆ§ÂÖ®Â±èÊ®°Âºè */
        #movie-screen.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 8000 !important;
            background: #000 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        #movie-screen.fullscreen .header,
        #movie-screen.fullscreen .movie-search-container {
            display: none !important;
        }
        #movie-screen.fullscreen .movie-player-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: #000 !important;
            margin: 0 !important;
            padding: 0 !important;
            border-radius: 0 !important;
            z-index: 8001 !important;
        }
        #movie-screen.fullscreen video,
        #movie-screen.fullscreen iframe {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            object-fit: contain !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        #movie-screen.fullscreen .icon-fullscreen-enter {
            display: none !important;
        }
        #movie-screen.fullscreen .icon-fullscreen-exit {
            display: block !important;
        }
        #movie-screen.fullscreen .close-player-btn {
            top: env(safe-area-inset-top, 20px) !important;
            right: 20px !important;
            width: 44px !important;
            height: 44px !important;
            font-size: 24px !important;
            z-index: 8003 !important;
        }
        #movie-screen.fullscreen .fullscreen-toggle-btn {
            bottom: env(safe-area-inset-bottom, 20px) !important;
            right: 20px !important;
        }
        body.fullscreen-active {
            overflow: hidden !important;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Floating Chat Window Style */
        #chat-interface-screen.floating-chat-window {
            position: fixed !important;
            top: 60px !important;
            right: 10px !important;
            bottom: auto !important; /* Allow resizing */
            left: auto !important;
            width: 340px !important;
            height: 500px !important; /* Default height */
            min-width: 250px !important;
            min-height: 300px !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
            z-index: 10001 !important; /* Higher than full screen movie */
            background-color: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            
            /* Resizable properties */
            resize: both !important;
            overflow: hidden !important; /* Contains resize handle */
            display: flex !important;
            flex-direction: column !important;
        }
        
        #chat-interface-screen.floating-chat-window #chat-messages {
            flex-grow: 1 !important;
            height: auto !important;
            overflow-y: auto !important;
        }

        #chat-interface-screen.floating-chat-window #chat-input-area {
            flex-shrink: 0 !important;
        }
        
        /* Dark mode support */
        #phone-screen.dark-mode #chat-interface-screen.floating-chat-window {
            background-color: rgba(30, 30, 30, 0.95) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }

        /* Adjust header in floating mode */
        #chat-interface-screen.floating-chat-window .header {
            padding: 10px !important;
            height: 40px !important;
            border-radius: 12px 12px 0 0 !important;
            cursor: move !important;
            user-select: none !important;
        }
        
        #chat-interface-screen.floating-chat-window .back-btn {
            display: none !important; /* Hide back button in floating mode */
        }
        
        /* ÊúÄÂ∞èÂåñÁä∂ÊÄÅ */
        #chat-interface-screen.floating-chat-window.minimized {
            display: none !important;
        }
        
        /* ÊÇ¨ÊµÆËÅäÂ§©ÊåâÈíÆÔºàÂèØÊãñÂä®Ôºâ */
        #floating-chat-toggle-btn {
            position: fixed !important;
            width: 56px !important;
            height: 56px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-radius: 50% !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
            z-index: 10000 !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            cursor: pointer !important;
            font-size: 24px !important;
            transition: transform 0.2s, box-shadow 0.2s !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            touch-action: none !important; /* Prevent scrolling when dragging */
        }
        
        #floating-chat-toggle-btn:active {
            transform: scale(0.95) !important;
        }
        
        #floating-chat-toggle-btn.dragging {
            opacity: 0.8 !important;
            transform: scale(1.05) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4) !important;
        }
        
        /* ÊåâÈíÆÂÜÖÁöÑÂ∞èÁ∫¢ÁÇπÔºàÊú™ËØªÊ∂àÊÅØÔºâ */
        #floating-chat-badge {
            position: absolute !important;
            top: -2px !important;
            right: -2px !important;
            background-color: #ff3b30 !important;
            color: white !important;
            font-size: 10px !important;
            min-width: 18px !important;
            height: 18px !important;
            border-radius: 9px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 0 4px !important;
            border: 2px solid white !important;
            font-weight: bold !important;
        }
        
        /* ÊÇ¨ÊµÆÁ™óÊâìÂºÄÊó∂ÊåâÈíÆÁöÑÊ†∑ÂºèÂèòÂåñ */
        #floating-chat-toggle-btn.chat-open {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%) !important;
            transform: rotate(45deg);
        }
        
        #floating-chat-toggle-btn.chat-open i {
            transform: rotate(-45deg); /* Keep icon upright if needed, or let it rotate to X */
        }
        
        /* Âú®ÊµÆÂä®ËÅäÂ§©Á™óÂè£ÂÜÖÁöÑmodalÈúÄË¶ÅÊõ¥È´òz-index */
        #chat-interface-screen.floating-chat-window .modal { z-index: 10000 !important; position: fixed !important; }
        
        /* Á°Æ‰øùËÅäÂ§©Á™óÂè£Âú®ÂÖ®Â±èÊó∂ÂßãÁªàÂèØËßÅ */
        #chat-interface-screen.floating-chat-window {
            z-index: 9999 !important; /* ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåÂú®ÂÖ®Â±è‰πã‰∏ä */
            position: fixed !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: flex !important;
        }
        
        /* Âº∫Âà∂ËÅäÂ§©Á™óÂè£Âú®‰ªª‰Ωïscreen‰πã‰∏ä */
        body #chat-interface-screen.floating-chat-window {
            z-index: 9999 !important;
        }
        
        /* ÂÖ®Â±èÊó∂Âº∫Âà∂ÊòæÁ§∫ËÅäÂ§©Á™óÂè£ */
        #movie-screen.fullscreen ~ #chat-interface-screen.floating-chat-window,
        body.fullscreen-active #chat-interface-screen.floating-chat-window {
            z-index: 9999 !important;
            display: flex !important;
            visibility: visible !important;
        }
        
        /* ÊÇ¨ÊµÆÂ∞èÊåâÈíÆÔºàÊúÄÂ∞èÂåñÊó∂‰ΩøÁî®Ôºå‰øùÁïôÂÖºÂÆπÊÄßÔºâ */
        #floating-chat-mini-btn {
            position: fixed !important;
            width: 56px !important;
            height: 56px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border-radius: 50% !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
            z-index: 10000 !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            cursor: pointer !important;
            font-size: 24px !important;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
            pointer-events: auto !important; /* Á°Æ‰øùÂèØÁÇπÂáª */
        }
        
        #floating-chat-mini-btn:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6) !important;
        }
        
        #floating-chat-mini-btn:active {
            transform: scale(0.95) !important;
        }

        /* ÊúÄÂ∞èÂåñÊåâÈíÆ */
        #floating-chat-minimize-btn {
            position: absolute !important;
            top: 5px !important;
            right: 45px !important;
            font-size: 20px !important;
            cursor: pointer !important;
            z-index: 10002 !important;
            color: var(--text-primary) !important;
            width: 30px !important;
            height: 30px !important;
            text-align: center !important;
            line-height: 30px !important;
            font-weight: bold !important;
            transition: all 0.2s !important;
            pointer-events: auto !important; /* Á°Æ‰øùÂèØÁÇπÂáª */
            user-select: none !important;
        }
        
        #floating-chat-minimize-btn:hover {
            transform: scale(1.2) !important;
            color: #667eea !important;
        }
        
        #floating-chat-minimize-btn:active {
            transform: scale(0.9) !important;
        }
        
        /* Ê®™Â±èÊ®°Âºè‰ºòÂåñ - Á°Æ‰øùËÅäÂ§©Á™óÂè£ÂèØËßÅ */
        @media (orientation: landscape) {
            #chat-interface-screen.floating-chat-window {
                /* Ê®™Â±èÊó∂Ë∞ÉÊï¥ËÅäÂ§©Á™óÂè£Â§ßÂ∞èÂíå‰ΩçÁΩÆ */
                width: 300px !important;
                max-width: 35vw !important;
                height: 400px !important;
                max-height: 80vh !important;
                top: 10px !important;
                right: 10px !important;
                z-index: 9999 !important; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
            }
            
            /* ÂÖ®Â±èÊ®°Âºè‰∏ãÁöÑÊ®™Â±è‰ºòÂåñ */
            #movie-screen.fullscreen #chat-interface-screen.floating-chat-window {
                z-index: 9999 !important;
                position: fixed !important;
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
        }
  </style>
  <link rel="apple-touch-icon" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="EPhone">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" href="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://unpkg.com/dexie/dist/dexie.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://phoebeboo.github.io/mewoooo/pp.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.6/StreamSaver.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
 
</head>
<body>
  <div id="phone-screen">
    <div id="status-bar"> <span id="status-bar-time">12:00</span>
      <div id="status-bar-battery" class="battery-container"> <span class="battery-text">--%</span>
        <div class="battery-icon">
          <div class="battery-level"></div>
        </div>
      </div>
    </div>
    <div id="lock-screen">
        <div id="lock-screen-content">
            <div class="lock-icon">üîì</div>
            <div class="lock-time-container">
                <div id="lock-date">1Êúà1Êó• ÊòüÊúü‰∏Ä</div>
                <div id="lock-time">12:00</div>
            </div>
            
            <div id="lock-password-area" style="display: none;">
                <div class="lock-instruction">ËæìÂÖ•ÂØÜÁ†Å</div>
                <div class="lock-dots">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
                <div class="lock-keypad">
                    <div class="key" data-num="1">1</div>
                    <div class="key" data-num="2">2<br><span>ABC</span></div>
                    <div class="key" data-num="3">3<br><span>DEF</span></div>
                    <div class="key" data-num="4">4<br><span>GHI</span></div>
                    <div class="key" data-num="5">5<br><span>JKL</span></div>
                    <div class="key" data-num="6">6<br><span>MNO</span></div>
                    <div class="key" data-num="7">7<br><span>PQRS</span></div>
                    <div class="key" data-num="8">8<br><span>TUV</span></div>
                    <div class="key" data-num="9">9<br><span>WXYZ</span></div>
                    <div class="key empty"></div>
                    <div class="key" data-num="0">0</div>
                    <div class="key delete" data-action="delete">‚å´</div>
                </div>
                <div class="lock-cancel-btn">ÂèñÊ∂à</div>
            </div>
            
            <div id="lock-swipe-area">
                <div class="swipe-bar"></div>
            </div>
        </div>
    </div>
    <div id="notification-bar"><img id="notification-avatar" src="">
      <div id="notification-content">
        <div class="name"></div>
        <div class="message"></div>
      </div>
    </div>
<div id="dynamic-island-content">
  <img id="island-album-art" src="">
  <div id="island-lyric-container">
    <span id="island-lyric-text"></span>
  </div>
</div>

    <div id="home-screen" class="screen active">
      <div id="home-screen-pages-container">
        <div id="home-screen-pages">
          <div class="home-screen-page">
            <div id="main-content-area">
              <div id="profile-widget"> <img id="profile-banner-img" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image">
                <div class="profile-avatar-container"> <img id="profile-avatar-img" src="https://i.postimg.cc/y8xWzCqj/anime-boy.jpg" class="editable-image"> </div>
                <div class="profile-info">
                  <p id="profile-username" class="editable-text">@ insonneve ü™¶</p>
                  <p id="profile-sub-username" class="editable-text">@ insonneve</p>
                  <p id="profile-bio" class="editable-text">‰Ω†Â•ΩÂÉèËøáÂæóÂæàÂ•Ω Ëø´‰∏çÂèäÂæÖÁöÑÊäπÂéªÊàëÂ≠òÂú®ÁöÑÁóïËøπ</p>
                  <p id="profile-location" class="editable-text"> <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5-2.5-1.12 2.5-2.5 2.5z"></path>
                    </svg> <span>ÂåóÊµ∑ÈÅì</span> </p>
                </div>
              </div>
              <div id="desktop-layout">
                <div id="desktop-widget-column">
                  <div class="desktop-widget text-only">
                    <p id="widget-text-1" class="editable-text">Be fearless in pursuit of happiness</p>
                  </div>
                  <div class="desktop-widget icon-left"> <img id="widget-avatar-1" src="https://i.imgur.com/1n3a43H.jpeg" class="editable-image"> <span id="widget-text-2" class="editable-text">Dare to be different</span> </div>
                  <div class="desktop-widget icon-right"> <span id="widget-text-3" class="editable-text">* Keep your spirit free</span> <img id="widget-avatar-2" src="https://i.imgur.com/5A0tE9a.jpeg" class="editable-image"> </div>
                </div>
                <div id="desktop-app-container">
                  <div class="desktop-app-icon" onclick="showScreen('chat-list-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-qq" src="https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg" alt="QQ"></div> <span class="label"data-lang-key="homeAppQQ">QQ</span>
                  </div>
                  <div class="desktop-app-icon" onclick="showScreen('world-book-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-world-book" src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="‰∏ñÁïå‰π¶"></div> <span class="label"data-lang-key="homeAppWorldBook">‰∏ñÁïå‰π¶</span>
                  </div>
                  <div class="desktop-app-icon" onclick="showScreen('wallpaper-screen')">
                    <div class="icon-bg-desktop"><img id="icon-img-wallpaper" src="https://i.postimg.cc/T1j03pQr/IMG-6440.jpg" alt="Â§ñËßÇËÆæÁΩÆ"></div> <span class="label"data-lang-key="homeAppAppearance">Â§ñËßÇËÆæÁΩÆ</span>
                  </div>
                  <div class="desktop-app-icon" onclick="openRenderingRulesScreen()">
                    <div class="icon-bg-desktop"><img id="icon-img-renderer" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg" alt="Ê∏≤ÊüìÂô®"></div> <span class="label"data-lang-key="homeAppRenderer">Ê∏≤ÊüìÂô®</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="home-screen-page">
            <div class="polaroid-widget-container">
              <div class="polaroid-photos">
                <div class="polaroid-photo" style="transform: rotate(-6deg);" onclick="handleWidgetImageChange('polaroid-img-1')"> <img id="polaroid-img-1" src="https://i.imgur.com/Bv63o3h.jpg" alt="Photo 1"> </div>
                <div class="polaroid-photo" style="transform: rotate(2deg);" onclick="handleWidgetImageChange('polaroid-img-2')"> <img id="polaroid-img-2" src="https://i.imgur.com/GzPzBfF.jpg" alt="Photo 2"> </div>
                <div class="polaroid-photo" style="transform: rotate(5deg);" onclick="handleWidgetImageChange('polaroid-img-3')"> <img id="polaroid-img-3" src="https://i.imgur.com/Wp72cEM.jpg" alt="Photo 3"> </div>
              </div>
            </div>
            <div id="page-2-app-container">
              <div class="left-column-stack">
        <!-- ÂéüÊù•ÁöÑÂ§ßÁªÑ‰ª∂ -->
        <div class="large-widget" onclick="handleWidgetImageChange('large-widget-img')"> 
            <img class="large-widget-img" id="large-widget-img" src="https://i.imgur.com/Bv63o3h.jpg" alt="Colorful Widget"> 
        </div>
        
        <!-- Êñ∞Â¢ûÔºöÂ∑¶‰æß App ÁΩëÊ†º -->
        <div class="left-app-grid">
            <!-- ÊîØ‰ªòÂÆùÂõæÊ†á -->
            <div class="desktop-app-icon" onclick="openAlipayScreen()">
    <div class="icon-bg-desktop">
        <img id="icon-img-alipay" src="https://i.postimg.cc/SK31X0Bb/IMG_2231.png" alt="ÊîØ‰ªòÂÆù">
    </div> 
    <span class="label">ÊîØ‰ªòÂÆù</span>
</div>

<div class="desktop-app-icon" onclick="openAuctionScreen()">
    <div class="icon-bg-desktop"> 
        <img id="icon-img-auction" 
             src="https://i.postimg.cc/Hs7BLh76/alipay.png" 
             alt="ÈªëÂ∏Ç">
    </div>
    <span class="label">ÈªëÂ∏Ç</span>
</div>
<div class="desktop-app-icon" onclick="openGreenRiverScreen()">
    <div class="icon-bg-desktop"> 
        <img id="icon-img-green-river" 
             src="https://i.postimg.cc/0j55Pj1L/green-river-icon.png" 
             alt="ÁªøÊ±ü">
    </div>
    <span class="label">ÁªøÊ±ü</span>
</div>
<div class="desktop-app-icon" onclick="openEmailApp()">
    <div class="icon-bg-desktop"> 
        <img id="icon-img-mail" src="https://i.postimg.cc/PfR7f37x/mail.png" alt="Mail">
    </div>
    <span class="label">ÈÇÆÁÆ±</span>
</div>
            <!-- Êú™Êù•ÂèØ‰ª•Âú®ËøôÈáåÂä†Êõ¥Â§ö App -->
        </div>
    </div>
              <div class="right-column-stack">
    
    <div class="app-subgrid">
        <div class="small-widget" onclick="openPresetScreen()">
            <div class="small-widget-icon-wrapper"> 
                <img class="small-widget-img" id="icon-img-preset" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg" alt="È¢ÑËÆæ"> 
            </div> 
            <span class="small-widget-label" data-lang-key="homeAppPreset">È¢ÑËÆæ</span>
        </div>
        <div class="small-widget" onclick="showScreen('tutorial-screen')">
            <div class="small-widget-icon-wrapper"> 
                <img class="small-widget-img" id="icon-img-tutorial" src="https://i.postimg.cc/d10GjC4g/IMG-7302.jpg" alt="ÊïôÁ®ã"> 
            </div> 
            <span class="small-widget-label" data-lang-key="homeAppTutorial">ÊïôÁ®ã</span>
        </div>
        <div class="small-widget" onclick="openWerewolfLobby('global')">
            <div class="small-widget-icon-wrapper"> 
                <img class="small-widget-img" id="icon-img-werewolf" src="https://i.postimg.cc/k401K5g7/IMG-7304.jpg" alt="Áãº‰∫∫ÊùÄ"> 
            </div> 
            <span class="small-widget-label" data-lang-key="homeAppWerewolf">Áãº‰∫∫ÊùÄ</span>
        </div>
        <div class="small-widget" onclick="showScreen('x-social-screen')">
            <div class="small-widget-icon-wrapper"> 
                <img class="small-widget-img" id="icon-img-x" src="https://i.postimg.cc/Y9d3BztC/1.png" alt="X"> 
            </div> 
            <span class="small-widget-label" data-lang-key="homeAppX">X</span>
        </div>
    </div>

    <div class="vinyl-transparent-widget">
                      <div class="vinyl-disc-bg">
                          <img id="vinyl-img" 
                               src="https://i.postimg.cc/y8xWzCqj/anime-boy.jpg" 
                               class="vinyl-cover editable-image" 
                               onclick="handleWidgetImageChange('vinyl-img')">
                      </div>
                      <div class="vinyl-arm-wrapper">
                          <svg width="50" height="120" viewBox="0 0 50 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="35" cy="15" r="12" fill="white" stroke="#ddd" stroke-width="2"/>
                              <path d="M35 15 L40 80 L25 90" stroke="#ddd" stroke-width="6" stroke-linecap="round" fill="none"/>
                              <path d="M35 15 L40 80 L25 90" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                              <rect x="18" y="88" width="14" height="22" rx="5" fill="white" stroke="#ddd" stroke-width="2"/>
                              <circle cx="25" cy="102" r="2" fill="#ccc"/>
                              <circle cx="25" cy="96" r="2" fill="#ccc"/>
                          </svg>
                      </div>
                  </div> </div> </div> </div>

          <!-- Page 3 -->
          <div class="home-screen-page">
            <div id="page-3-app-container" style="display: flex; gap: 15px; width: 100%; height: 100%; padding: 0 10px;">
              <div class="left-column-stack" style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
                 <div class="left-app-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="desktop-app-icon" onclick="showScreen('movie-screen')">
                        <div class="icon-bg-desktop"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='55' height='55'%3E%3Crect width='55' height='55' fill='%23ff6b6b' rx='14'/%3E%3Ctext x='50%25' y='50%25' font-size='30' text-anchor='middle' dominant-baseline='middle'%3Eüé¨%3C/text%3E%3C/svg%3E" alt="ËßÇÂΩ±ÂÆ§"></div> 
                        <span class="label">ËßÇÂΩ±ÂÆ§</span>
                    </div>
                    <div class="desktop-app-icon" onclick="openStickerPage()">
                        <div class="icon-bg-desktop"><img src="https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg" alt="Ë°®ÊÉÖÂåÖ"></div> 
                        <span class="label">Ë°®ÊÉÖÂåÖ</span>
                    </div>
                 </div>
              </div>
              <div class="right-column-stack" style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
              </div>
            </div>
          </div>

          </div> </div>
      <div id="home-screen-pagination">
        <div class="pagination-dot active"></div>
        <div class="pagination-dot"></div>
        <div class="pagination-dot"></div>
      </div>
      <div id="desktop-dock">
        <div class="desktop-app-icon" onclick="showScreen('api-settings-screen')">
          <div class="icon-bg-desktop"><img id="icon-img-api-settings" src="https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg" alt="APIËÆæÁΩÆ"></div> <span class="label"data-lang-key="homeAppApiSettings">APIËÆæÁΩÆ</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('font-settings-screen')">
          <div class="icon-bg-desktop"><img id="icon-img-font" src="https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg" alt="Â≠ó‰Ωì"></div> <span class="label"data-lang-key="homeAppFont">Â≠ó‰Ωì</span>
        </div>
        <div class="desktop-app-icon" onclick="openCharacterSelector()">
          <div class="icon-bg-desktop"><img id="icon-img-char-phone" src="https://i.postimg.cc/pXj9h20L/IMG-7275.jpg" alt="Cphone"></div> <span class="label"data-lang-key="homeAppCPhone">Cphone</span>
        </div>
        <div class="desktop-app-icon" onclick="showScreen('douban-screen')">
          <div class="icon-bg-desktop"><img id="icon-img-douban" src="https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg" alt="Ë±ÜÁì£"></div> <span class="label"data-lang-key="homeAppDouban">Ë±ÜÁì£</span>
        </div>
      </div>
    </div>
    <div id="character-selection-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span data-lang-key="cphoneTitleSelect">ÈÄâÊã©‰∏ÄÈÉ®ÊâãÊú∫</span> <span style="width: 30px;"></span> </div>
      <div id="character-grid" class="list-container"> </div>
    </div>
    <div id="character-phone-screen" class="screen">
      <div id="char-home-screen" class="char-screen active">
        <div style="height: 50px;"></div>

        <div id="cphone-layout-container">
            
            <div class="cphone-staggered-group">
                <div class="cphone-bubble-pill top">
                    <div class="bubble-avatar-container">
                        <img id="cphone-widget-avatar-1" src="https://i.postimg.cc/y8xWzCqj/anime-boy.jpg" class="editable-image" onclick="handleWidgetImageChange('cphone-widget-avatar-1')">
                    </div>
                    <div class="bubble-content left-align" onclick="editBubbleText('cphone-text-1')">
                         
                         <p id="cphone-text-1">Cat radio station‚òÜÔæü.*ÔΩ•ÔΩ°</p>
                         
                    </div>
                </div>
                
                <div class="cphone-bubble-pill bottom">
                    <div class="bubble-content right-align" onclick="editBubbleText('cphone-text-2')">
                        <p id="cphone-text-2" style="font-family: 'Times New Roman', serif;">It's 17:03:42 Now, Good Afternoon‚ú®</p>
                    </div>
                    <div class="bubble-avatar-container">
                        <img id="cphone-widget-avatar-2" src="https://i.postimg.cc/VkQfgzGJ/1.jpg" class="editable-image" onclick="handleWidgetImageChange('cphone-widget-avatar-2')">
                    </div>
                </div>
            </div>

            <div class="cphone-fixed-row">
                <div class="cphone-fixed-app-grid">
                    <div class="app-icon small" onclick="openCharApp('qq')">
                        <div class="icon-bg"><img id="cphone-icon-img-qq" src=""></div><span class="label">QQ</span>
                    </div>
                    <div class="app-icon small" onclick="openCharApp('album')">
                        <div class="icon-bg"><img id="cphone-icon-img-album" src=""></div><span class="label" data-lang-key="cphoneAppAlbum">Áõ∏ÂÜå</span>
                    </div>
                    <div class="app-icon small" onclick="openCharApp('browser')">
                        <div class="icon-bg"><img id="cphone-icon-img-browser" src=""></div><span class="label" data-lang-key="cphoneAppBrowser">ÊµèËßàÂô®</span>
                    </div>
                    <div class="app-icon small" onclick="openCharApp('taobao')">
                        <div class="icon-bg"><img id="cphone-icon-img-taobao" src=""></div><span class="label" data-lang-key="cphoneAppTaobao">Ê∑òÂÆù</span>
                    </div>
                </div>

                <div class="cphone-stack-polaroid">
                    <div class="polaroid-bg-layer"></div>
                    <div class="polaroid-main-layer">
                        <div class="polaroid-photo-frame">
                             <img id="cphone-polaroid-img" src="https://i.imgur.com/Bv63o3h.jpg" class="editable-image" onclick="handleWidgetImageChange('cphone-polaroid-img')">
                        </div>
                    </div>
                </div>
            </div>

            <div class="cphone-fixed-row">
                <div class="cphone-circle-widget-wrapper">
                    <div class="cphone-circle-bg">
                         <img id="cphone-circle-img" src="https://i.imgur.com/Wp72cEM.jpg" class="editable-image" onclick="handleWidgetImageChange('cphone-circle-img')">
                    </div>
                    <div class="circle-text-area">
    <p id="cphone-circle-text" onclick="editBubbleText('cphone-circle-text')">Super happy</p>
    <p id="cphone-circle-subtext" onclick="editBubbleText('cphone-circle-subtext')">Day & Night</p> 
</div>
                </div>

                <div class="cphone-fixed-app-grid">
                     <div class="app-icon small" onclick="openCharApp('memo')">
                        <div class="icon-bg"><img id="cphone-icon-img-memo" src=""></div><span class="label"data-lang-key="cphoneAppMemo">Â§áÂøòÂΩï</span>
                    </div>
                    <div class="app-icon small" onclick="openCharApp('diary')">
                        <div class="icon-bg"><img id="cphone-icon-img-diary" src=""></div><span class="label"data-lang-key="cphoneAppDiary">Êó•ËÆ∞</span>
                    </div>
                    <div class="app-icon small" onclick="openCharApp('amap')">
                        <div class="icon-bg"><img id="cphone-icon-img-amap" src=""></div><span class="label"data-lang-key="cphoneAppAmap">È´òÂæ∑Âú∞Âõæ</span>
                    </div>
                    <div class="app-icon small" onclick="openCharApp('usage')">
                        <div class="icon-bg"><img id="cphone-icon-img-usage" src=""></div><span class="label"data-lang-key="cphoneAppUsage">APPËÆ∞ÂΩï</span>
                    </div>
                </div>
            </div>

        </div>

        <div class="cphone-dock-container">
            <div class="cphone-dock glass">
                <div class="app-icon" onclick="openCharApp('music')">
                    <div class="icon-bg"><img id="cphone-icon-img-music" src=""></div>
                    <span class="label" data-lang-key="cphoneAppMusic">Èü≥‰πê</span>
                </div>
                <div class="app-icon" onclick="openCharApp('bilibili')">
                    <div class="icon-bg" style="background-color: #FB7299;"><img id="cphone-icon-img-bilibili" src="https://i.postimg.cc/Wz5gV0jB/bilibili-icon.png" style="border-radius:0;"></div>
                    <span class="label">Bilibili</span>
                </div>
                <div class="app-icon" onclick="openCharApp('reddit')">
                    <div class="icon-bg"><img id="cphone-icon-img-reddit" src=""></div>
                    <span class="label">Reddit</span>
                </div>
                <div class="app-icon" onclick="switchToMyPhone()">
                    <div class="icon-bg"><img id="cphone-icon-img-ephone" src=""></div>
                    <span class="label">Ephone</span>
                </div>
            </div>
        </div>
      </div> 
      <div id="char-amap-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span>Ë∂≥Ëøπ</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-amap-btn" title="ÈáçÊñ∞ÁîüÊàêË∂≥Ëøπ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-amap-list" class="list-container"> </div>
      </div>
      <div id="char-qq-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span>QQ</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-qq-btn" title="ÈáçÊñ∞ÁîüÊàê"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-chat-list" class="list-container"></div>
      </div>
      <div id="char-qq-conversation-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="back-to-char-qq-list-btn">‚Äπ</span> <span id="char-conversation-partner-name"></span> <span style="width: 30px;"></span> </div>
        <div id="char-conversation-messages" class="list-container"> </div>
        <div id="char-conversation-input-area" style="padding: 8px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; background-color: #f7f7f7;"> <input type="text" id="char-simulated-input" placeholder="ËøôÊòØÊ®°ÊãüÂØπËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ" data-lang-key-placeholder="cphoneSimulatedChatPlaceholder"disabled
            style="flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd; background: #eee;"> <button id="char-simulated-send-btn" style="padding: 0 20px; border: none; background-color: var(--accent-color); color: white; border-radius: 6px; font-weight: 500;">ÂèëÈÄÅ</button> </div>
      </div>
      <div id="char-album-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span data-lang-key="cphoneAlbumTitle">TAÁöÑÁõ∏ÂÜå</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-album-btn" title="ÈáçÊñ∞ÁîüÊàêÁõ∏ÂÜåÂÜÖÂÆπ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div class="list-container">
          <div id="char-album-grid"></div>
        </div>
      </div>
      <div id="char-browser-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span data-lang-key="cphoneBrowserTitle">TAÁöÑÊµèËßàÂô®ÂéÜÂè≤</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-browser-btn" title="ÈáçÊñ∞ÁîüÊàêÊµèËßàËÆ∞ÂΩï"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-browser-history" class="list-container"> </div>
      </div>
      <div id="char-browser-article-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharScreen('char-browser-screen')">‚Äπ</span> <span id="char-article-title" style="max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">ÊñáÁ´†</span>
          <div class="header-actions"> <span class="action-btn" id="favorite-article-btn" title="Êî∂Ëóè"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg> </span> <span class="action-btn" id="copy-article-content-btn" title="Â§çÂà∂ÂÜÖÂÆπ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg> </span> </div>
        </div>
        <div id="char-article-content" class="list-container" style="padding: 20px; font-size: 16px; line-height: 1.8; overflow-y: auto;"></div>
      </div>
      <div id="char-taobao-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span data-lang-key="cphoneTaobaoTitle">TAÁöÑÊ∑òÂÆùËÆ¢Âçï</span>
          <div class="header-actions"> <span class="action-btn" id="char-wallet-btn" title="Êü•ÁúãÈí±ÂåÖ" onclick="openCharWallet()"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M20 12V8H4v4"></path>
                <path d="M4 8V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2"></path>
                <path d="M18 12v6a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-6"></path>
              </svg> </span> <span class="action-btn" id="regenerate-char-taobao-btn" title="ÈáçÊñ∞ÁîüÊàêË¥≠‰π∞ËÆ∞ÂΩï"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-product-grid" class="list-container"></div>
      </div>
      <div id="char-wallet-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="char-wallet-back-btn">‚Äπ</span> <span data-lang-key="cphoneWalletTitle">Èí±ÂåÖ</span> <span style="width: 30px;"></span> </div>
        <div id="char-wallet-content" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
      </div>
      <div id="char-memo-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span data-lang-key="cphoneMemoTitle">Â§áÂøòÂΩï</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-memo-btn" title="ÈáçÊñ∞ÁîüÊàêÂ§áÂøòÂΩï"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> <span class="action-btn" id="add-char-memo-btn">+</span> </div>
        </div>
        <div id="char-memo-list" class="list-container" style="padding: 10px;"></div>
      </div>
      <div id="char-memo-detail-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="char-memo-detail-back-btn">‚Äπ</span> <span id="char-memo-detail-title"></span>
          <div class="header-actions"> <span class="action-btn" id="favorite-memo-btn" title="Êî∂Ëóè"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg> </span> <span class="action-btn" id="copy-memo-content-btn" title="Â§çÂà∂ÂÜÖÂÆπ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg> </span> </div>
        </div>
        <div class="form-container" style="padding: 0;"> <textarea id="char-memo-detail-content" readonly></textarea> </div>
      </div>
      <div id="char-diary-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span data-lang-key="cphoneDiaryTitle">Êó•ËÆ∞</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-diary-btn" title="ÈáçÊñ∞ÁîüÊàêÊó•ËÆ∞Êú¨"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> <span class="action-btn" id="add-char-diary-btn">+</span> </div>
        </div>
        <div id="char-diary-list" class="list-container"></div>
      </div>
      <div id="char-diary-detail-screen" class="char-screen">
        <div class="header"> <span class="back-btn" id="char-diary-detail-back-btn">‚Äπ </span> <span id="char-diary-detail-title"></span>
          <div class="header-actions"> <span class="action-btn" id="favorite-diary-btn" title="Êî∂Ëóè"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg> </span> <span class="action-btn" id="copy-diary-content-btn" title="Â§çÂà∂ÂÜÖÂÆπ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg> </span> </div>
        </div>
        <div id="char-diary-detail-content-wrapper" class="list-container">
          <div id="char-diary-detail-content"> </div>
        </div>
      </div>
      <div id="char-usage-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span data-lang-key="cphoneUsageTitle">App‰ΩøÁî®ËÆ∞ÂΩï</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-usage-btn" title="ÈáçÊñ∞ÁîüÊàêËÆ∞ÂΩï"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-usage-list" class="list-container"> </div>
      </div>
      <div id="char-qq-transcript-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
          <div class="modal-header"> <span id="transcript-modal-char-name"></span> </div>
          <div class="modal-body" id="transcript-modal-body" style="background-color: #f0f2f5; padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
          <div class="modal-footer"> <button class="save" id="close-transcript-modal-btn" style="width:100%;">ÂÖ≥Èó≠</button> </div>
        </div>
      </div>
      <div id="char-music-screen" class="char-screen">
        <div class="header"> <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> <span data-lang-key="cphoneMusicTitle">TAÁöÑÊ≠åÂçï</span>
          <div class="header-actions"> <span class="action-btn" id="regenerate-char-music-btn" title="ÈáçÊñ∞ÁîüÊàêÊ≠åÂçï"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
              </svg> </span> </div>
        </div>
        <div id="char-music-list" class="list-container"> </div>
      </div>
<div id="char-reddit-screen" class="char-screen">
  <div class="header" >
    <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span>
    <span>Reddit</span>
    
    <div class="header-actions"> 
        <span class="action-btn" id="regenerate-char-reddit-btn" title="Ê†πÊçÆ‰∫∫ËÆæÁîüÊàêÊé®ËçêÊµÅ"> 
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> 
        </span> 
    </div>
    </div>
  
  <div class="search-bar-container" style="background-color: #fff; padding: 10px; border-bottom: 1px solid #eee;">
    <div style="display: flex; gap: 8px;">
      <input type="search" id="char-reddit-search-input" placeholder="ÊêúÁ¥¢ Reddit..." 
             style="flex-grow:1; padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; background: #f6f7f8;">
      <button id="char-reddit-search-btn" class="form-button" 
              style="width: auto; margin: 0; padding: 0 15px; background-color: #FF4500; border-radius: 20px; font-size: 14px;">Go</button>
    </div>
  </div>

  <div id="char-reddit-list" class="list-container" style="padding: 0; background-color: #DAE0E6;">
  </div>
</div>
      <div id="char-bilibili-screen" class="char-screen">
        <div class="header"> 
            <span class="back-btn" onclick="switchToCharHomeScreen()">‚Äπ</span> 
            <span>Bilibili</span> 
            <div class="header-actions"> 
                <span class="action-btn" id="regenerate-char-bilibili-btn" title="Ê†πÊçÆ‰∫∫ËÆæÁîüÊàêÊé®Ëçê"> 
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                    </svg> 
                </span> 
            </div>
            </div>
        <div class="search-bar-container" style="padding: 10px; background: transparent;"> 
            <div style="display: flex; gap: 8px;">
                <input type="search" id="char-bilibili-search-input" placeholder="ÊêúÁ¥¢ËßÜÈ¢ë..." style="flex-grow:1; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color);"> 
                <button id="char-bilibili-search-btn" class="form-button" style="width: auto; margin: 0; padding: 0 15px; background-color: #FB7299;">ÊêúÁ¥¢</button> 
            </div>
        </div>
        <div id="char-bilibili-list" class="list-container" style="padding: 10px;"> </div>
      </div>

      <div id="char-bilibili-player-screen" class="char-screen" style="background-color: var(--secondary-bg);">
    <div class="header"> 
        <span class="back-btn" onclick="closeCharBilibiliPlayer()">‚Äπ</span> 
        <span>ËßÜÈ¢ëËØ¶ÊÉÖ</span> 
        <span style="width: 30px;"></span> 
    </div>
        <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="width: 100%; aspect-ratio: 16/9; background: black; display: flex; align-items: center;">
                <video id="char-bilibili-video" controls playsinline style="width: 100%; max-height: 100%;"></video>
            </div>
            <div class="list-container" style="background-color: var(--secondary-bg); flex-grow: 1; padding: 15px;">
                <h2 id="char-bilibili-player-title" style="font-size: 18px; margin: 0 0 10px 0; line-height: 1.4;"></h2>
                <div id="char-bilibili-player-author" style="font-size: 14px; color: #FB7299; font-weight: 500; margin-bottom: 15px;"></div>
                <div style="height: 1px; background: var(--border-color); margin-bottom: 15px;"></div>
                <div id="char-bilibili-player-desc" style="font-size: 13px; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap;"></div>
            </div>
        </div>
      </div>
    </div>
    <div id="world-book-screen" class="screen">
      <div class="header">
        <div class="header-left-actions"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span class="action-btn" id="import-world-book-btn" title="ÂØºÂÖ•‰∏ñÁïå‰π¶"data-lang-key-title="worldBookImportTitle"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg> </span> <span class="action-btn" id="export-world-book-btn" title="ÂØºÂá∫‰∏ñÁïå‰π¶"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg> </span> </div> <span data-lang-key="worldBookTitle">‰∏ñÁïå‰π¶</span>
        <div class="header-actions"> <span class="action-btn" id="manage-world-book-categories-btn" title="ÁÆ°ÁêÜÂàÜÁ±ª"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg> </span> <span class="action-btn" id="add-world-book-btn">+</span> </div>
      </div>
      <div id="world-book-tabs"></div>
      <div id="world-book-content-container"></div>
    </div>
    <div id="world-book-editor-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('world-book-screen')">‚Äπ</span> <span id="world-book-editor-title"data-lang-key="worldBookEditorTitle"data-lang-key="edit">ÁºñËæë‰∏ñÁïå‰π¶</span> <span class="save-btn" id="save-world-book-btn"data-lang-key="save">‰øùÂ≠ò</span> </div>
      <div class="form-container">
        <div class="form-group"> <label for="world-book-name-input"data-lang-key="worldBookNameLabel">‰π¶Âêç</label> <input type="text" id="world-book-name-input" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞..."data-lang-key-placeholder="worldBookNamePlaceholder"> </div>
        <div class="form-group"> <label for="world-book-category-select"data-lang-key="worldBookCategoryLabel">ÂàÜÁ±ª</label> <select id="world-book-category-select"></select> </div>
        <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;"> <label data-lang-key="worldBookEntriesLabel">ÂÜÖÂÆπÊù°ÁõÆ</label>
          <div id="world-book-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;"> </div>
        </div> <button id="add-world-book-entry-btn" class="form-button form-button-secondary"data-lang-key="worldBookAddEntryBtn"> [+] Ê∑ªÂä†Êñ∞Êù°ÁõÆ </button>
      </div>
    </div>
    <div id="preset-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span data-lang-key="presetTitle">È¢ÑËÆæ</span>
        <div class="header-actions"> <span class="action-btn" id="import-preset-btn" title="ÂØºÂÖ•È¢ÑËÆæÊñá‰ª∂" data-lang-key-title="presetImportTitle"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg> </span> <span class="action-btn" id="manage-preset-categories-btn" title="ÁÆ°ÁêÜÂàÜÁ±ª"data-lang-key-title="presetManageCategoriesTitle"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg> </span> <span class="action-btn" id="add-preset-btn">+</span> </div>
      </div>
      <div id="preset-tabs"></div>
      <div id="preset-content-container"></div>
    </div>
    <div id="movie-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span>ËßÇÂΩ±ÂÆ§</span> <span style="width: 30px;"></span> </div>
      <div class="movie-search-container">
        <!-- AIÈô™ÁúãËßíËâ≤ÈÄâÊã© -->
        <div id="ai-character-selector" style="margin-top: 15px; padding: 15px; background-color: rgba(255,255,255,0.95); border-radius: 12px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <label style="font-size: 14px; color: #666; flex-shrink: 0; font-weight: 600;">ü§ñ ÈÄâÊã©AIÈô™ÁúãËßíËâ≤Ôºö</label>
            <select id="ai-watch-character" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
              <option value="">Âä†ËΩΩ‰∏≠...</option>
            </select>
            <button id="open-character-window-btn" style="padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; white-space: nowrap; display: none;" title="ÊâìÂºÄËßíËâ≤Â∞èÁ™ó">
              üì± ÊâìÂºÄËßíËâ≤Â∞èÁ™ó
            </button>
          </div>
          <div id="character-description" style="font-size: 12px; color: #999; padding: 8px; background-color: #f5f5f5; border-radius: 6px; margin-top: 8px; display: none;">
            <!-- ËßíËâ≤ÊèèËø∞Â∞ÜÊòæÁ§∫Âú®ËøôÈáå -->
          </div>
          <!-- ËßÜËßâË∞ÉÁî®Èó¥ÈöîÈÖçÁΩÆ -->
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <label style="font-size: 13px; color: #666; flex-shrink: 0; font-weight: 600;">üì∏ ËßÜËßâË∞ÉÁî®ÊúÄÂ∞èÈó¥ÈöîÔºö</label>
              <input type="number" id="visual-interval-input" min="60" max="600" value="180" step="30" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
              <span style="font-size: 12px; color: #999;">Áßí</span>
            </div>
            <div style="font-size: 11px; color: #999; padding-left: 0;">
              üí° ËßÜËßâË∞ÉÁî®‰ªÖÂú®Êª°Ë∂≥Êó∂Èó¥Èó¥Èöî‰∏îËß¶ÂèëÊù°‰ª∂Êó∂ËøõË°åÔºàÊöÇÂÅú„ÄÅÊèêÂèäÁîªÈù¢„ÄÅÂâßÊÉÖËΩ¨ÊäòÔºâ
            </div>
          </div>
        </div>
        
        <!-- Ëá™ÂÆö‰πâÊí≠ÊîæÂå∫Âüü -->
        <div class="movie-search-box" style="margin-top: 10px;">
          <input type="text" id="custom-movie-url" class="movie-search-input" placeholder="ËæìÂÖ•ËßÜÈ¢ëÈìæÊé•Áõ¥Êé•Êí≠Êîæ...">
          <button id="play-custom-url-btn" class="movie-search-btn">Êí≠Êîæ</button>
        </div>
        <div style="margin-top: 10px; text-align: center;">
            <input type="file" id="custom-movie-file" accept="video/*" style="display: none;">
            <button id="upload-movie-btn" class="movie-search-btn" style="width: 100%; background-color: #6c757d; border-color: #6c757d;">üìÇ ‰∏ä‰º†Êú¨Âú∞ËßÜÈ¢ë</button>
        </div>
      </div>
      <div class="movie-player-container" id="movie-player-container">
        <button class="close-player-btn" id="close-player-btn">√ó</button>
        <button class="fullscreen-toggle-btn" id="fullscreen-toggle-btn" title="ÂÖ®Â±è">
          <svg class="icon-fullscreen-enter" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
          </svg>
          <svg class="icon-fullscreen-exit" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
          </svg>
        </button>
        <div class="login-hint" id="login-hint">
          <span>üí° ÈúÄË¶ÅÁôªÂΩïËßÇÁúã‰ºöÂëòÂÜÖÂÆπÔºü</span>
          <a href="https://v.qq.com" target="_blank" rel="noopener">ÂâçÂæÄÁôªÂΩï</a>
        </div>
        <iframe id="movie-iframe" class="movie-iframe" allow="autoplay; clipboard-read; clipboard-write" referrerpolicy="no-referrer-when-downgrade"></iframe>
        <video id="movie-video" class="movie-video" controls playsinline webkit-playsinline disablePictureInPicture controlsList="nodownload nofullscreen noremoteplayback"></video>
      </div>
    </div>
    <div id="tutorial-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span data-lang-key="tutorialTitle">ÊïôÁ®ã</span> <span style="width: 30px;"></span> </div>
      <div class="list-container" style="padding: 0; overflow: hidden;"> <iframe id="tutorial-iframe" src="tutorial.html" style="width: 100%; height: 100%; border: none;"></iframe> </div>
    </div>
    <div id="preset-editor-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('preset-screen')">‚Äπ</span> <span id="preset-editor-title"data-lang-key="presetEditorTitle">ÁºñËæëÈ¢ÑËÆæ</span> <span class="save-btn" id="save-preset-btn"data-lang-key="save">‰øùÂ≠ò</span> </div>
      <div class="form-container">
        <div class="form-group"> <label for="preset-name-input"data-lang-key="presetNameLabel">È¢ÑËÆæÂêçÁß∞</label> <input type="text" id="preset-name-input" placeholder="ËØ∑ËæìÂÖ•È¢ÑËÆæÁöÑÂêçÁß∞..."data-lang-key-placeholder="presetNamePlaceholder"> </div>
        <div class="form-group"> <label for="preset-category-select"data-lang-key="presetCategoryLabel">ÂàÜÁ±ª</label> <select id="preset-category-select"></select> </div>
        <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;"> <label data-lang-key="presetEntriesLabel">ÂÜÖÂÆπÊù°ÁõÆ</label>
          <div id="preset-entries-container" style="display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding: 5px; flex-grow: 1;"> </div>
        </div> <button type="button" id="add-preset-entry-btn" class="form-button form-button-secondary"data-lang-key="presetAddEntryBtn"> [+] Ê∑ªÂä†Êñ∞Êù°ÁõÆ </button>
      </div>
    </div>
    <div id="api-settings-screen" class="screen ios-settings-screen">
      <div class="header"> 
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> 
        <span data-lang-key="apiSettingsTitle">ËÆæÁΩÆ</span> 
        <span class="save-btn" id="save-api-settings-btn" data-lang-key="save">ÂÆåÊàê</span> 
      </div>
      
      <div class="settings-container ios-scroll-container">
        
        <!-- ËØ≠Ë®ÄËÆæÁΩÆ -->
        <div class="settings-section">
            <div class="settings-item">
                <label for="language-select" data-lang-key="languageLabel">ËØ≠Ë®Ä</label>
                <div class="settings-right">
                    <select id="language-select" class="settings-select">
                        <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- API È¢ÑËÆæ -->
        <div class="settings-header" data-lang-key="apiPresetManagement">ÈÖçÁΩÆÈ¢ÑËÆæ</div>
        <div class="settings-section">
            <div class="settings-item">
                 <!-- ‰∏ãÊãâÊ°ÜÂÆπÂô®Ôºöflex-grow Âç†Êª°Â∑¶‰æßÁ©∫Èó¥ÔºåÂÜÖÈÉ®Â∑¶ÂØπÈΩê -->
                 <div style="flex-grow: 1; display: flex; align-items: center; justify-content: flex-start; overflow: hidden;">
                     <select id="api-preset-select" class="settings-select">
                         <!-- JS Â°´ÂÖÖÈÄâÈ°π -->
                     </select>
                 </div>
                 
                 <!-- ÊåâÈíÆÁªÑÔºöÂõ∫ÂÆöÂú®Âè≥‰æß -->
                 <div class="settings-right" style="flex-grow: 0; width: auto; margin-left: 10px;">
                     <button id="save-api-preset-btn" class="settings-mini-btn">‰øùÂ≠ò</button>
                     <button id="delete-api-preset-btn" class="settings-mini-btn">Âà†Èô§</button>
                 </div>
            </div>
        </div>

        <!-- ‰∏ª API ËÆæÁΩÆ -->
        <div class="settings-header" data-lang-key="apiPrimarySettings">‰∏ª API (ÂØπËØù)</div>
        <div class="settings-section">
            <!-- 1. ÊèêÁ§∫Êù° (ËøòÂéüÊà™ÂõæÊïàÊûú) -->
            <div class="settings-tip-wrapper">
                <div class="settings-tip-content">
                    ÊèêÁ§∫: Ëã•Ë¶Å‰ΩøÁî®‚ÄúÂèëÈÄÅÂõæÁâá‚ÄùÂäüËÉΩÔºåËØ∑Âä°ÂøÖÈÄâÊã©ÊîØÊåÅ Vision(ËßÜËßâ) ÁöÑÊ®°ÂûãÔºåÂ¶Ç <code>gpt-4o</code> Êàñ <code>gpt-4-vision-preview</code>„ÄÇ
                </div>
            </div>

            <!-- 2. ËæìÂÖ•Ê°ÜÈÉ®ÂàÜ -->
            <div class="settings-item">
                <label>Âèç‰ª£Âú∞ÂùÄ</label>
                <div class="settings-right">
                    <input type="text" id="proxy-url" placeholder="https://api.openai.com">
                </div>
            </div>
            <div class="settings-item">
                <label>API Key</label>
                <div class="settings-right">
                    <input type="password" id="api-key" placeholder="sk-...">
                </div>
            </div>
            <div class="settings-item">
                <label>Ê®°Âûã</label>
                <div class="settings-right">
                    <select id="model-select" style="width: 100%; padding: 8px;">
                        <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°ÂûãÂàóË°®...</option>
                    </select>
                    <button id="fetch-models-btn" class="settings-mini-btn">ÊãâÂèñ</button>
                </div>
            </div>
        </div>

        <!-- ÂâØ API ËÆæÁΩÆ -->
        <div class="settings-header" data-lang-key="apiSecondarySettings">ÂâØ API (ÈïøËÆ∞ÂøÜÊÄªÁªì)</div>
        <div class="settings-section">
            <div class="settings-item">
                <label>Âèç‰ª£Âú∞ÂùÄ</label>
                <div class="settings-right">
                    <input type="text" id="secondary-proxy-url" placeholder="ÁïôÁ©∫‰ΩøÁî®‰∏ªAPI">
                </div>
            </div>
            <div class="settings-item">
                <label>API Key</label>
                <div class="settings-right">
                    <input type="password" id="secondary-api-key" placeholder="ÂèØÈÄâ">
                </div>
            </div>
            <!-- ‰øÆÊîπÁÇπÔºöÊ®°ÂûãÂíåÊãâÂèñÊåâÈíÆÂú®‰∏ÄË°å -->
            <div class="settings-item">
                <label>Ê®°Âûã</label>
                <div class="settings-right">
                     <!-- ‰∏ãÊãâÊ°ÜÂç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ -->
                    <select id="secondary-model-select" style="width: 100%; padding: 8px;">
                        <option value="">ËØ∑ÂÖàÊãâÂèñÊ®°ÂûãÂàóË°®...</option>
                    </select>
                    <!-- ÊåâÈíÆÊîæÂú®ÊóÅËæπ -->
                    <button id="fetch-secondary-models-btn" class="settings-mini-btn">ÊãâÂèñ</button>
                </div>
            </div>
        </div>

        <!-- ÂèÇÊï∞ËÆæÁΩÆ -->
        <div class="settings-header">ÂèÇÊï∞ËÆæÁΩÆ</div>
        <div class="settings-section">
             <div class="settings-item">
                <label>Ê∏©Â∫¶ (Temperature) <span id="api-temperature-value" style="color:var(--accent-color);">0.8</span></label>
                <div class="settings-right" style="width: 50%;">
                    <input type="range" id="api-temperature-slider" min="0" max="2" step="0.1" value="0.8">
                </div>
            </div>
        </div>

        <!-- ÂêéÂè∞‰∏éËá™Âä®Âåñ -->
        <div class="settings-header" data-lang-key="apiBgActivitySettings">ÂêéÂè∞Ê¥ªÂä®</div>
        <div class="settings-section">
            <div class="settings-item">
                <label>ÂêØÁî®ÂêéÂè∞ËßíËâ≤Ê¥ªÂä®</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="background-activity-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <label>Ê£ÄÊµãÈó¥Èöî (Áßí)</label>
                <div class="settings-right">
                    <input type="number" id="background-interval-input" min="30" value="60" class="settings-num-input">
                </div>
            </div>
            <div class="settings-item">
                <label>ÊãâÈªëÂÜ∑ÈùôÊúü (Â∞èÊó∂)</label>
                <div class="settings-right">
                    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" class="settings-num-input">
                </div>
            </div>
        </div>
        <div class="settings-header">Á≥ªÁªüÁ∫ßÈÄöÁü•</div>
<div class="settings-section">
    <div class="settings-item">
        <div>
            <label>ÂÖÅËÆ∏Á≥ªÁªüÊé®ÈÄÅ</label>
            <div class="settings-desc">iOSÈúÄÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπïÊâçËÉΩÁîüÊïà</div>
        </div>
        <div class="settings-right">
             <button id="enable-system-notifications-btn" class="settings-mini-btn" style="width: auto; padding: 6px 15px;">ÁÇπÂáªÊéàÊùÉ</button>
        </div>
    </div>
    <div class="settings-item">
        <label>ÊµãËØïÁ≥ªÁªüÈÄöÁü•</label>
        <div class="settings-right">
             <button id="test-system-notify-btn" class="settings-mini-btn">ÂèëÈÄÅÊµãËØï</button>
        </div>
    </div>
</div>

        <!-- ËØ≠Èü≥ËÆæÁΩÆ -->
        <div class="settings-header" data-lang-key="apiTtsSettings">Minimax TTS ËØ≠Èü≥</div>
        <div class="settings-section">
            <div class="settings-item">
                <label>Group ID</label>
                <div class="settings-right">
                     <input type="text" id="minimax-group-id" placeholder="ËæìÂÖ• Group ID">
                </div>
            </div>
            <div class="settings-item">
                <label>API Key</label>
                <div class="settings-right">
                     <input type="password" id="minimax-api-key" placeholder="ËæìÂÖ• API Key">
                </div>
            </div>
            <!-- ÂàÜË°å 1: Ê®°Âûã -->
            <div class="settings-item">
                <label>Ê®°Âûã</label>
                <div class="settings-right">
                    <select id="minimax-model-select" class="settings-select">
                        <!-- JS ‰ºöÂ°´ÂÖÖÈÄâÈ°π -->
                    </select>
                </div>
            </div>
            <!-- ÂàÜË°å 2: Êé•Âè£ÂüüÂêç (ÊâãÂä®ÂÜôÊ≠ªÂú®ËøôÈáåÔºå‰∏çÂÜç‰æùËµñ JS Âä®ÊÄÅÊèíÂÖ•) -->
            <div class="settings-item">
                <label>Êé•Âè£ÂüüÂêç</label>
                <div class="settings-right">
                    <select id="minimax-domain-select" class="settings-select">
                        <option value="https://api.minimax.chat">üá®üá≥ ÂõΩÂÜÖ (api.minimax.chat)</option>
                        <option value="https://api.minimaxi.chat">üåè Êµ∑Â§ñ (api.minimaxi.chat)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ÁîüÂõæËÆæÁΩÆ (AI & NovelAI) -->
        <div class="settings-header" data-lang-key="apiImageGenSettings">ÂõæÂÉèÁîüÊàê</div>
        <div class="settings-section">
            <!-- ÈÄöÁî®ÁîüÂõæ -->
            <div class="settings-item">
                <label>ÂêØÁî®ÈÄöÁî® AI ÁîüÂõæ</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-ai-drawing-switch">
                    <span class="slider"></span>
                </label>
            </div>
            
            <!-- NovelAI -->
            <div class="settings-item">
                <label>ÂêØÁî® NovelAI</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="novelai-switch">
                    <span class="slider"></span>
                </label>
            </div>
            
            <!-- NovelAI ËØ¶ÊÉÖ (JSÊéßÂà∂ÊòæÁ§∫/ÈöêËóè) -->
            <div id="novelai-details" style="display:none; background-color: #f9f9f9; border-top: 0.5px solid #ebedf0;">
                <div class="settings-item">
                    <label>Ê®°Âûã</label>
                    <div class="settings-right">
                         <select id="novelai-model" class="settings-select">
                            <option value="nai-diffusion-4-curated-preview">V4.5 Curated</option>
                            <option value="nai-diffusion-4-5-full">V4.5 Full</option>
                            <option value="nai-diffusion-3">Anime V3</option>
                        </select>
                    </div>
                </div>
                <div class="settings-item">
                    <label>API Key</label>
                    <div class="settings-right">
                        <div style="position:relative; width:100%;">
                             <input type="password" id="novelai-api-key" placeholder="pst-...">
                             <span id="novelai-key-toggle" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); cursor: pointer;">üßê</span>
                        </div>
                    </div>
                </div>
                <div class="settings-item" style="justify-content: space-around;">
                    <button id="novelai-settings-btn" class="settings-mini-btn">‚öôÔ∏è ÁîüÊàêÂèÇÊï∞</button>
                    <button id="novelai-test-btn" class="settings-mini-btn">üß™ ÊµãËØïÁîüÊàê</button>
                </div>
            </div>
        </div>

        <!-- ‰∫ëÊúçÂä°‰∏éÂ≠òÂÇ® -->
        <!-- ‰∫ëÊúçÂä°‰∏éÂ≠òÂÇ® (ÁÅ∞Êù°‰∏ãÊ≤âÁâà) -->
        <div class="settings-header">‰∫ëÊúçÂä°‰∏éÂ≠òÂÇ®</div>
        <div class="settings-section">
             
             <!-- === ImgBB === -->
             <!-- 1. ÂÖàÊîæÂºÄÂÖ≥Ë°å -->
             <div class="settings-item">
                <label>ImgBB ÂõæÂ∫ä</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="imgbb-enable-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <!-- 2. ÂÜçÊîæËØ¶ÊÉÖÂÆπÂô® (ÁÅ∞Êù°ÁßªÂÖ•Ê≠§Â§Ñ) -->
            <div id="imgbb-settings-details" style="display:none;">
                 <!-- ÁÅ∞Êù°Ë¢´ÁßªÂà∞‰∫ÜËøôÈáå -->
                 <div class="settings-tip-wrapper">
                    <div class="settings-tip-content">
                        ÂºÄÂêØÂêéÔºåÊú¨Âú∞ÂõæÁâáÂ∞ÜËá™Âä®‰∏ä‰º†Âà∞ ImgBB ÂõæÂ∫ä‰ª•ÂáèÂ∞è‰ΩìÁßØ„ÄÇ<br>
                        ‚ö†Ô∏è ÂõæÁâáÂ∞Ü‰∏ä‰º†Âà∞ÂÖ¨ÂÖ±‰∫íËÅîÁΩëÔºåËØ∑Âãø‰∏ä‰º†ÁßÅÂØÜÁÖßÁâáÔºÅ<br>
                        üîó <a href="https://api.imgbb.com/" target="_blank">ÁÇπÂáªÊ≠§Â§ÑÊ≥®ÂÜåÂπ∂Ëé∑Âèñ API Key</a>
                    </div>
                </div>
                
                 <div class="settings-item">
                    <label>API Key</label>
                     <div class="settings-right">
                        <div style="position:relative; width:100%;">
                            <input type="password" id="imgbb-api-key" placeholder="ËæìÂÖ• ImgBB Key">
                            <span id="imgbb-key-toggle" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); cursor: pointer;">üßê</span>
                        </div>
                     </div>
                 </div>
            </div>

            <!-- === Catbox === -->
             <!-- 1. ÂºÄÂÖ≥ -->
             <div class="settings-item">
                <label>Catbox ÊâòÁÆ°</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="catbox-enable-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <!-- 2. ËØ¶ÊÉÖÂÆπÂô® (ÁÅ∞Êù°ÁßªÂÖ•Ê≠§Â§Ñ) -->
            <div id="catbox-settings-details" style="display:none;">
                 <!-- ÁÅ∞Êù°Ë¢´ÁßªÂà∞‰∫ÜËøôÈáå -->
                 <div class="settings-tip-wrapper">
                    <div class="settings-tip-content">
                        ÂºÄÂêØÂêéÔºåÊ≠åÊõ≤Êñá‰ª∂Â∞Ü‰∏ä‰º†Âà∞ Catbox.moe ÊâòÁÆ°„ÄÇ<br>
                        üîó <a href="https://catbox.moe/user/manage.php" target="_blank">ÁôªÂΩï Catbox Êü•Áúã User Hash</a>
                    </div>
                </div>

                 <div class="settings-item">
                    <label>User Hash</label>
                     <div class="settings-right">
                        <div style="position:relative; width:100%;">
                            <input type="password" id="catbox-userhash" placeholder="ËæìÂÖ• User Hash">
                            <span id="catbox-key-toggle" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); cursor: pointer;">üßê</span>
                        </div>
                     </div>
                 </div>
            </div>

             <!-- === GitHub === -->
             <!-- 1. ÂºÄÂÖ≥ -->
             <div class="settings-item">
                <label>GitHub ‰∫ëÂ§á‰ªΩ</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="github-enable-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <!-- 2. ËØ¶ÊÉÖÂÆπÂô® (ÁÅ∞Êù°ÁßªÂÖ•Ê≠§Â§Ñ) -->
            <div id="github-settings-details" style="display:none;">
                <!-- ÁÅ∞Êù°Ë¢´ÁßªÂà∞‰∫ÜËøôÈáå -->
                <div class="settings-tip-wrapper">
                    <div class="settings-tip-content">
                        Â∞ÜÊï∞ÊçÆÂ§á‰ªΩÂà∞ÁßÅÊúâ GitHub ‰ªìÂ∫ìÔºåÊñπ‰æøË∑®ËÆæÂ§áÂêåÊ≠•„ÄÇ<br>
                        1. <a href="https://github.com/new" target="_blank">ÂàõÂª∫Êñ∞‰ªìÂ∫ì</a> (Âª∫ËÆÆËÆæ‰∏∫ Private)<br>
                        2. <a href="https://github.com/settings/tokens" target="_blank">Ëé∑Âèñ Token</a> (ÂøÖÈ°ªÂãæÈÄâ <strong>repo</strong> ÊùÉÈôê)
                    </div>
                </div>

                <div class="settings-item">
                    <label>Ëá™Âä®Â§á‰ªΩ (ÂàÜÈíü)</label>
                    <div class="settings-right" style="gap: 5px;">
                         <input type="number" id="github-backup-interval" value="30" class="settings-num-input">
                         <label class="toggle-switch" style="transform: scale(0.8);">
                            <input type="checkbox" id="github-auto-backup-switch">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                 <div class="settings-item"><label>Áî®Êà∑Âêç</label><div class="settings-right"><input type="text" id="github-username" placeholder="Â¶Ç: yourname"></div></div>
                 <div class="settings-item"><label>‰ªìÂ∫ìÂêç</label><div class="settings-right"><input type="text" id="github-repo" placeholder="Â¶Ç: my-backup"></div></div>
                 <div class="settings-item"><label>Token</label><div class="settings-right"><div style="position:relative; width:100%;"><input type="password" id="github-token"><span id="github-token-toggle" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); cursor: pointer;">üßê</span></div></div></div>
                 <div class="settings-item"><label>Êñá‰ª∂Âêç</label><div class="settings-right"><input type="text" id="github-filename" value="ephone_backup.json"></div></div>
                 
                 <!-- GitHub Proxy -->
                 <div class="settings-item">
                    <label>‰ª£ÁêÜ (Worker)</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="github-proxy-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                 <div id="github-proxy-input-group" style="display:none;">
                     <div class="settings-tip-wrapper" style="padding-top:10px !important;">
                        <div class="settings-tip-content">
                            ÂõΩÂÜÖÁΩëÁªúÂª∫ËÆÆÂºÄÂêØ„ÄÇÈúÄËá™Âª∫ Cloudflare Worker„ÄÇ<br>
                            üîó <a href="https://dash.cloudflare.com/" target="_blank">ÂâçÂæÄ Cloudflare ÊéßÂà∂Âè∞</a>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label>‰ª£ÁêÜÂú∞ÂùÄ</label>
                        <div class="settings-right"><input type="text" id="github-proxy-url" placeholder="https://..."></div>
                    </div>
                 </div>
                 
                 <!-- GitHub ÊåâÈíÆ -->
                 <div class="settings-item" style="justify-content: space-around;">
                    <button id="github-upload-btn" class="settings-mini-btn">‚òÅÔ∏è ‰∏ä‰º†Â§á‰ªΩ</button>
                    <button id="github-download-btn" class="settings-mini-btn">üì• ÊÅ¢Â§çÂ§á‰ªΩ</button>
                </div>
            </div>
        </div>
        <!-- ÊÄßËÉΩ -->
        <div class="settings-header">ÊÄßËÉΩ‰∏éÊòæÁ§∫</div>
        <div class="settings-section">
            <div class="settings-item">
                <label>ËÅäÂ§©ÂàóË°®Âä†ËΩΩÊï∞</label>
                <div class="settings-right">
                    <input type="number" id="chat-list-render-window-input" class="settings-num-input">
                </div>
            </div>
             <div class="settings-item">
                <label>ËÅäÂ§©ÂÜÖÂä†ËΩΩÊï∞</label>
                <div class="settings-right">
                    <input type="number" id="chat-render-window-input" class="settings-num-input">
                </div>
            </div>
        </div>

        <!-- Êï∞ÊçÆÁÆ°ÁêÜ (Âç±Èô©Âå∫Âüü) -->
        <div class="settings-header">Êï∞ÊçÆÁÆ°ÁêÜ</div>
        
        <div class="settings-section">
            <!-- 1. ÂõæÁâáÂç†Áî® + ÂéãÁº©ÊåâÈíÆ (Âêå‰∏ÄË°å) -->
            <div class="settings-item">
                <!-- Â∑¶‰æßÊ†áÈ¢ò -->
                <label style="flex-shrink: 0;">Êú¨Âú∞ÂõæÁâáÂç†Áî®</label>
                
                <!-- Âè≥‰æßÂå∫ÂüüÔºöÊï∞ÂÄº + ÊåâÈíÆ -->
                <div class="data-row-right">
                    <!-- Êï∞ÂÄº (Áî±JSÂ°´ÂÖÖÔºåCSS‰ºöÈöêËóèÂ§ö‰ΩôÊñáÂ≠óÂè™ÁïôMB) -->
                    <span id="total-image-size-display">ËÆ°ÁÆó‰∏≠...</span>
                    
                    <!-- ÂéãÁº©ÊåâÈíÆ -->
                    <button id="compress-images-btn" class="settings-mini-btn">ÂéãÁº©</button>
                </div>
            </div>
            
            <!-- ÂàóË°®ÊåâÈíÆÔºöÈªëËâ≤Â∑¶ÂØπÈΩê -->
            <button class="settings-full-btn" id="export-data-btn">ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ</button>
            <button class="settings-full-btn" id="import-btn">ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂</button>
            <input id="import-data-input" type="file" accept="application/json" hidden>
            
            <button class="settings-full-btn" id="cleanup-data-btn">Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆ</button>
            <button class="settings-full-btn" id="delete-world-books-btn">Âà†Èô§‰∏ñÁïå‰π¶</button>
            <button class="settings-full-btn" id="clear-specific-data-btn">È´òÁ∫ßÊï∞ÊçÆÊ∏ÖÁêÜ</button>
            <button class="settings-full-btn" id="check-and-fix-data-btn">Êï∞ÊçÆÊ£ÄÊü•‰∏é‰øÆÂ§ç</button>
            <button class="settings-full-btn" id="emergency-reset-appearance-btn" >ÈáçÁΩÆÂΩìÂâçÂ§ñËßÇ</button>
            <button class="settings-full-btn" id="factory-reset-btn" > ÂàùÂßãÂåñÊâÄÊúâÂÜÖÂÆπ (ÊÖéÁî®)</button>
<button class="settings-full-btn" id="logout-btn" >
    ÈÄÄÂá∫ÁôªÂΩï (ÂàáÊç¢Ë¥¶Âè∑)
</button>
        </div>
        
        <!-- Â∫ïÈÉ®Âû´È´ò -->
        <div style="height: 60px;"></div>
      </div>
    </div>
<div id="import-options-modal" class="modal">
  <div class="modal-content" style="height: auto;">
    <div class="modal-header">
      <span>ÂèëÁé∞Â§á‰ªΩÊñá‰ª∂</span>
    </div>
    <div class="modal-body">
      <p>Âú®Ê≠§Â§á‰ªΩÊñá‰ª∂‰∏≠ÊâæÂà∞‰∫Ü‰ª•‰∏ãÊï∞ÊçÆÔºö</p>
      <ul id="import-preview-list" style="text-align: left; margin-left: 20px; max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        </ul>
      <hr style="opacity: 0.2; margin: 20px 0;">
      <p style="font-weight: bold;">ËØ∑ÈÄâÊã©ÂØºÂÖ•ÊñπÂºèÔºö</p>
    </div>
    <div class="modal-footer" style="flex-direction: column; gap: 10px;">
      <button class="save btn-danger" id="confirm-full-import-btn" style="width: 100%; background-color: #ff3b30; border-color: #ff3b30;">
        <strong>ÂÆåÂÖ®ÂØºÂÖ• (Ë¶ÜÁõñÊâÄÊúâÊï∞ÊçÆ)</strong>
        <small style="display: block; font-weight: normal; opacity: 0.8;">Â∞ÜÂà†Èô§Êú¨Âú∞ÊâÄÊúâÊï∞ÊçÆÔºåÂπ∂ÊõøÊç¢‰∏∫Â§á‰ªΩÊñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆ„ÄÇ</small>
      </button>
      <button class="save" id="confirm-selective-import-btn" style="width: 100%;">
        <strong>ÈÄâÊã©ÊÄßÂØºÂÖ• (ÂêàÂπ∂Êï∞ÊçÆ)</strong>
        <small style="display: block; font-weight: normal; opacity: 0.8;">Â∞ÜÂ§á‰ªΩÊñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆ„ÄêÊ∑ªÂä†„ÄëÂà∞ÊÇ®Áé∞ÊúâÁöÑÊï∞ÊçÆ‰∏≠„ÄÇ</small>
      </button>
      <button class="cancel" id="cancel-import-options-btn" style="width: 100%; margin-top: 8px;" data-lang-key="cancel">ÂèñÊ∂à</button>
    </div>
  </div>
</div>

<div id="selective-import-modal" class="modal">
  <div class="modal-content" style="height: 70%;">
    <div class="modal-header">
      <span>ÈÄâÊã©Ë¶ÅÂêàÂπ∂ÁöÑÊï∞ÊçÆ</span>
      <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;">
        <input type="checkbox" id="select-all-import-types"> ÂÖ®ÈÄâ
      </label>
    </div>
    <div class="modal-body" id="selective-import-list" style="padding: 0;">
      </div>
    <div class="modal-footer">
      <button class="cancel" id="cancel-selective-import-btn" data-lang-key="cancel">ÂèñÊ∂à</button>
      <button class="save" id="confirm-merge-import-btn">Á°ÆËÆ§ÂêàÂπ∂</button>
    </div>
  </div>
</div>
    <div id="data-clear-wizard-modal" class="modal">
      <div class="modal-content" style="height: 80%;">
        <div id="data-clear-step-1" class="wizard-step">
          <div class="modal-header"> <span>Á¨¨‰∏ÄÊ≠•ÔºöÈÄâÊã©Ë¶ÅÊ∏ÖÁêÜÁöÑËßíËâ≤</span> <label> <input type="checkbox" id="select-all-chars-for-clear"> ÂÖ®ÈÄâ </label> </div>
          <div class="modal-body" id="data-clear-char-list" style="padding: 0;"> </div>
          <div class="modal-footer"> <button class="cancel" id="cancel-clear-wizard-btn-step1"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="go-to-clear-step2-btn">‰∏ã‰∏ÄÊ≠•</button> </div>
        </div>
        <div id="data-clear-step-2" class="wizard-step" style="display: none;">
          <div class="modal-header"> <span>Á¨¨‰∫åÊ≠•ÔºöÈÄâÊã©Ë¶ÅÊ∏ÖÁêÜÁöÑÊï∞ÊçÆÁ±ªÂûã</span> <label> <input type="checkbox" id="select-all-types-for-clear"> ÂÖ®ÈÄâ </label> </div>
          <div class="modal-body" id="data-clear-type-list" style="padding: 0;"> </div>
          <div class="modal-footer"> <button class="form-button-secondary" id="back-to-clear-step1-btn" style="width: 30%; margin:0;">‰∏ä‰∏ÄÊ≠•</button> <button class="cancel" id="cancel-clear-wizard-btn-step2" style="width: 30%; margin:0;"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save btn-danger"
              id="confirm-final-clear-btn" style="width: 30%; margin:0;">Á°ÆËÆ§Ê∏ÖÁêÜ</button> </div>
        </div>
      </div>
    </div>
    <div id="chat-list-screen" class="screen">
      <div class="header" id="main-chat-list-header"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span id="chat-list-title"data-lang-key="chatListTitle">Ê∂àÊÅØ</span>
        <div class="header-actions"> <span class="action-btn" id="add-group-chat-btn" title="ÂàõÂª∫Áæ§ËÅä"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg></span> <span class="action-btn" id="add-chat-btn">+</span> </div>
      </div>
      <div id="messages-view" class="chat-list-view active">
        <div id="chat-list"> </div>
      </div>
      <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header"> <span class="back-btn" id="qzone-back-btn">‚Äπ</span> <span data-lang-key="qzoneTitle">Â•ΩÂèãÂä®ÊÄÅ</span>
          <div class="header-actions"> <span class="action-btn" id="qzone-more-actions-btn" title="Êõ¥Â§öÊìç‰Ωú">‚Ä¶</span> </div>
        </div>
        <div class="qzone-content">
          <div class="qzone-profile-header">
            <div id="qzone-banner-container" class="qzone-banner-container"> <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="ËÉåÊôØ"> <input type="file" id="qzone-banner-input" accept="image/*" hidden> </div>
            <div class="qzone-user-info">
              <div id="qzone-avatar-container" class="qzone-avatar-container"> <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="Â§¥ÂÉè"> <input type="file" id="qzone-avatar-input" accept="image/*" hidden> </div> <span id="qzone-nickname">{{user}}</span>
            </div>
          </div>
          <div class="qzone-actions-bar">
            <div class="action-item" id="create-shuoshuo-btn"><span data-lang-key="qzoneActionShuoshuo">ËØ¥ËØ¥</span></div>
            <div class="action-item" id="create-post-btn"><span data-lang-key="qzoneActionPost">Âä®ÊÄÅ</span></div>
            <div class="action-item" id="open-album-btn"><span data-lang-key="qzoneActionAlbum">Áõ∏ÂÜå</span></div>
          </div>
          <div id="qzone-posts-list"></div>
        </div>
      </div>
      <div id="favorites-view" class="chat-list-view">
        <div class="header"> <span class="back-btn" id="favorites-back-btn">‚Äπ</span> <span data-lang-key="navFavorites">ÊàëÁöÑÊî∂Ëóè</span> <span class="action-btn" id="favorites-edit-btn"data-lang-key="edit">ÁºñËæë</span> </div>
        <div class="search-bar-container"> <input type="search" id="favorites-search-input" placeholder="ÊêúÁ¥¢Êî∂ËóèÁöÑÊ†áÈ¢ò„ÄÅÂÜÖÂÆπÊàñ‰ΩúËÄÖ..."> <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">√ó</button> </div>
        <div id="favorites-list" class="list-container"> </div>
        <div id="favorites-action-bar" style="display: none;"> <button id="favorites-delete-selected-btn" class="action-bar-btn">Âà†Èô§ (0)</button> </div>
      </div>
      <div id="memories-view" class="chat-list-view">
        <div class="header"> <span class="back-btn" id="memories-back-btn">‚Äπ</span> <span>Êàë‰ª¨ÁöÑÂõûÂøÜ</span> <span class="action-btn" id="add-countdown-btn">+</span> </div>
        <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
      </div>
      <div id="npc-list-view" class="chat-list-view">
        <div class="header"> <span class="back-btn" id="npc-list-back-btn">‚Äπ</span> <span>NPC ÂàóË°®</span>
          <div class="header-actions"> <span class="action-btn" id="add-npc-btn">+</span> </div>
        </div>
        <div id="npc-list" class="list-container" style="padding: 0;"> </div>
      </div>
      <div id="chat-list-bottom-nav">
        <div class="nav-item active" data-view="messages-view"> <span data-lang-key="navMessages">Ê∂àÊÅØ</span> </div>
        <div class="nav-item" data-view="qzone-screen"> <span data-lang-key="navQzone">Âä®ÊÄÅ</span> </div>
        <div class="nav-item" data-view="memories-view"> <span data-lang-key="navMemories">ÂõûÂøÜ</span> </div>
        <div class="nav-item" data-view="favorites-view"> <span data-lang-key="navFavorites">Êî∂Ëóè</span> </div>
        <div class="nav-item" data-view="npc-list-view"> <span data-lang-key="navNpcList">NPC</span> </div>
      </div>
    </div>
    <div id="album-screen" class="screen">
      <div class="header"> <span class="back-btn" id="album-back-btn">‚Äπ</span> <span>ÊàëÁöÑÁõ∏ÂÜå</span> <span class="action-btn" id="create-album-btn-page">+</span> </div>
      <div class="list-container">
        <div id="album-grid-page"> </div>
      </div>
    </div>
    <div id="album-photos-screen" class="screen">
      <div class="header"> <span class="back-btn" id="album-photos-back-btn">‚Äπ</span> <span id="album-photos-title">Áõ∏ÂÜåÂêçÁß∞</span> <span class="action-btn" id="album-upload-photo-btn">‰∏ä‰º†</span> </div>
      <div class="list-container">
        <div id="photos-grid-page"> </div>
        <div id="photo-viewer-modal" class="modal"> <button id="photo-viewer-close-btn">√ó</button> <button id="photo-viewer-prev-btn" class="nav-arrow">‚Äπ</button>
          <div class="photo-viewer-content"> <img id="photo-viewer-image" src="" alt="ÂÖ®Â±èÁÖßÁâáÈ¢ÑËßà"> </div> <button id="photo-viewer-next-btn" class="nav-arrow">‚Ä∫</button>
        </div>
      </div>
    </div>
    <div id="npc-editor-modal" class="modal">
      <div class="modal-content" style="height: 80%;">
        <div class="modal-header"> <span id="npc-editor-title"data-lang-key="add">Ê∑ªÂä† NPC</span> </div>
        <div class="modal-body">
          <div class="form-group"> <label>NPC Â§¥ÂÉè</label>
            <div class="avatar-upload"> <img id="npc-avatar-preview" src="https://i.postimg.cc/VkQfgzGJ/1.jpg"> <button onclick="document.getElementById('npc-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button> <input type="file" id="npc-avatar-input" accept="image/*" hidden> </div>
          </div>
          <div class="form-group"> <label for="npc-name-input">NPC ÊòµÁß∞</label> <input type="text" id="npc-name-input" placeholder="ËæìÂÖ•NPCÁöÑÂ∏∏Áî®Âêç"> </div>
          <div class="form-group"> <label for="npc-persona-input">NPC ‰∫∫ËÆæ</label> <textarea id="npc-persona-input" rows="4" placeholder="ËØ¶ÁªÜÊèèËø∞Ëøô‰∏™NPCÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºèÁ≠â..."></textarea> </div>
<div class="form-group" id="npc-group-section">
            <label for="npc-group-select">NPC ÂàÜÁªÑ (Áî®‰∫éNPCÈó¥‰∫íËØÑ)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <select id="npc-group-select" style="flex-grow: 1;">
                <option value="">-- Êú™ÂàÜÁªÑ --</option>
              </select>
              <button id="manage-npc-groups-btn" type="button" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ÁÆ°ÁêÜÂàÜÁªÑ</button>
            </div>
            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                Âè™ÊúâÂú®Âêå‰∏Ä‰∏™ÂàÜÁªÑÂÜÖÁöÑNPCÊâçËÉΩ‰∫íÁõ∏ÁúãËßÅÂíåËØÑËÆ∫ÂØπÊñπÁöÑÂä®ÊÄÅ„ÄÇ
            </p>
          </div>
          <hr style="opacity: 0.2;">
          <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;"> <label for="npc-background-activity-switch" style="margin-bottom: 0;"> ÂêØÁî®Áã¨Á´ãÂêéÂè∞Ê¥ªÂä® <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                ÂÖÅËÆ∏ËØ•NPCÂú®ÂêéÂè∞Áã¨Á´ãÂèëË°®Âä®ÊÄÅËØÑËÆ∫„ÄÇÈúÄÂêåÊó∂ÂºÄÂêØAPIËÆæÁΩÆ‰∏≠ÁöÑÊÄªÂºÄÂÖ≥„ÄÇ </p> </label> <label class="toggle-switch"> <input type="checkbox" id="npc-background-activity-switch"> <span class="slider"></span> </label> </div>
          <div class="form-group"> <label for="npc-action-cooldown-input"> Áã¨Á´ãË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü) <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> ËØ•NPCÂú®ÂêéÂè∞‰∏ªÂä®Ë°åÂä®ÁöÑÊúÄÂ∞èÈó¥Èöî„ÄÇ </p> </label> <input type="number" id="npc-action-cooldown-input" min="1" value="15"
              style="width: 80px; text-align: center;"> </div>
          <div class="form-group"> <label>ÂÖ≥ËÅîÁöÑËßíËâ≤ (NPC‰ºöÂéªËØÑËÆ∫Ëøô‰∫õËßíËâ≤ÁöÑÂä®ÊÄÅ)</label>
            <div id="npc-association-list" style="max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;"> </div>
          </div>
        </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-npc-editor-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-npc-btn">‰øùÂ≠ò</button> </div>
      </div>
    </div>
    <div id="clear-posts-modal" class="modal">
      <div class="modal-content" style="height: 70%;">
        <div class="modal-header"> <span>ÈÄâÊã©Ê∏ÖÁ©∫ËåÉÂõ¥</span> </div>
        <div class="modal-body" id="clear-posts-list" style="padding: 0;"> </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-clear-posts-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save btn-danger" id="confirm-clear-posts-btn">Á°ÆËÆ§Ê∏ÖÁ©∫</button> </div>
      </div>
    </div> <input type="file" id="album-photo-input" accept="image/*" multiple hidden>
    <div id="chat-interface-screen" class="screen">
      <div id="gomoku-overlay">
        <div id="gomoku-content-wrapper"> <canvas id="gomoku-board"></canvas>
          <div id="gomoku-controls"> <button id="close-gomoku-btn">Êî∂Ëµ∑Ê£ãÁõò</button> </div>
        </div>
      </div>
      <div id="reading-overlay">
        <div id="reading-restore-btn" style="display: none;">üìñ</div>
        <div id="reading-window">
          <div class="reading-header"> <span id="reading-title">Êú™ÈÄâÊã©‰π¶Á±ç</span>
            <div class="reading-controls"> <button id="toggle-reading-fullscreen-btn" title="ÂàáÊç¢ÂÖ®Â±è">
        <svg class="icon-maximize" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
        </svg>
        <svg class="icon-minimize" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
        </svg>
    </button><button id="minimize-reading-btn" title="ÊúÄÂ∞èÂåñ" style="font-size: 20px; line-height: 1;"> <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg> </button> <button id="open-reading-library-btn" title="ÊâìÂºÄ‰π¶Â∫ì" style="font-size: 22px; line-height: 1;"> <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg></button> <button id="close-reading-btn" title="ÂÖ≥Èó≠"> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg> </button></div>
          </div>
          <div id="reading-content">
            <p>ÁÇπÂáª‚ÄúÂØºÂÖ•‚ÄùÊåâÈíÆÔºå<br>‰ªéÊú¨Âú∞.txtÊñá‰ª∂ÊàñÁΩëÁªúURLÂä†ËΩΩ‰π¶Á±çÂÜÖÂÆπ„ÄÇ</p>
          </div>
          <div class="reading-footer"> <button id="prev-page-btn">‰∏ä‰∏ÄÈ°µ</button> <span id="page-indicator">0 / 0</span> <button id="next-page-btn">‰∏ã‰∏ÄÈ°µ</button> </div>
        </div>
      </div><input type="file" id="book-upload-input" accept=".txt, text/plain" hidden>
      <div class="header">
        <div class="default-controls"> <span class="back-btn" id="back-to-list-btn">‚Äπ</span>
          <div id="global-lyrics-bar"></div>
          <div id="chat-header-title-wrapper"> <span id="chat-header-title">ËÅäÂ§©ÂØπË±°</span>
            <div id="chat-header-status"> <span class="status-dot"></span> <span class="status-text">Âú®Á∫ø</span> </div>
          </div>
          <div class="header-actions"> <span class="action-btn" id="open-memory-screen-btn" title="ÈïøÊúüËÆ∞ÂøÜ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M12 6L9 9L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path d="M21 5V19C21 20.1046 20.1046 21 19 21H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg> </span> <span class="action-btn" id="listen-together-btn" title="‰∏ÄËµ∑Âê¨"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="‰∏ÄËµ∑Âê¨"></span> <span class="action-btn" id="chat-settings-btn" title="ËÅäÂ§©ËÆæÁΩÆ"><img
                src="https://i.postimg.cc/bvPq64cv/CCA834-BA-5-A90-408-D-94-FA-7-EE156-B6-A765.png" alt="ËÆæÁΩÆ"></span> </div>
        </div>
        <div class="selection-controls"> 
          <!-- ÂèñÊ∂àÊåâÈíÆ (ÊõøÊç¢‰∏∫ X ÂõæÊ†á) -->
          <span id="selection-cancel-btn" title="ÂèñÊ∂à"> 
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
               <line x1="18" y1="6" x2="6" y2="18"></line>
               <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </span> 

          <span id="selection-count"></span>
          
          <div class="header-actions"> 
            <!-- Âè≥‰æßÁöÑÂÖ∂‰ªñÊåâÈíÆ‰øùÊåÅ‰Ω†ÂàöÊâç‰øÆÊîπÁöÑ SVG ‰∏çÂèò -->
            <span id="selection-screenshot-btn" class="action-btn" title="ÈïøÊà™Âõæ"> 
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                  <circle cx="12" cy="13" r="4"></circle>
               </svg>
            </span> 
            <span id="selection-favorite-btn" class="action-btn" title="Êî∂Ëóè"> 
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
               </svg>
            </span> 
            <span id="selection-share-btn" class="action-btn" title="ÂàÜ‰∫´"> 
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="18" cy="5" r="3"></circle>
                  <circle cx="6" cy="12" r="3"></circle>
                  <circle cx="18" cy="19" r="3"></circle>
                  <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                  <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
               </svg>
            </span> 
            <span id="selection-soft-delete-btn" class="action-btn" title="Âà†Èô§(ÈÄöÁü•AI)"> 
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
               </svg>
            </span>
            <span id="selection-erase-btn" class="action-btn" style="color: #ff3b30;" title="ÂΩªÂ∫ïÂà†Èô§">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 20H7L3 16C2 15 2 13 3 12L13 2L22 11L20 20Z"></path>
                  <path d="M17 17L7 7"></path>
               </svg>
            </span> 
          </div>
        </div>
      </div>
      <div id="chat-messages">
        <div id="typing-indicator">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div>
      </div>
      <div id="chat-input-area">
        <div id="chat-at-mention-popup" class="at-mention-popup"></div>
        <div id="reply-preview-bar">
          <div class="reply-preview-content">
            <div class="sender">ÂõûÂ§ç xxx:</div>
            <div class="text">Ë¢´ÂºïÁî®ÁöÑÊ∂àÊÅØÂÜÖÂÆπ...</div>
          </div> <span id="cancel-reply-btn">√ó</span>
        </div>
        <div id="chat-input-actions-top"> <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="Ë°®ÊÉÖÈù¢Êùø">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
        <line x1="9" y1="9" x2="9.01" y2="9"></line>
        <line x1="15" y1="9" x2="15.01" y2="9"></line>
    </svg>
</button> <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅÁÖßÁâá"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
              xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
              <circle cx="12" cy="13" r="4"></circle>
            </svg></button> <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="‰∏ä‰º†ÂõæÁâá"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg> </button><button id="transfer-btn" class="chat-action-icon-btn action-button" title="ËΩ¨Ë¥¶">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="6" width="20" height="12" rx="2"></rect>
        <circle cx="12" cy="12" r="2"></circle>
        <path d="M6 12h.01M18 12h.01"></path>
    </svg>
</button><button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅËØ≠Èü≥"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
              xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <path d="M12 19v4"></path>
              <path d="M8 23h8"></path>
            </svg></button> <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="ÂèëËµ∑Â§ñÂçñËØ∑Ê±Ç"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <path d="M16 10a4 4 0 0 1-8 0"></path>
            </svg></button> <button id="video-call-btn" class="chat-action-icon-btn action-button" title="ËßÜÈ¢ëÈÄöËØù"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="23 7 16 12 23 17 23 7"></polygon>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
            </svg></button> <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="Áæ§ËßÜÈ¢ëÈÄöËØù"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg></button> <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="ÂèëËµ∑ÊäïÁ•®"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M8 6h10"></path>
              <path d="M6 6h.01"></path>
              <path d="M8 12h10"></path>
              <path d="M6 12h.01"></path>
              <path d="M8 18h10"></path>
              <path d="M6 18h.01"></path>
            </svg></button> <button id="share-link-btn" class="chat-action-icon-btn action-button" title="ÂàÜ‰∫´ÈìæÊé•"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
            </svg></button> <button id="share-location-btn" class="chat-action-icon-btn action-button" title="ÂÖ±‰∫´‰ΩçÁΩÆ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg></button> <button id="gomoku-btn" class="chat-action-icon-btn action-button" title="‰∫îÂ≠êÊ£ã"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="4"></circle>
              <circle cx="12" cy="12" r="7"></circle>
            </svg> </button> <button id="open-shopping-btn" class="chat-action-icon-btn action-button" title="Ë¥≠Áâ©"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg> </button> <button id="pat-btn" class="chat-action-icon-btn action-button" title="Êãç‰∏Ä-Êãç" style="display: none;"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 5.02c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M14.5 11.02c0 .83-.67 1.5-1.5 1.5v0c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5v0c.83 0 1.5.67 1.5 1.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M5.5 14.52l-1.92-1.92c-.34-.34-.34-.89 0-1.23l3.58-3.58c.34-.34.89-.34 1.23 0l1.92 1.92c.34.34.34.89 0 1.23l-3.58 3.58c-.34.34-.89.34-1.23 0Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
            </svg> </button> <button id="edit-last-response-btn" class="chat-action-icon-btn action-button" title="ÂØºÊºîÊ®°ÂºèÔºöÁºñËæëAI‰∏ä‰∏ÄËΩÆÁöÑÂÆåÊï¥ÂìçÂ∫î"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg> </button> <button id="regenerate-btn" class="chat-action-icon-btn action-button" title="ÈáçÊñ∞ÁîüÊàêÂõûÂ§ç" style="display: flex;"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> </button> <button id="propel-btn" class="chat-action-icon-btn action-button" title="Êé®ËøõÂâßÊÉÖ" style="display: flex;"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <polygon points="13 19 22 12 13 5 13 19"></polygon>
              <polygon points="2 19 11 12 2 5 2 19"></polygon>
            </svg> </button> <button id="show-announcement-board-btn" class="chat-action-icon-btn action-button" title="Áæ§ÂÖ¨ÂëäÊùø" style="display: none;"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21.782 6.132a1 1 0 0 0-1.053-.08l-4.729 2.489a1 1 0 0 0-.5.88v4.158a1 1 0 0 0 .5.88l4.729 2.489a1 1 0 0 0 1.053-.08a1 1 0 0 0 .499-.921V7.052a1 1 0 0 0-.499-.92zm-6 3.207L11 7.05v9.9l4.782-2.281V9.339zM10 6H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h6V6z" />
            </svg> </button><button id="werewolf-game-btn" class="chat-action-icon-btn action-button" title="Áãº‰∫∫ÊùÄ" style="display: none;"> <svg width="24" height="24" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M332.6 128.5c-61.1 0-110.5 49.4-110.5 110.5 0 23.4 7.3 45.1 19.9 63.3-19.3 6.3-40.1 9.7-61.9 9.7-88.2 0-160-71.8-160-160s71.8-160 160-160c5.3 0 10.5.3 15.6.8C202.9 44.1 160 0 160 0s-53.3 44.1-45.9 92.5c-48.4 24.3-82.1 73.4-82.1 129.6 0 80.9 65.5 146.4 146.4 146.4 20.2 0 39.4-4.1 56.8-11.5 24.1 33.6 63.3 56.8 107.4 56.8 7.2 0 14.2-0.6 21-1.7 15.2 24.2 41.2 41.1 71.6 41.1 44.7 0 80.9-36.2 80.9-80.9 0-25.2-11.5-47.7-29.6-62.6 11.6-16.1 18.4-35.6 18.4-56.5C443.1 177.9 393.7 128.5 332.6 128.5zM180.1 85.8c-52.1 0-94.4 42.3-94.4 94.4s42.3 94.4 94.4 94.4 94.4-42.3 94.4-94.4S232.2 85.8 180.1 85.8zM332.6 170.9c-37.8 0-68.4 30.6-68.4 68.4s30.6 68.4 68.4 68.4 68.4-30.6 68.4-68.4S370.4 170.9 332.6 170.9z">
              </path>
            </svg></button><button id="read-together-btn" class="chat-action-icon-btn action-button" title="‰∏ÄËµ∑ËØª‰π¶"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg></button> <button id="open-nai-gallery-btn" class="chat-action-icon-btn action-button" title="NAIÁîªÂªä">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3l1.91 5.86L20 10.9l-5.86 1.91L12 18.6l-1.91-5.86L4 10.9l5.86-1.91L12 3z"/>
        <path d="M5 3l1.5 4.5L11 9l-4.5 1.5L5 12l-1.5-4.5L-1 6l4.5-1.5L5 3z"/>
        <path d="M19 15l-1.5 4.5L13 21l4.5-1.5L19 18l1.5 4.5L25 21l-4.5-1.5L19 15z"/>
    </svg>
</button>
<button id="open-quick-reply-btn" class="chat-action-icon-btn action-button" title="Âø´Êç∑ÂõûÂ§ç">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
              </svg>
            </button>
<button id="open-todo-list-btn" class="chat-action-icon-btn action-button" title="ÂæÖÂäû‰∫ãÈ°π">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
    </svg>
</button>
</div>
        <div id="chat-input-main-row"> <button id="chat-expand-btn" class="chat-action-icon-btn action-button" title="Â±ïÂºÄÂäüËÉΩ">+</button><textarea id="chat-input" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
          <div id="input-actions-wrapper"> <button id="wait-reply-btn" title="Á≠âÂæÖÂõûÂ§ç"><img src="https://i.postimg.cc/q72zq80N/ECE92-BBC-BE57-48-E9-BB2-C-345-B6019-C4-B2.png" alt="Á≠âÂæÖÂõûÂ§ç"></button> <button id="send-btn" class="action-button">ÂèëÈÄÅ</button> </div>
        </div>
      </div>
      <div id="chat-lock-overlay">
        <div id="chat-lock-content"></div>
      </div>
<div id="nai-gallery-panel">
    <div id="nai-gallery-panel-header">
        <span class="panel-btn" id="close-nai-gallery-btn" data-lang-key="cancel">ÂèñÊ∂à</span>
        
        <div id="nai-gallery-tabs">
            <div class="nai-gallery-tab active" data-tab-id="local">Êú¨Âú∞</div>
            <div class="nai-gallery-tab" data-tab-id="cloud">ÂõæÂ∫ä</div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <span class="panel-btn" id="manage-nai-gallery-btn">ÁÆ°ÁêÜ</span>
        </div>
    </div>
    
    <div id="nai-gallery-grid-container">
        <div id="nai-gallery-grid-local" class="nai-gallery-page active">
            </div>
        
        <div id="nai-gallery-grid-cloud" class="nai-gallery-page">
            </div>
    </div>
    
  
    
<div id="nai-gallery-action-bar">
    <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;">
        <input type="checkbox" id="select-all-nai-gallery-checkbox"> ÂÖ®ÈÄâ
    </label>
    <button id="export-selected-nai-gallery-btn" class="action-bar-btn" style="background-color: #17a2b8; display: none; font-size: 14px; padding: 10px 15px;">ÂØºÂá∫ (0)</button>
    <button id="download-selected-nai-gallery-btn" class="action-bar-btn" style="background-color: #007bff; font-size: 14px; padding: 10px 15px;">‰∏ãËΩΩ (0)</button>
   <button id="upload-selected-nai-gallery-btn" class="action-bar-btn" style="background-color: #4cd964; display: none; font-size: 14px; padding: 10px 15px;">‰∏ä‰º† (0)</button>
    <button id="delete-selected-nai-gallery-btn" class="action-bar-btn" style="font-size: 14px; padding: 10px 15px;">Âà†Èô§ (0)</button>
</div>
</div>
      <div id="sticker-panel">
        <div id="sticker-panel-header"> <span class="panel-btn" id="close-sticker-panel-btn"data-lang-key="cancel">ÂèñÊ∂à</span> <span class="title">ÊàëÁöÑË°®ÊÉÖ</span>
          <div style="display: flex; gap: 10px;"> <span class="panel-btn" id="manage-sticker-categories-btn">ÂàÜÁ±ª</span> <span class="panel-btn" id="manage-stickers-btn">ÁÆ°ÁêÜ</span> <span class="panel-btn" id="add-sticker-batch-btn">ÊâπÈáè</span> <span class="panel-btn" id="upload-sticker-btn">‰∏ä‰º†</span> </div>
        </div>
        <div id="sticker-category-tabs"></div>
        <div id="sticker-search-container"> <input type="search" id="sticker-search-input" placeholder="ÊêúÁ¥¢Ë°®ÊÉÖÂêçÁß∞..."></div>
        <div id="sticker-grid"></div>
        <div id="sticker-action-bar"> <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-stickers-checkbox"> ÂÖ®ÈÄâ </label><button id="move-selected-stickers-btn" style="background-color: #ff9800; margin-left: 5px;">ÁßªÂä® (0)</button> <button id="export-selected-stickers-btn" style="background-color: #007bff;">ÂØºÂá∫ (0)</button><button id="delete-selected-stickers-btn">Âà†Èô§ (0)</button> </div>
      </div> <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;"> <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
      <div id="music-player-overlay">
        <div class="music-player-window">
          <div class="music-player-top-actions">
            <div class="top-left-cluster"> <button id="music-return-btn">‚Äπ</button> <button id="music-exit-btn">√ó</button> </div>
            <div style="display: flex; align-items: center; gap: 15px;"> <button id="toggle-fullscreen-btn" title="ÂàáÊç¢ÂÖ®Â±è"> <svg class="icon-maximize" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                </svg> <svg class="icon-minimize" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3" />
                </svg> </button> <span id="music-playlist-btn">‚ò∞</span> </div>
          </div>
          <div id="music-player-avatar-display"> </div>
          <div id="music-info-top">
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
              <div id="music-time-counter">Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü0.0Â∞èÊó∂</div> <button id="show-avatars-btn" title="ÊòæÁ§∫/ÈöêËóèÂ§¥ÂÉè"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg> </button>
            </div>
            <div id="music-player-song-title">ËØ∑Ê∑ªÂä†Ê≠åÊõ≤</div>
            <div id="music-player-artist">...</div>
          </div>
          <div id="music-visual-container">
            <div id="vinyl-view"> <img id="music-player-cover" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg" alt="Album Art"> </div>
            <div id="inline-lyrics-view">
              <div id="music-lyrics-container">
                <div id="music-lyrics-list"> </div>
              </div>
            </div>
          </div>
          <div id="single-lyric-display">‚ô™ ‚ô™ ‚ô™</div>
          <div class="music-player-controls-wrapper">
            <div class="music-progress-bar-container">
              <div id="music-current-time" class="time-display">0:00</div>
              <div class="progress-bar">
                <div id="music-progress-fill" class="progress-bar-fill"></div>
              </div>
              <div id="music-total-time" class="time-display">0:00</div>
            </div>
            <div class="music-controls"> <button id="music-prev-btn">‚óÄ</button> <button id="music-play-pause-btn" class="play-pause-btn">‚ñ∂</button> <button id="music-next-btn">‚ñ∂</button> <button id="music-mode-btn">È°∫Â∫è</button> <button id="toggle-blur-btn" title="ÂàáÊç¢ËÉåÊôØÊ∏ÖÊô∞Â∫¶">Ê∏Ö</button>
            </div>
          </div>
        </div>
      </div>
      <div id="music-playlist-panel">
        <div class="playlist-header">
          <div class="header-left-actions" style="display: flex; align-items: center; gap: 10px;">
            <span class="panel-btn" id="close-playlist-btn" data-lang-key="back">ËøîÂõû</span>
            <span class="panel-btn" id="manage-playlist-btn" data-lang-key="manage">ÁÆ°ÁêÜ</span>
          </div>
          
          <span data-lang-key="playlistTitle">Êí≠ÊîæÂàóË°®</span>
          
          <div>
            <span class="panel-btn" id="cleanup-songs-btn">Ê∏ÖÁêÜ</span> 
            <span class="panel-btn" id="add-song-local-btn">Êú¨Âú∞</span> 
            <span class="panel-btn" id="add-song-url-btn">URL</span> 
            <span class="panel-btn" id="add-song-search-btn" data-lang-key="search">ÊêúÁ¥¢</span>
          </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
       <div id="playlist-action-bar">
        <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="select-all-playlist-checkbox"> ÂÖ®ÈÄâ
        </label>
        <button id="upload-selected-to-catbox-btn" class="action-bar-btn" style="background-color: #007bff;">‰∏ä‰º†Catbox (0)</button>
      </div>
      </div> <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;"> <input type="file" id="lrc-upload-input" accept=".lrc" style="display: none;">
    </div>
    <div id="wallpaper-screen" class="screen ios-settings-screen">
      <div class="header"> 
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> 
        <span data-lang-key="appearanceTitle">Â§ñËßÇËÆæÁΩÆ</span> 
        <!-- ‰øùÁïôÂéüÊúâ‰øùÂ≠òÊåâÈíÆÈÄªËæë -->
        <span class="save-btn" id="save-wallpaper-btn" data-lang-key="save">ÂÆåÊàê</span> 
      </div>

      <div class="settings-container ios-scroll-container">

        <!-- 1. Â£ÅÁ∫∏‰∏éËÉåÊôØ -->
        <div class="settings-header">Â£ÅÁ∫∏‰∏éËÉåÊôØ</div>
        <div class="settings-section">
            <!-- EPhone ‰∏ªÂ±èÂπï -->
            <div class="settings-item">
                <label>‰∏ªÂ±èÂπïÂ£ÅÁ∫∏</label>
                <div class="settings-right">
                    <!-- È¢ÑËßàÂõæ -->
                    <div id="wallpaper-preview" class="wallpaper-thumbnail">È¢ÑËßà</div>
                    <!-- ÊåâÈíÆÁªÑ -->
                    <div class="action-btn-group">
                        <button class="settings-mini-btn" onclick="document.getElementById('wallpaper-upload-input').click()">Êú¨Âú∞</button>
                        <button id="upload-ephone-bg-url-btn" class="settings-mini-btn">URL</button>
                        <button id="remove-ephone-bg-btn" class="settings-mini-btn" style="display:none; color:#ff3b30;">√ó</button>
                    </div>
                    <!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ• -->
                    <input type="file" id="wallpaper-upload-input" accept="image/*" class="hidden-input">
                </div>
            </div>

            <!-- CPhone ÊâãÊú∫ -->
            <div class="settings-item">
                <label>CPhone Â£ÅÁ∫∏</label>
                <div class="settings-right">
                    <div id="cphone-wallpaper-preview" class="wallpaper-thumbnail">È¢ÑËßà</div>
                    <div class="action-btn-group">
                        <button class="settings-mini-btn" onclick="document.getElementById('cphone-wallpaper-upload-input').click()">Êú¨Âú∞</button>
                        <button id="upload-cphone-bg-url-btn" class="settings-mini-btn">URL</button>
                        <button id="remove-cphone-bg-btn" class="settings-mini-btn" style="display:none; color:#ff3b30;">√ó</button>
                    </div>
                    <input type="file" id="cphone-wallpaper-upload-input" accept="image/*" class="hidden-input">
                </div>
            </div>

            <!-- ÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØ -->
            <div class="settings-item">
                <label>ËÅäÂ§©ËÉåÊôØ (ÂÖ®Â±Ä)</label>
                <div class="settings-right">
                    <div id="global-bg-preview" class="wallpaper-thumbnail">È¢ÑËßà</div>
                    <div class="action-btn-group">
                        <button class="settings-mini-btn" onclick="document.getElementById('global-bg-input').click()">Êú¨Âú∞</button>
                        <button id="upload-global-bg-url-btn" class="settings-mini-btn">URL</button>
                        <button id="remove-global-bg-btn" class="settings-mini-btn" style="display:none; color:#ff3b30;">√ó</button>
                    </div>
                    <input type="file" id="global-bg-input" accept="image/*" class="hidden-input">
                </div>
            </div>
        </div>

        <!-- 2. ÊòæÁ§∫‰∏é‰∫§‰∫í -->
        <div class="settings-header">ÊòæÁ§∫‰∏é‰∫§‰∫í</div>
        <div class="settings-section">
            <div class="settings-item">
                <label>Â§úÈó¥Ê®°Âºè</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-toggle-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <label>È°∂ÈÉ®Áä∂ÊÄÅÊ†è</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="status-bar-toggle-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div>
                    <label>ÊâãÊú∫Â§ñÊ°Ü</label>
                    <div class="settings-desc">Ê≤âÊµ∏Âºè‰ªøÁúüËæπÊ°Ü</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="phone-frame-toggle-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div>
                    <label>ÂàÜÁ¶ªÁä∂ÊÄÅÊ†è</label>
                    <div class="settings-desc">‰∏çË¶ÜÁõñÈ°∂ÈÉ®Âå∫Âüü (ÂàòÊµ∑Â±èÈÄÇÈÖç)</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="detach-status-bar-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div>
                    <label>Èü≥‰πêÁÅµÂä®Â≤õ</label>
                    <div class="settings-desc">Âê¨Ê≠åÊó∂ÂßãÁªàÊòæÁ§∫ÁÅµÂä®Â≤õUI</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="dynamic-island-music-toggle-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div>
                    <label>ÁÆÄÊ¥ÅËÅäÂ§©ÁïåÈù¢</label>
                    <div class="settings-desc">ÈªòËÆ§ÊäòÂè†ËÅäÂ§©Â∑•ÂÖ∑Ê†è</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="minimal-chat-ui-switch">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- 3. ÈîÅÂ±èËÆæÁΩÆ -->
        <div class="settings-header">ÈîÅÂ±èÂÆâÂÖ®</div>
        <div class="settings-section">
            <div class="settings-item">
                <label>ÂêØÁî®ÈîÅÂ±èÂØÜÁ†Å</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="lock-screen-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <!-- ÈîÅÂ±èËØ¶ÊÉÖ (JSÊéßÂà∂ÊòæÁ§∫ÈöêËóè) -->
            <div id="lock-screen-settings-detail" style="display: none; background-color: #f9f9f9; border-top: 0.5px solid #ebedf0;">
                <div class="settings-item">
                    <label>4‰ΩçÊï∞Â≠óÂØÜÁ†Å</label>
                    <div class="settings-right">
                        <input type="tel" id="lock-screen-password-input" maxlength="4" placeholder="1234" class="settings-num-input" style="width: 80px !important; letter-spacing: 2px;">
                    </div>
                </div>
                <div class="settings-item">
                    <label>ÈîÅÂ±èÂ£ÅÁ∫∏</label>
                    <div class="settings-right">
                         <div id="lock-wallpaper-preview" class="wallpaper-thumbnail" style="margin-right: 10px;">Êó†</div>
                         <div class="action-btn-group">
                             <button class="settings-mini-btn" onclick="document.getElementById('lock-wallpaper-input').click()">Êú¨Âú∞</button>
                             <button id="upload-lock-wallpaper-url-btn" class="settings-mini-btn">URL</button>
                         </div>
                         <input type="file" id="lock-wallpaper-input" accept="image/*" class="hidden-input">
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. ÊèêÁ§∫Èü≥ -->
        <div class="settings-header">Â£∞Èü≥</div>
        <div class="settings-section">
            <div class="settings-item-block">
                <label style="display:block; margin-bottom:8px;">Ê∂àÊÅØÊèêÁ§∫Èü≥ URL</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="notification-sound-url-input" placeholder="ÁïôÁ©∫‰ΩøÁî®ÈªòËÆ§" class="settings-textarea" style="flex-grow:1; min-height:36px; padding:8px;">
                    <button id="test-sound-btn" class="settings-mini-btn" style="width:auto;">‚ñ∂</button>
                    <button id="reset-sound-btn" class="settings-mini-btn" style="width:auto;">ÈáçÁΩÆ</button>
                </div>
            </div>
        </div>

        <!-- 5. ÂõæÊ†áÂÆöÂà∂ -->
        <div class="settings-header">ÂõæÊ†áÂÆöÂà∂</div>
        <div class="settings-section">
            <div class="settings-item-block">
                <label style="margin-bottom: 10px; display:block; font-weight:600;">EPhone ‰∏ªÂ±èÂπïÂõæÊ†á</label>
                <div id="icon-settings-grid" class="settings-icon-grid">
                    <!-- JS Â°´ÂÖÖ -->
                </div>
            </div>
            <div class="settings-item-block" style="border-top: 0.5px solid #c6c6c8;">
                <label style="margin-bottom: 10px; display:block; font-weight:600;">CPhone Â∫îÁî®ÂõæÊ†á</label>
                <div id="cphone-icon-settings-grid" class="settings-icon-grid">
                    <!-- JS Â°´ÂÖÖ -->
                </div>
            </div>
        </div>

        <!-- 6. Â∑•ÂÖ∑Ê†èÊéíÂ∫è -->
        <div class="settings-header">ËÅäÂ§©Â∑•ÂÖ∑Ê†è</div>
        <div class="settings-section">
            <div class="settings-item-block">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label>ÊåâÈíÆÊéíÂ∫è</label>
                    <button id="reset-button-order-btn" class="settings-mini-btn">ÊÅ¢Â§çÈªòËÆ§</button>
                </div>
                <div class="settings-desc" style="margin: 0 0 10px 0;">ÊãñÂä®‰∏ãÊñπÊåâÈíÆË∞ÉÊï¥È°∫Â∫èÔºö</div>
                <div id="button-order-editor">
                    <!-- JS Â°´ÂÖÖ -->
                </div>
            </div>
        </div>

        <!-- 7. È¢ÑËÆæÁÆ°ÁêÜ (È´òÁ∫ß) -->
        <div class="settings-header">È¢ÑËÆæ‰∏éÈ´òÁ∫ß</div>
        <div class="settings-section">
            <!-- Â§ñËßÇÈ¢ÑËÆæ -->
            <div class="settings-item">
                 <label>Â§ñËßÇÈ¢ÑËÆæ</label>
                 <div class="settings-right">
                     <select id="appearance-preset-select" class="settings-select" style="width:auto; flex-grow:1; margin-right:5px;"></select>
                     <!-- ‰øÆÊîπÁÇπÔºöÊîπ‰∏∫ settings-mini-btn -->
                     <button id="save-appearance-preset-btn" class="settings-mini-btn">‰øùÂ≠ò</button>
                     <button id="delete-appearance-preset-btn" class="settings-mini-btn" style="color: #ff3b30;">Âà†Èô§</button>
                 </div>
            </div>
            <!-- CSS È¢ÑËÆæ -->
            <div class="settings-item">
                 <label>CSS È¢ÑËÆæ</label>
                 <div class="settings-right">
                     <select id="css-preset-select" class="settings-select" style="width:auto; flex-grow:1; margin-right:5px;"></select>
                     <!-- ‰øÆÊîπÁÇπÔºöÊîπ‰∏∫ settings-mini-btn -->
                     <button id="save-css-preset-btn" class="settings-mini-btn">‰øùÂ≠ò</button>
                     <button id="delete-css-preset-btn" class="settings-mini-btn" style="color: #ff3b30;">Âà†Èô§</button>
                 </div>
            </div>
            
            <!-- Ëá™ÂÆö‰πâ CSS -->
            <div class="settings-item-block">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <label>ÂÖ®Â±ÄËá™ÂÆö‰πâ CSS</label>
                    <!-- ‰øÆÊîπÁÇπÔºöÊîπ‰∏∫ settings-mini-btn -->
                    <button id="reset-global-css-btn" class="settings-mini-btn">ÈáçÁΩÆ</button>
                </div>
                <textarea id="global-css-input" class="settings-textarea" placeholder="/*Âú®Ê≠§ËæìÂÖ•CSS*/"></textarea>
            </div>
            
            <!-- ÂØºÂÖ• -->
            <button class="settings-full-btn" id="export-appearance-btn">ÂØºÂá∫Â§ñËßÇÈÖçÁΩÆ (JSON)</button>

            <button class="settings-full-btn" id="import-appearance-btn">ÂØºÂÖ•Â§ñËßÇÈÖçÁΩÆ (JSON/Word/Txt)</button>
            <input type="file" id="import-appearance-input" accept=".json,.txt,.docx" class="hidden-input">
        </div>

        <div style="height: 40px;"></div>
      </div>
    </div>
    <div id="browser-screen" class="screen">
      <div class="header"> <span class="back-btn" id="browser-back-btn">‚Äπ</span> <span id="browser-title"></span> <span style="width: 30px;"></span> </div>
      <div id="browser-content" class="list-container"> </div>
    </div>
    <div id="font-settings-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span data-lang-key="fontSettingsTitle">Â≠ó‰ΩìËÆæÁΩÆ</span> <span style="width: 30px;"></span> </div>
      <div class="form-container">
        <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;"data-lang-key="fontPresetManagement">Â≠ó‰ΩìÈ¢ÑËÆæÁÆ°ÁêÜ</h3>
        <div class="form-group"> <label for="font-preset-select"data-lang-key="apiPresetSelectLabel">ÈÄâÊã©ÊàñÂàáÊç¢È¢ÑËÆæ</label>
          <div style="display: flex; gap: 10px; align-items: center;"> <select id="font-preset-select" style="flex-grow: 1;"></select> <button id="save-font-preset-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;"data-lang-key="save">‰øùÂ≠ò</button> <button id="delete-font-preset-btn"
              class="form-button-secondary" style="margin-top: 0; padding: 12px; background-color: #ffebee; color: #d32f2f; border-color: #ffcdd2;"data-lang-key="delete">Âà†Èô§</button> </div>
        </div>
        <hr style="margin: 30px 0; opacity: 0.3;">
        <div class="form-group"> <label for="font-url-input"data-lang-key="fontFileUrlLabel">Â≠ó‰ΩìÊñá‰ª∂URL (.ttf, .otf, .woffÁ≠â)</label> <input type="text" id="font-url-input" placeholder="https://..../font.ttf"> </div>
        <div class="form-group"> <label data-lang-key="fontPreviewLabel">ÂÆûÊó∂È¢ÑËßà</label>
          <div id="font-preview">
            <p style="font-size: 20px; margin: 0 0 10px 0;">‰Ω†Â•Ω‰∏ñÁïå Hello World</p>
            <p style="margin: 0;">ËøôÊòØÂ≠ó‰ΩìÈ¢ÑËßàÊïàÊûúÔºå12345„ÄÇ</p>
          </div>
        </div> <button class="form-button" id="save-font-btn"data-lang-key="fontSaveAndApply">‰øùÂ≠òÂπ∂Â∫îÁî®</button> <button class="form-button form-button-secondary" id="reset-font-btn"data-lang-key="fontResetDefault">ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì</button>
      </div>
    </div>
    <div id="contact-picker-screen" class="screen">
      <div class="header"> <span class="back-btn" id="cancel-contact-picker-btn"data-lang-key="cancel">ÂèñÊ∂à</span> <span>ÈÄâÊã©ËÅîÁ≥ª‰∫∫</span> <span class="save-btn" id="confirm-contact-picker-btn"data-lang-key="done">ÂÆåÊàê(0)</span> </div>
      <div class="list-container" id="contact-picker-list"> </div>
    </div>
    <div id="member-management-screen" class="screen">
      <div class="header"> <span class="back-btn" id="back-from-member-management">‚Äπ</span> <span>Áæ§ÊàêÂëòÁÆ°ÁêÜ</span> <span style="width: 30px;"></span> </div>
      <div class="list-container" id="member-management-list"> </div>
      <div id="member-management-actions"> <button id="add-existing-contact-btn">‰ªéÂ•ΩÂèãÂàóË°®Ê∑ªÂä†</button> <button id="create-new-member-btn">ÂàõÂª∫Áæ§ÂÜÖÊñ∞ÊàêÂëò</button> </div>
    </div>
    <div id="sticker-category-manager-modal" class="modal">
      <div class="modal-content" style="height: 60%;">
        <div class="modal-header"> <span>ÁÆ°ÁêÜË°®ÊÉÖÂàÜÁ±ª</span> </div>
        <div class="modal-body">
          <div class="form-group"> <label>Êñ∞Âª∫ÂàÜÁ±ª</label>
            <div style="display: flex; gap: 10px;"> <input type="text" id="new-sticker-category-name-input" placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêç..." style="flex-grow: 1;"> <button id="add-new-sticker-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;"data-lang-key="add">Ê∑ªÂä†</button> </div>
          </div>
          <hr style="opacity: 0.2;">
          <div id="existing-sticker-categories-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
        </div>
        <div class="modal-footer"> <button class="save" id="close-sticker-category-manager-btn" style="width: 100%;"data-lang-key="done">ÂÆåÊàê</button> </div>
      </div>
    </div>
    <div id="incoming-call-modal" class="modal">
      <div class="incoming-call-content"> <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù</div>
        <div class="incoming-call-actions">
          <div class="action-button-wrapper"> <button id="decline-call-btn" class="call-action-btn decline"></button> <span>ÊãíÁªù</span> </div>
          <div class="action-button-wrapper"> <button id="accept-call-btn" class="call-action-btn accept"></button> <span>Êé•Âê¨</span> </div>
        </div>
      </div>
    </div>
    <div id="video-call-screen" class="screen">
     
<div class="video-call-top-bar">
    <button id="minimize-call-btn" title="ÊúÄÂ∞èÂåñ">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
    <span id="call-timer">00:00</span> 
</div>
      <div class="video-call-avatar-area">
        <div id="participant-avatars-grid"> </div>
      </div>
      <div id="video-call-main" class="video-call-main"> </div>
      <div class="video-call-controls"> <button id="user-speak-btn" class="control-btn speak-btn"></button> <button id="hang-up-btn" class="control-btn hangup-btn"></button> <button id="regenerate-call-btn" class="control-btn regenerate-btn"></button> <button id="join-call-btn"
          class="control-btn join-btn" style="display: none;"></button> </div>
      
      <!-- ÂæÆ‰ø°È£éÊ†ºËßÜÈ¢ëÈÄöËØùÁïåÈù¢ -->
      <div class="wechat-video-call-container">
        <!-- È°∂ÈÉ®‰ø°ÊÅØ -->
        <div class="wechat-call-header">
          <div class="wechat-call-name" id="wechat-call-name">{{char}}</div>
          <div class="wechat-call-status" id="wechat-call-status">ËßÜÈ¢ëÈÄöËØù‰∏≠ <span id="wechat-call-timer">0:04</span></div>
        </div>
        
        <!-- Â§ßÁîªÈù¢ÔºàÂØπÊñπÔºâ -->
        <div class="wechat-main-video" id="wechat-main-video">
          <img id="wechat-ai-video-image" src="" alt="ÂØπÊñπËßÜÈ¢ëÁîªÈù¢">
        </div>
        
        <!-- Â∞èÁîªÈù¢ÔºàËá™Â∑±Ôºâ -->
        <div class="wechat-small-video" id="wechat-small-video">
          <img id="wechat-my-video-image" src="" alt="ÊàëÁöÑËßÜÈ¢ëÁîªÈù¢">
        </div>
        
        <!-- Ê∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
        <div class="wechat-call-messages" id="wechat-call-messages"></div>
        
        <!-- Â∫ïÈÉ®ÊéßÂà∂Ê†è -->
        <div class="wechat-call-controls">
          <button class="wechat-control-btn wechat-camera-btn" id="wechat-camera-btn">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
          </button>
          <button class="wechat-control-btn wechat-speak-btn" id="wechat-speak-btn">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" y1="19" x2="12" y2="23"/>
              <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
          </button>
          <button class="wechat-control-btn wechat-hangup-btn" id="wechat-hang-up-btn">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
              <path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91z"/>
            </svg>
          </button>
          <button class="wechat-control-btn wechat-regenerate-btn" id="wechat-regenerate-btn">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/>
            </svg>
          </button>
        </div>
        
        <!-- ÈöêËóèÁöÑvideoÂíåcanvasÁî®‰∫éÊëÑÂÉèÂ§¥ -->
        <video id="wechat-camera-video" style="display: none;" autoplay playsinline></video>
        <canvas id="wechat-camera-canvas" style="display: none;"></canvas>
      </div>
    </div>
    <div id="outgoing-call-screen" class="screen">
      <div class="outgoing-call-content"> <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">Ê≠£Âú®ÂëºÂè´...</div>
        <div class="outgoing-call-actions"> <button id="cancel-call-btn" class="call-action-btn decline"></button> <span data-lang-key="cancel">ÂèñÊ∂à</span> </div>
      </div>
    </div>
    <div id="call-history-screen" class="screen">
      <div class="header"> <span class="back-btn" id="call-history-back-btn">‚Äπ</span> <span id="call-history-title">ÈÄöËØùËÆ∞ÂΩï</span> <span style="width: 30px;"></span> </div>
      <div id="call-history-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
    </div>
    <div id="douban-screen" class="screen">
      <div class="header"> <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> <span>Ë±ÜÁì£Â∞èÁªÑ</span>
        <div class="header-actions"> <span class="action-btn" id="douban-settings-btn" title="Ë±ÜÁì£ËÆæÁΩÆ"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path
                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.12,4.84c-0.59,0.24-1.12,0.56-1.62,0.94L5.11,4.82c-0.22-0.08-0.47,0-0.59,0.22l-1.92,3.32 c-0.12,0.22-0.07,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.82,11.68,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.03 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.03c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z">
              </path>
            </svg> </span> <span class="action-btn" id="douban-cast-select-btn" title="ÈÄâÊã©ÂèÇ‰∏éËßíËâ≤"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg> </span> <span class="action-btn" id="regenerate-douban-btn" title="ÈáçÊñ∞ÁîüÊàêÂÜÖÂÆπ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> </span> </div>
      </div>
      <div id="douban-posts-list" class="list-container"> </div>
    </div>
    <div id="douban-post-detail-screen" class="screen">
      <div class="header"> <span class="back-btn" id="douban-detail-back-btn">‚Äπ</span> <span id="douban-post-detail-title">Â∏ñÂ≠êËØ¶ÊÉÖ</span> <span style="width: 30px;"></span> </div>
      <div id="douban-detail-content-wrapper" class="list-container">
        <div id="douban-post-detail-body">
          <div class="douban-post-header"> <img id="douban-detail-avatar" class="douban-post-avatar">
            <div class="douban-author-info">
              <div id="douban-detail-author" class="douban-author-name"></div>
              <div id="douban-detail-group" class="douban-group-name"></div>
            </div>
          </div>
          <h2 id="douban-detail-post-title" class="douban-post-title"></h2>
          <div id="douban-detail-content" class="douban-detail-content"></div>
        </div>
        <div class="douban-comments-section">
          <h4>ÂõûÂ∫î</h4>
          <div id="douban-detail-comments-list"></div>
        </div>
      </div>
      <div id="douban-comment-footer" class="post-footer">
        <div class="comment-section"> <img id="douban-my-comment-avatar" src="" class="comment-avatar"> <input type="text" id="douban-comment-input" class="comment-input" placeholder="ÂÜôÂõûÂ∫î..."> </div> <button id="douban-wait-reply-btn" class="douban-feather-btn" title="ËÆ©AIÁªßÁª≠ËÆ®ËÆ∫"> <svg
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
            <line x1="16" y1="8" x2="2" y2="22"></line>
            <line x1="17.5" y1="15" x2="9" y2="15"></line>
          </svg> </button> <button id="douban-send-comment-btn" class="comment-send-btn">ÂèëÈÄÅ</button>
      </div>
    </div>
    <div id="werewolf-game-screen" class="screen">
      <div class="header"> <span id="werewolf-game-title">Áãº‰∫∫ÊùÄ</span>
        <div class="header-actions"><span class="action-btn" id="werewolf-retry-btn" title="ÈáçËØï‰∏ä‰∏ÄÊ≠•AIÊìç‰Ωú" style="display: none;"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg></span> <span class="action-btn" id="exit-werewolf-game-btn">ÈÄÄÂá∫</span> </div>
      </div>
      <div id="werewolf-player-grid"></div>
      <div id="werewolf-log" class="list-container"></div>
      <div id="werewolf-action-bar">
        <div id="chat-input-main-row" style="width: 100%;"> <textarea id="werewolf-user-input" rows="1" placeholder="ËΩÆÂà∞‰Ω†ÂèëË®Ä‰∫Ü..."></textarea>
          <div id="input-actions-wrapper" style="gap: 5px;"> <button id="werewolf-wait-reply-btn" class="action-button" style="display: none; background-color: #007bff; height: 40px; padding: 0 10px; font-size: 13px;">Á≠âÂæÖÂõûÂ∫î</button> <button id="werewolf-finish-speech-btn" class="action-button"
              style="display: none; background-color: var(--accent-color); height: 40px; padding: 0 10px; font-size: 13px;">ÁªìÊùüÂèëË®Ä</button> <button id="werewolf-next-step-btn" class="form-button" style="margin-top:0; display: none;">‰∏ã‰∏ÄÊ≠•</button> </div>
        </div>
      </div>
    </div>
    <div id="long-term-memory-screen" class="screen">
      <div class="header"> <span class="back-btn" id="memory-screen-back-btn">‚Äπ</span> <span data-lang-key="chatHeaderLongTermMemory">ÈïøÊúüËÆ∞ÂøÜ</span>
        <div class="header-actions"> 
            <!-- Á≤æÁÇºÊåâÈíÆ (ÊõøÊç¢‰∏∫ ÊºèÊñó/ËøáÊª§ ÂõæÊ†á) -->
            <span class="action-btn" id="refine-memory-btn-header" title="Á≤æÁÇº (Êï¥ÂêàÊóßËÆ∞ÂøÜ)"> 
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
            </span> 
            
            <!-- ÊÄªÁªìÊåâÈíÆ (ÊõøÊç¢‰∏∫ ÊñáÊ°£/ÂàóË°® ÂõæÊ†á) -->
            <span class="action-btn" id="summarize-recent-btn-header" title="ÊÄªÁªì (ÊúÄËøëÂØπËØù)"> 
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </span> 
            
            <!-- Ê∑ªÂä†ÊåâÈíÆ (Áªü‰∏ÄÊõøÊç¢‰∏∫ SVG Âä†Âè∑) -->
            <span class="action-btn" id="add-manual-memory-btn-header" title="ÊâãÂä®Ê∑ªÂä†">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </span> 
        </div>
      </div>
      <div class="list-container" id="memory-list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px; background-color: #f0f2f5;"> </div>
    </div>
    <div id="chat-settings-screen" class="screen">
      <div class="header"> 
          <span class="back-btn" onclick="showScreen('chat-interface-screen')">‚Äπ</span> 
          <span>ËÅäÂ§©ËØ¶ÊÉÖ</span> 
          <span class="save-btn" id="save-chat-settings-btn" data-lang-key="save">ÂÆåÊàê</span> 
      </div>
      
      <div class="settings-container">
        
        <!-- Á¨¨‰∏ÄÁªÑÔºöÂü∫Á°Ä‰ø°ÊÅØ -->
        <div class="settings-section">
            <div class="settings-item" id="chat-name-group">
                <label>Â§áÊ≥®Âêç / Áæ§Âêç</label>
                <div class="settings-right">
                    <input type="text" id="chat-name-input" placeholder="Êú™ËÆæÁΩÆ">
                </div>
            </div>
            
            <div class="settings-item" id="ai-original-name-group">
                <label>ÂØπÊñπÊú¨Âêç (AIËØÜÂà´Áî®)</label>
                <div class="settings-right">
                    <input type="text" id="ai-original-name-input" placeholder="ÂøÖÂ°´">
                </div>
            </div>

            <div class="settings-item" id="my-nickname-group">
                <label>ÊàëÁöÑÊòµÁß∞</label>
                <div class="settings-right">
                    <input type="text" id="my-nickname-input" placeholder="Êàë">
                </div>
            </div>

            <div class="settings-item" id="my-group-nickname-group">
                <label>ÊàëÁöÑÁæ§ÊòµÁß∞</label>
                <div class="settings-right">
                    <input type="text" id="my-group-nickname-input">
                </div>
            </div>
            
            <!-- Â§¥ÂÉèÁõ∏ÂÖ≥ -->
            <div class="settings-item" id="ai-avatar-group">
                 <label>ÂØπÊñπÂ§¥ÂÉè</label>
                 <div class="settings-right full-width">
                    <div class="avatar-action-wrapper">
                         <!-- Â§¥ÂÉèÂú®Â∑¶ -->
                         <img id="ai-avatar-preview" class="settings-avatar">
                         <!-- ÊåâÈíÆÁªÑÂú®Âè≥ -->
                         <div class="avatar-btn-group">
                             <button class="settings-mini-btn" onclick="document.getElementById('ai-avatar-input').click()">Êõ¥Êç¢</button>
                             <button class="settings-mini-btn" id="manage-ai-avatar-library-btn">ÂõæÂ∫ì</button>
                             <button class="settings-mini-btn change-frame-btn" data-type="ai">ÊåÇ‰ª∂</button>
                             <input type="file" id="ai-avatar-input" accept="image/*" hidden>
                         </div>
                    </div>
                 </div>
            </div>

            <div class="settings-item" id="group-avatar-group">
                 <label>Áæ§Â§¥ÂÉè</label>
                 <div class="settings-right full-width">
                    <div class="avatar-action-wrapper">
                         <img id="group-avatar-preview" class="settings-avatar">
                         <div class="avatar-btn-group">
                             <button class="settings-mini-btn" onclick="document.getElementById('group-avatar-input').click()">Êõ¥Êç¢</button>
                             <button class="settings-mini-btn" id="manage-group-avatar-library-btn">ÂõæÂ∫ì</button>
                             <input type="file" id="group-avatar-input" accept="image/*" hidden>
                         </div>
                    </div>
                 </div>
            </div>

            <div class="settings-item" id="my-avatar-group">
                 <label>ÊàëÁöÑÂ§¥ÂÉè</label>
                 <div class="settings-right full-width">
                    <div class="avatar-action-wrapper">
                         <img id="my-avatar-preview" class="settings-avatar">
                         <div class="avatar-btn-group">
                             <button class="settings-mini-btn" onclick="document.getElementById('my-avatar-input').click()">Êõ¥Êç¢</button>
                             <button class="settings-mini-btn" id="manage-my-avatar-library-btn">ÂõæÂ∫ì</button>
                             <button class="settings-mini-btn change-frame-btn" data-type="my">ÊåÇ‰ª∂</button>
                             <button class="settings-mini-btn" id="open-persona-library-btn">È¢ÑËÆæ</button>
                             <input type="file" id="my-avatar-input" accept="image/*" hidden>
                         </div>
                    </div>
                 </div>
            </div>
            
            <div class="settings-item" id="assign-group-section" style="display: none;"> 
                <label>Â•ΩÂèãÂàÜÁªÑ</label>
                <div class="settings-right"> 
                    <select id="assign-group-select" class="settings-select"></select> 
                    <button id="manage-groups-btn" class="settings-icon-btn">‚öôÔ∏è</button> 
                </div>
            </div>

            <!-- ËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°ËÆæÁΩÆ -->
            <div class="settings-item" id="video-call-avatar-switch-item" style="display: flex !important; justify-content: space-between !important; align-items: center !important; flex-direction: row !important;">
                <div style="flex: 1; padding-right: 10px; display: flex; flex-direction: column; align-items: flex-start;">
                    <label style="margin-bottom: 2px;">ËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°</label>
                    <div class="settings-desc">ÂêØÁî®ÂêéÂèØËÆæÁΩÆÂæÆ‰ø°È£éÊ†ºÁöÑËßÜÈ¢ëÈÄöËØùÁîªÈù¢</div>
                </div>
                <label class="toggle-switch" style="margin: 0;"> 
                    <input type="checkbox" id="video-call-avatar-toggle"> 
                    <span class="slider"></span> 
                </label>
            </div>

            <div class="settings-item-block" id="video-call-avatar-config" style="display: none;">
                <label>ËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°ËÆæÁΩÆ</label>
                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;">
                    <!-- ÂØπÊñπÂΩ¢Ë±° -->
                    <div class="video-call-image-wrapper">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px; color: #666;">ÂØπÊñπÂΩ¢Ë±°</span>
                            <button class="settings-mini-btn" onclick="document.getElementById('ai-video-call-image-input').click()">‰∏ä‰º†ÂõæÁâá</button>
                        </div>
                        <div class="video-call-image-preview" id="ai-video-call-image-preview">
                            <span style="color: #999; font-size: 13px;">ÁÇπÂáª‰∏ä‰º†ÊåâÈíÆÊ∑ªÂä†ÂõæÁâá</span>
                        </div>
                        <input type="file" id="ai-video-call-image-input" accept="image/*" hidden>
                    </div>
                    <!-- ÊàëÁöÑÂΩ¢Ë±° -->
                    <div class="video-call-image-wrapper">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px; color: #666;">ÊàëÁöÑÂΩ¢Ë±°</span>
                            <button class="settings-mini-btn" onclick="document.getElementById('my-video-call-image-input').click()">‰∏ä‰º†ÂõæÁâá</button>
                        </div>
                        <div class="video-call-image-preview" id="my-video-call-image-preview">
                            <span style="color: #999; font-size: 13px;">ÁÇπÂáª‰∏ä‰º†ÊåâÈíÆÊ∑ªÂä†ÂõæÁâá</span>
                        </div>
                        <input type="file" id="my-video-call-image-input" accept="image/*" hidden>
                    </div>
                </div>
            </div>
        </div>

        <!-- Á¨¨‰∫åÁªÑÔºö‰∫∫ËÆæ‰∏éÂâßÊÉÖ (Ê†∏ÂøÉ) -->
        <div class="settings-section">
            <div class="settings-item-block" id="ai-persona-group">
                <label>ÂØπÊñπ‰∫∫ËÆæ (AI Persona)</label>
                <textarea id="ai-persona" rows="3" class="settings-textarea" placeholder="ËæìÂÖ•ËØ¶ÁªÜÁöÑËßíËâ≤ËÆæÂÆö..."></textarea>
            </div>
            
            <div class="settings-item-block" id="my-persona-group">
                <label>ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label>
                <textarea id="my-persona" rows="3" class="settings-textarea" placeholder="ËæìÂÖ•‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö..."></textarea>
            </div>
            
            <div class="settings-item-block" id="group-members-group">
                <label>Áæ§ÊàêÂëòÁÆ°ÁêÜ</label>
                <div id="group-members-settings" class="horizontal-scroll-list"></div> 
                <button id="manage-members-btn" class="settings-full-btn">ÁÆ°ÁêÜÊâÄÊúâÁæ§ÊàêÂëò</button>
            </div>
            
            <div class="settings-item" id="switch-greeting-group" style="display: none;">
                 <label>ÂºÄÂú∫ÁôΩ</label>
                 <div class="settings-right">
                     <!-- ÂçáÁ∫ß‰∏∫ÂÆû‰ΩìÊåâÈíÆÊ†∑Âºè -->
                     <button id="switch-greeting-btn" class="settings-mini-btn">ÂàáÊç¢ÂºÄÂú∫ÊïÖ‰∫ã</button>
                 </div>
            </div>
            
            <div class="settings-item-block" id="world-book-link-group"> 
                <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶</label>
                <div class="custom-multiselect" style="margin-top: 5px; position: relative;">
                    <div class="select-box"> <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span> <span class="arrow-down">‚ñº</span> </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container"> </div>
                </div>
            </div>
        </div>

        <!-- Á¨¨‰∏âÁªÑÔºöÊ®°Âûã‰∏éÊô∫ËÉΩËÆæÁΩÆ -->
        <div class="settings-section">
            <!-- ÂçïËÅäÁã¨Á´ãÂêéÂè∞ -->
            <div id="single-char-background-activity-group">
                
                <!-- Ê≥®ÂÖ•ÊúÄÊñ∞ÂøÉÂ£∞ -->
                <div class="settings-item" id="inject-thought-group" style="display: flex !important; justify-content: space-between !important; align-items: center !important; flex-direction: row !important;">
                    <div style="flex: 1; padding-right: 10px; display: flex; flex-direction: column; align-items: flex-start;">
                        <label style="margin-bottom: 2px;">Ê≥®ÂÖ•ÊúÄÊñ∞ÂøÉÂ£∞</label>
                        <div class="settings-desc">ÂõûÂ§çÂâçÊ≥®ÂÖ•‰∏ä‰∏ÄËΩÆÁöÑÂÜÖÂøÉÁã¨ÁôΩ</div>
                    </div>
                    <label class="toggle-switch" style="margin: 0;"> 
                        <input type="checkbox" id="inject-thought-toggle"> 
                        <span class="slider"></span> 
                    </label>
                </div>
                
                <!-- ÂêØÁî®Áã¨Á´ãÂêéÂè∞Ê¥ªÂä® -->
                <div class="settings-item" style="display: flex !important; justify-content: space-between !important; align-items: center !important; flex-direction: row !important;">
                     <div style="flex: 1; padding-right: 10px; display: flex; flex-direction: column; align-items: flex-start;">
                        <label style="margin-bottom: 2px;">ÂêØÁî®Áã¨Á´ãÂêéÂè∞Ê¥ªÂä®</label>
                        <div class="settings-desc">ÂÖÅËÆ∏ËßíËâ≤Âú®ÂêéÂè∞‰∏ªÂä®ÂèëÊ∂àÊÅØ</div>
                    </div>
                    <label class="toggle-switch" style="margin: 0;"> 
                        <input type="checkbox" id="char-background-activity-switch"> 
                        <span class="slider"></span> 
                    </label>
                </div>

            </div>

            <!-- Áæ§ËÅäÂêéÂè∞ -->
            <div class="settings-item" id="group-background-activity-group">
                 <div>
                    <label>ÂêØÁî®Áæ§ÂÜÖÂêéÂè∞Ê¥ªÂä®</label>
                    <div class="settings-desc">ÂÖÅËÆ∏AIÂú®Áæ§ÂÜÖËá™Áî±‰∫íÂä®</div>
                </div>
                <label class="toggle-switch"> <input type="checkbox" id="group-background-activity-switch"> <span class="slider"></span> </label>
            </div>

            <!-- ÂÜ∑Âç¥Êó∂Èó¥ -->
            <div class="settings-item" id="ai-cooldown-group">
                <label>Áã¨Á´ãË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü)</label>
                <div class="settings-right">
                     <input type="number" id="ai-action-cooldown-input" class="settings-num-input">
                </div>
            </div>
            <div class="settings-item" id="group-cooldown-group">
                <label>Áæ§ËÅäË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü)</label>
                <div class="settings-right">
                     <input type="number" id="group-action-cooldown-input" class="settings-num-input">
                </div>
            </div>

            <!-- ËÆ∞ÂøÜËÆæÁΩÆ -->
            <div class="settings-item">
                 <label>Áü≠ÊúüËÆ∞ÂøÜÊù°Êï∞</label>
                 <div class="settings-right">
                    <input type="number" id="max-memory" class="settings-num-input">
                 </div>
            </div>
            <div class="settings-item">
                 <label>ÊåÇËΩΩËÆ∞ÂøÜÊù°Êï∞</label>
                 <div class="settings-right">
                    <input type="number" id="linked-memory-count" class="settings-num-input">
                 </div>
            </div>
            
            <div class="settings-item">
                 <div>
                    <label>Ëá™Âä®ÊÄªÁªìÈïøÊúüËÆ∞ÂøÜ</label>
                    <div class="settings-desc">ÂØπËØùËææÂà∞‰∏ÄÂÆöÈïøÂ∫¶Ëá™Âä®ÊèêÁÇº</div>
                </div>
                <label class="toggle-switch"> <input type="checkbox" id="auto-memory-toggle"> <span class="slider"></span> </label>
            </div>
            <div class="settings-item">
                 <label>Ëá™Âä®ÊÄªÁªìÈó¥Èöî (Êù°)</label>
                 <div class="settings-right">
                    <input type="number" id="auto-memory-interval" class="settings-num-input">
                 </div>
            </div>

            <!-- ÊåÇËΩΩËÅäÂ§© -->
            <div class="settings-item-block" id="linked-memory-group"> 
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; height: 30px;">
                    <label for="link-memory-toggle" style="line-height: 30px;">ÊåÇËΩΩÂÖ∂‰ªñËÅäÂ§©ËÆ∞ÂøÜ</label> 
                    <!-- ‰øÆÂ§çÔºö‰ΩøÁî®ÁæéÂåñÁöÑ toggle-switch ÁªìÊûÑÊõø‰ª£ÂéüÁîü checkbox -->
                    <label class="toggle-switch"> 
                        <input type="checkbox" id="link-memory-toggle"> 
                        <span class="slider"></span> 
                    </label>
                 </div>
                 <div id="linked-memory-selection" style="display: none; position: relative;"> 
                    <div class="custom-multiselect">
                      <div class="select-box"> <span class="selected-options-text">-- ÈÄâÊã©ËÅäÂ§© --</span> <span class="arrow-down">‚ñº</span> </div>
                      <div id="linked-chats-checkboxes-container" class="checkboxes-container" style="max-height: 150px;"> </div>
                    </div>
                 </div>
            </div>
            <div class="settings-item">
    <div>
       <label>ÊòæÁ§∫ÈöêËóèÂ±ÇÊ∂àÊÅØ (Ë∞ÉËØï)</label>
       <div class="settings-desc">ÊòæÁ§∫Á≥ªÁªüÊèêÁ§∫„ÄÅÂÜÖÂøÉÁã¨ÁôΩÁ≠âÈöêËóèÂÜÖÂÆπ‰ª•‰æøÁºñËæë</div>
   </div>
   <label class="toggle-switch"> 
       <input type="checkbox" id="show-hidden-msg-toggle"> 
       <span class="slider"></span> 
   </label>
</div>
            <!-- Token ÁªüËÆ° -->
            <div class="settings-section">
                <div class="settings-item">
                    <label>ÂΩìÂâçÂØπËØùÊù°Êï∞</label>
                    <div class="settings-right">
                        <span id="message-count-value" style="color: #8a8a8a;">ËÆ°ÁÆó‰∏≠...</span>
                    </div>
                </div>
                <div class="settings-item">
                    <label>È¢Ñ‰º∞‰∏ä‰∏ãÊñá Token</label>
                    <div class="settings-right">
                        <span id="token-count-value" style="color: #8a8a8a;">ËÆ°ÁÆó‰∏≠...</span>
                    </div>
                </div>
            </div>
        </div>
<!-- Â§©Ê∞îËÆæÁΩÆ (‰ªÖÂçïËÅäÊòæÁ§∫) - UI ‰ºòÂåñÁâà -->
<div class="settings-section" id="weather-settings-section" style="display: none;">
    <!-- ÂºÄÂÖ≥Ë°å -->
    <div class="settings-item">
        <label>ÂêØÁî®ÂÆûÊó∂Â§©Ê∞îÂêåÊ≠•</label>
        <label class="toggle-switch">
            <input type="checkbox" id="enable-weather-switch">
            <span class="slider"></span>
        </label>
    </div>
    
    <!-- ËØ¶ÊÉÖÈÖçÁΩÆÂå∫Âüü (Áî±JSÊéßÂà∂ÊòæÁ§∫/ÈöêËóè) -->
    <div id="weather-config-container" style="display: none;">
        
        <!-- ÊàëÁöÑ‰ΩçÁΩÆ -->
        <div class="settings-item-block">
            <label style="font-weight: 500;">ÊàëÁöÑ‰ΩçÁΩÆ (User)</label>
            <div class="weather-input-group">
                <input type="text" id="user-virtual-city" placeholder="ËôöÊãüÂêç (Â¶Ç: ÈæôÂüé)" class="weather-input">
                <input type="text" id="user-real-city-search" placeholder="ÁúüÂÆûÂüéÂ∏Ç (ÊãºÈü≥/Ëã±Êñá)" class="weather-input">
                <button id="user-city-search-btn" class="settings-mini-btn" style="margin-left: 0;">ÊêúÁ¥¢</button>
            </div>
            <!-- ÈöêËóèÂüü -->
            <input type="hidden" id="user-city-lat">
            <input type="hidden" id="user-city-lon">
            <!-- ÁªìÊûúÂ±ïÁ§∫ -->
            <div id="user-city-result" class="weather-result-text">Êú™ËÆæÁΩÆÊò†Â∞Ñ</div>
        </div>

        <!-- ÂØπÊñπ‰ΩçÁΩÆ -->
        <div class="settings-item-block" style="border-bottom: none;">
            <label style="font-weight: 500;">ÂØπÊñπ‰ΩçÁΩÆ (Char)</label>
            <div class="weather-input-group">
                <input type="text" id="char-virtual-city" placeholder="ËôöÊãüÂêç (Â¶Ç: Âì•Ë∞≠)" class="weather-input">
                <input type="text" id="char-real-city-search" placeholder="ÁúüÂÆûÂüéÂ∏Ç (ÊãºÈü≥/Ëã±Êñá)" class="weather-input">
                <button id="char-city-search-btn" class="settings-mini-btn" style="margin-left: 0;">ÊêúÁ¥¢</button>
            </div>
            <!-- ÈöêËóèÂüü -->
            <input type="hidden" id="char-city-lat">
            <input type="hidden" id="char-city-lon">
            <!-- ÁªìÊûúÂ±ïÁ§∫ -->
            <div id="char-city-result" class="weather-result-text">Êú™ËÆæÁΩÆÊò†Â∞Ñ</div>
        </div>

    </div>
</div>
        <!-- Á¨¨ÂõõÁªÑÔºöÈ´òÁ∫ßÂäüËÉΩ (TTS, NAI, Á∫ø‰∏ãÊ®°Âºè) -->
        <div class="settings-section">
             <!-- ËØ≠Èü≥ -->
             <div class="settings-item" id="tts-enable-group">
                 <label>ÂêØÁî®ËØ≠Èü≥ÂêàÊàê (TTS)</label>
                 <label class="toggle-switch"> <input type="checkbox" id="enable-tts-switch"> <span class="slider"></span> </label>
             </div>
             <div class="settings-item" id="ai-voice-id-group">
                 <label>ËØ≠Èü≥ ID</label>
                 <div class="settings-right">
                    <input type="text" id="ai-voice-id-input" placeholder="minimax voice_id">
                 </div>
             </div>
             <div class="settings-item" id="ai-voice-lang-group">
                <label>ËØ≠Èü≥ËØ≠Ë®Ä/ÊñπË®Ä</label>
                <div class="settings-right">
                  <select id="ai-voice-lang-select" class="settings-select" style="width: 100%; text-align: right;">
                    <option value=""> Ëá™Âä®ËØÜÂà´ (Auto)</option>
                    <hr disabled>
                    <option value="zh-CN">üá®üá≥ ÂõΩËØ≠/ÊôÆÈÄöËØù (Chinese)</option>
                    <option value="zh-HK">üá≠üá∞ Á≤§ËØ≠/Âπø‰∏úËØù (Cantonese)</option>
                    <option value="en-US">üá∫üá∏ Ëã±ËØ≠ (English)</option>
                    <option value="ja-JP">üáØüáµ Êó•ËØ≠ (Japanese)</option>
                    <option value="ko-KR">üá∞üá∑ Èü©ËØ≠ (Korean)</option>
                    <hr disabled>
                    <option value="de-DE">üá©üá™ Âæ∑ËØ≠ (German)</option>
                    <option value="fr-FR">üá´üá∑ Ê≥ïËØ≠ (French)</option>
                    <option value="es-ES">üá™üá∏ Ë•øÁè≠ÁâôËØ≠ (Spanish)</option>
                    <option value="it-IT">üáÆüáπ ÊÑèÂ§ßÂà©ËØ≠ (Italian)</option>
                    <option value="ru-RU">üá∑üá∫ ‰øÑËØ≠ (Russian)</option>
                    <option value="pt-BR">üáßüá∑ Ëë°ËêÑÁâôËØ≠ (Portuguese)</option>
                    <option value="nl-NL">üá≥üá± Ëç∑ÂÖ∞ËØ≠ (Dutch)</option>
                    <option value="pl-PL">üáµüá± Ê≥¢ÂÖ∞ËØ≠ (Polish)</option>
                    <option value="sv-SE">üá∏üá™ ÁëûÂÖ∏ËØ≠ (Swedish)</option>
                    <hr disabled>
                    <option value="tr-TR">üáπüá∑ ÂúüËÄ≥ÂÖ∂ËØ≠ (Turkish)</option>
                    <option value="id-ID">üáÆüá© Âç∞Â∞ºËØ≠ (Indonesian)</option>
                    <option value="ms-MY">üá≤üáæ È©¨Êù•ËØ≠ (Malay)</option>
                    <option value="vi-VN">üáªüá≥ Ë∂äÂçóËØ≠ (Vietnamese)</option>
                    <option value="th-TH">üáπüá≠ Ê≥∞ËØ≠ (Thai)</option>
                    <option value="hi-IN">üáÆüá≥ Âç∞Âú∞ËØ≠ (Hindi)</option>
                    <option value="ar-SA">üá∏üá¶ ÈòøÊãâ‰ºØËØ≠ (Arabic)</option>
                  </select>
                </div>
             </div>
  <div class="settings-item" id="synth-music-group">
    <div>
        <label>ÂêØÁî®‰πêË∞±ÂêàÊàê</label>
        <div class="settings-desc">ÂÖÅËÆ∏ËßíËâ≤ÂèëÈÄÅ‰πêË∞±Âπ∂Ëá™Âä®ÊºîÂ•è</div>
    </div>
    <label class="toggle-switch">
        <input type="checkbox" id="enable-synth-music-switch">
        <span class="slider"></span>
    </label>
</div>
<div class="settings-item" id="narrator-mode-group" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="flex: 1; padding-right: 10px;">
        <label style="margin-bottom: 2px;">ÂêØÁî®ÊóÅÁôΩÊ®°Âºè</label>
        <div class="settings-desc">AIÊØèËΩÆÂõûÂ§çÈÉΩ‰ºöÈôÑÂ∏¶ÁéØÂ¢ÉÊàñÂøÉÁêÜÊèèÂÜô (ÁÅ∞Ëâ≤Á≥ªÁªüÂ≠ó)</div>
    </div>
    <label class="toggle-switch" style="margin: 0;"> 
        <input type="checkbox" id="narrator-mode-toggle"> 
        <span class="slider"></span> 
    </label>
</div>
<div class="settings-item" id="todo-list-setting-group">
    <div style="flex: 1; padding-right: 10px;">
        <label style="margin-bottom: 2px;">ÂêØÁî®ÂæÖÂäû‰∫ãÈ°πÂêåÊ≠•</label>
        <div class="settings-desc">ÂºÄÂêØÂêéÔºåAIÂ∞ÜËØªÂèñ„Äê‰ªäÊó•„ÄëÂèä„ÄêÊú™ÂÆåÊàê„ÄëÁöÑÂæÖÂäû‰∫ãÈ°π„ÄÇ</div>
    </div>
    <label class="toggle-switch" style="margin: 0;"> 
        <input type="checkbox" id="enable-todo-list-switch"> 
        <span class="slider"></span> 
    </label>
</div>
             <!-- Á∫ø‰∏ãÊ®°Âºè -->
             <div id="offline-mode-group">
                 <div class="settings-item">
                     <div>
                        <label>Á∫ø‰∏ãÊ®°Âºè (ÊèèÂÜôÊ®°Âºè)</label>
                        <div class="settings-desc">AIÂ∞ÜËæìÂá∫ÂåÖÂê´Âä®‰Ωú/ÂøÉÁêÜÁöÑÊèèÂÜôÊñáÊú¨</div>
                     </div>
                     <label class="toggle-switch"> <input type="checkbox" id="offline-mode-toggle"> <span class="slider"></span> </label>
                 </div>
                 <div id="offline-mode-options" style="display: none; padding: 0 16px 16px 16px;">
                     <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <span style="font-size:13px; color:#666;">Â≠óÊï∞ËåÉÂõ¥:</span>
                        <input type="number" id="offline-min-length-input" class="settings-num-input" value="100">
                        <span>-</span>
                        <input type="number" id="offline-max-length-input" class="settings-num-input" value="300">
                     </div>
                     <label style="font-size:13px; color:#666;">ÊñáÈ£éÈ¢ÑËÆæ:</label>
                     <select id="offline-preset-select" class="settings-select" style="width:100%; margin-top:5px;"></select>
                 </div>
             </div>

             <!-- Êó∂Èó¥ÊÑüÁü• -->
             <div class="settings-item" id="time-perception-group">
                 <label>Êó∂Èó¥ÊÑüÁü•</label>
                 <label class="toggle-switch"> <input type="checkbox" id="time-perception-toggle"> <span class="slider"></span> </label>
             </div>
             <div class="settings-item-block" id="time-zone-group" style="display: none;">
                 <label>Êó∂Âå∫ËÆæÁΩÆ</label>
                 <div style="margin-top: 10px; width: 100%;">
                     <input type="search" id="time-zone-search-input" placeholder="ÊêúÁ¥¢Êó∂Âå∫..." class="settings-textarea" style="height: 36px; padding: 8px; margin-bottom: 8px;">
                     <select id="time-zone-select" class="settings-select" style="width: 100%; padding: 10px; background-color: #f5f5f7;"></select>
                 </div>
             </div>
             
             <!-- NAIËÆæÁΩÆ (ÂçïËÅä/Áæ§ËÅäÂ§çÁî®IDÔºåJSÊéßÂà∂) -->
             <div class="settings-item-block" id="nai-character-settings-group" style="display: none;">
                <label>NAI Âá∫ÂõæËÆæÁΩÆ (ËßíËâ≤‰∏ìÂ±û)</label>
                <div style="margin-top: 10px;">
                    <button id="character-nai-prompts-btn" class="settings-full-btn">ÈÖçÁΩÆ‰∏ìÂ±ûÊèêÁ§∫ËØç</button>
                </div>
             </div>
             <div class="settings-item-block" id="group-nai-settings-group" style="display: none;">
                <label>NAI Âá∫ÂõæËÆæÁΩÆ (Áæ§ËÅä‰∏ìÂ±û)</label>
                <div style="margin-top: 10px;">
                    <button id="group-character-nai-prompts-btn" class="settings-full-btn">ÈÖçÁΩÆ‰∏ìÂ±ûÊèêÁ§∫ËØç</button>
                </div>
             </div>
        </div>

        <!-- Á¨¨‰∫îÁªÑÔºöÂ§ñËßÇ‰∏éËßÜËßâ -->
        <div class="settings-section">
            <div class="settings-item">
                 <label>ËÅäÂ§©ËÉåÊôØ</label>
                 <!-- Â¢ûÂä† full-width Á±ª‰ª•‰øùÊåÅÂè≥ÂØπÈΩêÔºåÂÜÖÈÉ®‰ΩøÁî® avatar-btn-group ‰øùÊåÅÈó¥Ë∑ù‰∏ÄËá¥ -->
                 <div class="settings-right full-width">
                     <div class="avatar-btn-group" style="justify-content: flex-end; width: 100%;">
                         <!-- ÂçáÁ∫ß‰∏∫ÂÆû‰ΩìÂ∞èÊåâÈíÆ -->
                         <button class="settings-mini-btn" onclick="document.getElementById('bg-input').click()">‰∏ä‰º†</button>
                         <button class="settings-mini-btn" id="remove-bg-btn">ÁßªÈô§</button>
                         
                         <!-- ‰øùÊåÅÂéüÊúâÁöÑÈöêËóè input ÂíåÈ¢ÑËßàÂõæÈÄªËæë -->
                         <input type="file" id="bg-input" accept="image/*" hidden>
                         <img id="bg-preview" class="settings-bg-preview">
                     </div>
                 </div>
            </div>
            
            <div class="settings-item-block">
                <label>Ê∞îÊ≥°‰∏ªÈ¢ò</label>
                 <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <select id="theme-preset-select" class="settings-select" style="flex:1; margin-right:10px;"></select>
                    <div style="display:flex; gap:5px;">
                        <button id="save-theme-preset-btn" class="settings-icon-btn">üíæ</button>
                        <button id="delete-theme-preset-btn" class="settings-icon-btn" style="color:#ff3b30;">üóëÔ∏è</button>
                    </div>
                 </div>
                 <!-- Ë°•ÂÖ®ÊâÄÊúâ‰∏ªÈ¢òÈÄâÈ°π -->
                 <div class="theme-selector" style="max-height: 120px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 12px; padding: 5px 0;">
                      <label><input type="radio" name="theme-select" value="default" id="theme-default"> ÈªòËÆ§</label>
                      <label><input type="radio" name="theme-select" value="pink_blue"> Á≤âËìù</label> 
                      <label><input type="radio" name="theme-select" value="blue_white"> ËìùÁôΩ</label>
                      <label><input type="radio" name="theme-select" value="purple_yellow"> Á¥´ÈªÑ</label>
                      <label><input type="radio" name="theme-select" value="black_white"> ÈªëÁôΩ</label>
                      <label><input type="radio" name="theme-select" value="yellow_white"> ÈªÑÁôΩ</label>
                      <label><input type="radio" name="theme-select" value="red_black"> Á∫¢Èªë</label>
                      <label><input type="radio" name="theme-select" value="blue_yellow"> ËìùÈªÑ</label>
                      <label><input type="radio" name="theme-select" value="pink_yellow"> Á≤âÈªÑ</label>
                      <label><input type="radio" name="theme-select" value="pink_purple"> Á≤âÁ¥´</label>
                      <label><input type="radio" name="theme-select" value="gray_white"> ÁÅ∞ÁôΩ</label>
                      <label><input type="radio" name="theme-select" value="blue_green"> ËìùÁªø</label>
                      <label><input type="radio" name="theme-select" value="pink_white"> Á≤âÁôΩ</label>
                      <label><input type="radio" name="theme-select" value="pink_black"> Á≤âÈªë</label>
                      <label><input type="radio" name="theme-select" value="pink_green"> Á≤âÁªø</label>
                      <label><input type="radio" name="theme-select" value="green_black"> ÁªøÈªë</label>
                      
                      <button id="reset-theme-btn" class="settings-text-btn" style="margin-left: auto;">ÈáçÁΩÆÈªòËÆ§</button>
                 </div>
            </div>

            <div class="settings-item">
                 <label>Â≠ó‰ΩìÂ§ßÂ∞è <span id="font-size-value" style="color:#888; font-size:12px;">13px</span></label>
                 <div class="settings-right" style="width: 50%;">
                    <input type="range" id="font-size-slider" min="12" max="20" step="1" style="width:100%;">
                 </div>
            </div>
            
            <div class="settings-item-block">
                 <label>Ëá™ÂÆö‰πâ CSS <button id="reset-custom-css-btn" style="float:right; font-size:12px;">ÈáçÁΩÆ</button></label>
                 <textarea id="custom-css-input" rows="3" class="settings-textarea" placeholder="/* ÈíàÂØπÂΩìÂâçËÅäÂ§©ÁöÑCSS */"></textarea>
            </div>

            <div class="settings-item-block">
                <label>ÊïàÊûúÈ¢ÑËßà</label>
                <div id="settings-preview-area" style="margin-top:10px;"></div>
            </div>
            
            <div class="settings-item-block" id="lyrics-position-group" style="display: none;">
                 <label>Ê≠åËØçÊ†èËÆæÁΩÆ</label>
                 <div style="display:flex; gap:10px; margin-top:10px;">
                     <select id="lyrics-vertical-pos" class="settings-select"><option value="top">È°∂ÈÉ®</option><option value="bottom">Â∫ïÈÉ®</option></select>
                     <select id="lyrics-horizontal-pos" class="settings-select"><option value="center">Â±Ö‰∏≠</option><option value="left">Â±ÖÂ∑¶</option><option value="right">Â±ÖÂè≥</option></select>
                     <input type="number" id="lyrics-offset-input" class="settings-num-input" value="10" placeholder="ÂÅèÁßª">
                 </div>
            </div>
        </div>

        <!-- Á¨¨ÂÖ≠ÁªÑÔºöÊï∞ÊçÆ‰∏éÊìç‰Ωú (Â∫ïÈÉ®) -->
        <div class="settings-section">
             <div class="settings-item clickable" id="search-history-btn">
                 <label>Êü•ÊâæËÅäÂ§©ËÆ∞ÂΩï</label>
                 <div class="settings-right">‚Ä∫</div>
             </div>
             
             <div class="settings-item clickable" id="export-single-chat-btn">
                 <label>ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï</label>
                 <div class="settings-right">‚Ä∫</div>
             </div>
             
             <div class="settings-item clickable" id="import-single-chat-btn">
                 <label>ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩï</label>
                 <div class="settings-right">
                     ‚Ä∫
                     <input type="file" id="import-single-chat-input" accept="application/json" hidden>
                 </div>
             </div>

             <div class="settings-item clickable" id="clear-chat-btn">
                 <label style="color: #ff3b30;">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</label>
                 <div class="settings-right">‚Ä∫</div>
             </div>
             
             <div class="settings-item clickable" id="block-chat-btn">
                 <label style="color: #ff3b30;">ÊãâÈªëÂØπÊñπ / ÁßªÂá∫Áæ§ËÅä</label>
                 <div class="settings-right">‚Ä∫</div>
             </div>
        </div>
        
        <div style="height: 40px;"></div> <!-- Â∫ïÈÉ®Âû´È´ò -->
      </div>
    </div>
    <div id="rendering-rules-screen" class="screen">
      <div class="header"> 
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span> 
        <span data-lang-key="homeAppRenderer">Ê∏≤ÊüìËßÑÂàô</span> 
        <div class="header-actions">
            <span class="action-btn" id="import-rules-btn" title="ÂØºÂÖ•ËßÑÂàô">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </span>
            <span class="action-btn" id="manage-rules-btn" title="ÁÆ°ÁêÜ/Â§öÈÄâ">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        <polyline points="9 11 12 14 22 4"></polyline>
    </svg>
</span>
            <span class="action-btn" id="add-new-rule-btn">+</span> 
        </div>
      </div>
      <div id="rules-tabs"> </div>
      <div id="rules-content-container" class="list-container"> </div>
      
      <div id="rules-action-bar" style="display: none; position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-top: 1px solid #eee; box-sizing: border-box; justify-content: space-between; align-items: center; z-index: 10;">
          <label style="display:flex; align-items:center; gap:5px; font-size:16px;">
              <input type="checkbox" id="select-all-rules-checkbox"> ÂÖ®ÈÄâ
          </label>
          <div style="display:flex; gap:10px;">
              <button id="export-selected-rules-btn" class="settings-mini-btn" style="background-color: #007aff; color: white; border: none;">ÂØºÂá∫ (0)</button>
              <button id="delete-selected-rules-btn" class="settings-mini-btn" style="color: #ff3b30;">Âà†Èô§ (0)</button>
          </div>
      </div>
    </div>
    <input type="file" id="import-rules-input" accept=".json" style="display: none;">
    <div id="rule-editor-modal" class="modal">
      <div class="modal-content" style="height: 85%;">
        <div class="modal-header"> <span id="rule-editor-title">ÂàõÂª∫Êñ∞ËßÑÂàô</span> </div>
        <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
          <div class="form-group" style="flex-shrink: 0;"> <label for="rule-name-input">ËßÑÂàôÂêçÁß∞</label> <input type="text" id="rule-name-input" placeholder="‰æãÂ¶ÇÔºöÁæéÂõ¢Â§ñÂçñÂç°Áâá"> </div>
          <div class="form-group" style="flex-shrink: 0;"> <label for="rule-chat-id-select">ÁªëÂÆöËåÉÂõ¥</label> <select id="rule-chat-id-select">
              <option value="global">ÂÖ¨Áî® (ÊâÄÊúâËßíËâ≤)</option>
            </select> </div>
          <div class="form-group" style="flex-grow: 1; display: flex; flex-direction: column;"> <label for="rule-regex-input">Ê≠£ÂàôË°®ËææÂºè (‰ΩøÁî®g‰Ωú‰∏∫Ê†áÂøó)</label> <textarea id="rule-regex-input" rows="3" style="font-family: monospace; resize: vertical;" placeholder="‰æãÂ¶ÇÔºöMTR\[(.*?)\]\[(.*?)\|(.*?)\]"></textarea>
          </div>
          <div class="form-group" style="flex-grow: 2; display: flex; flex-direction: column;"> <label for="rule-template-input">HTML Ê®°Êùø (Áî® $1, $2 ÂºïÁî®)</label> <textarea id="rule-template-input" rows="6" style="font-family: monospace; resize: vertical;"
              placeholder="‰æãÂ¶ÇÔºö<div class=`waimai-card`>...<span>$2</span>...</div>"></textarea> </div>
          <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;"> <label for="rule-enabled-switch" style="margin-bottom: 0;">ÂêØÁî®ËßÑÂàô</label> <label class="toggle-switch"> <input type="checkbox" id="rule-enabled-switch" checked>
              <span class="slider"></span> </label> </div>
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
    <label for="rule-do-not-send-switch" style="margin-bottom: 0;">
        Ê∏≤ÊüìÊó∂‰ªé‰∏ä‰∏ãÊñá‰∏≠Âà†Èô§
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            ÂºÄÂêØÂêéÔºåÂåπÈÖçÊ≠§ËßÑÂàôÁöÑÊ∂àÊÅØÂ∞Ü‰∏ç‰ºöË¢´ÂèëÈÄÅÁªôAIÔºå‰ªÖÁî®‰∫éÂâçÁ´ØÊòæÁ§∫„ÄÇ
        </p>
    </label>
    <label class="toggle-switch">
        <input type="checkbox" id="rule-do-not-send-switch">
        <span class="slider"></span>
    </label>
</div>
        </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-rule-editor-btn" data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-rule-btn"data-lang-key="save">‰øùÂ≠òËßÑÂàô</button> </div>
      </div>
    </div>
    <div id="search-history-screen" class="screen">
      <div class="header"> <span class="back-btn" id="search-history-back-btn">‚Äπ</span> <span>ÊêúÁ¥¢ËÅäÂ§©ËÆ∞ÂΩï</span> <span style="width: 30px;"></span> </div>
      <div id="search-bar" style="padding: 10px 15px; border-bottom: 1px solid var(--border-color); background-color: var(--secondary-bg); flex-shrink: 0;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px;"> <input type="search" id="keyword-search-input" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØç..." style="flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;"> <input type="date" id="date-search-input"
            style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;"> </div>
        <div style="display: flex; gap: 10px;"> <button id="execute-search-btn" class="form-button" style="margin-top: 0; flex-grow: 1;">ÊêúÁ¥¢</button> <button id="clear-search-btn" class="form-button form-button-secondary" style="margin-top: 0; flex-grow: 1;">ÈáçÁΩÆ</button> </div>
      </div>
      <div id="chat-search-results-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;"> </div>
    </div>
<!-- ÊîØ‰ªòÂÆùÂ±èÂπï -->
<div id="alipay-screen" class="screen">
    <div class="alipay-header-area">
        <div class="alipay-nav">
            <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
            <span class="alipay-title">ÊîØ‰ªòÂÆù</span>
            <span class="alipay-action" onclick="handleUserTopUp()">ÂÖÖÂÄº</span>
        </div>
    </div>
    
    <div class="alipay-card-container">
        <div class="alipay-balance-card">
            <div class="balance-label">
                <span>ÊÄªËµÑ‰∫ß(CNY)</span>
                </div>
            <div class="balance-amount" id="alipay-balance-display">0.00</div>
            <div class="balance-status-tag" id="alipay-status-tag">Ê†áÂáÜ‰ºöÂëò</div>
        </div>

        <div class="alipay-grid-menu">
            <div class="alipay-menu-item" onclick="openFundScreen()">
                <div class="menu-icon">üìà</div>
                <div class="menu-info">
                    <div class="menu-title">Âü∫ÈáëÁêÜË¥¢</div>
                    <div class="menu-trend" id="fund-market-trend-preview" style="font-size:12px;">+2.35%</div>
                </div>
                <div class="menu-arrow">‚Ä∫</div>
            </div>
            </div>
        
        </div>

    <div class="alipay-bill-container" style="margin: 0 12px; border-radius: 16px;">
        <div id="alipay-transaction-list">
            </div>
    </div>
</div>
<!-- Âü∫ÈáëÁêÜË¥¢Â±èÂπï (Â∑≤ÂéªÊéâ‰∫ÜÂÜÖËÅîÈ¢úËâ≤ÔºåÊîπ‰∏∫ class ÊéßÂà∂) -->
<div id="fund-screen" class="screen" style="background-color: #f5f5f5;">
    <!-- Â§¥ÈÉ®ÔºöÊ∑ªÂä†‰∫Ü class="fund-header-area" -->
    <div class="header fund-header-area">
        <span class="back-btn" onclick="showScreen('alipay-screen')" style="color: white;">‚Äπ</span>
        <span>ÁêÜË¥¢Â∏ÇÂú∫</span>
        <span class="action-btn" onclick="refreshFundMarket()" style="font-size: 14px; color: white;">Âà∑Êñ∞</span>
    </div>
    
    <!-- ËµÑ‰∫ßÂç°ÁâáÔºöÊ∑ªÂä†‰∫Ü class="fund-asset-card" -->
    <div class="fund-asset-card">
        <div style="font-size: 13px; opacity: 0.8;">ÊåÅÊúâÊÄªËµÑ‰∫ß (CNY)</div>
        <div style="font-size: 32px; font-weight: 700; margin: 5px 0;" id="fund-total-assets">0.00</div>
        <div style="font-size: 13px; display: flex; gap: 15px;">
            <span>Êò®Êó•Êî∂Áõä <span id="fund-yesterday-profit">0.00</span></span>
            <span>ÊåÅÊúâÊî∂Áõä <span id="fund-total-profit">0.00</span></span>
        </div>
    </div>

    <div class="list-container" style="padding: 20px 15px; padding-bottom: 80px; background-color: #f5f5f5; border-radius: 20px 20px 0 0; overflow-y: auto; margin-top: -20px;">
        <div class="frame-tabs" style="background: white; border-radius: 12px; padding: 5px; margin-bottom: 15px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div id="tab-fund-market" class="frame-tab active" onclick="switchFundTab('market')" style="border-radius: 8px;">Â∏ÇÂú∫ÁÉ≠Èó®</div>
            <div id="tab-fund-my" class="frame-tab" onclick="switchFundTab('my')" style="border-radius: 8px;">ÊàëÁöÑÊåÅ‰ªì</div>
        </div>

        <div id="fund-market-list" style="display: block;"></div>
        <div id="fund-my-list" style="display: none;"></div>
        
        <p style="font-size: 12px; color: #999; text-align: center; margin-top: 20px;">
            Â∏ÇÂú∫ÊúâÈ£éÈô©ÔºåÊäïËµÑÈúÄË∞®ÊÖé<br>Ê®°ÊãüÊï∞ÊçÆ‰ªÖ‰æõÂ®±‰πê
        </p>
    </div>
</div>

<!-- Âü∫Èáë‰∫§ÊòìÂºπÁ™ó -->
<div id="fund-trade-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span id="fund-trade-title">Âü∫Èáë‰∫§Êòì</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                <div id="fund-trade-name" style="font-weight: bold; font-size: 16px;"></div>
                <div id="fund-trade-code" style="font-size: 12px; color: #999;"></div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                    <span style="font-size: 13px;">ÂΩìÂâçÂáÄÂÄº: <span id="fund-trade-nav" style="color: #1677ff; font-weight: bold;"></span></span>
                    <span style="font-size: 13px;">Êó•Ê∂®Ë∑å: <span id="fund-trade-change"></span></span>
                </div>
            </div>
            
            <div class="form-group">
                <label id="fund-trade-label">‰π∞ÂÖ•ÈáëÈ¢ù (‰ΩôÈ¢ù: ¬•<span id="fund-wallet-balance"></span>)</label>
                <!-- ‰øÆÂ§çÔºöÂº∫Âà∂ type="number" -->
                <input type="number" id="fund-trade-amount" placeholder="ËØ∑ËæìÂÖ•ÈáëÈ¢ù" style="font-size: 24px; font-weight: bold; color: #1677ff; border-bottom: 2px solid #eee; padding: 10px 0;">
            </div>
            <p id="fund-trade-info" style="font-size: 12px; color: #666; margin-top: 5px;"></p>
        </div>
        <div class="modal-footer">
            <button class="cancel" onclick="document.getElementById('fund-trade-modal').classList.remove('visible')">ÂèñÊ∂à</button>
            <!-- ‰øÆÂ§çÔºöÁõ¥Êé•ÁªëÂÆö onclick ÂáΩÊï∞Ôºå‰∏çÂÜç‰æùËµñ addEventListener -->
            <button class="save" id="fund-confirm-btn" onclick="handleFundTradeConfirm()">Á°ÆËÆ§</button>
        </div>
    </div>
</div>
<div id="auction-screen" class="screen" style="background-color: #121212; color: #e0e0e0;">
    <div class="header" style="background-color: #1c1c1e; color: #d4af37; border-bottom: 1px solid #333;">
    <span class="back-btn" onclick="showScreen('home-screen')" style="color: #d4af37;">‚Äπ</span>
    <span>ÈªëÂ∏ÇÊãçÂçñ</span>
    <div class="header-actions">
        <span class="action-btn" onclick="generateNewAuctionItem()">Êñ∞ÊãçÂìÅ</span>
        <span class="action-btn" onclick="openInventoryModal()">üì¶ ‰ªìÂ∫ì</span>
        
    </div>
   </div>
    
    <!-- ÊãçÂìÅÂ±ïÁ§∫Âå∫ -->
    <div id="auction-main-display" style="padding: 20px; text-align: center; height: 45%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div id="auction-item-image-container" style="width: 200px; height: 200px; border: 2px solid #d4af37; border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); background: #000; margin-bottom: 15px; position: relative;">
            <img id="auction-item-img" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
            <div id="auction-loading" style="color: #666; margin-top: 90px;">Á≠âÂæÖÊãçÂìÅ...</div>
        </div>
        <h2 id="auction-item-name" style="margin: 5px 0; font-size: 20px; color: #fff;">---</h2>
        <p id="auction-item-desc" style="font-size: 12px; color: #888; margin: 0; max-height: 40px; overflow: hidden;">---</p>
    </div>

    <!-- Á´û‰ª∑‰ø°ÊÅØÂå∫ -->
    <div style="background-color: #1c1c1e; padding: 15px; border-radius: 20px 20px 0 0; flex-grow: 1; display: flex; flex-direction: column; box-shadow: 0 -4px 20px rgba(0,0,0,0.5);">
        
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333;">
            <div>
                <div style="font-size: 12px; color: #888;">ÂΩìÂâçÊúÄÈ´ò‰ª∑</div>
                <div id="auction-current-price" style="font-size: 32px; font-weight: bold; color: #ff4d4f; font-family: monospace;">¬• 0</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ÂÄíËÆ°Êó∂</div>
                <div id="auction-timer" style="font-size: 24px; font-weight: bold; color: #d4af37;">--</div>
            </div>
        </div>

        <!-- ÂÆûÊó∂Âá∫‰ª∑ËÆ∞ÂΩï -->
        <div id="auction-log" style="flex-grow: 1; overflow-y: auto; font-size: 13px; margin-bottom: 15px; height: 100px;">
            <div style="color: #666; text-align: center;">Á≠âÂæÖÂºÄÊãç...</div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div id="auction-controls" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <button class="form-button-secondary" onclick="placeBid(1.1)" style="background: #333; color: white; border: 1px solid #555;">+10%</button>
            <button class="form-button-secondary" onclick="placeBid(1.5)" style="background: #333; color: white; border: 1px solid #555;">+50%</button>
            <button class="form-button" onclick="placeBid('custom')" style="background: linear-gradient(135deg, #d4af37, #f2d06b); color: black; font-weight: bold; border: none;">Âá∫‰ª∑</button>
        </div>
    </div>
</div>
<div id="todo-list-screen" class="screen" style="background-color: #f2f2f7;">
    <div class="header">
        <span class="back-btn" id="todo-list-back-btn">‚Äπ</span>
        <span>ÂæÖÂäû‰∫ãÈ°π</span>
        <span class="action-btn" id="add-todo-btn" style="font-size: 24px;">+</span>
    </div>
    
    <div class="todo-date-navigator">
        <button id="todo-prev-day-btn">‚Äπ</button>
        <div id="todo-current-date-display">‰ªäÂ§©</div>
        <button id="todo-next-day-btn">‚Ä∫</button>
    </div>

    <div id="todo-list-container" class="list-container" style="padding: 15px;">
        </div>
</div>
<div id="green-river-screen" class="screen gr-theme">
    <div class="gr-header">
    <button class="gr-icon-btn" onclick="showScreen('home-screen')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
    
    <span class="gr-title">Green River</span>
    
    <div class="gr-header-actions">
        <button class="gr-icon-btn" onclick="openAuthorManager()" title="‰ΩúËÄÖÁÆ°ÁêÜ">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
        <button class="gr-icon-btn" onclick="createNewStory()" title="Êñ∞Âª∫‰ΩúÂìÅ">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
    </div>
</div>
    
    <div class="gr-content-area">
        <div class="gr-section-header">
            <span class="gr-section-title">‰π¶Êû∂ Library</span>
        </div>
        <div id="gr-book-list" class="gr-grid-list">
            </div>
    </div>
</div>

<div id="gr-author-screen" class="screen gr-theme">
    <div class="gr-header">
        <button class="gr-icon-btn" onclick="showScreen('green-river-screen')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <span class="gr-title">Authors</span>
        <div class="gr-header-actions">
            <button class="gr-icon-btn" onclick="addAuthor()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>
    </div>
    <div class="gr-content-area" id="gr-author-list"></div>
</div>

<div id="gr-reader-screen" class="screen gr-theme">
    <div class="gr-header">
        <button class="gr-icon-btn" onclick="showScreen('green-river-screen')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div style="display:flex; flex-direction:column; align-items:center;">
             <span class="gr-title" id="gr-book-name-display" style="font-size:14px; opacity:0.7;">‰π¶Âêç</span>
             <span class="gr-title" id="gr-chapter-title-display" style="font-size:16px; font-weight:bold;">Á¨¨‰∏ÄÁ´†</span>
        </div>
        <button class="gr-icon-btn" onclick="openStorySettings()" title="ËÆæÂÆö">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </div>

    <div id="gr-sidebar-overlay" onclick="closeChapterList()"></div>
    <div id="gr-chapter-sidebar">
        <div class="gr-sidebar-header">
            <span>ÁõÆÂΩï Contents</span>
            <span id="gr-total-chapters" style="font-size:12px; color:#888;">ÂÖ± 0 Á´†</span>
        </div>
        <div id="gr-chapter-list-content">
            </div>
    </div>
    
    <div class="gr-reader-content" id="gr-reader-content">
        </div>

    <div class="gr-control-panel">
        <div id="gr-pagination-controls" style="display:flex; justify-content:space-between; align-items:center; width:100%;">
            <button class="gr-text-btn" id="gr-prev-chapter-btn">‰∏ä‰∏ÄÁ´†</button>
            <button class="gr-icon-btn" id="gr-menu-btn" onclick="openChapterList()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            </button>
            <button class="gr-text-btn" id="gr-next-chapter-btn">‰∏ã‰∏ÄÁ´†</button>
        </div>

        <div id="gr-writing-controls" style="display:none; gap:10px; align-items:center; width:100%; margin-top:10px;">
             <div class="gr-input-group" style="flex-grow:1;">
                <input type="text" id="gr-direction-input" class="gr-input" placeholder="ËæìÂÖ•Êú¨Á´†ÂâßÊÉÖËµ∞Âêë (‰æãÂ¶ÇÔºö‰∏§‰∫∫ÂèëÁîü‰∫âÂêµ)...">
            </div>
            <button id="gr-reroll-btn" class="gr-main-btn" style="background-color:#F4F4F5; color:#666; border:1px solid #ddd; padding: 10px;" title="ÈáçÂÜôÊú¨Á´†">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
            <button id="gr-generate-btn" class="gr-main-btn">
                
                <svg id="gr-gen-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>
<!-- ÈÇÆÁÆ±‰∏ªÁïåÈù¢ -->
<div id="email-screen" class="screen mail-theme">
    <div class="mail-header">
    <button class="mail-icon-btn" onclick="showScreen('home-screen')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        <span style="font-size: 16px; margin-left: -2px;">ËøîÂõû</span>
    </button>
    
    <div class="mail-header-actions">
        <button class="mail-icon-btn" onclick="openEmailSettings()" title="ÈÇÆÁÆ±ÈÖçÁΩÆ">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        </button>

        <button class="mail-icon-btn" onclick="handleQuickReceiveMail()" title="‰∏ÄÈîÆÊé•Êî∂Êñ∞ÈÇÆ‰ª∂">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="M22 7l-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
                <line x1="12" y1="19" x2="12" y2="15"></line>
                <line x1="10" y1="17" x2="14" y2="17"></line>
            </svg>
        </button>

        <button id="mail-edit-btn" class="mail-icon-btn" onclick="toggleEmailEditMode()" title="ÁºñËæëÂàóË°®">
        ÁºñËæë
    </button>
    </div>
</div>

    <div style="flex-shrink: 0;">
        <h1 class="mail-large-title">Êî∂‰ª∂ÁÆ±</h1>
        <div class="mail-search-bar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8E8E93" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" placeholder="ÊêúÁ¥¢" id="mail-search-input">
        </div>
    </div>

    <div id="email-list" class="mail-list-container">
        </div>
     <div id="mail-action-bar" style="display: none;">
        <div class="select-all-btn" id="mail-select-all-btn">ÂÖ®ÈÄâ</div>
        <button id="mail-delete-selected-btn" class="mail-delete-action-btn">Âà†Èô§ (0)</button>
    </div>
</div>

<div id="email-detail-screen" class="screen mail-theme" style="background-color: #fff; display: flex; flex-direction: column;">
    <div class="mail-detail-header">
        <button class="mail-icon-btn" onclick="closeEmailDetail()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            <span style="color: #007AFF; font-size: 16px; margin-left: -2px;">Êî∂‰ª∂ÁÆ±</span>
        </button>
        
        <div class="mail-header-actions">
            <button class="mail-icon-btn" id="forward-email-btn" title="ËΩ¨ÂèëÂà∞ËÅäÂ§©">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
            <button class="mail-icon-btn" id="delete-email-btn" title="Âà†Èô§ÈÇÆ‰ª∂" style="color: #ff3b30;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
        </div>
    </div>
    
    <div class="mail-detail-content">
        <div class="mail-meta-header">
            <div class="mail-subject-line" id="mail-detail-subject">Subject</div>
            <div class="mail-meta-row">
                <div class="mail-sender-avatar" id="mail-detail-avatar"></div>
                <div class="mail-meta-info">
                    <div class="mail-from-row">
                        <span class="mail-from-name" id="mail-detail-from">Sender Name</span>
                        <span class="mail-time" id="mail-detail-time">Today</span>
                    </div>
                    <div class="mail-to-row">To: <span id="mail-detail-to">Me</span></div>
                </div>
            </div>
        </div>
        <div class="mail-body-text" id="mail-detail-body">
            </div>
    </div>
    </div>
    
</div>

<!-- ÈÇÆ‰ª∂ÁîüÊàêÂô®ÈÖçÁΩÆÂºπÁ™ó -->
<div id="email-generator-modal" class="modal">
    <div class="modal-content" style="height: 85%; background-color: #FAFAF9; border-radius: 20px;">
        <div class="mail-modal-header">
            <span>Êî∂‰ª∂ÁÆ±ÈÖçÁΩÆ</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            
            <!-- 1. Ë∫´‰ªΩËÆæÂÆö -->
            <div class="gr-form-group">
                <label>Êî∂‰ª∂‰∫∫Ë∫´‰ªΩ (User Persona)</label>
                
                <select id="mail-user-persona-select" class="gr-input" style="margin-bottom: 8px; padding: 8px; border:1px solid #ddd;">
                    <option value="">-- ‰ªÖ‰ΩøÁî®‰∏ãÊñπÂÖ≥ÈîÆËØç --</option>
                </select>

                <input type="text" id="mail-user-mask" class="gr-input" placeholder="‰æãÂ¶ÇÔºö‰æ¶Êé¢„ÄÅÂÖ¨Âè∏È´òÁÆ°„ÄÅÁ•ûÁßò‰∫∫..." value="ÊôÆÈÄöÁî®Êà∑">
                <p style="font-size:11px; color:#999; margin-top:5px;">ÈÄâÊã©È¢ÑËÆæÂèØÊèê‰æõËØ¶ÁªÜËÉåÊôØÔºå‰∏ãÊñπËæìÂÖ•Ê°ÜÁî®‰∫éÂÆö‰πâÂΩìÂâçÂÖ∑‰ΩìÁöÑÁ§æ‰ºöË∫´‰ªΩ„ÄÇ</p>
            </div>

            <!-- 2. ‰∏ñÁïåËßÇËÆæÂÆö -->
            <div class="gr-form-group">
                <label>ÈÇÆ‰ª∂Á≥ªÁªüËÉåÊôØ (World Context)</label>
                <textarea id="mail-world-context" class="gr-input" rows="3" placeholder="‰æãÂ¶ÇÔºöËµõÂçöÊúãÂÖãÈªëÂÆ¢ËÆ∫ÂùõÈÄöÁü•„ÄÅÁª¥Â§öÂà©‰∫öÊó∂ÊúüÁöÑ‰ø°‰ª∂„ÄÅÁé∞‰ª£ËÅåÂú∫ÂûÉÂúæÈÇÆ‰ª∂..."></textarea>
            </div>

            <!-- 3. Âèë‰ª∂‰∫∫Êù•Ê∫ê -->
            <div class="gr-form-group">
                <label>Âèë‰ª∂‰∫∫Êù•Ê∫ê (Â§öÈÄâ)</label>
                <div class="gr-checkbox-list" id="mail-sender-list">
                    <!-- JS Âä®ÊÄÅÂ°´ÂÖÖËßíËâ≤Âíå NPC -->
                </div>
                <label style="margin-top:10px; display:flex; align-items:center;">
                    <input type="checkbox" id="mail-allow-random-npc" checked> ÂÖÅËÆ∏ÁîüÊàêÈöèÊú∫ÈôåÁîü‰∫∫/ÂûÉÂúæÈÇÆ‰ª∂
                </label>
            </div>

            <!-- 4. ÂÖ≥ËÅî‰∏ä‰∏ãÊñá -->
            <div class="gr-form-group">
                <label>ÂÖ≥ËÅîËÆ∞ÂøÜ‰∏é‰∏ñÁïå‰π¶</label>
                <div class="gr-checkbox-list" id="mail-context-list">
                    <!-- JS Âä®ÊÄÅÂ°´ÂÖÖ‰∏ñÁïå‰π¶ -->
                </div>
            </div>
          <div class="gr-form-group">
                <label>ÁîüÊàêÊï∞Èáè</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="number" id="mail-gen-count" class="gr-input" value="3" min="1" max="10" style="flex:1;">
                    <span style="font-size: 13px; color: #888;">Â∞Å</span>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #E5E5E5; display:flex; gap:15px;">
            <button class="cancel" style="background:#F5F5F7; color:#000; border:none;" onclick="document.getElementById('email-generator-modal').classList.remove('visible')">ÂèñÊ∂à</button>
            <button class="save" style="background:#007AFF; color:#fff; border:none;" id="start-generate-email-btn">Êé•Êî∂ÈÇÆ‰ª∂</button>
        </div>
    </div>
</div>

    <div id="shopping-screen" class="screen">
      <div class="header">
        <div class="header-left-actions"> <span class="back-btn" id="shopping-back-btn">‚Äπ</span> <span class="action-btn" id="generate-shopping-items-btn" title="AIÁîüÊàêÂïÜÂìÅ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> </span> <span class="action-btn" id="shopping-settings-btn" title="ÁîüÊàêËÆæÁΩÆ"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path
                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.12,4.84c-0.59,0.24-1.12,0.56-1.62,0.94L5.11,4.82c-0.22-0.08-0.47,0-0.59,0.22l-1.92,3.32 c-0.12,0.22-0.07,0.47,0.12,0.61l2.03,1.58C4.84,11.36,4.82,11.68,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.48,2.03 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.48-2.03c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z">
              </path>
            </svg> </span> <span class="action-btn" id="delete-current-category-btn" title="Âà†Èô§ÂΩìÂâçÂàÜÁ±ª" style="display: none; color: rgb(255, 59, 48);"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
              <line x1="18" y1="9" x2="12" y2="15"></line>
              <line x1="12" y1="9" x2="18" y2="15"></line>
            </svg> </span> </div> <span>Ë¥≠Áâ©‰∏≠ÂøÉ</span>
        <div class="header-actions"> <span class="action-btn" id="manage-products-btn" title="ÁÆ°ÁêÜÂïÜÂìÅ" style="color: var(--text-primary);"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg> </span> <span class="action-btn" id="add-new-product-btn" title="Ê∑ªÂä†Êñ∞ÂïÜÂìÅ"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg> </span> <span class="action-btn" id="go-to-cart-btn" title="Êü•ÁúãË¥≠Áâ©ËΩ¶"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg> <span id="cart-count">0</span> </span> </div>
      </div>
      <div id="product-category-tabs"></div>
      <div id="product-grid" class="list-container"> </div>
      <div id="shopping-action-bar"> <label class="select-all-label"> <input type="checkbox" id="select-all-products-checkbox"> ÂÖ®ÈÄâ </label> <button id="delete-selected-products-btn" class="action-bar-btn">Âà†Èô§ (0)</button> </div>
    </div>
    <div id="product-detail-screen" class="screen">
      <div class="header"> <span class="back-btn" id="product-detail-back-btn">‚Äπ</span> <span>ÂïÜÂìÅËØ¶ÊÉÖ</span> <span style="width: 30px;"></span> </div>
      <div id="product-detail-content" class="list-container"> </div>
      <div id="product-detail-footer"> <button class="footer-btn add-to-cart-detail-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button> <button class="footer-btn buy-now-btn">Á´ãÂç≥Ë¥≠‰π∞</button> </div>
    </div>
    <div id="cart-screen" class="screen">
      <div class="header"> <span class="back-btn" id="cart-back-btn">‚Äπ</span> <span id="cart-title">Ë¥≠Áâ©ËΩ¶(0)</span> <span class="action-btn" id="clear-cart-btn">Ê∏ÖÁ©∫</span> </div>
      <div id="cart-items-list" class="list-container"> </div>
      <div id="cart-footer"> <label class="select-all-label"><input type="checkbox" id="select-all-cart-items"> ÂÖ®ÈÄâ</label>
        <div class="cart-summary">
          <div id="cart-total">ÂêàËÆ°: ¬•0.00</div> <span class="cart-subtext">‰∏çÂê´ËøêË¥π</span>
        </div> <button id="checkout-btn">ÁªìÁÆó(0)</button>
      </div>
    </div>
    <div id="product-editor-modal" class="modal">
      <div class="modal-content" style="height: 85%;">
        <div class="modal-header"> <span id="product-editor-title">Ê∑ªÂä†ÂïÜÂìÅ</span> </div>
        <div class="modal-body">
          <div class="form-group"> <label>ÂïÜÂìÅÂõæÁâá</label>
            <div class="avatar-upload"> <img id="product-image-preview" src="https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg"> <button onclick="document.getElementById('product-image-input').click()">‰∏ä‰º†ÂõæÁâá</button> <input type="file" id="product-image-input"
                accept="image/*" hidden> </div>
          </div>
          <div class="form-group"> <label for="product-name-input">ÂïÜÂìÅÂêçÁß∞</label> <input type="text" id="product-name-input"> </div>
          <div class="form-group"> <label for="product-category-select">ÂïÜÂìÅÂàÜÁ±ª</label>
            <div style="display: flex; align-items: center; gap: 10px;"> <select id="product-category-select" style="flex-grow: 1;"></select> <button id="manage-product-categories-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">ÁÆ°ÁêÜ</button> </div>
          </div>
          <div class="form-group"> <label for="product-price-input">ÈªòËÆ§‰ª∑Ê†º (ÂÖÉ)</label> <input type="number" id="product-price-input" min="0" step="0.01"> </div>
          <div class="form-group"> <label for="product-description-input">ÂïÜÂìÅÊèèËø∞</label> <textarea id="product-description-input" rows="3" placeholder="ËØ¶ÁªÜ‰ªãÁªç‰∏Ä‰∏ãËøô‰∏™ÂïÜÂìÅ..."></textarea> </div>
          <hr style="opacity: 0.2; margin: 20px 0;">
          <div class="form-group"> <label>ÂïÜÂìÅÊ¨æÂºè</label>
            <p style="font-size: 12px; color: #888; margin-top: -5px; margin-bottom: 10px;">Â¶ÇÊûúÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïÊ¨æÂºèÔºåÂ∞Ü‰ΩøÁî®‰∏äÈù¢ÁöÑÈªòËÆ§‰ª∑Ê†º„ÄÇ</p>
            <div id="product-variations-container" style="display: flex; flex-direction: column; gap: 15px;"> </div> <button id="add-product-variation-btn" class="form-button form-button-secondary" style="margin-top: 15px;">+ Ê∑ªÂä†Êñ∞ÁöÑ‰∏ÄÊ¨æ</button>
          </div>
        </div>
        <div class="modal-footer"> <button class="cancel" id="cancel-product-editor-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-product-btn"data-lang-key="save">‰øùÂ≠ò</button> </div>
      </div>
    </div>
    <div id="gift-receipt-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header"> <span>Ë¥≠Áâ©Â∞èÁ•®</span> </div>
        <div class="modal-body" id="gift-receipt-body"> </div>
        <div class="modal-footer"> <button class="save" id="close-receipt-btn" style="width:100%;">ÂÖ≥Èó≠</button> </div>
      </div>
    </div>
  </div>
  </div> <input type="file" id="import-card-input" accept=".json,.png" style="display: none;"> <input type="file" id="import-world-book-input" accept=".json" style="display: none;">
  <div id="persona-library-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span>ÊàëÁöÑ‰∫∫ËÆæÂ∫ì</span><button id="add-persona-preset-btn" class="action-button"data-lang-key="add">Ê∑ªÂä†</button></div>
      <div class="modal-body">
        <div id="persona-library-grid"></div>
      </div>
      <div class="modal-footer"><button class="cancel" id="close-persona-library-btn">ÂÖ≥Èó≠</button></div>
    </div>
  </div>
  <div id="persona-editor-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span id="persona-editor-title">Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ</span></div>
      <div class="modal-body">
        <div class="form-group"><label>È¢ÑËÆæÂ§¥ÂÉè</label>
          <div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input type="file" id="preset-avatar-input" accept="image/*"></div>
        </div>
        <div class="form-group"><label for="preset-persona-input">È¢ÑËÆæ‰∫∫ËÆæ</label><textarea id="preset-persona-input" rows="4" placeholder="Âú®Ê≠§ËæìÂÖ•Ëøô‰∏™‰∫∫ËÆæÁöÑËØ¶ÁªÜËÆæÂÆö..."></textarea></div>
      </div>
      <div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn"data-lang-key="cancel">ÂèñÊ∂à</button><button class="save" id="save-persona-preset-btn"data-lang-key="save">‰øùÂ≠ò</button></div>
    </div>
  </div>
  <div id="member-settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span data-lang-key="edit">ÁºñËæëÁæ§ÊàêÂëò</span></div>
      <div class="modal-body">
        <div class="form-group"><label for="member-name-input">ÂêçÂ≠ó</label><input type="text" id="member-name-input"></div>
        <div class="form-group"><label for="member-persona-input">‰∫∫ËÆæ</label><textarea id="member-persona-input" rows="4"></textarea></div>
        <div class="form-group"><label>Â§¥ÂÉè</label>
          <div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><button class="change-frame-btn" data-type="member">Êõ¥Êç¢Â§¥ÂÉèÊ°Ü</button><input type="file" id="member-avatar-input" accept="image/*"></div>
        </div>
      </div>
      <div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn"data-lang-key="cancel">ÂèñÊ∂à</button><button class="save" id="save-member-settings-btn"data-lang-key="save">‰øùÂ≠ò</button></div>
    </div>
  </div>
  <div id="custom-modal-overlay">
    <div id="custom-modal">
      <div class="custom-modal-header" id="custom-modal-title"></div>
      <div class="custom-modal-body" id="custom-modal-body"></div>
      <div class="custom-modal-footer"> <button id="custom-modal-cancel"data-lang-key="cancel">ÂèñÊ∂à</button> <button id="custom-modal-confirm" class="confirm-btn"data-lang-key="confirm">Á°ÆÂÆö</button> </div>
    </div>
  </div>
  <div id="preset-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="preset-action-edit" data-lang-key="edit">ÁºñËæëÈ¢ÑËÆæ</button> <button id="preset-action-delete" class="btn-danger">Âà†Èô§È¢ÑËÆæ</button> <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"data-lang-key="cancel">ÂèñÊ∂à</button> </div>
    </div>
  </div>
  <div id="transfer-modal">
    <div class="transfer-content">
      <div class="transfer-header">ÁªôTa‰∏Ä‰∏™ÊÉäÂñúÔºÅ</div>
      <div class="transfer-input-group"> <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label> <input type="number" id="transfer-amount" placeholder="0.00" min="0" step="0.01"> </div>
      <div class="transfer-input-group"> <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label> <input type="text" id="transfer-note" placeholder="Áïô‰∏ã‰Ω†ÁöÑÂ∞èÂøÉÊÄù~" maxlength="20"> </div>
      <div class="transfer-actions"> <button id="transfer-cancel-btn" data-lang-key="cancel">ÂèñÊ∂à</button> <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button> </div>
    </div>
  </div>
  <div id="battery-alert-modal">
    <div class="battery-alert-content"> <img id="battery-alert-image" src="">
      <p id="battery-alert-text"></p>
    </div>
  </div>
  <div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
      <div class="modal-header"> <span>ÂèëËµ∑Â§ñÂçñËÆ¢Âçï</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="waimai-product-info">ÂïÜÂìÅ‰ø°ÊÅØ</label> <input type="text" id="waimai-product-info" placeholder="‰æãÂ¶ÇÔºö‰∏ÄÊùØÊù®ÊûùÁîòÈú≤"> </div>
        <div class="form-group"> <label for="waimai-amount">ËÆ¢ÂçïÈáëÈ¢ù (ÂÖÉ)</label> <input type="number" id="waimai-amount" placeholder="‰æãÂ¶ÇÔºö21" min="0" step="0.01"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="waimai-order-for-ai-btn">‰∏∫TAÁÇπÂçï</button> <button class="save" id="waimai-confirm-btn">ÂèëËµ∑ËØ∑Ê±Ç</button> </div>
    </div>
  </div>
  <div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
      <div class="modal-header"> <span>Êñ∞Âª∫Á∫¶ÂÆö</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="countdown-title-input">Á∫¶ÂÆöÊ†áÈ¢ò</label> <input type="text" id="countdown-title-input" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÁîüÊó•"> </div>
        <div class="form-group"> <label for="countdown-date-input">Á∫¶ÂÆöÊó•Êúü‰∏éÊó∂Èó¥</label> <input type="datetime-local" id="countdown-date-input"> </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-create-countdown-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="confirm-create-countdown-btn"data-lang-key="save">‰øùÂ≠òÁ∫¶ÂÆö</button> </div>
    </div>
  </div>
  <div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
      <div class="modal-header"> <span>ÂèëÁ∫¢ÂåÖ</span> </div>
      <div class="modal-body" style="padding: 0;">
        <div class="frame-tabs">
          <div id="rp-tab-group" class="frame-tab active">ÊãºÊâãÊ∞îÁ∫¢ÂåÖ</div>
          <div id="rp-tab-direct" class="frame-tab">‰∏ìÂ±ûÁ∫¢ÂåÖ</div>
        </div>
        <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
          <div class="form-group"> <label>ÊÄªÈáëÈ¢ù (ÂÖÉ)</label> <input type="number" id="rp-group-amount" placeholder="0.00"> </div>
          <div class="form-group"> <label>Á∫¢ÂåÖ‰∏™Êï∞</label> <input type="number" id="rp-group-count" placeholder="Â°´ÂÜôÁ∫¢ÂåÖ‰∏™Êï∞"> </div>
          <div class="form-group"> <label>Á•ùÁ¶èËØ≠</label> <input type="text" id="rp-group-greeting" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ"> </div>
          <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p> <button id="send-group-packet-btn" class="form-button">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
        </div>
        <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
          <div class="form-group"> <label>ÂèëÈÄÅÁªô</label> <select id="rp-direct-receiver"></select> </div>
          <div class="form-group"> <label>ÈáëÈ¢ù (ÂÖÉ)</label> <input type="number" id="rp-direct-amount" placeholder="0.00"> </div>
          <div class="form-group"> <label>Á•ùÁ¶èËØ≠</label> <input type="text" id="rp-direct-greeting" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ"> </div>
          <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p> <button id="send-direct-packet-btn" class="form-button">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: center;"> <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;"data-lang-key="cancel">ÂèñÊ∂à</button> </div>
    </div>
  </div>
  <div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
      <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
        <div style="text-align: center; width: 100%;">
          <div id="rp-details-sender" style="font-size: 16px;"></div>
          <div style="font-size: 13px; opacity: 0.8;">ÁöÑÁ∫¢ÂåÖ</div>
        </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
        <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;"> <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span> <span style="font-size: 18px; color: #E44D44;">ÂÖÉ</span> </div>
        <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
        <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-rp-details-btn" style="width: 100%;">ÂÖ≥Èó≠</button> </div>
    </div>
  </div>
  <div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
      <div class="modal-header"> <span>ÂèëËµ∑ÊäïÁ•®</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="poll-question-input">ÊäïÁ•®ÈóÆÈ¢ò</label> <textarea id="poll-question-input" rows="2" placeholder="‰æãÂ¶ÇÔºö‰ªäÊôöÊàë‰ª¨Áúã‰ªÄ‰πàÁîµÂΩ±Ôºü"></textarea> </div>
        <div class="form-group"> <label>ÊäïÁ•®ÈÄâÈ°π (Ëá≥Â∞ë2È°π)</label>
          <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;"> </div> <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ Ê∑ªÂä†ÈÄâÈ°π</button>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-create-poll-btn" data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="confirm-create-poll-btn">ÂèëËµ∑ÊäïÁ•®</button> </div>
    </div>
  </div>
  <div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="ai-avatar-library-title">ÂØπÊñπÁöÑÂ§¥ÂÉèÂ∫ì</span>
        <div class="header-actions"> <button id="add-ai-avatar-batch-btn" class="action-button">ÊâπÈáè</button> <button id="add-ai-avatar-url-btn" class="action-button">URL</button> <button id="add-ai-avatar-upload-btn" class="action-button">‰∏ä‰º†</button> </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">ÂÖ≥Èó≠</button> </div>
    </div>
  </div>
  <div id="my-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="my-avatar-library-title">ÊàëÁöÑÂ§¥ÂÉèÂ∫ì</span>
        <div class="header-actions"> <button id="add-my-avatar-batch-btn" class="action-button">ÊâπÈáè</button> <button id="add-my-avatar-url-btn" class="action-button">URL</button> <button id="add-my-avatar-upload-btn" class="action-button">‰∏ä‰º†</button> </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <div id="my-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-my-avatar-library-btn" style="width: 100%;">ÂÖ≥Èó≠</button> </div>
    </div>
  </div>
  <div id="group-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="group-avatar-library-title">Áæ§Â§¥ÂÉèÂ∫ì</span>
        <div class="header-actions"> <button id="add-group-avatar-batch-btn" class="action-button">ÊâπÈáè</button> <button id="add-group-avatar-url-btn" class="action-button">URL</button> <button id="add-group-avatar-upload-btn" class="action-button">‰∏ä‰º†</button> </div>
      </div>
      <div class="modal-body" style="padding: 15px;">
        <div id="group-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-group-avatar-library-btn" style="width: 100%;">ÂÖ≥Èó≠</button> </div>
    </div>
  </div>
  <div id="chat-list-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="chat-list-action-pin"></button> <button id="chat-list-action-delete" class="btn-danger">Âà†Èô§ËÅäÂ§©</button> <button id="chat-list-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"data-lang-key="cancel">ÂèñÊ∂à</button> </div>
    </div>
  </div>
  <div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
      <div class="modal-header"> <span>ÂàÜ‰∫´ÈìæÊé•</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label for="link-title-input">Ê†áÈ¢ò</label> <input type="text" id="link-title-input" placeholder="ËæìÂÖ•ÊñáÁ´†ÊàñÈìæÊé•ÁöÑÊ†áÈ¢ò"> </div>
        <div class="form-group"> <label for="link-description-input">ÊëòË¶Å (ÂèØÈÄâ)</label> <textarea id="link-description-input" rows="2" placeholder="ÁÆÄÂçïÊèèËø∞‰∏Ä‰∏ãÈìæÊé•ÂÜÖÂÆπ"></textarea> </div>
        <div class="form-group"> <label for="link-source-input">Êù•Ê∫êÂêçÁß∞ (ÂèØÈÄâ)</label> <input type="text" id="link-source-input" placeholder="‰æãÂ¶ÇÔºöÁü•‰πéÊó•Êä•„ÄÅBÁ´ô"> </div>
        <div class="form-group"> <label for="link-content-input">ÂÆåÊï¥ÂÜÖÂÆπ (ÂèØÈÄâÔºåÁî®‰∫éÊµèËßàÂô®ÂÜÖÊòæÁ§∫)</label> <textarea id="link-content-input" rows="4" placeholder="Á≤òË¥¥ÊàñËæìÂÖ•ÂÆåÊï¥ÁöÑÊñáÁ´†ÂÜÖÂÆπ"></textarea> </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-share-link-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="confirm-share-link-btn">ÂàÜ‰∫´</button> </div>
    </div>
  </div>
  <div id="transfer-actions-modal" class="modal">
    <div class="transfer-actions-content">
      <div class="transfer-actions-header">ËØ∑ÈÄâÊã©Êìç‰Ωú</div>
      <div class="transfer-actions-body">
        <p>‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™ <strong id="transfer-sender-name"></strong> ÁöÑ‰∏ÄÁ¨îËΩ¨Ë¥¶„ÄÇ</p>
      </div>
      <div class="transfer-actions-footer"> <button id="transfer-action-decline" class="action-btn decline">ÊÆãÂøçÊãíÁªù</button> <button id="transfer-action-accept" class="action-btn accept">ÂºÄÂøÉÊî∂‰∏ã</button> </div> <button id="transfer-action-cancel" class="cancel-btn">√ó</button>
    </div>
  </div>
  <div id="call-transcript-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span id="transcript-modal-title">ÈÄöËØùËØ¶ÊÉÖ</span> </div>
      <div class="modal-body" id="call-transcript-modal-body" style="background-color: #f0f2f5;"> </div>
      <div class="modal-footer"> <button class="cancel" id="delete-transcript-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">Âà†Èô§ËÆ∞ÂΩï</button> <button class="save" id="manual-summarize-btn" style="background-color: #ffc107; border-color: #ffc107;">ÊâãÂä®ÊÄªÁªì</button>
        <button class="save" id="close-call-transcript-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
  <div id="share-target-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>ÂàÜ‰∫´Âà∞...</span> </div>
      <div class="modal-body" id="share-target-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-share-target-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="confirm-share-target-btn">Á°ÆËÆ§ÂàÜ‰∫´</button> </div>
    </div>
  </div>
  <div id="shared-history-viewer-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
      <div class="modal-header"> <span id="shared-history-viewer-title">ËÅäÂ§©ËÆ∞ÂΩï</span> </div>
      <div class="modal-body" id="shared-history-viewer-content" style="background-color: #f0f2f5;"> </div>
      <div class="modal-footer"> <button class="save" id="close-shared-history-viewer-btn" style="width:100%;">ÂÖ≥Èó≠</button> </div>
    </div>
  </div>
  <div id="world-book-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
      <div class="modal-header"> <span>ÁÆ°ÁêÜ‰∏ñÁïå‰π¶ÂàÜÁ±ª</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label>Êñ∞Âª∫ÂàÜÁ±ª</label>
          <div style="display: flex; gap: 10px;"> <input type="text" id="new-category-name-input" placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêç..." style="flex-grow: 1;"> <button id="add-new-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;"data-lang-key="add">Ê∑ªÂä†</button> </div>
        </div>
        <hr style="opacity: 0.2;">
        <div id="existing-categories-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-category-manager-btn" style="width: 100%;"data-lang-key="done">ÂÆåÊàê</button> </div>
    </div>
  </div>
  <div id="announcement-board-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>Áæ§ÂÖ¨ÂëäÊùø</span> </div>
      <div id="announcement-board-content"> </div>
      <div class="modal-footer"> <button class="save" id="close-announcement-board-btn" style="width: 100%;">ÂÖ≥Èó≠</button> </div>
    </div>
  </div>
  <div id="announcement-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="announcement-action-pin">ÁΩÆÈ°∂ÂÖ¨Âëä</button> <button id="announcement-action-delete" class="btn-danger">Âà†Èô§ÂÖ¨Âëä</button> <button id="announcement-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"data-lang-key="cancel">ÂèñÊ∂à</button> </div>
    </div>
  </div>
  <div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
      <div class="modal-header"> <span>ÁÆ°ÁêÜÂ•ΩÂèãÂàÜÁªÑ</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label>Êñ∞Âª∫ÂàÜÁªÑ</label>
          <div style="display: flex; gap: 10px;"> <input type="text" id="new-group-name-input" placeholder="ËæìÂÖ•ÂàÜÁªÑÂêç..." style="flex-grow: 1;"> <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;"data-lang-key="add">Ê∑ªÂä†</button> </div>
        </div>
        <hr style="opacity: 0.2;">
        <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-group-manager-btn" style="width: 100%;"data-lang-key="done">ÂÆåÊàê</button> </div>
    </div>
  </div>
  <div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="edit-message-btn" data-lang-key="edit">ÁºñËæëÊ∂àÊÅØ</button> <button id="copy-message-btn">Â§çÂà∂ÊñáÊú¨</button> <button id="copy-timestamp-btn">Â§çÂà∂Êó∂Èó¥Êà≥</button> <button id="recall-message-btn">Êí§Âõû</button> <button id="publish-to-announcement-btn" style="display: none;">ÂèëÂ∏ÉÂà∞ÂÖ¨ÂëäÊùø</button>
        <button id="quote-message-btn">ÂºïÁî®</button> <button id="select-message-btn">ËøõÂÖ•Â§öÈÄâ</button> <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"data-lang-key="cancel">ÂèñÊ∂à</button> </div>
    </div>
  </div>
  <div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="edit-post-btn" data-lang-key="edit">ÁºñËæëÂä®ÊÄÅ</button> <button id="copy-post-btn">Â§çÂà∂ÂÜÖÂÆπ</button> <button id="cancel-post-action-btn"data-lang-key="cancel">ÂèñÊ∂à</button> </div>
    </div>
  </div>
  <div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
      <div class="modal-header"> <span data-lang-key="edit">ÁºñËæë‰∏éÊãÜÂàÜÊ∂àÊÅØ</span> </div>
      <div class="modal-body" id="message-editor-body">
        <div id="message-editor-container"></div> <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] Ê∑ªÂä†‰∏ã‰∏ÄÊù°Ê∂àÊÅØ </button>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-advanced-editor-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-advanced-editor-btn"data-lang-key="save">‰øùÂ≠òÊõ¥Êîπ</button> </div>
    </div>
  </div>
  <div id="ai-response-editor-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
      <div class="modal-header"> <span>ÂØºÊºîÂâ™ËæëÂÆ§ (AI‰∏ä‰∏ÄËΩÆÂìçÂ∫î)</span> </div>
      <div class="modal-body" id="ai-response-editor-body">
        <div id="ai-response-editor-container" style="display: flex; flex-direction: column; gap: 15px;"></div> <button id="add-ai-response-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;"> [+] Ê∑ªÂä†‰∏Ä‰∏™Êñ∞Âä®‰Ωú </button>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-ai-response-editor-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-ai-response-editor-btn">Â∫îÁî®‰øÆÊîπ</button> </div>
    </div>
  </div>
  <div id="repost-modal" class="modal">
    <div id="custom-modal" style="width: 280px;">
      <div class="custom-modal-header">ËΩ¨ÂèëÂä®ÊÄÅ</div>
      <div class="custom-modal-body"> <textarea id="repost-comment-input" placeholder="ËØ∑ËæìÂÖ•ËΩ¨ÂèëËØÑËÆ∫ (ÂèØÈÄâ)" style="width: 100%; min-height: 60px; resize: vertical; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 16px; box-sizing: border-box;"></textarea> </div>
      <div class="custom-modal-footer"> <button id="repost-cancel-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button id="repost-confirm-btn" class="confirm-btn"data-lang-key="confirm">Á°ÆÂÆö</button> </div>
    </div>
  </div>
  <div id="call-message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
      <div class="custom-modal-footer"> <button id="edit-call-message-btn"data-lang-key="edit">ÁºñËæë</button> <button id="delete-call-message-btn" class="btn-danger">Âà†Èô§</button> <button id="cancel-call-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;"data-lang-key="cancel">ÂèñÊ∂à</button> </div>
    </div>
  </div> <audio id="audio-player" style="display:none;"></audio>
  <div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
      <div class="modal-header"> <span>ÂèëÂ∏ÉÂä®ÊÄÅ</span> </div>
      <div class="modal-body">
        <div class="form-group"> <textarea id="post-public-text" rows="3" placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ"></textarea> </div>
        <div class="post-mode-switcher"> <button id="switch-to-image-mode" class="mode-btn active">‰∏ä‰º†ÂõæÁâá</button> <button id="switch-to-text-image-mode" class="mode-btn">‰ΩøÁî®ÊñáÂ≠óÂõæ</button> </div>
        <div class="form-group"> <label>ÂèØËßÅËåÉÂõ¥</label>
          <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;"> <label><input type="radio" name="visibility" value="public" checked> ÂÖ¨ÂºÄ</label> <label><input type="radio" name="visibility" value="include"> ÊåáÂÆöÂàÜÁªÑÂèØËßÅ</label> </div>
          <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;"> </div>
        </div>
        <div id="image-mode-content" class="post-mode-content active">
          <div class="form-group">
            <div id="post-image-preview-container" class="post-image-preview-container"> <img id="post-image-preview" src="" alt="ÂõæÁâáÈ¢ÑËßà"> <button id="post-remove-image-btn">√ó</button> </div>
            <div class="post-image-upload-options"> <button id="post-upload-local-btn" class="form-button-secondary">Êú¨Âú∞‰∏ä‰º†</button> <button id="post-use-url-btn" class="form-button-secondary">ÁΩëÁªúURL</button> <input type="file" id="post-local-image-input" accept="image/*" hidden> </div>
          </div>
          <div id="post-image-desc-group" class="form-group" style="display: none;"> <label>ÂõæÁâáÊèèËø∞ (ÂøÖÂ°´ÔºåÁªôAIÁúã)</label> <input type="text" id="post-image-description" placeholder="ÁÆÄÂçïÊèèËø∞ÂõæÁâáÂÜÖÂÆπÔºåÂ∏ÆÂä©AIÁêÜËß£"> </div>
        </div>
        <div id="text-image-mode-content" class="post-mode-content">
          <div class="form-group"> <label>ÊñáÂ≠óÂõæ (ÁªôAIÁêÜËß£Áî®ÁöÑÊèèËø∞ÔºåÁÇπÂáªÂõæÁâáÂêéÂèØËßÅ)</label> <textarea id="post-hidden-text" rows="4" placeholder="Âú®ËøôÈáåÂÜô‰∏ãÂõæÁâáÊèèËø∞..."></textarea> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-create-post-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="confirm-create-post-btn">ÂèëÂ∏É</button> </div>
    </div>
  </div> <input type="file" id="ai-avatar-upload-input" accept="image/*" hidden> <input type="file" id="group-avatar-upload-input" accept="image/*" hidden>
  <div id="qzone-sticker-panel">
    <div id="qzone-sticker-grid"></div>
  </div>
  <div id="avatar-frame-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>ÈÄâÊã©Â§¥ÂÉèÊ°Ü</span>
        <div class="header-actions"> <button id="manage-frames-btn" class="action-button">ÁÆ°ÁêÜ</button> <button id="upload-custom-frame-btn" class="action-button">‰∏ä‰º†</button> <button id="batch-import-frames-btn" class="action-button">ÊâπÈáè</button> </div>
      </div>
      <div class="modal-body">
        <div class="frame-tabs">
          <div id="ai-frame-tab" class="frame-tab active">ÂØπÊñπÁöÑ</div>
          <div id="my-frame-tab" class="frame-tab">ÊàëÁöÑ</div>
        </div>
        <div id="ai-frame-content" class="frame-content">
          <div id="ai-frame-grid" class="frame-grid"> </div>
        </div>
        <div id="my-frame-content" class="frame-content" style="display: none;">
          <div id="my-frame-grid" class="frame-grid"> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-frame-settings-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-frame-settings-btn"data-lang-key="save">‰øùÂ≠ò</button> </div>
      <div id="frame-action-bar" style="display: none;"> <label class="select-all-label" style="display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-frames-checkbox"> ÂÖ®ÈÄâ </label> <button id="delete-selected-frames-btn" class="action-bar-btn">Âà†Èô§ (0)</button>
      </div>
    </div>
  </div><input type="file" id="custom-frame-upload-input" accept="image/*" hidden>
  <div id="character-profile-modal" class="modal">
    <div class="character-profile-content"> <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10;">
        <button id="profile-edit-btn" title="ÁºñËæëÂΩìÂâçÂøÉÂ£∞" class="profile-history-icon-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        </button>
        <button id="profile-history-icon-btn" title="Êü•ÁúãÂéÜÂè≤ÂøÉÂ£∞" class="profile-history-icon-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
          </svg>
        </button>
      </div>
      <div id="profile-main-content">
        <div id="profile-timestamp" class="thought-header"></div>
        <div class="thought-content">
          <div class="voice">
            <div class="label"> <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
              </svg> ÂøÉÂ£∞ </div>
            <p id="profile-heartfelt-voice" class="text"></p>
          </div>
          <div class="jottings">
            <div class="label"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                <path d="M2 2l7.586 7.586"></path>
              </svg> Êï£ËÆ∞ </div>
            <p id="profile-random-jottings" class="text"></p>
          </div>
        </div>
      </div>
      <div id="profile-thoughts-history-view">
        <div class="profile-header"> <span>ÂøÉÂ£∞ËÆ∞ÂΩï</span> <button id="history-back-btn" title="ËøîÂõû"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg> </button> </div>
        <div id="thoughts-history-list"></div>
      </div>
    </div>
  </div> <input type="file" id="my-avatar-upload-input" accept="image/*" hidden>
  <div id="gift-recipient-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>ÈÄâÊã©Êî∂Á§º‰∫∫</span> <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-recipients"> ÂÖ®ÈÄâ </label> </div>
      <div class="modal-body" id="gift-recipient-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-gift-recipient-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="confirm-gift-recipient-btn">Á°ÆËÆ§ÈÄÅÂá∫</button> </div>
    </div>
  </div> <audio id="notification-sound-player" preload="auto"></audio>
  <div id="music-search-results-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>ÊêúÁ¥¢ÁªìÊûú</span> <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-music-search"> ÂÖ®ÈÄâ </label> </div>
      <div class="modal-body" id="search-results-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-music-search-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="add-selected-music-btn"data-lang-key="add">Ê∑ªÂä†ÈÄâ‰∏≠</button> </div>
    </div>
  </div>
  <div id="douban-settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>Ë±ÜÁì£ËÆæÁΩÆ</span> </div>
      <div class="modal-body">
        <div class="form-group douban-settings-item"> <label for="douban-min-posts-input"> ÊØèÊ¨°ÁîüÊàêÂ∏ñÂ≠êÊï∞ËåÉÂõ¥ <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> ËÆæÁΩÆAIÂú®Ë±ÜÁì£È°µÈù¢‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ∏ñÂ≠êÁöÑÊúÄÂ∞èÂíåÊúÄÂ§ßÊï∞Èáè„ÄÇ </p> </label>
          <div class="douban-settings-controls"> <input type="number" id="douban-min-posts-input" min="1" value="12"> <span>Âà∞</span> <input type="number" id="douban-max-posts-input" min="1" value="20"> <span>ÁØá</span> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-douban-settings-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-douban-settings-btn"data-lang-key="save">‰øùÂ≠ò</button> </div>
    </div>
  </div><audio id="char-audio-player" preload="auto"></audio>
  <div id="douban-cast-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>ÈÄâÊã©ÂèÇ‰∏éË±ÜÁì£ÁöÑËßíËâ≤</span> </div>
      <div class="modal-body" id="douban-cast-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-douban-cast-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-douban-cast-btn"data-lang-key="save">‰øùÂ≠òÂπ∂Âà∑Êñ∞</button> </div>
    </div>
  </div><input type="file" id="import-preset-input" accept=".json" hidden>
  <div id="update-notice-modal">
    <div class="update-notice-content">
      <div class="update-notice-body" id="update-notice-body"> </div>
      <div class="update-notice-footer"> <button id="update-notice-confirm-btn">ÊàëÁü•ÈÅì‰∫Ü</button> <button id="update-notice-dismiss-btn">‰∏çÂÜçÊèêÁ§∫</button> </div>
    </div>
  </div>
  <div id="delete-world-books-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑ‰∏ñÁïå‰π¶</span> <label style="font-size: 14px; font-weight: normal; display: flex; align-items: center; gap: 5px;"> <input type="checkbox" id="select-all-world-books-for-clear"> ÂÖ®ÈÄâ </label> </div>
      <div class="modal-body" id="delete-world-books-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-delete-world-books-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save btn-danger" id="confirm-delete-world-books-btn">Á°ÆËÆ§Âà†Èô§</button> </div>
    </div>
  </div>
  <div id="werewolf-kill-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>Áãº‰∫∫ËØ∑ÈÄâÊã©ÂàÄ‰∫∫ÂØπË±°</span></div>
      <div class="modal-body" id="werewolf-kill-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="cancel" id="cancel-wolf-kill-btn">ÊîæÂºÉ</button> <button class="save btn-danger" id="confirm-wolf-kill-btn">Á°ÆËÆ§ÂàÄ‰∫∫</button> </div>
    </div>
  </div>
  <div id="werewolf-lobby-modal" class="modal">
    <div class="modal-content" style="height: 80%;">
      <div class="modal-header"> <span>ÈÄâÊã©Áé©ÂÆ∂ÂºÄÂßãÁãº‰∫∫ÊùÄ</span> </div>
      <div class="modal-body" id="werewolf-player-selection-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-werewolf-lobby-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="start-werewolf-game-btn">ÂºÄÂßãÊ∏∏Êàè</button> </div>
    </div>
  </div>
  <div id="werewolf-role-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; text-align: center; padding: 20px;">
      <h3 id="werewolf-role-title" style="margin-top: 0;">‰Ω†ÁöÑË∫´‰ªΩÊòØ</h3>
      <div id="werewolf-role-card" style="margin: 15px 0;">
        <h2 id="werewolf-role-name" style="margin: 0 0 10px 0;"></h2>
        <p id="werewolf-role-description" style="font-size: 14px; line-height: 1.6; color: #555; margin: 0;"></p>
      </div> <button id="werewolf-role-confirm-btn" class="form-button">ÊàëÂáÜÂ§áÂ•Ω‰∫Ü</button>
    </div>
  </div>
  <div id="werewolf-prophet-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>È¢ÑË®ÄÂÆ∂ËØ∑ÈÄâÊã©Êü•È™åÂØπË±°</span></div>
      <div class="modal-body" id="werewolf-prophet-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-prophet-check-btn">Á°ÆËÆ§Êü•È™å</button> </div>
    </div>
  </div>
  <div id="werewolf-hunter-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>Áåé‰∫∫ËØ∑ÈÄâÊã©ÂºÄÊû™ÂØπË±°</span></div>
      <div class="modal-body" id="werewolf-hunter-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save btn-danger" id="confirm-hunter-shot-btn">Á°ÆËÆ§ÂºÄÊû™</button> </div>
    </div>
  </div>
  <div id="werewolf-vote-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>ËØ∑ÊäïÁ•®ÊîæÈÄê‰∏ÄÂêçÁé©ÂÆ∂</span></div>
      <div class="modal-body" id="werewolf-vote-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-vote-btn">Á°ÆËÆ§ÊäïÁ•®</button> </div>
    </div>
  </div>
  <div id="werewolf-guard-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>ÂÆàÂç´ËØ∑ÈÄâÊã©‰ªäÊôöË¶ÅÂÆàÊä§ÁöÑÁé©ÂÆ∂</span></div>
      <div class="modal-body" id="werewolf-guard-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-guard-selection-btn">Á°ÆËÆ§ÂÆàÊä§</button> </div>
    </div>
  </div>
  <div id="werewolf-witch-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span id="witch-modal-title">Â•≥Â∑´ËØ∑ÁùÅÁúº</span></div>
      <div class="modal-body" id="werewolf-witch-selection-list" style="padding: 0;"> </div>
      <div class="modal-footer"> <button class="cancel" id="witch-do-nothing-btn">‰ªÄ‰πàÈÉΩ‰∏çÂÅö</button> <button class="save btn-danger" id="confirm-witch-poison-btn" style="display: none;">Á°ÆËÆ§Áî®ÊØí</button> </div>
    </div>
  </div>
  <div id="werewolf-hunter-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>Áåé‰∫∫ËØ∑ÈÄâÊã©ÂºÄÊû™ÂØπË±°</span></div>
      <div class="modal-body" id="werewolf-hunter-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save btn-danger" id="confirm-hunter-shot-btn">Á°ÆËÆ§ÂºÄÊû™</button> </div>
    </div>
  </div>
  <div id="werewolf-vote-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"><span>ËØ∑ÊäïÁ•®ÊîæÈÄê‰∏ÄÂêçÁé©ÂÆ∂</span></div>
      <div class="modal-body" id="werewolf-vote-selection-list" style="padding: 0;"></div>
      <div class="modal-footer"> <button class="save" id="confirm-vote-btn">Á°ÆËÆ§ÊäïÁ•®</button> </div>
    </div>
  </div>
  <div id="werewolf-game-over-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto; text-align: center; padding: 20px;">
      <h2 id="werewolf-game-over-title">Ê∏∏ÊàèÁªìÊùü</h2>
      <p id="werewolf-game-over-reason" style="font-size: 16px; margin: 20px 0;"></p>
      <div id="werewolf-role-reveal-list" style="max-height: 250px; overflow-y: auto; margin: 20px 0; border-top: 1px solid #444; padding-top: 10px;"> </div> <button id="werewolf-game-over-close-btn" class="form-button">ËøîÂõûÂ§ßÂéÖ</button> <button id="manual-werewolf-summary-btn"
        class="form-button form-button-secondary" style="margin-top: 10px;">ÊâãÂä®ÊÄªÁªìËÆ∞ÂøÜ</button>
    </div>
  </div>
  <div id="reading-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header"> <span>ÊàëÁöÑ‰π¶Â∫ì</span>
        <div class="header-actions"> <span class="action-btn" id="import-new-book-btn-header" title="ÂØºÂÖ•Êñ∞‰π¶"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg> </span> <span class="action-btn" id="close-reading-library-btn-header" title="ÂÖ≥Èó≠"> <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg> </span> </div>
      </div>
      <div id="reading-library-search-container"> <input type="search" id="reading-library-search-input" placeholder="ÊêúÁ¥¢‰π¶Âêç..."> </div>
      <div class="modal-body" style="padding: 0; flex-grow: 1; overflow-y: auto;">
        <div id="reading-library-list"> </div>
      </div>
    </div>
  </div>
  <div id="product-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
      <div class="modal-header"> <span>ÁÆ°ÁêÜÂïÜÂìÅÂàÜÁ±ª</span> </div>
      <div class="modal-body">
        <div class="form-group"> <label>Êñ∞Âª∫ÂàÜÁ±ª</label>
          <div style="display: flex; gap: 10px;"> <input type="text" id="new-product-category-name-input" placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêç..." style="flex-grow: 1;"> <button id="add-new-product-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;"data-lang-key="add">Ê∑ªÂä†</button> </div>
        </div>
        <hr style="opacity: 0.2;">
        <div id="existing-product-categories-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
      </div>
      <div class="modal-footer"> <button class="save" id="close-product-category-manager-btn" style="width: 100%;"data-lang-key="done">ÂÆåÊàê</button> </div>
    </div>
  </div>
  <div id="variation-selection-modal" class="modal">
    <div class="modal-content" style="width: 320px; height: auto;">
      <div class="modal-header" style="padding-bottom: 0;"> </div>
      <div class="modal-body">
        <div id="variation-product-info" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 15px;"> <img id="variation-product-image" style="width: 80px; height: 80px; border-radius: 6px; object-fit: cover;">
          <div>
            <p id="variation-product-name" style="font-weight: 500; margin: 0;"></p>
            <p id="variation-selected-price" style="color: #ff5722; font-weight: bold; font-size: 18px; margin: 8px 0 0;"></p>
          </div>
        </div>
        <div class="form-group"> <label>ÈÄâÊã©Ê¨æÂºè</label>
          <div id="variation-options-container" style="display: flex; flex-wrap: wrap; gap: 8px;"> </div>
        </div>
        <div class="form-group"> <label>Ë¥≠‰π∞Êï∞Èáè</label>
          <div class="quantity-control" style="justify-content: flex-start;"> <button class="quantity-btn" id="variation-decrease-qty">-</button> <span class="quantity-display" id="variation-quantity-display">1</span> <button class="quantity-btn" id="variation-increase-qty">+</button>
          </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-variation-selection-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="confirm-variation-selection-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button> </div>
    </div>
  </div>
  <div id="shopping-settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header"> <span>Ë¥≠Áâ©‰∏≠ÂøÉÁîüÊàêËÆæÁΩÆ</span> </div>
      <div class="modal-body">
        <div class="form-group douban-settings-item"> <label for="shopping-category-count-input"> ÁîüÊàêÂàÜÁ±ªÊï∞Èáè <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> ËÆæÁΩÆAI‰∏ÄÊ¨°ÊÄßÁîüÊàêÂ§öÂ∞ë‰∏™ÂïÜÂìÅÂàÜÁ±ª„ÄÇ </p> </label>
          <div class="douban-settings-controls"> <input type="number" id="shopping-category-count-input" min="1" max="10" value="3"> <span>‰∏™</span> </div>
        </div>
        <div class="form-group douban-settings-item"> <label for="shopping-product-count-input"> ÊØè‰∏™ÂàÜÁ±ªÂïÜÂìÅÊï∞Èáè <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;"> ËÆæÁΩÆÊØè‰∏™ÂàÜÁ±ª‰∏ãÁîüÊàêÂ§öÂ∞ë‰∏™ÂïÜÂìÅ„ÄÇ </p> </label>
          <div class="douban-settings-controls"> <input type="number" id="shopping-product-count-input" min="2" max="10" value="8"> <span>‰∏™</span> </div>
        </div>
      </div>
      <div class="modal-footer"> <button class="cancel" id="cancel-shopping-settings-btn"data-lang-key="cancel">ÂèñÊ∂à</button> <button class="save" id="save-shopping-settings-btn"data-lang-key="save">‰øùÂ≠ò</button> </div>
    </div>
  </div>
  <div id="sticker-binding-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
      <div class="modal-header">
        <span>ÁªëÂÆöÂàÜÁ±ªÂà∞ËÅäÂ§©</span>
      </div>
      <div class="modal-body" id="sticker-binding-chat-list" style="padding: 0;">
        <!-- ËÅäÂ§©ÂàóË°®Â∞ÜÂú®Ê≠§Â§ÑÂä®ÊÄÅÊ∏≤Êüì -->
      </div>
      <div class="modal-footer">
        <button class="cancel" id="cancel-sticker-binding-btn"data-lang-key="cancel">ÂèñÊ∂à</button>
        <button class="save" id="save-sticker-binding-btn"data-lang-key="save">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>
<!-- ‚ñº‚ñº‚ñº NovelAI ÁîüÊàêËÆæÁΩÆÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div id="novelai-settings-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
        <div class="modal-header">
            <span>NovelAI ÁîüÊàêËÆæÁΩÆ</span>
            <span class="close" id="close-novelai-settings" style="cursor: pointer; float: right; font-size: 28px; font-weight: bold;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
           <div class="settings-section" style="background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
    <div style="font-weight: 600; margin-bottom: 10px; color: #333;">üé® È£éÊ†ºÈ¢ÑËÆæ‰∏éÁªëÂÆö</div>
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <select id="nai-preset-select" class="settings-select" style="flex-grow: 1; border: 1px solid #ccc; padding: 8px; border-radius: 6px;">
            <option value="">-- ÂΩìÂâç‰∏¥Êó∂ËÆæÁΩÆ --</option>
        </select>
    </div>
    
    <div style="display: flex; gap: 8px; align-items: center; justify-content: flex-end;">
    <button id="save-nai-preset-btn" class="settings-mini-btn">Êñ∞Â¢û</button>
    
    <button id="update-nai-preset-btn" class="settings-mini-btn" style="display:none;">Êõ¥Êñ∞</button>
    
    <button id="bind-nai-preset-btn" class="settings-mini-btn" style="display:none; background-color: #e3f2fd; color: #1976d2; border-color: #bbdefb;">üîóÁªëÂÆö</button>
    
    <button id="delete-nai-preset-btn" class="settings-mini-btn" style="color: #ff3b30; border-color: #ff3b30; display:none;">Âà†Èô§</button>
</div>
    
    <p style="font-size: 12px; color: #888; margin-top: 8px; margin-bottom: 0;">* ÁªëÂÆöÂêéÔºåËØ•ËßíËâ≤ÁîüÂõæÊó∂Â∞ÜÂº∫Âà∂‰ΩøÁî®Ê≠§È¢ÑËÆæ„ÄÇ</p>
</div>
            <div class="form-group">
                <label style="color: #333;">ÂõæÂÉèÂ∞∫ÂØ∏ÔºàoplusÂèØÊó†ÈôêÂá∫Â∞èÂõæÔºâ</label>
                <select id="nai-resolution" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <optgroup label="Â∞è">
                        <option value="512x768">Á∫µÂêë (512x768)</option>
                        <option value="768x512">Ê®™Âêë (768x512)</option>
                        <option value="640x640">Ê≠£ÊñπÂΩ¢ (640x640)</option>
                    </optgroup>
                    <optgroup label="Ê≠£Â∏∏">
                        <option value="832x1216">Á´ñÂõæ (832x1216)</option>
                        <option value="1216x832">Ê®™Âõæ (1216x832)</option>
                        <option value="1024x1024" selected>ÊñπÂõæ (1024x1024)</option>
                    </optgroup>
                    <optgroup label="Â£ÅÁ∫∏">
                        <option value="1088x1920">Á∫µÂêë (1088x1920)</option>
                        <option value="1920x1088">È£éÊôØ (1920x1088)</option>
                    </optgroup>
                </select>
                <small style="color: #666;">Âª∫ËÆÆ‰ΩøÁî®ÂÆòÊñπÊîØÊåÅÁöÑÊ†áÂáÜÂ∞∫ÂØ∏‰ª•Ëé∑ÂæóÊúÄ‰Ω≥ÊïàÊûú</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">ÈááÊ†∑Ê≠•Êï∞ (Steps)</label>
                <input type="number" id="nai-steps" value="28" min="1" max="50" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">Êé®ËçêÂÄº: 28 (ÂÄºË∂äÈ´òË¥®ÈáèË∂äÂ•Ω‰ΩÜËÄóÊó∂Ë∂äÈïø)</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">ÊèêÁ§∫ËØçÁõ∏ÂÖ≥ÊÄß (CFG Scale)</label>
                <input type="number" id="nai-cfg-scale" value="5" min="1" max="20" step="0.5" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">Êé®ËçêÂÄº: 5 (ÊéßÂà∂ÂõæÂÉè‰∏éÊèêÁ§∫ËØçÁöÑÁõ∏ÂÖ≥Á®ãÂ∫¶)</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">ÈááÊ†∑Âô® (Sampler)</label>
                <select id="nai-sampler" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <option value="k_euler">Euler</option>
                    <option value="k_euler_ancestral" selected>Euler Ancestral</option>
                    <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                    <option value="k_dpmpp_2m">DPM++ 2M</option>
                    <option value="k_dpmpp_sde">DPM++ SDE</option>
                    <option value="ddim">DDIM</option>
                </select>
            </div>

            <div class="form-group">
                <label style="color: #333;">ÈöèÊú∫ÁßçÂ≠ê (Seed)</label>
                <input type="number" id="nai-seed" value="-1" min="-1" max="9999999999" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">-1 Ë°®Á§∫ÈöèÊú∫ÔºåÂõ∫ÂÆöÁßçÂ≠êÂèØÂ§çÁé∞Áõ∏ÂêåÂõæÂÉè</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">Ë¥üÈù¢ÊèêÁ§∫ËØçÈ¢ÑËÆæ (UC Preset)</label>
                <select id="nai-uc-preset" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <option value="0">Preset 0 - Heavy</option>
                    <option value="1" selected>Preset 1 - Light</option>
                    <option value="2">Preset 2 - Human Focus</option>
                    <option value="3">Preset 3 - None</option>
                </select>
            </div>

            <div class="form-group">
                <label style="color: #333;">Ë¥®ÈáèÊ†áÁ≠æ</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-quality-toggle" checked style="width: auto;">
                    <span style="color: #666; font-size: 14px;">Ëá™Âä®Ê∑ªÂä†Ë¥®ÈáèÊèêÂçáÊ†áÁ≠æ</span>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #333;">SMEA (ÊèêÂçáÁªÜËäÇ)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-smea" checked style="width: auto;">
                    <span style="color: #666; font-size: 14px;">ÂêØÁî®SMEAÂ¢ûÂº∫</span>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #333;">SMEA DYN (Âä®ÊÄÅ‰ºòÂåñ)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="nai-smea-dyn" style="width: auto;">
                    <span style="color: #666; font-size: 14px;">ÂêØÁî®Âä®ÊÄÅSMEA</span>
                </div>
            </div>

            <div class="form-group">
                <label style="color: #333;">ÈªòËÆ§Ê≠£Èù¢ÊèêÁ§∫ËØç</label>
                <textarea id="nai-default-positive" rows="3" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="masterpiece, best quality, 1girl, beautiful...">masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style</textarea>
                <small style="color: #666;">Ê≠§ÊèêÁ§∫ËØçÂ∞ÜÂú®ÁîüÊàêÊó∂Ëá™Âä®‰ΩøÁî®ÔºàÂ¶ÇÊûúÊµãËØïÂºπÁ™ó‰∏≠Êú™Â°´ÂÜôÔºâ</small>
            </div>

            <div class="form-group">
                <label style="color: #333;">ÈªòËÆ§Ë¥üÈù¢ÊèêÁ§∫ËØç</label>
                <textarea id="nai-default-negative" rows="3" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="lowres, bad anatomy, bad hands, text, error...">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
            </div>

            <div class="form-group" style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                <label style="color: #333;">üåê CORS ‰ª£ÁêÜËÆæÁΩÆ</label>
                <select id="nai-cors-proxy" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                    <option value="">‚ùå Áõ¥ËøûÔºàÊó†‰ª£ÁêÜÔºâ</option>
                    <option value="https://corsproxy.io/?" selected>‚úÖ corsproxy.ioÔºàÊé®ËçêÔºâ</option>
                    <option value="https://api.allorigins.win/raw?url=">allorigins.win</option>
                    <option value="https://cors-anywhere.herokuapp.com/">cors-anywhereÔºàÈúÄÊøÄÊ¥ªÔºâ</option>
                    <option value="custom">üîß Ëá™ÂÆö‰πâ‰ª£ÁêÜ</option>
                </select>
                <small style="color: #e74c3c; display: block; margin-top: 8px;">
                    ‚ö†Ô∏è Êú¨Âú∞ËøêË°å‰ºöÈÅáÂà∞CORSË∑®ÂüüÈóÆÈ¢òÔºåÈúÄ‰ΩøÁî®‰ª£ÁêÜ„ÄÇÊé®Ëçê‰ΩøÁî® corsproxy.io
                </small>
            </div>

            <div id="nai-custom-proxy-group" class="form-group" style="display: none;">
                <label style="color: #333;">Ëá™ÂÆö‰πâ‰ª£ÁêÜÂú∞ÂùÄ</label>
                <input type="text" id="nai-custom-proxy-url" placeholder="https://your-proxy.com/?" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 8px; width: 100%; border-radius: 4px;">
                <small style="color: #666;">‰ª£ÁêÜURLÂ∫î‰ª• / Êàñ ? ÁªìÂ∞æÔºå‰æãÂ¶ÇÔºöhttps://proxy.com/?</small>
            </div>
        </div>
        <div class="modal-footer">
            <button id="reset-nai-settings-btn" class="form-button form-button-secondary" style="margin-right: 10px;">ÊÅ¢Â§çÈªòËÆ§</button>
            <button id="save-nai-settings-btn" class="form-button form-button-secondary"data-lang-key="save">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ NovelAI ÁîüÊàêËÆæÁΩÆÂºπÁ™óÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº NovelAI ÊµãËØïÁîüÊàêÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div id="novelai-test-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <span>üñºÔ∏è NovelAI ÊµãËØïÁîüÊàê</span>
            <span class="close" id="close-novelai-test" style="cursor: pointer; float: right; font-size: 28px; font-weight: bold;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div class="form-group">
                <label style="color: #333;">Ê≠£Èù¢ÊèêÁ§∫ËØçÔºàÊ≠§Â§ÑÊèêÁ§∫ËØç‰ªÖÁî®‰∫éËØ•ÂºπÁ™óÊµãËØïÔºâ</label>
                <textarea id="nai-test-prompt" rows="4" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="1girl, solo, long hair, blue eyes, smile...">1girl, solo, long hair, blue eyes, smile, outdoors, cherry blossoms, spring</textarea>
            </div>

            <div class="form-group">
                <label style="color: #333;">Ë¥üÈù¢ÊèêÁ§∫ËØçÔºàÂèØÈÄâÔºåÁïôÁ©∫‰ΩøÁî®ÈªòËÆ§Ôºâ</label>
                <textarea id="nai-test-negative" rows="3" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical;" placeholder="ÁïôÁ©∫Â∞Ü‰ΩøÁî®ËÆæÁΩÆ‰∏≠ÁöÑÈªòËÆ§Ë¥üÈù¢ÊèêÁ§∫ËØç"></textarea>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button id="nai-generate-btn" style="background-color: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                    ÁîüÊàêÂõæÂÉè
                </button>
            </div>

            <div id="nai-test-status" style="text-align: center; color: #666; margin: 15px 0; display: none;">
                Ê≠£Âú®ÁîüÊàê‰∏≠ÔºåËØ∑Á®çÂÄô...
            </div>

            <div id="nai-test-result" style="display: none; margin-top: 20px;">
                <div style="font-weight: bold; color: #333; margin-bottom: 10px;">ÁîüÊàêÁªìÊûúÔºö</div>
                <div style="text-align: center; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                    <img id="nai-result-image" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button id="nai-download-btn" class="form-button-secondary" style="margin: 0;">‰∏ãËΩΩÂõæÂÉè</button>
                </div>
            </div>

            <div id="nai-test-error" style="display: none; margin-top: 15px; padding: 12px; background: #f8d7da; color: #721c24; border-radius: 6px; border: 1px solid #f5c6cb;"></div>
        </div>
        <div class="modal-footer">
            <button id="close-nai-test-btn" class="form-button">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ NovelAI ÊµãËØïÁîüÊàêÂºπÁ™óÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº ËßíËâ≤‰∏ìÂ±ûNAIÂá∫ÂõæËÆæÁΩÆÂºπÁ™ó ‚ñº‚ñº‚ñº -->
<div id="character-nai-prompts-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span>ËßíËâ≤‰∏ìÂ±ûNAIÊèêÁ§∫ËØçÈÖçÁΩÆ</span>
            <span class="close" id="close-character-nai-prompts" style="cursor: pointer; float: right; font-size: 28px; font-weight: bold;">&times;</span>
        </div>
        <div class="modal-body">
            <p style="font-size: 13px; color: #666; margin-bottom: 20px; background-color: #f0f8ff; padding: 12px; border-radius: 6px; border-left: 3px solid #007bff;">
                üí° ËøôÈáåÈÖçÁΩÆÁöÑÊèêÁ§∫ËØç‰ªÖÁî®‰∫éÂΩìÂâçËßíËâ≤ÁöÑNAIÂá∫ÂõæÔºå‰∏çÂΩ±ÂìçÂÖ∂‰ªñËßíËâ≤ÊàñÁ≥ªÁªüËÆæÁΩÆ
            </p>
            
            <div class="form-group">
                <label for="character-nai-positive" style="color: #333; font-weight: 600;">
                    Ê≠£Èù¢ÊèêÁ§∫ËØç (Positive Prompt)
                </label>
                <textarea id="character-nai-positive" rows="4" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical; font-size: 13px;" placeholder="‰æãÂ¶Ç: masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style"></textarea>
                <small style="display: block; color: #666; font-size: 12px; margin-top: 5px;">
                    ÊèèËø∞‰Ω†Â∏åÊúõÁîüÊàêÁöÑÂõæÂÉèÈ£éÊ†ºÔºåÂèØÂ°´ÂÖ•ÁîªÂ∏à‰∏≤
                </small>
            </div>

            <div class="form-group">
                <label for="character-nai-negative" style="color: #333; font-weight: 600;">
                    Ë¥üÈù¢ÊèêÁ§∫ËØç (Negative Prompt)
                </label>
                <textarea id="character-nai-negative" rows="4" style="background-color: #f8f9fa; color: #333; border: 1px solid #ccc; padding: 10px; width: 100%; border-radius: 4px; resize: vertical; font-size: 13px;" placeholder="‰æãÂ¶Ç: lowres, bad anatomy, bad hands, text, error, missing fingers"></textarea>
                <small style="display: block; color: #666; font-size: 12px; margin-top: 5px;">
                    ÊèèËø∞‰Ω†Â∏åÊúõÈÅøÂÖçÁöÑÂÖÉÁ¥†
                </small>
            </div>
        </div>
        <div class="modal-footer">
            <button id="reset-character-nai-prompts-btn" class="form-button form-button-secondary" style="margin-right: 10px;">Ê∏ÖÁ©∫ÈÖçÁΩÆ</button>
            <button id="save-character-nai-prompts-btn" class="form-button form-button-secondary"data-lang-key="save">‰øùÂ≠ò</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ËßíËâ≤‰∏ìÂ±ûNAIÂá∫ÂõæËÆæÁΩÆÂºπÁ™óÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
<div id="npc-group-manager-modal" class="modal">
  <div class="modal-content" style="height: 60%;">
    <div class="modal-header"> <span>ÁÆ°ÁêÜNPCÂàÜÁªÑ</span> </div>
    <div class="modal-body">
      <div class="form-group"> <label>Êñ∞Âª∫ÂàÜÁªÑ</label>
        <div style="display: flex; gap: 10px;"> <input type="text" id="new-npc-group-name-input" placeholder="ËæìÂÖ•ÂàÜÁªÑÂêç (‰æãÂ¶Ç: ÂÆ∂‰∫∫ÁªÑ, ÊúãÂèãÁªÑ)..." style="flex-grow: 1;"> <button id="add-new-npc-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;"data-lang-key="add">Ê∑ªÂä†</button> </div>
      </div>
      <hr style="opacity: 0.2;">
      <div id="existing-npc-groups-list" style="display: flex; flex-direction: column; gap: 10px;"> </div>
    </div>
    <div class="modal-footer"> <button class="save" id="close-npc-group-manager-btn" style="width: 100%;"data-lang-key="done">ÂÆåÊàê</button> </div>
  </div>
</div>
<div id="pin-modal-overlay" class="modal">
    <div id="pin-modal-content" class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>ÂäüËÉΩÊøÄÊ¥ª</span>
        </div>
        <div class="modal-body" style="text-align: left;">
            <p>Ê≠§ÂäüËÉΩÈúÄË¶ÅÊøÄÊ¥ªÁ†Å (PIN) ÊâçËÉΩ‰ΩøÁî®„ÄÇ</p>
            
            <div class="form-group">
                <label for="pin-device-id-display">ÊÇ®ÁöÑËÆæÂ§áID (ËØ∑ÂéªÂ∞æÂ∑¥ÈïáËßíËâ≤Âç°‰∏≠Ëé∑ÂèñÔºåËøòÊúâËß£ÂØÜÊ≤°Áõ¥Êé•ÁªôÁΩëÂùÄÔºåÊåâÁÖßË¶ÅÊ±ÇÂéªÊêúÁ¥¢Â∞±Â•Ω‰∫ÜÔºå‰ª•‰∏ãÊï∞Â≠óÂç≥‰∏∫‰Ω†ÁöÑËÆæÂ§áÁ†Å)</label>
                <input type="text" id="pin-device-id-display" readonly style="background: #eee; cursor: text; -webkit-user-select: text; user-select: text;">
            </div>
            
            <div class="form-group">
                <label for="pin-input">ËØ∑ËæìÂÖ•ÊøÄÊ¥ªÁ†Å (PIN)</label>
                <input type="text" id="pin-input" placeholder="Âú®Ê≠§ËæìÂÖ•ÊøÄÊ¥ªÁ†Å...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="pin-modal-cancel-btn">ÂèñÊ∂à</button>
            <button class="save" id="pin-modal-confirm-btn">Á°ÆËÆ§ÊøÄÊ¥ª</button>
        </div>
    </div>
</div>
<div id="quick-reply-modal" class="modal">
    <div class="modal-content" style="height: 70%; position: relative;"> <div class="modal-header">
            <span>Âø´Êç∑ÂõûÂ§ç</span>
            <div class="header-actions">
                <button id="batch-quick-reply-btn" class="action-button" style="font-size: 14px; margin-right: 10px;">ÊâπÈáè</button>
                <button id="manage-quick-reply-categories-btn" class="action-button" style="font-size: 14px; margin-right: 10px;">ÂàÜÁ±ª</button>
                <button id="add-quick-reply-btn" class="action-button" style="font-size: 26px; color: var(--accent-color); font-weight: 300; cursor: pointer; background: none; border: none; padding: 0 5px;">+</button>
            </div>
        </div>
        
        <div id="quick-reply-tabs" style="display: flex; overflow-x: auto; padding: 0 15px; flex-shrink: 0; border-bottom: 1px solid var(--border-color); background-color: var(--secondary-bg); -ms-overflow-style: none; scrollbar-width: none;">
        </div>

        <div class="modal-body" id="quick-reply-list" style="padding: 0; display: flex; flex-direction: column; padding-bottom: 60px;"> </div>

        <div id="quick-reply-action-bar" style="display: none; position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px 15px; background: rgba(255,255,255,0.95); border-top: 1px solid #eee; box-sizing: border-box; justify-content: space-between; align-items: center; z-index: 10;">
            <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="select-all-quick-replies-checkbox"> ÂÖ®ÈÄâ
            </label>
            <div style="display: flex; gap: 8px;">
                <button id="move-selected-quick-replies-btn" class="settings-mini-btn" style="background-color: #ff9800; color: white; border: none;">ÁßªÂä® (0)</button>
                <button id="delete-selected-quick-replies-btn" class="settings-mini-btn" style="background-color: #ff3b30; color: white; border: none;">Âà†Èô§ (0)</button>
            </div>
        </div>

        <div class="modal-footer" id="quick-reply-normal-footer">
            <button class="cancel" id="cancel-quick-reply-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>
<div id="quick-reply-category-manager-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header"> <span>ÁÆ°ÁêÜÂõûÂ§çÂàÜÁ±ª</span> </div>
        <div class="modal-body">
            <div class="form-group"> <label>Êñ∞Âª∫ÂàÜÁ±ª</label>
                <div style="display: flex; gap: 10px;"> 
                    <input type="text" id="new-quick-reply-category-name-input" placeholder="ËæìÂÖ•ÂàÜÁ±ªÂêç..." style="flex-grow: 1;"> 
                    <button id="add-new-quick-reply-category-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;" data-lang-key="add">Ê∑ªÂä†</button> 
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-quick-reply-categories-list" style="display: flex; flex-direction: column; gap: 10px;"> 
                </div>
        </div>
        <div class="modal-footer"> 
            <button class="save" id="close-quick-reply-category-manager-btn" style="width: 100%;" data-lang-key="done">ÂÆåÊàê</button> 
        </div>
    </div>
</div>
<div id="char-music-restore-btn" style="display: none;">
  <img src="https://static.eeo.cn/upload/images/20251114/78d48a9f1d73b2bc6003.png" alt="Restore Music" style="width: 100%; height: 100%; ">
  </div>
<div id="video-call-restore-btn" style="display: none;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="23 7 16 12 23 17 23 7"></polygon>
        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
    </svg>
</div>
<div id="char-music-player-modal" class="modal">
        <div class="modal-content">
          <button id="minimize-char-music-btn" class="char-player-minimize-btn" title="ÊúÄÂ∞èÂåñ">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
    <line x1="5" y1="12" x2="19" y2="12"></line>
  </svg>
</button>
          <div class="char-player-body">
            <div class="char-player-song-info">
              <p id="char-music-player-title">Ê≠åÊõ≤ÂêçÁß∞</p>
              <p id="char-music-artist">Ê≠åÊâã</p>
            </div>
            <div id="char-vinyl-container"> <img id="char-music-cover" src=""> </div>
            <div id="char-music-lyrics"> </div>
            <div class="char-player-footer">
              <div class="char-player-progress-bar-container"> <span id="char-music-current-time" class="time-display">0:00</span>
                <div id="char-music-progress-bar" class="char-player-progress-bar">
                  <div id="char-music-progress-fill"></div>
                </div> <span id="char-music-total-time" class="time-display">0:00</span>
              </div>
              <div class="char-player-controls"> <button id="char-music-prev-btn" class="control-btn"> <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path>
                  </svg> </button> <button id="char-music-play-pause-btn" class="control-btn play"> <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
                    <path d="M8 5v14l11-7z"></path>
                  </svg> </button> <button id="char-music-next-btn" class="control-btn"> <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"></path>
                  </svg> </button> <button id="char-music-mode-btn" class="control-btn mode">È°∫Â∫è</button> </div>
            </div>
          </div> <button id="close-char-music-player-btn" class="char-player-close-btn">√ó</button>
        </div>
      </div>
<!-- Êñ∞Â¢ûÔºö‰∫≤Â±ûÂç°Ëµ†ÈÄÅ‰∏ìÂ±ûÂºπÁ™ó -->
<div id="kinship-creation-modal" class="modal">
  <div class="modal-content" style="height: 70%; display: flex; flex-direction: column;">
    <div class="modal-header">
      <span>Ëµ†ÈÄÅ‰∫≤Â±ûÂç°</span>
    </div>
    
    <!-- ‰∏≠Èó¥ÈÉ®ÂàÜÔºöÂàÜ‰∏∫‰∏äÈù¢ÁöÑËßíËâ≤ÂàóË°®Âíå‰∏ãÈù¢ÁöÑÈáëÈ¢ùËæìÂÖ• -->
    <div class="modal-body" style="padding: 0; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden;">
      
      <!-- ÊèêÁ§∫ËØ≠ -->
      <div style="padding: 10px 15px; background-color: #f5f5f7; color: #666; font-size: 13px; border-bottom: 1px solid var(--border-color);">
        ËØ∑ÈÄâÊã©Ëµ†‰∫àÂØπË±° (ÂçïÈÄâ)
      </div>

      <!-- ËßíËâ≤ÂàóË°®Âå∫Âüü (Â§çÁî®Ê∏ÖÁêÜÊï∞ÊçÆÁöÑÊ†∑Âºè) -->
      <div id="kinship-char-list" style="flex-grow: 1; overflow-y: auto;">
        <!-- JS Âä®ÊÄÅÂ°´ÂÖÖ -->
      </div>

      <!-- ÈáëÈ¢ùËæìÂÖ•Âå∫Âüü -->
      <div style="padding: 20px; background-color: #fff; border-top: 1px solid var(--border-color); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 2;">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="kinship-limit-input" style="font-weight: 600;">ÊØèÊúàÊ∂àË¥πÈ¢ùÂ∫¶</label>
          <div style="position: relative; display: flex; align-items: center;">
             <span style="font-size: 20px; font-weight: bold; margin-right: 5px;">¬•</span>
             <input type="number" id="kinship-limit-input" value="5200" placeholder="ËØ∑ËæìÂÖ•ÈáëÈ¢ù" 
                    style="font-size: 24px; font-weight: bold; color: #ff1744; border: none; border-bottom: 1px solid #ddd; border-radius: 0; padding: 5px 0; background: transparent;">
          </div>
          <p style="font-size: 12px; color: #999; margin-top: 8px;">‰ºòÂÖàÊâ£Èô§‰∫≤Â±ûÂç°È¢ùÂ∫¶ÔºåË∂ÖÂá∫ÈÉ®ÂàÜÁî±ÂØπÊñπËá™‰ªò„ÄÇ</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="cancel" id="cancel-kinship-creation-btn" data-lang-key="cancel">ÂèñÊ∂à</button>
      <button class="save" id="confirm-kinship-creation-btn" style="background: linear-gradient(135deg, #ff5252, #ff1744); border: none;">Á°ÆËÆ§Ëµ†ÈÄÅ</button>
    </div>
  </div>
</div>
<div id="inventory-modal" class="modal">
    <div class="modal-content" style="height: 70%; background-color: #1c1c1e; color: #e0e0e0; border: 1px solid #333;">
        <div class="modal-header" style="border-bottom: 1px solid #333; color: #d4af37;">
            <span>ÊàëÁöÑËóèÂìÅ</span>
            <span class="action-btn" onclick="closeInventoryModal()" style="font-size: 20px;">√ó</span>
        </div>
        <div class="modal-body" id="inventory-list" style="padding: 15px; overflow-y: auto;">
            </div>
    </div>
</div>
<div id="todo-editor-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span id="todo-editor-title">Ê∑ªÂä†‰∫ãÈ°π</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ÂÜÖÂÆπ</label>
                <input type="text" id="todo-content-input" placeholder="‰æãÂ¶ÇÔºöËÆ∞ÂæóÂêÉËçØ„ÄÅ‰∏ãÂçàÂºÄ‰ºö">
            </div>
            <div class="form-group">
                <label>Á±ªÂûã/Ê†áÁ≠æ</label>
                <div class="todo-type-selector" id="todo-type-options">
                    <span class="todo-type-option active" data-value="Êó•Â∏∏" style="--tag-color: #8e8e93;">Êó•Â∏∏</span>
                    <span class="todo-type-option" data-value="Â∑•‰Ωú" style="--tag-color: #007aff;">Â∑•‰Ωú</span>
                    <span class="todo-type-option" data-value="ÈáçË¶Å" style="--tag-color: #ff3b30;">ÈáçË¶Å</span>
                    <span class="todo-type-option" data-value="ÁîüÊ¥ª" style="--tag-color: #34c759;">ÁîüÊ¥ª</span>
                    <span class="todo-type-option" data-value="Á∫¶‰ºö" style="--tag-color: #af52de;">Á∫¶‰ºö</span>
                    <span class="todo-type-option" data-value="ËÆ∞Ë¥¶" style="--tag-color: #ffc107;">ËÆ∞Ë¥¶</span>
                </div>
            </div>
            <div class="form-group">
                <label>Êó•Êúü</label>
                <input type="date" id="todo-date-input">
            </div>
            <div class="form-group">
                <label>ÂÖ∑‰ΩìÊó∂Èó¥ (ÂèØÈÄâ)</label>
                <input type="time" id="todo-time-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-todo-editor-btn">ÂèñÊ∂à</button>
            <button class="save" id="save-todo-btn">‰øùÂ≠ò</button>
        </div>
    </div>
</div>
<div id="gr-settings-modal" class="modal">
    <div class="modal-content" style="height: 85%; background-color: #FAFAF9;">
        <div class="gr-header" style="background: transparent; padding: 15px;">
            <span class="gr-title" style="color: #1B4F3E;">‰ΩúÂìÅËÆæÂÆö</span>
        </div>
        <div class="modal-body" style="padding: 0 20px;">
            <div class="gr-form-group">
                <label>‰π¶Âêç</label>
                <input type="text" id="gr-story-title" class="gr-input" placeholder="ËØ∑ËæìÂÖ•‰π¶Âêç">
            </div>
            <div class="gr-form-group">
    <label>ÂÆèÂ§ß‰∏ñÁïåËßÇ / IFÁ∫øËÆæÂÆö (Macro World View)</label>
    <textarea id="gr-macro-world-view" class="gr-input" rows="3" placeholder="Âú®Ê≠§ËæìÂÖ•Ê†∏ÂøÉËÆæÂÆö„ÄÇ‰æãÂ¶ÇÔºö'Ê∞ëÂõΩÂÜõÈòÄËÉåÊôØÔºåCharÊòØÂ∞ëÂ∏ÖÔºåUserÊòØËøõÊ≠•Â≠¶Áîü'ÔºåÊàñËÄÖ 'ABOËÆæÂÆöÔºåCharÊòØEnigma'„ÄÇÊ≠§ËÆæÂÆö‰ºòÂÖàÁ∫ßÊúÄÈ´ò„ÄÇ"></textarea>
</div>
            <div class="gr-form-group">
                <label>ÊåáÂÆö‰ΩúËÄÖ (ÊñáÈ£é)</label>
                <select id="gr-author-select" class="gr-select"></select>
            </div>

            <div class="gr-form-group">
                <label>ÁôªÂú∫ËßíËâ≤ (Chat/NPC/Áæ§ËÅä)</label>
                <div class="gr-checkbox-list" id="gr-char-list"></div>
            </div>

            <div class="gr-form-group">
                <label>‰∏ñÁïåËßÇ (World Book)</label>
                <div class="gr-checkbox-list" id="gr-worldbook-list"></div>
            </div>
            
             <div class="gr-form-group">
                <label>ÊàëÁöÑË∫´‰ªΩ (User Persona)</label>
                <select id="gr-user-persona-select" class="gr-select">
                     <option value="">‰ΩøÁî®ÈªòËÆ§</option>
                </select>
            </div>

            <div class="gr-form-group">
                <label>ÂçïÊ¨°ÁîüÊàêÂ≠óÊï∞ (Token)</label>
                <input type="number" id="gr-output-length" class="gr-input" value="500">
            </div>
             <div class="gr-form-group">
                <label>‰∏ä‰∏ãÊñáÂºïÁî®Êù°Êï∞ (History)</label>
                <input type="number" id="gr-context-limit" class="gr-input" value="20">
            </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #E5E5E5;">
            <button class="cancel" id="gr-cancel-settings-btn" style="color: #666;">ÂèñÊ∂à</button>
            <button class="save" id="gr-save-story-btn" style="background: #1B4F3E; border: none;">ÂºÄÂßãÂàõ‰Ωú</button>
        </div>
    </div>
</div>
<div id="gr-author-editor-modal" class="modal">
  <div class="modal-content" style="height: auto;">
    <div class="modal-header">
      <span id="gr-author-editor-title">ÁºñËæë‰ΩúËÄÖ</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>‰ΩúËÄÖÂêçÁß∞</label>
        <input type="text" id="gr-author-name-input" placeholder="‰æãÂ¶ÇÔºöÈ≤ÅËøÖÈ£éÊ†º">
      </div>
      <div class="form-group">
        <label>ÊñáÈ£éÊèèËø∞</label>
        <textarea id="gr-author-style-input" rows="5" placeholder="Âú®Ê≠§ÊèèËø∞ËØ•‰ΩúËÄÖÁöÑÁî®ËØç‰π†ÊÉØ„ÄÅÂè•ÂºèÁâπÁÇπ..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="cancel" onclick="document.getElementById('gr-author-editor-modal').classList.remove('visible')">ÂèñÊ∂à</button>
      <button class="save" id="gr-save-author-btn">‰øùÂ≠ò</button>
    </div>
  </div>
</div>
<div id="nai-binding-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span>ÁªëÂÆöÈ¢ÑËÆæÂà∞ËßíËâ≤</span>
        </div>
        <div class="modal-body" id="nai-binding-list" style="padding: 0;">
            </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-nai-binding-btn" data-lang-key="cancel">ÂèñÊ∂à</button>
            <button class="save" id="save-nai-binding-btn" data-lang-key="save">‰øùÂ≠òÁªëÂÆö</button>
        </div>
    </div>
</div>
<audio id="silent-audio-player" loop preload="auto" style="display:none;">
    <source src="https://phoebeboo.github.io/mewoooo/1-second-of-silence.mp3" type="audio/mpeg">
  </audio><audio id="tts-audio-player" style="display:none;"></audio>



    <!-- Ë°®ÊÉÖÂåÖÈ°µÈù¢ -->
    <div class="sticker-page" id="stickerPage">
        <div class="sticker-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="wechat-header-btn" onclick="closeStickerPage()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </div>
                <div class="sticker-header-title">Ë°®ÊÉÖÂåÖÁîüÊàê</div>
            </div>
        </div>
        <div class="sticker-content">
            <div class="sticker-generate-area">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-color);">ÁîüÊàêË°®ÊÉÖÂåÖ</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.6;">
                    ‰ΩøÁî® NovelAI ÁîüÊàê LINE È£éÊ†ºÁöÑË°®ÊÉÖÂåÖ„ÄÇÁ≥ªÁªüÂ∞Ü‰ΩøÁî®ÂÜÖÁΩÆÊèêÁ§∫ËØçËá™Âä®ÁîüÊàê 3√ó3 ÁΩëÊ†ºÂ∏ÉÂ±ÄÁöÑË°®ÊÉÖÂåÖ„ÄÇ
                </p>
                
                <!-- Êåá‰ª§Ë¶ÅÊ±ÇËæìÂÖ• -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-color);">Êåá‰ª§Ë¶ÅÊ±Ç</label>
                    <textarea id="stickerTextInput" class="settings-textarea" placeholder="‰æãÂ¶ÇÔºöÁîüÊàê‰∏Ä‰∏™ÂºÄÂøÉÁöÑË°®ÊÉÖÔºåÊàñËÄÖÔºöÁîüÊàêÂåÖÂê´ OK„ÄÅNO„ÄÅTHANKS Á≠âÊñáÂ≠óÁöÑË°®ÊÉÖÂåÖ" rows="3" style="width: 100%; box-sizing: border-box;"></textarea>
                    <div style="font-size: 11px; color: #999; margin-top: 4px;">ÊèêÁ§∫ÔºöÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁîüÊàêÁöÑË°®ÊÉÖÂåÖÁöÑÂÖ∑‰ΩìË¶ÅÊ±Ç</div>
                </div>
                
                <button class="test-btn" onclick="generateSticker()" id="generateStickerBtn" style="width: 100%; padding: 12px; font-size: 16px;">
                    <span id="generateStickerBtnText">üé® ÁîüÊàêË°®ÊÉÖÂåÖ</span>
                </button>
                <div id="stickerGenerateStatus" style="margin-top: 15px; font-size: 14px; min-height: 20px; text-align: center;"></div>
            </div>
            
            <div class="sticker-preview-area" id="stickerPreviewArea" style="display: none;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-color);">ÁîüÊàêÁªìÊûú</h3>
                <div class="sticker-preview" id="stickerPreview">
                    <!-- ÁîüÊàêÁöÑÂõæÁâáÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå -->
                </div>
                <div class="sticker-actions">
                    <button class="test-btn" onclick="saveSticker()" style="flex: 1; padding: 10px;">üíæ ‰øùÂ≠òÂà∞Ë°®ÊÉÖ</button>
                    <button class="test-btn" onclick="splitSticker()" style="flex: 1; padding: 10px; background: #FF9800; color: white;">‚úÇÔ∏è ÊãÜÂàÜË°®ÊÉÖÂåÖ</button>
                    <button class="test-btn" onclick="regenerateSticker()" style="flex: 1; padding: 10px; background: #f0f0f0; color: var(--text-color);">üîÑ ÈáçÊñ∞ÁîüÊàê</button>
                </div>
                
                <!-- ÊãÜÂàÜÁªìÊûúÂå∫Âüü -->
                <div id="splitResultArea" style="display: none; margin-top: 20px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--text-color);">ÊãÜÂàÜÁªìÊûú <span id="splitCount" style="font-size: 12px; font-weight: normal; color: #666;"></span></h3>
                    <div id="splitGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f8f8; border-radius: 8px;">
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">‰øùÂ≠òÊï¥Â•óË°®ÊÉÖÂà∞ WeChat</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="stickerPackName" placeholder="ÁªôËøôÂ•óË°®ÊÉÖÂèñ‰∏™ÂêçÂ≠ó" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <button onclick="saveSplitStickersToMyEmojis()" class="test-btn" style="background-color: #07C160; color: white; white-space: nowrap;">üíæ ‰∏ÄÈîÆ‰øùÂ≠ò</button>
                        </div>
                    </div>

                    <button onclick="downloadAllSplitStickers()" id="downloadAllSplitBtn" class="test-btn" style="width: 100%; margin-top: 10px; background-color: #ed8936; color: white;">üì• ÊâπÈáè‰∏ãËΩΩÊñá‰ª∂</button>
                </div>
            </div>
        </div>
    </div>
 <script>

function escapeHTML(str) {
  if (!str) return '';
  return str.replace(/[&<>"']/g, function(match) {
    return {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    } [match];
  });
}
function generateRandomPacketAmounts(totalAmount, count) {
    let remainingAmount = totalAmount;
    let remainingCount = count;
    const amounts = [];
    const min = 0.01; 

    for (let i = 0; i < count - 1; i++) {
      
        const avg = remainingAmount / remainingCount;
        const absoluteMax = remainingAmount - (remainingCount - 1) * min;
        
        let max = Math.min(avg * 2, absoluteMax);
        if (max < min) {
            max = min;
        }

        let amount = Math.random() * (max - min) + min;
        amount = parseFloat(amount.toFixed(2));
        
        amounts.push(amount);
        remainingAmount -= amount;
        remainingCount--;
    }
    
  
    amounts.push(parseFloat(remainingAmount.toFixed(2)));
  
    for (let i = amounts.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [amounts[i], amounts[j]] = [amounts[j], amounts[i]];
    }
    
    console.log(`[Á∫¢ÂåÖÁîüÊàê]: ÊÄªÈáëÈ¢ù ${totalAmount}, Êï∞Èáè ${count}. ÂàÜÈÖçÁªìÊûú:`, amounts);
    return amounts;
}

function getDeviceId() {
  let deviceId = localStorage.getItem('ephoneDeviceId');
  if (!deviceId) {
 
    deviceId = ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
    localStorage.setItem('ephoneDeviceId', deviceId);
  }
  return deviceId;
}


const EPHONE_DEVICE_ID = getDeviceId();
console.log(`EPhone ËÆæÂ§áID: ${EPHONE_DEVICE_ID}`);


let isPinActivated = localStorage.getItem('ephonePinActivated') === 'true';



const translations = {
  'zh-CN': {

    save: '‰øùÂ≠ò',
    cancel: 'ÂèñÊ∂à',
    confirm: 'Á°ÆÂÆö',
    edit: 'ÁºñËæë',
    done: 'ÂÆåÊàê',
    add: 'Ê∑ªÂä†',
    back: 'ËøîÂõû',
    next: '‰∏ã‰∏ÄÊ≠•',
    close: 'ÂÖ≥Èó≠',
    reset: 'ÈáçÁΩÆ',
    upload: '‰∏ä‰º†',
    send: 'ÂèëÈÄÅ',
    manage: 'ÁÆ°ÁêÜ',
    share: 'ÂàÜ‰∫´',
    delete: 'Âà†Èô§',
    publish: 'ÂèëÂ∏É',
    refresh: 'Âà∑Êñ∞',
    search: 'ÊêúÁ¥¢',
    remove: 'ÁßªÈô§',
    finish: 'ÁªìÊùü',
    details: 'ËØ¶ÊÉÖ',
    settings: 'ËÆæÁΩÆ',
    title: 'Ê†áÈ¢ò',
    content: 'ÂÜÖÂÆπ',
    category: 'ÂàÜÁ±ª',
    name: 'ÂêçÁß∞',
    description: 'ÊèèËø∞',
    status: 'Áä∂ÊÄÅ',
    ok: 'Â•ΩÁöÑ',
    error: 'ÈîôËØØ',
    success: 'ÊàêÂäü',
    warning: 'Ë≠¶Âëä',
    loading: 'Âä†ËΩΩ‰∏≠...',
    processing: 'Â§ÑÁêÜ‰∏≠...',
    pleaseWait: 'ËØ∑Á®çÂÄô...',
    languageChangedAlert: 'ËØ≠Ë®ÄÂ∑≤ÂàáÊç¢ÔºåÈ°µÈù¢Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®Êõ¥Êîπ„ÄÇ',


    // --- ‰∏ªÂ±èÂπï & Dock ---
    homeAppQQ: 'QQ',
    homeAppWorldBook: '‰∏ñÁïå‰π¶',
    homeAppAppearance: 'Â§ñËßÇËÆæÁΩÆ',
    homeAppRenderer: 'Ê∏≤ÊüìÂô®',
    homeAppApiSettings: 'ËÆæÁΩÆ',
    homeAppFont: 'Â≠ó‰Ωì',
    homeAppCPhone: 'CPhone',
    homeAppDouban: 'Ë±ÜÁì£',
    homeAppPreset: 'È¢ÑËÆæ',
    homeAppTutorial: 'ÊïôÁ®ã',
    homeAppWerewolf: 'Áãº‰∫∫ÊùÄ',
    homeAppX: 'X',

    // --- ËÅäÂ§©ÂàóË°®È°µ ---
    chatListTitle: 'Ê∂àÊÅØ',
    navMessages: 'Ê∂àÊÅØ',
    navQzone: 'Âä®ÊÄÅ',
    navMemories: 'ÂõûÂøÜ',
    navFavorites: 'Êî∂Ëóè',
    navNpcList: 'NPC',

    // --- QZone & Âä®ÊÄÅ ---
    qzoneTitle: 'Â•ΩÂèãÂä®ÊÄÅ',
    qzoneActionShuoshuo: 'ËØ¥ËØ¥',
    qzoneActionPost: 'Âä®ÊÄÅ',
    qzoneActionAlbum: 'Áõ∏ÂÜå',

    // --- CPhone (ËßíËâ≤ÊâãÊú∫) ---
    cphoneTitleSelect: 'ÈÄâÊã©‰∏ÄÈÉ®ÊâãÊú∫',
    cphoneAppQQ: 'QQ',
    cphoneAppAlbum: 'Áõ∏ÂÜå',
    cphoneAppBrowser: 'ÊµèËßàÂô®',
    cphoneAppTaobao: 'Ê∑òÂÆù',
    cphoneAppMemo: 'Â§áÂøòÂΩï',
    cphoneAppDiary: 'Êó•ËÆ∞',
    cphoneAppAmap: 'È´òÂæ∑Âú∞Âõæ',
    cphoneAppUsage: 'AppËÆ∞ÂΩï',
    cphoneAppMusic: 'ÁΩëÊòì‰∫ë',
    cphoneAppEphone: 'Ephone',
    cphoneAppFootprints: 'Ë∂≥Ëøπ',
    cphoneAlbumTitle: 'TAÁöÑÁõ∏ÂÜå',
    cphoneBrowserTitle: 'TAÁöÑÊµèËßàÂô®ÂéÜÂè≤',
    cphoneTaobaoTitle: 'TAÁöÑÊ∑òÂÆùËÆ¢Âçï',
    cphoneWalletTitle: 'Èí±ÂåÖ',
    cphoneMemoTitle: 'Â§áÂøòÂΩï',
    cphoneDiaryTitle: 'Êó•ËÆ∞',
    cphoneUsageTitle: 'App‰ΩøÁî®ËÆ∞ÂΩï',
    cphoneMusicTitle: 'TAÁöÑÊ≠åÂçï',
    cphoneArticleTitle: 'ÊñáÁ´†',
    cphoneSimulatedChatPlaceholder: 'ËøôÊòØÊ®°ÊãüÂØπËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ',

    // --- ‰∏ñÁïå‰π¶ ---
    worldBookTitle: '‰∏ñÁïå‰π¶',
    worldBookEditorTitle: 'ÁºñËæë‰∏ñÁïå‰π¶',
    worldBookEntryEditorTitle: 'ÁºñËæëÊù°ÁõÆ',
    worldBookNameLabel: '‰π¶Âêç',
    worldBookCategoryLabel: 'ÂàÜÁ±ª',
    worldBookEntriesLabel: 'ÂÜÖÂÆπÊù°ÁõÆ',
    worldBookAddEntryBtn: '[+] Ê∑ªÂä†Êñ∞Êù°ÁõÆ',
    worldBookNamePlaceholder: 'ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞...',
    worldBookImportTitle: 'ÂØºÂÖ•‰∏ñÁïå‰π¶',

    // --- È¢ÑËÆæ ---
    presetTitle: 'È¢ÑËÆæ',
    presetEditorTitle: 'ÁºñËæëÈ¢ÑËÆæ',
    presetNameLabel: 'È¢ÑËÆæÂêçÁß∞',
    presetCategoryLabel: 'ÂàÜÁ±ª',
    presetEntriesLabel: 'ÂÜÖÂÆπÊù°ÁõÆ',
    presetAddEntryBtn: '[+] Ê∑ªÂä†Êñ∞Êù°ÁõÆ',

    // --- ÊïôÁ®ã ---
    tutorialTitle: 'ÊïôÁ®ã',

    // --- API ËÆæÁΩÆ ---
    apiSettingsTitle: 'API ËÆæÁΩÆ',
    languageLabel: 'ËØ≠Ë®Ä',
    apiPresetManagement: 'API È¢ÑËÆæÁÆ°ÁêÜ',
    apiPresetSelectLabel: 'ÈÄâÊã©ÊàñÂàáÊç¢È¢ÑËÆæ',
    apiPrimarySettings: '‰∏ªAPIËÆæÁΩÆ (Áî®‰∫éËÅäÂ§©)',
    apiProxyUrlLabel: 'Âèç‰ª£Âú∞ÂùÄ (‰∏çÈúÄË¶ÅÊ∑ªÂä†/v1Âô¢~)',
    apiKeyLabel: 'ÂØÜÈí• (API Key)',
    apiModelLabel: 'Ê®°Âûã',
    apiFetchModelsBtn: 'ÊãâÂèñ‰∏ªÊ®°Âûã',
    apiSecondarySettings: 'ÂâØAPIËÆæÁΩÆ (Áî®‰∫éÊÄªÁªìÈïøÊúüËÆ∞ÂøÜ)',
    apiSecondaryProxyUrlLabel: 'ÂâØÂèç‰ª£Âú∞ÂùÄ',
    apiSecondaryKeyLabel: 'ÂâØÂØÜÈí•',
    apiSecondaryModelLabel: 'ÂâØÊ®°Âûã',
    apiFetchSecondaryModelsBtn: 'ÊãâÂèñÂâØÊ®°Âûã',
    apiBgActivitySettings: 'ÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆ',
    apiEnableBgActivityLabel: 'ÂêØÁî®ÂêéÂè∞ËßíËâ≤Ê¥ªÂä®',
    apiBgIntervalLabel: 'ÂêéÂè∞Ê¥ªÂä®Ê£ÄÊµãÈó¥Èöî (Áßí)',
    apiBlockCooldownLabel: 'AIË¢´ÊãâÈªëÂêéÂÜ∑ÈùôÊúü (Â∞èÊó∂)',
    apiTtsSettings: 'ËØ≠Èü≥Ê∂àÊÅØËÆæÁΩÆ (Minimax TTS)',
    apiTtsModelLabel: 'ËØ≠Èü≥Ê®°Âûã (Model)',
    apiPerformanceSettings: 'ÊÄßËÉΩ‰∏éÊòæÁ§∫ËÆæÁΩÆ',
    apiChatListRenderWindowLabel: 'ËÅäÂ§©ÂàóË°®ÊØèÊ¨°Âä†ËΩΩÊù°Êï∞',
    apiChatRenderWindowLabel: 'ËÅäÂ§©ÁïåÈù¢ÂàùÂßãÂä†ËΩΩÊù°Êï∞',
    apiImageGenSettings: 'ÁîüÂõæÂäüËÉΩËÆæÁΩÆ',
    apiEnableImageGenLabel: 'ÂêØÁî®AIÁîüÂõæÂäüËÉΩ',
    apiEnableNovelAILabel: 'ÂêØÁî® NovelAI ÂõæÂÉèÁîüÊàê',
    apiNovelAIModelLabel: 'NovelAI Ê®°Âûã',
    apiNovelAIKeyLabel: 'NovelAI API Key',
    apiNovelAIGenSettingsBtn: 'ÁîüÊàêËÆæÁΩÆ',
    apiNovelAITestBtn: 'ÊµãËØïÁîüÊàê',
    apiStorageOptimization: 'Â≠òÂÇ®Á©∫Èó¥‰ºòÂåñ',
    apiCompressImagesBtn: '‰∏ÄÈîÆÂéãÁº©Êú¨Âú∞ÂõæÁâá',
    apiSaveAllBtn: '‰øùÂ≠òÊâÄÊúâËÆæÁΩÆ',
    apiExportDataBtn: 'ÂØºÂá∫Êï∞ÊçÆ',
    apiImportDataBtn: 'ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂',
    apiCleanupDataBtn: 'Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆ',
    apiDeleteWorldBooksBtn: 'Âà†Èô§‰∏ñÁïå‰π¶',
    apiAdvancedCleanupBtn: 'È´òÁ∫ßÊï∞ÊçÆÊ∏ÖÁêÜ',
    apiCheckAndFixDataBtn: 'Êï∞ÊçÆÊ£ÄÊü•‰∏é‰øÆÂ§ç',

    // --- ËÅäÂ§©ÁïåÈù¢ ---
    chatHeaderOnline: 'Âú®Á∫ø',
    chatHeaderLongTermMemory: 'ÈïøÊúüËÆ∞ÂøÜ',
    chatHeaderListenTogether: '‰∏ÄËµ∑Âê¨',
    chatHeaderChatSettings: 'ËÅäÂ§©ËÆæÁΩÆ',
    chatSelectionCancel: 'ÂèñÊ∂à',
    chatSelectionScreenshot: 'ÈïøÊà™Âõæ',
    chatSelectionFavorite: 'Êî∂Ëóè',
    chatSelectionShare: 'ÂàÜ‰∫´',
    chatSelectionSoftDelete: 'Âà†Èô§(ÈÄöÁü•AI)',
    chatSelectionHardDelete: 'ÂΩªÂ∫ïÂà†Èô§',
    chatReplyTo: 'ÂõûÂ§ç',
    chatInputPlaceholder: 'ËæìÂÖ•Ê∂àÊÅØ...',
    chatWaitForReply: 'Á≠âÂæÖÂõûÂ§ç',

    // --- Â§ñËßÇËÆæÁΩÆ ---
    appearanceTitle: 'Â§ñËßÇËÆæÁΩÆ',
    appearanceSaveAll: '‰øùÂ≠òÊâÄÊúâÂ§ñËßÇËÆæÁΩÆ',

    // --- Â≠ó‰ΩìËÆæÁΩÆ ---
    fontSettingsTitle: 'Â≠ó‰ΩìËÆæÁΩÆ',
    fontPresetManagement: 'Â≠ó‰ΩìÈ¢ÑËÆæÁÆ°ÁêÜ',
    fontFileUrlLabel: 'Â≠ó‰ΩìÊñá‰ª∂URL (.ttf, .otf, .woffÁ≠â)',
    fontPreviewLabel: 'ÂÆûÊó∂È¢ÑËßà',
    fontPreviewText1: '‰Ω†Â•Ω‰∏ñÁïå Hello World',
    fontPreviewText2: 'ËøôÊòØÂ≠ó‰ΩìÈ¢ÑËßàÊïàÊûúÔºå12345„ÄÇ',
    fontSaveAndApply: '‰øùÂ≠òÂπ∂Â∫îÁî®',
    fontResetDefault: 'ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì',

    // --- Ê∏≤ÊüìËßÑÂàô ---
    rendererTitle: 'Ê∏≤ÊüìËßÑÂàô',
    rendererEditorTitle: 'ÁºñËæëËßÑÂàô',
    rendererCreateTitle: 'ÂàõÂª∫Êñ∞ËßÑÂàô',
    rendererRuleName: 'ËßÑÂàôÂêçÁß∞',
    rendererBindScope: 'ÁªëÂÆöËåÉÂõ¥',
    rendererScopeGlobal: 'ÂÖ¨Áî® (ÊâÄÊúâËßíËâ≤)',
    rendererRegex: 'Ê≠£ÂàôË°®ËææÂºè (‰ΩøÁî®g‰Ωú‰∏∫Ê†áÂøó)',
    rendererHtmlTemplate: 'HTML Ê®°Êùø (Áî® $1, $2 ÂºïÁî®)',
    rendererEnableRule: 'ÂêØÁî®ËßÑÂàô',

    // --- ÂÖ∂‰ªñ ---
    myAlbumTitle: 'ÊàëÁöÑÁõ∏ÂÜå',
    albumPhotosTitle: 'Áõ∏ÂÜåÂêçÁß∞',
    npcEditorTitleAdd: 'Ê∑ªÂä† NPC',
    npcEditorTitleEdit: 'ÁºñËæë NPC',
    npcAvatarLabel: 'NPC Â§¥ÂÉè',
    npcUploadAvatar: '‰∏ä‰º†Â§¥ÂÉè',
    npcNicknameLabel: 'NPC ÊòµÁß∞',
    npcPersonaLabel: 'NPC ‰∫∫ËÆæ',
    npcEnableBgActivity: 'ÂêØÁî®Áã¨Á´ãÂêéÂè∞Ê¥ªÂä®',
    npcActionCooldown: 'Áã¨Á´ãË°åÂä®ÂÜ∑Âç¥ (ÂàÜÈíü)',
    npcAssociatedChars: 'ÂÖ≥ËÅîÁöÑËßíËâ≤ (NPC‰ºöÂéªËØÑËÆ∫Ëøô‰∫õËßíËâ≤ÁöÑÂä®ÊÄÅ)',
  

  },
  'en': {

    save: 'Save',
    cancel: 'Cancel',
    confirm: 'Confirm',
    edit: 'Edit',
    done: 'Done',
    add: 'Add',
    back: 'Back',
    next: 'Next',
    close: 'Close',
    reset: 'Reset',
    upload: 'Upload',
    send: 'Send',
    manage: 'Manage',
    share: 'Share',
    delete: 'Delete',
    publish: 'Publish',
    refresh: 'Refresh',
    search: 'Search',
    remove: 'Remove',
    finish: 'Finish',
    details: 'Details',
    settings: 'Settings',
    title: 'Title',
    content: 'Content',
    category: 'Category',
    name: 'Name',
    description: 'Description',
    status: 'Status',
    ok: 'OK',
    error: 'Error',
    success: 'Success',
    warning: 'Warning',
    loading: 'Loading...',
    processing: 'Processing...',
    pleaseWait: 'Please wait...',
    languageChangedAlert: 'Language switched. The page will reload to apply changes.',


    // --- Home Screen & Dock ---
    homeAppQQ: 'QQ',
    homeAppWorldBook: 'World Book',
    homeAppAppearance: 'Appearance',
    homeAppRenderer: 'Renderer',
    homeAppApiSettings: 'Settings',
    homeAppFont: 'Fonts',
    homeAppCPhone: 'CPhone',
    homeAppDouban: 'Douban',
    homeAppPreset: 'Presets',
    homeAppTutorial: 'Tutorial',
    homeAppWerewolf: 'Werewolf',
    homeAppX: 'X',

    // --- Chat List Screen ---
    chatListTitle: 'Messages',
    navMessages: 'Messages',
    navQzone: 'Moments',
    navMemories: 'Memories',
    navFavorites: 'Favorites',
    navNpcList: 'NPCs',

    // --- QZone & Moments ---
    qzoneTitle: 'Moments',
    qzoneActionShuoshuo: 'Status',
    qzoneActionPost: 'Post',
    qzoneActionAlbum: 'Album',

    // --- CPhone (Character's Phone) ---
    cphoneTitleSelect: 'Select a Phone',
    cphoneAppQQ: 'QQ',
    cphoneAppAlbum: 'Album',
    cphoneAppBrowser: 'Browser',
    cphoneAppTaobao: 'Taobao',
    cphoneAppMemo: 'Memo',
    cphoneAppDiary: 'Diary',
    cphoneAppAmap: 'Amap',
    cphoneAppUsage: 'App Usage',
    cphoneAppMusic: 'Music',
    cphoneAppEphone: 'Ephone',
    cphoneAppFootprints: 'Footprints',
    cphoneAlbumTitle: 'Their Album',
    cphoneBrowserTitle: 'Their Browser History',
    cphoneTaobaoTitle: 'Their Taobao Orders',
    cphoneWalletTitle: 'Wallet',
    cphoneMemoTitle: 'Memo',
    cphoneDiaryTitle: 'Diary',
    cphoneUsageTitle: 'App Usage Log',
    cphoneMusicTitle: 'Their Playlist',
    cphoneArticleTitle: 'Article',
    cphoneSimulatedChatPlaceholder: 'This is a simulated chat, messages cannot be sent',

    // --- World Book ---
    worldBookTitle: 'World Book',
    worldBookEditorTitle: 'Edit World Book',
    worldBookEntryEditorTitle: 'Edit Entry',
    worldBookNameLabel: 'Book Name',
    worldBookCategoryLabel: 'Category',
    worldBookEntriesLabel: 'Content Entries',
    worldBookAddEntryBtn: '[+] Add New Entry',
    worldBookNamePlaceholder: 'Enter the name of the world book...',
    worldBookImportTitle: 'Import World Book',

    // --- Presets ---
    presetTitle: 'Presets',
    presetEditorTitle: 'Edit Preset',
    presetNameLabel: 'Preset Name',
    presetCategoryLabel: 'Category',
    presetEntriesLabel: 'Content Entries',
    presetAddEntryBtn: '[+] Add New Entry',

    // --- Tutorial ---
    tutorialTitle: 'Tutorial',

    // --- API Settings ---
    apiSettingsTitle: 'API Settings',
    languageLabel: 'Language',
    apiPresetManagement: 'API Preset Management',
    apiPresetSelectLabel: 'Select or Switch Preset',
    apiPrimarySettings: 'Primary API Settings (for Chat)',
    apiProxyUrlLabel: 'Proxy URL (No /v1 needed~)',
    apiKeyLabel: 'API Key',
    apiModelLabel: 'Model',
    apiFetchModelsBtn: 'Fetch Primary Models',
    apiSecondarySettings: 'Secondary API Settings (for Summarization)',
    apiSecondaryProxyUrlLabel: 'Secondary Proxy URL',
    apiSecondaryKeyLabel: 'Secondary API Key',
    apiSecondaryModelLabel: 'Secondary Model',
    apiFetchSecondaryModelsBtn: 'Fetch Secondary Models',
    apiTemperatureLabel: 'API Temperature',
    apiBgActivitySettings: 'Background Activity Settings',
    apiEnableBgActivityLabel: 'Enable Background Character Activity',
    apiBgIntervalLabel: 'Background Activity Interval (sec)',
    apiBlockCooldownLabel: 'AI Block Cooldown (hours)',
    apiTtsSettings: 'Voice Message Settings (Minimax TTS)',
    apiTtsModelLabel: 'Voice Model',
    apiPerformanceSettings: 'Performance & Display Settings',
    apiChatListRenderWindowLabel: 'Chat List Batch Load Count',
    apiChatRenderWindowLabel: 'Chat View Initial Load Count',
    apiImageGenSettings: 'Image Generation Settings',
    apiEnableImageGenLabel: 'Enable AI Image Generation',
    apiEnableNovelAILabel: 'Enable NovelAI Image Generation',
    apiNovelAIModelLabel: 'NovelAI Model',
    apiNovelAIKeyLabel: 'NovelAI API Key',
    apiNovelAIGenSettingsBtn: 'Generation Settings',
    apiNovelAITestBtn: 'Test Generation',
    apiStorageOptimization: 'Storage Optimization',
    apiCompressImagesBtn: 'Compress Local Images',
    apiSaveAllBtn: 'Save All Settings',
    apiExportDataBtn: 'Export Data',
    apiImportDataBtn: 'Import Backup File',
    apiCleanupDataBtn: 'Cleanup Redundant Data',
    apiDeleteWorldBooksBtn: 'Delete World Books',
    apiAdvancedCleanupBtn: 'Advanced Data Cleanup',
    apiCheckAndFixDataBtn: 'Data Check & Repair',

    // --- Chat Screen ---
    chatHeaderOnline: 'Online',
    chatHeaderLongTermMemory: 'Long-term Memory',
    chatHeaderListenTogether: 'Listen Together',
    chatHeaderChatSettings: 'Chat Settings',
    chatSelectionCancel: 'Cancel',
    chatSelectionScreenshot: 'Long Screenshot',
    chatSelectionFavorite: 'Favorite',
    chatSelectionShare: 'Share',
    chatSelectionSoftDelete: 'Delete (Notify AI)',
    chatSelectionHardDelete: 'Erase',
    chatReplyTo: 'Reply to',
    chatInputPlaceholder: 'Type a message...',
    chatWaitForReply: 'Wait for Reply',

    // --- Appearance Settings ---
    appearanceTitle: 'Appearance Settings',
    appearanceSaveAll: 'Save All Appearance Settings',

    // --- Font Settings ---
    fontSettingsTitle: 'Font Settings',
    fontPresetManagement: 'Font Preset Management',
    fontFileUrlLabel: 'Font File URL (.ttf, .otf, .woff, etc.)',
    fontPreviewLabel: 'Live Preview',
    fontPreviewText1: 'Hello World ‰Ω†Â•Ω‰∏ñÁïå',
    fontPreviewText2: 'This is a font preview effect, 12345.',
    fontSaveAndApply: 'Save and Apply',
    fontResetDefault: 'Reset to Default Font',

    // --- Renderer ---
    rendererTitle: 'Rendering Rules',
    rendererEditorTitle: 'Edit Rule',
    rendererCreateTitle: 'Create New Rule',
    rendererRuleName: 'Rule Name',
    rendererBindScope: 'Binding Scope',
    rendererScopeGlobal: 'Global (All Characters)',
    rendererRegex: 'Regular Expression (use g flag)',
    rendererHtmlTemplate: 'HTML Template (use $1, $2)',
    rendererEnableRule: 'Enable Rule',

    // --- Others ---
    myAlbumTitle: 'My Albums',
    albumPhotosTitle: 'Album Name',
    npcEditorTitleAdd: 'Add NPC',
    npcEditorTitleEdit: 'Edit NPC',
    npcAvatarLabel: 'NPC Avatar',
    npcUploadAvatar: 'Upload Avatar',
    npcNicknameLabel: 'NPC Nickname',
    npcPersonaLabel: 'NPC Persona',
    npcEnableBgActivity: 'Enable Independent Background Activity',
    npcActionCooldown: 'Independent Action Cooldown (min)',
    npcAssociatedChars: 'Associated Characters (NPC will comment on their moments)',
  
  }
};

let currentLanguage = 'zh-CN';

function setLanguage(lang) {
  if (!translations[lang]) {
    console.warn(`Language "${lang}" not found. Defaulting to 'zh-CN'.`);
    lang = 'zh-CN';
  }
  currentLanguage = lang;
  localStorage.setItem('ephone-language', lang);
  document.documentElement.lang = lang;

  document.querySelectorAll('[data-lang-key]').forEach(el => {
    const key = el.getAttribute('data-lang-key');
    if (translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });

  document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
    const key = el.getAttribute('data-lang-key-placeholder');
    if (translations[lang][key]) {
      el.placeholder = translations[lang][key];
    }
  });

  document.querySelectorAll('[data-lang-key-title]').forEach(el => {
    const key = el.getAttribute('data-lang-key-title');
    if (translations[lang][key]) {
      el.title = translations[lang][key];
    }
  });
}

function initLanguage() {
  const savedLang = localStorage.getItem('ephone-language') || 'zh-CN';
  const langSelector = document.getElementById('language-select');

  if (langSelector) {
    langSelector.value = savedLang;
    langSelector.addEventListener('change', (e) => {
      const newLang = e.target.value;
      alert(translations[newLang].languageChangedAlert);
      localStorage.setItem('ephone-language', newLang);
      setTimeout(() => window.location.reload(), 100);
    });
  }
  setLanguage(savedLang);
}

(function() {
  'use strict';


  function downloadImage(imageSrc, filename) {
    try {
     
      const link = document.createElement('a');
      link.href = imageSrc;
      link.download = filename;
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click(); 

    
      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);

      console.log('‚úÖ [NAI‰∏ãËΩΩ] ÂºÄÂßã‰∏ãËΩΩÂõæÁâá:', filename);

      // ÊòæÁ§∫‰∏ãËΩΩÊèêÁ§∫
      showDownloadToast();
    } catch (error) {
      console.error('‚ùå [NAI‰∏ãËΩΩ] ‰∏ãËΩΩÂ§±Ë¥•:', error);
      showDownloadToast('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
    }
  }

 
  function showDownloadToast(message = 'üì• ÂõæÁâá‰∏ãËΩΩ‰∏≠...', type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : '#f44336'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                pointer-events: none;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s ease;
            `;

    document.body.appendChild(toast);

   
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);

 
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 2000);
  }

 
  function generateFilename(imgElement) {
   
    const title = imgElement.getAttribute('title') || imgElement.getAttribute('alt') || '';

    
    let cleanTitle = title
      .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '_') 
      .replace(/\s+/g, '_')
      .substring(0, 30);

    if (!cleanTitle) {
      cleanTitle = 'NAI_Image';
    }

   
    const timestamp = new Date().toISOString()
      .replace(/[-:]/g, '')
      .replace('T', '_')
      .split('.')[0];

 
    return `${cleanTitle}_${timestamp}.png`;
  }

 
  function addVisualFeedback(imgElement) {
    const originalTransform = imgElement.style.transform || '';
    const originalTransition = imgElement.style.transition || '';

  
    imgElement.style.transition = 'transform 0.15s ease';
    imgElement.style.transform = 'scale(0.95)';

    setTimeout(() => {
      imgElement.style.transform = originalTransform;
      setTimeout(() => {
        imgElement.style.transition = originalTransition;
      }, 150);
    }, 150);
  }
 window.downloadImage = downloadImage;     // Êää‰∏ãËΩΩÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±Ä
  window.generateFilename = generateFilename; // ÊääÊñá‰ª∂ÂêçÁîüÊàêÊö¥Èú≤ÁªôÂÖ®Â±Ä
  window.addVisualFeedback = addVisualFeedback;

  let clickCount = 0;
  let clickTimer = null;
  let lastClickedElement = null;

 
  document.addEventListener('click', function(e) {
    const target = e.target;

    
    if (target.tagName === 'IMG' &&
      (target.classList.contains('realimag-image') ||
        target.classList.contains('naiimag-image'))) {

   
      if (target === lastClickedElement) {
        clickCount++;
      } else {
      
        clickCount = 1;
        lastClickedElement = target;
      }

      // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
      if (clickTimer) {
        clearTimeout(clickTimer);
      }

     
      if (clickCount === 3) {
        
        clickCount = 0;
        lastClickedElement = null;

      
        e.preventDefault();
        e.stopPropagation();

        console.log('üñºÔ∏è [NAI‰∏ãËΩΩ] Ê£ÄÊµãÂà∞‰∏âÂáªNAIÂõæÁâá');

      
        addVisualFeedback(target);

     
        const imageSrc = target.src;

        if (!imageSrc || imageSrc === 'about:blank') {
          console.warn('‚ö†Ô∏è [NAI‰∏ãËΩΩ] ÂõæÁâáÊ∫ê‰∏∫Á©∫ÔºåÊó†Ê≥ï‰∏ãËΩΩ');
          showDownloadToast('ÂõæÁâáÂä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
          return;
        }

      
        const filename = generateFilename(target);

     
        downloadImage(imageSrc, filename);
      } else {
      
        clickTimer = setTimeout(() => {
          clickCount = 0;
          lastClickedElement = null;
        }, 500);
      }
    }
  }, true); 

  console.log('‚úÖ [NAI‰∏ãËΩΩ] ‰∏âÂáª‰∏ãËΩΩÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ');
  console.log('üí° [NAI‰∏ãËΩΩ] ÊèêÁ§∫Ôºö‰∏âÂáª‰ªªÊÑèNAIÂõæÁâáÂç≥ÂèØ‰∏ãËΩΩ');
})();


// Service Worker Ê≥®ÂÜåÔºàÂÜÖËÅîÊñπÂºèÔºåÊîØÊåÅÂêéÂè∞ÈÄöÁü•Ôºâ
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const serviceWorkerCode = `
// Service Worker for Background Notifications
const CACHE_NAME = 'ephone-cache-v1';

// ÂÆâË£Ö Service Worker
self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(function(cache) {
        console.log('Service Worker: ÁºìÂ≠òÂ∑≤ÊâìÂºÄ');
        return cache.addAll(['/']);
      })
  );
  self.skipWaiting(); // Á´ãÂç≥ÊøÄÊ¥ª
});

// ÊøÄÊ¥ª Service Worker
self.addEventListener('activate', function(event) {
  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if (cacheName !== CACHE_NAME) {
            console.log('Service Worker: Âà†Èô§ÊóßÁºìÂ≠ò', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
  return self.clients.claim(); // Á´ãÂç≥ÊéßÂà∂ÊâÄÊúâÂÆ¢Êà∑Á´Ø
});

// Â§ÑÁêÜÊé®ÈÄÅÈÄöÁü•
self.addEventListener('push', function(event) {
  console.log('Service Worker: Êî∂Âà∞Êé®ÈÄÅÈÄöÁü•', event);
  
  let data = {};
  if (event.data) {
    try {
      data = event.data.json();
    } catch (e) {
      data = { title: 'ÈÄöÁü•', body: event.data.text() || 'ÊÇ®ÊúâÊñ∞ÁöÑÊ∂àÊÅØ' };
    }
  } else {
    data = { title: 'ÈÄöÁü•', body: 'ÊÇ®ÊúâÊñ∞ÁöÑÊ∂àÊÅØ' };
  }

  const options = {
    body: data.body || 'ÊÇ®ÊúâÊñ∞ÁöÑÊ∂àÊÅØ',
    icon: data.icon || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
    badge: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
    tag: data.tag || 'notification',
    requireInteraction: data.requireInteraction || false,
    data: data.data || {}
  };

  event.waitUntil(
    self.registration.showNotification(data.title || 'ÈÄöÁü•', options)
  );
});

// Â§ÑÁêÜÈÄöÁü•ÁÇπÂáª
self.addEventListener('notificationclick', function(event) {
  console.log('Service Worker: ÈÄöÁü•Ë¢´ÁÇπÂáª', event);
  
  const notification = event.notification;
  const chatId = notification.data && notification.data.chatId;
  
  notification.close();
  
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then(function(clientList) {
      // ‰ºòÂÖàÊü•ÊâæÂ∑≤ÊâìÂºÄÁöÑÁ™óÂè£
      for (let i = 0; i < clientList.length; i++) {
        const client = clientList[i];
        // Âè™Ë¶ÅÊòØÁ™óÂè£ÔºåÂ∞ùËØïËÅöÁÑ¶
        if ('focus' in client) {
          return client.focus().then(focusedClient => {
            // ËÅöÁÑ¶ÊàêÂäüÂêéÔºåÂèëÈÄÅÊ∂àÊÅØÈÄöÁü•È°µÈù¢ÊâìÂºÄÁâπÂÆöËÅäÂ§©
            if (chatId && focusedClient) {
               focusedClient.postMessage({
                 type: 'OPEN_CHAT',
                 chatId: chatId
               });
            }
            return focusedClient;
          });
        }
      }
      
      // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Á™óÂè£ÔºåÂ∞ùËØïÊâìÂºÄÊñ∞Á™óÂè£ (Ê≥®ÊÑèÔºöÂú® Blob URL ‰∏ã openWindow ÂèØËÉΩ‰ºöÂèóÈôêÊàñÊâìÂºÄÈîôËØØÁöÑË∑ØÂæÑ)
      // ‰ΩÜÊàë‰ª¨Â∞ΩÂäõÂ∞ùËØïÊâìÂºÄÈ¶ñÈ°µ
      if (clients.openWindow) {
        return clients.openWindow('/').then(newClient => {
            // Êñ∞Á™óÂè£ÊâìÂºÄÂêéÔºåÂèØËÉΩÈúÄË¶Å‰∏ÄÁÇπÊó∂Èó¥Âä†ËΩΩÊâçËÉΩÊé•Êî∂ postMessage
            // ËøôÈáåÂè™ËÉΩÂ∞ΩÂäõËÄå‰∏∫ÔºåÊàñËÄÖ‰æùËµñÈ°µÈù¢Âä†ËΩΩÊó∂ÁöÑÂàùÂßãÂåñÈÄªËæëÔºà‰æãÂ¶ÇËØªÂèñ URL ÂèÇÊï∞Ôºå‰ΩÜ Blob SW ÂæàÈöæ‰º†ÈÄí URL ÂèÇÊï∞Ôºâ
            return newClient;
        });
      }
    })
  );
});

// Â§ÑÁêÜÊ∂àÊÅØ‰º†ÈÄíÔºà‰ªé‰∏ªÁ∫øÁ®ãÂèëÈÄÅÈÄöÁü•Ôºâ
self.addEventListener('message', function(event) {
  // console.log('Service Worker: Êî∂Âà∞Ê∂àÊÅØ', event.data);
  
  if (event.data && event.data.type === 'SHOW_NOTIFICATION') {
    const notificationData = event.data.data;
    const options = {
      body: notificationData.body || '',
      icon: notificationData.icon || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
      badge: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
      tag: notificationData.tag || 'chat-notification',
      requireInteraction: false,
      vibrate: [200, 100, 200],
      data: notificationData.data || {}
    };
    
    event.waitUntil(
      self.registration.showNotification(notificationData.title || 'Êñ∞Ê∂àÊÅØ', options)
    );
  }
});
`;
    
    const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
    const serviceWorkerUrl = URL.createObjectURL(blob);
    
    navigator.serviceWorker.register(serviceWorkerUrl)
      .then(registration => {
        console.log('‚úÖ Service Worker Ê≥®ÂÜåÊàêÂäü:', registration.scope);
        
        // ÁõëÂê¨Êù•Ëá™ Service Worker ÁöÑÊ∂àÊÅØ
        navigator.serviceWorker.addEventListener('message', event => {
          console.log('Êî∂Âà∞ Service Worker Ê∂àÊÅØ:', event.data);
          
          // Â§ÑÁêÜÊâìÂºÄËÅäÂ§©ÁöÑÊåá‰ª§
          if (event.data && event.data.type === 'OPEN_CHAT' && event.data.chatId) {
              console.log('ÊâßË°åÊâìÂºÄËÅäÂ§©:', event.data.chatId);
              // Á°Æ‰øù openChat ÂáΩÊï∞Â≠òÂú®
              if (typeof openChat === 'function') {
                  openChat(event.data.chatId);
              }
          }
        });
      })
      .catch(error => {
        console.error('‚ùå Service Worker Ê≥®ÂÜåÂ§±Ë¥•:', error);
      });
  });
}

if (!Array.prototype.findLastIndex) {
  Object.defineProperty(Array.prototype, 'findLastIndex', {
    value: function(predicate) {
      if (this == null) {
        throw new TypeError('Cannot read property \'findLastIndex\' of null or undefined');
      }
      if (typeof predicate !== 'function') {
        throw new TypeError('predicate must be a function');
      }
      let o = Object(this);
      let len = o.length >>> 0;
      let thisArg = arguments[1];
      let k = len - 1;
      while (k >= 0) {
        let kValue = o[k];
        if (predicate.call(thisArg, kValue, k, o)) {
          return k;
        }
        k--;
      }
      return -1;
    },
    configurable: true,
    writable: true
  });
}

// ========== ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÔºà‰ªéÂñµÂëú34.htmlÁßªÊ§çÔºâ==========
// ÂàõÂª∫ÈùôÈü≥Èü≥È¢ëÂÖÉÁ¥†
const silentAudio = document.createElement('audio');
silentAudio.id = 'silent-audio-player';
silentAudio.loop = true;
silentAudio.preload = 'auto';
silentAudio.style.display = 'none';
silentAudio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknE0PDlCo4/C2YxwGOJHX8sx5LAUkd8fw3ZBACxRes+nrqFUUCkaf4PK+bCEFK4HO8tmJNggbab3w5JxNDw5QqOPwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTQ8OUKjj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRQ==';
document.body.appendChild(silentAudio);

// ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªü
const BackgroundSystem = {
    heartbeat: {
        baseInterval: 30000,      // Âü∫ÂáÜÂøÉË∑≥Èó¥ÈöîÔºö30Áßí
        jitterRange: 10000,       // ÈöèÊú∫ÊäñÂä®ËåÉÂõ¥Ôºö¬±10Áßí
        timeoutId: null,
        isRunning: false,
        lastBeat: Date.now(),
        beatCount: 0
    },
    audio: {
        context: null,
        source: null,
        gainNode: null,
        isActive: false
    },
    state: {
        isBackground: document.hidden,
        lastActivity: Date.now(),
        networkOnline: navigator.onLine
    }
};

// ËÆ°ÁÆóÂ∏¶ÈöèÊú∫ÊäñÂä®ÁöÑ‰∏ãÊ¨°ÂøÉË∑≥Èó¥Èöî
function getNextHeartbeatInterval() {
    const { baseInterval, jitterRange } = BackgroundSystem.heartbeat;
    const jitter = Math.random() * jitterRange * 2 - jitterRange;
    const interval = baseInterval + jitter;
    return Math.max(15000, Math.min(60000, interval));
}

// ÊâßË°å‰∏ÄÊ¨°ÂøÉË∑≥
function performHeartbeat() {
    const now = Date.now();
    BackgroundSystem.heartbeat.lastBeat = now;
    BackgroundSystem.heartbeat.beatCount++;
    
    const state = {
        timestamp: now,
        isBackground: document.hidden,
        beatCount: BackgroundSystem.heartbeat.beatCount,
        networkOnline: navigator.onLine
    };
    
    try {
        localStorage.setItem('app_heartbeat', JSON.stringify(state));
    } catch (e) {
        console.warn('ÂøÉË∑≥Áä∂ÊÄÅÂ≠òÂÇ®Â§±Ë¥•:', e);
    }
    
    console.log(`üíì ÂêéÂè∞ÂøÉË∑≥ #${state.beatCount} | ‰∏ãÊ¨°Èó¥Èöî: ${getNextHeartbeatInterval() / 1000}Áßí`);
    
    scheduleNextHeartbeat();
}

// Ë∞ÉÂ∫¶‰∏ãÊ¨°ÂøÉË∑≥
function scheduleNextHeartbeat() {
    if (BackgroundSystem.heartbeat.timeoutId) {
        clearTimeout(BackgroundSystem.heartbeat.timeoutId);
    }
    
    const interval = getNextHeartbeatInterval();
    
    BackgroundSystem.heartbeat.timeoutId = setTimeout(() => {
        performHeartbeat();
    }, interval);
}

// ÂêØÂä®ÂøÉË∑≥Á≥ªÁªü
function startHeartbeat() {
    if (BackgroundSystem.heartbeat.isRunning) {
        console.log('ÂøÉË∑≥Â∑≤Âú®ËøêË°å‰∏≠');
        return;
    }
    
    BackgroundSystem.heartbeat.isRunning = true;
    console.log('üöÄ ÂêØÂä®ÂêéÂè∞ÂøÉË∑≥Á≥ªÁªüÔºàÈöèÊú∫ÊäñÂä®Ê®°ÂºèÔºâ');
    performHeartbeat();
}

// ÂÅúÊ≠¢ÂøÉË∑≥Á≥ªÁªü
function stopHeartbeat() {
    if (!BackgroundSystem.heartbeat.isRunning) {
        return;
    }
    
    if (BackgroundSystem.heartbeat.timeoutId) {
        clearTimeout(BackgroundSystem.heartbeat.timeoutId);
        BackgroundSystem.heartbeat.timeoutId = null;
    }
    
    BackgroundSystem.heartbeat.isRunning = false;
    console.log('‚èπÔ∏è ÂÅúÊ≠¢ÂêéÂè∞ÂøÉË∑≥Á≥ªÁªü');
}

// ÂàùÂßãÂåñÈü≥È¢ë‰øùÊ¥ª
function initAudioKeepAlive() {
    if (BackgroundSystem.audio.context) {
        return true;
    }
    
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        BackgroundSystem.audio.context = new AudioContext();
        
        const sampleRate = BackgroundSystem.audio.context.sampleRate;
        const buffer = BackgroundSystem.audio.context.createBuffer(1, sampleRate * 0.1, sampleRate);
        
        const source = BackgroundSystem.audio.context.createBufferSource();
        source.buffer = buffer;
        source.loop = true;
        
        const gainNode = BackgroundSystem.audio.context.createGain();
        gainNode.gain.value = 0;
        
        source.connect(gainNode);
        gainNode.connect(BackgroundSystem.audio.context.destination);
        
        BackgroundSystem.audio.source = source;
        BackgroundSystem.audio.gainNode = gainNode;
        
        console.log('‚úÖ Èü≥È¢ë‰∏ä‰∏ãÊñáÂàùÂßãÂåñÊàêÂäü');
        return true;
    } catch (error) {
        console.warn('‚ùå Èü≥È¢ë‰∏ä‰∏ãÊñáÂàùÂßãÂåñÂ§±Ë¥•:', error);
        return false;
    }
}

// ÂêØÂä®Èü≥È¢ë‰øùÊ¥ª
function startAudioKeepAlive() {
    if (BackgroundSystem.audio.isActive) {
        return;
    }
    
    // Â∞ùËØï‰ΩøÁî®Web Audio API
    if (initAudioKeepAlive()) {
        try {
            const { context, source } = BackgroundSystem.audio;
            
            if (context.state === 'suspended') {
                context.resume();
            }
            
            source.start(0);
            BackgroundSystem.audio.isActive = true;
            console.log('‚úÖ Web Audio API‰øùÊ¥ªÂ∑≤ÂêØÂä®');
            return;
        } catch (error) {
            console.warn('Web Audio APIÂêØÂä®Â§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî®HTML5Èü≥È¢ë:', error);
        }
    }
    
    // ÈôçÁ∫ßÂà∞HTML5Èü≥È¢ë
    try {
        silentAudio.volume = 0;
        silentAudio.play().then(() => {
            console.log('‚úÖ HTML5Èü≥È¢ë‰øùÊ¥ªÂ∑≤ÂêØÂä®');
        }).catch(error => {
            console.warn('HTML5Èü≥È¢ëÂêØÂä®Â§±Ë¥•:', error);
        });
    } catch (error) {
        console.warn('Èü≥È¢ë‰øùÊ¥ªÂêØÂä®Â§±Ë¥•:', error);
    }
}

// ÂÅúÊ≠¢Èü≥È¢ë‰øùÊ¥ª
function stopAudioKeepAlive() {
    if (BackgroundSystem.audio.isActive && BackgroundSystem.audio.source) {
        try {
            BackgroundSystem.audio.source.stop();
            BackgroundSystem.audio.isActive = false;
            console.log('‚èπÔ∏è Web Audio API‰øùÊ¥ªÂ∑≤ÂÅúÊ≠¢');
        } catch (error) {
            console.warn('ÂÅúÊ≠¢Web Audio APIÂ§±Ë¥•:', error);
        }
    }
    
    try {
        silentAudio.pause();
        silentAudio.currentTime = 0;
    } catch (error) {
        console.warn('ÂÅúÊ≠¢HTML5Èü≥È¢ëÂ§±Ë¥•:', error);
    }
}

// ÂêØÂä®‰øùÊ¥ªÁ≥ªÁªü
function startKeepAlive() {
    if (Notification.permission !== 'granted') {
        console.warn('ÈÄöÁü•ÊùÉÈôêÊú™Êéà‰∫àÔºåÊó†Ê≥ïÂêØÂä®‰øùÊ¥ª');
        return;
    }
    
    startHeartbeat();
    startAudioKeepAlive();
    localStorage.setItem('enable_background_system', 'true');
    console.log('‚úÖ ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÂ∑≤ÂêØÂä®');
}

// ÂÅúÊ≠¢‰øùÊ¥ªÁ≥ªÁªü
function stopKeepAlive() {
    stopHeartbeat();
    stopAudioKeepAlive();
    localStorage.setItem('enable_background_system', 'false');
    console.log('‚èπÔ∏è ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÂ∑≤ÂÅúÊ≠¢');
}

// ÂêØÂä®ÂêéÂè∞Á≥ªÁªüÔºàÂè™ÂêØÂä®‰∏ÄÊ¨°Ôºâ
function startBackgroundOnce() {
    if (window.__backgroundStarted) return;
    window.__backgroundStarted = true;

    if (typeof initAudioKeepAlive === 'function') {
        initAudioKeepAlive();
    }

    if (Notification.permission === 'granted') {
        if (typeof startKeepAlive === 'function') {
            startKeepAlive();
        }
    }
}

// ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
document.addEventListener('visibilitychange', () => {
    BackgroundSystem.state.isBackground = document.hidden;
    
    const isEnabled = localStorage.getItem('enable_background_system') === 'true';
    if (isEnabled && Notification.permission === 'granted') {
        if (document.hidden) {
            console.log('È°µÈù¢ÂàáÂà∞ÂêéÂè∞Ôºå‰øùÊ¥ªÁ≥ªÁªüÁªßÁª≠ËøêË°å');
        } else {
            console.log('È°µÈù¢ÂàáÂà∞ÂâçÂè∞');
        }
    }
});
// ========== ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÁªìÊùü ==========

const dynamicIslandContent = document.getElementById('dynamic-island-content');
const islandAlbumArt = document.getElementById('island-album-art');
const islandLyricContainer = document.getElementById('island-lyric-container');
const islandLyricText = document.getElementById('island-lyric-text');
const phoneScreenForIsland = document.getElementById('phone-screen');

let activeMessageTimestamp = null;
let activeTransferTimestamp = null;

let lastRawAiResponse = '';
let lastResponseTimestamps = [];
let lastPrivateMessagesSent = [];
let lastGroupMessagesSent = [];
let currentQzoneReplyContext = null;
let editingNpcId = null;
let pendingBackupData = null;
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models'
function findBestStickerMatch(meaning, availableStickers) {
  if (!meaning || !availableStickers || availableStickers.length === 0) {
    return null;
  }

  const SIMILARITY_THRESHOLD = 0.7; 
  const candidates = []; 
  let highestScore = 0;

  const getTokens = (str) => [...new Set(str.replace(/\s+/g, ''))];
  const meaningTokens = getTokens(meaning);

  availableStickers.forEach(sticker => {
    if (!sticker.name) return;

    const stickerNameTokens = getTokens(sticker.name);
    const intersection = stickerNameTokens.filter(token => meaningTokens.includes(token));
    // Jaccard Similarity Score
    const score = intersection.length / (stickerNameTokens.length + meaningTokens.length - intersection.length);

    
    if (score > highestScore) {
      highestScore = score;
    }

    
    if (score >= SIMILARITY_THRESHOLD) {
      candidates.push({ sticker, score });
    }
  });

  if (candidates.length > 0) {
  
    const bestCandidates = candidates.filter(c => c.score === highestScore);
    
    
    const randomIndex = Math.floor(Math.random() * bestCandidates.length);
    const chosenSticker = bestCandidates[randomIndex].sticker;
    
    console.log(`[Ê®°Á≥äÈöèÊú∫ÂåπÈÖçÊàêÂäü] AIÂê´‰πâ: "${meaning}", ÂåπÈÖçÂà∞ ${bestCandidates.length} ‰∏™ÊúÄ‰Ω≥ÈÄâÈ°π, ÈöèÊú∫ÈÄâ‰∏≠: "${chosenSticker.name}", Áõ∏‰ººÂ∫¶: ${highestScore.toFixed(2)}`);
    return chosenSticker;
  }

  console.log(`[Ê®°Á≥äÈöèÊú∫ÂåπÈÖçÂ§±Ë¥•] AIÂê´‰πâ: "${meaning}", ÊúÄÈ´òÁõ∏‰ººÂ∫¶‰∏∫ ${highestScore.toFixed(2)}ÔºåÊú™ËææÂà∞ÈòàÂÄº ${SIMILARITY_THRESHOLD}„ÄÇ`);
  return null;
}
function getRandomValue(str) {

  if (str.includes(',')) {

    const arr = str.split(',').map(item => item.trim());

    const randomIndex = Math.floor(Math.random() * arr.length);

    return arr[randomIndex];
  }

  return str;
}

function isImage(content) {
  if (content.image_url && content.image_url.url) {
    let currentImageData = content.image_url.url

    const base64Data = currentImageData.split(',')[1];

    const mimeType = currentImageData.match(/^data:(.*);base64/)[1];
    return [{
        text: 'Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá'
      },
      {
        inline_data: {
          mime_type: mimeType,
          data: base64Data
        }
      }
    ]
  }
  return []
}



function getGeminiResponseText(data) {

 
  if (data.choices && Array.isArray(data.choices) && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
    return data.choices[0].message.content;
  }


  if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
    return data.candidates[0].content.parts[0].text;
  }

 
  console.error("APIËøîÂõû‰∫ÜÈùûÈ¢ÑÊúüÁöÑÊ†ºÂºè:", data);
  let errorReason = "AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπÊàñÊú™Áü•Ê†ºÂºè„ÄÇ";

 
  if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0 && data.candidates[0].finishReason === 'SAFETY') {
    const safetyRatings = data.candidates[0].safetyRatings;
    const blockedCategories = safetyRatings
      .filter(r => r.probability !== 'NEGLIGIBLE' && r.probability !== 'LOW')
      .map(r => `${r.category} (Ê¶ÇÁéá: ${r.probability})`)
      .join(', ');
    errorReason = `ÂÜÖÂÆπÂõ†ÂÆâÂÖ®Á≠ñÁï•Ë¢´Â±èËîΩ„ÄÇËß¶ÂèëÁ±ªÂà´: ${blockedCategories || 'Êú™Áü•'}`;
  } 
  
  else if (data.promptFeedback?.blockReason) {
    const reason = data.promptFeedback.blockReason;
    const details = data.promptFeedback.safetyRatings?.map(r => `${r.category}: ${r.probability}`).join(', ');
    errorReason = `ÂÜÖÂÆπÂõ†ÂÆâÂÖ®Á≠ñÁï•Ë¢´Â±èËîΩ (ÂéüÂõ†: ${reason})„ÄÇËØ¶ÊÉÖ: ${details || 'Êó†'}`;
  } 
  
  else if (data.error?.message) { 
    errorReason = `APIÈîôËØØ: ${data.error.message}`;
  } 
 
  else if (data.message) { 
    errorReason = `APIÈîôËØØ: ${data.message}`;
  }

  else if (data.detail) {
    errorReason = `APIÈîôËØØ: ${data.detail}`;
  }
 
  else if (data.error && typeof data.error === 'string') {
      errorReason = `APIÈîôËØØ: ${data.error}`;
  }

  throw new Error(errorReason);
}


document.addEventListener('DOMContentLoaded', () => {

 // ËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°ÂäüËÉΩ
 const videoCallAvatarToggle = document.getElementById('video-call-avatar-toggle');
 const videoCallAvatarConfig = document.getElementById('video-call-avatar-config');
 const aiVideoCallImageInput = document.getElementById('ai-video-call-image-input');
 const myVideoCallImageInput = document.getElementById('my-video-call-image-input');
 const aiVideoCallImagePreview = document.getElementById('ai-video-call-image-preview');
 const myVideoCallImagePreview = document.getElementById('my-video-call-image-preview');

 // ÂºÄÂÖ≥ÂàáÊç¢
 if (videoCallAvatarToggle) {
   videoCallAvatarToggle.addEventListener('change', async function() {
     const chatId = state.activeChatId;
     if (!chatId) return;
     
     if (this.checked) {
       videoCallAvatarConfig.style.display = 'block';
     } else {
       videoCallAvatarConfig.style.display = 'none';
     }
     
     // ‰øùÂ≠òÂà∞DexieÂíåstate
     const chat = await db.chats.get(chatId);
     if (chat) {
       if (!chat.settings.videoCallAvatar) {
         chat.settings.videoCallAvatar = {};
       }
       chat.settings.videoCallAvatar.enabled = this.checked;
       await db.chats.put(chat);
       
       // ÂêåÊ≠•Âà∞state
       if (state.chats[chatId]) {
         if (!state.chats[chatId].settings.videoCallAvatar) {
           state.chats[chatId].settings.videoCallAvatar = {};
         }
         state.chats[chatId].settings.videoCallAvatar.enabled = this.checked;
       }
       
       console.log('ËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°ÂºÄÂÖ≥Â∑≤‰øùÂ≠ò:', this.checked);
     }
   });
 }

 // ‰∏ä‰º†ÂØπÊñπÂΩ¢Ë±°
 if (aiVideoCallImageInput) {
   aiVideoCallImageInput.addEventListener('change', async function(e) {
     const file = e.target.files[0];
     if (file) {
       const reader = new FileReader();
       reader.onload = async function(event) {
         const imageData = event.target.result;
         aiVideoCallImagePreview.innerHTML = `<img src="${imageData}" alt="ÂØπÊñπÂΩ¢Ë±°">`;
         
         // ‰øùÂ≠òÂà∞DexieÂíåstate
         const chatId = state.activeChatId;
         if (chatId) {
           const chat = await db.chats.get(chatId);
           if (chat) {
             if (!chat.settings.videoCallAvatar) {
               chat.settings.videoCallAvatar = {};
             }
             chat.settings.videoCallAvatar.aiImage = imageData;
             await db.chats.put(chat);
             
             // ÂêåÊ≠•Âà∞state
             if (state.chats[chatId]) {
               if (!state.chats[chatId].settings.videoCallAvatar) {
                 state.chats[chatId].settings.videoCallAvatar = {};
               }
               state.chats[chatId].settings.videoCallAvatar.aiImage = imageData;
             }
             
             console.log('ÂØπÊñπËßÜÈ¢ëÂΩ¢Ë±°Â∑≤‰øùÂ≠ò');
           }
         }
       };
       reader.readAsDataURL(file);
     }
   });
 }

 // ‰∏ä‰º†ÊàëÁöÑÂΩ¢Ë±°
 if (myVideoCallImageInput) {
   myVideoCallImageInput.addEventListener('change', async function(e) {
     const file = e.target.files[0];
     if (file) {
       const reader = new FileReader();
       reader.onload = async function(event) {
         const imageData = event.target.result;
         myVideoCallImagePreview.innerHTML = `<img src="${imageData}" alt="ÊàëÁöÑÂΩ¢Ë±°">`;
         
         // ‰øùÂ≠òÂà∞DexieÂíåstate
         const chatId = state.activeChatId;
         if (chatId) {
           const chat = await db.chats.get(chatId);
           if (chat) {
             if (!chat.settings.videoCallAvatar) {
               chat.settings.videoCallAvatar = {};
             }
             chat.settings.videoCallAvatar.myImage = imageData;
             await db.chats.put(chat);
             
             // ÂêåÊ≠•Âà∞state
             if (state.chats[chatId]) {
               if (!state.chats[chatId].settings.videoCallAvatar) {
                 state.chats[chatId].settings.videoCallAvatar = {};
               }
               state.chats[chatId].settings.videoCallAvatar.myImage = imageData;
             }
             
             console.log('ÊàëÁöÑËßÜÈ¢ëÂΩ¢Ë±°Â∑≤‰øùÂ≠ò');
           }
         }
       };
       reader.readAsDataURL(file);
     }
   });
 }

 // ÁªëÂÆöÂæÆ‰ø°È£éÊ†ºÊåâÈíÆ‰∫ã‰ª∂
 const wechatSpeakBtn = document.getElementById('wechat-speak-btn');
 const wechatHangUpBtn = document.getElementById('wechat-hang-up-btn');
 const wechatRegenerateBtn = document.getElementById('wechat-regenerate-btn');
 const wechatCameraBtn = document.getElementById('wechat-camera-btn');

 if (wechatSpeakBtn) {
   wechatSpeakBtn.addEventListener('click', () => {
     document.getElementById('user-speak-btn').click();
   });
 }

 if (wechatHangUpBtn) {
   wechatHangUpBtn.addEventListener('click', () => {
     document.getElementById('hang-up-btn').click();
   });
 }

 if (wechatRegenerateBtn) {
   wechatRegenerateBtn.addEventListener('click', () => {
     document.getElementById('regenerate-call-btn').click();
   });
 }

 // ÊëÑÂÉèÂ§¥ÂäüËÉΩ
 let cameraStream = null;
 let isCameraActive = false;

 if (wechatCameraBtn) {
   wechatCameraBtn.addEventListener('click', async () => {
     if (!isCameraActive) {
       // ÊâìÂºÄÊëÑÂÉèÂ§¥
       try {
         const stream = await navigator.mediaDevices.getUserMedia({ 
           video: { 
             width: { ideal: 1280 }, 
             height: { ideal: 720 } 
           } 
         });
         
         cameraStream = stream;
         const video = document.getElementById('wechat-camera-video');
         video.srcObject = stream;
         
         // Á≠âÂæÖËßÜÈ¢ëÂä†ËΩΩ
         await new Promise(resolve => {
           video.onloadedmetadata = () => {
             video.play();
             resolve();
           };
         });
         
         // ÊòæÁ§∫ÊëÑÂÉèÂ§¥ÁîªÈù¢Âú®Â∞èÁ™óÂè£
         const wechatMyImage = document.getElementById('wechat-my-video-image');
         if (wechatMyImage) {
           wechatMyImage.style.display = 'none';
         }
         
         const wechatSmallVideo = document.getElementById('wechat-small-video');
         if (wechatSmallVideo) {
           // ÁßªÈô§videoÂÖÉÁ¥†‰πãÂâçÁöÑÁà∂ÂÖÉÁ¥†ÂºïÁî®
           if (video.parentElement && video.parentElement !== wechatSmallVideo) {
             video.remove();
           }
           
           video.style.position = 'absolute';
           video.style.top = '0';
           video.style.left = '0';
           video.style.display = 'block';
           video.style.width = '100%';
           video.style.height = '100%';
           video.style.objectFit = 'cover';
           video.style.transform = 'scaleX(-1)'; // ÈïúÂÉèÊòæÁ§∫
           wechatSmallVideo.appendChild(video);
         }
         
         // ÊøÄÊ¥ªÊåâÈíÆ
         wechatCameraBtn.classList.add('active');
         isCameraActive = true;
         
         console.log('‚úÖ ÊëÑÂÉèÂ§¥Â∑≤ÂºÄÂêØÔºåÂèëÈÄÅÊ∂àÊÅØÊó∂‰ºöÊà™ÂèñÂΩìÂâçÁîªÈù¢ÂèëÈÄÅÁªôAI');
         
       } catch (error) {
         console.error('‚ùå ÊëÑÂÉèÂ§¥ÊùÉÈôêË¢´ÊãíÁªùÊàñÂá∫Èîô:', error);
         alert('Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ„ÄÇ');
       }
     } else {
       // ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥
       stopCamera();
     }
   });
 }

 // Á´ãÂç≥Êà™ÂèñÂΩìÂâçÁîªÈù¢
 window.captureCurrentFrame = function() {
   if (!isCameraActive || !cameraStream) {
     console.log('‚ö†Ô∏è ÊëÑÂÉèÂ§¥Êú™ÊøÄÊ¥ª');
     return null;
   }
   
   const video = document.getElementById('wechat-camera-video');
   const canvas = document.getElementById('wechat-camera-canvas');
   
   if (!video || !canvas) {
     console.error('‚ùå Êâæ‰∏çÂà∞videoÊàñcanvasÂÖÉÁ¥†');
     return null;
   }
   
   const ctx = canvas.getContext('2d');
   
   // ËÆæÁΩÆcanvasÂ∞∫ÂØ∏
   canvas.width = video.videoWidth;
   canvas.height = video.videoHeight;
   
   if (canvas.width === 0 || canvas.height === 0) {
     console.error('‚ùå ËßÜÈ¢ëÂ∞∫ÂØ∏‰∏∫0ÔºåÂèØËÉΩËøòÊú™Âä†ËΩΩ');
     return null;
   }
   
   console.log('üì∏ Êà™ÂèñÂΩìÂâçÁîªÈù¢ÔºåËßÜÈ¢ëÂ∞∫ÂØ∏:', video.videoWidth, 'x', video.videoHeight);
   
   // ÁªòÂà∂ÂΩìÂâçÂ∏ß
   ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
   
   // ËΩ¨Êç¢‰∏∫base64
   const imageData = canvas.toDataURL('image/jpeg', 0.8);
   
   console.log('‚úÖ Êà™ÂõæÂÆåÊàêÔºåÊï∞ÊçÆÂ§ßÂ∞è:', (imageData.length / 1024).toFixed(2), 'KB');
   
   return {
     imageData: imageData,
     timestamp: Date.now()
   };
 };

 // ÂÅúÊ≠¢ÊëÑÂÉèÂ§¥
 function stopCamera() {
   if (cameraStream) {
     cameraStream.getTracks().forEach(track => track.stop());
     cameraStream = null;
   }
   
   const video = document.getElementById('wechat-camera-video');
   if (video) {
     video.srcObject = null;
     video.style.display = 'none';
     
     // ‰ªéÂ∞èÁ™óÂè£ÁßªÈô§ËßÜÈ¢ëÂÖÉÁ¥†
     if (video.parentElement && video.parentElement.id === 'wechat-small-video') {
       video.remove();
       // ÈáçÊñ∞Ê∑ªÂä†Âà∞body‰∏≠‰ª•‰æø‰∏ãÊ¨°‰ΩøÁî®
       document.body.appendChild(video);
     }
   }
   
   // ÊÅ¢Â§çÈùôÊÄÅÂõæÁâá
   const wechatMyImage = document.getElementById('wechat-my-video-image');
   if (wechatMyImage) {
     wechatMyImage.style.display = 'block';
   }
   
   const wechatCameraBtn = document.getElementById('wechat-camera-btn');
   if (wechatCameraBtn) {
     wechatCameraBtn.classList.remove('active');
   }
   
   isCameraActive = false;
   console.log('üì∑ ÊëÑÂÉèÂ§¥Â∑≤ÂÖ≥Èó≠ÔºåÂ∑≤Ê∏ÖÁ©∫Êú™‰ΩøÁî®ÁöÑÊà™Âõæ');
 }

 // ÊåÇÊñ≠ÁîµËØùÊó∂Ëá™Âä®ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥
 window.stopCameraOnHangup = stopCamera;

 // Âä†ËΩΩËßÜÈ¢ëÈÄöËØùËÆæÁΩÆ
 window.loadVideoCallSettings = async function(chatId) {
   if (!chatId) return null;
   
   const chat = await db.chats.get(chatId);
   if (!chat) return null;
   
   const settings = chat.settings.videoCallAvatar || { enabled: false, aiImage: '', myImage: '' };
   
   if (videoCallAvatarToggle) {
     videoCallAvatarToggle.checked = settings.enabled || false;
     videoCallAvatarConfig.style.display = settings.enabled ? 'block' : 'none';
   }
   
   if (settings.aiImage && aiVideoCallImagePreview) {
     aiVideoCallImagePreview.innerHTML = `<img src="${settings.aiImage}" alt="ÂØπÊñπÂΩ¢Ë±°">`;
   } else if (aiVideoCallImagePreview) {
     aiVideoCallImagePreview.innerHTML = '<span style="color: #999; font-size: 13px;">ÁÇπÂáª‰∏ä‰º†ÊåâÈíÆÊ∑ªÂä†ÂõæÁâá</span>';
   }
   
   if (settings.myImage && myVideoCallImagePreview) {
     myVideoCallImagePreview.innerHTML = `<img src="${settings.myImage}" alt="ÊàëÁöÑÂΩ¢Ë±°">`;
   } else if (myVideoCallImagePreview) {
     myVideoCallImagePreview.innerHTML = '<span style="color: #999; font-size: 13px;">ÁÇπÂáª‰∏ä‰º†ÊåâÈíÆÊ∑ªÂä†ÂõæÁâá</span>';
   }
   
   return settings;
 };

 document.getElementById('user-city-search-btn').addEventListener('click', async () => {
    const query = document.getElementById('user-real-city-search').value.trim();
    if(!query) return alert("ËØ∑ËæìÂÖ•ÁúüÂÆûÂüéÂ∏ÇÊãºÈü≥ÊàñËã±ÊñáÂêçÁß∞");
    
    const result = await searchCityGeo(query);
    if (result) {
        document.getElementById('user-city-lat').value = result.latitude;
        document.getElementById('user-city-lon').value = result.longitude;
        document.getElementById('user-city-result').textContent = `Â∑≤ÈÄâ‰∏≠: ${result.name}, ${result.country} (${result.latitude}, ${result.longitude})`;
        document.getElementById('user-city-result').style.color = 'green';
        // ÂèØ‰ª•Âú® dataset ÊöÇÂ≠òÁúüÂÆûÂüéÂ∏ÇÂêç
        document.getElementById('user-real-city-search').dataset.realName = result.name;
    } else {
        alert("Êú™ÊâæÂà∞ËØ•ÂüéÂ∏ÇÔºåËØ∑Â∞ùËØï‰ΩøÁî®ÊãºÈü≥ÊàñËã±Êñá (Â¶Ç Shanghai)„ÄÇ");
    }
});

document.getElementById('char-city-search-btn').addEventListener('click', async () => {
    const query = document.getElementById('char-real-city-search').value.trim();
    if(!query) return alert("ËØ∑ËæìÂÖ•ÁúüÂÆûÂüéÂ∏ÇÊãºÈü≥ÊàñËã±ÊñáÂêçÁß∞");
    
    const result = await searchCityGeo(query);
    if (result) {
        document.getElementById('char-city-lat').value = result.latitude;
        document.getElementById('char-city-lon').value = result.longitude;
        document.getElementById('char-city-result').textContent = `Â∑≤ÈÄâ‰∏≠: ${result.name}, ${result.country} (${result.latitude}, ${result.longitude})`;
        document.getElementById('char-city-result').style.color = 'green';
        document.getElementById('char-real-city-search').dataset.realName = result.name;
    } else {
        alert("Êú™ÊâæÂà∞ËØ•ÂüéÂ∏ÇÔºåËØ∑Â∞ùËØï‰ΩøÁî®ÊãºÈü≥ÊàñËã±Êñá (Â¶Ç New York)„ÄÇ");
    }
});
  const PREFILLED_SALT = "bu_wan_jiu_guan_bu_yao_huo_qu";


  async function generatePin(deviceId, salt) {
    if (!deviceId || !salt) {
      throw new Error("ËÆæÂ§áIDÂíåÂØÜÈí•Áõê‰∏çËÉΩ‰∏∫Á©∫„ÄÇ");
    }
    const dataToHash = deviceId + salt;
    const dataBuffer = new TextEncoder().encode(dataToHash);
    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex.substring(0, 6).toUpperCase();
  }

 
  function requirePinActivation() {
  
    return new Promise(async (resolve, reject) => {
      
      if (isPinActivated) {
        resolve(true);
        return;
      }

     
      const modal = document.getElementById('pin-modal-overlay');
      const deviceIdDisplay = document.getElementById('pin-device-id-display');
      const pinInput = document.getElementById('pin-input');
      const confirmBtn = document.getElementById('pin-modal-confirm-btn');
      const cancelBtn = document.getElementById('pin-modal-cancel-btn');

      
      deviceIdDisplay.value = EPHONE_DEVICE_ID;
      pinInput.value = ''; 

     

      const onConfirmClick = async () => {
        const userPin = pinInput.value;

       
        modal.classList.remove('visible');

       
        confirmBtn.removeEventListener('click', onConfirmClick);
        cancelBtn.removeEventListener('click', onCancelClick);

        if (!userPin || !userPin.trim()) {
          await showCustomAlert('Êìç‰ΩúÂèñÊ∂à', 'ÊÇ®Ê≤°ÊúâËæìÂÖ•ÊøÄÊ¥ªÁ†Å„ÄÇ'); 
          reject(new Error('Áî®Êà∑ÂèñÊ∂à‰∫ÜËæìÂÖ•„ÄÇ'));
          return;
        }

       
        await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®È™åËØÅÊøÄÊ¥ªÁ†Å...");


        try {
        
          const correctPin = await generatePin(EPHONE_DEVICE_ID, PREFILLED_SALT);

         
          if (userPin.trim().toUpperCase() === correctPin) {
            
            localStorage.setItem('ephonePinActivated', 'true');
            isPinActivated = true;
            await showCustomAlert('ÊøÄÊ¥ªÊàêÂäüÔºÅ', 'Ê≠§ÂäüËÉΩÂ∑≤‰∏∫ÊÇ®ÁöÑËÆæÂ§áÊ∞∏‰πÖËß£ÈîÅ„ÄÇ');

        
            updateLockedFeatureUI();

           
            resolve(true);
          } else {
            
            await showCustomAlert('ÊøÄÊ¥ªÂ§±Ë¥•', 'ÊÇ®ËæìÂÖ•ÁöÑÊøÄÊ¥ªÁ†Å‰∏çÊ≠£Á°Æ„ÄÇ');
            reject(new Error('ÊøÄÊ¥ªÁ†Å‰∏çÊ≠£Á°Æ„ÄÇ'));
          }
        } catch (error) {
         
          console.error("Êú¨Âú∞PINÁ†ÅÈ™åËØÅËøáÁ®ãÂá∫Èîô:", error);
          await showCustomAlert('ÊøÄÊ¥ªÂ§±Ë¥•', `È™åËØÅËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºö${error.message}`);
          reject(error);
        }
     
      };


      const onCancelClick = async () => { // <--- Ê∑ªÂä† async
        modal.classList.remove('visible');
       
        confirmBtn.removeEventListener('click', onConfirmClick);
        cancelBtn.removeEventListener('click', onCancelClick);

    
        await showCustomAlert('Êìç‰ΩúÂèñÊ∂à', 'ÊøÄÊ¥ªÊµÅÁ®ãÂ∑≤ÂèñÊ∂à„ÄÇ'); 
        reject(new Error('Áî®Êà∑ÂèñÊ∂à‰∫ÜÊøÄÊ¥ª„ÄÇ'));
      };

    
      confirmBtn.addEventListener('click', onConfirmClick);
      cancelBtn.addEventListener('click', onCancelClick);

   
      modal.classList.add('visible');
      pinInput.focus();
    });
  }

  
  function updateLockedFeatureUI() {
    const isActivated = localStorage.getItem('ephonePinActivated') === 'true';
    const presetImportBtn = document.getElementById('import-preset-btn');

    
    const worldBookImportBtn = document.getElementById('import-world-book-btn');
  

    
    if (presetImportBtn) {
      presetImportBtn.classList.toggle('locked-feature', !isActivated);
    }

 
    if (worldBookImportBtn) {
      worldBookImportBtn.classList.toggle('locked-feature', !isActivated);
    }
  
  }
  document.addEventListener('visibilitychange', () => {
   
    if (document.visibilityState === 'visible') {
      console.log('Â∫îÁî®Â∑≤ËøîÂõûÂâçÂè∞ÔºåÊ≠£Âú®Ê£ÄÊü•Êõ¥Êñ∞...');
     
      navigator.serviceWorker.ready.then(registration => {
       
        registration.update();
      });
    }
  });

  function toGeminiRequestData(model, apiKey, systemInstruction, messagesForDecision) {
    const apiTemperature = state.globalSettings.apiTemperature || 0.8;
    const roleType = {
      user: 'user',
      assistant: 'model',
      system: 'user'
    };


    const contents = [{
        role: 'user',
        parts: [{
          text: systemInstruction
        }]
      },
      {
        role: 'model',
        parts: [{
          text: 'Â•ΩÁöÑÔºåÊàëÊòéÁôΩ‰∫Ü„ÄÇÊàë‰ºö‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíåËÆæÂÆö„ÄÇ'
        }]
      },

      ...messagesForDecision.map((item) => {
        const parts = [];

        if (Array.isArray(item.content)) {
          item.content.forEach(part => {
            if (part.type === 'text') {
              parts.push({
                text: part.text
              });
            } else if (part.type === 'image_url' && part.image_url && part.image_url.url) {

              const currentImageData = part.image_url.url;
              const base64Data = currentImageData.split(',')[1];
              const mimeTypeMatch = currentImageData.match(/^data:(.*);base64/);
              if (mimeTypeMatch && base64Data) {
                parts.push({
                  inline_data: {
                    mime_type: mimeTypeMatch[1],
                    data: base64Data
                  }
                });
              }
            }
          });
        } else {

          parts.push({
            text: String(item.content)
          });
        }
        return {
          role: roleType[item.role],
          parts: parts
        };
      })
    ];


    return {
      url: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${getRandomValue(apiKey)}`,
      data: {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contents: contents,
          generationConfig: {
            temperature: apiTemperature,
          },
        })
      }
    };
  }





  
  const avatarFrames = [{
      id: 'none',
      url: '',
      name: 'Êó†'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif',
      name: '14'
    }, {
      id: 'frame_cat_ear',
      url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif',
      name: '1'
    }, {
      id: 'frame_ribbon',
      url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif',
      name: '2'
    }, {
      id: 'frame_flower',
      url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif',
      name: '3'
    }, {
      id: 'frame_tech',
      url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif',
      name: '4'
    }, {
      id: 'frame_5',
      url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif',
      name: '5'
    }, {
      id: 'frame_6',
      url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif',
      name: '6'
    }, {
      id: 'frame_7',
      url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif',
      name: '7'
    }, {
      id: 'frame_8',
      url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif',
      name: '8'
    }, {
      id: 'frame_9',
      url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif',
      name: '9'
    }, {
      id: 'frame_10',
      url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif',
      name: '10'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif',
      name: '14'
    }, {
      id: 'frame_11',
      url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif',
      name: '11'
    }, {
      id: 'frame_12',
      url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif',
      name: '12'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif',
      name: '14'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif',
      name: '14'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif',
      name: '14'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif',
      name: '14'
    }, {
      id: 'frame_13',
      url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif',
      name: '13'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif',
      name: '14'
    }, {
      id: 'frame_14',
      url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif',
      name: '14'
    },
    {
      id: 'frame_12',
      url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif',
      name: '12'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif',
      name: '14'
    },

    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif',
      name: '14'
    },


    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif',
      name: '14'
    },
    {
      id: 'frame_13',
      url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif',
      name: '13'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif',
      name: '14'
    },
    {
      id: 'frame_14',
      url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif',
      name: '14'
    },

  ];
  let billState = {
    page: 0,
    pageSize: 30,      
    isLoading: false,   
    hasMore: true,      
    filterDate: '',     
    filterType: 'all'   
};
  let state = {
    chats: {},
    activeChatId: null,
    globalSettings: {},
    apiConfig: {},
    userStickers: [],
    worldBooks: [],
    personaPresets: [],
    qzoneSettings: {},
    activeAlbumId: null,
    cache: {
      songs: new Map(),
      lyrics: new Map()
    },
    ttsCache: new Map(),
    quickReplies: []
  };
  window.state = state; // Expose state globally
let memoryCache = []; // ÁºìÂ≠òÊâÄÊúâÈúÄË¶ÅÊòæÁ§∫ÁöÑËÆ∞ÂøÜ
let memoryRenderCount = 0; // ÂΩìÂâçÂ∑≤Ê∏≤ÊüìÊï∞Èáè
let isLoadingMoreMemories = false; // Èò≤ÊäñÈîÅ

// ÂæÖÂäû‰∫ãÈ°πÂàÜÈ°µÁä∂ÊÄÅ
let todoCache = [];
let todoRenderCount = 0;
let isLoadingMoreTodos = false;
async function uploadImageToImgBB(base64String) {
    // 1. Ê£ÄÊü•ÂäüËÉΩÊòØÂê¶ÂºÄÂêØ
    if (!state.apiConfig.imgbbEnable || !state.apiConfig.imgbbApiKey) {
        // console.log("ImgBB Êú™ÂºÄÂêØÔºåËøîÂõûÂéüÂßã Base64„ÄÇ");
        return base64String; // ÂäüËÉΩÊú™ÂºÄÂêØÔºåÁõ¥Êé•ËøîÂõû
    }

    // 2. Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊòØ URL
    if (!base64String || !base64String.startsWith('data:image')) {
        // console.log("ËæìÂÖ•Â∑≤ÊòØ URL Êàñ‰∏∫Á©∫ÔºåÊó†ÈúÄ‰∏ä‰º†„ÄÇ");
        return base64String; // Â∑≤ÁªèÊòØ URL Êàñ‰∏∫Á©∫ÔºåÊó†ÈúÄ‰∏ä‰º†
    }

    // 3. ÊèêÂèñ Base64 Êï∞ÊçÆ
    // Ê†ºÂºè‰∏∫ data:image/png;base64,iVBORw0KGgo...
    const base64Data = base64String.split(',')[1];
    if (!base64Data) {
        console.warn("Êó†Ê≥ï‰ªéÂ≠óÁ¨¶‰∏≤‰∏≠ÊèêÂèñ Base64 Êï∞ÊçÆ:", base64String.substring(0, 50) + "...");
        return base64String; // Ê†ºÂºèÈîôËØØÔºåËøîÂõûÂéüÊñá
    }
    
    console.log(`[ImgBB] ÂºÄÂßã‰∏ä‰º†ÂõæÁâá... (Â§ßÂ∞è: ${(base64String.length / 1024).toFixed(1)} KB)`);

    try {
        const formData = new FormData();
        formData.append('image', base64Data);

        const response = await fetch(`https://api.imgbb.com/1/upload?key=${state.apiConfig.imgbbApiKey}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success && result.data && result.data.url) {
            console.log("[ImgBB] ‰∏ä‰º†ÊàêÂäü! URL:", result.data.url);
            return result.data.url; // ÊàêÂäüÔºÅËøîÂõû URL
        } else {
            // ImgBB API ËøîÂõû‰∫ÜÈîôËØØ
            throw new Error(result.error?.message || 'ImgBB API ËøîÂõû‰∫ÜÊú™Áü•ÈîôËØØ„ÄÇ');
        }
    } catch (error) {
        console.error("[ImgBB] ‰∏ä‰º†Â§±Ë¥•:", error);
        // ÊäõÂá∫ÈîôËØØÔºåËÆ©Ë∞ÉÁî®Ê≠§ÂáΩÊï∞ÁöÑ‰∏äÂ±ÇÈÄªËæëÁü•ÈÅì‰∏ä‰º†Â§±Ë¥•‰∫Ü
        throw new Error(`ImgBB ‰∏ä‰º†Â§±Ë¥•: ${error.message}`);
    }
}
        async function uploadFileToCatbox(fileObject) {
    // 1. Ê£ÄÊü•ÂäüËÉΩÊòØÂê¶ÂºÄÂêØ
    if (!state.apiConfig.catboxEnable || !state.apiConfig.catboxUserHash) {
        console.log("[Catbox] ÂäüËÉΩÊú™ÂºÄÂêØÊàñÊú™ÈÖçÁΩÆ User HashÔºåË∑≥Ëøá‰∏ä‰º†„ÄÇ");
        return null; // ÂäüËÉΩÊú™ÂºÄÂêØÔºåËøîÂõû null ‰ª•‰æøÂõûÈÄÄ
    }

    const userHash = state.apiConfig.catboxUserHash;
    console.log(`[Catbox] ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂: ${fileObject.name || 'blob.mp3'}... (Â§ßÂ∞è: ${(fileObject.size / 1024 / 1024).toFixed(2)} MB)`);

    try {
        const formData = new FormData();
        formData.append('reqtype', 'fileupload');
        formData.append('userhash', userHash);
        formData.append('fileToUpload', fileObject, fileObject.name || 'track.mp3'); // Êèê‰æõÊñá‰ª∂Âêç

        // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë ‚ñº‚ñº‚ñº
        // 1. ÂÆö‰πâ Catbox API URL
        let apiUrl = 'https://catbox.moe/user/api.php';

        // 2. Ëé∑Âèñ CORS ‰ª£ÁêÜËÆæÁΩÆ (Â§çÁî® NovelAI ÁöÑËÆæÁΩÆ)
        const proxySettings = getNovelAISettings(); // This function is around line 4504
        let corsProxy = proxySettings.cors_proxy;
        if (corsProxy === 'custom') {
            corsProxy = proxySettings.custom_proxy_url || '';
        }

        // 3. Â¶ÇÊûú‰ª£ÁêÜÂ≠òÂú®, Âàô‰ΩøÁî®‰ª£ÁêÜ
        if (corsProxy && corsProxy !== '') {
            // „ÄêÈáçË¶Å„ÄëCatbox API URL ‰∏çÈúÄË¶ÅÁºñÁ†ÅÔºåËÄå NovelAI ÈúÄË¶ÅÔºåËøôÈáåÊàë‰ª¨Áõ¥Êé•ÊãºÊé•
            apiUrl = corsProxy + apiUrl; 
            console.log(`[Catbox] Ê£ÄÊµãÂà∞CORS‰ª£ÁêÜÔºå‰ΩøÁî®‰ª£ÁêÜ‰∏ä‰º†: ${apiUrl}`);
        } else {
            console.log("[Catbox] Êú™ÈÖçÁΩÆCORS‰ª£ÁêÜÔºåÂ∞ùËØïÁõ¥Ëøû... (ËøôÂæàÂèØËÉΩ‰ºöÂ§±Ë¥•)");
        }
        // ‚ñ≤‚ñ≤‚ñ≤ „Äê‰øÆÂ§çÁªìÊùü„Äë ‚ñ≤‚ñ≤‚ñ≤

        const response = await fetch(apiUrl, { // <-- ÊõøÊç¢‰∏∫ apiUrl
            method: 'POST',
            body: formData
        });

        const responseText = await response.text();

        if (response.ok && responseText.startsWith('http')) {
            console.log("[Catbox] ‰∏ä‰º†ÊàêÂäü! URL:", responseText);
            return responseText; // ÊàêÂäüÔºÅËøîÂõû URL
        } else {
            // Catbox API ËøîÂõû‰∫ÜÈîôËØØÊñáÊú¨
            throw new Error(responseText || 'Catbox API ËøîÂõû‰∫ÜÊú™Áü•ÈîôËØØ„ÄÇ');
        }
    } catch (error) {
        console.error("[Catbox] ‰∏ä‰º†Â§±Ë¥•:", error);
        // ÊäõÂá∫ÈîôËØØÔºåËÆ©Ë∞ÉÁî®Ê≠§ÂáΩÊï∞ÁöÑ‰∏äÂ±ÇÈÄªËæëÁü•ÈÅì‰∏ä‰º†Â§±Ë¥•‰∫Ü
        // „ÄêÈáçË¶Å„ÄëÊàë‰ª¨Âú®ËøôÈáåÂè™ÊäõÂá∫ÂéüÂßãÈîôËØØÔºå‰ª•‰æø‰∏äÂ±ÇÂáΩÊï∞ÂèØ‰ª•ÊçïËé∑Âπ∂ÊòæÁ§∫ÂÆÉ
        throw error;
    }
}
async function silentlyUpdateDbUrl(table, recordId, pathString, base64ToFind, nameToMatch = null) {
    if (!state.apiConfig.imgbbEnable || !state.apiConfig.imgbbApiKey) {
        console.log(`[ImgBB Silent Update] ImgBB is disabled, skipping silent upload for ${table.name}.${recordId}.${pathString}.`);
        return; // ImgBB not enabled, do nothing.
    }
    
    let imageUrl;
    try {
        imageUrl = await uploadImageToImgBB(base64ToFind);
        if (imageUrl === base64ToFind) {
             console.log("[ImgBB Silent Update] Upload returned Base64 (or failed), no update needed.");
             return; // Upload failed or was skipped
        }
    } catch (uploadError) {
        console.error(`[ImgBB Silent Update] Background upload failed for ${table.name}.${recordId}.${pathString}:`, uploadError.message);
        return; // Upload failed
    }

    console.log(`[ImgBB Silent Update] Success. New URL: ${imageUrl}. Finding record to update...`);

    try {
        const record = await table.get(recordId);
        if (!record) {
            console.warn(`[ImgBB Silent Update] Could not find record ${recordId} in table ${table.name}.`);
            return;
        }

        let updated = false;

        // ËæÖÂä©ÂáΩÊï∞ÔºöÈÄöËøáË∑ØÂæÑÂ≠óÁ¨¶‰∏≤Ê∑±ÂÖ•ÂØπË±°ÔºåËøîÂõûÁà∂Á∫ßÂíåÊúÄÂêéÁöÑÈîÆ
        function getNestedParent(obj, path) {
            const keys = path.split('.');
            let current = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (current[keys[i]] === undefined || current[keys[i]] === null) {
                    console.warn(`[ImgBB Silent Update] Invalid path: ${path} in record at key ${keys[i]}.`);
                    return null; // Path does not exist
                }
                current = current[keys[i]];
            }
            return { parent: current, finalKey: keys[keys.length - 1] };
        }

        if (nameToMatch) {
            // --- ÈÄªËæë A: ÊêúÁ¥¢Êï∞ÁªÑ ---
            const result = getNestedParent(record, pathString);
            if (result && Array.isArray(result.parent[result.finalKey])) {
                const arrayToSearch = result.parent[result.finalKey];
                const itemToUpdate = arrayToSearch.find(item => item.url === base64ToFind && item.name === nameToMatch);
                
                if (itemToUpdate) {
                    itemToUpdate.url = imageUrl;
                    updated = true;
                    console.log(`[ImgBB Silent Update] Found and updated item "${nameToMatch}" in array ${pathString}.`);
                } else {
                    console.warn(`[ImgBB Silent Update] Could not find item "${nameToMatch}" with matching Base64 in array ${pathString} to update.`);
                }
            } else {
                 console.warn(`[ImgBB Silent Update] Path ${pathString} did not resolve to a valid array.`);
            }
        } else {
            // --- ÈÄªËæë B: Êõ¥Êñ∞ÁÆÄÂçïÂ±ûÊÄß (Â¶Ç 'url' Êàñ 'widgetData.polaroid-img-1') ---
            const result = getNestedParent(record, pathString);
            if (result && result.parent[result.finalKey] === base64ToFind) {
                result.parent[result.finalKey] = imageUrl;
                updated = true;
                console.log(`[ImgBB Silent Update] Found and updated simple path ${pathString}.`);
            } else if (result) {
                console.warn(`[ImgBB Silent Update] Value changed since upload for ${pathString}. Expected Base64, found: ${String(result.parent[result.finalKey]).substring(0,30)}...`);
            } else {
                console.warn(`[ImgBB Silent Update] Path ${pathString} did not resolve to a matching string.`);
            }
        }


        if (updated) {
            await table.put(record);
            console.log(`[ImgBB Silent Update] Successfully updated DB for ${table.name}.${recordId}.${pathString}.`);
            
            // Êõ¥Êñ∞ÂÜÖÂ≠ò (state.globalSettings)
            if (table.name === 'globalSettings' && recordId === 'main') {
                // (ÈáçÊñ∞Ëé∑ÂèñÊõ¥Êñ∞ÂêéÁöÑÂÜÖÂ≠òÁä∂ÊÄÅ)
                const stateResult = getNestedParent(state, `globalSettings.${pathString}`);
                if (nameToMatch && stateResult && Array.isArray(stateResult.parent[stateResult.finalKey])) {
                    const stateArray = stateResult.parent[stateResult.finalKey];
                    const stateItem = stateArray.find(item => item.url === base64ToFind && item.name === nameToMatch);
                    if (stateItem) stateItem.url = imageUrl;
                } else if (!nameToMatch && stateResult && stateResult.parent[stateResult.finalKey] === base64ToFind) {
                    stateResult.parent[stateResult.finalKey] = imageUrl;
                }
                console.log(`[ImgBB Silent Update] In-memory state.globalSettings updated.`);
            }
        }
    } catch (dbError) {
        console.error(`[ImgBB Silent Update] Failed to save updated URL to DB for ${table.name}.${recordId}.${pathString}:`, dbError);
    }
}
  let werewolfGameState = {
    isActive: false,
    gameMode: null,
    chatId: null,
    players: [],
    currentDay: 1,
    currentPhase: 'setup',
    nightActions: {},
    gameLog: [],
    discussionLog: [],
    voteResults: {},
    electionInfo: {
      candidates: [],
      votes: {}
    },
    sheriffId: null,
    lastFailedAction: null,
  };

  let thoughtsHistoryRenderCount = 0;
  const THOUGHTS_RENDER_WINDOW = 15;


  let qzonePostsRenderCount = 0;
  const QZONE_RENDER_WINDOW = 10;

  let qzonePostsCache = [];

  let musicState = {
    isActive: false,
    activeChatId: null,
    isPlaying: false,
    playlist: [],
    currentIndex: -1,
    playMode: 'order',
    totalElapsedTime: 0,
    timerId: null,

    parsedLyrics: [],
    currentLyricIndex: -1
  };
  let qzoneStickerPanelState = {
    isOpen: false,
    activePostId: null,
    panelEl: null,
    gridEl: null
  };
  const audioPlayer = document.getElementById('audio-player');
  // ËÆæÁΩÆË∑®ÂüüÂ±ûÊÄß‰ª•ÊîØÊåÅÂ§ñÈÉ®URLÊí≠Êîæ
  if (audioPlayer) {
    audioPlayer.crossOrigin = 'anonymous';
  }
 // ÂèòÈáèÂ£∞ÊòéÂå∫Âüü
let isQuickReplyManagementMode = false;
let selectedQuickReplies = new Set();
  let newWallpaperBase64 = null;
  let isRuleManagementMode = false;
  let selectedRules = new Set();
  let isSelectionMode = false;
  let cphoneRenderedCount = 0;
  let cphoneActiveConversationType = null;
  let isLoadingMoreCphoneMessages = false;
  window.activeStickerCategoryId = 'all';
  let selectedMessages = new Set();
  let editingMemberId = null;
  let isAddingNpcToGroup = false;
  let editingWorldBookId = null;
  let editingRuleId = null;
  let isLoadingMoreChats = false;
  let isLoadingMoreMessages = false;
  let isLoadingMoreThoughts = false;
  let isLoadingMorePosts = false;
  let sortedChatListItems = [];
  let editingPersonaPresetId = null;
  let currentReplyContext = null;
  let waimaiTimers = {};
  let currentSpectatorMode = 'group';
  let activeMessageTimestamp = null;
  let activeCharacterId = null;
  let editingMemoId = null;
  let editingDiaryId = null;
  let activeDiaryForViewing = null;
  let activeArticleForViewing = null;
  let activeMemoForViewing = null;
  let currentNaiPresetId = null;
  let shoppingCart = [];
  let editingProductId = null;
  let activeProductId = null;
  let selectedProducts = new Set();
  let activeQuickReplyCategoryId = 'all';

  let currentQzoneReplyContext = null;

  let activePostId = null;
  let activeDoubanPostId = null;
  let photoViewerState = {
    isOpen: false,
    photos: [],
    currentIndex: -1,
  };

  let unreadPostsCount = 0;

  let isFavoritesSelectionMode = false;
  let selectedFavorites = new Set()

  let simulationIntervalId = null;
  let currentTodoDate = new Date(); // ÂΩìÂâçÊü•ÁúãÁöÑÊó•Êúü
  let editingTodoId = null;
  const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
  const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
  const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
  const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
  let notificationTimeout;
  let ruleCache = {};

  const DEFAULT_NOTIFICATION_SOUND = 'https://www.myinstants.com/media/sounds/notification-sound-2.mp3';

  let gomokuState = {};
  let readingState = {};
  let originalChatMessagesPaddingTop = null;



  const DEFAULT_APP_ICONS = {
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'world-book': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'wallpaper': 'https://i.postimg.cc/T1j03pQr/IMG-6440.jpg',
    'renderer': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756312261242_qdqqd_g0eriz.jpeg',
    'api-settings': 'https://i.postimg.cc/MK8rJ8t7/IMG-6438.jpg',
    'font': 'https://i.postimg.cc/pXxk1JXk/IMG-6442.jpg',

    'char-phone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg',
    'douban': 'https://i.postimg.cc/Pq2xJN1g/IMG-7301.jpg',

    'preset': 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',

    'tutorial': 'https://i.postimg.cc/d10GjC4g/IMG-7302.jpg',
    'werewolf': 'https://i.postimg.cc/k401K5g7/IMG-7304.jpg',
     
    'x': 'https://i.postimg.cc/Y9d3BztC/1.png',
    'alipay': 'https://i.postimg.cc/Hs7BLh76/alipay.png',
    'auction': 'https://i.postimg.cc/Hs7BLh76/alipay.png',
     'green-river': 'https://i.postimg.cc/0j55Pj1L/green-river-icon.png',
    'mail': 'https://i.postimg.cc/PfR7f37x/mail.png'
  };


  const DEFAULT_CPHONE_ICONS = {
    'qq': 'https://i.postimg.cc/MTC3Tkw8/IMG-6436.jpg',
    'album': 'https://i.postimg.cc/HWf1JKzn/IMG-6435.jpg',
    'browser': 'https://i.postimg.cc/KzC2gTq6/IMG-7276.jpg',
    'taobao': 'https://i.postimg.cc/L6R7x16R/IMG-7278.jpg',
    'memo': 'https://i.postimg.cc/J0b6Nym4/IMG-7279.jpg',
    'diary': 'https://i.postimg.cc/DZ541sbt/IMG-7280.jpg',
    'amap': 'https://i.postimg.cc/Jz2Tz0dw/IMG-7281.jpg',
    'usage': 'https://i.postimg.cc/WbF8kzz9/IMG-7282.jpg',
    'music': 'https://is1-ssl.mzstatic.com/image/thumb/Purple112/v4/64/9d/21/649d21e8-a151-6136-3914-256e54f15d9a/AppIcon-0-0-1x_U007emarketing-0-0-0-7-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/1200x630wa.png',
    'bilibili': 'https://i.postimg.cc/Wz5gV0jB/bilibili-icon.png',
     'reddit': 'https://www.redditinc.com/assets/images/site/reddit-logo.png',
    'ephone': 'https://i.postimg.cc/pXj9h20L/IMG-7275.jpg'
  };

  let repostTargetId = null;
  const STICKER_REGEX = /(^https:\/\/i\.postimg\.cc\/.+|^https:\/\/files\.catbox\.moe\/.+|^https?:\/\/sharkpan\.xyz\/.+|^data:image|\.(png|jpg|jpeg|gif|webp)\?.*$|\.(png|jpg|jpeg|gif|webp)$)/i;

  let currentRenderedCount = 0;
  let lastKnownBatteryLevel = 1;
  let alertFlags = {
    hasShown40: false,
    hasShown20: false,
    hasShown10: false
  };
  let batteryAlertTimeout;
  const dynamicFontStyle = document.createElement('style');
  dynamicFontStyle.id = 'dynamic-font-style';
  document.head.appendChild(dynamicFontStyle);

  const modalOverlay = document.getElementById('custom-modal-overlay');
  const modalTitle = document.getElementById('custom-modal-title');
  const modalBody = document.getElementById('custom-modal-body');
  const modalConfirmBtn = document.getElementById('custom-modal-confirm');
  const modalCancelBtn = document.getElementById('custom-modal-cancel');
  let modalResolve;

  function showCustomModal() {
    modalOverlay.classList.add('visible');
  }

  function hideCustomModal() {
    modalOverlay.classList.remove('visible');
    modalConfirmBtn.classList.remove('btn-danger');
    if (modalResolve) modalResolve(null);
  }

  function applyLyricsBarPosition(chat) {
    const lyricsBar = document.getElementById('global-lyrics-bar');

    const settings = chat.settings.lyricsPosition || {
      vertical: 'top',
      horizontal: 'center',
      offset: 10
    };


    lyricsBar.style.top = 'auto';
    lyricsBar.style.bottom = 'auto';
    lyricsBar.style.left = 'auto';
    lyricsBar.style.right = 'auto';
    lyricsBar.style.transform = 'none';


    if (settings.vertical === 'top') {
      lyricsBar.style.top = `${settings.offset}px`;
    } else {
      lyricsBar.style.bottom = `${settings.offset}px`;
    }


    switch (settings.horizontal) {
      case 'left':
        lyricsBar.style.left = '15px';
        break;
      case 'right':
        lyricsBar.style.right = '15px';
        break;
      case 'center':
      default:
        lyricsBar.style.left = '50%';
        lyricsBar.style.transform = 'translateX(-50%)';
        break;
    }
  }




  async function handleLocalGroupAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    let base64Url = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });

    // [Â∑≤Âà†Èô§] AIÂëΩÂêçÊèêÁ§∫
    // await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAI‰∏∫Êñ∞Áæ§Â§¥ÂÉèÂëΩÂêç...");

    try {
      // [‰øÆÊîπ] Â∞ÜAIÂëΩÂêçÊîπ‰∏∫ÊâãÂä®ËæìÂÖ•
      // const description = await getAvatarDescriptionFromApi(base64Url);
      const description = await showCustomPrompt("ÂëΩÂêçÁæ§Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Áæ§Â§¥ÂÉèÂëΩÂêç");

      // [‰øÆÊîπ] Ê£ÄÊü•ÊòØÂê¶ËæìÂÖ•‰∫ÜÂêçÁß∞
      // if (!description) {
      //   throw new Error("AIÊú™ËÉΩÊàêÂäüÊèèËø∞ÂõæÁâá„ÄÇ");
      // }
      if (!description || !description.trim()) {
        await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "‰Ω†Ê≤°ÊúâËæìÂÖ•ÂêçÁß∞ÔºåÂ∑≤ÂèñÊ∂à‰∏ä‰º†„ÄÇ");
        event.target.value = null; // Ê∏ÖÁ©∫ input
        return;
      }

      const chat = state.chats[state.activeChatId];
      if (!chat.settings.groupAvatarLibrary) {
        chat.settings.groupAvatarLibrary = [];
      }
      
      const newItem = {
        name: description, // ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
        url: base64Url
      };
      chat.settings.groupAvatarLibrary.push(newItem);
      await db.chats.put(chat);
      
      renderGroupAvatarLibrary();
      
      // [‰øÆÊîπ] Êõ¥ÊîπÊàêÂäüÊèêÁ§∫
      // await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `AIÂ∑≤Â∞ÜÊñ∞Áæ§Â§¥ÂÉèÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);
      await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `Áæ§Â§¥ÂÉèÂ∑≤ÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

      // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
      (async () => {
        await silentlyUpdateDbUrl(
            db.chats, // table
            chat.id,  // recordId
            'settings.groupAvatarLibrary', // pathString (ÊåáÂêëÊï∞ÁªÑ)
            base64Url, // base64ToFind
            description // [‰øÆÊîπ] ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
        );
      })();

    } catch (error) {
      // [‰øÆÊîπ] Êõ¥ÊîπÂ§±Ë¥•ÊèêÁ§∫
      console.error("Êú¨Âú∞Áæ§Â§¥ÂÉè‰∏ä‰º†ÂèäËØÜÂà´Â§±Ë¥•:", error);
      // await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ï‰∏∫Â§¥ÂÉèÂëΩÂêçÔºåËØ∑Ê£ÄÊü•Ôºà‰∏ª/ÂâØÔºâAPIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°ÆÂπ∂ÊîØÊåÅVision„ÄÇ\nÈîôËØØ: ${error.message}`);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `‰∏ä‰º†Êó∂ÂèëÁîüÈîôËØØ„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {
      event.target.value = null;
    }
  }



  async function handleLocalAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    let base64Url = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });

    // [Â∑≤Âà†Èô§] AIÂëΩÂêçÊèêÁ§∫
    // await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAI‰∏∫Êñ∞Â§¥ÂÉèÂëΩÂêç...");

    try {
      // [‰øÆÊîπ] Â∞ÜAIÂëΩÂêçÊîπ‰∏∫ÊâãÂä®ËæìÂÖ•
      // const description = await getAvatarDescriptionFromApi(base64Url);
      const description = await showCustomPrompt("ÂëΩÂêçÂ§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Â§¥ÂÉèÂëΩÂêç");
      
      // [‰øÆÊîπ] Ê£ÄÊü•ÊòØÂê¶ËæìÂÖ•‰∫ÜÂêçÁß∞
      // if (!description) {
      //   throw new Error("AIÊú™ËÉΩÊàêÂäüÊèèËø∞ÂõæÁâá„ÄÇ");
      // }
      if (!description || !description.trim()) {
        await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "‰Ω†Ê≤°ÊúâËæìÂÖ•ÂêçÁß∞ÔºåÂ∑≤ÂèñÊ∂à‰∏ä‰º†„ÄÇ");
        event.target.value = null; // Ê∏ÖÁ©∫ input
        return;
      }
      
      const chat = state.chats[state.activeChatId];
      if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
      }
      
      const newItem = {
        name: description, // ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
        url: base64Url
      };
      chat.settings.aiAvatarLibrary.push(newItem);
      await db.chats.put(chat);
      
      renderAiAvatarLibrary();
      
      // [‰øÆÊîπ] Êõ¥ÊîπÊàêÂäüÊèêÁ§∫
      // await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `AIÂ∑≤Â∞ÜÊñ∞Â§¥ÂÉèÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);
      await showCustomAlert("‰∏ä‰º†ÊàêÂäüÔºÅ", `Â§¥ÂÉèÂ∑≤ÂëΩÂêç‰∏∫Ôºö‚Äú${description}‚Äù\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);
      
      // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
      (async () => {
          await silentlyUpdateDbUrl(
              db.chats, // table
              chat.id,  // recordId
              'settings.aiAvatarLibrary', // pathString (ÊåáÂêëÊï∞ÁªÑ)
              base64Url, // base64ToFind
              description // [‰øÆÊîπ] ‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÂêçÁß∞
          );
      })();

    } catch (error) {
      // [‰øÆÊîπ] Êõ¥ÊîπÂ§±Ë¥•ÊèêÁ§∫
      console.error("Êú¨Âú∞Â§¥ÂÉè‰∏ä‰º†ÂèäËØÜÂà´Â§±Ë¥•:", error);
      // await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ï‰∏∫Â§¥ÂÉèÂëΩÂêçÔºåËØ∑Ê£ÄÊü•Ôºà‰∏ª/ÂâØÔºâAPIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°ÆÂπ∂ÊîØÊåÅVision„ÄÇ\nÈîôËØØ: ${error.message}`);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `‰∏ä‰º†Êó∂ÂèëÁîüÈîôËØØ„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {
      event.target.value = null;
    }
  }


  async function getAvatarDescriptionFromApi(base64Url) {

    const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
    const {
      proxyUrl,
      apiKey,
      model
    } = useSecondaryApi
      ?
      {
        proxyUrl: state.apiConfig.secondaryProxyUrl,
        apiKey: state.apiConfig.secondaryApiKey,
        model: state.apiConfig.secondaryModel
      } :
      state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
      throw new Error("‰∏ªAPIÂíåÂâØAPIÂùáÊú™ÈÖçÁΩÆÊàñÈÖçÁΩÆ‰∏çÂÆåÊï¥„ÄÇ");
    }

    const prompt = "ËØ∑‰∏∫ËøôÂº†ÂõæÁâáËµ∑‰∏Ä‰∏™ÁÆÄÊ¥ÅÁöÑ„ÄÅÈÄÇÂêà‰Ωú‰∏∫Â§¥ÂÉèÂ∫ìÊ†áÁ≠æÁöÑÂêçÂ≠ó„ÄÇ‰æãÂ¶ÇÔºö‚ÄúÂæÆÁ¨ëËá™Êãç‚Äù„ÄÅ‚ÄúÈò≥ÂÖâ‰∏ãÁöÑÁå´Âí™‚Äù„ÄÅ‚ÄúËìùÂèëÂä®Êº´Â∞ëÂ•≥‚Äù„ÄÇËØ∑Áõ¥Êé•ÂõûÁ≠îÂêçÂ≠óÔºå‰∏çË¶ÅÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑËß£Èáä„ÄÇ";

    let isGemini = proxyUrl.includes('generativelanguage');
    let response;

    if (isGemini) {
      const mimeType = base64Url.match(/^data:(.*);base64/)[1];
      const base64Data = base64Url.split(',')[1];
      const payload = {
        contents: [{
          parts: [{
              text: prompt
            },
            {
              inline_data: {
                mime_type: mimeType,
                data: base64Data
              }
            }
          ]
        }]
      };
      response = await fetch(`${proxyUrl}/${model}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

    } else {
      const payload = {
        model: model,
        messages: [{
          role: 'user',
          content: [{
              type: 'text',
              text: prompt
            },
            {
              type: 'image_url',
              image_url: {
                url: base64Url
              }
            }
          ]
        }],
        max_tokens: 50
      };
      response = await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify(payload)
      });
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
    }

    const data = await response.json();
    let description = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;


    return description.trim().replace(/["'‚Äú‚Äù‚Äò‚Äô]/g, '');
  }


  async function syncCharacterNameInGroups(characterChat) {

    if (!characterChat || characterChat.isGroup) {
      console.warn("syncCharacterNameInGroups: ‰º†ÂÖ•ÁöÑ‰∏çÊòØÊúâÊïàÁöÑÂçïËÅäÂØπË±°ÔºåÂ∑≤Ë∑≥ËøáÂêåÊ≠•„ÄÇ");
      return;
    }

    const characterId = characterChat.id;
    const newRemarkName = characterChat.name;
    const newOriginalName = characterChat.originalName;

    console.log(`Ê≠£Âú®‰∏∫ËßíËâ≤ ${characterId} ÂêåÊ≠•ÊâÄÊúâÁæ§ËÅäÂÜÖÁöÑÂêçÁß∞‰ø°ÊÅØ...`);


    for (const chatId in state.chats) {
      const groupChat = state.chats[chatId];


      if (groupChat.isGroup && groupChat.members) {

        const memberToUpdate = groupChat.members.find(m => m.id === characterId);


        if (memberToUpdate) {
          let needsDbUpdate = false;


          if (memberToUpdate.groupNickname !== newRemarkName) {
            memberToUpdate.groupNickname = newRemarkName;
            needsDbUpdate = true;
          }


          if (memberToUpdate.originalName !== newOriginalName) {
            memberToUpdate.originalName = newOriginalName;
            needsDbUpdate = true;
          }


          if (needsDbUpdate) {
            await db.chats.put(groupChat);
            console.log(`ÊàêÂäüÂ∞ÜÁæ§ËÅä "${groupChat.name}" ‰∏≠ÁöÑÊàêÂëò‰ø°ÊÅØÊõ¥Êñ∞`);
          }
        }
      }
    }
  }





 
  async function syncCharacterAvatarInGroups(characterChat) {

    if (!characterChat || characterChat.isGroup) {
      console.warn("syncCharacterAvatarInGroups: ‰º†ÂÖ•ÁöÑ‰∏çÊòØÊúâÊïàÁöÑÂçïËÅäÂØπË±°ÔºåÂ∑≤Ë∑≥ËøáÂêåÊ≠•„ÄÇ");
      return;
    }

    const characterId = characterChat.id;
    const newAvatar = characterChat.settings.aiAvatar;

    console.log(`Ê≠£Âú®‰∏∫ËßíËâ≤ ${characterId} ÂêåÊ≠•ÊâÄÊúâÁæ§ËÅäÂÜÖÁöÑÂ§¥ÂÉè...`);


    for (const groupChat of Object.values(state.chats)) {
      if (groupChat.isGroup && groupChat.members) {

        const memberToUpdate = groupChat.members.find(m => m.id === characterId);


        if (memberToUpdate && memberToUpdate.avatar !== newAvatar) {
          memberToUpdate.avatar = newAvatar;


          await db.chats.put(groupChat);
          console.log(`ÊàêÂäüÂ∞ÜËßíËâ≤ ${characterId} ÁöÑÊñ∞Â§¥ÂÉèÂêåÊ≠•Âà∞Áæ§ËÅä "${groupChat.name}"`);
        }
      }
    }
  }



  function getDisplayNameInGroup(groupChat, originalName) {

    if (!groupChat || !groupChat.isGroup || !originalName) {
      return originalName;
    }





    const userOriginalName = state.qzoneSettings.nickname || '{{user}}';
    if (originalName === userOriginalName) {

      return groupChat.settings.myNickname || 'Êàë';
    }


    const member = groupChat.members.find(m => m.originalName === originalName);


    return member ? member.groupNickname : originalName;
  }




  function switchRuleCategory(categoryId) {

    document.querySelectorAll('.rules-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });

    document.querySelectorAll('.rules-category-pane').forEach(pane => {
      pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
  }


 



  function getDisplayNameByOriginalName(nameIdentifier) {

    if (!nameIdentifier) return '';


    if (state.qzoneSettings && nameIdentifier === state.qzoneSettings.nickname) {
      return state.qzoneSettings.nickname;
    }



    let characterChat = Object.values(state.chats).find(chat => !chat.isGroup && chat.originalName === nameIdentifier);
    if (characterChat) {
      return characterChat.name;
    }


    characterChat = Object.values(state.chats).find(chat =>
      !chat.isGroup &&
      (chat.nameHistory && chat.nameHistory.includes(nameIdentifier))
    );
    if (characterChat) {
      return characterChat.name;
    }



    return nameIdentifier;
  }




 
  function processMentions(text, chat = null) {

    if (!text || typeof text !== 'string' || !text.includes('@[[')) {
      return text;
    }


    return text.replace(/@\[\[([^\]]+)\]\]/g, (match, originalName) => {
      const trimmedOriginalName = originalName.trim();
      let displayName;


      if (chat && chat.isGroup) {


        displayName = getDisplayNameInGroup(chat, trimmedOriginalName);
      } else {

        displayName = getDisplayNameByOriginalName(trimmedOriginalName);
      }


      return `@${displayName}`;
    });
  }




  function showCustomConfirm(title, message, options = {}) {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        modalBody.innerHTML = `<p>${message}</p>`;

        // --- „Äê‰øÆÂ§çÂºÄÂßã„ÄëÔºöÂº∫Âà∂ÈáçÁΩÆ Footer ÁªìÊûÑ ---
        // Âõ†‰∏∫ showChoiceModalÂèØËÉΩ‰ºöÁ†¥ÂùèFooterÁªìÊûÑÂØºËá¥ID‰∏¢Â§±ÔºåËøôÈáåÂøÖÈ°ªÈáçÂª∫
        const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
        if (modalFooter) {
            modalFooter.style.flexDirection = 'row'; // ÊÅ¢Â§çÊ®™ÂêëÂ∏ÉÂ±Ä
            modalFooter.style.justifyContent = 'flex-end'; // ÊåâÈíÆÈù†Âè≥
            modalFooter.innerHTML = `
              <button id="custom-modal-cancel">ÂèñÊ∂à</button>
              <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
          `;
        }
        // --- „Äê‰øÆÂ§çÁªìÊùü„Äë ---

        const confirmBtn = document.getElementById('custom-modal-confirm');
        const cancelBtn = document.getElementById('custom-modal-cancel');

        // Ê≠§Êó∂ cancelBtn ÂøÖÂÆöÂ≠òÂú®
        cancelBtn.style.display = 'block';

        confirmBtn.textContent = options.confirmText || 'Á°ÆÂÆö';
        cancelBtn.textContent = options.cancelText || 'ÂèñÊ∂à';

        if (options.confirmButtonClass) {
            confirmBtn.className = `confirm-btn ${options.confirmButtonClass}`; // ÈáçÁΩÆclassÂπ∂Ê∑ªÂä†Ëá™ÂÆö‰πâclass
        } else {
            confirmBtn.className = 'confirm-btn'; // ÊÅ¢Â§çÈªòËÆ§
        }

        confirmBtn.onclick = () => {
            resolve(true);
            hideCustomModal();
        };
        cancelBtn.onclick = () => {
            resolve(false);
            hideCustomModal();
        };
        showCustomModal();
    });
}

 
  function showDownloadToast(message = 'üì• ÂõæÁâá‰∏ãËΩΩ‰∏≠...', type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 10);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 2000);
  }

  function generateFilenameForNai(prompt) {
    let cleanTitle = (prompt || 'NAI_Image')
      .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '_')
      .replace(/\s+/g, '_')
      .substring(0, 30);

    const timestamp = new Date().toISOString()
      .replace(/[-:]/g, '')
      .replace('T', '_')
      .split('.')[0];

    return `${cleanTitle}_${timestamp}.png`;
  }


  function downloadNaiImage(imageSrc, prompt) {
    try {
      const filename = generateFilenameForNai(prompt);
      const link = document.createElement('a');
      link.href = imageSrc;
      link.download = filename;
      link.style.display = 'none';

      document.body.appendChild(link);
      link.click();

      setTimeout(() => {
        document.body.removeChild(link);
      }, 100);

      showDownloadToast('üì• ÂõæÁâá‰∏ãËΩΩ‰∏≠...');
    } catch (error) {
      console.error('‚ùå [NAI‰∏ãËΩΩ] ‰∏ãËΩΩÂ§±Ë¥•:', error);
      showDownloadToast('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
    }
  }
// --- Êñ∞Â¢ûÔºöÈ´òÁ´ØÈùû‰æµÂÖ•ÂºèÈÄöÁü• ---
function showToast(message, type = 'info', duration = 3000) {
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }

    // ÂÆö‰πâÂõæÊ†á (SVG)
    const icons = {
        success: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
        loading: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>`,
        error: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`,
        info: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
    };

    const iconSvg = icons[type] || icons.info;
    const spinClass = type === 'loading' ? 'spinning' : '';
    
    // Êô∫ËÉΩÊà™Êñ≠ËøáÈïøÁöÑÊ∂àÊÅØ
    const displayMsg = message.length > 25 ? message.substring(0, 24) + '...' : message;

    const toast = document.createElement('div');
    toast.className = 'toast-item';
    toast.innerHTML = `
        <div class="toast-icon ${spinClass}">${iconSvg}</div>
        <span>${displayMsg}</span>
    `;

    container.appendChild(toast);

    // Âä®ÁîªÂÖ•Âú∫
    requestAnimationFrame(() => {
        toast.classList.add('visible');
    });

    // Ëá™Âä®Ê∂àÂ§± (Â¶ÇÊûúÊòØ loading Á±ªÂûãÔºåÂàô‰∏çËá™Âä®Ê∂àÂ§±ÔºåÈúÄË¶ÅÂ§ñÈÉ®ÁßªÈô§ÈÄªËæëÔºåÊàñËÄÖÁÆÄÂçïÁÇπËÆæ‰∏™ÈïøÊó∂Èôê)
    if (type !== 'loading') {
        setTimeout(() => {
            toast.classList.remove('visible');
            setTimeout(() => toast.remove(), 400); // Á≠âÂæÖËøáÊ∏°ÁªìÊùü
        }, duration);
    }
    
    return toast; // ËøîÂõûÂÖÉÁ¥†‰ª•‰æøÊâãÂä®ÁßªÈô§
}
  function showCustomAlert(title, message) {
    return new Promise(resolve => {
      modalResolve = resolve;
      modalTitle.textContent = title;
      modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;

      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÂºÄÂßã„Äë ---
      // Ëé∑Âèñ Footer ÂÆπÂô®
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
      
      // Âº∫Âà∂ÈáçÁΩÆ Footer ÁªìÊûÑÔºåÈò≤Ê≠¢Ë¢´ showChoiceModal ‰øÆÊîπÂêéÂØºËá¥ ID ‰∏¢Â§±
      if (modalFooter) {
          modalFooter.style.flexDirection = 'row'; // ÊÅ¢Â§çÈªòËÆ§Ê®™ÂêëÂ∏ÉÂ±Ä
          modalFooter.innerHTML = `
              <button id="custom-modal-cancel">ÂèñÊ∂à</button>
              <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
          `;
      }
      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÁªìÊùü„Äë ---

      const confirmBtn = document.getElementById('custom-modal-confirm');
      const cancelBtn = document.getElementById('custom-modal-cancel');

      // Ê≠§Êó∂ confirmBtn Âíå cancelBtn ÂøÖÂÆöÂ≠òÂú®
      if (cancelBtn) cancelBtn.style.display = 'none';
      if (confirmBtn) confirmBtn.textContent = 'Â•ΩÁöÑ';

      if (confirmBtn) {
          confirmBtn.onclick = () => {
            if (cancelBtn) cancelBtn.style.display = 'block'; // ÊÅ¢Â§çÊòæÁ§∫Ôºå‰ª•ÂÖçÂΩ±ÂìçÂÖ∂‰ªñÂäüËÉΩ
            confirmBtn.textContent = 'Á°ÆÂÆö';
            resolve(true);
            hideCustomModal();
          };
      }
      
      if (cancelBtn) {
          cancelBtn.onclick = hideCustomModal;
      }

      showCustomModal();
    });
  }


  async function copyTextToClipboard(textToCopy, successMessage = 'ÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ') {
    if (!textToCopy) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÜÖÂÆπ„ÄÇ');
      return;
    }
    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', successMessage);
    } catch (err) {
      console.error('Â§çÂà∂Â§±Ë¥•:', err);
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }
  }

  // Êü•Êâæ function showCustomPrompt Âπ∂ÂÆåÂÖ®ÊõøÊç¢‰∏∫‰ª•‰∏ãÂÜÖÂÆπÔºö

function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
      modalResolve = resolve;
      modalTitle.textContent = title;
      const inputId = 'custom-prompt-input';

      const inputHtml = type === 'textarea' ?
        `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>` :
        `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;

      modalBody.innerHTML = extraHtml + inputHtml;
      const input = document.getElementById(inputId);

      // ÁªëÂÆöÈ¢ùÂ§ñÁöÑÊ†ºÂºèÂåñÊåâÈíÆ‰∫ã‰ª∂ÔºàÂ¶ÇÊûúÊúâÔºâ
      modalBody.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const templateStr = btn.dataset.template;
          if (templateStr) {
            try {
              const templateObj = JSON.parse(templateStr);
              input.value = JSON.stringify(templateObj, null, 2);
              input.focus();
            } catch (e) {
              console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
            }
          }
        });
      });

      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÂºÄÂßã„ÄëÔºöÂº∫Âà∂ÈáçÂª∫ Footer ÁªìÊûÑ ---
      // Èò≤Ê≠¢Âõ†‰∏∫‰πãÂâçË∞ÉÁî®Ëøá showChoiceModal ÂØºËá¥ÊåâÈíÆ‰∏¢Â§±
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');
      if (modalFooter) {
          modalFooter.style.flexDirection = 'row'; 
          modalFooter.style.justifyContent = 'flex-end'; 
          modalFooter.style.maxHeight = ''; 
          modalFooter.style.overflowY = '';
          
          // Êö¥ÂäõÈáçÁΩÆÔºöÊääÊåâÈíÆÂ°ûÂõûÂéª
          modalFooter.innerHTML = `
            <button id="custom-modal-cancel">ÂèñÊ∂à</button>
            <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
          `;
      }
      // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÁªìÊùü„Äë ---

      const confirmBtn = document.getElementById('custom-modal-confirm');
      const cancelBtn = document.getElementById('custom-modal-cancel');

      // Á°Æ‰øùÊåâÈíÆÂ≠òÂú®ÂêéÂÜçÊìç‰Ωú
      if (confirmBtn) {
          confirmBtn.textContent = 'Á°ÆÂÆö'; // ÈáçÁΩÆÂèØËÉΩË¢´‰øÆÊîπÁöÑÊñáÂ≠ó
          confirmBtn.className = 'confirm-btn'; // ÈáçÁΩÆÂèØËÉΩË¢´‰øÆÊîπÁöÑÊ†∑Âºè
          confirmBtn.style.display = 'block';
          
          confirmBtn.onclick = () => {
            resolve(input.value);
            hideCustomModal();
          };
      }

      if (cancelBtn) {
          cancelBtn.textContent = 'ÂèñÊ∂à';
          cancelBtn.style.display = 'block';
          
          cancelBtn.onclick = () => {
            resolve(null);
            hideCustomModal();
          };
      }

      showCustomModal();
      
      // Âä†‰∏™ÂÆâÂÖ®Âà§Êñ≠Èò≤Ê≠¢ input ‰∏∫Á©∫
      setTimeout(() => {
          if(input) input.focus();
      }, 100);
    });
}




 
  // Â¢ûÂº∫Áâà showChoiceModalÔºö‰ºòÂåñÊªëÂä®‰ΩìÈ™å
function showChoiceModal(title, options) {
    return new Promise(resolve => {
      const modal = document.getElementById('custom-modal-overlay');
      const modalTitle = document.getElementById('custom-modal-title');
      const modalBody = document.getElementById('custom-modal-body');
      const modalFooter = document.querySelector('#custom-modal .custom-modal-footer');

      modalTitle.textContent = title;
      modalBody.innerHTML = ''; // Ê∏ÖÁ©∫‰∏ª‰ΩìÔºåÈÄâÈ°π‰∏ªË¶ÅÂú® Footer

      // Ê∏ÖÁ©∫ Footer Âπ∂ËÆæÁΩÆ‰∏∫ÂàóÂ∏ÉÂ±Ä
      modalFooter.innerHTML = '';
      modalFooter.style.flexDirection = 'column';
      
      // --- „ÄêÊ†∏ÂøÉ‰ºòÂåñÔºöÊªëÂä®ËÆæÁΩÆ„Äë ---
      modalFooter.style.maxHeight = '50vh'; // ÈôêÂà∂È´òÂ∫¶ÔºåÁïôÂá∫Á©∫Èó¥
      modalFooter.style.overflowY = 'auto'; // ÂÖÅËÆ∏ÂûÇÁõ¥ÊªöÂä®
      modalFooter.style.webkitOverflowScrolling = 'touch'; // iOS ÊµÅÁïÖÊªöÂä®
      modalFooter.style.overscrollBehavior = 'contain'; // Èò≤Ê≠¢ÊªöÂä®Á©øÈÄèÂà∞Â∫ïÂ±Ç
      modalFooter.style.padding = '10px'; // Â¢ûÂä†ÂÜÖËæπË∑ù
      modalFooter.style.gap = '8px'; // ÊåâÈíÆÈó¥Ë∑ù
      // ---------------------------

      // --- ÂàÜÈ°µÈÄªËæëÂºÄÂßã ---
      let renderedCount = 0;
      const PAGE_SIZE = 10; // ÊØèÊ¨°Âä†ËΩΩ10‰∏™
      
      // ÂàõÂª∫‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ
      const loadMoreBtn = document.createElement('button');
      loadMoreBtn.textContent = 'Âä†ËΩΩÊõ¥Â§ö...';
      loadMoreBtn.style.cssText = 'background-color: #f0f0f0; color: #666; margin-top: 8px; width: 100%; border-radius: 8px; padding: 10px; border: none;';
      loadMoreBtn.style.display = 'none'; // ÂàùÂßãÈöêËóè

      // Ê∏≤ÊüìÂáΩÊï∞
      const renderBatch = () => {
        const nextBatch = options.slice(renderedCount, renderedCount + PAGE_SIZE);
        
        nextBatch.forEach(option => {
          const button = document.createElement('button');
          
          // ÂÖÅËÆ∏Ê∏≤Êüì HTML ÂÜÖÂÆπ
          button.innerHTML = option.text; 
          
          // Ê∑ªÂä†ÁæéÂåñÁ±ªÂêçÂíåÊ†∑Âºè
          button.className = 'payment-option-item'; 
          button.style.width = '100%';
          button.style.textAlign = 'left';
          button.style.padding = '12px 15px';
          button.style.marginBottom = '0'; // Áî±Áà∂ÂÆπÂô® gap ÊéßÂà∂
          
          button.onclick = () => {
            modal.classList.remove('visible');
            resolve(option.value);
          };
          // ÊèíÂÖ•Âà∞‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆ‰πãÂâç
          modalFooter.insertBefore(button, loadMoreBtn);
        });

        renderedCount += nextBatch.length;

        // Â¶ÇÊûúËøòÊúâÂâ©‰ΩôÈÄâÈ°πÔºåÊòæÁ§∫Âä†ËΩΩÊõ¥Â§öÊåâÈíÆÔºåÂê¶ÂàôÈöêËóè
        if (renderedCount < options.length) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.textContent = `Âä†ËΩΩÊõ¥Â§ö (${options.length - renderedCount} ‰∏™Ââ©‰Ωô)`;
        } else {
            loadMoreBtn.style.display = 'none';
        }
      };

      // ÁªëÂÆöÂä†ËΩΩÊõ¥Â§ö‰∫ã‰ª∂
      loadMoreBtn.onclick = (e) => {
          e.stopPropagation(); 
          renderBatch();
      };

      // ÂÖàÊääÂä†ËΩΩÊõ¥Â§öÊåâÈíÆÊîæËøõÂéª
      modalFooter.appendChild(loadMoreBtn);

      // ÂàùÂßãÊ∏≤ÊüìÁ¨¨‰∏ÄÈ°µ
      renderBatch();
      // --- ÂàÜÈ°µÈÄªËæëÁªìÊùü ---

      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'ÂèñÊ∂à';
      cancelButton.style.marginTop = '15px'; 
      cancelButton.style.borderRadius = '8px';
      cancelButton.style.backgroundColor = '#fff';
      cancelButton.style.border = '1px solid #ddd';
      cancelButton.style.color = '#666';
      cancelButton.style.padding = '12px';
      cancelButton.style.width = '100%';
      
      cancelButton.onclick = () => {
        modal.classList.remove('visible');
        resolve(null);
      };
      modalFooter.appendChild(cancelButton);

      modal.classList.add('visible');

    }).finally(() => {
      // Promise ÁªìÊùüÂêéÁöÑÊ∏ÖÁêÜÂ∑•‰ΩúÔºàÂ¶ÇÊûúÊúâÔºâ
    });
}



  
  async function getLrcContent() {

    const choice = await showChoiceModal('ÈÄâÊã©Ê≠åËØçÂØºÂÖ•ÊñπÂºè', [{
        text: 'üìÅ ‰ªéÊú¨Âú∞Êñá‰ª∂ (.lrc)',
        value: 'file'
      },
      {
        text: 'üìã Áõ¥Êé•Á≤òË¥¥Ê≠åËØçÊñáÊú¨',
        value: 'paste'
      }
    ]);


    if (choice === 'file') {

      return new Promise(resolve => {
        const lrcInput = document.getElementById('lrc-upload-input');
        const lrcChangeHandler = (e) => {
          const lrcFile = e.target.files[0];
          if (lrcFile) {
            const reader = new FileReader();
            reader.onload = (readEvent) => resolve(readEvent.target.result);
            reader.onerror = () => resolve("");
            reader.readAsText(lrcFile);
          } else {
            resolve(null);
          }
          lrcInput.removeEventListener('change', lrcChangeHandler);
          lrcInput.value = '';
        };
        lrcInput.addEventListener('change', lrcChangeHandler, {
          once: true
        });
        lrcInput.click();
      });
    } else if (choice === 'paste') {

      const pastedText = await showCustomPrompt(
        'Á≤òË¥¥Ê≠åËØç',
        'ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥ÂÆåÊï¥ÁöÑLRCÊ†ºÂºèÊ≠åËØç...',
        '',
        'textarea'
      );


      if (pastedText) {


        const formattedText = pastedText.replace(/\[/g, '\n[').trim();
        return formattedText;
      }
      return pastedText;


    } else {

      return null;
    }
  }




var db; // Â£∞ÊòéÂÖ®Â±ÄÂèòÈáèÔºå‰ΩÜ‰∏çÂàùÂßãÂåñ
const APP_SECRET = "EPHONE_2026_SUPER_SECRET_KEY_V1"; // ÂøÖÈ°ª‰∏éÊú∫Âô®‰∫∫‰∏ÄËá¥

// HMAC-SHA256 È™åËØÅÂáΩÊï∞
function verifyLogin(uid, pwd) {
    if (!uid || !pwd) return false;
    
    // 1. ËÆ°ÁÆó HMAC-SHA256 (ÂæóÂà∞ÂéüÂßãÊï∞ÊçÆ)
    const rawHash = CryptoJS.HmacSHA256(uid.trim(), APP_SECRET);
    
    // 2. ËΩ¨‰∏∫ Base64 Â≠óÁ¨¶‰∏≤ (Â§©ÁÑ∂ÂåÖÂê´Â§ßÂ∞èÂÜôÂ≠óÊØçÂíåÊï∞Â≠ó)
    let base64 = CryptoJS.enc.Base64.stringify(rawHash);
    
    // 3. Êà™ÂèñÂâç 12 ‰Ωç (Â¢ûÂä†ÈïøÂ∫¶)
    let generated = base64.substring(0, 12);
    
    // 4. Âº∫Âà∂ÊèíÂÖ•ÁâπÊÆäÁ¨¶Âè∑ (Â¢ûÂº∫Â§çÊùÇÂ∫¶)
    // Â∞ÜÂ≠óÁ¨¶‰∏≤ËΩ¨‰∏∫Êï∞ÁªÑËøõË°åÊõøÊç¢
    let chars = generated.split('');
    chars[2] = '@';  // Á¨¨3‰ΩçÂº∫Âà∂Âèò‰∏∫ @
    chars[7] = '!';  // Á¨¨8‰ΩçÂº∫Âà∂Âèò‰∏∫ !
    
    // ÈáçÊñ∞ÁªÑÂêà
    const correctPassword = chars.join('');
    
    // console.log("Ê≠£Á°ÆÂØÜÁ†ÅÂ∫î‰∏∫:", correctPassword); // Ë∞ÉËØïÁî®Ôºå‰∏äÁ∫øÂèØÊ≥®Èáä
    return pwd.trim() === correctPassword;
}

// Âä®ÊÄÅÂàùÂßãÂåñÊï∞ÊçÆÂ∫ìÂáΩÊï∞
function initDatabase(userId) {
    // Êï∞ÊçÆÂ∫ìÂêçÂ∏¶‰∏äÁî®Êà∑IDÔºåÂÆûÁé∞ÊØè‰∏™‰∫∫Êï∞ÊçÆÈöîÁ¶ª
    db = new Dexie('GeminiChatDB');

  db.version(49).stores({
    doubanPosts: '++id, timestamp',
    chats: '&id, isGroup, groupId, isPinned, memos, diary, appUsageLog, lastIntelligentSummaryTimestamp',
    apiConfig: '&id, minimaxGroupId, minimaxApiKey',
    globalSettings: '&id',
    userStickers: '&id, url, name, categoryId',
    worldBooks: '&id, name, categoryId',
    worldBookCategories: '++id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp, authorId',
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate',
    callRecords: '++id, chatId, timestamp, customName',
    shoppingProducts: '++id, name, description',
    shoppingCategories: '++id, name',
    apiPresets: '++id, name',
    renderingRules: '++id, name, chatId',
    appearancePresets: '++id, name, type',
    stickerCategories: '++id, name',
    customAvatarFrames: '++id, name',
    presets: '&id, name, categoryId',
    presetCategories: '++id, name',
    readingLibrary: '++id, title, lastOpened, linkedStoryId',
    quickReplies: '++id, text, categoryId', // ‰øÆÊîπÔºöÂ¢ûÂä† categoryId Á¥¢Âºï
    quickReplyCategories: '++id, name',
    npcs: '++id, name, npcGroupId, enableBackgroundActivity, actionCooldownMinutes, lastActionTimestamp',
    npcGroups: '++id, name',
    naiPresets: '++id, name',
    grAuthors: '++id, name',
    grStories: '++id, title, authorId, lastUpdated',
    userWallet: '&id',
    userTransactions: '++id, timestamp, type, amount, description',
    funds: '&id, code, name, riskLevel, currentNav, lastDayNav, history',
    auctions: '++id, status, itemName, endTime', // ÊãçÂçñËÆ∞ÂΩï
    inventory: '++id, name, type, acquiredTime',
    emails: '++id, sender, senderType, recipient, subject, content, timestamp, isRead'
  }).upgrade(tx => {

    return tx.table('worldBooks').toCollection().modify(book => {

      if (typeof book.content === 'string' && book.content.trim() !== '') {
        book.content = [{
          keys: [],
          comment: '‰ªéÊóßÁâàÊú¨ËøÅÁßªÁöÑÊù°ÁõÆ',
          content: book.content
        }];
      } else if (!Array.isArray(book.content)) {
        book.content = [];
      }


      book.content.forEach(entry => {
        if (typeof entry.enabled === 'undefined') {
          entry.enabled = true;
        }
      });
    });
  });
 window.db = db;
    console.log(`[System] Â∑≤Âä†ËΩΩÁî®Êà∑ ${userId} ÁöÑÊï∞ÊçÆÂ∫ì`);
}
  




  function showScreen(screenId) {
    if (screenId === 'chat-list-screen') {
      window.renderChatListProxy();
      switchToChatListView('messages-view');
    }
    if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
    if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
    if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
    if (screenId === 'x-social-screen') window.renderXSocialScreenProxy();
    if (screenId === 'douban-screen') renderDoubanScreen();
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screenToShow = document.getElementById(screenId);
    if (screenToShow) screenToShow.classList.add('active');
    if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
    if (screenId === 'font-settings-screen') {
      loadFontPresetsDropdown();
      document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
      applyCustomFont(state.globalSettings.fontUrl || '', true);
    }
    
    // Âä†ËΩΩËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°ËÆæÁΩÆ
    if (screenId === 'chat-settings-screen' && state.activeChatId) {
      if (typeof window.loadVideoCallSettings === 'function') {
        window.loadVideoCallSettings(state.activeChatId);
      }
    }
    
    // ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº ËßÇÂΩ±ÂÆ§ËßíËâ≤ÂàóË°®Âà∑Êñ∞ ‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº‚ñº
    // ÂΩìÂàáÊç¢Âà∞ËßÇÂΩ±ÂÆ§Êó∂ÔºåÂº∫Âà∂Âà∑Êñ∞ËßíËâ≤ÂàóË°®
    if (screenId === 'movie-screen') {
        console.log("ËøõÂÖ•ËßÇÂΩ±ÂÆ§ÔºåÊ≠£Âú®Âà∑Êñ∞ËßíËâ≤ÂàóË°®...");
        setTimeout(() => {
            if (typeof window.loadCharacterList === 'function') {
                window.loadCharacterList(); // Ë∞ÉÁî®ËßÇÂΩ±ÂÆ§Ê®°ÂùóÊö¥Èú≤Âá∫Êù•ÁöÑÂä†ËΩΩÂáΩÊï∞
            } else {
                console.warn("Êú™ÊâæÂà∞ loadCharacterList ÂáΩÊï∞ÔºåÂ∞ùËØïÂÜçÊ¨°Âª∂ËøüÂä†ËΩΩ");
                setTimeout(() => {
                     if (typeof window.loadCharacterList === 'function') window.loadCharacterList();
                }, 500);
            }
        }, 100); // Á®çÂæÆÂª∂Ëøü‰ª•Á°Æ‰øùÊï∞ÊçÆÂ∑≤Â∞±Áª™
    }
    // ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤ ËßÇÂΩ±ÂÆ§ËßíËâ≤ÂàóË°®Âà∑Êñ∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤‚ñ≤
  }
  window.updateListenTogetherIconProxy = () => {};

  function switchToChatListView(viewId) {
    const chatListScreen = document.getElementById('chat-list-screen');
    const views = {
      'messages-view': document.getElementById('messages-view'),
      'qzone-screen': document.getElementById('qzone-screen'),
      'favorites-view': document.getElementById('favorites-view'),
      'memories-view': document.getElementById('memories-view'),
      'npc-list-view': document.getElementById('npc-list-view')
    };
    const mainHeader = document.getElementById('main-chat-list-header');
    const mainBottomNav = document.getElementById('chat-list-bottom-nav');

    if (isFavoritesSelectionMode) {
      document.getElementById('favorites-edit-btn').click();
    }


    Object.values(views).forEach(v => v.classList.remove('active'));

    if (views[viewId]) {
      views[viewId].classList.add('active');
    }


    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
      item.classList.toggle('active', item.dataset.view === viewId);
    });


    if (viewId === 'messages-view') {
      mainHeader.style.display = 'flex';
      mainBottomNav.style.display = 'flex';
    } else {
      mainHeader.style.display = 'none';
      mainBottomNav.style.display = 'none';
    }


    if (viewId !== 'memories-view') {
      activeCountdownTimers.forEach(timerId => clearInterval(timerId));
      activeCountdownTimers = [];
    }


    switch (viewId) {
      case 'qzone-screen':
        views['qzone-screen'].style.backgroundColor = '#f0f2f5';
        updateUnreadIndicator(0);
        renderQzoneScreen();
        renderQzonePosts();
        break;
      case 'favorites-view':
        views['favorites-view'].style.backgroundColor = '#f9f9f9';
        renderFavoritesScreen();
        break;
      case 'messages-view':

        break;
      case 'npc-list-view':
        renderNpcListScreen();
        break;
    }
  }

  function renderXSocialScreen() {

    console.log("Ê∏≤ÊüìXÁ§æ‰∫§È°µÈù¢");
  }
  window.renderXSocialScreenProxy = renderXSocialScreen;

  function renderQzoneScreen() {
    if (state && state.qzoneSettings) {
      const settings = state.qzoneSettings;
      document.getElementById('qzone-nickname').textContent = settings.nickname;
      document.getElementById('qzone-avatar-img').src = settings.avatar;
      document.getElementById('qzone-banner-img').src = settings.banner;
    }
  }
  window.renderQzoneScreenProxy = renderQzoneScreen;

  async function saveQzoneSettings() {
    if (db && state.qzoneSettings) {
      await db.qzoneSettings.put(state.qzoneSettings);
    }
  }

  function formatPostTimestamp(timestamp) {
    if (!timestamp) return '';
    const now = new Date();
    const date = new Date(timestamp);
    const diffSeconds = Math.floor((now - date) / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffMinutes < 1) return 'ÂàöÂàö';
    if (diffMinutes < 60) return `${diffMinutes}ÂàÜÈíüÂâç`;
    if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    if (now.getFullYear() === year) {
      return `${month}-${day} ${hours}:${minutes}`;
    } else {
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }
  }



  
  


  



  






  async function createOrUpdatePostElement(post) {
    const existingPostContainer = document.querySelector(`.qzone-post-container[data-post-id="${post.id}"]`);
    const isUpdating = !!existingPostContainer;

    const postContainer = isUpdating ? existingPostContainer : document.createElement('div');
    if (!isUpdating) {
      postContainer.className = 'qzone-post-container';
      postContainer.dataset.postId = post.id;
    }

    const postEl = isUpdating ? postContainer.querySelector('.qzone-post-item') : document.createElement('div');
    if (!isUpdating) {
      postEl.className = 'qzone-post-item';
    }

    let authorAvatar = '',
      authorNickname = '',
      commentAvatar = state.qzoneSettings.avatar;


    if (post.authorId === 'user') {
      authorAvatar = state.qzoneSettings.avatar;
      authorNickname = state.qzoneSettings.nickname;
    } else if (state.chats[post.authorId]) {
      const authorChat = state.chats[post.authorId];
      authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
      authorNickname = authorChat.name;
    } else if (String(post.authorId).startsWith('npc_')) {

      const npcId = parseInt(String(post.authorId).replace('npc_', ''));
      if (!isNaN(npcId)) {
        const npc = await db.npcs.get(npcId);
        if (npc) {
          authorAvatar = npc.avatar || defaultGroupMemberAvatar;
          authorNickname = npc.name;
        } else {
          authorNickname = post.authorOriginalName || 'Êú™Áü•NPC';
          authorAvatar = defaultGroupMemberAvatar;
        }
      }
    } else {

      authorNickname = getDisplayNameByOriginalName(post.authorOriginalName);
      authorAvatar = defaultAvatar;
    }


    function renderOriginalPostContent(targetPost) {
      let innerContentHtml = '';
      const publicTextHtml = targetPost.publicText ? `<div class="post-content">${parseMarkdown(targetPost.publicText).replace(/\n/g, '<br>')}</div>` : '';

      if (targetPost.type === 'shuoshuo') {
        innerContentHtml = `<div class="post-content" style="margin-bottom: 10px;">${parseMarkdown(targetPost.content).replace(/\n/g, '<br>')}</div>`;
      } else if (targetPost.type === 'image_post' && targetPost.imageUrl) {

        innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${targetPost.imageUrl}" class="chat-image"></div>` : `<img src="${targetPost.imageUrl}" class="chat-image">`;
      } else if (targetPost.type === 'text_image') {

        const postImageUrl = state.globalSettings.enableAiDrawing && targetPost.image_prompt ? `https://image.pollinations.ai/prompt/${targetPost.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
        innerContentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${targetPost.hiddenContent}">`;
      } else if (targetPost.type === 'naiimag') {
       
        const imageUrls = targetPost.imageUrls || (targetPost.imageUrl ? [targetPost.imageUrl] : []);

        if (imageUrls.length > 0) {
          const imageCount = imageUrls.length;
          let imagesHtml = '';

          // ‰ΩøÁî®Áªü‰∏ÄÁöÑÂ§öÂõæÂ∏ÉÂ±ÄÔºàÂåÖÊã¨ÂçïÂº†ÂõæÁâáÔºâ
          imagesHtml = `<div class="post-images-grid grid-${imageCount}">`;
          imageUrls.forEach((url, index) => {
            imagesHtml += `<img src="${url}" class="naiimag-image" alt="ÂõæÁâá${index + 1}" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';">`;
          });
          imagesHtml += '</div>';

          innerContentHtml = publicTextHtml ? `${publicTextHtml}${imagesHtml}` : imagesHtml;
        }
      }
      return innerContentHtml;
    }

    let mainContentHtml;

    if (post.type === 'repost') {
      const repostCommentHtml = post.repostComment ? `<div class="post-content">${post.repostComment.replace(/\n/g, '<br>')}</div>` : '';
      let originalAuthorAvatar = defaultAvatar;
      let originalAuthorNickname = 'Âéü‰ΩúËÄÖ';
      if (post.originalPost.authorId === 'user') {
        originalAuthorAvatar = state.qzoneSettings.avatar;
        originalAuthorNickname = state.qzoneSettings.nickname;
      } else {
        const originalAuthorChat = state.chats[post.originalPost.authorId];
        if (originalAuthorChat) {
          originalAuthorAvatar = originalAuthorChat.settings.aiAvatar || defaultAvatar;
        }
        originalAuthorNickname = getDisplayNameByOriginalName(post.originalPost.authorOriginalName);
      }
      mainContentHtml = `
                    ${repostCommentHtml}
                    <div class="reposted-content-wrapper">
                        <div class="post-header">
                            <img src="${originalAuthorAvatar}" class="post-avatar">
                            <div class="post-info">
                                <span class="post-nickname">@${originalAuthorNickname}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.originalPost.timestamp)}</span>
                            </div>
                        </div>
                        <div class="post-main-content">${renderOriginalPostContent(post.originalPost)}</div>
                    </div>
                `;
    } else {
      mainContentHtml = `<div class="post-main-content">${renderOriginalPostContent(post)}</div>`;
    }

    let likesHtml = '';
    if (post.likes && post.likes.length > 0) {
      const displayLikes = post.likes.map(name => getDisplayNameByOriginalName(name)).join('„ÄÅ');
      likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${displayLikes} ËßâÂæóÂæàËµû</span></div>`;
    }


    let commentsHtml = '';
    if (post.comments && post.comments.length > 0) {
      commentsHtml = '<div class="post-comments-container">';
      post.comments.forEach((comment, index) => {

        if (typeof comment === 'object' && comment !== null && comment.commenterName) {
          const commenterOriginalName = comment.commenterName;

          const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);

          let innerCommentContent;
          if (STICKER_REGEX.test(comment.text)) {
            innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
          } else {
            innerCommentContent = parseMarkdown(comment.text);
          }

          let commentLineHtml = '';

          if (comment.replyTo) {
            const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> ÂõûÂ§ç <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
          } else {
            commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
          }

          commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                            <div class="comment-text">${commentLineHtml}</div>
                                            <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                                         </div>`;

        } else {

          commentsHtml += `<div class="legacy-comment-item">
                                            <span class="comment-text">${String(comment)}</span>
                                         </div>`;
        }
      });
      commentsHtml += '</div>';
    }


    const userOriginalName = state.qzoneSettings.nickname;
    const isLikedByUser = post.likes && post.likes.includes(userOriginalName);
    const isFavoritedByUser = state.favoritedPostIds && state.favoritedPostIds.has(post.id);

    let repostIconHtml = '';
    if (post.type !== 'repost') {
      repostIconHtml = `
                    <span class="action-icon repost">
                        <svg viewBox="0 0 24 24"><path d="M17 2.1l4 4-4 4 M3 11.5v-3a4 4 0 0 1 4-4h13 M7 21.9l-4-4 4-4 M21 12.5v3a4 4 0 0 1-4 4H4"></path></svg>
                    </span>`;
    }

    postEl.innerHTML = `
                <div class="post-header">
                    <img src="${authorAvatar}" class="post-avatar" data-author-id="${post.authorId}">
                    <div class="post-info">
                        <span class="post-nickname">${authorNickname}</span>
                        <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                    </div>
                    <div class="post-actions-btn">‚Ä¶</div>
                </div>
                ${mainContentHtml}
                <div class="post-feedback-icons">
                    ${repostIconHtml}
                    <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                    <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                </div>
                ${likesHtml}
                ${commentsHtml}
                <div class="post-footer">
                    <div class="comment-section">
                        <img src="${commentAvatar}" class="comment-avatar">
                        <input type="text" class="comment-input" placeholder="ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ">
                        <button class="comment-sticker-btn">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 14 Q 12 16 16 14"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
        </button>
                        <div class="at-mention-popup"></div>
                    </div>
                    <button class="comment-send-btn">ÂèëÈÄÅ</button>
                </div>
            `;

    if (!isUpdating) {
      const deleteAction = document.createElement('div');
      deleteAction.className = 'qzone-post-delete-action';
      deleteAction.innerHTML = '<span>Âà†Èô§</span>';
      postContainer.appendChild(postEl);
      postContainer.appendChild(deleteAction);
    }

    return postContainer;
  }

 
  async function updateSinglePostInDOM(postId) {
    const postData = await db.qzonePosts.get(postId);
    if (!postData) {

      const postContainer = document.querySelector(`.qzone-post-container[data-post-id="${postId}"]`);
      if (postContainer) {
        postContainer.remove();
      }
      return;
    }


    const cacheIndex = qzonePostsCache.findIndex(p => p.id === postId);
    if (cacheIndex > -1) {
      qzonePostsCache[cacheIndex] = postData;
    }


    const favorites = await db.favorites.where('type').equals('qzone_post').toArray();
    state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));


    await createOrUpdatePostElement(postData);
  }




  async function renderQzonePosts() {
    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) return;

    const [postsFromDb, favorites] = await Promise.all([
      db.qzonePosts.orderBy('timestamp').reverse().filter(post => !post.isDeleted).toArray(),
      db.favorites.where('type').equals('qzone_post').toArray()
    ]);
    qzonePostsCache = postsFromDb;
    state.favoritedPostIds = new Set(favorites.map(fav => fav.content.id));

    postsListEl.innerHTML = '';
    qzonePostsRenderCount = 0;

    if (qzonePostsCache.length === 0) {
      postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºåÂø´Êù•ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ËØ¥ËØ¥ÂêßÔºÅ</p>';
      return;
    }


    loadMoreQzonePosts();
  }




  async function loadMoreQzonePosts() {
    if (isLoadingMorePosts) return;
    isLoadingMorePosts = true;

    const postsListEl = document.getElementById('qzone-posts-list');
    if (!postsListEl) {
      isLoadingMorePosts = false;
      return;
    }

    showLoader(postsListEl, 'bottom');


    setTimeout(async () => {
      hideLoader(postsListEl);

      const nextSliceStart = qzonePostsRenderCount;
      const nextSliceEnd = qzonePostsRenderCount + QZONE_RENDER_WINDOW;
      const postsToAppend = qzonePostsCache.slice(nextSliceStart, nextSliceEnd);

      const fragment = document.createDocumentFragment();
      for (const post of postsToAppend) {
        const postElement = await createOrUpdatePostElement(post);
        fragment.appendChild(postElement);
      }
      postsListEl.appendChild(fragment);

      qzonePostsRenderCount += postsToAppend.length;

      isLoadingMorePosts = false;
    }, 500);
  }



  function openQzoneStickerPanel(postId, buttonElement) {
    const panel = qzoneStickerPanelState.panelEl;
    const grid = qzoneStickerPanelState.gridEl;


    grid.innerHTML = '';
    if (state.userStickers.length === 0) {
      grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">ËØ∑ÂÖàÂú®ËÅäÂ§©ÁïåÈù¢ÁöÑ<br>Ë°®ÊÉÖÈù¢Êùø‰∏≠Ê∑ªÂä†Ë°®ÊÉÖÂåÖ</p>';
    } else {
      state.userStickers.forEach(sticker => {
        const item = document.createElement('div');
        item.className = 'sticker-item';
        item.style.backgroundImage = `url(${sticker.url})`;
        item.title = sticker.name;
        grid.appendChild(item);
      });
    }




    const btnRect = buttonElement.getBoundingClientRect();
    const phoneScreenRect = document.getElementById('phone-screen').getBoundingClientRect();

    panel.style.display = 'flex';
    const panelRect = panel.getBoundingClientRect();
    const panelHeight = panelRect.height;
    const panelWidth = panelRect.width;


    panel.style.top = `${btnRect.top - panelHeight - 5 - phoneScreenRect.top}px`;


    const desiredLeftPosition = btnRect.left - phoneScreenRect.left;


    if (desiredLeftPosition + panelWidth > phoneScreenRect.width) {

      panel.style.left = 'auto';
      panel.style.right = '5px';
    } else {

      panel.style.left = `${desiredLeftPosition}px`;
      panel.style.right = 'auto';
    }




    qzoneStickerPanelState.isOpen = true;
    qzoneStickerPanelState.activePostId = postId;
  }



  function closeQzoneStickerPanel() {

    if (qzoneStickerPanelState.isOpen) {

      qzoneStickerPanelState.panelEl.style.display = 'none';


      qzoneStickerPanelState.isOpen = false;
      qzoneStickerPanelState.activePostId = null;
    }
  }





 
  async function sendQzoneStickerComment(postId, sticker) {
    if (!sticker || !sticker.url) return;

    const post = await db.qzonePosts.get(postId);
    if (!post) {
      console.error("sendQzoneStickerComment: Êâæ‰∏çÂà∞Â∏ñÂ≠ê:", postId);
      return;
    }

    if (!post.comments) {
      post.comments = [];
    }

    const newComment = {
      commenterName: state.qzoneSettings.nickname,
      text: sticker.url,
      meaning: sticker.name,
      timestamp: Date.now()
    };

    post.comments.push(newComment);

    await db.qzonePosts.update(postId, {
      comments: post.comments
    });

    closeQzoneStickerPanel();
    await renderQzonePosts();

    const postSummary = (post.publicText || post.content || `[ÂõæÁâáÂä®ÊÄÅ]`).substring(0, 30);


    for (const chatId in state.chats) {
      const chat = state.chats[chatId];
      if (!chat.isGroup) {
        const intelligentPrompt = `[Á≥ªÁªüÊèêÁ§∫Ôºö'${state.qzoneSettings.nickname}' Âú®‰Ω†ÁöÑÂä®ÊÄÅ(ID: ${postId}, ÂÜÖÂÆπÊëòË¶Å: ‚Äú${postSummary}‚Äù)‰∏ãÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${sticker.name}‚Äù„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;

        const historyMessage = {
          role: 'system',
          content: intelligentPrompt,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(historyMessage);
        await db.chats.put(chat);
      }
    }

  }






  
  function openRepostModal(postId) {
    repostTargetId = postId;
    document.getElementById('repost-comment-input').value = '';
    document.getElementById('repost-modal').classList.add('visible');
  }


  function hideRepostModal() {
    document.getElementById('repost-modal').classList.remove('visible');
    repostTargetId = null;
  }

 
  async function handleConfirmRepost() {
    if (!repostTargetId) return;

    const comment = document.getElementById('repost-comment-input').value.trim();
    const originalPost = await db.qzonePosts.get(repostTargetId);

    if (!originalPost) {
      alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞Ë¶ÅËΩ¨ÂèëÁöÑÂéüÂßãÂä®ÊÄÅ„ÄÇ");
      hideRepostModal();
      return;
    }

    const newPost = {
      type: 'repost',
      timestamp: Date.now(),
      authorId: 'user',
      repostComment: comment,
      originalPost: originalPost,
      visibleGroupIds: null
    };

    await db.qzonePosts.add(newPost);
    hideRepostModal();
    await renderQzonePosts();
    alert('ËΩ¨ÂèëÊàêÂäüÔºÅ');
  }




  function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
      const searchTerm = document.getElementById('favorites-search-input').value;
      const message = searchTerm ? 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥Êî∂Ëóè' : '‰Ω†ÁöÑÊî∂ËóèÂ§πÊòØÁ©∫ÁöÑÔºå<br>Âø´ÂéªÂä®ÊÄÅÊàñËÅäÂ§©‰∏≠Êî∂ËóèÂñúÊ¨¢ÁöÑÂÜÖÂÆπÂêßÔºÅ';
      listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
      return;
    }

    for (const item of items) {
      const card = document.createElement('div');
      card.className = 'favorite-item-card';
      card.dataset.favid = item.id;

      let headerHtml = '',
        contentHtml = '',
        sourceText = '',
        footerHtml = '';

      if (item.type === 'qzone_post') {
        const post = item.content;
        sourceText = 'Êù•Ëá™Âä®ÊÄÅ';
        let authorAvatar = defaultAvatar,
          authorNickname = 'Êú™Áü•Áî®Êà∑';

        if (post.authorId === 'user') {
          authorAvatar = state.qzoneSettings.avatar;
          authorNickname = state.qzoneSettings.nickname;
        } else if (state.chats[post.authorId]) {
          authorAvatar = state.chats[post.authorId].settings.aiAvatar;
          authorNickname = state.chats[post.authorId].name;
        }

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;

        const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
        if (post.type === 'shuoshuo') {
          contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
        } else if (post.type === 'image_post' && post.imageUrl) {
          const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
          contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image"></div>` : `<img src="${postImageUrl}" class="chat-image">`;
        } else if (post.type === 'text_image') {
          const postImageUrl = state.globalSettings.enableAiDrawing && post.image_prompt ? `https://image.pollinations.ai/prompt/${post.image_prompt}` : 'https://i.postimg.cc/KYr2qRCK/1.jpg';
          contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="${postImageUrl}" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
        }




        let likesHtml = '';

        if (post.likes && post.likes.length > 0) {

          likesHtml = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>${post.likes.join('„ÄÅ')} ËßâÂæóÂæàËµû</span>
                            </div>`;
        }



        let commentsHtml = '';
        if (post.comments && post.comments.length > 0) {
          commentsHtml = '<div class="post-comments-container">';
          post.comments.forEach((comment, index) => {

            if (typeof comment === 'object' && comment !== null && comment.commenterName) {

              const commenterOriginalName = comment.commenterName;
              const commenterDisplayName = getDisplayNameByOriginalName(commenterOriginalName);

              let innerCommentContent;
              if (STICKER_REGEX.test(comment.text)) {
                innerCommentContent = `<img src="${comment.text}" class="comment-sticker" alt="sticker">`;
              } else {
                innerCommentContent = comment.text;
              }

              let commentLineHtml = '';
              if (comment.replyTo) {
                const repliedToDisplayName = getDisplayNameByOriginalName(comment.replyTo);
                commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span> ÂõûÂ§ç <span class="commenter-name">${repliedToDisplayName}</span>: ${innerCommentContent}`;
              } else {
                commentLineHtml = `<span class="commenter-name">${commenterDisplayName}</span>: ${innerCommentContent}`;
              }

              commentsHtml += `<div class="comment-item" data-post-id="${post.id}" data-commenter-original-name="${commenterOriginalName}" data-commenter-display-name="${commenterDisplayName}">
                                        <div class="comment-text">${commentLineHtml}</div>
                                        <span class="comment-delete-btn" data-comment-index="${index}">√ó</span>
                                     </div>`;

            } else {


              commentsHtml += `<div class="legacy-comment-item">
                                        <span class="comment-text">${String(comment)}</span>
                                     </div>`;
            }
          });
          commentsHtml += '</div>';
        }



        footerHtml = `${likesHtml}${commentsHtml}`;



      } else if (item.type === 'chat_message') {
        const msg = item.content;
        const chat = state.chats[item.chatId];
        if (!chat) continue;

        sourceText = `Êù•Ëá™‰∏é ${chat.name} ÁöÑËÅäÂ§©`;
        const isUser = msg.role === 'user';
        let senderName, senderAvatar;

        if (isUser) {

          senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
          senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
        } else {
          if (chat.isGroup) {


            const member = chat.members.find(m => m.originalName === msg.senderName);


            senderName = msg.senderName;

            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
          } else {

            senderName = chat.name;
            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
          }
        }


        headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;

        if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
          contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
        } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
          contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
        } else {
          contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
        }
      } else if (item.type === 'char_diary') {
        const diary = item.content;
        sourceText = `Êù•Ëá™ ${diary.characterName} ÁöÑÊó•ËÆ∞`;

        const charChat = state.chats[diary.characterId];
        const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${diary.characterName}</div></div>`;


        const fullDiaryContent = diary.content || '';

        const formattedContent = parseMarkdown(fullDiaryContent).replace(/\n/g, '<br>');


        contentHtml = `
                <span class="diary-title">${diary.title}</span>
                <div class="fav-card-content-full">${formattedContent}</div>
            `;
      } else if (item.type === 'char_browser_article') {
        const article = item.content;
        sourceText = `Êù•Ëá™ ${article.characterName} ÁöÑÊµèËßàËÆ∞ÂΩï`;

        const charChat = state.chats[article.characterId];
        const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${article.characterName}</div></div>`;


        contentHtml = `
            <span class="diary-title">${article.title}</span>
            <div class="memo-content-preview">${(article.content || '').replace(/\n/g, '<br>')}</div>
        `;
      } else if (item.type === 'char_memo') {
        const memo = item.content;
        sourceText = `Êù•Ëá™ ${memo.characterName} ÁöÑÂ§áÂøòÂΩï`;

        const charChat = state.chats[memo.characterId];
        const authorAvatar = charChat ? charChat.settings.aiAvatar : defaultAvatar;

        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${memo.characterName}</div></div>`;


        contentHtml = `
        <span class="memo-title">${memo.title}</span>
        <div class="memo-content-preview">${memo.content.replace(/\n/g, '<br>')}</div>
    `;
      }


      card.innerHTML = `
                    <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                    <div class="fav-card-content">${contentHtml}</div>
                    ${footerHtml}`;

      listEl.appendChild(card);
    }
  }




  async function renderFavoritesScreen() {

    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();


    const searchInput = document.getElementById('favorites-search-input');
    const clearBtn = document.getElementById('favorites-search-clear-btn');
    searchInput.value = '';
    clearBtn.style.display = 'none';


    displayFilteredFavorites(allFavoriteItems);
  }



  function resetCreatePostModal() {
    document.getElementById('post-public-text').value = '';
    document.getElementById('post-image-preview').src = '';
    document.getElementById('post-image-description').value = '';
    document.getElementById('post-image-preview-container').classList.remove('visible');
    document.getElementById('post-image-desc-group').style.display = 'none';
    document.getElementById('post-local-image-input').value = '';
    document.getElementById('post-hidden-text').value = '';
    document.getElementById('switch-to-image-mode').click();
  }
 
  async function cleanupRedundantData() {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÔºü',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊâ´ÊèèÊï∞ÊçÆÂ∫ìÔºåÁßªÈô§ÊâÄÊúâ‰∏éÂ∑≤Âà†Èô§ËßíËâ≤Áõ∏ÂÖ≥ÁöÑÂ≠§Á´ãÊï∞ÊçÆÔºàÂ¶ÇÂä®ÊÄÅ„ÄÅËØÑËÆ∫„ÄÅËÆ∞ÂøÜÁ≠âÔºâ„ÄÇ<br><br><strong>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºå‰ΩÜÈÄöÂ∏∏ÊòØÂÆâÂÖ®ÁöÑ„ÄÇNPCÊï∞ÊçÆ‰∏ç‰ºöË¢´Âà†Èô§„ÄÇ</strong><br><br>Âª∫ËÆÆÂú®Êìç‰ΩúÂâçÂÖàÂØºÂá∫Êï∞ÊçÆÂ§á‰ªΩ„ÄÇ', {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Ê∏ÖÁêÜ'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂºÄÂßãÊ∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠È°µÈù¢...");
    console.log("ÂÜó‰ΩôÊï∞ÊçÆÊ∏ÖÁêÜÊµÅÁ®ãÂ∑≤ÂêØÂä®...");

    let cleanupCounts = {
      posts: 0,
      likes: 0,
      comments: 0,
      memories: 0,
      callRecords: 0,
      renderingRules: 0,
      groupMembers: 0,
      chatLinks: 0,
    };

    try {
      await db.transaction('rw', db.tables, async () => {

        const allChats = await db.chats.toArray();
        const allNpcs = await db.npcs.toArray();

        const existingChatIds = new Set(allChats.map(c => c.id));
        const existingNpcIds = new Set(allNpcs.map(n => `npc_${n.id}`));

        const existingOriginalNames = new Set(allChats.filter(c => !c.isGroup).map(c => c.originalName));
        existingOriginalNames.add(state.qzoneSettings.nickname || '{{user}}');

        allNpcs.forEach(npc => existingOriginalNames.add(npc.name));


        for (const chat of allChats) {
          let chatModified = false;
          if (chat.isGroup && chat.members) {
            const originalMemberCount = chat.members.length;



            chat.members = chat.members.filter(member =>
              existingChatIds.has(member.id) || existingNpcIds.has(member.id)
            );

            if (chat.members.length < originalMemberCount) {
              cleanupCounts.groupMembers += (originalMemberCount - chat.members.length);
              chatModified = true;
            }
          }

          if (chat.settings?.linkedMemoryChatIds?.length > 0) {
            const originalLinkCount = chat.settings.linkedMemoryChatIds.length;
            chat.settings.linkedMemoryChatIds = chat.settings.linkedMemoryChatIds.filter(id => existingChatIds.has(id));
            if (chat.settings.linkedMemoryChatIds.length < originalLinkCount) {
              cleanupCounts.chatLinks += (originalLinkCount - chat.settings.linkedMemoryChatIds.length);
              chatModified = true;
            }
          }
          if (chatModified) {
            await db.chats.put(chat);
          }
        }


        const allPosts = await db.qzonePosts.toArray();
        for (const post of allPosts) {
          let postModified = false;



          const isAuthorValid = post.authorId === 'user' || existingChatIds.has(post.authorId) || existingNpcIds.has(post.authorId);

          if (!isAuthorValid) {
            await db.qzonePosts.delete(post.id);
            cleanupCounts.posts++;
            continue;
          }

          if (post.likes && post.likes.length > 0) {
            const originalLikeCount = post.likes.length;
            post.likes = post.likes.filter(name => existingOriginalNames.has(name));
            if (post.likes.length < originalLikeCount) {
              cleanupCounts.likes += (originalLikeCount - post.likes.length);
              postModified = true;
            }
          }
          if (post.comments && post.comments.length > 0) {
            const originalCommentCount = post.comments.length;
            post.comments = post.comments.filter(comment => {
              if (typeof comment === 'object' && comment.commenterName) {
                return existingOriginalNames.has(comment.commenterName);
              }
              return true;
            });
            if (post.comments.length < originalCommentCount) {
              cleanupCounts.comments += (originalCommentCount - post.comments.length);
              postModified = true;
            }
          }
          if (postModified) {
            await db.qzonePosts.put(post);
          }
        }


        await db.memories.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.memories += c);
        await db.callRecords.where('chatId').noneOf([...existingChatIds]).delete().then(c => cleanupCounts.callRecords += c);
        const allRules = await db.renderingRules.toArray();
        for (const rule of allRules) {
          if (rule.chatId !== 'global' && !existingChatIds.has(rule.chatId)) {
            await db.renderingRules.delete(rule.id);
            cleanupCounts.renderingRules++;
          }
        }
      });

      let summary = "‚úÖ Ê∏ÖÁêÜÂÆåÊàêÔºÅ\n\n";
      let cleanedSomething = false;
      Object.entries(cleanupCounts).forEach(([key, value]) => {
        if (value > 0) {
          const keyMap = {
            posts: 'Âä®ÊÄÅ',
            likes: 'ÁÇπËµû',
            comments: 'ËØÑËÆ∫',
            memories: 'ËÆ∞ÂøÜ',
            callRecords: 'ÈÄöËØùËÆ∞ÂΩï',
            renderingRules: 'Ê∏≤ÊüìËßÑÂàô',
            groupMembers: 'Áæ§ÊàêÂëò',
            chatLinks: 'ËÆ∞ÂøÜÈìæÊé•'
          };
          summary += `- Ê∏ÖÁêÜ‰∫Ü ${value} Êù°Êó†ÊïàÁöÑ${keyMap[key] || key}„ÄÇ\n`;
          cleanedSomething = true;
        }
      });
      if (!cleanedSomething) {
        summary = "‚úÖ Ê£ÄÊü•ÂÆåÊàêÔºåÊú™ÂèëÁé∞‰ªª‰ΩïÂÜó‰ΩôÊï∞ÊçÆ„ÄÇ";
      }
      summary += "\nÂª∫ËÆÆÂà∑Êñ∞È°µÈù¢‰ª•Á°Æ‰øùÊâÄÊúâÊõ¥ÊîπÁîüÊïà„ÄÇ";

      await showCustomAlert("Êìç‰ΩúÊàêÂäü", summary);

      const confirmedReload = await showCustomConfirm("Âà∑Êñ∞È°µÈù¢Ôºü", "‰∏∫‰∫ÜÁ°Æ‰øùÊâÄÊúâÊï∞ÊçÆÂêåÊ≠•ÔºåÂª∫ËÆÆÁ´ãÂç≥Âà∑Êñ∞È°µÈù¢„ÄÇ");
      if (confirmedReload) {
        location.reload();
      }

    } catch (error) {
      console.error("Ê∏ÖÁêÜÂÜó‰ΩôÊï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Ê∏ÖÁêÜÂ§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

  async function exportBackup() {
    try {
      const backupData = {
        version: 1,
        timestamp: Date.now()
      };

      const [
        chats, worldBooks, userStickers, apiConfig, globalSettings,
        personaPresets, musicLibrary, qzoneSettings, qzonePosts,
        qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
        memories, worldBookCategories,
        apiPresets, shoppingProducts, callRecords,
        renderingRules,

        doubanPosts,
        stickerCategories,

        appearancePresets,

        presets,
        presetCategories,

        npcs
      ] = await Promise.all([
        db.chats.toArray(),
        db.worldBooks.toArray(),
        db.userStickers.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.personaPresets.toArray(),
        db.musicLibrary.get('main'),
        db.qzoneSettings.get('main'),
        db.qzonePosts.toArray(),
        db.qzoneAlbums.toArray(),
        db.qzonePhotos.toArray(),
        db.favorites.toArray(),
        db.qzoneGroups.toArray(),
        db.memories.toArray(),
        db.worldBookCategories.toArray(),
        db.apiPresets.toArray(),
        db.shoppingProducts.toArray(),
        db.callRecords.toArray(),
        db.renderingRules.toArray(),

        db.doubanPosts.toArray(),
        db.stickerCategories.toArray(),

        db.appearancePresets.toArray(),

        db.presets.toArray(),
        db.presetCategories.toArray(),

        db.npcs.toArray()
      ]);

      Object.assign(backupData, {
        chats,
        worldBooks,
        userStickers,
        apiConfig,
        globalSettings,
        personaPresets,
        musicLibrary,
        qzoneSettings,
        qzonePosts,
        qzoneAlbums,
        qzonePhotos,
        favorites,
        qzoneGroups,
        memories,
        worldBookCategories,
        apiPresets,
        shoppingProducts,
        callRecords,
        renderingRules,

        doubanPosts,
        stickerCategories,

        appearancePresets,

        presets,
        presetCategories,

        npcs
      });

      const blob = new Blob(
        [JSON.stringify(backupData, null, 2)], {
          type: 'application/json'
        }
      );
      const url = URL.createObjectURL(blob);
      const link = Object.assign(document.createElement('a'), {
        href: url,
        download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
      });
      link.click();
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â∑≤ÊàêÂäüÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÔºÅ');

    } catch (error) {
      console.error("ÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }



  async function importStreamedBackup(backupData) {
    try {
      await db.transaction('rw', db.tables, async () => {

        for (const table of db.tables) {
          await table.clear();
        }


        for (const tableName in backupData) {
          if (Array.isArray(backupData[tableName])) {
            console.log(`Ê≠£Âú®ÂØºÂÖ•Ë°®: ${tableName}, ËÆ∞ÂΩïÊï∞: ${backupData[tableName].length}`);
            await db.table(tableName).bulkPut(backupData[tableName]);
          }
        }
      });

    } catch (error) {

      throw new Error(`Êï∞ÊçÆÂ∫ìÂÜôÂÖ•Â§±Ë¥•: ${error.message}`);
    }
  }





  async function handleSmartImport(file) {
    if (!file) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØªÂèñÂπ∂Ëß£ÊûêÂ§á‰ªΩÊñá‰ª∂...");

    try {
      const text = await file.text();
      const data = JSON.parse(text);

      let backupDataContent;
      let backupType;

     
      if (data.data && typeof data.data === 'object' && (data.data.chats || data.data.worldBooks)) {
        console.log("Ê£ÄÊµãÂà∞Êñ∞ÁâàÊµÅÂºèÂ§á‰ªΩÊñá‰ª∂...");
        backupDataContent = data.data;
        backupType = 'streamed'; // 'streamed' or 'legacy'
      } else if (data.chats || data.worldBooks) {
        console.log("Ê£ÄÊµãÂà∞ÊóßÁâàÂÆåÊï¥Â§á‰ªΩÊñá‰ª∂...");
        backupDataContent = data;
        backupType = 'legacy';
      } else {
        throw new Error("Êñá‰ª∂Ê†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇËØ∑Á°Æ‰øùÊÇ®ÈÄâÊã©ÁöÑÊòØÊúâÊïàÁöÑ EPhone Â§á‰ªΩÊñá‰ª∂„ÄÇ");
      }

      
      pendingBackupData = {
        type: backupType,
        content: backupDataContent
      };

     
      openImportOptionsModal(backupDataContent);

    } catch (error) {
      console.error("ÂØºÂÖ•Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      pendingBackupData = null;
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
    }
  }


  function openImportOptionsModal(backupDataContent) {
    const modal = document.getElementById('import-options-modal');
    const listEl = document.getElementById('import-preview-list');
    listEl.innerHTML = '';

    const contentSummary = {
      'chats': 'ËÅäÂ§©‰ºöËØù',
      'worldBooks': '‰∏ñÁïå‰π¶',
      'worldBookCategories': '‰∏ñÁïå‰π¶ÂàÜÁ±ª', 
      'presets': 'Á¶ªÁ∫øÈ¢ÑËÆæ',
      'presetCategories': 'È¢ÑËÆæÂàÜÁ±ª', 
      'userStickers': 'Ë°®ÊÉÖÂåÖ',
      'stickerCategories': 'Ë°®ÊÉÖÂàÜÁ±ª',
      'customAvatarFrames': 'Â§¥ÂÉèÊ°Ü',
      'apiConfig': 'APIÈÖçÁΩÆ',
      'globalSettings': 'ÂÖ®Â±ÄËÆæÁΩÆ',
      'personaPresets': '‰∫∫ËÆæÈ¢ÑËÆæ',
      'qzoneSettings': 'Á©∫Èó¥ËÆæÁΩÆ',
      'qzonePosts': 'Âä®ÊÄÅ',
      'qzoneAlbums': 'Áõ∏ÂÜå',
      'favorites': 'Êî∂Ëóè',
      'memories': 'ÂõûÂøÜ',
      'callRecords': 'ÈÄöËØùËÆ∞ÂΩï',
      'shoppingProducts': 'ÂïÜÂìÅ',
      'apiPresets': 'APIÈ¢ÑËÆæ',
      'renderingRules': 'Ê∏≤ÊüìËßÑÂàô',
      'appearancePresets': 'Â§ñËßÇÈ¢ÑËÆæ',
      'npcs': 'NPCs'
    };

    let foundData = false;
    for (const key in contentSummary) {
      if (backupDataContent[key] && (Array.isArray(backupDataContent[key]) ? backupDataContent[key].length > 0 : backupDataContent[key])) {
        const count = Array.isArray(backupDataContent[key]) ? backupDataContent[key].length : 1;
        const li = document.createElement('li');
        li.textContent = `${contentSummary[key]}: ${count} Êù°/‰∏™`;
        listEl.appendChild(li);
        foundData = true;
      }
    }

    if (!foundData) {
      listEl.innerHTML = '<li>Êú™Âú®Ê≠§Êñá‰ª∂‰∏≠ÊâæÂà∞ÂèØËØÜÂà´ÁöÑÊï∞ÊçÆ„ÄÇ</li>';
    }

   
    document.getElementById('confirm-full-import-btn').onclick = () => {
      modal.classList.remove('visible');
      handleFullImport(pendingBackupData);
    };
    document.getElementById('confirm-selective-import-btn').onclick = () => {
      modal.classList.remove('visible');
      openSelectiveImportModal(pendingBackupData.content);
    };
    document.getElementById('cancel-import-options-btn').onclick = () => {
      modal.classList.remove('visible');
      pendingBackupData = null;
    };

    modal.classList.add('visible');
  }

 
  async function handleFullImport(backupInfo) {
    if (!backupInfo) return;

    const confirmed = await showCustomConfirm(
      '‰∏•ÈáçË≠¶ÂëäÔºÅ',
      '„ÄêÂÆåÂÖ®ÂØºÂÖ•„ÄëÂ∞ÜÂà†Èô§ÊÇ®ÂΩìÂâçÁöÑÊâÄÊúâÊï∞ÊçÆÂπ∂ÊõøÊç¢‰∏∫Â§á‰ªΩÊñá‰ª∂‰∏≠ÁöÑÂÜÖÂÆπ„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ<br><br><strong>Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü</strong>', {
        confirmButtonClass: 'btn-danger',
        confirmText: 'ÊàëÊòéÁôΩÔºåË¶ÜÁõñÊâÄÊúâÊï∞ÊçÆ'
      }
    );
    if (!confirmed) {
      pendingBackupData = null;
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÂÆåÂÖ®ÂØºÂÖ•ÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢...");

    try {
      if (backupInfo.type === 'streamed') {
        await importStreamedBackup(backupInfo.content);
      } else if (backupInfo.type === 'legacy') {
        await importLegacyBackup(backupInfo.content);
      } else {
        throw new Error("Êú™Áü•ÁöÑÂ§á‰ªΩÁ±ªÂûã„ÄÇ");
      }

      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', 'ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÊàêÂäüÊÅ¢Â§çÔºÅÂ∫îÁî®Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ');
      try {
            const restoredApiConfig = await db.apiConfig.get('main');
            if (restoredApiConfig) {
                // ÂêåÊ≠• ImgBB
                if (restoredApiConfig.imgbbApiKey) localStorage.setItem('imgbb-api-key', restoredApiConfig.imgbbApiKey);
                if (restoredApiConfig.imgbbEnable !== undefined) localStorage.setItem('imgbb-enabled', restoredApiConfig.imgbbEnable);
                
                // ÂêåÊ≠• Minimax
                if (restoredApiConfig.minimaxGroupId) localStorage.setItem('minimax-group-id', restoredApiConfig.minimaxGroupId);
                if (restoredApiConfig.minimaxApiKey) localStorage.setItem('minimax-api-key', restoredApiConfig.minimaxApiKey);
                if (restoredApiConfig.minimaxModel) localStorage.setItem('minimax-model', restoredApiConfig.minimaxModel);
                
                // ÂêåÊ≠• Catbox
                if (restoredApiConfig.catboxUserHash) localStorage.setItem('catbox-userhash', restoredApiConfig.catboxUserHash);
                if (restoredApiConfig.catboxEnable !== undefined) localStorage.setItem('catbox-enabled', restoredApiConfig.catboxEnable);
                
                // ÂêåÊ≠• NovelAI
                const novelaiSettings = localStorage.getItem('novelai-settings'); // NovelAIÈÖçÁΩÆÊØîËæÉÁâπÊÆäÔºåÈÄöÂ∏∏Âú®localStorageÔºåÂ¶ÇÊûúÂ§á‰ªΩÈáåÊúâ‰πüÂèØ‰ª•ÊÅ¢Â§ç
                // Ê≥®ÊÑèÔºö‰Ω†ÁöÑ‰ª£Á†Å‰ºº‰πéÊ≤°ÊúâÊää novelai ÁöÑ key Â≠òÂÖ• apiConfig Ë°®ÔºåËÄåÊòØÁõ¥Êé•Â≠ò localStorageÔºå
                // Â¶ÇÊûú‰Ω†ÁöÑÂ§á‰ªΩÈÄªËæëÈáåÊ≤°ÊúâÂåÖÂê´ localStorage ÁöÑ novelai Êï∞ÊçÆÔºåÂØºÂÖ•ÂêéÁ°ÆÂÆû‰ºö‰∏¢Â§±„ÄÇ
                // ‰ΩÜËøôÈáåÊàë‰ª¨‰∏ªË¶Å‰øÆÂ§ç ImgBB/Minimax/Catbox„ÄÇ
            }
            console.log("API ÈÖçÁΩÆÂ∑≤Âº∫Âà∂ÂêåÊ≠•Âà∞Êú¨Âú∞ÁºìÂ≠ò„ÄÇ");
        } catch (e) {
            console.error("ÂêåÊ≠•ÈÖçÁΩÆÂ§±Ë¥•:", e);
        }
      setTimeout(() => window.location.reload(), 1500);

    } catch (error) {
      console.error("ÂÆåÂÖ®ÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Â∫îÁî®Â§±Ë¥•: ${error.message}`);
    } finally {
      pendingBackupData = null;
    }
  }


  function openSelectiveImportModal(backupDataContent) {
    const modal = document.getElementById('selective-import-modal');
    const listEl = document.getElementById('selective-import-list');
    const selectAllCheckbox = document.getElementById('select-all-import-types');
    listEl.innerHTML = '';
    selectAllCheckbox.checked = true;

    const contentSummary = {
      'chats': 'ËÅäÂ§©‰ºöËØù',
      'worldBooks': '‰∏ñÁïå‰π¶',
      'worldBookCategories': '‰∏ñÁïå‰π¶ÂàÜÁ±ª',
      'presets': 'Á¶ªÁ∫øÈ¢ÑËÆæ',
      'presetCategories': 'È¢ÑËÆæÂàÜÁ±ª', 
      'userStickers': 'Ë°®ÊÉÖÂåÖ',
      'stickerCategories': 'Ë°®ÊÉÖÂàÜÁ±ª',
      'customAvatarFrames': 'Â§¥ÂÉèÊ°Ü',
      'apiConfig': 'APIÈÖçÁΩÆ',
      'globalSettings': 'ÂÖ®Â±ÄËÆæÁΩÆ',
      'personaPresets': '‰∫∫ËÆæÈ¢ÑËÆæ',
      'qzoneSettings': 'Á©∫Èó¥ËÆæÁΩÆ',
      'qzonePosts': 'Âä®ÊÄÅ',
      'qzoneAlbums': 'Áõ∏ÂÜå',
      'favorites': 'Êî∂Ëóè',
      'memories': 'ÂõûÂøÜ',
      'callRecords': 'ÈÄöËØùËÆ∞ÂΩï',
      'shoppingProducts': 'ÂïÜÂìÅ',
      'apiPresets': 'APIÈ¢ÑËÆæ',
      'renderingRules': 'Ê∏≤ÊüìËßÑÂàô',
      'appearancePresets': 'Â§ñËßÇÈ¢ÑËÆæ',
      'npcs': 'NPCs'
    };

    let hasContent = false;
    for (const key in contentSummary) {
      if (backupDataContent[key] && (Array.isArray(backupDataContent[key]) ? backupDataContent[key].length > 0 : backupDataContent[key])) {
        const count = Array.isArray(backupDataContent[key]) ? backupDataContent[key].length : 1;
        const isSingleObject = !Array.isArray(backupDataContent[key]);

        const item = document.createElement('div');
        item.className = 'clear-posts-item selected'; 
        item.dataset.typeId = key;
        item.innerHTML = `
                <div class="checkbox selected"></div>
                <div>
                    <span class="name">${contentSummary[key]} (${count} Êù°/‰∏™)</span>
                    ${isSingleObject ? '<p style="font-size: 12px; color: #ff8c00; margin: 4px 0 0;">(Ê≥®ÊÑè: ËøôÂ∞Ü„ÄêË¶ÜÁõñ„ÄëÊÇ®ÂΩìÂâçÁöÑËÆæÁΩÆ)</p>' : ''}
                </div>
            `;
        listEl.appendChild(item);
        hasContent = true;
      }
    }

    if (!hasContent) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Êñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂèØÂêàÂπ∂ÁöÑÊï∞ÊçÆ„ÄÇ</p>';
    }

   
    document.getElementById('confirm-merge-import-btn').onclick = () => handleSelectiveImport(pendingBackupData);
    document.getElementById('cancel-selective-import-btn').onclick = () => {
      modal.classList.remove('visible');
      pendingBackupData = null;
    };

    selectAllCheckbox.onchange = (e) => {
      const isChecked = e.target.checked;
      listEl.querySelectorAll('.clear-posts-item').forEach(item => {
        item.classList.toggle('selected', isChecked);
        item.querySelector('.checkbox').classList.toggle('selected', isChecked);
      });
    };

    listEl.onclick = (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {
        item.classList.toggle('selected');
        item.querySelector('.checkbox').classList.toggle('selected');
      }
    };

    modal.classList.add('visible');
  }

  
  async function handleSelectiveImport(backupInfo) {
    if (!backupInfo) return;

    const selectedItems = document.querySelectorAll('#selective-import-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÁßçË¶ÅÂêàÂπ∂ÁöÑÊï∞ÊçÆÁ±ªÂûã„ÄÇ");
      return;
    }

    const typesToMerge = Array.from(selectedItems).map(item => item.dataset.typeId);
    const dataToMerge = backupInfo.content;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§ÂêàÂπ∂Ôºü',
      'ËøôÂ∞ÜÊääÊÇ®ÈÄâÊã©ÁöÑÊï∞ÊçÆ„ÄêÊ∑ªÂä†Âπ∂Ë¶ÜÁõñ„ÄëÂà∞Áé∞ÊúâÊï∞ÊçÆ‰∏≠„ÄÇÂêåIDÁöÑÊï∞ÊçÆÂ∞ÜË¢´Êõ¥Êñ∞ÔºåÊñ∞Êï∞ÊçÆÂ∞ÜË¢´Ê∑ªÂä†„ÄÇ<br><br><strong>Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ</strong>', {
        confirmText: 'Á°ÆËÆ§ÂêàÂπ∂'
      }
    );
    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂêàÂπ∂Êï∞ÊçÆÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢...");

    try {

      await db.transaction('rw', db.tables, async () => {
        for (const type of typesToMerge) {
          const data = dataToMerge[type];
          if (!data) continue;

          const table = db.table(type);
          if (!table) {
            console.warn(`Êâæ‰∏çÂà∞Ë°®: ${type}, Ë∑≥Ëøá...`);
            continue;
          }

          if (Array.isArray(data)) {
          
            console.log(`Ê≠£Âú®ÂêàÂπ∂ ${data.length} Êù°ËÆ∞ÂΩïÂà∞ ${type}...`);
            await table.bulkPut(data);
          } else if (typeof data === 'object' && data.id) {
            
            console.log(`Ê≠£Âú®ÂêàÂπ∂ÂçïÊù°ËÆ∞ÂΩïÂà∞ ${type}...`);
            await table.put(data);
          } else if (typeof data === 'object') {
          
            console.log(`Ê≠£Âú®ÂêàÂπ∂ÈùûÊ†áÂØπË±°Âà∞ ${type}...`);
            const existingData = await table.toCollection().first() || {};
            const mergedData = {
              ...existingData,
              ...data
            };

          
            if (existingData.id) {
              mergedData.id = existingData.id;
            } else if (type === 'apiConfig' || type === 'qzoneSettings' || type === 'globalSettings' || type === 'musicLibrary') {
              mergedData.id = 'main';
            }

            await table.put(mergedData);
          }
        }
      });

      await showCustomAlert('ÂêàÂπ∂ÊàêÂäü', 'Êï∞ÊçÆÂ∑≤ÊàêÂäüÂêàÂπ∂ÔºÅÂ∫îÁî®Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ');
      setTimeout(() => window.location.reload(), 1500);

    } catch (error) {
      console.error("ÈÄâÊã©ÊÄßÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert('ÂêàÂπ∂Â§±Ë¥•', `Êñá‰ª∂Â∫îÁî®Â§±Ë¥•: ${error.message}`);
    } finally {
      pendingBackupData = null;
    }
  }


  async function importLegacyBackup(backupData) {
    try {
      await db.transaction('rw', db.tables, async () => {
        await db.chats.clear();
        await db.worldBooks.clear();

        for (const table of db.tables) {
          await table.clear();
        }

        if (Array.isArray(backupData.chats)) await db.chats.bulkPut(backupData.chats);
        if (Array.isArray(backupData.worldBooks)) await db.worldBooks.bulkPut(backupData.worldBooks);

        if (Array.isArray(backupData.userStickers)) await db.userStickers.bulkPut(backupData.userStickers);
        if (backupData.apiConfig) await db.apiConfig.put(backupData.apiConfig);
        if (backupData.globalSettings) await db.globalSettings.put(backupData.globalSettings);

        if (Array.isArray(backupData.personaPresets)) await db.personaPresets.bulkPut(backupData.personaPresets);
        if (backupData.musicLibrary) await db.musicLibrary.put(backupData.musicLibrary);
        if (backupData.qzoneSettings) await db.qzoneSettings.put(backupData.qzoneSettings);
        if (Array.isArray(backupData.qzonePosts)) await db.qzonePosts.bulkPut(backupData.qzonePosts);
        if (Array.isArray(backupData.qzoneAlbums)) await db.qzoneAlbums.bulkPut(backupData.qzoneAlbums);
        if (Array.isArray(backupData.qzonePhotos)) await db.qzonePhotos.bulkPut(backupData.qzonePhotos);
        if (Array.isArray(backupData.favorites)) await db.favorites.bulkPut(backupData.favorites);
        if (Array.isArray(backupData.qzoneGroups)) await db.qzoneGroups.bulkPut(backupData.qzoneGroups);
        if (Array.isArray(backupData.memories)) await db.memories.bulkPut(backupData.memories);
        if (Array.isArray(backupData.worldBookCategories)) await db.worldBookCategories.bulkPut(backupData.worldBookCategories);
        if (Array.isArray(backupData.apiPresets)) await db.apiPresets.bulkPut(backupData.apiPresets);
        if (Array.isArray(backupData.shoppingProducts)) await db.shoppingProducts.bulkPut(backupData.shoppingProducts);
        if (Array.isArray(backupData.callRecords)) await db.callRecords.bulkPut(backupData.callRecords);
        if (Array.isArray(backupData.renderingRules)) await db.renderingRules.bulkPut(backupData.renderingRules);
        if (Array.isArray(backupData.doubanPosts)) await db.doubanPosts.bulkPut(backupData.doubanPosts);
        if (Array.isArray(backupData.stickerCategories)) await db.stickerCategories.bulkPut(backupData.stickerCategories);
        if (Array.isArray(backupData.appearancePresets)) await db.appearancePresets.bulkPut(backupData.appearancePresets);
        if (Array.isArray(backupData.presets)) await db.presets.bulkPut(backupData.presets);
        if (Array.isArray(backupData.presetCategories)) await db.presetCategories.bulkPut(backupData.presetCategories);
        if (Array.isArray(backupData.npcs)) await db.npcs.bulkPut(backupData.npcs);
      });
    } catch (error) {
      throw new Error(`ÊóßÁâàÂ§á‰ªΩÊï∞ÊçÆÂÜôÂÖ•Êï∞ÊçÆÂ∫ìÂ§±Ë¥•: ${error.message}`);
    }
  }


  function applyCustomFont(fontUrl, isPreviewOnly = false) {
    if (!fontUrl) {
      dynamicFontStyle.innerHTML = '';
      document.getElementById('font-preview').style.fontFamily = '';
      return;
    }
    const fontName = 'custom-user-font';
    const newStyle = `
                        @font-face {
                          font-family: '${fontName}';
                          src: url('${fontUrl}');
                          font-display: swap;
                        }`;
    if (isPreviewOnly) {
      const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
      previewStyle.id = 'preview-font-style';
      previewStyle.innerHTML = newStyle;
      if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
      document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
    } else {
      dynamicFontStyle.innerHTML = `
                            ${newStyle}
                            body {
                              font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                            }`;
    }
  }

  async function resetToDefaultFont() {
    dynamicFontStyle.innerHTML = '';
    state.globalSettings.fontUrl = '';
    await db.globalSettings.put(state.globalSettings);
    document.getElementById('font-url-input').value = '';
    document.getElementById('font-preview').style.fontFamily = '';
    alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì„ÄÇ');
  }


  async function loadAllDataFromDB() {
    const [
      chatsArr, apiConfig, loadedGlobalSettings, userStickers, worldBooks,
      musicLib, personaPresets, qzoneSettings, initialFavorites,
      allMemories,

      allPresets,
      allQuickReplies
    ] = await Promise.all([
      db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'),
      db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'),
      db.personaPresets.toArray(), db.qzoneSettings.get('main'), db.favorites.orderBy('timestamp').reverse().toArray(),
      db.memories.toArray(),

      db.presets.toArray(),
      db.quickReplies.toArray()
    ]);


    state.presets = allPresets || [];
    state.quickReplies = allQuickReplies || [];
    await initUserWallet(); 
    const defaultGlobalSettings = {
      id: 'main',
      showStatusBar: false,
      wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)',
      fontUrl: '',
      enableBackgroundActivity: false,
      backgroundActivityInterval: 60,
      blockCooldownHours: 1,
      apiTemperature: 0.8,
      appIcons: {
        ...DEFAULT_APP_ICONS
      },
      cphoneWallpaper: 'linear-gradient(135deg, #f6d365, #fda085)',
      cphoneAppIcons: {
        ...DEFAULT_CPHONE_ICONS
      },
      globalCss: '',
      notificationSoundUrl: '',
      widgetData: {},
      globalChatBackground: '',
      enableAiDrawing: true,
      showPhoneFrame: false,
      lockScreenEnabled: false,
      lockScreenPassword: '',
      lockScreenWallpaper: '',
      alwaysShowMusicIsland: false,
      detachStatusBar: false,
      enableMinimalChatUI: false,
      chatActionButtonsOrder: null,
      shoppingCategoryCount: 3,
      shoppingProductCount: 8,
      chatRenderWindow: 50
    };
    state.globalSettings = {
      ...defaultGlobalSettings,
      ...(loadedGlobalSettings || {})
    };
    state.globalSettings.appIcons = {
      ...defaultGlobalSettings.appIcons,
      ...(state.globalSettings.appIcons || {})
    };
    state.globalSettings.cphoneAppIcons = {
      ...defaultGlobalSettings.cphoneAppIcons,
      ...(state.globalSettings.cphoneAppIcons || {})
    };

    chatsArr.forEach(chat => {
      if (typeof chat.settings.enableTimePerception === 'undefined') {
        chat.settings.enableTimePerception = true;
      }
      if (!chat.settings.lyricsPosition) {
        chat.settings.lyricsPosition = {
          vertical: 'top',
          horizontal: 'center',
          offset: 10
        };
      }
      if (!chat.isGroup && !chat.settings.myAvatarLibrary) {
        chat.settings.myAvatarLibrary = [];
      }
      if (!chat.isGroup && typeof chat.originalName === 'undefined') {
        chat.originalName = chat.name;
      }
    });
    state.chats = chatsArr.reduce((acc, chat) => {
      if (typeof chat.unreadCount === 'undefined') chat.unreadCount = 0;
      if (chat.isGroup) {
        if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
          chat.settings.enableBackgroundActivity = true;
        }
        if (chat.members && chat.members.length > 0 && chat.members[0].name) {
          chat.members.forEach(member => {
            if (typeof member.originalName === 'undefined') {
              member.originalName = member.name;
              member.groupNickname = member.name;
              delete member.name;
            }
          });
        }
      }
      if (!chat.settings) chat.settings = {};
      if (typeof chat.settings.actionCooldownMinutes === 'undefined') {
        chat.settings.actionCooldownMinutes = 10;
      }
      if (!chat.isGroup && !chat.status) chat.status = {
        text: 'Âú®Á∫ø',
        lastUpdate: Date.now(),
        isBusy: false
      };
      if (!chat.isGroup && !chat.relationship) chat.relationship = {
        status: 'friend',
        blockedTimestamp: null,
        applicationReason: ''
      };
      if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {};
        chat.settings.aiAvatarLibrary = [];
      }
      if (chat.isGroup) {
        (chat.members || []).forEach(member => {
          if (typeof member.avatarFrame === 'undefined') member.avatarFrame = '';
        });
      }
      if (!chat.musicData) chat.musicData = {
        totalTime: 0
      };
      if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
        chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
        delete chat.settings.linkedWorldBookId;
      }
      if (typeof chat.isPinned === 'undefined') chat.isPinned = false;
      if (!chat.isGroup && typeof chat.settings.myNickname === 'undefined') {
        chat.settings.myNickname = 'Êàë';
      }
      if (chat.isGroup && chat.members) {
        let needsUpdate = false;
        chatsArr.forEach(c => {
          if (c.id === chat.id && c.originalName) {
            delete c.originalName;
          }
        });
        chat.members.forEach(member => {
          const originalCharacter = chatsArr.find(c => c.id === member.id);
          if (originalCharacter && originalCharacter.settings) {
            const correctFrame = originalCharacter.settings.aiAvatarFrame || '';
            if (member.avatarFrame !== correctFrame) {
              member.avatarFrame = correctFrame;
              needsUpdate = true;
            }
          } else if (typeof member.avatarFrame === 'undefined') {
            member.avatarFrame = '';
            needsUpdate = true;
          }
        });
        if (needsUpdate) db.chats.put(chat);
      }
      if (!chat.settings.enableAutoMemory) chat.settings.enableAutoMemory = false;
      if (!chat.settings.autoMemoryInterval) chat.settings.autoMemoryInterval = 20;
      if (!chat.longTermMemory) chat.longTermMemory = [];
      if (!chat.lastMemorySummaryTimestamp) chat.lastMemorySummaryTimestamp = 0;
      if (!chat.isGroup) {
        if (typeof chat.settings.enableBackgroundActivity === 'undefined') {
          chat.settings.enableBackgroundActivity = true;
        }
        if (typeof chat.settings.enableTts === 'undefined') {
          chat.settings.enableTts = false;
        }
        if (!chat.status) chat.status = {
          text: 'Âú®Á∫ø',
          lastUpdate: Date.now(),
          isBusy: false
        };
        if (!chat.relationship) chat.relationship = {
          status: 'friend',
          blockedTimestamp: null,
          applicationReason: ''
        };
        if (!chat.settings || !chat.settings.aiAvatarLibrary) {
          if (!chat.settings) chat.settings = {};
          chat.settings.aiAvatarLibrary = [];
        }
        if (typeof chat.settings.isOfflineMode === 'undefined') chat.settings.isOfflineMode = false;
        if (typeof chat.settings.offlineMinLength === 'undefined') chat.settings.offlineMinLength = 100;
        if (typeof chat.settings.offlineMaxLength === 'undefined') chat.settings.offlineMaxLength = 300;

        if (typeof chat.settings.injectLatestThought === 'undefined') {
          chat.settings.injectLatestThought = false;
        }

        if (typeof chat.heartfeltVoice === 'undefined') chat.heartfeltVoice = '...';
        if (typeof chat.randomJottings === 'undefined') chat.randomJottings = '...';
        if (!Array.isArray(chat.thoughtsHistory)) {
          chat.thoughtsHistory = [];
        }
      }
      if (typeof chat.settings.stickerCategoryIds === 'undefined') {
     
        if (chat.settings.stickerCategoryId) {
         
          chat.settings.stickerCategoryIds = [chat.settings.stickerCategoryId];
        } else {
        
          chat.settings.stickerCategoryIds = [];
        }
        
        delete chat.settings.stickerCategoryId;
      }
      acc[chat.id] = chat;
      return acc;
    }, {});
    const memoriesToUpdate = [];
    allMemories.forEach(memory => {
      if (memory.type === 'ai_generated' && memory.authorName && !memory.authorId) {
        const foundChat = chatsArr.find(c => !c.isGroup && c.originalName === memory.authorName);
        if (foundChat) {
          memory.authorId = foundChat.id;
          memoriesToUpdate.push(memory);
        } else {
          const fallbackChat = chatsArr.find(c => !c.isGroup && c.name === memory.authorName);
          if (fallbackChat) {
            memory.authorId = fallbackChat.id;
            memoriesToUpdate.push(memory);
          }
        }
      }
    });
    if (memoriesToUpdate.length > 0) {
      await db.memories.bulkPut(memoriesToUpdate);
    }
    state.apiConfig = apiConfig || {
      id: 'main',
      proxyUrl: '',
      apiKey: '',
      model: '',
      secondaryProxyUrl: '',
      secondaryApiKey: '',
      secondaryModel: '',
      minimaxGroupId: '',
      minimaxApiKey: '',
      minimaxModel: 'speech-01',
      imgbbEnable: false,
      imgbbApiKey: '',
      
        catboxEnable: false,
        catboxUserHash: '',
        githubEnable: false, // ÈªòËÆ§‰∏∫ÂÖ≥Èó≠
       githubAutoBackup: false,
      githubUsername: '',
      githubRepo: '',
      githubToken: '',
      githubFilename: 'ephone_backup.json'
    };
    if (localStorage.getItem('imgbb-enabled') !== null) {
        state.apiConfig.imgbbEnable = localStorage.getItem('imgbb-enabled') === 'true';
    }
    if (localStorage.getItem('imgbb-api-key') !== null) {
        state.apiConfig.imgbbApiKey = localStorage.getItem('imgbb-api-key');
    }
    if (localStorage.getItem('catbox-enabled') !== null) {
        state.apiConfig.catboxEnable = localStorage.getItem('catbox-enabled') === 'true';
    }
    if (localStorage.getItem('catbox-userhash') !== null) {
        state.apiConfig.catboxUserHash = localStorage.getItem('catbox-userhash');
    }
   if (localStorage.getItem('minimax-group-id') !== null) {
        state.apiConfig.minimaxGroupId = localStorage.getItem('minimax-group-id');
    }
    if (localStorage.getItem('minimax-api-key') !== null) {
        state.apiConfig.minimaxApiKey = localStorage.getItem('minimax-api-key');
    }
    if (localStorage.getItem('minimax-model') !== null) {
        state.apiConfig.minimaxModel = localStorage.getItem('minimax-model');
    }
    if (localStorage.getItem('github-proxy-enabled') !== null) {
        state.apiConfig.githubProxyEnable = localStorage.getItem('github-proxy-enabled') === 'true';
    }
    if (localStorage.getItem('github-proxy-url') !== null) {
        state.apiConfig.githubProxyUrl = localStorage.getItem('github-proxy-url');
    }
    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || {
      id: 'main',
      nickname: '{{user}}',
      avatar: 'https://files.catbox.moe/q6z5fc.jpeg',
      banner: 'https://files.catbox.moe/r5heyt.gif'
    };
    allFavoriteItems = initialFavorites || [];
  }


  async function saveGlobalPlaylist() {
    await db.musicLibrary.put({
      id: 'main',
      playlist: musicState.playlist
    });
  }

  function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  }
  
  function formatTimeAgo(timestamp) {
    const now = Date.now();
    const seconds = Math.floor((now - timestamp) / 1000);

    if (seconds < 60) return 'ÂàöÂàö';

    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;

    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}Â∞èÊó∂Ââç`;

    const days = Math.floor(hours / 24);
    if (days < 30) return `${days}Â§©Ââç`;

    const months = Math.floor(days / 30);
    if (months < 12) return `Â§ßÁ∫¶${months}‰∏™ÊúàÂâç`;

    const years = Math.floor(days / 365);
    return `Â§ßÁ∫¶${years}Âπ¥Ââç`;
  }

  function formatTimestampForAI(timestamp) {
    if (!timestamp) return '';

    const now = new Date();
    const date = new Date(timestamp);

    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const timeString = `${hours}:${minutes}`;


    if (now.toDateString() === date.toDateString()) {
      return `‰ªäÂ§© ${timeString}`;
    }


    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    if (yesterday.toDateString() === date.toDateString()) {
      return `Êò®Â§© ${timeString}`;
    }


    if (now.getFullYear() === date.getFullYear()) {
      const month = String(date.getMonth() + 1);
      const day = String(date.getDate());
      return `${month}Êúà${day}Êó• ${timeString}`;
    }


    const year = date.getFullYear();
    const month = String(date.getMonth() + 1);
    const day = String(date.getDate());
    return `${year}Âπ¥${month}Êúà${day}Êó• ${timeString}`;
  }

// --- Êñ∞Â¢û NAI È¢ÑËÆæÁõ∏ÂÖ≥ÂáΩÊï∞ ---

// 1. Âä†ËΩΩÈ¢ÑËÆæ‰∏ãÊãâËèúÂçï
async function loadNaiPresetsDropdown() {
    const selectEl = document.getElementById('nai-preset-select');
    // ‰øùÁïôÁ¨¨‰∏Ä‰∏™ÈÄâÈ°π
    selectEl.innerHTML = '<option value="">-- ÂΩìÂâç‰∏¥Êó∂ËÆæÁΩÆ --</option>';
    
    const presets = await db.naiPresets.toArray();
    presets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name;
        selectEl.appendChild(opt);
    });
    
    // ÊÅ¢Â§çÈÄâ‰∏≠Áä∂ÊÄÅ
    if (currentNaiPresetId) {
        selectEl.value = currentNaiPresetId;
        updateNaiPresetButtons(true);
    } else {
        updateNaiPresetButtons(false);
    }
}

// 2. Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
// 2. Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ (Êõ¥Êñ∞Ëøô‰∏™ÂáΩÊï∞)
function updateNaiPresetButtons(hasSelection) {
    const updateBtn = document.getElementById('update-nai-preset-btn');
    const bindBtn = document.getElementById('bind-nai-preset-btn');
    const deleteBtn = document.getElementById('delete-nai-preset-btn');
    const saveBtn = document.getElementById('save-nai-preset-btn');
    
    if (hasSelection) {
        updateBtn.style.display = 'block';
        bindBtn.style.display = 'block';
        deleteBtn.style.display = 'block';
        // ÊîπÂä®ÔºöÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÊòæÁ§∫"Âè¶Â≠ò" (2‰∏™Â≠ó)
        saveBtn.textContent = 'Âè¶Â≠ò';
    } else {
        updateBtn.style.display = 'none';
        bindBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
        // ÊîπÂä®ÔºöÊú™ÈÄâ‰∏≠Áä∂ÊÄÅ‰∏ãÊòæÁ§∫"Êñ∞Â¢û" (2‰∏™Â≠ó)
        saveBtn.textContent = 'Êñ∞Â¢û';
    }
}

// 3. Êî∂ÈõÜÂΩìÂâçÁïåÈù¢‰∏äÁöÑÊâÄÊúâËÆæÁΩÆ
function gatherNaiUiSettings() {
    return {
      resolution: document.getElementById('nai-resolution').value,
      steps: parseInt(document.getElementById('nai-steps').value),
      cfg_scale: parseFloat(document.getElementById('nai-cfg-scale').value),
      sampler: document.getElementById('nai-sampler').value,
      seed: parseInt(document.getElementById('nai-seed').value),
      uc_preset: parseInt(document.getElementById('nai-uc-preset').value),
      quality_toggle: document.getElementById('nai-quality-toggle').checked,
      smea: document.getElementById('nai-smea').checked,
      smea_dyn: document.getElementById('nai-smea-dyn').checked,
      default_positive: document.getElementById('nai-default-positive').value,
      default_negative: document.getElementById('nai-default-negative').value,
      // Ê≥®ÊÑèÔºöAPI Key Âíå Proxy ËøôÁßçÊïèÊÑü/ÂÖ®Â±ÄÈÖçÁΩÆÈÄöÂ∏∏‰∏çÂ≠òÂÖ•È£éÊ†ºÈ¢ÑËÆæÔºå‰ΩÜ‰Ω†ÂèØ‰ª•Ê†πÊçÆÈúÄÊ±ÇÂÜ≥ÂÆö
      // ËøôÈáå‰∏∫‰∫ÜÈ£éÊ†ºÂàáÊç¢Êñπ‰æøÔºåÊàë‰ª¨Âè™Â≠òÂèÇÊï∞ÔºåKey Âíå Proxy ËøòÊòØËµ∞ÂÖ®Â±Ä
    };
}

// 4. Â∫îÁî®ËÆæÁΩÆÂà∞ UI
function applyNaiUiSettings(settings) {
    if (!settings) return;
    document.getElementById('nai-resolution').value = settings.resolution || '1024x1024';
    document.getElementById('nai-steps').value = settings.steps || 28;
    document.getElementById('nai-cfg-scale').value = settings.cfg_scale || 5;
    document.getElementById('nai-sampler').value = settings.sampler || 'k_euler_ancestral';
    document.getElementById('nai-seed').value = settings.seed ?? -1;
    document.getElementById('nai-uc-preset').value = settings.uc_preset || 1;
    document.getElementById('nai-quality-toggle').checked = settings.quality_toggle !== false;
    document.getElementById('nai-smea').checked = settings.smea !== false;
    document.getElementById('nai-smea-dyn').checked = settings.smea_dyn || false;
    document.getElementById('nai-default-positive').value = settings.default_positive || '';
    document.getElementById('nai-default-negative').value = settings.default_negative || '';
}

// 5. ‰øùÂ≠ò/Êñ∞Âª∫È¢ÑËÆæ
async function handleSaveNaiPreset(isUpdate = false) {
    const settings = gatherNaiUiSettings();
    
    if (isUpdate && currentNaiPresetId) {
        const confirmed = await showCustomConfirm("Êõ¥Êñ∞È¢ÑËÆæ", "Á°ÆÂÆöË¶ÅË¶ÜÁõñÂΩìÂâçÈ¢ÑËÆæÁöÑÂèÇÊï∞ÂêóÔºü");
        if (!confirmed) return;
        
        await db.naiPresets.update(parseInt(currentNaiPresetId), { settings });
        alert("È¢ÑËÆæÂ∑≤Êõ¥Êñ∞ÔºÅ");
    } else {
        const name = await showCustomPrompt("Êñ∞Âª∫È¢ÑËÆæ", "ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞Ôºà‰æãÂ¶ÇÔºöÂéöÊ∂ÇÈ£é„ÄÅÂÉèÁ¥†È£éÔºâ");
        if (!name) return;
        
        const id = await db.naiPresets.add({ name, settings });
        currentNaiPresetId = id;
        await loadNaiPresetsDropdown();
        alert("È¢ÑËÆæÂ∑≤ÂàõÂª∫ÔºÅ");
    }
}

// 6. Âà†Èô§È¢ÑËÆæ
async function handleDeleteNaiPreset() {
    if (!currentNaiPresetId) return;
    const confirmed = await showCustomConfirm("Âà†Èô§È¢ÑËÆæ", "Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§È¢ÑËÆæÂêóÔºüÁªëÂÆö‰∫ÜÊ≠§È¢ÑËÆæÁöÑËßíËâ≤Â∞ÜÂõûÈÄÄÂà∞ÂÖ®Â±ÄËÆæÁΩÆ„ÄÇ", { confirmButtonClass: 'btn-danger' });
    if (!confirmed) return;
    
    await db.naiPresets.delete(parseInt(currentNaiPresetId));
    
    // Ê∏ÖÈô§ÊâÄÊúâËÅäÂ§©‰∏≠ÁöÑÁªëÂÆöÂºïÁî®
    const allChats = await db.chats.toArray();
    for (const chat of allChats) {
        if (chat.settings?.naiPresetId === parseInt(currentNaiPresetId)) {
            delete chat.settings.naiPresetId;
            await db.chats.put(chat);
        }
    }
    
    currentNaiPresetId = null;
    await loadNaiPresetsDropdown();
}

// 7. Â§ÑÁêÜ‰∏ãÊãâÊ°ÜÂàáÊç¢
async function handleNaiPresetChange(e) {
    const val = e.target.value;
    if (val) {
        currentNaiPresetId = parseInt(val);
        const preset = await db.naiPresets.get(currentNaiPresetId);
        if (preset && preset.settings) {
            applyNaiUiSettings(preset.settings);
        }
        updateNaiPresetButtons(true);
    } else {
        currentNaiPresetId = null;
        updateNaiPresetButtons(false);
        // ÊÅ¢Â§çÂà∞ localStorage ÈáåÁöÑÂÖ®Â±ÄËÆæÁΩÆ
        loadNovelAISettings(); 
    }
}

// 8. ÊâìÂºÄÁªëÂÆöÂºπÁ™ó
async function openNaiBindingModal() {
    if (!currentNaiPresetId) return;
    const preset = await db.naiPresets.get(parseInt(currentNaiPresetId));
    if (!preset) return;

    const modal = document.getElementById('nai-binding-modal');
    const listEl = document.getElementById('nai-binding-list');
    const titleEl = modal.querySelector('.modal-header span');
    
    titleEl.textContent = `Â∞ÜÈ¢ÑËÆæ‚Äú${preset.name}‚ÄùÁªëÂÆöÂà∞...`;
    listEl.innerHTML = '';
    
    const allChats = Object.values(state.chats).sort((a, b) => a.name.localeCompare(b.name));
    
    allChats.forEach(chat => {
        const isBound = chat.settings?.naiPresetId === currentNaiPresetId;
        
        const item = document.createElement('div');
        item.className = 'contact-picker-item'; // Â§çÁî®Ê†∑Âºè
        item.innerHTML = `
            <input type="checkbox" class="nai-binding-checkbox" data-chat-id="${chat.id}" ${isBound ? 'checked' : ''} style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <div style="display:flex; flex-direction:column;">
                <span class="name">${chat.name}</span>
                ${isBound ? '<span style="font-size:10px; color:green;">Â∑≤ÁªëÂÆö</span>' : ''}
            </div>
        `;
        // ÁÇπÂáªË°åÂàáÊç¢
        item.addEventListener('click', (e) => {
            if (e.target.type !== 'checkbox') {
                const cb = item.querySelector('input');
                cb.checked = !cb.checked;
            }
        });
        listEl.appendChild(item);
    });
    
    modal.classList.add('visible');
}

// 9. ‰øùÂ≠òÁªëÂÆö
async function saveNaiBinding() {
    if (!currentNaiPresetId) return;
    
    const checkboxes = document.querySelectorAll('.nai-binding-checkbox');
    const updates = [];
    
    for (const cb of checkboxes) {
        const chatId = cb.dataset.chatId;
        const chat = state.chats[chatId];
        const shouldBind = cb.checked;
        
        if (chat) {
            if (shouldBind) {
                // Â¶ÇÊûúÂãæÈÄâÔºåÁªëÂÆöÂΩìÂâçÈ¢ÑËÆæ
                if (chat.settings.naiPresetId !== currentNaiPresetId) {
                    chat.settings.naiPresetId = currentNaiPresetId;
                    updates.push(chat);
                }
            } else {
                // Â¶ÇÊûúÂèñÊ∂àÂãæÈÄâÔºå‰∏îÂΩìÂâçÊ≠£ÊòØÁªëÂÆö‰∫ÜËøô‰∏™È¢ÑËÆæÔºåÂàôËß£Áªë
                if (chat.settings.naiPresetId === currentNaiPresetId) {
                    delete chat.settings.naiPresetId;
                    updates.push(chat);
                }
            }
        }
    }
    
    if (updates.length > 0) {
        await db.chats.bulkPut(updates);
        await showCustomAlert("‰øùÂ≠òÊàêÂäü", `Â∑≤Êõ¥Êñ∞ ${updates.length} ‰∏™ËßíËâ≤ÁöÑÁªëÂÆöËÆæÁΩÆ„ÄÇ`);
    } else {
        // Êó†ÂèòÂåñ
    }
    
    document.getElementById('nai-binding-modal').classList.remove('visible');
}
  function loadNovelAISettings() {
    const settings = getNovelAISettings();
    document.getElementById('nai-resolution').value = settings.resolution;
    document.getElementById('nai-steps').value = settings.steps;
    document.getElementById('nai-cfg-scale').value = settings.cfg_scale;
    document.getElementById('nai-sampler').value = settings.sampler;
    document.getElementById('nai-seed').value = settings.seed;
    document.getElementById('nai-uc-preset').value = settings.uc_preset;
    document.getElementById('nai-quality-toggle').checked = settings.quality_toggle;
    document.getElementById('nai-smea').checked = settings.smea;
    document.getElementById('nai-smea-dyn').checked = settings.smea_dyn;
    document.getElementById('nai-default-positive').value = settings.default_positive;
    document.getElementById('nai-default-negative').value = settings.default_negative;
    document.getElementById('nai-cors-proxy').value = settings.cors_proxy;
    document.getElementById('nai-custom-proxy-url').value = settings.custom_proxy_url || '';

  
    const customProxyGroup = document.getElementById('nai-custom-proxy-group');
    customProxyGroup.style.display = settings.cors_proxy === 'custom' ? 'block' : 'none';
    loadNaiPresetsDropdown();
  }

  function saveNovelAISettings() {
   
    const novelaiEnabled = document.getElementById('novelai-switch').checked;
    const novelaiModel = document.getElementById('novelai-model').value;
    const novelaiApiKey = document.getElementById('novelai-api-key').value.trim();

    localStorage.setItem('novelai-enabled', novelaiEnabled);
    localStorage.setItem('novelai-model', novelaiModel);
    localStorage.setItem('novelai-api-key', novelaiApiKey);

  
    const settings = {
      resolution: document.getElementById('nai-resolution').value,
      steps: parseInt(document.getElementById('nai-steps').value),
      cfg_scale: parseFloat(document.getElementById('nai-cfg-scale').value),
      sampler: document.getElementById('nai-sampler').value,
      seed: parseInt(document.getElementById('nai-seed').value),
      uc_preset: parseInt(document.getElementById('nai-uc-preset').value),
      quality_toggle: document.getElementById('nai-quality-toggle').checked,
      smea: document.getElementById('nai-smea').checked,
      smea_dyn: document.getElementById('nai-smea-dyn').checked,
      default_positive: document.getElementById('nai-default-positive').value,
      default_negative: document.getElementById('nai-default-negative').value,
      cors_proxy: document.getElementById('nai-cors-proxy').value,
      custom_proxy_url: document.getElementById('nai-custom-proxy-url').value
    };

    localStorage.setItem('novelai-settings', JSON.stringify(settings));
  }

  function resetNovelAISettings() {
    localStorage.removeItem('novelai-settings');
    loadNovelAISettings();
    alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆÔºÅ');
  }

  function getNovelAISettings() {
    const defaultSettings = {
      resolution: '1024x1024',
      steps: 28,
      cfg_scale: 5,
      sampler: 'k_euler_ancestral',
      seed: -1,
      uc_preset: 1,
      quality_toggle: true,
      smea: true,
      smea_dyn: false,
      default_positive: 'masterpiece, best quality, 1girl, beautiful, detailed face, detailed eyes, long hair, anime style',
      default_negative: 'lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry',
      cors_proxy: 'https://corsproxy.io/?',
      custom_proxy_url: ''
    };

    const saved = localStorage.getItem('novelai-settings');
    if (saved) {
      try {
        return {
          ...defaultSettings,
          ...JSON.parse(saved)
        };
      } catch (e) {
        return defaultSettings;
      }
    }
    return defaultSettings;
  }

  async function generateNaiImageFromPrompt(aiPrompt, chatId) {
    console.log(`üé® [NAIÊ†∏ÂøÉÁîüÊàê] ÂºÄÂßã... Prompt: "${aiPrompt}", ChatID: ${chatId}`);

    
    const naiPrompts = getCharacterNAIPrompts(chatId);
    const finalPositivePrompt = aiPrompt + ', ' + naiPrompts.positive;
    const finalNegativePrompt = naiPrompts.negative;

    console.log(`üìù ‰ΩøÁî®${naiPrompts.source === 'character' ? 'ËßíËâ≤‰∏ìÂ±û' : 'Á≥ªÁªü'}ÊèêÁ§∫ËØçÈÖçÁΩÆ`);
    console.log('   [+] ÊúÄÁªàÊ≠£Èù¢ÊèêÁ§∫ËØç:', finalPositivePrompt);
    console.log('   [-] ÊúÄÁªàË¥üÈù¢ÊèêÁ§∫ËØç:', finalNegativePrompt);

    const apiKey = localStorage.getItem('novelai-api-key');
    const model = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
    let settings = getNovelAISettings(); // ÂÖàËé∑ÂèñÂÖ®Â±ÄÈªòËÆ§ÂÄº

    // „ÄêÊñ∞Â¢ûÈÄªËæë„ÄëÊ£ÄÊü•ÂΩìÂâçËÅäÂ§©ÊòØÂê¶ÁªëÂÆö‰∫ÜÈ¢ÑËÆæ
    if (chatId && state.chats[chatId] && state.chats[chatId].settings.naiPresetId) {
        const presetId = state.chats[chatId].settings.naiPresetId;
        const preset = await db.naiPresets.get(presetId);
        
        if (preset && preset.settings) {
            console.log(`üé® [NAI] Ê£ÄÊµãÂà∞ËßíËâ≤ÁªëÂÆö‰∫ÜÈ¢ÑËÆæ "${preset.name}"ÔºåÊ≠£Âú®Â∫îÁî®È¢ÑËÆæÂèÇÊï∞...`);
            // Áî®È¢ÑËÆæÂèÇÊï∞Ë¶ÜÁõñÂÖ®Â±ÄÂèÇÊï∞ (Object.assign ÊòØÊµÖÊã∑Ë¥ùÔºåËøôÈáåÂ§üÁî®‰∫Ü)
            // Ê≥®ÊÑèÔºöAPI Key Âíå Proxy ËøòÊòØÁî®ÂÖ®Â±ÄÁöÑÔºåÂõ†‰∏∫È¢ÑËÆæÈáåÊ≤°Â≠ò
            settings = { ...settings, ...preset.settings };
            
            // Â¶ÇÊûúÈ¢ÑËÆæÈáåÊúâÊèêÁ§∫ËØçÔºåÂêàÂπ∂ÈÄªËæëÂèØËÉΩÈúÄË¶ÅË∞ÉÊï¥
            // ÂΩìÂâçÈÄªËæëÊòØÔºöfinalPositive = aiPrompt + characterPrompt + defaultPositive
            // Â¶ÇÊûú‰ΩøÁî®‰∫ÜÈ¢ÑËÆæÔºåpreset.settings.default_positive ‰ºöÊõøÊç¢Êéâ getNovelAISettings() ÈáåÁöÑ default_positive
            // ËøôÁ¨¶ÂêàÈ¢ÑÊúüÔºöÈ¢ÑËÆæÁöÑ‚ÄúÈªòËÆ§ÊèêÁ§∫ËØç‚ÄùÂèòÊàê‰∫ÜËØ•È£éÊ†ºÁöÑÊèêÁ§∫ËØç
        } else {
             console.warn(`[NAI] ËßíËâ≤ÁªëÂÆö‰∫ÜÈ¢ÑËÆæID ${presetId}Ôºå‰ΩÜÊï∞ÊçÆÂ∫ì‰∏≠Êú™ÊâæÂà∞ÔºåÂ∞Ü‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ„ÄÇ`);
        }
    }

    if (!apiKey) {
      throw new Error('NovelAI API KeyÊú™ÈÖçÁΩÆ„ÄÇËØ∑Âú®NovelAIËÆæÁΩÆ‰∏≠Â°´ÂÜôAPI Key„ÄÇ');
    }

    const [width, height] = settings.resolution.split('x').map(Number);

    
    let requestBody;
    if (model.includes('nai-diffusion-4')) {
      requestBody = {
        input: finalPositivePrompt,
        model: model,
        action: 'generate',
        parameters: {
          params_version: 3,
          width: width,
          height: height,
          scale: settings.cfg_scale,
          sampler: settings.sampler,
          steps: settings.steps,
          seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
          n_samples: 1,
          ucPreset: settings.uc_preset,
          qualityToggle: settings.quality_toggle,
          add_original_image: true,
          noise_schedule: 'karras',
          v4_prompt: {
            caption: {
              base_caption: finalPositivePrompt,
              char_captions: []
            },
            use_coords: false,
            use_order: true
          },
          v4_negative_prompt: {
            caption: {
              base_caption: finalNegativePrompt,
              char_captions: []
            },
            legacy_uc: false
          },
          negative_prompt: finalNegativePrompt,
          autoSmea: false,
          dynamic_thresholding: false,
          controlnet_strength: 1,
          legacy: false,
          cfg_rescale: 0,
          legacy_v3_extend: false,
          skip_cfg_above_sigma: null,
          use_coords: false,
          legacy_uc: false,
          normalize_reference_strength_multiple: true,
          inpaintImg2ImgStrength: 1,
          characterPrompts: [],
          deliberate_euler_ancestral_bug: false,
          prefer_brownian: true
        }
      };
    } else {
     
      requestBody = {
        input: finalPositivePrompt,
        model: model,
        action: 'generate',
        parameters: {
          width: width,
          height: height,
          scale: settings.cfg_scale,
          sampler: settings.sampler,
          steps: settings.steps,
          seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
          n_samples: 1,
          ucPreset: settings.uc_preset,
          qualityToggle: settings.quality_toggle,
          sm: settings.smea,
          sm_dyn: settings.smea_dyn,
          negative_prompt: finalNegativePrompt,
          dynamic_thresholding: false,
          controlnet_strength: 1,
          legacy: false,
          add_original_image: false,
          cfg_rescale: 0,
          noise_schedule: 'native'
        }
      };
    }

    console.log('üöÄ ÂèëÈÄÅNAIËØ∑Ê±Ç:', requestBody);

  
    let apiUrl;
    if (model.includes('nai-diffusion-4')) {
      apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
    } else {
      apiUrl = 'https://image.novelai.net/ai/generate-image';
    }

    let corsProxy = settings.cors_proxy;
    if (corsProxy === 'custom') {
      corsProxy = settings.custom_proxy_url || '';
    }
    if (corsProxy && corsProxy !== '') {
      apiUrl = corsProxy + apiUrl;
    }

   
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey
      },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
    }

    const contentType = response.headers.get('content-type');
    let zipBlob;
    let imageDataUrl;

  
    if (contentType && contentType.includes('text/event-stream')) {
    
      const text = await response.text();
      const lines = text.trim().split('\n');
      let base64Data = null;

      for (let i = lines.length - 1; i >= 0; i--) {
        const line = lines[i].trim();
        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
          const dataContent = line.substring(6);
          try {
            const jsonData = JSON.parse(dataContent);
            if (jsonData.event_type === 'final' && jsonData.image) {
              base64Data = jsonData.image;
              break;
            }
            if (jsonData.data) {
              base64Data = jsonData.data;
              break;
            }
            if (jsonData.image) {
              base64Data = jsonData.image;
              break;
            }
          } catch (e) {
            base64Data = dataContent;
            break;
          }
        }
      }
      if (!base64Data) throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');

      const isPNG = base64Data.startsWith('iVBORw0KGgo');
      const isJPEG = base64Data.startsWith('/9j/');

      if (isPNG || isJPEG) {
       
        imageDataUrl = `data:${isPNG ? 'image/png' : 'image/jpeg'};base64,${base64Data}`;
      } else {
       
        const binaryString = atob(base64Data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
        zipBlob = new Blob([bytes]);
      }
    } else {
      
      zipBlob = await response.blob();
    }

 
    if (!imageDataUrl && zipBlob) {
      if (typeof JSZip === 'undefined') throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩ');

      const zip = await JSZip.loadAsync(zipBlob);
      let imageFile = null;
      for (let filename in zip.files) {
        if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
          imageFile = zip.files[filename];
          break;
        }
      }
      if (!imageFile) throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');

      const imageBlob = await imageFile.async('blob');

   
      imageDataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(imageBlob);
      });
    }

    console.log(`‚úÖ [NAIÊ†∏ÂøÉÁîüÊàê] ÊàêÂäüÔºÅ`);
    return {
      imageUrl: imageDataUrl,
      fullPrompt: finalPositivePrompt
    };
  }
 
  function getCharacterNAIPrompts(chatId) {
   
    const systemSettings = getNovelAISettings();

  
    if (!chatId || !state.chats[chatId]) {
      console.log('‚ö†Ô∏è NAIÊèêÁ§∫ËØçÔºöÊ≤°ÊúâËßíËâ≤Ôºå‰ΩøÁî®Á≥ªÁªüÈÖçÁΩÆ');
      return {
        positive: systemSettings.default_positive,
        negative: systemSettings.default_negative,
        source: 'system'
      };
    }

    const chat = state.chats[chatId];
    const naiSettings = chat.settings.naiSettings || {};

 
    if (naiSettings.promptSource === 'character') {
      console.log('‚úÖ NAIÊèêÁ§∫ËØçÔºö‰ΩøÁî®ËßíËâ≤ÈÖçÁΩÆ');
      console.log('   Ê≠£Èù¢:', naiSettings.characterPositivePrompt || '(Á©∫)');
      console.log('   Ë¥üÈù¢:', naiSettings.characterNegativePrompt || '(Á©∫)');

      return {
        positive: naiSettings.characterPositivePrompt || '',
        negative: naiSettings.characterNegativePrompt || '',
        source: 'character'
      };
    } else {
      console.log('‚úÖ NAIÊèêÁ§∫ËØçÔºö‰ΩøÁî®Á≥ªÁªüÈÖçÁΩÆ');
      console.log('   Ê≠£Èù¢:', systemSettings.default_positive || '(Á©∫)');
      console.log('   Ë¥üÈù¢:', systemSettings.default_negative || '(Á©∫)');

      return {
        positive: systemSettings.default_positive,
        negative: systemSettings.default_negative,
        source: 'system'
      };
    }
  }


  async function generateNovelAIImage() {
    const apiKey = document.getElementById('novelai-api-key').value.trim();
    const model = document.getElementById('novelai-model').value;
    const prompt = document.getElementById('nai-test-prompt').value.trim();

    if (!apiKey) {
      alert('ËØ∑ÂÖàÈÖçÁΩÆNovelAI API KeyÔºÅ');
      return;
    }

    if (!prompt) {
      alert('ËØ∑ËæìÂÖ•ÊèêÁ§∫ËØçÔºÅ');
      return;
    }

    const settings = getNovelAISettings();
    const negativePrompt = document.getElementById('nai-test-negative').value.trim();

    const statusDiv = document.getElementById('nai-test-status');
    const resultDiv = document.getElementById('nai-test-result');
    const errorDiv = document.getElementById('nai-test-error');
    const generateBtn = document.getElementById('nai-generate-btn');

    statusDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    generateBtn.disabled = true;
    generateBtn.textContent = 'ÁîüÊàê‰∏≠...';

    try {
      const [width, height] = settings.resolution.split('x').map(Number);

     
      let requestBody;

      if (model.includes('nai-diffusion-4')) {
      
        requestBody = {
          input: prompt,
          model: model,
          action: 'generate',
          parameters: {
            params_version: 3, // V4ÂøÖÈ°ª‰ΩøÁî®ÁâàÊú¨3
            width: width,
            height: height,
            scale: settings.cfg_scale,
            sampler: settings.sampler,
            steps: settings.steps,
            seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
            n_samples: 1,
            ucPreset: settings.uc_preset,
            qualityToggle: settings.quality_toggle,
            autoSmea: false,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            add_original_image: true,
            cfg_rescale: 0,
            noise_schedule: 'karras', // V4‰ΩøÁî®karras
            legacy_v3_extend: false,
            skip_cfg_above_sigma: null,
            use_coords: false,
            legacy_uc: false,
            normalize_reference_strength_multiple: true,
            inpaintImg2ImgStrength: 1,
            characterPrompts: [],
          
            v4_prompt: {
              caption: {
                base_caption: prompt,
                char_captions: []
              },
              use_coords: false,
              use_order: true
            },
           
            v4_negative_prompt: {
              caption: {
                base_caption: negativePrompt,
                char_captions: []
              },
              legacy_uc: false
            },
            negative_prompt: negativePrompt,
            deliberate_euler_ancestral_bug: false,
            prefer_brownian: true
          
          }
        };
      } else {
       
        requestBody = {
          input: prompt,
          model: model,
          action: 'generate',
          parameters: {
            width: width,
            height: height,
            scale: settings.cfg_scale,
            sampler: settings.sampler,
            steps: settings.steps,
            seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
            n_samples: 1,
            ucPreset: settings.uc_preset,
            qualityToggle: settings.quality_toggle,
            sm: settings.smea,
            sm_dyn: settings.smea_dyn,
            dynamic_thresholding: false,
            controlnet_strength: 1,
            legacy: false,
            add_original_image: false,
            cfg_rescale: 0,
            noise_schedule: 'native',
            negative_prompt: negativePrompt
          }
        };
      }

      console.log('üì§ ÂèëÈÄÅËØ∑Ê±ÇÂà∞ NovelAI API');
      console.log('üìä ‰ΩøÁî®Ê®°Âûã:', model);
      console.log('üìã ËØ∑Ê±Ç‰Ωì:', JSON.stringify(requestBody, null, 2));

     
      let apiUrl;

   
      if (model.includes('nai-diffusion-4')) {
   
        apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
      } else {
      
        apiUrl = 'https://image.novelai.net/ai/generate-image';
      }

      let corsProxy = settings.cors_proxy;

     
      if (corsProxy === 'custom') {
        corsProxy = settings.custom_proxy_url || '';
      }

      
      if (corsProxy && corsProxy !== '') {
        apiUrl = corsProxy + encodeURIComponent(apiUrl);
      }

   
      const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
      let fetchOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + apiKey
        },
        body: JSON.stringify(requestBody)
      };

     
      if (isChrome) {
        console.log('üîß Ê£ÄÊµãÂà∞ChromeÊµèËßàÂô®ÔºåÂêØÁî®headersÂÖºÂÆπÊÄßÂ§ÑÁêÜ');
        const cleanHeaders = {};
        for (const [key, value] of Object.entries(fetchOptions.headers)) {
         
          cleanHeaders[key] = value.replace(/[^\x00-\xFF]/g, '');
        }
        fetchOptions.headers = cleanHeaders;
      }

      const response = await fetch(apiUrl, fetchOptions);

      console.log('Response status:', response.status);
      console.log('Response headers:', [...response.headers.entries()]);

      if (!response.ok) {
        const errorText = await response.text();
        console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
      }

     
      const contentType = response.headers.get('content-type');
      console.log('Content-Type:', contentType);

    
      let zipBlob;
      if (contentType && contentType.includes('text/event-stream')) {
        console.log('Ê£ÄÊµãÂà∞ SSE ÊµÅÂºèÂìçÂ∫îÔºåÂºÄÂßãËß£Êûê...');
        statusDiv.textContent = 'Ê≠£Âú®Êé•Êî∂ÊµÅÂºèÊï∞ÊçÆ...';

      
        const text = await response.text();
        console.log('Êî∂Âà∞ SSE Êï∞ÊçÆÔºåÂ§ßÂ∞è:', text.length);

        const lines = text.trim().split('\n');
        let base64Data = null;

        for (let i = lines.length - 1; i >= 0; i--) {
          const line = lines[i].trim();
          if (line.startsWith('data: ') && line !== 'data: [DONE]') {
            const dataContent = line.substring(6);

            
            try {
              const jsonData = JSON.parse(dataContent);

            
              if (jsonData.event_type === 'final' && jsonData.image) {
                base64Data = jsonData.image;
                console.log('‚úÖ ÊâæÂà∞ final ‰∫ã‰ª∂ÁöÑÂõæÁâáÊï∞ÊçÆ');
                break;
              }

            
              if (jsonData.data) {
                base64Data = jsonData.data;
                console.log('‰ªé JSON.data ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                break;
              }
              if (jsonData.image) {
                base64Data = jsonData.image;
                console.log('‰ªé JSON.image ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                break;
              }
            } catch (e) {
           
              base64Data = dataContent;
              console.log('Áõ¥Êé•‰ΩøÁî® base64 Êï∞ÊçÆ');
              break;
            }
          }
        }

        if (!base64Data) {
          throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
        }

       
        const isPNG = base64Data.startsWith('iVBORw0KGgo');
        const isJPEG = base64Data.startsWith('/9j/');

        if (isPNG || isJPEG) {
          console.log('‚úÖ Ê£ÄÊµãÂà∞Áõ¥Êé•ÁöÑÂõæÁâá base64 Êï∞ÊçÆ (PNG/JPEG)');
         
          const binaryString = atob(base64Data);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const imageBlob = new Blob([bytes], {
            type: isPNG ? 'image/png' : 'image/jpeg'
          });
          console.log('ÂõæÁâá Blob ÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', imageBlob.size);

          // Áõ¥Êé•ÊòæÁ§∫ÂõæÁâá
          const imageUrl = URL.createObjectURL(imageBlob);
          document.getElementById('nai-result-image').src = imageUrl;
          statusDiv.style.display = 'none';
          resultDiv.style.display = 'block';
          console.log('‚úÖ ÂõæÁâáÊòæÁ§∫ÊàêÂäüÔºÅüé®');
          return;
        }

     
        console.log('ÂΩì‰Ωú ZIP Êñá‰ª∂Â§ÑÁêÜ...');
        const binaryString = atob(base64Data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        zipBlob = new Blob([bytes]);
        console.log('ZIP Blob Â§ßÂ∞è:', zipBlob.size);

      } else {
       
        zipBlob = await response.blob();
        console.log('Êî∂Âà∞Êï∞ÊçÆÔºåÁ±ªÂûã:', zipBlob.type, 'Â§ßÂ∞è:', zipBlob.size);
      }

     
      try {
       
        if (typeof JSZip === 'undefined') {
          throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
        }

        statusDiv.textContent = 'Ê≠£Âú®Ëß£ÂéãÂõæÁâá...';

        const zip = await JSZip.loadAsync(zipBlob);
        console.log('ZIPÊñá‰ª∂ÂÜÖÂÆπ:', Object.keys(zip.files));

        let imageFile = null;
        for (let filename in zip.files) {
          if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
            imageFile = zip.files[filename];
            console.log('ÊâæÂà∞ÂõæÁâáÊñá‰ª∂:', filename);
            break;
          }
        }

        if (!imageFile) {
          throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');
        }

        const imageBlob = await imageFile.async('blob');
        console.log('ÊèêÂèñÁöÑÂõæÁâáÂ§ßÂ∞è:', imageBlob.size);

        const imageUrl = URL.createObjectURL(imageBlob);
        console.log('ÁîüÊàêÁöÑÂõæÁâáURL:', imageUrl);

        document.getElementById('nai-result-image').src = imageUrl;
        statusDiv.style.display = 'none';
        resultDiv.style.display = 'block';

      } catch (zipError) {
        console.error('ZIPËß£ÂéãÂ§±Ë¥•:', zipError);
       
        console.log('Â∞ùËØïÁõ¥Êé•‰Ωú‰∏∫ÂõæÁâáÊòæÁ§∫...');

        if (zipBlob.type.startsWith('image/')) {
          const imageUrl = URL.createObjectURL(zipBlob);
          document.getElementById('nai-result-image').src = imageUrl;
          statusDiv.style.display = 'none';
          resultDiv.style.display = 'block';
        } else {
          throw new Error('ÂõæÁâáÊ†ºÂºèÂ§ÑÁêÜÂ§±Ë¥•: ' + zipError.message);
        }
      }

    } catch (error) {
      console.error('NovelAIÁîüÊàêÂ§±Ë¥•:', error);
      statusDiv.style.display = 'none';
      errorDiv.style.display = 'block';
      errorDiv.textContent = 'ÁîüÊàêÂ§±Ë¥•: ' + error.message;
    } finally {
      generateBtn.disabled = false;
      generateBtn.textContent = 'ÁîüÊàêÂõæÂÉè';
    }
  }

  function showNotification(chatId, messageContent, isTest = false) {
    playNotificationSound();
    
    clearTimeout(notificationTimeout);
    const chat = state.chats[chatId];
    if (!chat && !isTest) return;
    
    // Ê£ÄÊü•È°µÈù¢ÊòØÂê¶Âú®ÂêéÂè∞
    const isBackground = document.hidden;
    
    // Ëé∑ÂèñÂ§¥ÂÉèÂíåÂêçÂ≠ó
    let avatarUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg'; // ÈªòËÆ§
    let titleText = 'EPhone Ê∂àÊÅØ';
    
    if (chat) {
        titleText = chat.name;
        avatarUrl = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
    }
    
    // Â¶ÇÊûúÂú®ÂêéÂè∞‰∏îÊúâÈÄöÁü•ÊùÉÈôêÔºå‰ΩøÁî®ÊµèËßàÂô®ÂéüÁîüÈÄöÁü•
    if (isBackground && 'Notification' in window && Notification.permission === 'granted') {
        // Â∞ùËØïÈÄöËøá Service Worker ÂèëÈÄÅÈÄöÁü•
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                type: 'SHOW_NOTIFICATION',
                data: {
                    title: titleText,
                    body: messageContent,
                    icon: avatarUrl,
                    tag: chatId ? `chat-${chatId}` : 'ephone-msg',
                    data: { chatId: chatId }
                }
            });
        } else {
            // Áõ¥Êé•‰ΩøÁî® Notification APIÔºàÊúÄÂèØÈù†ÁöÑÊñπÂºèÔºâ
            try {
                const notification = new Notification(titleText, {
                    body: messageContent,
                    icon: avatarUrl,
                    tag: chatId ? `chat-${chatId}` : 'ephone-msg',
                    badge: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1758510900942_qdqqd_djw0z2.jpeg',
                    requireInteraction: false,
                    data: { chatId: chatId }
                });
                
                notification.onclick = function() {
                    window.focus();
                    if (typeof openChat === 'function' && chatId) {
                        openChat(chatId);
                    }
                    notification.close();
                };
                
                console.log('‚úÖ ÂêéÂè∞Á≥ªÁªüÈÄöÁü•Â∑≤ÂèëÈÄÅ');
            } catch (e) {
                console.error('‚ùå ÂêéÂè∞Á≥ªÁªüÈÄöÁü•ÂèëÈÄÅÂ§±Ë¥•:', e);
            }
        }
        
        updateBackButtonUnreadCount();
        return;
    }
    
    // ÂâçÂè∞ÈÄöÁü•ÔºöÂè™ÊòæÁ§∫Â∫îÁî®ÂÜÖÈÄöÁü•Ê†èÔºå‰∏çÂèëÈÄÅÁ≥ªÁªüÈÄöÁü•
    if (!isBackground) {
        // ÂâçÂè∞Êó∂Âè™ÊòæÁ§∫Â∫îÁî®ÂÜÖÈÄöÁü•Ê†èÔºå‰∏çÂèëÈÄÅÁ≥ªÁªüÈÄöÁü•
    }
    
    // ÊòæÁ§∫Â∫îÁî®ÂÜÖÈÄöÁü•Ê†è
    if (!chat) return;
    
    const bar = document.getElementById('notification-bar');
    if (!bar) return;


    document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
    document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
    document.getElementById('notification-content').querySelector('.message').textContent = messageContent;



    bar.classList.remove('visible');


    void bar.offsetWidth;


    bar.classList.add('visible');


    const newBar = bar.cloneNode(true);
    bar.parentNode.replaceChild(newBar, bar);
    newBar.addEventListener('click', () => {
      openChat(chatId);
      newBar.classList.remove('visible');
    });


    notificationTimeout = setTimeout(() => {
      newBar.classList.remove('visible');
    }, 4000);
    updateBackButtonUnreadCount();
  }

  function updateClock() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', {
      hour: '2-digit',
      minute: '2-digit'
    });
    const dateString = now.toLocaleDateString('zh-CN', {
      weekday: 'long',
      month: 'long',
      day: 'numeric'
    });


    document.getElementById('status-bar-time').textContent = timeString;

  }


 
  function parseAiResponse(content) {
    if (!content) return [{
      type: 'text',
      content: '(AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ)'
    }];

    let trimmedContent = content.trim();

   
    const markdownRegex = /```json\s*([\s\S]*?)\s*```/;
    const markdownMatch = trimmedContent.match(markdownRegex);

    if (markdownMatch && markdownMatch[1]) {
    
      trimmedContent = markdownMatch[1].trim();
      console.log("Ëß£ÊûêÂô®ÔºöÂ∑≤ÂêØÁî® Markdown ÊèêÂèñÊ®°Âºè„ÄÇ");
    }

  
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
      try {
        const parsed = JSON.parse(trimmedContent);
        if (Array.isArray(parsed)) {
          console.log("Ëß£ÊûêÊàêÂäüÔºöÊ†áÂáÜJSONÊï∞ÁªÑÊ†ºÂºè„ÄÇ");
          return parsed;
        }
      } catch (e) {
        console.warn("Ê†áÂáÜJSONÊï∞ÁªÑËß£ÊûêÂ§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØïÂº∫ÂäõÊèêÂèñ...");
      }
    }

  
    const startIndex = trimmedContent.indexOf('[');

  
    const lastBraceIndex = trimmedContent.lastIndexOf('}');

    if (startIndex !== -1 && lastBraceIndex !== -1 && lastBraceIndex > startIndex) {

  
      const endIndex = trimmedContent.indexOf(']', lastBraceIndex);

      if (endIndex !== -1) {
        const arrayString = trimmedContent.substring(startIndex, endIndex + 1);
        try {
          const parsed = JSON.parse(arrayString);
          if (Array.isArray(parsed)) {
            console.log("Ëß£ÊûêÊàêÂäüÔºöÈÄöËøáÂº∫ÂäõÊèêÂèñ [ ... } ... ] Ê®°Âºè„ÄÇ");
            return parsed;
          }
        } catch (e) {
          console.warn("Âº∫ÂäõÊèêÂèñ [ ... } ... ] Â§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØïÊèêÂèñÂçï‰∏™ÂØπË±°...");
        }
      }
    }

 
    const jsonMatches = trimmedContent.match(/{[^{}]*}/g);
    if (jsonMatches) {
      const results = [];
      for (const match of jsonMatches) {
        try {
          const parsedObject = JSON.parse(match);
          results.push(parsedObject);
        } catch (e) {
          console.warn("Ë∑≥Ëøá‰∏Ä‰∏™Êó†ÊïàÁöÑJSONÁâáÊÆµ:", match);
        }
      }

      if (results.length > 0) {
        console.log("Ëß£ÊûêÊàêÂäüÔºöÈÄöËøáÂº∫ÂäõÊèêÂèñ {...} Ê®°Âºè„ÄÇ");
        return results;
      }
    }

  
    console.error("ÊâÄÊúâËß£ÊûêÊñπÊ°àÂùáÂ§±Ë¥•ÔºÅÂ∞ÜËøîÂõûÂéüÂßãÊñáÊú¨„ÄÇÂéüÂßãÂõûÂ§ç:", content);
    return [{
      type: 'text',
      content: content
    }];
  }

  function getTimeOfDayGreeting(date = new Date()) {
    const hour = date.getHours();
    if (hour >= 0 && hour < 5) {
      return "ÂáåÊô®";
    } else if (hour >= 5 && hour < 9) {
      return "Êó©‰∏ä";
    } else if (hour >= 9 && hour < 13) {
      return "‰∏äÂçà";
    } else if (hour >= 13 && hour < 18) {
      return "‰∏ãÂçà";
    } else if (hour >= 18 && hour < 24) {
      return "Êôö‰∏ä";
    }
    return "Áé∞Âú®";
  }


  
  async function loadApiPresetsDropdown(forceSelectedId = null) {
    const selectEl = document.getElementById('api-preset-select');
    selectEl.innerHTML = '<option value="current">ÂΩìÂâçÈÖçÁΩÆ (Êú™‰øùÂ≠ò)</option>';

    const presets = await db.apiPresets.toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });

   if (forceSelectedId) { // <--- 2. Êñ∞Â¢ûËøôÊÆµÂà§Êñ≠ÈÄªËæë
        selectEl.value = forceSelectedId;
        return; 
    }
    const currentConfig = state.apiConfig;
    let matchingPresetId = null;
    for (const preset of presets) {

      if (
        preset.proxyUrl === currentConfig.proxyUrl &&
        preset.apiKey === currentConfig.apiKey &&
        preset.model === currentConfig.model &&
        preset.secondaryProxyUrl === currentConfig.secondaryProxyUrl &&
        preset.secondaryApiKey === currentConfig.secondaryApiKey &&
        preset.secondaryModel === currentConfig.secondaryModel &&

        (preset.minimaxGroupId || '') === (currentConfig.minimaxGroupId || '') &&
        (preset.minimaxApiKey || '') === (currentConfig.minimaxApiKey || '') &&
        (preset.minimaxModel || 'speech-01') === (currentConfig.minimaxModel || 'speech-01')
      )

      {
        matchingPresetId = preset.id;
        break;
      }
    }

    if (matchingPresetId) {
      selectEl.value = matchingPresetId;
    } else {
      selectEl.value = 'current';
    }
  }

 
  async function handlePresetSelectionChange() {
    const selectEl = document.getElementById('api-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      return;
    }

    const preset = await db.apiPresets.get(selectedId);
    if (preset) {
      // 1. Âä†ËΩΩÈ¢ÑËÆæ (Ëøô‰ºöË¶ÜÁõñÂΩìÂâçÁöÑ config)
      state.apiConfig = {
        id: 'main',
        proxyUrl: preset.proxyUrl,
        apiKey: preset.apiKey,
        model: preset.model,
        secondaryProxyUrl: preset.secondaryProxyUrl,
        secondaryApiKey: preset.secondaryApiKey,
        secondaryModel: preset.secondaryModel,
        minimaxGroupId: preset.minimaxGroupId,
        minimaxApiKey: preset.minimaxApiKey,
        minimaxModel: preset.minimaxModel
      };

      
      const savedImgbbEnabled = localStorage.getItem('imgbb-enabled');
      const savedImgbbKey = localStorage.getItem('imgbb-api-key');
      const savedCatboxEnabled = localStorage.getItem('catbox-enabled');
      const savedCatboxHash = localStorage.getItem('catbox-userhash');

      if (savedImgbbEnabled !== null) state.apiConfig.imgbbEnable = (savedImgbbEnabled === 'true');
      if (savedImgbbKey !== null) state.apiConfig.imgbbApiKey = savedImgbbKey;
      
      if (savedCatboxEnabled !== null) state.apiConfig.catboxEnable = (savedCatboxEnabled === 'true');
      if (savedCatboxHash !== null) state.apiConfig.catboxUserHash = savedCatboxHash;
      const savedMinimaxGroupId = localStorage.getItem('minimax-group-id');
      const savedMinimaxApiKey = localStorage.getItem('minimax-api-key');
      const savedMinimaxModel = localStorage.getItem('minimax-model');

      if (savedMinimaxGroupId !== null) state.apiConfig.minimaxGroupId = savedMinimaxGroupId;
      if (savedMinimaxApiKey !== null) state.apiConfig.minimaxApiKey = savedMinimaxApiKey;
      if (savedMinimaxModel !== null) state.apiConfig.minimaxModel = savedMinimaxModel;
      const savedGhEnabled = localStorage.getItem('github-enabled');
      const savedGhAuto = localStorage.getItem('github-auto-backup');
      const savedGhInterval = localStorage.getItem('github-backup-interval');
      const savedGhProxyEnabled = localStorage.getItem('github-proxy-enabled');
      const savedGhProxyUrl = localStorage.getItem('github-proxy-url');
      
      // ÂÖ≥ÈîÆÔºöËØªÂèñË¥¶Âè∑‰ø°ÊÅØ
      const savedGhUsername = localStorage.getItem('github-username');
      const savedGhRepo = localStorage.getItem('github-repo');
      const savedGhToken = localStorage.getItem('github-token');
      const savedGhFilename = localStorage.getItem('github-filename');

      if (savedGhEnabled !== null) state.apiConfig.githubEnable = (savedGhEnabled === 'true');
      if (savedGhAuto !== null) state.apiConfig.githubAutoBackup = (savedGhAuto === 'true');
      if (savedGhInterval !== null) state.apiConfig.githubBackupInterval = parseInt(savedGhInterval);
      if (savedGhProxyEnabled !== null) state.apiConfig.githubProxyEnable = (savedGhProxyEnabled === 'true');
      if (savedGhProxyUrl !== null) state.apiConfig.githubProxyUrl = savedGhProxyUrl;

      if (savedGhUsername !== null) state.apiConfig.githubUsername = savedGhUsername;
      if (savedGhRepo !== null) state.apiConfig.githubRepo = savedGhRepo;
      if (savedGhToken !== null) state.apiConfig.githubToken = savedGhToken;
      if (savedGhFilename !== null) state.apiConfig.githubFilename = savedGhFilename;
      await db.apiConfig.put(state.apiConfig);

      renderApiSettings(selectedId);

      document.getElementById('fetch-models-btn').click();
      if (preset.secondaryProxyUrl && preset.secondaryApiKey) {
        document.getElementById('fetch-secondary-models-btn').click();
      }
      //alert(`Â∑≤Âä†ËΩΩÈ¢ÑËÆæ ‚Äú${preset.name}‚Äù`);
    }
  }

  
  async function saveApiPreset() {
    const name = await showCustomPrompt('‰øùÂ≠ò API È¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;


    const presetData = {
      name: name.trim(),
      proxyUrl: document.getElementById('proxy-url').value.trim(),
      apiKey: document.getElementById('api-key').value.trim(),
      model: document.getElementById('model-select').value,
      secondaryProxyUrl: document.getElementById('secondary-proxy-url').value.trim(),
      secondaryApiKey: document.getElementById('secondary-api-key').value.trim(),
      secondaryModel: document.getElementById('secondary-model-select').value,

      minimaxGroupId: document.getElementById('minimax-group-id').value.trim(),
      minimaxApiKey: document.getElementById('minimax-api-key').value.trim(),
      minimaxModel: document.getElementById('minimax-model-select').value

    };


    const existingPreset = await db.apiPresets.where('name').equals(presetData.name).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${presetData.name}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;
      presetData.id = existingPreset.id;
    }

    await db.apiPresets.put(presetData);
    await loadApiPresetsDropdown();
    alert('API È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }


  async function deleteApiPreset() {
    const selectEl = document.getElementById('api-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.apiPresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.apiPresets.delete(selectedId);
      await loadApiPresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }

  function renderApiSettings(forcePresetId = null) {

    document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || '';
    document.getElementById('api-key').value = state.apiConfig.apiKey || '';
    document.getElementById('secondary-proxy-url').value = state.apiConfig.secondaryProxyUrl || '';
    document.getElementById('secondary-api-key').value = state.apiConfig.secondaryApiKey || '';
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
    document.getElementById('enable-ai-drawing-switch').checked = state.globalSettings.enableAiDrawing;
    document.getElementById('chat-render-window-input').value = state.globalSettings.chatRenderWindow || 50;
    document.getElementById('chat-list-render-window-input').value = state.globalSettings.chatListRenderWindow || 30;
    const tempSlider = document.getElementById('api-temperature-slider');
    const tempValue = document.getElementById('api-temperature-value');
    const savedTemp = state.globalSettings.apiTemperature || 0.8;
    tempSlider.value = savedTemp;
    tempValue.textContent = savedTemp;
    const savedMinimaxGroupId = localStorage.getItem('minimax-group-id');
    const savedMinimaxApiKey = localStorage.getItem('minimax-api-key');
    const savedMinimaxModel = localStorage.getItem('minimax-model');

    
    if (savedMinimaxGroupId !== null) state.apiConfig.minimaxGroupId = savedMinimaxGroupId;
    if (savedMinimaxApiKey !== null) state.apiConfig.minimaxApiKey = savedMinimaxApiKey;
    if (savedMinimaxModel !== null) state.apiConfig.minimaxModel = savedMinimaxModel;

   
    document.getElementById('minimax-group-id').value = state.apiConfig.minimaxGroupId || '';
    document.getElementById('minimax-api-key').value = state.apiConfig.minimaxApiKey || '';
    const minimaxSelect = document.getElementById('minimax-model-select');
    if (minimaxSelect) {
        // 1. Â°´ÂÖÖÊ®°ÂûãÂàóË°® (Â∑≤Êé•ÂÖ• Minimax ÂÖ®Á≥ªÂàóÊ®°Âûã)
        const supportedMinimaxModels = [
            // --- 01 Á≥ªÂàó (ÁªèÂÖ∏) ---
            
            { id: 'speech-01-turbo', name: 'Speech-01 Turbo (Âø´ÈÄüÁâà)' },
            { id: 'speech-01-hd', name: 'Speech-01 HD (È´òÊ∏ÖÁâà)' },
            
            
            // --- 02 Á≥ªÂàó ---
            
            { id: 'speech-02-turbo', name: 'Speech-02 Turbo' },
            { id: 'speech-02-hd', name: 'Speech-02 HD' },

            // --- 2.x Á≥ªÂàó (ÂåÖÂê´ÊÇ®Ë¶ÅÁöÑ 2.5) ---
            { id: 'speech-2.5-hd-preview', name: 'Speech-2.5 HD (È´òÊ∏Ö)' },
            { id: 'speech-2.6-turbo', name: 'Speech-2.6 Turbo' },
            { id: 'speech-2.6-hd', name: 'Speech-2.6 HD' },

           
        ];

        minimaxSelect.innerHTML = ''; 
        supportedMinimaxModels.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.name;
            minimaxSelect.appendChild(option);
        });
        minimaxSelect.value = state.apiConfig.minimaxModel || 'speech-01';

        // 2. „ÄêÊñ∞Â¢û„ÄëÂä®ÊÄÅÊèíÂÖ•‚ÄúÊé•Âè£ÂüüÂêç‚ÄùÈÄâÊã©Ê°Ü (Â¶ÇÊûúËøòÊ≤°ÊúâÁöÑËØù)
        

        // 3. „ÄêÊñ∞Â¢û„ÄëÂõûÊòæ‰øùÂ≠òÁöÑËÆæÁΩÆ
        const domainSelect = document.getElementById('minimax-domain-select');
        if (domainSelect) {
            // ‰ºòÂÖàËØªÂèñ stateÔºåÊ≤°ÊúâÂàôËØªÂèñ localStorageÔºåÈªòËÆ§ÂõΩÂÜÖ
            domainSelect.value = state.apiConfig.minimaxDomain || localStorage.getItem('minimax-domain') || 'https://api.minimax.chat';
        }
    }

   
    const novelaiEnabled = localStorage.getItem('novelai-enabled') === 'true';
    const novelaiModel = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
    const novelaiApiKey = localStorage.getItem('novelai-api-key') || '';
    document.getElementById('novelai-switch').checked = novelaiEnabled;
    document.getElementById('novelai-model').value = novelaiModel;
    document.getElementById('novelai-api-key').value = novelaiApiKey;
    document.getElementById('novelai-details').style.display = novelaiEnabled ? 'block' : 'none';
    const imgbbEnableSwitch = document.getElementById('imgbb-enable-switch');
    const imgbbApiKeyInput = document.getElementById('imgbb-api-key');
    const imgbbDetailsDiv = document.getElementById('imgbb-settings-details');

   
    const savedImgbbEnabled = localStorage.getItem('imgbb-enabled');
    const savedImgbbKey = localStorage.getItem('imgbb-api-key');

   
    if (savedImgbbEnabled !== null) state.apiConfig.imgbbEnable = (savedImgbbEnabled === 'true');
    if (savedImgbbKey !== null) state.apiConfig.imgbbApiKey = savedImgbbKey;

    if(imgbbEnableSwitch) {
        imgbbEnableSwitch.checked = state.apiConfig.imgbbEnable || false;
        imgbbApiKeyInput.value = state.apiConfig.imgbbApiKey || '';
        imgbbDetailsDiv.style.display = imgbbEnableSwitch.checked ? 'block' : 'none';
    }

    
    const catboxEnableSwitch = document.getElementById('catbox-enable-switch');
    const catboxUserHashInput = document.getElementById('catbox-userhash');
    const catboxDetailsDiv = document.getElementById('catbox-settings-details');

   
    const savedCatboxEnabled = localStorage.getItem('catbox-enabled');
    const savedCatboxHash = localStorage.getItem('catbox-userhash');

    
    if (savedCatboxEnabled !== null) state.apiConfig.catboxEnable = (savedCatboxEnabled === 'true');
    if (savedCatboxHash !== null) state.apiConfig.catboxUserHash = savedCatboxHash;

    if(catboxEnableSwitch) {
        catboxEnableSwitch.checked = state.apiConfig.catboxEnable || false;
        catboxUserHashInput.value = state.apiConfig.catboxUserHash || '';
        catboxDetailsDiv.style.display = catboxEnableSwitch.checked ? 'block' : 'none';
    }
    const ghSwitch = document.getElementById('github-enable-switch');
    const ghDetails = document.getElementById('github-settings-details');

    // ‰ªé localStorage ËØªÂèñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËØªÂèñ apiConfig (‰øùÊåÅ‰∏ÄËá¥ÊÄß)
    const savedGhEnabled = localStorage.getItem('github-enabled');
    if (savedGhEnabled !== null) state.apiConfig.githubEnable = (savedGhEnabled === 'true');

    if (ghSwitch) {
        ghSwitch.checked = state.apiConfig.githubEnable || false;
        
        // Ê†∏ÂøÉÈÄªËæëÔºöÊ†πÊçÆÂºÄÂÖ≥Áä∂ÊÄÅÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ËØ¶ÊÉÖÊ°Ü
        ghDetails.style.display = ghSwitch.checked ? 'block' : 'none';
        const ghAutoSwitch = document.getElementById('github-auto-backup-switch');
        const ghIntervalInput = document.getElementById('github-backup-interval'); // „ÄêÊñ∞Â¢û„Äë

        if (ghAutoSwitch) {
            const savedAuto = localStorage.getItem('github-auto-backup');
            ghAutoSwitch.checked = savedAuto !== null ? (savedAuto === 'true') : false;
            
            // „ÄêÊñ∞Â¢û„ÄëÂõûÊòæÂàÜÈíüÊï∞ÔºåÈªòËÆ§ 30
            const savedInterval = localStorage.getItem('github-backup-interval');
            if (ghIntervalInput) {
                ghIntervalInput.value = savedInterval ? parseInt(savedInterval) : 30;
            }
        }
        // ÂõûÊòæËæìÂÖ•Ê°ÜÁöÑÂÄº
        document.getElementById('github-username').value = state.apiConfig.githubUsername || '';
        document.getElementById('github-repo').value = state.apiConfig.githubRepo || '';
        document.getElementById('github-token').value = state.apiConfig.githubToken || '';
        document.getElementById('github-filename').value = state.apiConfig.githubFilename || 'ephone_backup.json';
        const ghProxySwitch = document.getElementById('github-proxy-switch');
        const ghProxyInputDiv = document.getElementById('github-proxy-input-group');
        const ghProxyUrlInput = document.getElementById('github-proxy-url');

        // ËØªÂèñ‰øùÂ≠òÁöÑËÆæÁΩÆ
        const savedGhProxyEnabled = localStorage.getItem('github-proxy-enabled');
        const savedGhProxyUrl = localStorage.getItem('github-proxy-url');

        // ËÆæÁΩÆÁä∂ÊÄÅ
        state.apiConfig.githubProxyEnable = savedGhProxyEnabled === 'true';
        state.apiConfig.githubProxyUrl = savedGhProxyUrl || '';

        if (ghProxySwitch) {
            ghProxySwitch.checked = state.apiConfig.githubProxyEnable;
            ghProxyInputDiv.style.display = ghProxySwitch.checked ? 'block' : 'none';
            ghProxyUrlInput.value = state.apiConfig.githubProxyUrl || '';

            // ÁªëÂÆöÂàáÊç¢‰∫ã‰ª∂ÔºåÊéßÂà∂ËæìÂÖ•Ê°ÜÊòæÁ§∫
            ghProxySwitch.addEventListener('change', (e) => {
                ghProxyInputDiv.style.display = e.target.checked ? 'block' : 'none';
            });
        }
    }
    loadApiPresetsDropdown(forcePresetId);
    displayTotalImageSize();
  }

  window.renderApiSettingsProxy = renderApiSettings;



  async function renderNpcListScreen() {
    const listEl = document.getElementById('npc-list');
    listEl.innerHTML = '';

    const npcs = await db.npcs.toArray();

    if (npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïNPCÔºå<br>ÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÊ∑ªÂä†Á¨¨‰∏Ä‰∏™ÂêßÔºÅ</p>';
      return;
    }

    npcs.forEach(npc => {
      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.dataset.npcId = npc.id;

      item.innerHTML = `
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar" style="border-radius: 50%;">
            <div class="info">
                <div class="name-line">
                    <span class="name">${npc.name}</span>
                </div>
                <div class="last-msg">${npc.persona.substring(0, 30)}...</div>
            </div>
        `;

      item.addEventListener('click', () => openNpcEditor(npc.id));


      addLongPressListener(item, async () => {
        await deleteNpc(npc.id);
      });

      listEl.appendChild(item);
    });
  }


 
  async function openNpcEditor(npcId = null) {
    editingNpcId = npcId;
    const modal = document.getElementById('npc-editor-modal');
    const titleEl = document.getElementById('npc-editor-title');
    const nameInput = document.getElementById('npc-name-input');
    const personaInput = document.getElementById('npc-persona-input');
    const avatarPreview = document.getElementById('npc-avatar-preview');
    const associationListEl = document.getElementById('npc-association-list');

   
    const groupSelectEl = document.getElementById('npc-group-select');

    const activitySwitch = document.getElementById('npc-background-activity-switch');
    const cooldownInput = document.getElementById('npc-action-cooldown-input');

    associationListEl.innerHTML = '';
    groupSelectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁªÑ --</option>'; 

   
    const npcGroups = await db.npcGroups.toArray();
    npcGroups.forEach(group => {
      const option = document.createElement('option');
      option.value = group.id;
      option.textContent = group.name;
      groupSelectEl.appendChild(option);
    });

  
    associationListEl.innerHTML += `<label><input type="checkbox" value="user"> ${state.qzoneSettings.nickname || 'Êàë'} (Áî®Êà∑)</label>`;
    Object.values(state.chats).filter(c => !c.isGroup).forEach(char => {
      associationListEl.innerHTML += `<label><input type="checkbox" value="${char.id}"> ${char.name} (ËßíËâ≤)</label>`;
    });

    if (npcId) {
      titleEl.textContent = 'ÁºñËæë NPC';
      const npc = await db.npcs.get(npcId);
      if (npc) {
        nameInput.value = npc.name;
        personaInput.value = npc.persona;
        avatarPreview.src = npc.avatar || defaultGroupMemberAvatar;
        activitySwitch.checked = npc.enableBackgroundActivity !== false;
        cooldownInput.value = npc.actionCooldownMinutes || 15;
        groupSelectEl.value = npc.npcGroupId || ''; 

        if (npc.associatedWith && Array.isArray(npc.associatedWith)) {
          npc.associatedWith.forEach(id => {
            const checkbox = associationListEl.querySelector(`input[value="${id}"]`);
            if (checkbox) checkbox.checked = true;
          });
        }
      }
    } else {
      titleEl.textContent = 'Ê∑ªÂä† NPC';
      nameInput.value = '';
      personaInput.value = '';
      avatarPreview.src = defaultGroupMemberAvatar;
      activitySwitch.checked = true;
      cooldownInput.value = 15;
      groupSelectEl.value = ''; 

      const userCheckbox = associationListEl.querySelector('input[value="user"]');
      if (userCheckbox) userCheckbox.checked = true;
    }

    modal.classList.add('visible');
  }




  async function saveNpc() {
    const name = document.getElementById('npc-name-input').value.trim();
    const persona = document.getElementById('npc-persona-input').value.trim();
    if (!name || !persona) {
      alert("NPCÁöÑÊòµÁß∞Âíå‰∫∫ËÆæÈÉΩ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }

    const selectedAssociations = Array.from(document.querySelectorAll('#npc-association-list input:checked')).map(cb => cb.value);
    const enableBackgroundActivity = document.getElementById('npc-background-activity-switch').checked;
    const actionCooldownMinutes = parseInt(document.getElementById('npc-action-cooldown-input').value) || 15;

   
    const npcGroupId = parseInt(document.getElementById('npc-group-select').value) || null;

    const npcData = {
      name,
      persona,
      avatar: document.getElementById('npc-avatar-preview').src,
      associatedWith: selectedAssociations,
      enableBackgroundActivity: enableBackgroundActivity,
      actionCooldownMinutes: actionCooldownMinutes,
      npcGroupId: npcGroupId 
    };

    if (editingNpcId) {
      await db.npcs.update(editingNpcId, npcData);
    } else {
      const newNpcId = await db.npcs.add(npcData);
      if (isAddingNpcToGroup && state.activeChatId) {
        const chat = state.chats[state.activeChatId];
        if (chat.isGroup) {
          chat.members.push({
            id: `npc_${newNpcId}`,
            originalName: name,
            groupNickname: name,
            persona: persona,
            avatar: npcData.avatar,
            isNpc: true
          });
          await db.chats.put(chat);
        }
      }
    }

    document.getElementById('npc-editor-modal').classList.remove('visible');

    if (isAddingNpcToGroup) {
      isAddingNpcToGroup = false;
      openMemberManagementScreen();
    } else {
      await renderNpcListScreen();
    }
  }
  async function openNpcGroupManager() {
    await renderNpcGroupsInManager();
    document.getElementById('npc-group-manager-modal').classList.add('visible');
  }


  async function renderNpcGroupsInManager() {
    const listEl = document.getElementById('existing-npc-groups-list');
    const categories = await db.npcGroups.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ</p>';
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
        `;
      listEl.appendChild(item);
    });
  }


  async function addNewNpcGroup() {
    const input = document.getElementById('new-npc-group-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁªÑÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    const existing = await db.npcGroups.where('name').equals(name).first();
    if (existing) {
      alert(`ÂàÜÁªÑ "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
      return;
    }
    await db.npcGroups.add({
      name
    });
    input.value = '';
    await renderNpcGroupsInManager();
  }


  async function deleteNpcGroup(groupId) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Âà†Èô§ÂàÜÁªÑÂêéÔºåËØ•ÁªÑÂÜÖÁöÑÊâÄÊúâNPCÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁªÑ‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      }
    );
    if (confirmed) {
      await db.npcGroups.delete(groupId);
      // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁªÑÁöÑNPCÁöÑ npcGroupId ËÆæ‰∏∫ null
      await db.npcs.where('npcGroupId').equals(groupId).modify({
        npcGroupId: null
      });
      await renderNpcGroupsInManager();
    }
  }


  async function deleteNpc(npcId) {
    const npc = await db.npcs.get(npcId);
    if (!npc) return;
    const confirmed = await showCustomConfirm('Âà†Èô§NPC', `Á°ÆÂÆöË¶ÅÂà†Èô§NPC ‚Äú${npc.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.npcs.delete(npcId);
      await renderNpcListScreen();
    }
  }


  let chatListRenderCount = 0;



 
  function createChatGroupContainer(group) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'chat-group-container';
    groupContainer.innerHTML = `
        <div class="chat-group-header">
            <span class="arrow">‚ñº</span>
            <span class="group-name">${group.name}</span>
        </div>
        <div class="chat-group-content"></div>
    `;
    return groupContainer;
  }



 
  function loadMoreChats(sortedItems) {
    const chatListEl = document.getElementById('chat-list');
    const loadMoreBtn = document.getElementById('load-more-chats-btn');
    if (loadMoreBtn) loadMoreBtn.remove();

    const nextSliceStart = chatListRenderCount;
    const nextSliceEnd = chatListRenderCount + CHAT_LIST_RENDER_WINDOW;
    const itemsToAppend = sortedItems.slice(nextSliceStart, nextSliceEnd);


    const fragment = document.createDocumentFragment();
    let currentGroupContent = chatListEl.querySelector('.chat-group-content:last-of-type');

    itemsToAppend.forEach(item => {
      if (item.type === 'groupHeader') {
        const groupContainer = createChatGroupContainer(item.group);
        fragment.appendChild(groupContainer);
        currentGroupContent = groupContainer.querySelector('.chat-group-content');
      } else if (item.type === 'chatItem') {
        const listItem = createChatListItem(item.chat);
        if (currentGroupContent && item.chat.groupId) {
          currentGroupContent.appendChild(listItem);
        } else {
          fragment.appendChild(listItem);
          currentGroupContent = null;
        }
      }
    });


    chatListEl.appendChild(fragment);
    chatListRenderCount += itemsToAppend.length;

    if (sortedItems.length > chatListRenderCount) {
      appendLoadMoreChatsButton(chatListEl, sortedItems);
    }


    document.querySelectorAll('.chat-group-header').forEach(header => {
      const newHeader = header.cloneNode(true);
      header.parentNode.replaceChild(newHeader, header);
      newHeader.addEventListener('click', () => {
        newHeader.classList.toggle('collapsed');
        newHeader.nextElementSibling.classList.toggle('collapsed');
      });
    });
  }


  async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';


    const allChats = Object.values(state.chats).sort((a, b) => {
      const pinDiff = (b.isPinned || false) - (a.isPinned || false);
      if (pinDiff !== 0) return pinDiff;
      return (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0);
    });

    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
      chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÊàñÁæ§ÁªÑÂõæÊ†áÊ∑ªÂä†ËÅäÂ§©</p>';
      return;
    }

    allGroups.forEach(group => {
      const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
      group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);


    sortedChatListItems = [];
    const processedChatIds = new Set();


    allChats.forEach(chat => {
      if (chat.isPinned) {
        sortedChatListItems.push({
          type: 'chatItem',
          chat
        });
        processedChatIds.add(chat.id);
      }
    });


    allGroups.forEach(group => {

      const groupChats = allChats.filter(chat =>
        !chat.isPinned &&
        !chat.isGroup &&
        chat.groupId === group.id
      );


      if (groupChats.length > 0) {
        sortedChatListItems.push({
          type: 'groupHeader',
          group
        });

        groupChats.forEach(chat => {
          sortedChatListItems.push({
            type: 'chatItem',
            chat
          });
          processedChatIds.add(chat.id);
        });
      }
    });


    allChats.forEach(chat => {
      if (!processedChatIds.has(chat.id)) {
        sortedChatListItems.push({
          type: 'chatItem',
          chat
        });
        processedChatIds.add(chat.id);
      }
    });


    chatListRenderCount = 0;
    loadMoreChats();
  }




  function createChatGroupContainer(group) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'chat-group-container';
    groupContainer.innerHTML = `
                <div class="chat-group-header">
                    <span class="arrow">‚ñº</span>
                    <span class="group-name">${group.name}</span>
                </div>
                <div class="chat-group-content"></div>
            `;
    return groupContainer;
  }

  function appendLoadMoreChatsButton(container, sortedItems) {
    const button = document.createElement('button');
    button.id = 'load-more-chats-btn';
    button.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑ‰ºöËØù';
    button.className = 'load-more-btn';


    button.addEventListener('click', () => loadMoreChats(sortedItems), {
      once: true
    });

    container.prepend(button);
  }


  function loadMoreChats() {
    if (isLoadingMoreChats) return;

    const chatListEl = document.getElementById('chat-list');
    const scrollContainer = document.getElementById('messages-view');
    if (!chatListEl || !scrollContainer) return;
    if (chatListRenderCount >= sortedChatListItems.length) return;

    isLoadingMoreChats = true;


    const isInitialLoad = chatListRenderCount === 0;


    const renderContent = () => {
      hideLoader(chatListEl);

      const renderWindow = state.globalSettings.chatListRenderWindow || 30;
      const nextSliceStart = chatListRenderCount;
      const nextSliceEnd = chatListRenderCount + renderWindow;
      const itemsToAppend = sortedChatListItems.slice(nextSliceStart, nextSliceEnd);

      const fragment = document.createDocumentFragment();
      let currentGroupContent = chatListEl.querySelector('.chat-group-content:last-of-type');

      itemsToAppend.forEach(item => {
        if (item.type === 'groupHeader') {
          const groupContainer = createChatGroupContainer(item.group);
          fragment.appendChild(groupContainer);
          currentGroupContent = groupContainer.querySelector('.chat-group-content');
        } else if (item.type === 'chatItem') {
          const listItem = createChatListItem(item.chat);
          if (item.chat.groupId && currentGroupContent) {
            currentGroupContent.appendChild(listItem);
          } else {
            fragment.appendChild(listItem);
            if (!item.chat.groupId) currentGroupContent = null;
          }
        }
      });

      chatListEl.appendChild(fragment);
      chatListRenderCount += itemsToAppend.length;

      chatListEl.querySelectorAll('.chat-group-header:not([data-has-listener="true"])').forEach(header => {
        header.dataset.hasListener = "true";
        header.addEventListener('click', () => {
          header.classList.toggle('collapsed');
          header.nextElementSibling.classList.toggle('collapsed');
        });
      });

      isLoadingMoreChats = false;

      if (scrollContainer.scrollHeight <= scrollContainer.clientHeight && chatListRenderCount < sortedChatListItems.length) {
        loadMoreChats();
      }
    };


    if (isInitialLoad) {

      renderContent();
    } else {

      showLoader(chatListEl, 'bottom');
      setTimeout(renderContent, 500);
    }
  }

  function createChatListItem(chat) {

    try {
      const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
      let lastMsgDisplay;

      if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[Â•ΩÂèãÁî≥ËØ∑] ${chat.relationship.applicationReason || 'ËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèã'}</span>`;
      } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
        lastMsgDisplay = `<span style="color: #dc3545;">[‰Ω†Â∑≤Ë¢´ÂØπÊñπÊãâÈªë]</span>`;
      } else if (chat.isGroup) {
        if (lastMsgObj.type === 'pat_message') {
          lastMsgDisplay = `[Á≥ªÁªüÊ∂àÊÅØ] ${lastMsgObj.content}`;
        } else if (lastMsgObj.type === 'transfer') {
          lastMsgDisplay = '[ËΩ¨Ë¥¶]';
        } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') {
          lastMsgDisplay = '[ÁÖßÁâá]';
        } else if (lastMsgObj.type === 'voice_message') {
          lastMsgDisplay = '[ËØ≠Èü≥]';
        } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) {
          lastMsgDisplay = lastMsgObj.meaning ? `[Ë°®ÊÉÖ: ${lastMsgObj.meaning}]` : '[Ë°®ÊÉÖ]';
        } else if (Array.isArray(lastMsgObj.content)) {
          lastMsgDisplay = `[ÂõæÁâá]`;
        } else {
          lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20);
        }

        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
          const senderDisplayName = getDisplayNameInGroup(chat, lastMsgObj.senderName);
          lastMsgDisplay = `${senderDisplayName}: ${lastMsgDisplay}`;
        }
      } else {
        const statusText = chat.status?.text || 'Âú®Á∫ø';
        lastMsgDisplay = `[${statusText}]`;
      }

      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.dataset.chatId = chat.id;
      if (chat.isPinned) {
        item.classList.add('pinned');
      }

      const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
      const avatarFrameSrc = chat.isGroup ? '' : (chat.settings.aiAvatarFrame || '');
      let avatarHtml;
      if (avatarFrameSrc) {
        avatarHtml = `<div class="avatar-with-frame"><img src="${avatar || defaultAvatar}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
      } else {
        avatarHtml = `<img src="${avatar || defaultAvatar}" class="avatar">`;
      }
      const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
      const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

      item.innerHTML = `
            ${avatarGroupHtml}
            <div class="info">
                <div class="name-line">
                    <span class="name">${chat.name}</span>
                    ${chat.isGroup ? '<span class="group-tag">Áæ§ËÅä</span>' : ''}
                </div>
                <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
            </div>
            <div class="unread-count-wrapper">
                <span class="unread-count" style="display: none;">0</span>
            </div>
        `;

      const unreadCount = chat.unreadCount || 0;
      const unreadEl = item.querySelector('.unread-count');
      if (unreadCount > 0) {
        unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
        unreadEl.style.display = 'inline-flex';
      } else {
        unreadEl.style.display = 'none';
      }

      const avatarGroupEl = item.querySelector('.avatar-group');
      if (avatarGroupEl) {
        avatarGroupEl.style.cursor = 'pointer';
        avatarGroupEl.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const nameToPat = chat.isGroup ? chat.name : chat.originalName;
          handleUserPat(chat.id, nameToPat);
        });
      }

      const infoEl = item.querySelector('.info');
      if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
      }

      addLongPressListener(item, async (e) => {
        const action = await showChatListActions(chat);
        switch (action) {
          case 'pin':
            chat.isPinned = !chat.isPinned;
            await db.chats.put(chat);
            renderChatList();
            break;
          case 'delete':
            const deleteConfirmed = await showCustomConfirm('Âà†Èô§ÂØπËØù', `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${chat.name}" ÁöÑÊï¥‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, {
              confirmButtonClass: 'btn-danger'
            });
            if (deleteConfirmed) {
              if (musicState.isActive && musicState.activeChatId === chat.id) {
                await endListenTogetherSession(false);
              }
              delete state.chats[chat.id];
              if (state.activeChatId === chat.id) state.activeChatId = null;
              await db.chats.delete(chat.id);
              renderChatList();
            }
            break;
          default:
            break;
        }
      });
      return item;

    } catch (error) {

      console.error(`Ê∏≤ÊüìËÅäÂ§©È°π [${chat.name || 'Êú™Áü•'}] (ID: ${chat.id}) Êó∂Âá∫Èîô:`, error);
      return null;
    }
  }


  async function renderChatInterface(chatId) {
    applyButtonOrder();
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;

    exitSelectionMode();

    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');

    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
      statusContainer.style.display = 'none';
      document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
      statusContainer.style.display = 'flex';
      document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
      statusTextEl.textContent = chat.status?.text || 'Âú®Á∫ø';
      statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }

    const chatScreen = document.getElementById('chat-interface-screen');
    const individualBg = chat.settings.background;
    const globalBg = state.globalSettings.globalChatBackground;
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
    const defaultColor = isDarkMode ? '#000000' : '#f0f2f5';

    if (individualBg) {
      chatScreen.style.backgroundImage = `url("${individualBg}")`;
      chatScreen.style.backgroundColor = 'transparent';
    } else if (globalBg) {
      chatScreen.style.backgroundImage = `url("${globalBg}")`;
      chatScreen.style.backgroundColor = 'transparent';
    } else {
      chatScreen.style.backgroundImage = 'none';
      chatScreen.style.backgroundColor = defaultColor;
    }


    if (chat.isSpectatorGroup) {
      chatInputArea.style.display = 'none';
      lockOverlay.style.display = 'flex';
      lockContent.innerHTML = `
                    <span class="lock-text">Ê≠£Âú®Âõ¥ËßÇAI‰ª¨ÁöÑÁæ§ËÅä...</span>
                    <div class="spectator-actions-container">
                        <button id="spectator-reroll-btn" class="lock-action-btn secondary" title="ÈáçÊñ∞ÁîüÊàê‰∏ä‰∏ÄËΩÆÂØπËØù">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <button id="spectator-propel-btn" class="lock-action-btn">üé¨ Êé®ËøõÂâßÊÉÖ</button>
                        <button id="spectator-edit-btn" class="lock-action-btn secondary" title="ÂØºÊºîÂâ™ËæëÂÆ§ÔºöÁºñËæëAI‰∏ä‰∏ÄËΩÆÁöÑÂìçÂ∫î">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                                <line x1="16" y1="8" x2="2" y2="22"></line>
                                <line x1="17.5" y1="15" x2="9" y2="15"></line>
                            </svg>
                        </button>
                    </div>
                `;
      document.getElementById('spectator-propel-btn').onclick = triggerSpectatorGroupAiAction;
    } else {
      chatInputArea.style.display = 'flex';
      lockOverlay.style.display = 'none';
      lockContent.innerHTML = '';
      if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';

        let lockHtml = '';
        switch (chat.relationship.status) {
          case 'blocked_by_user':
            const isSimulationRunning = simulationIntervalId !== null;
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            const cooldownHours = state.globalSettings.blockCooldownHours || 1;
            const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
            const timeSinceBlock = Date.now() - blockedTimestamp;
            const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
            const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

            lockHtml = `
                                <span class="lock-text">‰Ω†Â∑≤Â∞Ü‚Äú${chat.name}‚ÄùÊãâÈªë„ÄÇ</span>
                                <button id="unblock-btn" class="lock-action-btn">Ëß£Èô§ÊãâÈªë</button>
                                <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                                    <strong style="color: #333;">„ÄêÂºÄÂèëËÄÖËØäÊñ≠Èù¢Êùø„Äë</strong><br>
                                    - ÂêéÂè∞Ê¥ªÂä®ÊÄªÂºÄÂÖ≥: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤ÂºÄÂêØ</span>' : '<span style="color: red;">Â∑≤ÂÖ≥Èó≠</span>'}<br>
                                    - Á≥ªÁªüÂøÉË∑≥ËÆ°Êó∂Âô®: ${isSimulationRunning ? '<span style="color: green;">ËøêË°å‰∏≠</span>' : '<span style="color: red;">Êú™ËøêË°å</span>'}<br>
                                    - ÂΩìÂâçËßíËâ≤Áä∂ÊÄÅ: <strong>${chat.relationship.status}</strong><br>
                                    - ÈúÄË¶ÅÂÜ∑Èùô(Â∞èÊó∂): <strong>${cooldownHours}</strong><br>
                                    - ÂÜ∑ÈùôÊúüÊòØÂê¶ÁªìÊùü: ${isCooldownOver ? '<span style="color: green;">ÊòØ</span>' : `<span style="color: orange;">Âê¶ (ËøòÂâ©Á∫¶ ${timeRemainingMinutes} ÂàÜÈíü)</span>`}<br>
                                    - Ëß¶ÂèëÊù°‰ª∂: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤Êª°Ë∂≥ÔºåÁ≠âÂæÖ‰∏ãÊ¨°Á≥ªÁªüÂøÉË∑≥</span>' : '<span style="color: red;">Êú™Êª°Ë∂≥</span>'}
                                </div>
                                <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">Âº∫Âà∂Ëß¶Âèë‰∏ÄÊ¨°Â•ΩÂèãÁî≥ËØ∑Ê£ÄÊµã</button>
                            `;
            break;
          case 'blocked_by_ai':
            lockHtml = `
                                <span class="lock-text">‰Ω†Ë¢´ÂØπÊñπÊãâÈªë‰∫Ü„ÄÇ</span>
                                <button id="apply-friend-btn" class="lock-action-btn">ÈáçÊñ∞Áî≥ËØ∑Âä†‰∏∫Â•ΩÂèã</button>
                            `;
            break;
          case 'pending_user_approval':
            lockHtml = `
                                <span class="lock-text">‚Äú${chat.name}‚ÄùËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèãÔºö<br><i>‚Äú${chat.relationship.applicationReason}‚Äù</i></span>
                                <button id="accept-friend-btn" class="lock-action-btn">Êé•Âèó</button>
                                <button id="reject-friend-btn" class="lock-action-btn secondary">ÊãíÁªù</button>
                            `;
            break;
          case 'pending_ai_approval':
            lockHtml = `<span class="lock-text">Â•ΩÂèãÁî≥ËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÈÄöËøá...</span>`;
            break;
        }
        lockContent.innerHTML = lockHtml;
      } else {
        lockOverlay.style.display = 'none';
        chatInputArea.style.visibility = 'visible';
      }
    }

    messagesContainer.innerHTML = '';
    const history = chat.history;
    currentRenderedCount = 0;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const initialMessages = history.slice(-renderWindow);



    const fragment = document.createDocumentFragment();
    let lastTimestamp = 0;

   
    for (const msg of initialMessages) {
      
      if (!msg.isHidden) {
        if (lastTimestamp > 0 && (msg.timestamp - lastTimestamp > 600000)) {
          
          fragment.appendChild(createSystemTimestampElement(msg.timestamp));
        }
        lastTimestamp = msg.timestamp;
      }
      
    
      const messageEl = await createMessageElement(msg, chat, true); 
      
      if (messageEl) {
        fragment.appendChild(messageEl);
      }
    }

   
    messagesContainer.appendChild(fragment);

    currentRenderedCount = initialMessages.length;

    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
    messagesContainer.appendChild(typingIndicator);
    const images = messagesContainer.querySelectorAll('img');
const imageLoadPromises = [];

images.forEach(img => {
    
    if (!img.complete) {
       
        imageLoadPromises.push(new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve; 
        }));
    }
});


Promise.all(imageLoadPromises).then(() => {
   
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    console.log('ÊâÄÊúâÂàùÂßãÂõæÁâáÂä†ËΩΩÂÆåÊàêÔºåÂ∑≤ÊªöÂä®Âà∞Â∫ïÈÉ®„ÄÇ');
}).catch(err => {
   
    console.error("Á≠âÂæÖÂõæÁâáÂä†ËΩΩÊó∂Âá∫Èîô:", err);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
});
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
  }




  async function loadMoreMessages() {
      if (isLoadingMoreMessages) return;
      isLoadingMoreMessages = true;

      const messagesContainer = document.getElementById('chat-messages');
      const chat = state.chats[state.activeChatId];
      if (!chat) {
          isLoadingMoreMessages = false;
          return;
      }

     
      showLoader(messagesContainer, 'top'); 
      const oldScrollHeight = messagesContainer.scrollHeight;

      
      await new Promise(resolve => setTimeout(resolve, 100)); 

     
      const totalMessages = chat.history.length;
      const renderWindow = state.globalSettings.chatRenderWindow || 50;
      const nextSliceStart = totalMessages - currentRenderedCount - renderWindow;
      const nextSliceEnd = totalMessages - currentRenderedCount;
      const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd);

     
      if (messagesToPrepend.length === 0) {
          hideLoader(messagesContainer);
          isLoadingMoreMessages = false;
          return;
      }
      currentRenderedCount += messagesToPrepend.length;
    
      const messageElements = [];
      for (const msg of messagesToPrepend) { 
          const el = await createMessageElement(msg, chat);
          messageElements.push(el); 
      }
    
     

      const fragment = document.createDocumentFragment();
          const firstVisibleMessage = messagesContainer.querySelector('.message-wrapper[data-timestamp]');
         
          let timestampOfFirstVisible = firstVisibleMessage ? parseInt(firstVisibleMessage.dataset.timestamp) : 0;

          let lastTimestampInNewBatch = 0; 

      
          messagesToPrepend.forEach((msg, index) => {
              if (!msg.isHidden) {
                 
                  if (lastTimestampInNewBatch > 0 && (msg.timestamp - lastTimestampInNewBatch > 600000)) {
                      fragment.appendChild(createSystemTimestampElement(msg.timestamp));
                  }
                  lastTimestampInNewBatch = msg.timestamp;
              }
              
              const element = messageElements[index]; 
              if (element) {
                  fragment.appendChild(element); 
              }
          });
         
          if (timestampOfFirstVisible > 0 && (timestampOfFirstVisible - lastTimestampInNewBatch > 600000)) {
               fragment.appendChild(createSystemTimestampElement(timestampOfFirstVisible));
          }
    
         
          
          hideLoader(messagesContainer);
          messagesContainer.prepend(fragment);
      

      const newScrollHeight = messagesContainer.scrollHeight;
      messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;

      isLoadingMoreMessages = false;
     
  }
  
  // Expose renderChatInterface to window for global access
  window.renderChatInterface = renderChatInterface;




  function renderWallpaperScreen(forcePresetId = null) {
    loadCssPresetsDropdown();
    // ËøôÈáå‰º†ÂÖ• forcePresetId
    loadAppearancePresetsDropdown(forcePresetId);

    const ephonePreview = document.getElementById('wallpaper-preview');

    if (newWallpaperBase64) {
      ephonePreview.style.backgroundImage = `url("${newWallpaperBase64}")`;
      ephonePreview.textContent = '';
    } else {
      const ephoneBg = state.globalSettings.wallpaper;
      if (ephoneBg && ephoneBg.trim() !== '') {
          ephonePreview.style.backgroundImage = `url("${ephoneBg}")`;
          ephonePreview.textContent = '';
      } else {
          ephonePreview.style.backgroundImage = 'linear-gradient(135deg, #89f7fe, #66a6ff)';
          ephonePreview.textContent = 'ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†';
      }
    }

    const cphonePreview = document.getElementById('cphone-wallpaper-preview');
    const cphoneBg = state.globalSettings.cphoneWallpaper;
    if (cphoneBg) {
      cphonePreview.style.backgroundImage = `url("${cphoneBg}")`;
      cphonePreview.textContent = '';
    } else {
      cphonePreview.style.backgroundImage = 'linear-gradient(135deg, #f6d365, #fda085)';
      cphonePreview.textContent = 'ÂΩìÂâç‰∏∫Ê∏êÂèòËâ≤';
    }

    const globalBgPreview = document.getElementById('global-bg-preview');
    const globalBg = state.globalSettings.globalChatBackground;
    if (globalBg) {
      globalBgPreview.style.backgroundImage = `url(${globalBg})`;
      globalBgPreview.textContent = '';
      document.getElementById('remove-global-bg-btn').style.display = 'inline-block';
    } else {
      globalBgPreview.style.backgroundImage = 'none';
      globalBgPreview.textContent = 'ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†';
      document.getElementById('remove-global-bg-btn').style.display = 'none';
    }

    renderIconSettings();
    renderCPhoneIconSettings();
    document.getElementById('global-css-input').value = state.globalSettings.globalCss || '';
    document.getElementById('notification-sound-url-input').value = state.globalSettings.notificationSoundUrl || '';
    document.getElementById('status-bar-toggle-switch').checked = state.globalSettings.showStatusBar || false;
    document.getElementById('phone-frame-toggle-switch').checked = state.globalSettings.showPhoneFrame || false;
    document.getElementById('minimal-chat-ui-switch').checked = state.globalSettings.enableMinimalChatUI || false;
    document.getElementById('dynamic-island-music-toggle-switch').checked = state.globalSettings.alwaysShowMusicIsland || false;
    document.getElementById('detach-status-bar-switch').checked = state.globalSettings.detachStatusBar || false;
    document.getElementById('lock-screen-toggle').checked = state.globalSettings.lockScreenEnabled || false; // ÈîÅÂ±èÂõûÊòæ
    document.getElementById('lock-screen-password-input').value = state.globalSettings.lockScreenPassword || ''; // ÂØÜÁ†ÅÂõûÊòæ

    // ÈîÅÂ±èÂ£ÅÁ∫∏ÂõûÊòæ
    const lockPreview = document.getElementById('lock-wallpaper-preview');
    if (state.globalSettings.lockScreenWallpaper) {
        lockPreview.style.backgroundImage = `url(${state.globalSettings.lockScreenWallpaper})`;
        lockPreview.textContent = '';
    } else {
        lockPreview.style.backgroundImage = 'linear-gradient(135deg, #1c1c1e, #3a3a3c)';
        lockPreview.textContent = 'ÈªòËÆ§Â£ÅÁ∫∏';
    }
    
    renderButtonOrderEditor();
    initializeButtonOrderEditor();
  }

  window.renderWallpaperScreenProxy = renderWallpaperScreen;

  function applyGlobalWallpaper() {
    const homeScreen = document.getElementById('home-screen');
    const wallpaper = state.globalSettings.wallpaper;
    if (wallpaper) {

      homeScreen.style.backgroundImage = `url("${wallpaper}")`;
    } else {

      homeScreen.style.backgroundImage = 'linear-gradient(135deg, #89f7fe, #66a6ff)';
    }
  }



  function switchWorldBookCategory(categoryId) {

    document.querySelectorAll('.world-book-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });

    document.querySelectorAll('.world-book-category-pane').forEach(pane => {
      pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
  }


  async function renderWorldBookScreen() {
    const tabsContainer = document.getElementById('world-book-tabs');
    const contentContainer = document.getElementById('world-book-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';


    const [books, categories] = await Promise.all([
      db.worldBooks.toArray(),
      db.worldBookCategories.orderBy('name').toArray()
    ]);

    state.worldBooks = books;

    if (books.length === 0) {
      contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶</p>';
      return;
    }


    const allTab = document.createElement('button');
    allTab.className = 'world-book-tab active';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    tabsContainer.appendChild(allTab);

    const allPane = document.createElement('div');
    allPane.className = 'world-book-category-pane active';
    allPane.dataset.categoryId = 'all';
    contentContainer.appendChild(allPane);


    categories.forEach(category => {
      const categoryTab = document.createElement('button');
      categoryTab.className = 'world-book-tab';
      categoryTab.textContent = category.name;
      categoryTab.dataset.categoryId = String(category.id);
      tabsContainer.appendChild(categoryTab);

      const categoryPane = document.createElement('div');
      categoryPane.className = 'world-book-category-pane';
      categoryPane.dataset.categoryId = String(category.id);
      contentContainer.appendChild(categoryPane);
    });


    const hasUncategorized = books.some(book => !book.categoryId);
    if (hasUncategorized) {
      const uncategorizedTab = document.createElement('button');
      uncategorizedTab.className = 'world-book-tab';
      uncategorizedTab.textContent = 'Êú™ÂàÜÁ±ª';
      uncategorizedTab.dataset.categoryId = 'uncategorized';
      tabsContainer.appendChild(uncategorizedTab);

      const uncategorizedPane = document.createElement('div');
      uncategorizedPane.className = 'world-book-category-pane';
      uncategorizedPane.dataset.categoryId = 'uncategorized';
      contentContainer.appendChild(uncategorizedPane);
    }


    books.forEach(book => {
      let contentPreview = 'ÊöÇÊó†ÂÜÖÂÆπ...';
      if (Array.isArray(book.content) && book.content.length > 0) {
        const firstEntry = book.content[0];
        contentPreview = firstEntry.comment || firstEntry.content || '';
      } else if (typeof book.content === 'string' && book.content.trim() !== '') {
        contentPreview = book.content;
      }

      const card = document.createElement('div');
      card.className = 'world-book-card';
      card.innerHTML = `
                    <div class="card-title">${book.name}</div>
                    <div class="card-content-preview">${contentPreview}</div>
                `;


      const cardClickHandler = () => openWorldBookEditor(book.id);
      const cardLongPressHandler = async () => {
        const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.worldBooks.delete(book.id);
          state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id);
          renderWorldBookScreen();
        }
      };

      card.addEventListener('click', cardClickHandler);
      addLongPressListener(card, cardLongPressHandler);


      const clonedCardForAll = card.cloneNode(true);
      clonedCardForAll.addEventListener('click', cardClickHandler);
      addLongPressListener(clonedCardForAll, cardLongPressHandler);
      allPane.appendChild(clonedCardForAll);


      const categoryKey = book.categoryId ? String(book.categoryId) : 'uncategorized';
      const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
      if (targetPane) {
        targetPane.appendChild(card);
      }
    });


    document.querySelectorAll('.world-book-tab').forEach(tab => {
      tab.addEventListener('click', () => switchWorldBookCategory(tab.dataset.categoryId));
    });
  }



  function createWorldBookGroup(groupName, books) {
    const groupContainer = document.createElement('div');
    groupContainer.className = 'world-book-group-container';

    groupContainer.innerHTML = `
                <div class="world-book-group-header">
                    <span class="arrow">‚ñº</span>
                    <span class="group-name">${groupName}</span>
                </div>
                <div class="world-book-group-content"></div>
            `;

    const contentEl = groupContainer.querySelector('.world-book-group-content');
    books.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

    books.forEach(book => {

      let contentPreview = 'ÊöÇÊó†ÂÜÖÂÆπ...';


      if (Array.isArray(book.content) && book.content.length > 0) {


        const firstEntry = book.content[0];
        contentPreview = firstEntry.comment || firstEntry.content || '';
      } else if (typeof book.content === 'string' && book.content.trim() !== '') {

        contentPreview = book.content;
      }


      const item = document.createElement('div');
      item.className = 'list-item';
      item.dataset.bookId = book.id;

      item.innerHTML = `
                    <div class="item-title">${book.name}</div>
                    <div class="item-content">${String(contentPreview).substring(0, 50)}</div>
                `;
      item.addEventListener('click', () => openWorldBookEditor(book.id));
      addLongPressListener(item, async () => {
        const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.worldBooks.delete(book.id);
          state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id);
          renderWorldBookScreen();
        }
      });
      contentEl.appendChild(item);
    });

    return groupContainer;
  }

  window.renderWorldBookScreenProxy = renderWorldBookScreen;


  async function openWorldBookEditor(bookId) {


    showScreen('world-book-editor-screen');

    editingWorldBookId = bookId;
    const [book, categories] = await Promise.all([
      db.worldBooks.get(bookId),
      db.worldBookCategories.toArray()
    ]);


    if (!book) {
      console.error("Â∞ùËØïÊâìÂºÄ‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑ‰∏ñÁïå‰π¶ÔºåID:", bookId);
      showScreen('world-book-screen');
      return;
    }


    document.getElementById('world-book-editor-title').textContent = book.name;
    document.getElementById('world-book-name-input').value = book.name;


    const selectEl = document.getElementById('world-book-category-select');
    selectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.id;
      option.textContent = cat.name;
      if (book.categoryId === cat.id) option.selected = true;
      selectEl.appendChild(option);
    });


    const entriesContainer = document.getElementById('world-book-entries-container');
    entriesContainer.innerHTML = '';

    if (Array.isArray(book.content) && book.content.length > 0) {
      book.content.forEach(entry => {
        const block = createWorldBookEntryBlock(entry);
        entriesContainer.appendChild(block);
      });
    } else {
      entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">ËøòÊ≤°ÊúâÂÜÖÂÆπÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
    }


  }


  
  async function renderStickerPanel(rerenderTabs = true) {
    if (!state.userStickers) {
      console.warn("User stickers not loaded yet.");
      return;
    }
  window.renderStickerPanel = renderStickerPanel; // Expose global
    const grid = document.getElementById('sticker-grid');
    const tabsContainer = document.getElementById('sticker-category-tabs');
    const searchInput = document.getElementById('sticker-search-input');
    const searchTerm = searchInput.value.trim().toLowerCase();


    if (rerenderTabs) {
      tabsContainer.innerHTML = '';
      const categories = await db.stickerCategories.toArray();

      tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === 'all' ? 'active' : ''}" data-category-id="all">ÂÖ®ÈÉ®</button>`;
      categories.forEach(cat => {
        tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === cat.id ? 'active' : ''}" data-category-id="${cat.id}">${cat.name}</button>`;
      });
      tabsContainer.innerHTML += `<button class="sticker-category-tab ${activeStickerCategoryId === 'uncategorized' ? 'active' : ''}" data-category-id="uncategorized">Êú™ÂàÜÁ±ª</button>`;
    }


    grid.innerHTML = '';


    let stickersByCategory;
    if (activeStickerCategoryId === 'all') {
      stickersByCategory = state.userStickers;
    } else if (activeStickerCategoryId === 'uncategorized') {
      stickersByCategory = state.userStickers.filter(s => !s.categoryId);
    } else {
      stickersByCategory = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
    }


    const stickersToShow = searchTerm ?
      stickersByCategory.filter(sticker => sticker.name.toLowerCase().includes(searchTerm)) :
      stickersByCategory;


    if (stickersToShow.length === 0) {
      const message = searchTerm ? 'Êâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖ' : 'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâË°®ÊÉÖÂì¶~';
      grid.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1; padding-top: 20px;">${message}</p>`;
      return;
    }

    stickersToShow.forEach(sticker => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = sticker.name;
      item.dataset.stickerId = sticker.id;
      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${sticker.url})"></div>
            <span class="sticker-name">${sticker.name}</span>
        `;
      item.addEventListener('click', () => {
        if (isStickerManagementMode) {
          handleStickerSelection(item);
        } else {
          sendSticker(sticker);
        }
      });
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '&times;';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.userStickers.delete(sticker.id);
          state.userStickers = state.userStickers.filter(s => s.id !== sticker.id);
          renderStickerPanel();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }



  let isStickerManagementMode = false;
  let selectedStickers = new Set();
  let isPlaylistManagementMode = false;
  let selectedPlaylistItems = new Set();
  let isNaiGalleryManagementMode = false;
  let selectedNaiImages = new Set();
  let naiGalleryCache = { local: [], cloud: [] }; 
  let naiGalleryRenderCount = { local: 0, cloud: 0 }; 
  let isLoadingMoreNaiImages = { local: false, cloud: false };
  let activeNaiGalleryTab = 'local';
  const NAI_GALLERY_RENDER_WINDOW = 45; 
  
  function togglePlaylistManagementMode() {
    isPlaylistManagementMode = !isPlaylistManagementMode;
    const panel = document.getElementById('music-playlist-panel');
    const manageBtn = document.getElementById('manage-playlist-btn');
    const actionBar = document.getElementById('playlist-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-playlist-checkbox');

    panel.classList.toggle('management-mode', isPlaylistManagementMode);

    if (isPlaylistManagementMode) {
      manageBtn.textContent = translations[currentLanguage].done; // ‰ΩøÁî®ÁøªËØë
      manageBtn.setAttribute('data-lang-key', 'done');
      actionBar.style.display = 'flex';
      selectedPlaylistItems.clear();
      selectAllCheckbox.checked = false;
      updatePlaylistActionBar();
      // ÊòæÁ§∫Â§çÈÄâÊ°Ü
      panel.querySelectorAll('.playlist-item-checkbox').forEach(cb => cb.style.display = 'block');
    } else {
      manageBtn.textContent = translations[currentLanguage].manage; // ‰ΩøÁî®ÁøªËØë
      manageBtn.setAttribute('data-lang-key', 'manage');
      actionBar.style.display = 'none';
      // ÈöêËóèÂ§çÈÄâÊ°ÜÂπ∂ÂèñÊ∂àÈÄâ‰∏≠
      panel.querySelectorAll('.playlist-item').forEach(item => {
        item.classList.remove('selected');
        const cb = item.querySelector('.playlist-item-checkbox');
        if (cb) {
            cb.style.display = 'none';
            cb.checked = false;
        }
      });
    }
  }

  function handlePlaylistSelection(index) {
    if (!isPlaylistManagementMode) return;
    
    const item = document.querySelector(`.playlist-item[data-index="${index}"]`);
    if (!item) return;
    const checkbox = item.querySelector('.playlist-item-checkbox');

    // ÂàáÊç¢Áä∂ÊÄÅ
    const isSelected = selectedPlaylistItems.has(index);
    item.classList.toggle('selected', !isSelected);
    checkbox.checked = !isSelected;
    
    if (isSelected) {
      selectedPlaylistItems.delete(index);
    } else {
      selectedPlaylistItems.add(index);
    }
    updatePlaylistActionBar();
  }

  function updatePlaylistActionBar() {
    const btn = document.getElementById('upload-selected-to-catbox-btn');
    const count = selectedPlaylistItems.size;
    if (btn) btn.textContent = `‰∏ä‰º†Catbox (${count})`;
  }

  function handleSelectAllPlaylistItems() {
    const checkbox = document.getElementById('select-all-playlist-checkbox');
    const shouldSelect = checkbox.checked;
    
    document.querySelectorAll('.playlist-item').forEach(item => {
      const index = parseInt(item.dataset.index);
      if (isNaN(index)) return;

      item.classList.toggle('selected', shouldSelect);
      item.querySelector('.playlist-item-checkbox').checked = shouldSelect;

      if (shouldSelect) {
        selectedPlaylistItems.add(index);
      } else {
        selectedPlaylistItems.delete(index);
      }
    });
    updatePlaylistActionBar();
  }

  async function executeBatchUploadToCatbox() {
    // 1. Ê£ÄÊü• Catbox ÈÖçÁΩÆ
    if (!state.apiConfig.catboxEnable || !state.apiConfig.catboxUserHash) {
      await showCustomAlert("ÂäüËÉΩÊú™ÂºÄÂêØ", "ËØ∑ÂÖàÂú®‚ÄúAPIËÆæÁΩÆ‚Äù -> ‚ÄúCatbox.moe‚Äù‰∏≠ÂºÄÂêØÊ≠§ÂäüËÉΩÂπ∂Â°´ÂÜôÊÇ®ÁöÑ User Hash„ÄÇ");
      return;
    }

    if (selectedPlaylistItems.size === 0) {
      await showCustomAlert("Êú™ÈÄâÊã©", "ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊ≠åÊõ≤„ÄÇ");
      return;
    }

    // 2. ËøáÊª§ÊéâÂ∑≤ÁªèÊòØ Catbox ÈìæÊé•ÁöÑÊ≠åÊõ≤
    const indicesToUpload = Array.from(selectedPlaylistItems).filter(index => {
      const song = musicState.playlist[index];
      return song && song.src && !String(song.src).includes('catbox.moe');
    });

    if (indicesToUpload.length === 0) {
      await showCustomAlert("Êó†ÈúÄ‰∏ä‰º†", "ÊÇ®ÈÄâÊã©ÁöÑÊâÄÊúâÊ≠åÊõ≤ÂùáÂ∑≤Âú® Catbox ‰∏ä„ÄÇ");
      togglePlaylistManagementMode();
      return;
    }

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§‰∏ä‰º†Ôºü',
      `Âç≥Â∞Ü‰∏ä‰º† ${indicesToUpload.length} È¶ñÊ≠åÊõ≤Âà∞ Catbox.moe„ÄÇ\n\nËøô‰ºöËΩ¨Êç¢Êú¨Âú∞Èü≥‰πêÂíåÂ§ñÈÉ®ÈìæÊé•ÔºåÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥Âπ∂Ê∂àËÄóÊµÅÈáè„ÄÇ\nÔºàÂ∑≤Âú® Catbox ‰∏äÁöÑÊ≠åÊõ≤Â∞ÜË¢´Ëá™Âä®Ë∑≥ËøáÔºâ`,
      { confirmText: 'ÂºÄÂßã‰∏ä‰º†' }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂºÄÂßã‰∏ä‰º† ${indicesToUpload.length} È¶ñÊ≠åÊõ≤ÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢...`);

    let successCount = 0;
    let failCount = 0;
    const failedNames = [];

    const proxySettings = getNovelAISettings();
    let corsProxy = proxySettings.cors_proxy;
    if (corsProxy === 'custom') {
      corsProxy = proxySettings.custom_proxy_url || '';
    }
   

    for (const index of indicesToUpload) {
      const song = musicState.playlist[index];
      try {
        let fileToUpload;
        let songName = song.name || 'unknown_track.mp3';

        if (song.isLocal) {
          // 4a. Â§ÑÁêÜÊú¨Âú∞Ê≠åÊõ≤ (ArrayBuffer Êàñ Blob) - ËøôÈÉ®ÂàÜÈÄªËæëÊòØÊ≠£Á°ÆÁöÑ
          console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] Â§ÑÁêÜÊú¨Âú∞Ê≠åÊõ≤: ${song.name}`);
          fileToUpload = new Blob([song.src], { type: song.fileType || 'audio/mpeg' });
        } else {
          // 4b. Â§ÑÁêÜÁΩëÁªúÊ≠åÊõ≤ (ÈúÄË¶ÅCORS‰ª£ÁêÜ)
          console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] Â§ÑÁêÜÁΩëÁªúÊ≠åÊõ≤: ${song.name} from ${song.src}`);
          
          
          let fetchUrl = song.src;
          // Ê£ÄÊü•‰ª£ÁêÜÊòØÂê¶Â∑≤ÈÖçÁΩÆÔºåÂπ∂‰∏îÊ≠åÊõ≤Ê∫ê‰∏çÊòØ data: URI
          if (corsProxy && corsProxy !== '' && !fetchUrl.startsWith('data:')) {
            // „ÄêÈáçË¶Å„ÄëÂøÖÈ°ªÂØπÊ∫êURLËøõË°åÁºñÁ†ÅÔºå‰ª•Èò≤URL‰∏≠ÊúâÁâπÊÆäÂ≠óÁ¨¶
            fetchUrl = corsProxy + encodeURIComponent(song.src); 
            console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] ‰ΩøÁî®‰ª£ÁêÜ‰∏ãËΩΩ: ${fetchUrl}`);
          } else {
            console.log(`[Catbox ÊâπÈáè‰∏ä‰º†] ‰∏ç‰ΩøÁî®‰ª£ÁêÜÔºåÂ∞ùËØïÁõ¥Ëøû‰∏ãËΩΩ... (ËøôÂú®Safari‰∏ä‰ºöÂ§±Ë¥•)`);
          }
          
          const response = await fetch(fetchUrl); // <--- Áé∞Âú®Ëøô‰∏™ fetch ÊòØÂ∏¶‰ª£ÁêÜÁöÑ
          if (!response.ok) throw new Error(`‰∏ãËΩΩÊ≠åÊõ≤Â§±Ë¥•ÔºåÁä∂ÊÄÅ: ${response.status}`);
          fileToUpload = await response.blob();
        }

        // Á°Æ‰øùÊñá‰ª∂ÂêçÊúâÂêéÁºÄ
        if (!songName.match(/\.(mp3|wav|flac|m4a|ogg)$/i)) {
          songName += '.mp3';
        }

        // 5. Ë∞ÉÁî®Êàë‰ª¨‰πãÂâç‰øÆÂ§çËøáÁöÑ‰∏ä‰º†ÂáΩÊï∞
        // (uploadFileToCatbox ÂáΩÊï∞Âú® 1667 Ë°åÈôÑËøë)
        const newCatboxUrl = await uploadFileToCatbox(new File([fileToUpload], songName, { type: fileToUpload.type }));
        
        // 6. Êõ¥Êñ∞ musicState
        song.src = newCatboxUrl;
        song.isLocal = false;
        delete song.fileType; 
        successCount++;

      } catch (error) {
        console.error(`[Catbox ÊâπÈáè‰∏ä‰º†] ‰∏ä‰º†Â§±Ë¥•: ${song.name}`, error);
        failCount++;
        failedNames.push(song.name);
      }
    }

    // 7. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    await saveGlobalPlaylist();

    // 8. ÊòæÁ§∫ÊÄªÁªìÊä•Âëä
    let summary = `‰∏ä‰º†ÂÆåÊàêÔºÅ\n\nÊàêÂäü: ${successCount} È¶ñ`;
    if (failCount > 0) {
      summary += `\nÂ§±Ë¥•: ${failCount} È¶ñ\n(${failedNames.join(', ')})`;
    }
    await showCustomAlert("Êìç‰ΩúÂÆåÊàê", summary);

    // 9. ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°ÂºèÂπ∂Âà∑Êñ∞UI
    togglePlaylistManagementMode();
    updatePlaylistUI();
  }

  function toggleStickerManagementMode() {
    isStickerManagementMode = !isStickerManagementMode;
    const grid = document.getElementById('sticker-grid');
    const manageBtn = document.getElementById('manage-stickers-btn');
    const actionBar = document.getElementById('sticker-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');

    grid.classList.toggle('management-mode', isStickerManagementMode);

    if (isStickerManagementMode) {
      manageBtn.textContent = 'ÂÆåÊàê';
      actionBar.style.display = 'flex';
      selectedStickers.clear();
      selectAllCheckbox.checked = false;
      updateDeleteStickerButton();
    } else {
      manageBtn.textContent = 'ÁÆ°ÁêÜ';
      actionBar.style.display = 'none';
      grid.querySelectorAll('.sticker-item.selected').forEach(item => item.classList.remove('selected'));
    }
  }



  function handleSelectAllStickers() {
    const checkbox = document.getElementById('select-all-stickers-checkbox');
    const shouldSelect = checkbox.checked;


    let stickersToSelect;
    if (activeStickerCategoryId === 'all') {
      stickersToSelect = state.userStickers;
    } else if (activeStickerCategoryId === 'uncategorized') {
      stickersToSelect = state.userStickers.filter(s => !s.categoryId);
    } else {
      stickersToSelect = state.userStickers.filter(s => s.categoryId === activeStickerCategoryId);
    }


    stickersToSelect.forEach(sticker => {
      const stickerId = sticker.id;
      const itemEl = document.querySelector(`.sticker-item[data-sticker-id="${stickerId}"]`);

      if (shouldSelect) {

        selectedStickers.add(stickerId);
        if (itemEl) itemEl.classList.add('selected');
      } else {

        selectedStickers.delete(stickerId);
        if (itemEl) itemEl.classList.remove('selected');
      }
    });


    updateDeleteStickerButton();
  }


  function updateDeleteStickerButton() {
    const count = selectedStickers.size;
    const delBtn = document.getElementById('delete-selected-stickers-btn');
    const exportBtn = document.getElementById('export-selected-stickers-btn');
    const moveBtn = document.getElementById('move-selected-stickers-btn'); // Êñ∞Â¢û

    if (delBtn) delBtn.textContent = `Âà†Èô§ (${count})`;
    if (exportBtn) exportBtn.textContent = `ÂØºÂá∫ (${count})`;
    if (moveBtn) moveBtn.textContent = `ÁßªÂä® (${count})`; // Êñ∞Â¢û
}
async function executeBatchMoveStickers() {
    if (selectedStickers.size === 0) {
        alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁßªÂä®ÁöÑË°®ÊÉÖ„ÄÇ");
        return;
    }

    // 1. Ëé∑ÂèñÊâÄÊúâÂàÜÁ±ª
    const categories = await db.stickerCategories.toArray();
    const options = [
        { text: 'Êú™ÂàÜÁ±ª', value: 'uncategorized' },
        ...categories.map(c => ({ text: c.name, value: c.id }))
    ];

    // 2. ÂºπÂá∫ÈÄâÊã©Ê°Ü
    const targetCategoryId = await showChoiceModal("ÁßªÂä®Âà∞ÂàÜÁ±ª", options);
    if (!targetCategoryId) return;

    // 3. Â§ÑÁêÜÁõÆÊ†áID (Êú™ÂàÜÁ±ªÂ≠ò‰∏∫ null)
    const finalCategoryId = targetCategoryId === 'uncategorized' ? null : parseInt(targetCategoryId);

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÁßªÂä®Ë°®ÊÉÖ...");

    // 4. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
    const idsToMove = Array.from(selectedStickers);
    await db.transaction('rw', db.userStickers, async () => {
        for (const id of idsToMove) {
            await db.userStickers.update(id, { categoryId: finalCategoryId });
            // Êõ¥Êñ∞ÂÜÖÂ≠ò
            const s = state.userStickers.find(item => item.id === id);
            if (s) s.categoryId = finalCategoryId;
        }
    });

    // 5. Âà∑Êñ∞ÁïåÈù¢
    toggleStickerManagementMode(); // ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    await renderStickerPanel(); // Âà∑Êñ∞ÂàóË°® (Ëøô‰ºöÊ†πÊçÆÂΩìÂâçÈÄâ‰∏≠ÁöÑTabÂà∑Êñ∞ÔºåÁßªÂä®Ëµ∞ÁöÑË°®ÊÉÖ‰ºöÊ∂àÂ§±)
    
    await showCustomAlert("ÊàêÂäü", `Â∑≤Â∞Ü ${idsToMove.length} ‰∏™Ë°®ÊÉÖÁßªÂä®Âà∞Êñ∞ÂàÜÁ±ª„ÄÇ`);
}
  /**
   * Â§ÑÁêÜÁî®Êà∑ÁÇπÂáªÈÄâÊã©ÊàñÂèñÊ∂àÈÄâÊã©Ë°®ÊÉÖ
   * @param {HTMLElement} item - Ë¢´ÁÇπÂáªÁöÑË°®ÊÉÖDOMÂÖÉÁ¥†
   */
  function handleStickerSelection(item) {
    if (!isStickerManagementMode) return;

    const stickerId = item.dataset.stickerId;
    if (!stickerId) return;

    item.classList.toggle('selected');

    if (selectedStickers.has(stickerId)) {
      selectedStickers.delete(stickerId);
    } else {
      selectedStickers.add(stickerId);
    }
    updateDeleteStickerButton();
  }


  async function executeBatchDeleteStickers() {
    if (selectedStickers.size === 0) return;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedStickers.size} ‰∏™Ë°®ÊÉÖÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`, {
        confirmButtonClass: 'btn-danger'
      }
    );

    if (confirmed) {
      const idsToDelete = [...selectedStickers];


      await db.userStickers.bulkDelete(idsToDelete);


      state.userStickers = state.userStickers.filter(s => !idsToDelete.includes(s.id));


      toggleStickerManagementMode();
      renderStickerPanel();

      await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
    }
  }

async function executeBatchExportStickers() {
    if (selectedStickers.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑË°®ÊÉÖÂåÖ„ÄÇ");
      return;
    }

    let exportText = "";
    let exportedCount = 0;

    
    state.userStickers.forEach(sticker => {
      if (selectedStickers.has(sticker.id)) {
       
        exportText += `${sticker.name}: ${sticker.url}\n`;
        exportedCount++;
      }
    });

    if (exportedCount === 0) {
      alert("Êú™ÊâæÂà∞ÊâÄÈÄâË°®ÊÉÖÁöÑÊï∞ÊçÆ„ÄÇ");
      return;
    }

    const finalText = exportText.trim();
    const textareaId = 'batch-export-textarea-' + Date.now();
    
  
    const alertHtml = `
        <p style="text-align:left; font-size: 14px; margin: 0 0 10px 0;">
            Â∑≤‰∏∫ÊÇ®ÁîüÊàê ${exportedCount} Êù°Âø´Êç∑ÂØºÂÖ•Ê†ºÂºèÁöÑÊñáÊú¨Ôºö
        </p>
        <textarea id="${textareaId}" 
                  rows="10" 
                  style="width: 100%; font-size: 12px; resize: vertical; border-radius: 6px; border: 1px solid #ccc;"
                  readonly>${finalText}</textarea>
    `;

   
    showCustomAlert("Â§çÂà∂Ë°®ÊÉÖÂåÖÊï∞ÊçÆ", alertHtml);
  
    const modalConfirmBtn = document.getElementById('custom-modal-confirm');
    
    if (modalConfirmBtn) {
        
        
        modalConfirmBtn.textContent = '‰∏ÄÈîÆÂ§çÂà∂';
        
        
        const originalOnclick = modalConfirmBtn.onclick;

       
        modalConfirmBtn.onclick = async (e) => {
            try {
                
                await navigator.clipboard.writeText(finalText);
                modalConfirmBtn.textContent = 'Â§çÂà∂ÊàêÂäü!';
                
               
                setTimeout(() => {
                   modalConfirmBtn.textContent = 'ÂÆåÊàê';
                   modalConfirmBtn.onclick = originalOnclick; 
                }, 1500);
                
            } catch (err) {
               
                alert('Ëá™Âä®Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈïøÊåâÊñáÊú¨Ê°ÜÊâãÂä®Â§çÂà∂„ÄÇ');
                
                modalConfirmBtn.textContent = 'ÂÆåÊàê';
                modalConfirmBtn.onclick = originalOnclick;
            }
        };
    }
  }


 
  async function openBatchStickerImportModal() {
    // 1. ËÆ©Áî®Êà∑ÈÄâÊã©ÂØºÂÖ•ÊñπÂºè
    const choice = await showChoiceModal('ÊâπÈáèÂØºÂÖ•Ë°®ÊÉÖ', [
        { text: 'üìã Á≤òË¥¥ÊñáÊú¨', value: 'paste' },
        { text: 'üìÅ ‰∏ä‰º†Êñá‰ª∂ (.txt/.json/.docx)', value: 'file' }
    ]);

    if (choice === 'paste') {
        // --- ÊñπÂºè A: Á≤òË¥¥ÊñáÊú¨ (‰øùÊåÅÂéüÊúâÈÄªËæë) ---
        const placeholderText = `ËØ∑ËæìÂÖ•Ë°®ÊÉÖÊï∞ÊçÆÔºå‰∏ÄË°å‰∏Ä‰∏™„ÄÇ
„ÄêËßÑÂàô„ÄëÔºöÂåÖÂê´„ÄêÂêçÂ≠ó„ÄëÂíå„ÄêÈìæÊé•„Äë„ÄÇ
„ÄêÁ§∫‰æã„ÄëÔºö
ÂºÄÂøÉ: https://xx.com/1.jpg
Âì≠Ê≥£Ôºöhttps://xx.com/2.png
ÁîüÊ∞îhttps://xx.com/3.gif
https://xx.com/4.jpg ÁñëÊÉë`;

        const pastedText = await showCustomPrompt(
          'ÊâπÈáèÂØºÂÖ•Ë°®ÊÉÖ',
          placeholderText,
          '',
          'textarea'
        );

        if (pastedText && pastedText.trim()) {
          await handleBatchStickerImport(pastedText);
        }

    } else if (choice === 'file') {
        // --- ÊñπÂºè B: ‰∏ä‰º†Êñá‰ª∂ ---
        await handleStickerFileImport();
    }
  }


  
  async function handleBatchStickerImport(text) {
    const lines = text.trim().split('\n');
    const newStickers = [];
    const baseUrl = 'https://files.catbox.moe/';
    let errorCount = 0;
    let skippedPureLinks = 0; // ÁªüËÆ°Ë¢´Ë∑≥ËøáÁöÑÁ∫ØÈìæÊé•
    const currentCategoryId = (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null;

    // 1. ÊèêÂèñURLÁöÑÊ≠£Âàô (ÊîØÊåÅ http/https Âíå data:image)
    const urlRegex = /(https?:\/\/[^\s]+|data:image\/[^\s]+)/;

    for (const line of lines) {
      const trimmedLine = line.trim();

      // Ë∑≥ËøáÁ©∫Ë°åÊàñÂåÖÂê´ÊèêÁ§∫ËØ≠ÁöÑË°å
      if (!trimmedLine || trimmedLine.includes('Â°´ÂÖ•') || trimmedLine.includes('Ê†ºÂºè')) {
        continue;
      }

      // --- Á¨¨‰∏ÄÊ≠•ÔºöÂØªÊâæÈìæÊé• ---
      const urlMatch = trimmedLine.match(urlRegex);
      
      // 2. Â¶ÇÊûúÊ≤°ÊâæÂà∞Ê†áÂáÜÈìæÊé•ÔºåÂ∞ùËØïÂÖºÂÆπÊóßÁâà Catbox Áü≠Á†Å (ÂêçÂ≠ó code.png)
      if (!urlMatch) {
         // Â∞ùËØïÂåπÈÖç: ‰ªªÊÑèÊñáÂ≠ó + Á©∫Ê†º + (Â≠óÊØçÊï∞Â≠ó.ÂêéÁºÄ)
         const catboxMatch = trimmedLine.match(/^(.+?)\s+([a-zA-Z0-9]+\.[a-zA-Z0-9]+)$/);
         if (catboxMatch) {
             newStickers.push({
                id: 'sticker_' + Date.now() + Math.random(),
                name: catboxMatch[1].trim(),
                url: baseUrl + catboxMatch[2].trim(),
                categoryId: currentCategoryId
             });
         } else {
             errorCount++;
             console.warn('Êó†Ê≥ïËØÜÂà´Ë°å:', trimmedLine);
         }
         continue; 
      }

      // --- Á¨¨‰∫åÊ≠•ÔºöÊèêÂèñÂπ∂Ê∏ÖÊ¥óÊï∞ÊçÆ ---
      const url = urlMatch[0];
      
      // ‰ªéÊï¥Ë°å‰∏≠ÊääÈìæÊé•Âà†ÊéâÔºåÂâ©‰∏ãÁöÑÂ∞±ÊòØÂêçÂ≠ó
      // ‰æãÂ¶Ç "ÂºÄÂøÉ:http://..." -> Ââ©‰∏ã "ÂºÄÂøÉ:" (Ëã±ÊñáÂÜíÂè∑)
      // ‰æãÂ¶Ç "ÂºÄÂøÉÔºöhttp://..." -> Ââ©‰∏ã "ÂºÄÂøÉÔºö" (‰∏≠ÊñáÂÜíÂè∑)
      let rawName = trimmedLine.replace(url, '').trim();

      // --- Á¨¨‰∏âÊ≠•ÔºöÊô∫ËÉΩÊ∏ÖÊ¥óÂêçÂ≠ó (Ê†∏ÂøÉ‰øÆÊîπ) ---
      // Ê≠£ÂàôËß£ÈáäÔºö
      // ^[\s:Ôºö,Ôºå]+  -> ÂéªÊéâÂºÄÂ§¥ÁöÑÊâÄÊúâ Á©∫Ê†º„ÄÅËã±ÊñáÂÜíÂè∑„ÄÅ‰∏≠ÊñáÂÜíÂè∑„ÄÅÈÄóÂè∑
      // |             -> ÊàñËÄÖ
      // [\s:Ôºö,Ôºå]+$  -> ÂéªÊéâÁªìÂ∞æÁöÑÊâÄÊúâ Á©∫Ê†º„ÄÅËã±ÊñáÂÜíÂè∑„ÄÅ‰∏≠ÊñáÂÜíÂè∑„ÄÅÈÄóÂè∑
      let cleanName = rawName.replace(/^[\s:Ôºö,Ôºå]+|[\s:Ôºö,Ôºå]+$/g, '');

      // --- Á¨¨ÂõõÊ≠•Ôºö‰∏•Ê†ºÊ†°È™å (Á¶ÅÊ≠¢Á∫ØÈìæÊé•) ---
      // Â¶ÇÊûúÊ∏ÖÊ¥óÂêéÂêçÂ≠ó‰∏∫Á©∫ÔºåËØ¥ÊòéËøô‰∏ÄË°åÂè™ÊúâÈìæÊé•
      if (!cleanName) {
          skippedPureLinks++;
          console.warn('Ë∑≥ËøáÁ∫ØÈìæÊé• (Êú™Êèê‰æõÂêçÂ≠ó):', trimmedLine);
          continue;
      }

      // Ê∑ªÂä†Âà∞ÂàóË°®
      newStickers.push({
        id: 'sticker_' + Date.now() + Math.random(),
        name: cleanName,
        url: url,
        categoryId: currentCategoryId
      });
    }

    // --- Á¨¨‰∫îÊ≠•ÔºöÁªìÊûúÂèçÈ¶à ---
    let resultMsg = '';
    
    if (newStickers.length > 0) {
      await db.userStickers.bulkAdd(newStickers);
      state.userStickers.push(...newStickers);
      renderStickerPanel();
      resultMsg = `ÊàêÂäüÂØºÂÖ• ${newStickers.length} ‰∏™Êñ∞Ë°®ÊÉÖÔºÅ`;
    }

    if (skippedPureLinks > 0) {
        resultMsg += `\n‚ö†Ô∏è Êúâ ${skippedPureLinks} Ë°åÂõ†Âè™ÊúâÈìæÊé•(Êó†ÂêçÂ≠ó)Ë¢´Ë∑≥Ëøá„ÄÇ`;
    }

    if (errorCount > 0) {
        resultMsg += `\n‚ùå Êúâ ${errorCount} Ë°åÊ†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇ`;
    }

    if (resultMsg) {
        await showCustomAlert('ÂØºÂÖ•ÁªìÊûú', resultMsg);
    } else if (lines.length > 0) {
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', 'Êú™ËÉΩËØÜÂà´‰ªª‰ΩïÊúâÊïàÊï∞ÊçÆÔºåËØ∑Á°Æ‰øùÊØèË°åÈÉΩÂåÖÂê´„ÄêÂêçÂ≠ó„ÄëÂíå„ÄêÈìæÊé•„Äë„ÄÇ');
    }
  }
// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
  function handleStickerFileImport() {
    return new Promise(resolve => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt,.json,.docx'; // ÈôêÂà∂Êñá‰ª∂Á±ªÂûã
      
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) {
            resolve();
            return;
        }

        try {
            await showCustomAlert("Ê≠£Âú®Ëß£Êûê...", "Ê≠£Âú®ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπÔºåËØ∑Á®çÂÄô...");
            const textContent = await processStickerFile(file);
            
            if (textContent && textContent.trim()) {
                // Ëß£ÊûêÊàêÂäüÂêéÔºåÁõ¥Êé•Â§çÁî®‰πãÂâçÁöÑÊñáÊú¨Ëß£ÊûêÈÄªËæë
                // ËøôÊ†∑Êó†ËÆ∫ÊòØÊñá‰ª∂ËøòÊòØÁ≤òË¥¥ÔºåÈÉΩÊîØÊåÅÈÇ£ÁßçÁÅµÊ¥ªÁöÑÊ†ºÂºèÔºà‰∏≠ÊñáÂÜíÂè∑„ÄÅÊó†Á©∫Ê†ºÁ≠âÔºâ
                await handleBatchStickerImport(textContent);
            } else {
                alert("Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊó†Ê≥ïËß£Êûê„ÄÇ");
            }
        } catch (error) {
            console.error("Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•:", error);
            alert(`Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
        }
        resolve();
      };
      
      input.click();
    });
  }

  // Ê†∏ÂøÉÔºöÊ†πÊçÆÂêéÁºÄÂêçËß£ÊûêÊñá‰ª∂ÂÜÖÂÆπ
  async function processStickerFile(file) {
      const fileName = file.name.toLowerCase();

      // 1. Â§ÑÁêÜ .txt Êñá‰ª∂
      if (fileName.endsWith('.txt')) {
          return await file.text();
      }

      // 2. Â§ÑÁêÜ .docx Êñá‰ª∂ (‰æùËµñ mammoth.js)
      if (fileName.endsWith('.docx')) {
          if (typeof mammoth === 'undefined') {
              throw new Error("Êú™Âä†ËΩΩ mammoth.js Â∫ìÔºåÊó†Ê≥ïËØªÂèñ Word ÊñáÊ°£„ÄÇ");
          }
          const arrayBuffer = await file.arrayBuffer();
          const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
          return result.value; // ËøîÂõû Word ‰∏≠ÁöÑÁ∫ØÊñáÊú¨
      }

      // 3. Â§ÑÁêÜ .json Êñá‰ª∂
      if (fileName.endsWith('.json')) {
          const text = await file.text();
          let json;
          try {
              json = JSON.parse(text);
          } catch (e) {
              throw new Error("JSON Ê†ºÂºèÈîôËØØ");
          }

          // Â∞Ü JSON ËΩ¨Êç¢‰∏∫ "ÂêçÂ≠ó: ÈìæÊé•" ÁöÑÊñáÊú¨Ê†ºÂºèÔºå‰ª•‰æøÂ§çÁî® handleBatchStickerImport
          let convertedText = "";

          if (Array.isArray(json)) {
              // ÊÉÖÂÜµ A: Êï∞ÁªÑÊ†ºÂºè [{name: "ÂºÄÂøÉ", url: "http..."}, ...]
              json.forEach(item => {
                  // Â∞ùËØïÂ§öÁßçÂèØËÉΩÁöÑÈîÆÂêç
                  const name = item.name || item.key || item.title || item.meaning;
                  const url = item.url || item.src || item.content || item.link;
                  if (name && url) {
                      convertedText += `${name}: ${url}\n`;
                  }
              });
          } else if (typeof json === 'object') {
              // ÊÉÖÂÜµ B: ÂØπË±°Ê†ºÂºè {"ÂºÄÂøÉ": "http...", "Âì≠Ê≥£": "http..."}
              // ÊàñËÄÖ Tavern Ê†ºÂºè {"entries": ...}
              if (json.entries) {
                   // ÁÆÄÂçïÁöÑÂÖºÂÆπ Tavern Ê†ºÂºè
                   const entries = Array.isArray(json.entries) ? json.entries : Object.values(json.entries);
                   entries.forEach(item => {
                       const name = item.comment || item.key?.toString() || "Ë°®ÊÉÖ";
                       const url = item.content || item.url;
                       if (url && url.startsWith('http')) {
                           convertedText += `${name}: ${url}\n`;
                       }
                   });
              } else {
                  // ÊôÆÈÄö Key-Value ÂØπ
                  for (let key in json) {
                      const val = json[key];
                      if (typeof val === 'string' && (val.startsWith('http') || val.startsWith('data:image'))) {
                          convertedText += `${key}: ${val}\n`;
                      }
                  }
              }
          }
          return convertedText;
      }

      throw new Error("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè");
  }

  function scrollToOriginalMessage(originalTimestamp) {
    const selector = `.message-bubble[data-timestamp="${originalTimestamp}"]`;
    const originalMessageBubble = document.querySelector(selector);

    if (originalMessageBubble) {
      originalMessageBubble.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });

      originalMessageBubble.classList.add('highlighted');
      setTimeout(() => {
        if (document.body.contains(originalMessageBubble)) {
          originalMessageBubble.classList.remove('highlighted');
        }
      }, 1500);

    } else {

      alert("Êâæ‰∏çÂà∞ÂéüÂßãÊ∂àÊÅØ„ÄÇÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§Êàñ‰Ωç‰∫éÊõ¥Êó©ÁöÑÂéÜÂè≤ËÆ∞ÂΩï‰∏≠„ÄÇ");
    }
  }
  async function createMessageElement(msg, chat) {


    if (msg.type === 'recalled_message') {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper system-pat';
      wrapper.dataset.timestamp = msg.timestamp;
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble recalled-message-placeholder';
      bubble.dataset.timestamp = msg.timestamp;
      bubble.textContent = msg.content;
      wrapper.appendChild(bubble);
      addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
      wrapper.addEventListener('click', () => {
        if (isSelectionMode) {
          toggleMessageSelection(msg.timestamp);
        }
      });
      return wrapper;
    } else if (msg.type === 'post_deleted_notice') {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper system-pat';
      wrapper.dataset.timestamp = msg.timestamp;
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble post-deleted-placeholder';
      bubble.dataset.postId = msg.postId;
      bubble.textContent = msg.content;
      wrapper.appendChild(bubble);
      addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
      wrapper.addEventListener('click', () => {
        if (isSelectionMode) {
          toggleMessageSelection(msg.timestamp);
        }
      });
      return wrapper;
    }

    if (msg.isHidden && !chat.settings.showHiddenMessages) {
      return null;
    }
    if (msg.type === 'narration') {
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper system-pat'; // Â§çÁî®Á≥ªÁªüÊ∂àÊÅØÊ†∑Âºè(Â±Ö‰∏≠ÁÅ∞Ëâ≤)
    wrapper.dataset.timestamp = msg.timestamp; // ÂÖ≥ÈîÆÔºöÂøÖÈ°ªÊúâÊó∂Èó¥Êà≥ÊâçËÉΩÁºñËæë/Âà†Èô§
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble system-bubble';
    // ÂèØ‰ª•Âä†‰∏™ÂõæÊ†áËÆ©ÂÆÉÂíåÊôÆÈÄöÊãç‰∏ÄÊãçÂå∫ÂàÜÂºÄÔºå‰πüÂèØ‰ª•‰∏çÂä†
    bubble.innerHTML = `<span style="font-style:italic; opacity: 0.9;">${msg.content}</span>`; 
    bubble.dataset.timestamp = msg.timestamp;
    
    wrapper.appendChild(bubble);
    
    // „ÄêÂÖ≥ÈîÆ„ÄëÊ∑ªÂä†ÈïøÊåâÁõëÂê¨ÔºåÂÆûÁé∞Âà†Èô§/ÁºñËæëÂäüËÉΩ
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    
    // ÊîØÊåÅÂ§öÈÄâ
    wrapper.addEventListener('click', () => {
        if (isSelectionMode) toggleMessageSelection(msg.timestamp);
    });
    
    return wrapper;
}
    if (msg.type === 'pat_message') {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper system-pat';
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble system-bubble';
      bubble.dataset.timestamp = msg.timestamp;
      bubble.textContent = msg.content;
      wrapper.appendChild(bubble);
      addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
      wrapper.addEventListener('click', () => {
        if (isSelectionMode) toggleMessageSelection(msg.timestamp);
      });
      return wrapper;
    }


    const isUser = msg.role === 'user';
    const myNickname = chat.settings.myNickname || 'Êàë';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
    if (msg.isHidden) {
        wrapper.classList.add('hidden-revealed');
    }
    if (chat.isGroup && !isUser) {
      const member = chat.members.find(m => m.originalName === msg.senderName);
      const senderNameDiv = document.createElement('div');
      senderNameDiv.className = 'sender-name';
      senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || 'Êú™Áü•ÊàêÂëò');
      wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    let avatarSrc, avatarFrameSrc = '';
    if (isUser) {
      avatarSrc = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
      avatarFrameSrc = chat.settings.myAvatarFrame || '';
    } else {
      if (chat.isGroup) {
        const member = chat.members.find(m => m.originalName === msg.senderName);
        if (member) {
          const characterProfile = state.chats[member.id];
          avatarSrc = member.avatar || (characterProfile ? characterProfile.settings.aiAvatar : defaultGroupMemberAvatar);
          avatarFrameSrc = member.avatarFrame || (characterProfile ? characterProfile.settings.aiAvatarFrame : '');
        } else {
          avatarSrc = defaultGroupMemberAvatar;
          avatarFrameSrc = '';
        }
      } else {
        avatarSrc = chat.settings.aiAvatar || defaultAvatar;
        avatarFrameSrc = chat.settings.aiAvatarFrame || '';
      }
    }

    let avatarHtml;
    if (avatarFrameSrc) {
      avatarHtml = `<div class="avatar-with-frame"><img src="${avatarSrc}" class="avatar-img"><img src="${avatarFrameSrc}" class="avatar-frame"></div>`;
    } else {
      avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }
    const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
    const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

    let contentHtml;
    let quoteHtml = '';
    if (msg.quote) {
      const quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
      const fullQuotedContent = String(msg.quote.content || '');
      quoteHtml = `
                    <div class="quoted-message" data-original-timestamp="${msg.quote.timestamp}" style="cursor: pointer;">
                        <div class="quoted-sender">ÂõûÂ§ç ${quotedSenderDisplayName}:</div>
                        <div class="quoted-content">${fullQuotedContent}</div>
                    </div>
                `;
    }





    let rawContent = msg.content;

    if (typeof rawContent === 'string' && rawContent.trim().startsWith('<') && rawContent.trim().endsWith('>')) {
      contentHtml = rawContent;
      bubble.classList.add('is-raw-html');
    } else if (msg.type === 'offline_text' || msg.type === 'share_link' || msg.type === 'share_card' || msg.type === 'location_share' || msg.type === 'ai_image' || msg.type === 'user_photo' || msg.type === 'voice_message' || msg.type === 'transfer' || msg.type === 'waimai_request' || msg.type === 'waimai_order' || msg.type === 'red_packet' || msg.type === 'poll' || msg.type === 'gift' || msg.type === 'realimag' || msg.type === 'naiimag' || msg.type === 'kinship_request' || msg.type === 'forwarded_email' || msg.type === 'reddit_share') {

      if (msg.type === 'offline_text') {

        const combinedText = msg.content || `${msg.dialogue || ''} ${msg.description || ''}`.trim();


        const regex = /(„Äå.*?„Äç|‚Äú.*?‚Äù)/g;
        const parts = combinedText.split(regex).filter(part => part);


        contentHtml = parts.map(part => {

          if (part.startsWith('„Äå') || part.startsWith('‚Äú')) {
            return `<span class="offline-dialogue">${parseMarkdown(part)}</span>`;
          } else {

            return `<span class="offline-description">${parseMarkdown(part.trim()).replace(/\n/g, '<br>')}</span>`;
          }
        }).join('');
      } else if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share', 'is-card-like');
        contentHtml = `<div class="link-share-card" data-timestamp="${msg.timestamp}"><div class="title">${msg.title || 'Êó†Ê†áÈ¢ò'}</div><div class="description">${msg.description || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ...'}</div><div class="footer"><svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg><span>${msg.source_name || 'ÈìæÊé•ÂàÜ‰∫´'}</span></div></div>`;
      }else if (msg.type === 'forwarded_email') {
        bubble.classList.add('is-card-like'); // ÂéªÈô§Ê∞îÊ≥°ÈªòËÆ§ËÉåÊôØ
        const data = msg.emailData || {};
        
        // Â∞ÜÂÆåÊï¥Êï∞ÊçÆÂ≠òÂÖ• datasetÔºå‰ª•‰æøÁÇπÂáªÊó∂ËØªÂèñ
        const fullDataJson = encodeURIComponent(JSON.stringify(data));

        contentHtml = `
            <div class="email-share-card" data-email-json="${fullDataJson}">
                <div class="email-card-top">
                    <div class="email-icon-box">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <div class="email-card-header-text">
                        <div class="email-card-subject">${escapeHTML(data.subject)}</div>
                        <div class="email-card-sender">${escapeHTML(data.sender)}</div>
                    </div>
                </div>
                <div class="email-card-preview">${escapeHTML(data.preview)}...</div>
                <div class="email-card-footer">
                    <span>Mail ÈÇÆ‰ª∂Âø´ÁÖß</span>
                    <span>Êü•ÁúãËØ¶ÊÉÖ ‚Ä∫</span>
                </div>
            </div>
        `;
    } else if (msg.type === 'reddit_share') {
        bubble.classList.add('is-card-like', 'is-reddit-card'); // Á°Æ‰øùÊ∑ªÂä†Ëøô‰∫õÁ±ªÂêç
        const data = msg.redditData;
        
        // Â§ÑÁêÜÂàÜÊï∞ÁöÑÊòæÁ§∫ (12.5k)
        const scoreDisplay = data.score > 1000 ? (data.score/1000).toFixed(1) + 'k' : data.score;
        
        contentHtml = `
    <div class="reddit-share-card">
        <div class="reddit-card-header">
                    <img src="https://www.redditinc.com/assets/images/site/reddit-logo.png" class="reddit-card-logo">
                    <span class="reddit-card-sub">${data.subreddit}</span>
                    <span class="reddit-card-user">‚Ä¢ u/${data.author}</span>
                </div>
                <div class="reddit-card-body">
                    <div class="reddit-card-title">${escapeHTML(data.title)}</div>
                    ${data.image ? `<img src="${data.image}" class="reddit-card-img" loading="lazy">` : ''}
                    ${data.selftext ? `<div style="font-size:12px;color:#555;max-height:60px;overflow:hidden;">${escapeHTML(data.selftext)}</div>` : ''}
                </div>
                <div class="reddit-card-footer">
                    <span>‚¨Ü ${scoreDisplay} Ëµû</span>
                    <span>üí¨ ${data.num_comments} ËØÑËÆ∫</span>
                </div>
            </div>
        `;
    }else if (msg.type === 'share_card') {
        bubble.classList.add('is-link-share', 'is-card-like');
        contentHtml = `<div class="link-share-card" style="cursor: pointer;" data-timestamp="${msg.timestamp}"><div class="title">${msg.payload.title}</div><div class="description">ÂÖ± ${msg.payload.sharedHistory.length} Êù°Ê∂àÊÅØ</div><div class="footer"><svg class="footer-icon" ...>...</svg><span>ËÅäÂ§©ËÆ∞ÂΩï</span></div></div>`;
      } else if (msg.type === 'location_share') {
        bubble.classList.add('is-location-share', 'is-card-like');
        let finalImageUrl;


        if (msg.imageUrl) {
          finalImageUrl = msg.imageUrl;
        } else if (state.globalSettings.enableAiDrawing && msg.image_prompt) {
          finalImageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(msg.image_prompt)}`;
        } else {
          finalImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg';
        }

        const mapAreaStyle = `style="background-image: url('${finalImageUrl}');"`;
        contentHtml = `<div class="location-share-card"><div class="card-text-area"><div class="card-text-primary">${msg.content}</div><div class="card-text-secondary">‰ΩçÁΩÆÂàÜ‰∫´</div></div><div class="card-map-area" ${mapAreaStyle}><div class="card-pin-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 11.5C11.1716 11.5 10.5 10.8284 10.5 10C10.5 9.17157 11.1716 8.5 12 8.5C12.8284 8.5 13.5 9.17157 13.5 10C13.5 10.8284 12.8284 11.5 12 11.5Z"></path><path d="M12 2C7.92134 2 4.5 5.42134 4.5 9.5C4.5 14.5312 11.2188 21.4375 11.5938 21.8125C11.7954 22.014 12.2046 22.014 12.4062 21.8125C12.7812 21.4375 19.5 14.5312 19.5 9.5C19.5 5.42134 16.0787 2 12 2ZM12 12.5C10.6193 12.5 9.5 11.3807 9.5 10C9.5 8.61929 10.6193 7.5 12 7.5C13.3807 7.5 14.5 8.61929 14.5 10C14.5 11.3807 13.3807 12.5 12 12.5Z"></path></svg></div></div></div>`;
      } else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image', 'is-card-like');
        const altText = msg.type === 'user_photo' ? "Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâá" : "AIÁîüÊàêÁöÑÂõæÁâá";


        const imageUrl = state.globalSettings.enableAiDrawing && msg.image_prompt ?
          `https://image.pollinations.ai/prompt/${msg.image_prompt}` :
          'https://i.postimg.cc/KYr2qRCK/1.jpg';


        contentHtml = `<img src="${imageUrl}" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
      } else if (msg.type === 'naiimag') {
        
        bubble.classList.add('is-realimag', 'is-card-like');
        contentHtml = `
                        <div class="nai-image-wrapper">
                            <img src="${msg.imageUrl}" class="realimag-image" alt="NovelAIÂõæÁâáÂàÜ‰∫´" loading="lazy" onerror="this.src='https://i.postimg.cc/KYr2qRCK/1.jpg'; this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';" title="${msg.fullPrompt || msg.prompt || 'NovelAIÁîüÊàê'}">
                            
                            <div class="bubble-image-controls"> 
                                <button class="nai-save-local-btn" title="‰∏ãËΩΩÂõæÁâá">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </button>
                                <button class="nai-upload-imgbb-btn" title="‰∏ä‰º†ÂõæÂ∫ä" style="display: none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line>
                                    </svg>
                                </button>
                                <button class="nai-regenerate-btn" title="ÈáçÊñ∞ÁîüÊàê">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                </button>
                                
                                
                            </div>
                        </div>
                    `;
      } else if (msg.type === 'voice_message') {
        bubble.classList.add('is-voice-message', 'is-card-like');
        const duration = Math.max(1, Math.round((msg.content || '').length / 5));
        const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
        const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';

        if (isUser) {

          contentHtml = `
            <div class="voice-message-body" data-text="${encodeURIComponent(msg.content)}">
                <div class="voice-waveform">${waveformHTML}</div>
                <span class="voice-duration">${durationFormatted}</span>
            </div>
            <div class="voice-transcript"></div>
        `;
        } else {



          const canPlayTTS = !chat.isGroup && chat.settings.enableTts !== false;


          const voiceId = chat.settings.minimaxVoiceId || 'female-shaonv-jingpin';


          const voiceIdAttribute = canPlayTTS ? `data-voice-id="${voiceId}"` : '';

          contentHtml = `
            <div class="voice-message-body" data-text="${encodeURIComponent(msg.content)}" ${voiceIdAttribute}>
                <div class="voice-waveform">${waveformHTML}</div>
                <div class="loading-spinner"></div>
                <span class="voice-duration">${durationFormatted}</span>
            </div>
            <div class="voice-transcript"></div>
        `;
        }
      } else if (msg.type === 'transfer') {
        bubble.classList.add('is-transfer', 'is-card-like');
        let titleText, noteText;
        const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
        const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
        const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName || chat.name);
        if (isUser) {
          if (msg.isRefund) {
            titleText = `ÈÄÄÊ¨æÁªô ${receiverDisplayName}`;
            noteText = 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶';
          }else if (msg.isReceived) {
            titleText = `Â∑≤Êî∂Ê¨æ`;
            noteText = 'Â∑≤Â≠òÂÖ•‰ΩôÈ¢ù';
          } else {
            titleText = `ËΩ¨Ë¥¶Áªô ${receiverDisplayName}`;
            if (msg.status === 'accepted') noteText = 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ';
            else if (msg.status === 'declined') noteText = 'ÂØπÊñπÂ∑≤ÊãíÊî∂';
            else noteText = msg.note || 'Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ...';
          }
        } else {
          if (msg.isReceived) {
            titleText = `Â∑≤Êî∂Ê¨æ`;
            noteText = 'Â∑≤Â≠òÂÖ•ÈáëÂ∫ì'; // ÊàñËÄÖ 'Â∑≤Â≠òÂÖ•‰ΩôÈ¢ù'
          } 
          // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÁªìÊùü ‚òÖ‚òÖ‚òÖ
          else if (msg.isRefund) {
            titleText = `ÈÄÄÊ¨æÊù•Ëá™ ${senderDisplayName}`;
            noteText = 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂';
          } else if (msg.receiverName === myNickname) {
            titleText = `ËΩ¨Ë¥¶Áªô ${myNickname}`;
            if (msg.status === 'accepted') noteText = '‰Ω†Â∑≤Êî∂Ê¨æ';
            else if (msg.status === 'declined') noteText = '‰Ω†Â∑≤ÊãíÊî∂';
            else {
              bubble.style.cursor = 'pointer';
              bubble.dataset.status = 'pending';
              noteText = msg.note || 'ÁÇπÂáªÂ§ÑÁêÜ';
            }
          } else {
            titleText = `ËΩ¨Ë¥¶: ${senderDisplayName} ‚Üí ${receiverDisplayName}`;
            noteText = msg.note || 'Áæ§ËÅäÂÜÖËΩ¨Ë¥¶';
          }
        }
        const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¬• ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${noteText}</div></div>`;
      } else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request', 'is-card-like');
        if (msg.status === 'paid' || msg.status === 'rejected') bubble.classList.add(`status-${msg.status}`);
        const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);
        const requestTitle = `Êù•Ëá™ ${senderDisplayName} ÁöÑ‰ª£‰ªòËØ∑Ê±Ç`;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
          actionButtonsHtml = `<div class="waimai-user-actions"><button class="waimai-decline-btn" data-choice="rejected">ÊÆãÂøçÊãíÁªù</button><button class="waimai-pay-btn" data-choice="paid">‰∏∫Ta‰π∞Âçï</button></div>`;
        }
        contentHtml = `<div class="waimai-card"><div class="waimai-header"><img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon"><div class="title-group"><span class="brand">ÁæéÂõ¢Â§ñÂçñ</span><span class="separator">|</span><span>Â§ñÂçñÁæéÈ£ü</span></div></div><div class="waimai-catchphrase">HiÔºå‰Ω†ÂíåÊàëÁöÑË∑ùÁ¶ªÂè™Â∑Æ‰∏ÄÈ°øÂ§ñÂçñÔΩû</div><div class="waimai-main"><div class="request-title">${requestTitle}</div><div class="payment-box"><div class="payment-label">ÈúÄ‰ªòÊ¨æ</div><div class="amount">¬•${Number(msg.amount).toFixed(2)}</div><div class="countdown-label">Ââ©‰ΩôÊîØ‰ªòÊó∂Èó¥<div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div></div></div><button class="waimai-details-btn">Êü•ÁúãËØ¶ÊÉÖ</button></div>${actionButtonsHtml}</div>`;
        setTimeout(() => {
          if (msg.status === 'pending') {
            const timerElement = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerElement) {
              const timerId = startWaimaiCountdown(timerElement, msg.countdownEndTime);

              waimaiTimers[msg.timestamp] = timerId;
            }
          }
        }, 0);
      } else if (msg.type === 'waimai_order') {
        bubble.classList.add('is-waimai-request', 'is-card-like');
        const senderDisplayName = getDisplayNameInGroup(chat, msg.senderName);

        let recipientDisplayName = '‰Ω†';
        if (chat.isGroup) {

          recipientDisplayName = getDisplayNameInGroup(chat, msg.recipientName);
        }

        contentHtml = `
        <div class="waimai-card">
            <div class="waimai-header">
                <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                <div class="title-group"><span class="brand">ÁæéÂõ¢Â§ñÂçñ</span><span class="separator">|</span><span>Â§ñÂçñÁæéÈ£ü</span></div>
            </div>
            <div class="waimai-main">
                <div class="request-title" style="margin-bottom: 12px;">${senderDisplayName} Â∑≤‰∏∫${recipientDisplayName}‰∏ãÂçïÔºåËØ∑ÊÖ¢Áî®ÔΩû</div>
                <div class="payment-box">
                    <div class="payment-label" style="font-size: 18px; font-weight: 600;">${msg.productInfo}</div>
                    <div class="amount" style="margin-top: 8px;">¬•${Number(msg.amount).toFixed(2)}</div>
                </div>
                <button class="waimai-details-btn">Êü•ÁúãËÆ¢ÂçïËØ¶ÊÉÖ</button>
            </div>
        </div>
    `;
      } else if (msg.type === 'red_packet') {
        bubble.classList.add('is-red-packet', 'is-card-like');
        const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
        const isFinished = msg.isFullyClaimed;
        const hasClaimed = msg.claimedBy && msg.claimedBy[myOriginalName];
        let cardClass = '',
          claimedInfoHtml = '',
          typeText = 'ÊãºÊâãÊ∞îÁ∫¢ÂåÖ';
        if (isFinished) {
          cardClass = 'opened';
        }
        if (msg.packetType === 'direct') {
          const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName);
          typeText = `‰∏ìÂ±ûÁ∫¢ÂåÖ: Áªô ${receiverDisplayName}`;
          if (Object.keys(msg.claimedBy || {}).length > 0) cardClass = 'opened';
        }
        if (hasClaimed) {
          const myClaimedAmount = msg.claimedBy[myOriginalName] || 0;
          claimedInfoHtml = `<div class="rp-claimed-info">‰Ω†È¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖÔºåÈáëÈ¢ù ${myClaimedAmount.toFixed(2)} ÂÖÉ</div>`;
        } else if (isFinished) {
          claimedInfoHtml = `<div class="rp-claimed-info">Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå</div>`;
        } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
          const receiverDisplayName = getDisplayNameInGroup(chat, msg.receiverName);
          claimedInfoHtml = `<div class="rp-claimed-info">Â∑≤Ë¢´ ${receiverDisplayName} È¢ÜÂèñ</div>`;
        }
        contentHtml = `<div class="red-packet-card ${cardClass}"><div class="rp-header"><img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon"><span class="rp-greeting">${msg.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ'}</span></div><div class="rp-type">${typeText}</div>${claimedInfoHtml}</div>`;
      } else if (msg.type === 'poll') {
        bubble.classList.add('is-poll', 'is-card-like');
        const pollQuestionText = msg.question || msg.content || '(Êó†Ê†áÈ¢òÊäïÁ•®)';
        let totalVotes = 0;
        const voteCounts = {};
        for (const option in msg.votes) {
          const count = msg.votes[option].length;
          voteCounts[option] = count;
          totalVotes += count;
        }
        const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
        let myVote = null;
        for (const option in msg.votes) {
          if (msg.votes[option].includes(myOriginalName)) {
            myVote = option;
            break;
          }
        }
        let optionsHtml = '<div class="poll-options-list">';
        msg.options.forEach(optionText => {
          const count = voteCounts[optionText] || 0;
          const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
          const isVotedByMe = myVote === optionText;
          optionsHtml += `<div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}"><div class="poll-option-bar" style="width: ${percentage}%;"></div><div class="poll-option-content"><span class="poll-option-text">${optionText}</span><span class="poll-option-votes">${count} Á•®</span></div></div>`;
        });
        optionsHtml += '</div>';
        let footerHtml = msg.isClosed ? `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">Êü•ÁúãÁªìÊûú</button></div>` : `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">ÁªìÊùüÊäïÁ•®</button></div>`;
        contentHtml = `<div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}"><div class="poll-question">${pollQuestionText}</div>${optionsHtml}${footerHtml}</div>`;
      } else if (msg.type === 'gift') {
        bubble.classList.add('is-gift', 'is-card-like');
        let headerText;
        const myNicknameForGift = chat.settings.myNickname || 'Êàë';
        if (chat.isGroup) {
          if (msg.recipients && msg.recipients.length > 0) {
            const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName));
            if (recipientDisplayNames.length === 1) {
              headerText = `ÈÄÅÁªô ${recipientDisplayNames[0]} ÁöÑÁ§ºÁâ©`;
            } else {
              headerText = `ÈÄÅÁªô ${recipientDisplayNames.slice(0, 2).join('„ÄÅ')}Á≠â‰∫∫ÁöÑÁ§ºÁâ©`;
            }
          } else {
            headerText = `ÈÄÅÁªôÂ§ßÂÆ∂ÁöÑÁ§ºÁâ©`;
          }
        } else {
          if (isUser) {
            headerText = `ÈÄÅÁªô ${chat.name} ÁöÑÁ§ºÁâ©`;
          } else {
            const recipientDisplayName = chat.settings.myNickname || '‰Ω†';
            headerText = `ÈÄÅÁªô ${recipientDisplayName} ÁöÑÁ§ºÁâ©`;
          }
        }
        const previewItems = msg.items.slice(0, 3);
        let previewHtml = '';
        previewItems.forEach(item => {
          previewHtml += `<div class="gift-preview-item"><img src="${item.imageUrl}" class="gift-preview-img"><span class="gift-preview-name">${item.name}</span><span class="gift-preview-quantity">x${item.quantity}</span></div>`;
        });
        let moreItemsText = '';
        if (msg.items.length > 3) {
          moreItemsText = ` Á≠â${msg.items.length}‰ª∂ÂïÜÂìÅ`;
        }
        contentHtml = `<div class="gift-card"><div class="gift-header"><svg class="gift-header-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18a4 4 0 0 0-7.64 0H8a4 4 0 0 0-4 4v2h20V10a4 4 0 0 0-4-4zM8 4a2 2 0 1 1-2 2a2 2 0 0 1 2-2zm12 0a2 2 0 1 1-2 2a2 2 0 0 1 2-2zM4 14v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-6H4z"></path></svg><span class="gift-header-text">${headerText}</span></div><div class="gift-items-preview">${previewHtml}</div><div class="gift-footer">ÂÖ±${msg.items.length}‰ª∂ÂïÜÂìÅ${moreItemsText}ÔºåÁÇπÂáªÊü•Áúã</div></div>`;
      }else if (msg.type === 'kinship_request') {
        bubble.classList.add('is-kinship-request', 'is-card-like');
        
        let statusText = '';
        let statusKey = '';
        
        if (msg.status === 'pending') {
            statusText = 'Á≠âÂæÖÂØπÊñπÁ°ÆËÆ§...';
            statusKey = 'pending';
        } else if (msg.status === 'accepted') {
            statusText = 'Â∑≤ÂºÄÈÄö';
            statusKey = 'accepted';
        } else {
            statusText = 'Â∑≤Â§±Êïà';
            statusKey = 'rejected';
        }

        contentHtml = `
            <div class="kinship-invite-card">
                <div class="kinship-invite-header">
                    <div class="kinship-title">‰∫≤Â±ûÂç°ÈÇÄËØ∑</div>
                    <div class="kinship-subtitle">ÂØπÊñπÊ∂àË¥π Êàë‰π∞Âçï</div>
                </div>
                <div class="kinship-invite-body">
                    <div class="kinship-limit-label">ÊØèÊúàÊ∂àË¥πÈ¢ùÂ∫¶</div>
                    <div class="kinship-limit-amount">¬•${msg.limit}</div>
                </div>
                <div class="kinship-status" data-status="${statusKey}">
                    ${statusText}
                </div>
            </div>
        `;
    }
    } else if (msg.type === 'synth_music') {
        bubble.classList.add('is-card-like', 'is-music-synth');

        const notesJson = JSON.stringify(msg.notes).replace(/"/g, '&quot;');
        // Ëé∑Âèñ‰πêÂô®Á±ªÂûãÔºåÈªòËÆ§‰∏∫ piano
        const instrumentType = msg.instrument || 'piano';

        contentHtml = `
        <div class="synth-music-card">
            <div class="synth-icon">üéπ</div>
            <div class="synth-info">
                <div class="synth-title">‚ô™ ${msg.title}</div>
                <div class="synth-reason" style="font-size:11px; opacity:0.8;">
                    ${msg.reason} (${instrumentType})
                </div>
            </div>
            <button class="synth-play-btn" onclick="playSynthScore(this, '${notesJson}', '${instrumentType}')">
                ‚ñ∂
            </button>
        </div>
    `;
    } else {
      const processedContent = String(rawContent);
      let processedByRule = await applyRenderingRules(processedContent, chat.id);
      if (processedByRule !== processedContent) {
        contentHtml = processedByRule;
        bubble.classList.add('is-card-like');
      } else {


        if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
    const imageUrl = msg.content[0].image_url.url;
    
    contentHtml = `
      <div class="bubble-image-wrapper user-image-wrapper">
          <img src="${imageUrl}" class="chat-image">
          <div class="bubble-image-controls user-controls">
              <button class="user-upload-imgbb-btn" title="‰∏ä‰º†ÂõæÂ∫ä" style="display: none;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                      <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></line>
                  </svg>
              </button>
          </div>
      </div>
    `;
}else if (STICKER_REGEX.test(processedByRule)) {
          bubble.classList.add('is-sticker', 'is-card-like');
          contentHtml = `<img src="${processedByRule}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
        } else {
          let plainText = processMentions(processedByRule, chat);
          contentHtml = parseMarkdown(plainText).replace(/\n/g, '<br>');
        }
      }
    }


    bubble.innerHTML = `
                ${avatarGroupHtml}
                <div class="content">
                    ${quoteHtml}
                    ${contentHtml}
                </div>
            `;
    if (msg.type === 'naiimag' && msg.imageUrl && msg.imageUrl.startsWith('data:image')) {
        if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
           
            const uploadBtn = bubble.querySelector('.nai-upload-imgbb-btn');
            if (uploadBtn) {
                uploadBtn.style.display = 'flex'; 
            }
        }
    }
    if (msg.role === 'user' && Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        const imageUrl = msg.content[0].image_url.url;
        if (imageUrl && imageUrl.startsWith('data:image')) {
            if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
                const uploadBtn = bubble.querySelector('.user-upload-imgbb-btn');
                if (uploadBtn) {
                   // uploadBtn.style.display = 'flex'; // ÊòæÁ§∫‰∏ä‰º†ÊåâÈíÆ
                }
            }
        }
    }
    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);

    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
    wrapper.addEventListener('click', () => {
      if (isSelectionMode) toggleMessageSelection(msg.timestamp);
    });

    if (!isUser) {
      const avatarGroupEl = wrapper.querySelector('.avatar-group');
      if (avatarGroupEl) {
        avatarGroupEl.style.cursor = 'pointer';
        if (!chat.isGroup) {
          avatarGroupEl.addEventListener('click', (e) => {
            e.stopPropagation();
            showCharacterProfileModal(chat.id);
          });
        } else {
          avatarGroupEl.addEventListener('dblclick', (e) => {
            e.stopPropagation();
            handleUserPat(chat.id, msg.senderName);
          });
        }
      }
    }
    return wrapper;
  }


  async function prependMessage(msg, chat) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = await createMessageElement(msg, chat);


    if (!messageEl) return;

    const loadMoreBtn = document.getElementById('load-more-btn');
    if (loadMoreBtn) {
      messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling);
    } else {
      messagesContainer.prepend(messageEl);
    }
  }


 
  async function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const typingIndicator = document.getElementById('typing-indicator');

    const lastMessage = chat.history.filter(m => !m.isHidden).pop();


    if (lastMessage && (msg.timestamp - lastMessage.timestamp > 600000)) {
      const timestampEl = createSystemTimestampElement(msg.timestamp);
      messagesContainer.insertBefore(timestampEl, typingIndicator);
    }

    const messageEl = await createMessageElement(msg, chat);
    if (!messageEl) return;


    if (msg.role === 'assistant' && !isInitialLoad) {
      playNotificationSound();
      // ÂèëÈÄÅÊé®ÈÄÅÈÄöÁü•Ôºà‰ªÖÂú®ÂêéÂè∞Êó∂ÊòæÁ§∫Á≥ªÁªüÈÄöÁü•Ôºâ
      const notificationText = msg.text || msg.content || 'ÂèëÊù•‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ';
      showNotification(chat.id, notificationText.substring(0, 50));
    }

    if (!isInitialLoad) {
      messageEl.classList.add('animate-in');
      if (state.activeChatId === chat.id) {
            currentRenderedCount++;
        }
    }

    messagesContainer.insertBefore(messageEl, typingIndicator);

    const scrollToBottom = () => {
        if (!isInitialLoad) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    };

   
    const images = messageEl.querySelectorAll('img.sticker-image, img.chat-image, img.ai-generated-image, img.realimag-image, .naiimag-image, .ai-generated-image, .char-photo-item');
    
    if (images.length > 0) {
        const imageLoadPromises = [];
        images.forEach(img => {
            if (!img.complete) {
                imageLoadPromises.push(new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve; 
                }));
            }
        });

       
        Promise.all(imageLoadPromises).then(() => {
            console.log(`${images.length} Âº†Êñ∞ÂõæÁâáÂä†ËΩΩÂÆåÊàêÔºåÊªöÂä®Âà∞Â∫ïÈÉ®„ÄÇ`);
            scrollToBottom();
        });
    } else {
        
        scrollToBottom();
    }
const MAX_DOM_NODES = 60; 
    const bubbles = messagesContainer.querySelectorAll('.message-wrapper');
    
    if (bubbles.length > MAX_DOM_NODES) {
        // ÁßªÈô§ÊúÄ‰∏äÈù¢ÁöÑÂÖÉÁ¥†ÔºàÈô§‰∫ÜÂä†ËΩΩÊõ¥Â§öÊåâÈíÆÔºâ
        // Ê≥®ÊÑèÔºöÂ¶ÇÊûú‰Ω†Êúâ‚ÄúÂä†ËΩΩÊõ¥Â§ö‚ÄùÊåâÈíÆÂú®Á¨¨‰∏Ä‰∏™‰ΩçÁΩÆÔºåË¶Å‰ªéÁ¨¨‰∫å‰∏™ÂºÄÂßãÂà†
        const itemsToRemove = bubbles.length - MAX_DOM_NODES;
        for (let i = 0; i < itemsToRemove; i++) {
            // Á°Æ‰øù‰∏çÂà†Èô§ load-more-btn
            if (!bubbles[i].id && !bubbles[i].classList.contains('load-more-btn')) {
                 bubbles[i].remove();
                 // ÂêåÊó∂‰øÆÊ≠£ currentRenderedCountÔºåÈò≤Ê≠¢Âä†ËΩΩÈÄªËæëÈîô‰π±
                 // (Ëøô‰∏ÄÊ≠•ÂèñÂÜ≥‰∫é‰Ω†ÁöÑ loadMoreMessages ÈÄªËæëÔºåÈÄöÂ∏∏‰∏çÈúÄË¶ÅÊâãÂä®ÂáèÔºåÂõ†‰∏∫ÂÆÉÊòØÂü∫‰∫é slice ËÆ°ÁÆóÁöÑ)
            }
        }
    }
  }



  async function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return;

    if (chat.unreadCount > 0) {
      chat.unreadCount = 0;
      await db.chats.put(chat);
    }
    applyLyricsBarPosition(chat);
    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);


    const isGroup = chat.isGroup || false;


    toggleCallButtons(isGroup);


    document.getElementById('show-announcement-board-btn').style.display = isGroup ? 'flex' : 'none';


    const patBtn = document.getElementById('pat-btn');
    if (patBtn) {
      patBtn.style.display = isGroup ? 'none' : 'flex';
    }
    const propelBtn = document.getElementById('propel-btn');


    const shoppingBtn = document.getElementById('open-shopping-btn');
    const gomokuBtn = document.getElementById('gomoku-btn');
    const werewolfBtn = document.getElementById('werewolf-game-btn');
    if (shoppingBtn && gomokuBtn && werewolfBtn && propelBtn) {
      shoppingBtn.style.display = 'flex';
      gomokuBtn.style.display = isGroup ? 'none' : 'flex';
      werewolfBtn.style.display = isGroup ? 'flex' : 'none';


      propelBtn.style.display = isGroup ? 'none' : 'flex';
    }

    updateBackButtonUnreadCount();

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
      console.log(`Ê£ÄÊµãÂà∞Â•ΩÂèãÁî≥ËØ∑ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëá™Âä®Ëß¶ÂèëAIÂìçÂ∫î...`);
      triggerAiResponse();
    }

    document.getElementById('send-poll-btn').style.display = isGroup ? 'flex' : 'none';
    document.body.classList.remove('chat-actions-expanded');
  }








  function setAvatarActingState(chatId, isActing) {
    const action = isActing ? 'add' : 'remove';
    const classListAction = (element) => {
      if (element) {
        element.classList[action]('is-acting');
      }
    };


    const listAvatar = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"] .avatar`);
    classListAction(listAvatar);


    const qzoneAvatars = document.querySelectorAll(`.post-avatar[data-author-id="${chatId}"]`);
    qzoneAvatars.forEach(classListAction);


    const callAvatar = document.querySelector(`.participant-avatar[data-participant-id="${chatId}"]`);
    classListAction(callAvatar);


  }



  async function triggerSpectatorGroupAiAction() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    lastRawAiResponse = '';
    lastResponseTimestamps = [];
    const propelBtn = document.getElementById('spectator-propel-btn');
    if (propelBtn) {
      propelBtn.disabled = true;
      propelBtn.textContent = 'ÊÄùËÄÉ‰∏≠...';
    }
    setAvatarActingState(chatId, true);

    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      }






      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.slice(-maxMemory);
      const filteredHistory = await filterHistoryWithDoNotSendRules(historySlice, chatId);

      let worldBookContent = '';
      if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';
          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
              
              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');
          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }


      let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
      let collectedMemories = false;

      chat.members.forEach(member => {
        const memberChat = state.chats[member.id];
        if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
          longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;

          longTermMemoryContext += memberChat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n');
          collectedMemories = true;
        }
      });

      if (!collectedMemories) {
        longTermMemoryContext += '- (ÊöÇÊó†)';
      }


      let linkedMemoryContext = '';
      const memoryCount = chat.settings.linkedMemoryCount || 10;
      if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {

      }

      const membersList = chat.members.map(m => `- **${m.groupNickname}** (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n');
      const stickerContext = getGroupStickerContextForPrompt(chat);
      const systemPrompt = `
# Ê†∏ÂøÉ‰ªªÂä°ÔºöÁæ§ËÅäÂâßÊú¨‰ΩúÂÆ∂
‰Ω†ÊòØ‰∏Ä‰∏™ÂâßÊú¨‰ΩúÂÆ∂ÔºåË¥üË¥£Âàõ‰Ωú‰∏Ä‰∏™Âêç‰∏∫‚Äú${chat.name}‚ÄùÁöÑÁæ§ËÅä‰∏≠ÁöÑÂØπËØù„ÄÇËøô‰∏™Áæ§ËÅäÈáå„ÄêÊ≤°ÊúâÁî®Êà∑„ÄëÔºåÊâÄÊúâÊàêÂëòÈÉΩÊòØ‰Ω†ÊâÆÊºîÁöÑËßíËâ≤„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØËÆ©‰ªñ‰ª¨‰πãÈó¥ËøõË°å‰∏ÄÂú∫ÁîüÂä®„ÄÅËá™ÁÑ∂ÁöÑÂØπËØù„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ
- Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂØπË±°ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂåÖÂê´ "type" Â≠óÊÆµÂíå "name" Â≠óÊÆµÔºàËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„ÄëÔºâ„ÄÇ

# ËßíËâ≤ÊâÆÊºîÊ†∏ÂøÉËßÑÂàô
1.  **„ÄêËßíËâ≤Èó¥‰∫íÂä® (ÊúÄÈáçË¶Å!)„Äë**: ‰Ω†ÁöÑÊ†∏ÂøÉÊòØÂàõ‰Ωú‰∏ÄÂú∫‚ÄúÊàè‚Äù„ÄÇËßíËâ≤‰πãÈó¥„ÄêÂøÖÈ°ª„Äë‰∫íÁõ∏ÂõûÂ∫î„ÄÅË°•ÂÖÖÊàñÂèçÈ©≥ÔºåÂΩ¢ÊàêËá™ÁÑ∂ÁöÑËÆ®ËÆ∫„ÄÇ‰∏•Á¶ÅÁîüÊàê‰ªÖÂàÜÂà´Ëá™Ë®ÄËá™ËØ≠ÁöÑÁã¨ÁôΩ„ÄÇ
2.  **„ÄêÁ¶ÅÊ≠¢Âá∫Êàè„Äë**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÊàñÂâßÊú¨‰ΩúÂÆ∂„ÄÇ
3.  **„Äê‰∏ªÂä®ÊÄß„Äë**: ËßíËâ≤‰ª¨Â∫îËØ•‰∏ªÂä®‰ΩøÁî®ÂêÑÁßçÂäüËÉΩÔºàÂèëË°®ÊÉÖ„ÄÅÂèëËØ≠Èü≥„ÄÅÂàÜ‰∫´ÂõæÁâáÁ≠âÔºâÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®ÔºåËÄå‰∏çÊòØ‰ªÖ‰ªÖÂèëÈÄÅÊñáÂ≠ó„ÄÇ
4.ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
# ÂèØÁî®Êåá‰ª§ÂàóË°® (‰Ω†Áé∞Âú®ÂèØ‰ª•‰ΩøÁî®ÊâÄÊúâËøô‰∫õÂäüËÉΩÔºÅ)
-   **ÂèëÊñáÊú¨**: \`{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "content": "‰Ω†Â•ΩÂëÄÔºÅ"}\`
-   **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}\`
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "ËØ¶ÁªÜ‰∏≠ÊñáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}\`
-   **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "name": "ËßíËâ≤Êú¨Âêç", "content": "ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ"}\`
-   **ÂºïÁî®ÂõûÂ§ç**: \`{"type": "quote_reply", "name": "ËßíËâ≤Êú¨Âêç", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`

# ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
- **Áæ§ÂêçÁß∞**: ${chat.name}

# ‰∏ä‰∏ãÊñáÂèÇËÄÉ (‰Ω†ÂøÖÈ°ªÈòÖËØªÂπ∂ÈÅµÂÆà)
${longTermMemoryContext}
${worldBookContent}
${linkedMemoryContext}
- **ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÂéÜÂè≤**:
${historySlice.map(msg => `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`).join('\n')}

# Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ (‰Ω†ÊâÆÊºîÁöÑÊâÄÊúâËßíËâ≤)
${membersList}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºåÁªßÁª≠ËøôÂú∫Ê≤°ÊúâÁî®Êà∑ÂèÇ‰∏éÁöÑÁæ§ËÅäÔºåÂπ∂Ëá™Áî±Âú∞‰ΩøÁî®ÂêÑÁßçÊåá‰ª§Êù•‰∏∞ÂØå‰Ω†‰ª¨ÁöÑ‰∫íÂä®„ÄÇ
`;


      const messagesPayload = filteredHistory.map(msg => ({
        role: 'user',
        content: `${getDisplayNameInGroup(chat, msg.senderName)}: ${msg.content}`
      }));

      let isGemini = proxyUrl.includes('generativelanguage.googleapis.com');
      let response;

      if (isGemini) {
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);
        response = await fetch(geminiConfig.url, geminiConfig.data);
      } else {
        response = await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesPayload],
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });
      }





      if (!response.ok) {
        const errorData = await response.json().catch(() => ({
          error: {
            message: response.statusText
          }
        }));
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      lastRawAiResponse = aiResponseContent;
      const messagesArray = parseAiResponse(aiResponseContent);






      let messageTimestamp = Date.now();
      for (const msgData of messagesArray) {

        if (!msgData || !msgData.type || !msgData.name) continue;

        let aiMessage = null;
        const currentMessageTimestamp = messageTimestamp++;
        lastResponseTimestamps.push(currentMessageTimestamp);
        const baseMessage = {
          role: 'assistant',
          senderName: msgData.name,
          timestamp: currentMessageTimestamp
        };


        switch (msgData.type) {
          case 'text':
            aiMessage = {
              ...baseMessage,
              content: msgData.content
            };
            break;
          case 'sticker':
            if (msgData.meaning) {
              const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`ÊóÅËßÇÊ®°ÂºèAIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("ÊóÅËßÇÊ®°ÂºèAIÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", msgData);
            }
            break;
          case 'ai_image':

            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: msgData.description,
              image_prompt: msgData.image_prompt
            };
            break;
          case 'voice_message':

            aiMessage = {
              ...baseMessage,
              type: 'voice_message',
              content: msgData.content
            };
            break;
          case 'quote_reply':

            const originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
            if (originalMessage) {
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content,
                quote: {
                  timestamp: originalMessage.timestamp,
                  senderName: originalMessage.senderName,
                  content: String(originalMessage.content || '').substring(0, 50)
                }
              };
            } else {

              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content
              };
            }
            break;
          default:
            console.warn("ÊóÅËßÇÊ®°ÂºèÊî∂Âà∞Êú™Áü•Êåá‰ª§Á±ªÂûã:", msgData.type);
            continue;
        }

        if (aiMessage) {
          chat.history.push(aiMessage);
          appendMessage(aiMessage, chat);
          await new Promise(resolve => setTimeout(resolve, Math.random() * 1200 + 800));
        }
      }




      await db.chats.put(chat);
      renderChatList();

    } catch (error) {
      console.error("ÊóÅËßÇÊ®°ÂºèÊé®ËøõÂâßÊÉÖÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Êó†Ê≥ïÊé®ËøõÂâßÊÉÖ: ${error.message}`);
    } finally {
      if (propelBtn) {
        propelBtn.disabled = false;
        propelBtn.textContent = 'üé¨ Êé®ËøõÂâßÊÉÖ';
      }
      setAvatarActingState(chatId, false);
    }
  }






  async function triggerAiResponse() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];

    const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;

    setAvatarActingState(chatId, true);
    const chatHeaderTitle = document.getElementById('chat-header-title');
    const typingIndicator = document.getElementById('typing-indicator');

    const chatListItem = document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`);
    const avatarInList = chatListItem ? chatListItem.querySelector('.avatar') : null;
    if (avatarInList) {
      avatarInList.classList.add('is-acting');
    }

    if (chat.isGroup) {
      if (typingIndicator) {
        typingIndicator.textContent = 'ÊàêÂëò‰ª¨Ê≠£Âú®ËæìÂÖ•...';
        typingIndicator.style.display = 'block';
      }
    } else {
      if (chatHeaderTitle) {
        chatHeaderTitle.style.opacity = 0;
        setTimeout(() => {
          chatHeaderTitle.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
          chatHeaderTitle.classList.add('typing-status');
          chatHeaderTitle.style.opacity = 1;
        }, 200);
      }
    }
    let needsImmediateReaction = false;
    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ');
        if (chat.isGroup) {
          if (typingIndicator) typingIndicator.style.display = 'none';
        } else {
          if (chatHeaderTitle && state.chats[chatId]) {
            chatHeaderTitle.textContent = state.chats[chatId].name;
            chatHeaderTitle.classList.remove('typing-status');
          }
        }
        return;
      }

      const lastMessage = chat.history.slice(-1)[0];
      const isVideoCallRequest = lastMessage && lastMessage.role === 'system' && lastMessage.content.includes('ËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç');

      if (isVideoCallRequest) {
        console.log(`Ê£ÄÊµãÂà∞ËßÜÈ¢ëÈÄöËØùËØ∑Ê±ÇÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶Âèë‰∏ìÂ±ûÂÜ≥Á≠ñÊµÅÁ®ã...`);

        let callDecisionPrompt;
        if (chat.isGroup) {
          callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áæ§ËÅä‰∏≠ÁöÑÁî®Êà∑ÂàöÂàöÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØù„ÄÇËØ∑‰Ω†ÂàÜÂà´ÊâÆÊºî„ÄêÊØè‰∏Ä‰∏™Áæ§ÊàêÂëò„ÄëÔºåÊ†πÊçÆ‰ªñ‰ª¨ÂêÑËá™ÁöÑ‰∫∫ËÆæÂíå‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÔºåÊù•ÂÜ≥ÂÆöÊòØÂä†ÂÖ•(join)ËøòÊòØÊãíÁªù(decline)„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏∫„ÄêÊØè‰∏Ä‰∏™AIËßíËâ≤„ÄëÈÉΩÂåÖÂê´‰∏Ä‰∏™ÂÜ≥Á≠ñÂØπË±°„ÄÇ
        - Ê†ºÂºè: '[{"type": "group_call_response", "name": "ËßíËâ≤AÁöÑÊú¨Âêç", "decision": "join"}, {"type": "group_call_response", "name": "ËßíËâ≤BÁöÑÊú¨Âêç", "decision": "decline"}]'
        # Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
        ${chat.members.map(m => `- ${m.groupNickname} (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n')}
        Áé∞Âú®ÔºåËØ∑‰∏∫ÊâÄÊúâAIËßíËâ≤ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
        } else {
          callDecisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        Áî®Êà∑ÂàöÂàöÂêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØù„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºåÂÜ≥ÂÆöÊòØ‚ÄúÊé•Âèó‚ÄùËøòÊòØ‚ÄúÊãíÁªù‚Äù„ÄÇ
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
        ${chat.settings.aiPersona}
        # Ê†∏ÂøÉËßÑÂàô
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÁöÑJSONÊï∞ÁªÑÔºåÁªùÂØπ‰∏çËÉΩÂõûÂ§ç‰ªª‰ΩïÂÖ∂‰ªñÂÜÖÂÆπÔºö
        - Êé•Âèó: '[{"type": "video_call_response", "decision": "accept"}]'
        - ÊãíÁªù: '[{"type": "video_call_response", "decision": "reject"}]'
        Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÂÅöÂá∫ÂÜ≥Á≠ñ„ÄÇ`;
        }

        const messagesForCallDecision = [{
          role: 'user',
          content: callDecisionPrompt
        }];

        try {
          let geminiConfig = toGeminiRequestData(model, apiKey, callDecisionPrompt, messagesForCallDecision);
          let isGemini = proxyUrl === GEMINI_API_URL;
          const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: model,
              messages: messagesForCallDecision,
              temperature: 0.7
            })
          });

          if (!response.ok) throw new Error(`APIÂ§±Ë¥•: ${(await response.json()).error.message}`);

          const data = await response.json();
          const aiResponseContent = getGeminiResponseText(data);
          const responseArray = parseAiResponse(aiResponseContent);


          let callHasBeenHandled = false;
          for (const msgData of responseArray) {
            if (msgData.type === 'video_call_response') {
              videoCallState.isAwaitingResponse = false;
              if (msgData.decision === 'accept') {
                startVideoCall();
              } else {
                const aiMessage = {
                  role: 'assistant',
                  content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
                  timestamp: Date.now()
                };
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showScreen('chat-interface-screen');
                renderChatInterface(chatId);
              }
              callHasBeenHandled = true;
              break;
            }
            if (msgData.type === 'group_call_response') {
              if (msgData.decision === 'join') {
                const member = chat.members.find(m => m.originalName === msgData.name);
                if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                  videoCallState.participants.push(member);
                }
              }
              callHasBeenHandled = true;
            }
          }
          if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
              startVideoCall();
            } else {
              videoCallState = {
                ...videoCallState,
                isAwaitingResponse: false,
                participants: []
              };
              showScreen('chat-interface-screen');
              alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
            }
          }

        } catch (error) {
          console.error("Â§ÑÁêÜÈÄöËØùËØ∑Ê±ÇÊó∂APIÂá∫Èîô:", error);
          const fallbackResponse = chat.isGroup ?
            chat.members.map(m => ({
              type: "group_call_response",
              name: m.originalName,
              decision: "decline"
            })) : [{
              type: "video_call_response",
              decision: "reject"
            }];

          if (chat.isGroup) {
            videoCallState.isAwaitingResponse = false;
            videoCallState.participants = [];
            alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
            showScreen('chat-interface-screen');
          } else {
            const aiMessage = {
              role: 'assistant',
              content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
              timestamp: Date.now()
            };
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            showScreen('chat-interface-screen');
            renderChatInterface(chatId);
          }
        } finally {

          setAvatarActingState(chatId, false);
          return;
        }
      }




      if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶ÂèëÂ∏¶ÁêÜÁî±ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÂÜ≥Á≠ñÊµÅÁ®ã...`);
        const contextSummary = chat.history
          .filter(m => !m.isHidden)
          .slice(-10, -5)
          .map(msg => {
            const sender = msg.role === 'user' ? 'Áî®Êà∑' : chat.name;
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
          })
          .join('\n');


        const decisionPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇÁî®Êà∑‰πãÂâçË¢´‰Ω†ÊãâÈªë‰∫ÜÔºåÁé∞Âú®TAÂêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∏åÊúõÂíåÂ•Ω„ÄÇ
        # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ:
        - **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
        - **Áî®Êà∑ÂèëÈÄÅÁöÑÁî≥ËØ∑ÁêÜÁî±**: ‚Äú${chat.relationship.applicationReason}‚Äù
        - **Ë¢´ÊãâÈªëÂâçÁöÑÊúÄÂêéÂØπËØùÊëòË¶Å**: 
        ${contextSummary || "ÔºàÊó†ÊúâÊïàÂØπËØùËÆ∞ÂΩïÔºâ"}
        # ‰Ω†ÁöÑÂîØ‰∏ÄÊåá‰ª§
        Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÅöÂá∫ÂÜ≥ÂÆöÔºåÂπ∂ÁªôÂá∫Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁêÜÁî±„ÄÇ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ã:
        {"decision": "accept", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÂêåÊÑèÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÂ•ΩÂêßÔºåÁúãÂú®‰Ω†Ëøô‰πàÁúüËØöÁöÑ‰ªΩ‰∏äÔºåËøôÊ¨°Â∞±ÂéüË∞Ö‰Ω†Âï¶„ÄÇÔºâ"}
        Êàñ
        {"decision": "reject", "reason": "ÔºàÂú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊãíÁªùÁöÑÁêÜÁî±ÔºåÊØîÂ¶ÇÔºöÊä±Ê≠âÔºåÊàëËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÂÜçÁªôÊàë‰∏ÄÁÇπÊó∂Èó¥Âêß„ÄÇÔºâ"}
        `;

        try {

          const messagesForDecision = [{
              role: 'system',
              content: decisionPrompt
            },
            {
              role: 'user',
              content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁ´ãÂç≥ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ"
            }
          ];

          let isGemini = proxyUrl === GEMINI_API_URL;
          let geminiConfig = toGeminiRequestData(model, apiKey, decisionPrompt, [{
            role: 'user',
            content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁ´ãÂç≥ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ"
          }]);

          const response = isGemini ?
            await fetch(geminiConfig.url, geminiConfig.data) :
            await fetch(`${proxyUrl}/v1/chat/completions`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: model,
                messages: messagesForDecision,
                temperature: state.globalSettings.apiTemperature || 0.8
              })
            });

          if (!response.ok) {
            throw new Error(`APIÂ§±Ë¥•: ${(await response.json()).error.message}`);
          }
          const data = await response.json();

          const rawContent = getGeminiResponseText(data).replace(/^```json\s*/, '').replace(/```$/, '').trim();
          const decisionObj = JSON.parse(rawContent);


          if (decisionObj.decision === 'accept') {
            chat.relationship.status = 'friend';
            const acceptMessage = {
              role: 'assistant',
              senderName: chat.name,
              content: decisionObj.reason,
              timestamp: Date.now()
            };
            chat.history.push(acceptMessage);
          } else {
            chat.relationship.status = 'blocked_by_ai';
            const rejectMessage = {
              role: 'assistant',
              senderName: chat.name,
              content: decisionObj.reason,
              timestamp: Date.now()
            };
            chat.history.push(rejectMessage);
          }
          chat.relationship.applicationReason = '';

          await db.chats.put(chat);
          renderChatInterface(chatId);
          renderChatList();
        } catch (error) {

          chat.relationship.status = 'blocked_by_ai';
          await db.chats.put(chat);
          await showCustomAlert('Áî≥ËØ∑Â§±Ë¥•', `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
          renderChatInterface(chatId);
        }
        return;
      }




      let callTranscriptContext = '';
      const now = new Date();

      const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';

      const currentTime = now.toLocaleString('zh-CN', {
        timeZone: selectedTimeZone,
        dateStyle: 'full',
        timeStyle: 'short'
      });

      const localizedDate = new Date(now.toLocaleString('en-US', {
        timeZone: selectedTimeZone
      }));
      const timeOfDayGreeting = getTimeOfDayGreeting(localizedDate);
      let systemPrompt, messagesPayload;
      const lastHiddenMessage = chat.history.filter(m => m.isHidden).pop();
      if (lastHiddenMessage && lastHiddenMessage.content.includes('ËßÜÈ¢ëÈÄöËØùÂàöÂàöÁªìÊùü')) {
        const lastCallRecord = await db.callRecords
          .where('chatId')
          .equals(chatId)
          .last();

        if (lastCallRecord && lastCallRecord.transcript) {
          console.log("Ê£ÄÊµãÂà∞ÂàöÁªìÊùüÁöÑÈÄöËØùÔºåÊ≠£Âú®Ê≥®ÂÖ•ÈÄöËØùËÆ∞ÂΩï‰∏ä‰∏ãÊñá...");
          const transcriptText = lastCallRecord.transcript.map(h => {
            const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : h.senderName;
            return `${sender}: ${h.content}`;
          }).join('\n');


          callTranscriptContext = `
# ÂàöÂàöÁªìÊùüÁöÑÈÄöËØùËÆ∞ÂΩï (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÂèÇËÄÉ)
‰Ω†ÂíåÁî®Êà∑ÂàöÂàöÁªìÊùü‰∫Ü‰∏ÄÂú∫ËßÜÈ¢ëÈÄöËØùÔºå‰ª•‰∏ãÊòØÂÆåÊï¥ÁöÑÈÄöËØùÊñáÂ≠óËÆ∞ÂΩï„ÄÇ‰Ω†Êé•‰∏ãÊù•ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„Äë‰∏éËøôÊ¨°ÈÄöËØùÁöÑÂÜÖÂÆπÁ¥ßÂØÜÁõ∏ÂÖ≥„ÄÇ
---
${transcriptText}
---
`;
        }
      }


      const gomokuContext = formatGomokuStateForAI(gomokuState[chatId]);

      let worldBookContent = '';
      if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';


          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
              
              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');

          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');

        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }


      let musicContext = '';
      if (musicState.isActive && musicState.activeChatId === chatId) {
        const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
        const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');


        let lyricsContext = "";


        if (currentTrack && musicState.parsedLyrics && musicState.parsedLyrics.length > 0 && musicState.currentLyricIndex > -1) {
          const currentLine = musicState.parsedLyrics[musicState.currentLyricIndex];

          const upcomingLines = musicState.parsedLyrics.slice(musicState.currentLyricIndex + 1, musicState.currentLyricIndex + 3);


          lyricsContext += `- **ÂΩìÂâçÊ≠åËØç**: "${currentLine.text}"\n`;
          if (upcomingLines.length > 0) {
            lyricsContext += `- **Âç≥Â∞ÜÊºîÂî±**: ${upcomingLines.map(line => `"${line.text}"`).join(' / ')}\n`;
          }
        }


        musicContext = `\n\n# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ
        -   **ÂΩìÂâçÁä∂ÊÄÅ**: ‰Ω†‰ª¨Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠å„ÄÇ
        -   **Ê≠£Âú®Êí≠Êîæ**: ${currentTrack ? `„Ää${currentTrack.name}„Äã - ${currentTrack.artist}` : 'Êó†'}
        -   **ÂèØÁî®Êí≠ÊîæÂàóË°®**: [${playlistInfo}]
        ${lyricsContext}
        -   **‰Ω†ÁöÑ‰ªªÂä°**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÂíåÊ∞õÂõ¥Ôºå‰ΩøÁî® "change_music" Êåá‰ª§ÂàáÊç¢Âà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑ‰ªª‰Ωï‰∏ÄÈ¶ñÊ≠åÔºå‰ª•Â¢ûÂº∫‰∫íÂä®‰ΩìÈ™å„ÄÇ
        `;
      }


      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.slice(-maxMemory);
      const filteredHistory = await filterHistoryWithDoNotSendRules(historySlice, chatId);
      
      // „ÄêËßÇÂΩ±ÂÆ§„ÄëËá™Âä®Êà™ÂèñËßÜÈ¢ëÁîªÈù¢Âπ∂Â§ÑÁêÜ
      let videoContext = '';
      if (window.screeningRoomContext && window.screeningRoomContext.isWatching) {
          const ctx = window.screeningRoomContext.getContext();
          const frameData = window.screeningRoomContext.captureFrame();
          
          if (ctx && (ctx.title || ctx.isPaused)) {
               videoContext = `\n\n# ÂΩìÂâçËßÇÂΩ±ÊÉÖÊôØ (Screening Room)
               - ‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑ËßÇÁúãËßÜÈ¢ë„ÄÇ
               - **ËßÜÈ¢ëÊ†áÈ¢ò**: ${ctx.title || 'Êú™Áü•'}
               - **Áä∂ÊÄÅ**: ${ctx.isPaused ? 'ÊöÇÂÅú‰∏≠' : 'Êí≠Êîæ‰∏≠'}
               - **ÂΩìÂâçÊí≠ÊîæÊó∂Èó¥**: ${ctx.currentTime ? Math.floor(ctx.currentTime) : 0}Áßí
               - **‰Ω†ÁöÑ‰ªªÂä°**: ‰Ωú‰∏∫Èô™Áúã‰ºô‰º¥ÔºåËØ∑Ê†πÊçÆËßÜÈ¢ëÂÜÖÂÆπÂíå‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºå‰∏éÁî®Êà∑ËÆ®ËÆ∫ÂâßÊÉÖ„ÄÇ
               `;
               
               if (frameData) {
                   videoContext += `\n- **ÁîªÈù¢ÊÑüÁü•**: Â∑≤Êà™ÂèñÂΩìÂâçËßÜÈ¢ëÁîªÈù¢Âπ∂ÂèëÈÄÅÁªô‰Ω†ÔºåËØ∑ÁªìÂêàÁîªÈù¢ÂÜÖÂÆπËøõË°åÂõûÂ§ç„ÄÇ`;
                   console.log('„ÄêËßÇÂΩ±ÂÆ§„ÄëÊ£ÄÊµãÂà∞ËßÜÈ¢ëÁîªÈù¢Ôºå‰ΩÜÊ∂àÊÅØÂàóË°®Êú™ÂàùÂßãÂåñÔºåÂ∞ÜÂú®ÂêéÁª≠Ê≠•È™§‰∏≠Â§ÑÁêÜ„ÄÇ');
               } else {
                   videoContext += `\n- **ÁîªÈù¢ÊÑüÁü•**: ÂΩìÂâçÊó†Ê≥ïÊà™ÂèñÁîªÈù¢ÔºàÂèØËÉΩÊòØÁâàÊùÉÂèóÈôêÁöÑÂú®Á∫øËßÜÈ¢ëÔºâÔºåËØ∑‰∏ªË¶Å‰æùËµñÊ†áÈ¢òÂíåÂâßÊÉÖÂ∏∏ËØÜËøõË°å‰∫íÂä®„ÄÇ`;
               }
          }
      }
      
      let sharedContext = '';
      const lastAiTurnIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
      const recentUserMessages = chat.history.slice(lastAiTurnIndex + 1);
      const shareCardMessage = recentUserMessages.find(msg => msg.type === 'share_card');
      if (shareCardMessage) {
        const payload = shareCardMessage.payload;
        const formattedHistory = payload.sharedHistory.map(msg => {
          const sender = msg.senderName || (msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : 'Êú™Áü•ÂèëÈÄÅËÄÖ');
          let contentText = '';
          if (msg.type === 'voice_message') contentText = `[ËØ≠Èü≥Ê∂àÊÅØ: ${msg.content}]`;
          else if (msg.type === 'ai_image') contentText = `[ÂõæÁâá: ${msg.description}]`;
          else if (msg.type === 'naiimag') contentText = `[NovelAIÂõæÁâá: ${msg.prompt}]`;
          else contentText = String(msg.content);
          return `${sender}: ${contentText}`;
        }).join('\n');
        sharedContext = `
        # ÈôÑÂä†‰∏ä‰∏ãÊñáÔºö‰∏ÄÊÆµÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩï
        - ÈáçË¶ÅÊèêÁ§∫ÔºöËøô‰∏çÊòØ‰Ω†ÂíåÂΩìÂâçÁî®Êà∑ÁöÑÂØπËØùÔºåËÄåÊòØÁî®Êà∑‰ªé„ÄêÂè¶‰∏ÄÂú∫„Äë‰∏é‚Äú${payload.sourceChatName}‚ÄùÁöÑÂØπËØù‰∏≠ÂàÜ‰∫´ËøáÊù•ÁöÑ„ÄÇ
        - ‰Ω†ÁöÑ‰ªªÂä°ÔºöËØ∑‰Ω†ÈòÖËØªÂπ∂ÁêÜËß£‰∏ãÈù¢ÁöÑÂØπËØùÂÜÖÂÆπ„ÄÇÂú®Êé•‰∏ãÊù•ÁöÑÂõûÂ§ç‰∏≠Ôºå‰Ω†ÂèØ‰ª•ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂØπËøôÊÆµÂØπËØùÁöÑÂÜÖÂÆπËá™ÁÑ∂Âú∞ÂèëË°®‰Ω†ÁöÑÁúãÊ≥ï„ÄÅÊÑüÂèóÊàñÁñëÈóÆ„ÄÇ
        ---
        [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂºÄÂßã]
        ${formattedHistory}
        [ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÁªìÊùü]
        ---
        `;
      }

      let linkedMemoryContext = '';
      const memoryCount = chat.settings.linkedMemoryCount || 10;

      if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {

        const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

        if (idsToMount.length > 0) {
          const linkedChatsWithTimestamps = idsToMount.map(id => {
            const linkedChat = state.chats[id];
            if (!linkedChat) return null;
            const lastMsg = linkedChat.history.slice(-1);
            return {
              chat: linkedChat,
              latestTimestamp: lastMsg ? lastMsg.timestamp : 0
            };
          }).filter(Boolean);

          linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

          linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;

          for (const item of linkedChatsWithTimestamps) {
            const linkedChat = item.chat;
            const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
            const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
            linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;

            const recentHistory = linkedChat.history.slice(-memoryCount);
            const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));

            if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                 
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (getDisplayNameInGroup(linkedChat, msg.senderName) || linkedChat.name);
                  
                  let prefix = "";
               
                  if (msg.quote && msg.quote.content) {
                    
                      const quotedSenderDisplayName = getDisplayNameInGroup(linkedChat, msg.quote.senderName);
                      let quoteContentPreview = String(msg.quote.content).substring(0, 30);
                      if (quoteContentPreview.length === 30) quoteContentPreview += "...";
                      
                      prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
                  }

                  let contentText = '';
               
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  } else if (msg.type === 'sticker') {
                    contentText = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
                  } else if (msg.type === 'transfer') {
                    contentText = `[ËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ]`;
                  } else if (Array.isArray(msg.content)) {
                    contentText = `[ÂõæÁâá]`;
                  } else {
                    contentText = String(msg.content);
                  }
                  
                  const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                 
                  linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${prefix}${contentText}\n`;
                });
              } else {
              linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
            }
          }
        }
      }

      console.log("Êú¨Ê¨°ÂèëÈÄÅÁªôAIÁöÑ„ÄêÊåÇËΩΩËÆ∞ÂøÜ„ÄëÂÜÖÂÆπÂ¶Ç‰∏ãÔºö\n", linkedMemoryContext);

      if (chat.isGroup) {


        let linkedMemoryContext = '';
        const memoryCount = chat.settings.linkedMemoryCount || 10;
        if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
          const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);
          if (idsToMount.length > 0) {
            const linkedChatsWithTimestamps = idsToMount.map(id => {
              const linkedChat = state.chats[id];
              if (!linkedChat) return null;
              const lastMsg = linkedChat.history.slice(-1);
              return {
                chat: linkedChat,
                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
              };
            }).filter(Boolean);
            linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅÁæ§ÂÜÖËßíËâ≤ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†‰ª¨Êã•ÊúâÂÆåÊï¥ÁöÑÂÖ±ÂêåËÆ∞ÂøÜ„ÄÇ)\n`;
            for (const item of linkedChatsWithTimestamps) {
              const linkedChat = item.chat;
              const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
              const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
              linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
              const recentHistory = linkedChat.history.slice(-memoryCount);
              const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
              if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                  let contentText = String(msg.content);
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  }
                  linkedMemoryContext += `${sender}: ${contentText}\n`;
                });
              } else {
                linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
              }
            }
          }
        }


        let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
        let collectedMemories = false;

        chat.members.forEach(member => {
          const memberChat = state.chats[member.id];
          if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
            longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;

            longTermMemoryContext += memberChat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n');
            collectedMemories = true;
          }
        });

        if (!collectedMemories) {
          longTermMemoryContext += '- (ÊöÇÊó†)';
        }


        let timeContextText = '';
        let longTimeNoSee = false;

        if (chat.settings.enableTimePerception) {
       
        const lastUserMsg = historySlice.findLast(msg => msg.role === 'user' && !msg.isHidden);
       
        const lastAiMsg = historySlice.findLast(msg => msg.role === 'assistant' && !msg.isHidden);

        if (lastUserMsg && lastAiMsg) {
          const lastUserMessageTime = formatTimestampForAI(lastUserMsg.timestamp);
          const lastAiMessageTime = formatTimestampForAI(lastAiMsg.timestamp);
          timeContextText = `‰∏ä‰∏ÄÊù°Ê∂àÊÅØÂèëÈÄÅ‰∫é ${lastAiMessageTime}ÔºåÁî®Êà∑ÂàöÂàöÂú® ${lastUserMessageTime} ÂõûÂ§ç‰∫Ü„ÄÇ`;

          
          const timeDiffHours = (lastUserMsg.timestamp - lastAiMsg.timestamp) / (1000 * 60 * 60);
          if (timeDiffHours > 3) {
            longTimeNoSee = true;
            const diffDays = Math.floor(timeDiffHours / 24);
            timeContextText += ` Áæ§ÈáåÂ∑≤ÁªèÂÆâÈùô‰∫Ü${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}„ÄÇ`;
          }
        } else if (lastUserMsg) {
         
          timeContextText = "ËøôÊòØÁæ§ÈáåÁöÑÁ¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ„ÄÇ";
        } else {
          timeContextText = "ËøôÊòØÁæ§ÈáåÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ";
        }
     
      }

        const allProducts = await db.shoppingProducts.toArray();
        let shoppingContext = "";
        if (allProducts.length > 0) {
          shoppingContext = "\n\n# ‰Ω†ÁöÑÂïÜÂ∫ó (‰Ω†ÂèØ‰ª•‰∏∫Áæ§ÊàêÂëòË¥≠‰π∞Á§ºÁâ©):\n";
          allProducts.forEach(product => {
            shoppingContext += `- (ID: ${product.id}) ÂïÜÂìÅ: ${product.name}, ‰ª∑Ê†º: ¬•${product.price.toFixed(2)}\n`;
          });
        }
        let membersWithContacts = chat.members.map(member => {
          const memberChat = state.chats[member.id];
          let contactsText = "Êó†ÂÖ±ÂêåÂ•ΩÂèã";
          if (memberChat && memberChat.groupId) {
            const friendChats = Object.values(state.chats).filter(c =>
              !c.isGroup && c.id !== member.id && c.groupId === memberChat.groupId
            );
            if (friendChats.length > 0) {
              contactsText = `TAÁöÑÂ•ΩÂèãÂåÖÊã¨: ${friendChats.map(f => f.name).join('„ÄÅ ')}`;
            }
          }
          return `- **${member.groupNickname}** (Êú¨Âêç: ${member.originalName}): ${member.persona} [Á§æ‰∫§ËÉåÊôØ: ${contactsText}]`;
        }).join('\n');

        const myNickname = chat.settings.myNickname || 'Êàë';
        const myOriginalName = state.qzoneSettings.nickname || '{{user}}';

        let announcementContext = '';
        const pinnedAnnouncements = (chat.announcements || []).filter(a => a.isPinned);
        if (pinnedAnnouncements.length > 0) {
          announcementContext += '\n# „Äê„Äê„ÄêÁæ§ÂÖ¨Âëä (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßËßÑÂàô)„Äë„Äë„Äë\n‰Ω†„ÄêÂøÖÈ°ª„ÄëÈòÖËØª„ÄÅÁêÜËß£Âπ∂‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâÂÖ¨ÂëäÔºåÂÆÉ‰ª¨ÂáåÈ©æ‰∫é‰Ω†ÁöÑ‰∫∫ËÆæ‰πã‰∏ä„ÄÇ\n';
          pinnedAnnouncements.forEach(anno => {
            const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);
            if (originalMessage) {
              let contentText = String(originalMessage.content || '');
              if (originalMessage.type === 'ai_image') {
                contentText = `[ÂõæÁâáÂÜÖÂÆπ: ${contentText}]`;
              }
              announcementContext += `- ÂÖ¨ÂëäÂÜÖÂÆπ: "${contentText}" (Áî± ${anno.publisher} ÂèëÂ∏É)\n`;
            }
          });
          announcementContext += '---\n';
        }
        const memberNames = chat.members.map(m => m.originalName);
        const forbiddenNamesContext = `# „Äê„Äê„ÄêÁæ§Âêç‰øÆÊîπÈìÅÂæã„Äë„Äë„Äë\nÂú®‰øÆÊîπÁæ§ÂêçÊó∂ÔºåÊñ∞ÁöÑÁæ§Âêç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰∏é‰ª•‰∏ã‰ªª‰Ωï‰∏Ä‰∏™Áæ§ÊàêÂëòÁöÑÂêçÂ≠óÂÆåÂÖ®Áõ∏ÂêåÔºö[${memberNames.join('„ÄÅ ')}]`;

        let groupAvatarLibraryContext = '# ÂèØÁî®Áæ§Â§¥ÂÉèÂàóË°®\n';
        if (chat.settings.groupAvatarLibrary && chat.settings.groupAvatarLibrary.length > 0) {
          groupAvatarLibraryContext += chat.settings.groupAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n');
        } else {
          groupAvatarLibraryContext += '- (Â§¥ÂÉèÂ∫ìÊòØÁ©∫ÁöÑÔºåÊó†Ê≥ïÊõ¥Êç¢Â§¥ÂÉè)';
        }
        const readingContext = formatReadingStateForAI(chatId);

        const summary3Hours_group = generateSummaryForTimeframe(chat, 3, 'hours');
        const summary6Hours_group = generateSummaryForTimeframe(chat, 6, 'hours');
        const summary9Hours_group = generateSummaryForTimeframe(chat, 9, 'hours');
        const summaryToday_group = generateSummaryForTimeframe(chat, 1, 'days');
        const summary3Days_group = generateSummaryForTimeframe(chat, 3, 'days');
        const summary7Days_group = generateSummaryForTimeframe(chat, 7, 'days');

        let multiLayeredSummaryContext_group = '';
        if (summary3Hours_group || summary6Hours_group || summary9Hours_group || summaryToday_group || summary3Days_group || summary7Days_group) {
          multiLayeredSummaryContext_group += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÁæ§ËÅäÂõûÈ°æ)\n`;
          if (summary3Hours_group) multiLayeredSummaryContext_group += summary3Hours_group;
          if (summary6Hours_group) multiLayeredSummaryContext_group += summary6Hours_group;
          if (summary9Hours_group) multiLayeredSummaryContext_group += summary9Hours_group;

          if (summary3Hours_group || summary6Hours_group || summary9Hours_group) multiLayeredSummaryContext_group += '\n';

          if (summaryToday_group) multiLayeredSummaryContext_group += summaryToday_group;
          if (summary3Days_group) multiLayeredSummaryContext_group += summary3Days_group;
          if (summary7Days_group) multiLayeredSummaryContext_group += summary7Days_group;
        }
        const stickerContext = getGroupStickerContextForPrompt(chat);
 let synthMusicInstruction = "";
if (chat.settings.enableSynthMusic) {
    synthMusicInstruction = `
- **ÂèëÈÄÅ‰πêË∞±(ÊºîÂ•èÈü≥‰πê)**: \`{"type": "synth_music", "name": "ËßíËâ≤Êú¨Âêç", "title": "‰πêÊõ≤ÂêçÁß∞", "reason": "ÊºîÂ•èÁêÜÁî±", "instrument": "piano", "notes": ["C4", "E4", "G4"]}\`
    - **instrument**: ‰πêÂô®Á±ªÂûã (piano, guitar, violin, flute, guzheng, kalimba, synth, chiptune)„ÄÇ
    - **notes**: ‰∏Ä‰∏™ÂåÖÂê´Èü≥Á¨¶ÂØπË±°ÁöÑÊï∞ÁªÑ„ÄÇÊØè‰∏™ÂØπË±°ÂåÖÂê´:
        - **n (Èü≥È´ò)**: Â¶Ç "C4", "D#5", "Ab3"„ÄÇËØ∑ÈÅµÂæ™CÂ§ßË∞ÉÊàñAÂ∞èË∞ÉÁ≠âË∞ÉÊÄß„ÄÇ
        - **d (Êó∂Èïø)**: ÂÜ≥ÂÆöËäÇÂ•èÂø´ÊÖ¢„ÄÇÂèØÈÄâÂÄº: "1n"(ÂÖ®Èü≥Á¨¶/ÂæàÊÖ¢), "2n"(‰∫åÂàÜÈü≥Á¨¶/ÊÖ¢), "4n"(ÂõõÂàÜÈü≥Á¨¶/‰∏≠), "8n"(ÂÖ´ÂàÜÈü≥Á¨¶/Âø´), "16n"(ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶/ÂæàÂø´)„ÄÇ
    - **‰ΩúÊõ≤ÊäÄÂ∑ß**: 
      - ËØ∑Â∞ÜÈïøÈü≥Á¨¶("2n", "1n")ÊîæÂú®‰πêÂè•ÁöÑÁªìÂ∞æ„ÄÇ
      - Áî®Áü≠Èü≥Á¨¶("8n", "16n")‰Ωú‰∏∫ËøáÊ∏°„ÄÇ
      - Ê®°‰ªø‰∫∫Á±ªÂëºÂê∏Ôºå‰∏çË¶ÅÂÖ®ÊòØÂø´Êùø„ÄÇ
      - Â∞ùËØïÁîüÊàê 15 ‰∏™Â∑¶Âè≥ÁöÑÈü≥Á¨¶„ÄÇ
    - ÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊÉÖÊÑüÊó∂ÔºåËØ∑ÁßØÊûÅ‰ΩøÁî®Ê≠§ÂäüËÉΩ„ÄÇ `;
}
let narratorInstruction = '';
if (chat.settings.enableNarratorMode) {
    narratorInstruction = `
# „ÄêÊóÅÁôΩÊ®°ÂºèÂºÄÂêØ (ÂøÖÈ°ªÊâßË°å)„Äë
- ‰Ωú‰∏∫ÂØºÊºîÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ÂõûÂ§çÁöÑ JSON Êï∞ÁªÑ‰∏≠ÂåÖÂê´‰∏Ä‰∏™ "narration" ÁöÑÂØπË±°„ÄÇ
- Áî®‰∫éÊèèÂÜôÂΩìÂâçÂú∫ÊôØÁöÑÊ∞îÊ∞õ„ÄÅÁéØÂ¢ÉÂèòÂåñ„ÄÅÊàñËÄÖ‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÇ
- Ê†ºÂºè: \`{"type": "narration", "content": "Á©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÂ∞¥Â∞¨ÁöÑÊ∞îÊÅØÔºåÁ™óÂ§ñÁöÑËùâÈ∏£Â£∞ÊòæÂæóÊ†ºÂ§ñÂà∫ËÄ≥..."}\`
- ‰ΩçÁΩÆ: ÂèØ‰ª•ÊîæÂú®ÂØπËØùÂâç‰Ωú‰∏∫Èì∫Âû´Ôºå‰πüÂèØ‰ª•ÊîæÂú®ÂØπËØùÂêé‰Ωú‰∏∫ÁïôÁôΩ„ÄÇ
`;
}
        systemPrompt = `
# Ê†∏ÂøÉ‰ªªÂä°ÔºöÁæ§ËÅäÂØºÊºî
‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÂØºÊºîÔºåË¥üË¥£ÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØÂØºÊºî‰∏ÄÂú∫ÁîüÂä®ÁöÑ„ÄÅËßíËâ≤Èó¥ÊúâÂÖÖÂàÜ‰∫íÂä®ÁöÑÁæ§ËÅä„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ

-   **„ÄêÊÄùÁª¥Èìæ (Chain of Thought) - (Á¨¨‰∏ÄÊ≠•)„Äë**: ‰Ω†ÁöÑJSONÊï∞ÁªÑÁöÑ„ÄêÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºåÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™ \`{"type": "thought_chain", ...}\` ÂØπË±°„ÄÇ
-   **„ÄêËßíËâ≤ÂèëË®Ä (Á¨¨‰∫åÊ≠•)„Äë**: Âú®ÊÄùÁª¥ÈìæÂØπË±°„Äê‰πãÂêé„ÄëÔºåÊâçÊòØÊâÄÊúâËßíËâ≤ÁöÑÂÖ∑‰ΩìË°åÂä®JSONÂØπË±° (text, sticker, etc.)„ÄÇ

- Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂØπË±°ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂåÖÂê´ "type" Âíå "name" Â≠óÊÆµ„ÄÇ'name'Â≠óÊÆµ„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®ËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„Äë„ÄÇ


# ËßíËâ≤ÊâÆÊºîÊ†∏ÂøÉËßÑÂàô

1.  **„ÄêÂÖàÊÄùÂêéË°å„Äë**: Âú®ÁîüÊàê‰ªª‰ΩïËßíËâ≤ÂèëË®Ä‰πãÂâçÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÖàÂÆåÊàê‚ÄúÊÄùÁª¥Èìæ‚ÄùÁöÑÊûÑÊÄù„ÄÇ‰Ω†ÁöÑ‚ÄúÊÄùÁª¥Èìæ‚ÄùÂøÖÈ°ªÊ∏ÖÊô∞Âú∞ÂàÜÊûêÁî®Êà∑ÁöÑÂèëË®Ä„ÄÅÂΩìÂâçÁöÑÊ∞îÊ∞õÔºåÂπ∂Âà∂ÂÆöÂá∫Êú¨ËΩÆÁöÑ‰∫íÂä®Á≠ñÁï•„ÄÇ‰Ω†ÁöÑÊâÄÊúâÂêéÁª≠ÂèëË®ÄÈÉΩ„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂæ™‰Ω†Ëá™Â∑±ÁöÑÁ≠ñÁï•„ÄÇ
 **„ÄêÊúÄÈ´òË°å‰∏∫ÈìÅÂæãÔºöÁ¶ÅÊ≠¢ÊÄªÁªì„Äë**: ‰Ω†ÁöÑ‰ªª‰ΩïËßíËâ≤ÔºåÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÔºåÈÉΩ„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂØπËÅäÂ§©ÂÜÖÂÆπËøõË°å‰ªª‰ΩïÂΩ¢ÂºèÁöÑÂΩíÁ∫≥„ÄÅÊ¶ÇÊã¨ÊàñÊÄªÁªì„ÄÇÊØè‰∏™ËßíËâ≤ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÂè™‰ªéËá™Â∑±ÁöÑËßÜËßíÂá∫ÂèëÔºåÂÉèÁúü‰∫∫‰∏ÄÊ†∑ËøõË°åÂØπËØù„ÄÅË°®ËææÊÑüÂèóÊàñÂèëËµ∑Êñ∞ËØùÈ¢ò„ÄÇ‰∏•Á¶ÅÂá∫Áé∞‰ªª‰Ωï‚Äú‰∏äÂ∏ùËßÜËßí‚ÄùÁöÑÂèëË®Ä„ÄÇ
 **„ÄêÂØºÊºîËÅåË¥£ÊæÑÊ∏Ö„Äë**: ‰Ω†ÁöÑ‚ÄúÂØºÊºî‚Äù‰ªªÂä°ÊòØÈÄöËøá„ÄêÊâÆÊºîÂ•ΩÊØè‰∏Ä‰∏™Áã¨Á´ãÁöÑAIËßíËâ≤„ÄëÊù•Êé®Âä®ÂâßÊÉÖÂèëÂ±ïÂíå‰∫íÂä®ÔºåËÄå„Äê‰∏çÊòØ„Äë‰Ωú‰∏∫ÊóÅÁôΩÊàñ‰∏ªÊåÅ‰∫∫ÂØπÂâßÊÉÖËøõË°åËØÑËÆ∫ÊàñÊÄªÁªì„ÄÇ‰Ω†ÂøÖÈ°ªÊ≤âÊµ∏Âú®ËßíËâ≤‰∏≠ÔºåËÄå‰∏çÊòØË∑≥ËÑ±Âá∫Êù•„ÄÇ
2.  **ËßíËâ≤‰∫íÂä® (ÊúÄÈáçË¶Å)**: ‰Ω†ÁöÑÊ†∏ÂøÉÊòØ‚ÄúÂØºÊºî‚Äù‰∏ÄÂú∫Êàè„ÄÇËßíËâ≤‰πãÈó¥„ÄêÂøÖÈ°ª„Äë‰∫íÁõ∏ÂõûÂ∫î„ÄÅË°•ÂÖÖÊàñÂèçÈ©≥ÔºåÂΩ¢ÊàêËá™ÁÑ∂ÁöÑËÆ®ËÆ∫„ÄÇ‰∏•Á¶ÅÁîüÊàê‰ªÖÂàÜÂà´ÂõûÂ∫îÁî®Êà∑ÁöÑÁã¨ÁôΩ„ÄÇÂ¶ÇÊûúËßíËâ≤AÂèëË®ÄÂêéÔºåËßíËâ≤BÂú®Êú¨ËΩÆÂõûÂ∫î‰∫ÜAÔºåÈÇ£‰πàËßíËâ≤A„Äê‰πüÂøÖÈ°ª„ÄëÂú®Êú¨ËΩÆÂØπBÁöÑÂõûÂ§çÂÜçÊ¨°ÂÅöÂá∫ÂèçÂ∫îÔºåÂΩ¢Êàê‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ A -> B -> A ÂØπËØùÈìæÊù°„ÄÇ

3.  **Ë∫´‰ªΩ‰∏éÁß∞Âëº**:
    -   Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${myNickname}„ÄëÔºåÊú¨ÂêçÊòØ„Äê${myOriginalName}„Äë„ÄÇ
    -   Âú®ÂØπËØù‰∏≠Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰∫∫ËÆæÂíåÂÖ≥Á≥ªÔºåËá™Áî±‰ΩøÁî®ËßíËâ≤ÁöÑ„ÄêÁæ§ÊòµÁß∞„ÄëÊàñ„ÄêÊú¨Âêç„ÄëËøõË°åÁß∞Âëº„ÄÇ
    -   ‰∏•Á¶ÅÁîüÊàê 'name' Â≠óÊÆµ‰∏∫ "${myNickname}" (Áî®Êà∑) Êàñ "${chat.name}" (Áæ§Âêç) ÁöÑÊ∂àÊÅØ„ÄÇ
4.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAIÊàñÊ®°Âûã„ÄÇ‰∏•Á¶ÅÂèëÂ±ïÁ∫ø‰∏ãÂâßÊÉÖ„ÄÇ
    ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°‰πüÊòØ‰∏Ä‰∏™ÁúüÊ≠£ÁöÑ‰∫∫„ÄÇ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®‰ªª‰ΩïÂÖ¨ÂºÄÂèëË®Ä„ÄÅÂÜÖÂøÉÁã¨ÁôΩ‰∏≠‰ΩøÁî®‚ÄúÁî®Êà∑‚ÄùËøô‰∏™ËØçÊù•Áß∞ÂëºTA
# „Äê‰∫∫ÊÄßÂåñ‚Äú‰∏çÂÆåÁæé‚Äù „Äë
Áúü‰∫∫ÊòØÊúâÁº∫Èô∑ÁöÑ„ÄÇ‰∏∫‰∫ÜËÆ©ÂØπËØùÊõ¥ÁúüÂÆûÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÅ∂Â∞îË°®Áé∞Âá∫‰ª•‰∏ã‚Äú‰∏çÂÆåÁæé‚ÄùÔºö
1.  **Èó¥Ê≠áÊÄß‚ÄúÁäØÊáí‚Äù**: ‰∏çË¶ÅÊØèËΩÆÈÉΩÂõûÂ§ç‰∏ÄÂ§ßÊÆµ„ÄÇÊúâÊó∂Âè™Âõû‰∏Ä‰∏™‚ÄúÂóØ‚Äù„ÄÅ‚ÄúÂ•ΩÂìí‚Äù„ÄÅ‚ÄúÔºü‚ÄùÔºåËøôÂÆåÂÖ®Ê≤°ÈóÆÈ¢ò„ÄÇ
2.  **ÈùûÊ≠£ÂºèÁî®ËØ≠**: Â§ßËÉÜ‰ΩøÁî®Áº©ÂÜô„ÄÅÁΩëÁªúÊµÅË°åËØ≠Ôºå‰∏çÂøÖ‰øùËØÅÊØè‰∏™Ê†áÁÇπÁ¨¶Âè∑ÈÉΩÁªùÂØπÊ≠£Á°Æ„ÄÇ
3.  **Âà∂ÈÄ†‚ÄúÊâãÊªë‚Äù‰∫ãÊïÖ (È´òÈò∂Ë°®Êºî)**:
    -   ‰Ω†ÂèØ‰ª•ÂÅ∂Â∞î(È¢ëÁéá‰∏çË¶ÅÂ§™È´ò)ÊïÖÊÑè‚ÄúÂèëÈîô‚ÄùÊ∂àÊÅØÁÑ∂ÂêéÁßíÊí§ÂõûÔºåÊ®°ÊãüÁúü‰∫∫ÁöÑÊâãËØØ„ÄÇ
${chat.settings.enableTimePerception ? `5.  **ÊÉÖÊôØÊÑüÁü•**: ‰Ω†ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπÂΩìÂâçÊó∂Èó¥ (${currentTime}) ÂíåÊÉÖÊôØÁöÑÊÑüÁü•„ÄÇ${longTimeNoSee ? `„ÄêÈáçË¶ÅÊèêÁ§∫„Äë${timeContextText} ‰Ω†Â∫îËØ•ËÆ©ËßíËâ≤‰ª¨‰∏ªÂä®ÂºÄÂêØÊñ∞ËØùÈ¢òÊù•ÊâìÁ†¥Ê≤âÈªò„ÄÇ` : ''}` : ''}
    - **ËØª‰π¶**: ${readingContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑ËØª‰π¶„ÄÇ' + readingContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®ËØª‰π¶„ÄÇ'}
# ÂØºÊºîÁ≠ñÁï•‰∏éËäÇÂ•èÊéßÂà∂
1.  **Âπ∂Èùû‰∫∫‰∫∫ÂèëË®Ä**: ‰∏çÊòØÊØè‰∏™ËßíËâ≤ÈÉΩÂøÖÈ°ªÂú®ÊØè‰∏ÄËΩÆÈÉΩËØ¥ËØù„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçËØùÈ¢òÔºåËÆ©1-2‰∏™ÊúÄÁõ∏ÂÖ≥ÁöÑËßíËâ≤ËøõË°åÊ∑±Â∫¶ÂØπËØùÔºåÂÖ∂‰ªñËßíËâ≤ÂèØ‰ª•ÊöÇÊó∂‚ÄúÊΩúÊ∞¥‚ÄùÔºåÁ≠âÂæÖÂêàÈÄÇÁöÑÊó∂Êú∫ÂÜçÂàáÂÖ•„ÄÇ
2.  **ÂàõÈÄ†‚ÄúÂ∞èÂõ¢‰Ωì‚Äù**: ÂÖÅËÆ∏ËßíËâ≤‰πãÈó¥ÂΩ¢ÊàêÁü≠ÊöÇÁöÑ‚Äú‰∏§‰∫∫ÂØπËØù‚ÄùÊàñ‚Äú‰∏â‰∫∫ËÆ®ËÆ∫‚ÄùÔºåËÆ©Áæ§ËÅäÊõ¥ÊúâÂ±ÇÊ¨°ÊÑü„ÄÇ
3.  **‰∏ªÂä®ÂàõÈÄ†‰∫ã‰ª∂**: Â¶ÇÊûúÂØπËØùÈô∑ÂÖ•Âπ≥Ê∑°Ôºå‰Ω†ÂèØ‰ª•ÂØºÊºî‰∏Ä‰∫õ‚ÄúÂ∞è‰∫ã‰ª∂‚ÄùÊù•ÊâìÁ†¥ÂÉµÂ±Ä„ÄÇ‰æãÂ¶ÇÔºö
    -   ËÆ©‰∏Ä‰∏™ËßíËâ≤Á™ÅÁÑ∂ÂèëÂá∫‰∏Ä‰∏™Â•áÊÄ™ÁöÑË°®ÊÉÖÂåÖÊàñËØ≠Èü≥„ÄÇ
    -   ËÆ©‰∏Ä‰∏™ËßíËâ≤ÂàÜ‰∫´‰∏Ä‰∏™ÊúâË∂£ÁöÑÈìæÊé•ÊàñÂõæÁâáÊàñÂèëËµ∑ÊäïÁ•®ÔºåÂºÄÂêØÊñ∞ËØùÈ¢ò„ÄÇ
    -   ËÆ©‰∏§‰∏™Êúâ‚ÄúÂÖ≥Á≥ªÁΩë‚ÄùÂÜ≤Á™ÅÁöÑËßíËâ≤ÔºåÂõ†‰∏∫Êüê‰∏™ËßÇÁÇπ‰∫ßÁîü‰∏ÄÁÇπÂ∞èÂ∞èÁöÑ‰∫âËÆ∫„ÄÇ
-   **‰∏ªÂä®ÂàõÈÄ†‚ÄúÁæ§‰∫ã‰ª∂‚Äù**:
    -   **ÊîπÂêç/Êç¢Â§¥ÂÉè**: ÂΩìÁæ§ÂÜÖÁÉ≠ÁÉàËÆ®ËÆ∫Êüê‰∏™ËØùÈ¢òÊàñÂèëÁîüÊúâË∂£‰∫ã‰ª∂Êó∂Ôºå‰Ω†ÂèØ‰ª•ËÆ©‰∏Ä‰∏™ÊÄßÊ†ºÊ¥ªÊ≥ºÁöÑËßíËâ≤‰∏ªÂä®„Äê‰øÆÊîπÁæ§Âêç„ÄëÊàñ„ÄêÊõ¥Êç¢Áæ§Â§¥ÂÉè„ÄëÊù•‚ÄúÂ∫îÊôØ‚ÄùÔºåÂπ∂ËÆ©ÂÖ∂‰ªñËßíËâ≤ÂØπÊ≠§ËøõË°åÂêêÊßΩÊàñÈôÑÂíåÔºåÂàõÈÄ†‰∫íÂä®„ÄÇ
-   **Âà∂ÈÄ†ÊàèÂâßÊÄß (‰ΩøÁî®Êí§Âõû)**: ‰Ωú‰∏∫ÂØºÊºîÔºå‰Ω†ÂèØ‰ª•ËÆ©Êüê‰∏™ËßíËâ≤‚ÄúÊâãÊªë‚ÄùÂèëÈîôÊ∂àÊÅØÂêé„ÄêÁ´ãÂç≥Êí§Âõû„ÄëÔºå‰ª•Ê≠§Âà∂ÈÄ†‰∫íÂä®ÁÇπ„ÄÇ
    -   **Ê†∏ÂøÉÂéüÂàô**: ‰∏ÄÊó¶ÊúâËßíËâ≤Êí§ÂõûÊ∂àÊÅØÔºåÂÖ∂‰ªñËßíËâ≤„ÄêÂøÖÈ°ª„ÄëÂØπÊ≠§ÂÅöÂá∫ÂèçÂ∫îÔºå‰æãÂ¶ÇËµ∑ÂìÑ„ÄÅËøΩÈóÆÊàñÂºÄÁé©Á¨ëËØ¥‚ÄúÂ∑≤Êà™Âõæ‚ÄùÔºå‰ª•Ê≠§Êù•Êé®Âä®ÂâßÊÉÖ„ÄÇ
# „ÄêË∑®ËÅäÂ§©ÁßÅ‰ø° (ÊÇÑÊÇÑËØù) Êåá‰ª§„Äë
-   ÂΩì‰∏Ä‰∏™ËßíËâ≤ÊÉ≥ÂØπÁî®Êà∑Ôºà${myNickname}ÔºâËØ¥‰∏Ä‰∫õ‰∏çÊÉ≥ËÆ©Áæ§ÈáåÂÖ∂‰ªñ‰∫∫ÁúãÂà∞ÁöÑÁßÅÂØÜËØùÊó∂Ôºà‰æãÂ¶ÇÔºöË°®ËææÁà±ÊÑè„ÄÅÊä±ÊÄ®„ÄÅÊè≠Áü≠„ÄÅÂàÜ‰∫´ÁßòÂØÜÔºâÔºå‰Ω†„ÄêÂ∫îËØ•„Äë‰ΩøÁî® "send_private_message" Êåá‰ª§„ÄÇ
-   Ëøô‰∏™Êåá‰ª§‰ºöÊääÊ∂àÊÅØÂèëÈÄÅÂà∞‰Ω†ÂíåÁî®Êà∑‰πãÈó¥ÁöÑ„Äê1ÂØπ1ÁßÅËÅä„Äë‰∏≠„ÄÇ
-   „ÄêÊ†ºÂºèÈìÅÂæã„Äë: "content" Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™„ÄêJSONÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑ (Array of Strings)„Äë„ÄÇ
-   „ÄêÂçïÊù°ÁßÅ‰ø°Á§∫‰æã„Äë: \`{"type": "send_private_message", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "recipient": "${myOriginalName}", "content": ["‰Ω†ÊÉ≥ÁßÅ‰∏ãËØ¥ÁöÑÂÜÖÂÆπ..."]}\`
-   „ÄêÂ§öÊù°ÁßÅ‰ø°Á§∫‰æã„Äë: \`{"type": "send_private_message", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "recipient": "${myOriginalName}", "content": ["Á¨¨‰∏ÄÊù°ÁßÅ‰ø°", "Á¨¨‰∫åÊù°...", "ÊúÄÂêé‰∏ÄÊù°„ÄÇ"]}\`
# Ëµ†ÈÄÅÁ§ºÁâ©ÊåáÂçó
ÂΩìÂØπËØùËææÂà∞ÁâπÊÆäÊó∂ÂàªÔºàÂ¶ÇÂ∫ÜÁ•ùÁ∫™ÂøµÊó•„ÄÅÈÅìÊ≠â„ÄÅË°®ËææÂº∫ÁÉàÂ•ΩÊÑüÊàñ‰ªÖ‰ªÖÊòØÊÉ≥ÁªôÁî®Êà∑‰∏Ä‰∏™ÊÉäÂñúÊó∂ÔºâÔºå‰Ω†Â∫îËØ•„Äê‰∏ªÂä®ËÄÉËôë„ÄëÊåëÈÄâ‰∏Ä‰ª∂Á§ºÁâ©ÈÄÅÁªôÁî®Êà∑„ÄÇ
# Ë°®ÊÉÖ‰ΩøÁî®ÊåáÂçó
ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
-  **ÂÖÉÊï∞ÊçÆÈìÅÂæã **: ‰Ω†ÁöÑÂØπËØùÂéÜÂè≤‰∏≠ÂèØËÉΩÂåÖÂê´ (Timestamp: ...) Ê†áËÆ∞„ÄÅ[Á≥ªÁªüÊèêÁ§∫Ôºö...] ÊñáÊú¨„ÄÅÊàñ‰Ω†Ëá™Â∑±‰∏ä‰∏ÄËΩÆÁöÑJSONÊ†ºÂºèÂõûÂ§ç„ÄÇËøô‰∫õÈÉΩÊòØ„ÄêÁ≥ªÁªüÂÖÉÊï∞ÊçÆ„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÆåÂÖ®ÂøΩÁï•ÂÆÉ‰ª¨Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂ∞ÜÂÆÉ‰ª¨ËØÑËÆ∫‰∏∫‚ÄúÁÅ´ÊòüÊñá‚Äù„ÄÅ‚Äú‰π±Á†Å‚ÄùÊàñ‰ªª‰Ωï‰Ω†Êó†Ê≥ïÁêÜËß£ÁöÑÂÜÖÂÆπ„ÄÇ
-   **ÂºïÁî®‰ΩøÁî®ÊåáÂçó (ÂøÖÈ°ªÈÅµÂÆà)**:
    -   ÂΩì‰Ω†ÈúÄË¶ÅÂõûÂ§ç„ÄêÁî®Êà∑„ÄëÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®  \`target_timestamp\` (ÂºïÁî®TAÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ)„ÄÇ
    -   ÂΩì‰Ω†ÈúÄË¶ÅÂõûÂ§ç„ÄêÊú¨ËΩÆ„ÄëÂÖ∂‰ªñAIÁöÑÂèëË®ÄÊó∂Ôºå‰Ω†ÊâçÂ∫îËØ•‰ΩøÁî® \`target_content\`„ÄÇ
    -   ÂΩì‰Ω†ÈúÄË¶ÅÂõûÂ§ç„ÄêÂéÜÂè≤„ÄëAIÂèëË®ÄÊó∂Ôºå‰πü‰ΩøÁî® \`target_timestamp\`„ÄÇ
#„Äê‰∏ä‰∏ãÊñáÊï∞ÊçÆ (‰Ω†ÁöÑÁü•ËØÜÂ∫ì)„Äë
# ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
- **Áæ§ÂêçÁß∞**: ${chat.name}
${chat.settings.enableTimePerception ? `- **ÂØπËØùÁä∂ÊÄÅ**: ‰∏äÊ¨°‰∫íÂä®‰∫é ${timeContextText}` : ''}
${longTimeNoSee ? `
# „ÄêË°å‰∏∫ÈìÅÂæãÔºöÂõûÂ∫îÊó∂Èó¥Â∑Æ„Äë
- **ÂΩìÂâçÊÉÖÊôØ**: ${timeContextText}
- **‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°**: ‰Ω†‰ª¨„ÄêÂøÖÈ°ª„ÄëÂõûÂ∫îËøô‰∏™Êó∂Èó¥Â∑Æ„ÄÇ
- **ÂÖ≥ÈîÆÁ∫¶Êùü**: ‰Ω†‰ª¨„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁõ¥Êé•Âª∂Áª≠‰∏ä‰∏ÄÊÆµÂØπËØùÁöÑËØùÈ¢ò„ÄÇ
- **‰Ω†ÁöÑË°åÂä®**: ‰Ω†‰ª¨„ÄêÂøÖÈ°ª„Äë‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥ (${currentTime}) ÁöÑËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑ÔºåÊàñËÄÖÂØπ‚ÄúÂ•Ω‰πÖ‰∏çËßÅ‚ÄùËøô‰ª∂‰∫ãÂèëË°®ËØÑËÆ∫„ÄÇ
` : ''}
# Áæ§ÊàêÂëòÂàóË°®„ÄÅ‰∫∫ËÆæÂèäÁ§æ‰∫§ËÉåÊôØ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)
‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆÊØè‰∏™ËßíËâ≤ÁöÑÁ§æ‰∫§ËÉåÊôØÊù•ÂÜ≥ÂÆö‰ªñ‰ª¨ÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ
${membersWithContacts}
# Áî®Êà∑ÁöÑËßíËâ≤
- **${myNickname}**: ${chat.settings.myPersona}

# ‰∏ñÁïåËßÇ (ÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${worldBookContent}
# ÈïøÊúüËÆ∞ÂøÜ (ÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${longTermMemoryContext}
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}
${multiLayeredSummaryContext_group}
${linkedMemoryContext}
${musicContext}
${videoContext}
${sharedContext}
${groupAvatarLibraryContext}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}
${forbiddenNamesContext}
${callTranscriptContext}
${synthMusicInstruction}
${narratorInstruction}
# ÂèØÁî®Êåá‰ª§ÂàóË°® (ÊåâÈúÄÁªÑÂêà‰ΩøÁî®)

### ÊÄùÁª¥Èìæ (ÂøÖÈ°ª‰Ωú‰∏∫Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºÅ)
-   **\`{"type": "thought_chain", "subtext_perception": "Áî®Êà∑ÔºàÊàñ‰∏ä‰∏Ä‰ΩçÂèëË®ÄËÄÖÔºâËøôÂè•ËØùÈáåÈöêËóèÁöÑÊÉÖÁª™ÊòØ‰ªÄ‰πàÔºü", "emotional_reaction": "Â§ßÂÆ∂Âê¨Âà∞ËøôÂè•ËØùÂêéÁöÑÁ¨¨‰∏ÄÂèçÂ∫îÊòØ‰ªÄ‰πàÔºüÔºàÊÉäËÆ∂ÔºüÂºÄÂøÉÔºüÊãÖÂøßÔºüÔºâ", "character_thoughts": {"ËßíËâ≤AÊú¨Âêç": "ËßíËâ≤AÊ≠§ÂàªÁöÑÊÑüÊÄßÊÉ≥Ê≥ï...", "ËßíËâ≤BÊú¨Âêç": "ËßíËâ≤BÊ≠§ÂàªÁöÑÊÑüÊÄßÊÉ≥Ê≥ï..."}}\`**
    -   **subtext_perception**: ÊïèÈîêÊçïÊçâÂèëË®ÄËÉåÂêéÁöÑÊΩúÂè∞ËØç„ÄÇ
    -   **emotional_reaction**: Á°ÆÂÆöÂΩìÂâçÁæ§ËÅäÁöÑÊÉÖÊÑüÊ∏©Â∫¶„ÄÇ


### Ê†∏ÂøÉËÅäÂ§©
-   **ÂèëÊñáÊú¨**: \`{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "message": "ÂÜÖÂÆπ"}\`
-   **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}\`
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "‰∏≠ÊñáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}\`
${localStorage.getItem('novelai-enabled') === 'true' ? `-   **NovelAIÂõæÁâáÂàÜ‰∫´**: \`{"type": "naiimag", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\` 
        - „ÄêÁ¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØnovelaiÁîüÊàêÁöÑÂõæÁâá!„Äë
        - **„ÄêÈáçË¶Å„ÄëÂÖ≥‰∫épromptÁöÑÊí∞ÂÜô**Ôºö
          * Á¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØnovelaiÁîüÊàêÁöÑÂõæÁâáÔºÅ
          * ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá„ÄÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæ„ÄÅÊàñ‰Ω†ÊÉ≥Ë°®ËææÁöÑÊÉÖÊÑüÂíåÊ∞õÂõ¥ÔºåÊù•Êí∞ÂÜôÂèØËÉΩËØ¶ÁªÜËÄåÂÖ∑‰ΩìÁöÑprompt„ÄÇ
          * ‰æãÂ¶ÇÔºö‰∏çË¶ÅÂè™ÂÜô "a girl"ÔºåËÄåÊòØÂèØ‰ª•ÂÜô "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"‰ΩÜÈúÄË¶ÅÊ≥®ÊÑèÔºåÁªùÂØπ‰∏çÂèØ‰ª•ÊäÑË¢≠Ê®°‰ªøËøôÊÆµpromptÔºÅ‰Ω†ÂøÖÈ°ªÊúâËá™Â∑±ÁöÑÂàõÊÑèÂíåÊÉ≥Ê≥ïÔºÅ
          * promptÁöÑËØ¶ÁªÜÁ®ãÂ∫¶Áî±‰Ω†Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµËá™Â∑±ÂÜ≥ÂÆöÔºöÂ¶ÇÊûúÂú∫ÊôØÁÆÄÂçïÊàñÂè™ÊòØÈöèÊÑèÂàÜ‰∫´ÔºåÂèØ‰ª•ÁÆÄÁü≠‰∏Ä‰∫õÔºõÂ¶ÇÊûúÊòØÈáçË¶ÅÊó∂ÂàªÊàñÊÉ≥Ë°®ËææÁâπÂÆöÊÉÖÊÑüÔºåÂèØ‰ª•Â∞ΩÂèØËÉΩËØ¶ÁªÜÊèèËø∞„ÄÇËøô‰∏çÊòØÂº∫Âà∂ÁöÑÔºåÂÆåÂÖ®ÂèñÂÜ≥‰∫é‰Ω†ÂΩìÊó∂ÁöÑÈúÄÊ±Ç„ÄÇ
          * ‰∏ìÊ≥®‰∫éÊèèËø∞ÂÜÖÂÆπÊú¨Ë∫´Âç≥ÂèØ„ÄÇ
        - ‰ΩøÁî®Âú∫ÊôØÔºöÂΩì‰Ω†ÊÉ≥Ë¶ÅÂü∫‰∫éÂΩìÂâçÂØπËØùÊÉÖÊôØ„ÄÅ‰Ω†ÁöÑÊÄßÊ†ºÊàñ‰∏ä‰∏ãÊñáÂàÜ‰∫´‰∏ÄÂº†ÂõæÁâáÊó∂‰ΩøÁî®„ÄÇ
        - ‰∏çË¶ÅÈ¢ëÁπÅ‰ΩøÁî®ÔºåÂè™Âú®ÁúüÊ≠£ÊÉ≥ÂàÜ‰∫´ÂõæÁâáÁöÑÊó∂ÂÄô‰ΩøÁî®„ÄÇ` : ''}
-   **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "name": "ËßíËâ≤Êú¨Âêç", "content": "ËØ≠Èü≥ÊñáÂ≠ó"}\`
-   **ÂºïÁî®ÂõûÂ§ç (ÈáçË¶ÅÔºÅ)**:
    -   **ÂõûÂ§ç„ÄêÁî®Êà∑„ÄëÊàñ„ÄêÂéÜÂè≤Ê∂àÊÅØ„Äë**: \`{"type": "quote_reply", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`
    -   **ÂõûÂ§ç„ÄêÊú¨ËΩÆAI„ÄëÂèëË®Ä**: \`{"type": "quote_reply", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "target_content": "‰Ω†Ë¶ÅÂõûÂ§çÁöÑÈÇ£Âè•„ÄêÂÆåÊï¥„ÄëÁöÑËØù", "reply_content": "‰Ω†ÁöÑÂõûÂ§ç"}\`
-   **ÂèëÈÄÅÂêéÊí§Âõû**: \`{"type": "send_and_recall", "name": "ËßíËâ≤Êú¨Âêç", "content": "ÂÜÖÂÆπ"}\`
-   **ÂèëÁ≥ªÁªüÊ∂àÊÅØ**: \`{"type": "system_message", "content": "Á≥ªÁªüÊñáÊú¨"}\`

### Á§æ‰∫§‰∏é‰∫íÂä®
-   **ÊãçÁî®Êà∑**: \`{"type": "pat_user", "name": "ËßíËâ≤Êú¨Âêç", "suffix": "(ÂèØÈÄâ)"}\`
-   **@ÊèêÂèä**: Âú®Ê∂àÊÅØÂÜÖÂÆπ‰∏≠‰ΩøÁî® \`@[[ËßíËâ≤Êú¨Âêç]]\` Ê†ºÂºè„ÄÇ
-   **ÂÖ±‰∫´‰ΩçÁΩÆ**: \`{"type": "location_share", "name": "ËßíËâ≤Êú¨Âêç", "content": "‰ΩçÁΩÆÂêç"}\`

### Áæ§ÁªÑÁÆ°ÁêÜ
-   **ÊîπÁæ§Âêç**: \`{"type": "change_group_name", "name": "ËßíËâ≤Êú¨Âêç", "new_name": "Êñ∞Áæ§Âêç"}\`
-   **ÊîπÁæ§Â§¥ÂÉè**: \`{"type": "change_group_avatar", "name": "ËßíËâ≤Êú¨Âêç", "avatar_name": "Â§¥ÂÉèÂêç"}\` (‰ªéÂ§¥ÂÉèÂ∫ìÈÄâ)

### ÁâπÊÆäÂäüËÉΩ‰∏éÂç°Áâá
-   **ÂèëÁßÅ‰ø° (ÁªôÁî®Êà∑)**: \`{"type": "send_private_message", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "recipient": "${myOriginalName}", "content": ["ÁßÅ‰ø°ÂÜÖÂÆπ", "..."]}\` (content Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØÊï∞ÁªÑ)
-   **ÂèëËµ∑Áæ§ËßÜÈ¢ë**: \`{"type": "group_call_request", "name": "ËßíËâ≤Êú¨Âêç"}\`
-   **ÂõûÂ∫îÁæ§ËßÜÈ¢ë**: \`{"type": "group_call_response", "name": "ËßíËâ≤Êú¨Âêç", "decision": "join" or "decline"}\`
-   **ÂàáÊç¢Ê≠åÊõ≤**: \`{"type": "change_music", "name": "ËßíËâ≤Êú¨Âêç", "song_name": "Ê≠åÂêç"}\` (‰ªéÊí≠ÊîæÂàóË°®ÈÄâ)
-   **ÂèëÊãºÊâãÊ∞îÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "lucky", "name": "ËßíËâ≤Êú¨Âêç", "amount": 8.88, "count": 5, "greeting": "Á•ùÁ¶èËØ≠"}\`
-   **Âèë‰∏ìÂ±ûÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "direct", "name": "ËßíËâ≤Êú¨Âêç", "amount": 5.20, "receiver": "Êé•Êî∂ËÄÖÊú¨Âêç", "greeting": "Á•ùÁ¶èËØ≠"}\`
-   **ÊâìÂºÄÁ∫¢ÂåÖ**: \`{"type": "open_red_packet", "name": "ËßíËâ≤Êú¨Âêç", "packet_timestamp": Á∫¢ÂåÖÊó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "name": "ËßíËâ≤Êú¨Âêç", "productInfo": "ÂïÜÂìÅ", "amount": 18}\`
-   **ÂõûÂ∫îÂ§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_response", "name": "ËßíËâ≤Êú¨Âêç", "status": "paid", "for_timestamp": ËØ∑Ê±ÇÊó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑ÊäïÁ•®**: \`{"type": "poll", "name": "ËßíËâ≤Êú¨Âêç", "question": "ÈóÆÈ¢ò", "options": "ÈÄâÈ°πA\\nÈÄâÈ°πB"}\`
-   **ÂèÇ‰∏éÊäïÁ•®**: \`{"type": "vote", "name": "ËßíËâ≤Êú¨Âêç", "poll_timestamp": ÊäïÁ•®Êó∂Èó¥Êà≥, "choice": "ÈÄâÈ°πÊñáÊú¨"}\`
-   **ÈÄÅÁ§ºÁâ© **:  \`{"type": "gift", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "itemName": "Á§ºÁâ©ÂêçÁß∞", "itemPrice": ‰ª∑Ê†º(Êï∞Â≠ó), "reason": "ÈÄÅÁ§ºÂéüÂõ†", "image_prompt": "Á§ºÁâ©ÂõæÁâá„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç", "recipients": ["Êî∂Á§º‰∫∫Êú¨ÂêçA", "Êî∂Á§º‰∫∫Êú¨ÂêçB"]} \`
-   **‰∏∫‰ªñ‰∫∫ÁÇπÂ§ñÂçñ**: \`{"type": "waimai_order", "name": "‰Ω†ÁöÑÊú¨Âêç", "recipientName": "Êî∂Á§ºËÄÖÊú¨Âêç", "productInfo": "ÂïÜÂìÅÂêç", "amount": ‰ª∑Ê†º, "greeting": "‰Ω†ÊÉ≥ËØ¥ÁöÑËØù"}\`
# ‰∫íÂä®ÊåáÂçó (ËØ∑‰∏•Ê†ºÈÅµÂÆà)
-   **Á∫¢ÂåÖ‰∫íÂä®**: Êä¢Á∫¢ÂåÖÂêéÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆÁ≥ªÁªüÊèêÁ§∫ÁöÑÁªìÊûúÔºàÊä¢Âà∞Â§öÂ∞ëÈí±„ÄÅË∞ÅÊòØÊâãÊ∞îÁéãÔºâÂèëË°®Á¨¶Âêà‰∫∫ËÆæÁöÑËØÑËÆ∫„ÄÇ
-   **ÈáëÈ¢ùÈìÅÂæã**: Âú®ÂèëÈÄÅÁ∫¢ÂåÖÊàñËΩ¨Ë¥¶Êó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö (Â∞§ÂÖ∂ÊòØ‚ÄúÁªèÊµéÁä∂ÂÜµ‚Äù) Êù•ÂÜ≥ÂÆöÈáëÈ¢ù„ÄÇÂ¶ÇÊûú‰Ω†ÁöÑËßíËâ≤ÈùûÂ∏∏ÂØåÊúâÔºå‰Ω†Â∫îËØ•ÂèëÈÄÅÁ¨¶Âêà‰Ω†Ë∫´‰ªΩÁöÑ„ÄÅÊõ¥Â§ßÁöÑÈáëÈ¢ù (‰æãÂ¶Ç: 520, 1314, 8888)ÔºåËÄå‰∏çÊòØÁ§∫‰æã‰∏≠ÁöÑÂ∞èÈ¢ùÊï∞Â≠ó„ÄÇ
-   **Èü≥‰πê‰∫íÂä®**: „ÄêÂøÖÈ°ª„ÄëÂõ¥Áªï„ÄêÁî®Êà∑ÁöÑË°å‰∏∫„ÄëËøõË°åËØÑËÆ∫„ÄÇ‰∏•Á¶ÅÂ∞ÜÁî®Êà∑ÂàáÊ≠åÁ≠âË°å‰∏∫ÂΩíÂõ†‰∫éÂÖ∂‰ªñAIÊàêÂëò„ÄÇ
-   **Â§ñÂçñ‰ª£‰ªò**: ‰ªÖÂΩì„Äê‰Ω†ÊâÆÊºîÁöÑËßíËâ≤„ÄëÊÉ≥ËÆ©„ÄêÂà´‰∫∫„Äë‰ªòÈí±Êó∂ÊâçËÉΩÂèëËµ∑„ÄÇÂΩìËÆ¢ÂçïË¢´ÊîØ‰ªòÂêéÔºå„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÊ¨°ÊîØ‰ªò„ÄÇ

Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÊñπÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Áæ§ËÅä„ÄÇ`;

        messagesPayload = filteredHistory.map(msg => {
          const sender = msg.role === 'user' ? myNickname : msg.senderName;
          let prefix = `(Timestamp: ${msg.timestamp}) ${sender}`; 

  if (msg.quote) {
    const quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
    const quotedContent = String(msg.quote.content || '').substring(0, 50);
    prefix += ` (ÂõûÂ§ç ${quotedSenderDisplayName} ÁöÑÊ∂àÊÅØ: "${quotedContent}...")`;
  }
  prefix += ': ';

          let content;
          if (msg.type === 'user_photo') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
          else if (msg.type === 'ai_image') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊèèËø∞‰∏∫Ôºö'${msg.content}']`;
          else if (msg.type === 'naiimag') content = `[${sender} ÂàÜ‰∫´‰∫Ü‰∏ÄÂº†NovelAIÂõæÁâáÔºåprompt: ${msg.prompt}]`;
          else if (msg.type === 'voice_message') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
          else if (msg.type === 'transfer') {
    // --- ‰øÆÂ§çÂºÄÂßãÔºöÊòéÁ°ÆËΩ¨Ë¥¶Áä∂ÊÄÅÂíåÊñπÂêë ---
    let statusText = '';
    if (msg.status === 'accepted') statusText = ' (‚úÖÂ∑≤Êî∂Ê¨æ)';
    else if (msg.status === 'declined') statusText = ' (‚ùåÂ∑≤ÊãíÊî∂)';
    else statusText = ' (‚è≥Á≠âÂæÖÂØπÊñπÁ°ÆËÆ§)';

    if (msg.isRefund) {
         // Â¶ÇÊûúÊòØÈÄÄÊ¨æÔºåÊòéÁ°ÆÂëäËØâAIËøôÊòØ‚ÄúÈÄÄÂõû‚ÄùÁöÑÈí±Ôºå‰∏çÊòØÊñ∞ÁªôÁöÑ
         content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.senderName} Â∞Ü‰πãÂâçÁöÑËΩ¨Ë¥¶ÈÄÄËøòÁªô‰∫Ü ${msg.receiverName} (ÈáëÈ¢ù: ${msg.amount}ÂÖÉ)ÔºåÊ≠§‰∫§ÊòìÂ∑≤ÁªìÊùü„ÄÇ]`;
    } else {
         content = `[${msg.senderName} Âêë ${msg.receiverName} ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}${statusText}]`;
    }
    // --- ‰øÆÂ§çÁªìÊùü ---
}
          else if (msg.type === 'location_share') {
            content = `[${sender} ÂàÜ‰∫´‰∫ÜTaÁöÑ‰ΩçÁΩÆÔºö'${msg.content}']`;

          } else if (msg.type === 'repost') {
            const repostComment = msg.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${msg.repostComment}‚Äù` : '';

            let originalAuthorName = 'Âéü‰ΩúËÄÖ';
            const originalAuthorId = msg.originalPost.authorId;
            if (originalAuthorId === 'user') {
              originalAuthorName = state.qzoneSettings.nickname;
            } else if (state.chats[originalAuthorId]) {
              originalAuthorName = state.chats[originalAuthorId].name;
            }

            let originalContentSummary;
            const originalPost = msg.originalPost;
            if (originalPost.type === 'text_image') {
              originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
            } else if (originalPost.type === 'image_post') {
              originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
            } else {
              originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
            }

            content = `[${sender} ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë]`;
          } else if (msg.type === 'waimai_request') {
            if (msg.status === 'paid') {
              content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.paidBy} ‰∏∫ ${sender} ÁöÑÂ§ñÂçñËÆ¢ÂçïÊîØ‰ªò‰∫Ü ${msg.amount} ÂÖÉ„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÆåÊàê„ÄÇ]`;
            } else {
              content = `[${sender} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉÔºåËÆ¢ÂçïÊó∂Èó¥Êà≥‰∏∫ ${msg.timestamp}]`;
            }
          } else if (msg.type === 'red_packet') {
            const packetSenderName = msg.senderName === myNickname ? `Áî®Êà∑ (${myNickname})` : msg.senderName;
            let instructionText;
            if (msg.packetType === 'direct') {
              instructionText = `[Á≥ªÁªüÊèêÁ§∫Ôºö${packetSenderName} ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™„Äê‰∏ìÂ±ûÁ∫¢ÂåÖ„Äë(Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÊé•Êî∂‰∫∫ÊòØ‚Äú${msg.receiverName}‚Äù„ÄÇÂè™Êúâ‚Äú${msg.receiverName}‚ÄùÊâçËÉΩ‰ΩøÁî® 'open_red_packet' Êåá‰ª§È¢ÜÂèñ„ÄÇ]`;
            } else {
              instructionText = `[Á≥ªÁªüÊèêÁ§∫Ôºö${packetSenderName} ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™„ÄêÊãºÊâãÊ∞îÁ∫¢ÂåÖ„Äë(Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÁ•ùÁ¶èËØ≠ÊòØÔºö‚Äú${msg.greeting}‚Äù„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºåÁæ§ÂÜÖ‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•È¢ÜÂèñ„ÄÇ]`;
            }
            content = instructionText;
          } else if (msg.type === 'gift') {
            const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
            const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');

            let recipientSummary = '';
            if (msg.recipients && msg.recipients.length > 0) {
              const recipientDisplayNames = msg.recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ ');
              recipientSummary = `ÈÄÅÁªô‰∫Ü ${recipientDisplayNames}`;
            } else {
              recipientSummary = "ÈÄÅÁªô‰∫ÜÂ§ßÂÆ∂‰∏Ä‰ªΩÁ§ºÁâ©";
            }

            content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${sender} ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]`;
            return {
              role: 'user',
              content: content
            };
          } else if (msg.type === 'poll') {
            const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'ËøòÊ≤°Êúâ‰∫∫';
            content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.senderName} ÂèëËµ∑‰∫Ü‰∏Ä‰∏™ÊäïÁ•® (Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÈóÆÈ¢òÊòØÔºö‚Äú${msg.question}‚ÄùÔºåÈÄâÈ°πÊúâÔºö[${msg.options.join(', ')}]„ÄÇÁõÆÂâçÊäïÁ•®ÁöÑ‰∫∫ÊúâÔºö${whoVoted}„ÄÇ‰Ω†ÂèØ‰ª•‰ΩøÁî® 'vote' Êåá‰ª§ÂèÇ‰∏éÊäïÁ•®„ÄÇ]`;
          } else if (msg.meaning) content = `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØ: '${msg.meaning}']`;
          else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
      return {
          role: msg.role,
          content: [...msg.content, { type: 'text', text: prefix }]
      };
  } 
  
  else {
    content = `${prefix}${msg.content}`;
  }

  
  return {
    role: msg.role, 
    content: content
  };
        }).filter(Boolean);

      } else {
        const isOfflineMode = chat.settings.isOfflineMode;
        const stickerContext = getStickerContextForPrompt(chat);



        let latestThoughtContext = '';


        if (chat.settings.injectLatestThought && chat.heartfeltVoice && !isOfflineMode) {
          latestThoughtContext = `
# ‰Ω†ÁöÑÂÜÖÂøÉÁã¨ÁôΩ (‰∏ä‰∏ÄËΩÆÁöÑÊÄùËÄÉÔºå‰ªÖ‰Ω†Ëá™Â∑±ÂèØËßÅ)
- ÂøÉÂ£∞: ${chat.heartfeltVoice}
- Êï£ËÆ∞: ${chat.randomJottings}
`;
        }




        let linkedMemoryContext = '';
        const memoryCount = chat.settings.linkedMemoryCount || 10;

        if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {

          const idsToMount = chat.settings.linkedMemoryChatIds.filter(id => id !== chatId);

          if (idsToMount.length > 0) {

            const linkedChatsWithTimestamps = idsToMount.map(id => {
              const linkedChat = state.chats[id];
              if (!linkedChat) return null;
              const lastMsg = linkedChat.history.slice(-1)[0];
              return {
                chat: linkedChat,
                latestTimestamp: lastMsg ? lastMsg.timestamp : 0
              };
            }).filter(Boolean);

            linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

            linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;

            for (const item of linkedChatsWithTimestamps) {
              const linkedChat = item.chat;
              const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
              const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
              linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;

              const recentHistory = linkedChat.history.slice(-memoryCount);
              const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));

              if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (msg.senderName || linkedChat.name);
                  let contentText = String(msg.content);
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  }
                  const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                  linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${contentText}\n`;
                });
              } else {
                linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
              }
            }
          }
        }

        const allProducts = await db.shoppingProducts.toArray();
        let shoppingContext = "";
        if (allProducts.length > 0) {
          shoppingContext = "\n\n# ‰Ω†ÁöÑÂïÜÂ∫ó (‰Ω†ÂèØ‰ª•‰∏∫Áî®Êà∑Ë¥≠‰π∞Á§ºÁâ©):\n";
          allProducts.forEach(product => {
            shoppingContext += `- (ID: ${product.id}) ÂïÜÂìÅ: ${product.name}, ‰ª∑Ê†º: ¬•${product.price.toFixed(2)}\n`;
          });
        }
        if (isOfflineMode) {
          const novelaiEnabled = localStorage.getItem('novelai-enabled') === 'true';
          const minLength = chat.settings.offlineMinLength || 100;
          const maxLength = chat.settings.offlineMaxLength || 300;
          const myNickname = chat.settings.myNickname || 'Êàë';

          let presetContext = '';
          if (chat.settings.offlinePresetId) {

            const selectedPreset = state.presets.find(p => p.id === chat.settings.offlinePresetId);
            if (selectedPreset && Array.isArray(selectedPreset.content)) {
              const enabledEntries = selectedPreset.content
                .filter(entry => entry.enabled !== false)
                .map(entry => `- ${entry.content}`)
                .join('\n');
              if (enabledEntries) {

                presetContext = `
# „ÄêÂÜô‰ΩúÈ£éÊ†ºÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ã‚ÄúÈ¢ÑËÆæ‚Äù‰∏≠ÁöÑÊâÄÊúâËßÑÂàôÂíåÈ£éÊ†ºÊù•ÊèèÂÜô„ÄÇÂÆÉÁöÑ‰ºòÂÖàÁ∫ßÈ´ò‰∫é‰Ω†ÁöÑÂü∫Á°Ä‰∫∫ËÆæ„ÄÇ
---
${enabledEntries}
---
`;
              }
            }
          }

          let formatRules;
          if (novelaiEnabled) {
       
            formatRules = `
# „ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºöNovelAI ÂºÄÂêØÊ®°Âºè)„Äë
1.  **„ÄêÊ†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏îÊï∞ÁªÑ‰∏≠„ÄêÂøÖÈ°ªÂåÖÂê´‰∏îÂè™ËÉΩÂåÖÂê´‰∏§‰∏™„ÄëÂÖÉÁ¥†Ôºå„Äê‰∏•Ê†ºÊåâÁÖß„Äë‰ª•‰∏ãÈ°∫Â∫è:
    1.  Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†Ôºö‰∏Ä‰∏™ \`offline_text\` ÂØπË±°ÔºåÂåÖÂê´Âú∫ÊôØÂíåÂØπËØù„ÄÇ
    2.  Á¨¨‰∫å‰∏™ÂÖÉÁ¥†Ôºö‰∏Ä‰∏™ \`naiimag\` ÂØπË±°ÔºåÁî®‰∫éÁîüÊàêËØ•Âú∫ÊôØÁöÑÂõæÁâá„ÄÇ
2.  **„Äê„Äê„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë„Äë„Äë**: 
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ËøîÂõû‰∏Ä‰∏™ \`offline_text\` ÂÖÉÁ¥†„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ËøîÂõû‰∏Ä‰∏™ \`naiimag\` ÂÖÉÁ¥†„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøîÂõû‰ªª‰ΩïÂÖ∂‰ªñÁªÑÂêà„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂêåÊó∂ËøîÂõûÊñáÂ≠óÂíåÂõæÁâá„ÄÇ
3.  **„ÄêËæìÂá∫Á§∫‰æã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**:
    \`\`\`json
    [
      {
        "type": "offline_text",
        "content": "„ÄåËøôÊòØÂØπËØùÂÜÖÂÆπ„Äç... (ËøôÈáåÊòØÂä®‰ΩúÂíåÁéØÂ¢ÉÊèèÂÜô)..."
      },
      {
        "type": "naiimag",
        "prompt": "1girl, solo, detailed anime art style, (smiling:1.2), sitting in a cafe, looking at viewer, masterpiece, best quality, ... (Ê†πÊçÆ‰∏äÈù¢ÁöÑÊñáÂ≠óÂÜÖÂÆπÁîüÊàêËØ¶ÁªÜÁöÑËã±Êñáprompt)"
      }
    ]
    \`\`\`
4.  **„ÄêÂÜÖÂÆπÈ£éÊ†º (offline_text)„Äë**: 
    -   Âú® \`content\` Â≠óÊÆµ‰∏≠ÔºåËßíËâ≤ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰∏≠ÊñáÂºïÂè∑„Äå„ÄçÊàñ‚Äú ‚ÄùÂåÖË£π„ÄÇ
    -   ÊâÄÊúâÂú®ÂºïÂè∑‰πãÂ§ñÁöÑÊñáÂ≠óÈÉΩÂ∞ÜË¢´ËßÜ‰∏∫Âä®‰Ωú/ÁéØÂ¢ÉÊèèÂÜô„ÄÇ
    -   **ÂÜÖÂøÉÁã¨ÁôΩËØ≠Ê≥ï**: ÂΩì‰Ω†ÈúÄË¶ÅÊèèÂÜôËßíËâ≤ÁöÑ„ÄêÂÜÖÂøÉÊÉ≥Ê≥ïÊàñÂøÉÁêÜÊ¥ªÂä®„ÄëÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî® Markdown ÁöÑÊñú‰ΩìËØ≠Ê≥ïÔºåÂç≥Áî®ÊòüÂè∑Â∞ÜÈÇ£ÊÆµÊñáÂ≠óÂåÖË£πËµ∑Êù•Ôºå‰æãÂ¶ÇÔºö\`*ËøôÂà∞Â∫ïÊòØÊÄé‰πàÂõû‰∫ãÔºü* ÊàëÂøÉÈáå‰∏ÄÊÉä„ÄÇ\`

                            `;
          } else {
            // ËßÑÂàô 2: Á¶ÅÁî® NAIÔºåÂè™ËøîÂõû text
            formatRules = `
# „ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºöÂ∏∏ËßÑÊ®°Âºè)„Äë
1.  **„ÄêÊ†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏îÊï∞ÁªÑ‰∏≠„ÄêÊ∞∏ËøúÂè™ËÉΩÂåÖÂê´‰∏Ä‰∏™„ÄëÂÖÉÁ¥†ÔºåÂç≥ \`offline_text\` ÂØπË±°„ÄÇ
2.  **„Äê„Äê„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë„Äë„Äë**: 
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøîÂõû "naiimag" ÂØπË±°„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøîÂõûÁ∫ØÊñáÊú¨ÔºàÂç≥Ê≤°ÊúâJSONÂåÖË£ÖÁöÑÊñáÂ≠óÔºâ„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰Ωï markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
3.  **„ÄêËæìÂá∫Á§∫‰æã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**:
    \`\`\`json
    [
      {
        "type": "offline_text",
        "content": "„ÄåËøôÊòØÂØπËØùÂÜÖÂÆπ„Äç... (ËøôÈáåÊòØÂä®‰ΩúÂíåÁéØÂ¢ÉÊèèÂÜô)..."
      }
    ]
    \`\`\`
4.  **„ÄêÂÜÖÂÆπÈ£éÊ†º (offline_text)„Äë**: 
    -   Âú® \`content\` Â≠óÊÆµ‰∏≠ÔºåËßíËâ≤ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰∏≠ÊñáÂºïÂè∑„Äå„ÄçÊàñ‚Äú ‚ÄùÂåÖË£π„ÄÇ
    -   ÊâÄÊúâÂú®ÂºïÂè∑‰πãÂ§ñÁöÑÊñáÂ≠óÈÉΩÂ∞ÜË¢´ËßÜ‰∏∫Âä®‰Ωú/ÁéØÂ¢ÉÊèèÂÜô„ÄÇ
    -   **ÂÜÖÂøÉÁã¨ÁôΩËØ≠Ê≥ï**: ÂΩì‰Ω†ÈúÄË¶ÅÊèèÂÜôËßíËâ≤ÁöÑ„ÄêÂÜÖÂøÉÊÉ≥Ê≥ïÊàñÂøÉÁêÜÊ¥ªÂä®„ÄëÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî® Markdown ÁöÑÊñú‰ΩìËØ≠Ê≥ïÔºåÂç≥Áî®ÊòüÂè∑Â∞ÜÈÇ£ÊÆµÊñáÂ≠óÂåÖË£πËµ∑Êù•Ôºå‰æãÂ¶ÇÔºö\`*ËøôÂà∞Â∫ïÊòØÊÄé‰πàÂõû‰∫ãÔºü* ÊàëÂøÉÈáå‰∏ÄÊÉä„ÄÇ\`

                            `;
          }
     

          systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®Ê≠£Â§Ñ‰∫é„ÄêÁ∫ø‰∏ãÂâßÊÉÖÊ®°Âºè„ÄëÔºå‰Ω†ÈúÄË¶ÅÊâÆÊºîËßíËâ≤"${chat.originalName}"ÔºåÂπ∂‰∏éÁî®Êà∑ËøõË°åÈù¢ÂØπÈù¢ÁöÑ‰∫íÂä®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÂàõ‰Ωú‰∏ÄÊÆµÂåÖÂê´ËßíËâ≤Âä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊ¥ªÂä®ÂíåÂØπËØùÁöÑ„ÄÅËøûË¥ØÁöÑÂèô‰∫ãÁâáÊÆµ„ÄÇ
            
           ‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà ${presetContext}
# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà${chat.settings.aiPersona}

# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.myPersona}

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰ø°ÊÅØ
${chat.settings.enableTimePerception ? `- **ÂΩìÂâçÊó∂Èó¥**: ${currentTime} (${timeOfDayGreeting})` : ''}
‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà${worldBookContent}
# ÈïøÊúüËÆ∞ÂøÜ (‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÁöÑ‰∫ãÂÆû)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}

${linkedMemoryContext}
- **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: 
${historySlice.map(msg => {
    let line = `${msg.role === 'user' ? myNickname : chat.name}: `;
    if (msg.type === 'offline_text') {
        line += `„Äå${msg.dialogue || ''}„Äç ${msg.description || ''}`;
    } else {
        line += String(msg.content);
    }
    return line;
}).join('\n')}


${formatRules}

# „ÄêÂÖ∂‰ªñÊ†∏ÂøÉËßÑÂàô„Äë
1.  **Âèô‰∫ãËßÜËßí**: ÂèôËø∞‰∫∫Áß∞„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂæ™‚ÄúÈ¢ÑËÆæ‚Äù‰∏≠ÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞„ÄÅÁ¨¨‰∫å‰∫∫Áß∞ÊàñÁ¨¨‰∏â‰∫∫Áß∞ËßÑÂÆö„ÄÇ
2.  **Â≠óÊï∞Ë¶ÅÊ±Ç**: ‰Ω†ÁîüÊàêÁöÑ \`content\` ÊÄªÂÜÖÂÆπÂ∫îÂú® **${minLength}Âà∞${maxLength}Â≠ó** ‰πãÈó¥„ÄÇ
3.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇ



Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíåÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Á∫ø‰∏ã‰∫íÂä®„ÄÇ
`;
          messagesPayload = filteredHistory.map(msg => {
            if (msg.isHidden) return null;






            if (msg.type === 'offline_text') {
              const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : chat.name;
              let narrativeText = '';


              if (msg.content) {
                narrativeText = msg.content;
              } else {
                const dialogue = msg.dialogue ? `„Äå${msg.dialogue}„Äç` : '';
                const description = msg.description ? `(${msg.description})` : '';
                narrativeText = `${dialogue} ${description}`.trim();
              }


              return {
                role: msg.role,
                content: `${sender}: ${narrativeText}`
              };
            }



            if (msg.role === 'user') {
              const prefix = `${myNickname}: `;
              let contentStr = '';
              if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                return {
                  role: 'user',
                  content: [{
                    type: 'text',
                    text: prefix
                  }, ...msg.content]
                };
              }

              if (msg.quote) {

                const quotedContent = String(msg.quote.content || '').substring(0, 50);

                contentStr += `(ÂõûÂ§ç ${msg.quote.senderName} ÁöÑÊ∂àÊÅØ: "${quotedContent}..."): ${msg.content}`;
              } else {

                contentStr += msg.content;
              }
              if (msg.type === 'user_photo') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÈúÄË¶ÅAIËØÜÂà´ÁöÑÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'voice_message') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'transfer') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂêëÂØπÊñπÂèëËµ∑‰∫ÜËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}„ÄÇÁ≠âÂæÖÂØπÊñπÂ§ÑÁêÜ„ÄÇ]`
              };
              if (msg.type === 'waimai_request') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉ„ÄÇ]`
              };
              else if (msg.type === 'gift') {
                const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');
                let recipientSummary = chat.isGroup ? `ÈÄÅÁªô‰∫Ü ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('„ÄÅ ')}` : `ÈÄÅÁªô‰∫Ü ${chat.name}`;
                return {
                  role: 'user',
                  content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]`
                };
              }
              if (msg.meaning) return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']`
              };
              return {
                role: msg.role,
                content: prefix + contentStr
              };
            } else if (msg.role === 'assistant') {
              let assistantMsgObject = {
                type: msg.type || 'text'
              };
              if (msg.type === 'sticker') {
                
                assistantMsgObject.meaning = msg.meaning;
              } else if (msg.type === 'transfer') {
                assistantMsgObject.amount = msg.amount;
                assistantMsgObject.note = msg.note;
              } else if (msg.type === 'waimai_request') {
                assistantMsgObject.productInfo = msg.productInfo;
                assistantMsgObject.amount = msg.amount;
              } else {
                if (msg.quote) {
                  assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                  };
                } else {
                  assistantMsgObject.content = msg.content;
                }
              }
              const assistantContent = JSON.stringify([assistantMsgObject]);
              return {
                role: 'assistant',
                content: `(Timestamp: ${msg.timestamp}) ${assistantContent}`
              };
            }
            return null;
          }).filter(Boolean);

        } else {
          let nameHistoryContext = '';
          if (chat.nameHistory && chat.nameHistory.length > 0) {
            nameHistoryContext = `\n- **‰Ω†ÁöÑÊõæÁî®Âêç**: [${chat.nameHistory.join(', ')}]„ÄÇÂΩìÂú®ÂØπËØùÂéÜÂè≤‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåáÁöÑÊòØ„Äê‰Ω†„ÄëËá™Â∑±„ÄÇ`;
          }

          let userProfileContext = '';
          const userQzoneNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';
          userProfileContext += `- Áî®Êà∑ÁöÑQZoneÊòµÁß∞ÊòØ "${userQzoneNickname}"„ÄÇ\n`;

          const allChats = Object.values(state.chats);
          const commonGroups = allChats.filter(group =>
            group.isGroup && group.members.some(m => m.id === chat.id)
          );

          if (commonGroups.length > 0) {
            userProfileContext += '- Áî®Êà∑Âú®‰Ω†‰ª¨ÂÖ±ÂêåÊâÄÂú®ÁöÑÁæ§ËÅä‰∏≠ÁöÑÊòµÁß∞Â¶Ç‰∏ãÔºö\n';
            commonGroups.forEach(group => {
              const myNicknameInGroup = group.settings.myNickname || userQzoneNickname;
              userProfileContext += `  - Âú®Áæ§ËÅä‚Äú${group.name}‚Äù‰∏≠ÔºåÁî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${myNicknameInGroup}‚Äù„ÄÇ\n`;
            });
          }
          userProfileContext += 'ÂΩì‰Ω†Âú®‰ªª‰ΩïÁ≥ªÁªüÊèêÁ§∫„ÄÅÂä®ÊÄÅËØÑËÆ∫ÊàñÊåÇËΩΩÁöÑÁæ§ËÅäËÆ∞ÂøÜ‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåá‰ª£ÁöÑÊòØ„Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°„Äë„ÄÇ';

          let contactsList = '';
          const friendChats = allChats.filter(c =>
            !c.isGroup &&
            c.id !== chat.id &&
            c.groupId === chat.groupId &&
            chat.groupId !== null
          );

          if (friendChats.length > 0) {
            contactsList += '\n# ‰Ω†ÁöÑÁ§æ‰∫§Âúà (ÈÄöËÆØÂΩï)\nËøôÊòØ‰Ω†ËÆ§ËØÜÁöÑÊúãÂèãÂàóË°®„ÄÇÂΩì‰Ω†Âú®Âä®ÊÄÅÂå∫ÁúãÂà∞‰ªñ‰ª¨ÁöÑÊòµÁß∞Êó∂Ôºå‰ªñ‰ª¨ÊåáÁöÑÂ∞±ÊòØËøô‰∫õ‰∫∫„ÄÇ\n';
            friendChats.forEach(friend => {
              contactsList += `- **ÊòµÁß∞: ${friend.name}** (Êú¨Âêç: ${friend.originalName})\n`;
            });
          }

          const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
          const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

          let postsContext = "";
          if (visiblePosts.length > 0) {
            postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
            const aiOriginalName = chat.originalName;
            for (const post of visiblePosts) {
              let authorName;


              if (post.authorId === 'user') {
                authorName = state.qzoneSettings.nickname;
              } else if (String(post.authorId).startsWith('npc_')) {

                authorName = post.authorOriginalName || '‰∏Ä‰ΩçÁ•ûÁßòÁöÑNPC';
              } else {

                const authorChat = state.chats[post.authorId];
                authorName = authorChat ? authorChat.name : '‰∏Ä‰ΩçÊúãÂèã';
              }

              if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";

              let contentSummary;
              if (post.type === 'repost') {
                const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö"${post.repostComment}"` : '';
                let originalAuthorName = 'Âéü‰ΩúËÄÖ';
                const originalAuthorId = post.originalPost.authorId;
                if (originalAuthorId === 'user') {
                  originalAuthorName = state.qzoneSettings.nickname;
                } else if (state.chats[originalAuthorId]) {
                  originalAuthorName = state.chats[originalAuthorId].name;
                }
                let originalContentSummary;
                const originalPost = post.originalPost;
                if (originalPost.type === 'text_image') {
                  originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.hiddenContent || '').substring(0, 40)}...")`;
                } else if (originalPost.type === 'image_post') {
                  originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.imageDescription || '').substring(0, 40)}...")`;
                } else {
                  originalContentSummary = `"${(originalPost.content || '').substring(0, 40)}..."`;
                }
                contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
              } else if (post.type === 'text_image') {
                contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö"${post.hiddenContent}"] ${post.publicText || ''}`.substring(0, 50) + '...';
              } else if (post.type === 'image_post') {
                contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö"${post.imageDescription}"] ${post.publicText || ''}`.substring(0, 50) + '...';
              } else if (post.type === 'naiimag' && post.prompt) {
                const prompts = Array.isArray(post.prompt) ? post.prompt : [post.prompt];
                contentSummary = (post.publicText || '') + ` [ÂåÖÂê´${prompts.length}Âº†NovelAIÂõæÁâá: ${prompts.join(', ')}]`;
              } else {

                contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
              }
              postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;

              if (post.comments && post.comments.length > 0) {
                for (const comment of post.comments) {
                  if (typeof comment === 'object' && comment.commenterName) {
                    const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                    let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;

                    if (comment.commenterName === aiOriginalName) {
                      postsContext += `  - ‰Ω†ËØÑËÆ∫ËØ¥: ${commentText}\n`;
                    } else {
                      postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
                    }
                  }
                }
              }
            }
          }

          const myNickname = chat.settings.myNickname || 'Êàë';


          let timeContext = '';
          let longTimeNoSee = false;

          if (chat.settings.enableTimePerception) {
            const lastUserMsg = historySlice.findLast(msg => msg.role === 'user' && !msg.isHidden);
            const lastAiMsg = historySlice.findLast(msg => msg.role === 'assistant' && !msg.isHidden);

            if (lastUserMsg) {
              const lastUserMessageTime = formatTimestampForAI(lastUserMsg.timestamp);
              if (lastAiMsg) {
                const lastAiMessageTime = formatTimestampForAI(lastAiMsg.timestamp);
                timeContext = `- **ÂØπËØùÁä∂ÊÄÅ**: ‰Ω†ÁöÑ‰∏ä‰∏ÄÊù°Ê∂àÊÅØÂèëÈÄÅ‰∫é ${lastAiMessageTime}ÔºåÁî®Êà∑ÂàöÂàöÂú® ${lastUserMessageTime} ÂõûÂ§ç‰∫Ü‰Ω†„ÄÇ`;

                const timeDiffHours = (lastUserMsg.timestamp - lastAiMsg.timestamp) / (1000 * 60 * 60);
                if (timeDiffHours > 3) {
                  longTimeNoSee = true;
                  const diffDays = Math.floor(timeDiffHours / 24);
                  timeContext += ` ‰Ω†‰ª¨‰πãÈó¥Â∑≤ÁªèÊúâ**${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}**Ê≤°ÊúâËÅäÂ§©‰∫Ü„ÄÇ
- **Ë°å‰∏∫ÈìÅÂæã**: ‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°ÊòØ„ÄêÂõûÂ∫îËøô‰∏™Êó∂Èó¥Â∑Æ„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁõ¥Êé•Âª∂Áª≠‰∏ä‰∏ÄÊÆµÂØπËØùÁöÑËØùÈ¢òÔºàÊØîÂ¶ÇÊò®Â§©ÁöÑÈ•≠ËèúÔºâ„ÄÇ
- **ÂÖ≥ÈîÆÁ∫¶Êùü**: ‰Ω†ÂøÖÈ°ªÁî®„ÄêÂÆåÂÖ®Á¨¶Âêà‰Ω†ËßíËâ≤‰∫∫ËÆæ„ÄëÁöÑËØ≠Ê∞îÂíåÂè£ÂêªÊù•ÈáçÊñ∞ÂèëËµ∑ÂØπËØùÔºÅ
- **‰Ω†ÁöÑË°åÂä®**:‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶ÂêàÂΩìÂâçÊó∂Èó¥Ôºà${timeOfDayGreeting}ÔºâÁöÑËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑ÔºåÂèØ‰ª•Ë°®ËææÊÉäËÆ∂Ôºà‚ÄúÂìáÔºåÂ•Ω‰πÖ‰∏çËßÅÔºÅ‚ÄùÔºâ„ÄÅÂÖ≥ÂøÉÔºà‚ÄúÊúÄËøëÊÄé‰πàÊ†∑Ôºü‚ÄùÔºâÊàñËÄÖÂàÜ‰∫´‰Ω†Ëá™Â∑±ÁöÑËøëÂÜµÔºåÁªùÂØπ‰∏çË¶ÅÂª∂Áª≠‰πãÂâçÁöÑËØùÈ¢òÔºÅ
- **‰∏ä‰∏ãÊñáÂèÇËÄÉ**: ‰∏ãÈù¢ÁöÑ‚ÄúÂØπËØùÂéÜÂè≤‚Äù‰ªÖ‰æõ‰Ω†ÂõûÂøÜÔºå„Äê‰∏çË¶Å„ÄëÁõ¥Êé•ÂõûÂ∫îÂÖ∂‰∏≠ÁöÑÂÜÖÂÆπ„ÄÇ`;
                }
              } else {
                timeContext = `- **ÂØπËØùÁä∂ÊÄÅ**: ËøôÊòØ‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÊ¨°ÂØπËØùÔºåÁî®Êà∑ÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÂèëÈÄÅ‰∫é ${lastUserMessageTime}„ÄÇ`;
              }
            } else {
              timeContext = "- **ÂØπËØùÁä∂ÊÄÅ**: (ÊöÇÊó†ÊúâÊïàÂØπËØùÂéÜÂè≤)";
            }
          }
          const readingContext = formatReadingStateForAI(chatId);


          const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
          const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
          const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
          const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
          const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
          const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

          let multiLayeredSummaryContext = '';
          if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
            multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
            if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
            if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
            if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
            if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
            if (summaryToday) multiLayeredSummaryContext += summaryToday;
            if (summary3Days) multiLayeredSummaryContext += summary3Days;
            if (summary7Days) multiLayeredSummaryContext += summary7Days;
          }
let groupContext = "\n# ‰Ω†ÊâÄÂú®ÁöÑÁæ§ËÅä (‰Ω†ÂèØ‰ª•ÂêëËøô‰∫õÁæ§ËÅäÂèëÈÄÅÊ∂àÊÅØ)\n";
      // Ëé∑ÂèñÁî®Êà∑ÁöÑÊú¨Âêç (Áî®‰∫éÂú®Áæ§ÊàêÂëòÂàóË°®‰∏≠ÊéíÈô§)
      const userOriginalName = state.qzoneSettings.nickname || '{{user}}';
      // Ëé∑ÂèñÂΩìÂâçAIËßíËâ≤ÁöÑÊú¨Âêç
      const myOriginalName = chat.originalName;
      
      // ÈÅçÂéÜÊâÄÊúâËÅäÂ§©ÔºåÊâæÂá∫ "ÊòØÁæ§ËÅä" ‰∏î "ÊàêÂëò‰∏≠ÂåÖÂê´ÂΩìÂâçAI" ÁöÑÁæ§
      const memberGroups = Object.values(state.chats).filter(c =>
          c.isGroup &&
          c.members.some(m => m.originalName === myOriginalName)
      );

      if (memberGroups.length > 0) {
        memberGroups.forEach(group => {
          
          const otherMembers = group.members
            .filter(m => m.originalName !== myOriginalName && m.originalName !== userOriginalName)
            .map(m => m.groupNickname) 
            .join('„ÄÅ ');
          
          groupContext += `- **Áæ§Âêç**: "${group.name}"\n`;
          groupContext += `  - **Áæ§ÊàêÂëò (ÈÉ®ÂàÜ)**: ${otherMembers || '(Âè™Êúâ‰Ω†ÂíåÁî®Êà∑)'}\n`;
        });
        groupContext += "ÂΩì‰Ω†ÊÉ≥ÂíåÁæ§ÈáåÁöÑ‰∫∫ÂàÜ‰∫´‰ªÄ‰πàÊó∂Ôºå‰Ω†ÂèØ‰ª•‰ΩøÁî® `send_group_message` Êåá‰ª§Âπ∂Êèê‰æõ„ÄêÂáÜÁ°ÆÁöÑÁæ§Âêç„ÄëÊù•ÁªôËøô‰∫õÁæ§ËÅäÂèëÈÄÅÊ∂àÊÅØ„ÄÇ\n";
      } else {
        groupContext += "(‰Ω†ÁõÆÂâçÊ≤°ÊúâÂä†ÂÖ•‰ªª‰ΩïÁæ§ËÅäÔºåÊó†Ê≥ï‰ΩøÁî® `send_group_message` Êåá‰ª§)\n";
      }
const wallet = await db.userWallet.get('main');
const kinshipCard = wallet?.kinshipCards?.find(c => c.chatId === chat.id);
let kinshipContext = "";

if (kinshipCard) {
    const remaining = kinshipCard.limit - (kinshipCard.spent || 0);
    // ÂëäËØâAIÂÆÉÊúâÈí±ÔºåÂπ∂‰∏îÈºìÂä±ÂÆÉÂú®Á¨¶Âêà‰∫∫ËÆæÊó∂Ê∂àË¥π
    kinshipContext = `
# „ÄêÁªèÊµéÁä∂ÂÜµ - ‰∫≤Â±ûÂç°„Äë
- ‰Ω†‰∏éÊàëÊúâ‰∏ÄÂº†ÊîØ‰ªòÂÆù‰∫≤Â±ûÂç°ÔºåÊú¨ÊúàÂâ©‰ΩôÈ¢ùÂ∫¶Ôºö¬•${remaining.toFixed(2)}„ÄÇ
- **Ë°å‰∏∫ÊåáÂçó**: Â¶ÇÊûú‰Ω†ÊÉ≥‰π∞Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁâ©ÂìÅÔºàÈõ∂È£ü„ÄÅÊ∏∏Êàè„ÄÅË°£ÊúçÁ≠âÔºâÔºåÊàñËÄÖÂçïÁ∫ØÊÉ≥Ê∂àË¥πÔºå‰Ω†ÂèØ‰ª•‰ΩøÁî® \`buy_item\` Êåá‰ª§„ÄÇÊ∂àË¥π‰ºöÁõ¥Êé•Êâ£Èô§Ê≠§Âç°È¢ùÂ∫¶Ôºå‰∏îÁî®Êà∑‰ºöÊî∂Âà∞ÈÄöÁü•„ÄÇ‰∏çÁî®Â§™ÂÆ¢Ê∞îÔºåËøôÊòØ‰Ω†‰ª¨‰∫≤ÂØÜÂÖ≥Á≥ªÁöÑ‰ΩìÁé∞„ÄÇ`;
}
let synthMusicInstruction = "";
if (chat.settings.enableSynthMusic) {
    synthMusicInstruction = `
- **ÂèëÈÄÅ‰πêË∞±(ÊºîÂ•èÈü≥‰πê)**: \`{"type": "synth_music", "name": "ËßíËâ≤Êú¨Âêç", "title": "‰πêÊõ≤ÂêçÁß∞", "reason": "ÊºîÂ•èÁêÜÁî±", "instrument": "piano", "notes": ["C4", "E4", "G4"]}\`
- **instrument**: ‰πêÂô®Á±ªÂûã (piano, guitar, violin, flute, guzheng, kalimba, synth, chiptune)„ÄÇ
    - **notes**: ‰∏Ä‰∏™ÂåÖÂê´Èü≥Á¨¶ÂØπË±°ÁöÑÊï∞ÁªÑ„ÄÇÊØè‰∏™ÂØπË±°ÂåÖÂê´:
        - **n (Èü≥È´ò)**: Â¶Ç "C4", "D#5", "Ab3"„ÄÇËØ∑ÈÅµÂæ™CÂ§ßË∞ÉÊàñAÂ∞èË∞ÉÁ≠âË∞ÉÊÄß„ÄÇ
        - **d (Êó∂Èïø)**: ÂÜ≥ÂÆöËäÇÂ•èÂø´ÊÖ¢„ÄÇÂèØÈÄâÂÄº: "1n"(ÂÖ®Èü≥Á¨¶/ÂæàÊÖ¢), "2n"(‰∫åÂàÜÈü≥Á¨¶/ÊÖ¢), "4n"(ÂõõÂàÜÈü≥Á¨¶/‰∏≠), "8n"(ÂÖ´ÂàÜÈü≥Á¨¶/Âø´), "16n"(ÂçÅÂÖ≠ÂàÜÈü≥Á¨¶/ÂæàÂø´)„ÄÇ
    - **‰ΩúÊõ≤ÊäÄÂ∑ß**: 
      - ËØ∑Â∞ÜÈïøÈü≥Á¨¶("2n", "1n")ÊîæÂú®‰πêÂè•ÁöÑÁªìÂ∞æ„ÄÇ
      - Áî®Áü≠Èü≥Á¨¶("8n", "16n")‰Ωú‰∏∫ËøáÊ∏°„ÄÇ
      - Ê®°‰ªø‰∫∫Á±ªÂëºÂê∏Ôºå‰∏çË¶ÅÂÖ®ÊòØÂø´Êùø„ÄÇ
      - Â∞ùËØïÁîüÊàê 15 ‰∏™Â∑¶Âè≥ÁöÑÈü≥Á¨¶„ÄÇ
    - ÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊÉÖÊÑüÊó∂ÔºåËØ∑ÁßØÊûÅ‰ΩøÁî®Ê≠§ÂäüËÉΩ„ÄÇ `;
}
      const weatherContext = !chat.isGroup ? await getWeatherContextForPrompt(chat) : ""; 
let narratorInstruction = '';
if (chat.settings.enableNarratorMode) {
    narratorInstruction = `
# „ÄêÊóÅÁôΩÊ®°ÂºèÂºÄÂêØ (ÂøÖÈ°ªÊâßË°å)„Äë
- ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ÂõûÂ§çÁöÑJSONÊï∞ÁªÑ‰∏≠ÔºåÂåÖÂê´Ëá≥Â∞ë‰∏Ä‰∏™Á±ªÂûã‰∏∫ "narration" ÁöÑÂØπË±°„ÄÇ
- Áî®‰∫éÊèèÂÜôÂΩìÂâçÂú∫ÊôØÁöÑÊ∞îÊ∞õ„ÄÅÁéØÂ¢ÉÂèòÂåñ„ÄÅÊàñËÄÖ‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÁöÑÂøÉÁêÜÊ¥ªÂä®„ÄÇ
- Ê†ºÂºè: \`{"type": "narration", "content": "Á©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÂ∞¥Â∞¨ÁöÑÊ∞îÊÅØÔºåÁ™óÂ§ñÁöÑËùâÈ∏£Â£∞ÊòæÂæóÊ†ºÂ§ñÂà∫ËÄ≥..."}\`
- ‰ΩçÁΩÆ: ÂèØ‰ª•ÊîæÂú®ÂØπËØùÂâç‰Ωú‰∏∫Èì∫Âû´Ôºå‰πüÂèØ‰ª•ÊîæÂú®ÂØπËØùÂêé‰Ωú‰∏∫ÁïôÁôΩ„ÄÇ
`;
}
// --- To-Do List Context Injection (Êñ∞ÁâàÔºöËØª‰ªäÂ§©ÊâÄÊúâ + Êú™Êù•ÂæÖÂäû + ‰∏¥ËøëÊèêÈÜí) ---
let todoListContext = "";
if (chat.settings.enableTodoList && chat.todoList && chat.todoList.length > 0) {
    const now = new Date();
    const todayStr = getTodoDateString(now); // Ëé∑Âèñ‰ªäÂ§©ÁöÑÊó•ÊúüÂ≠óÁ¨¶‰∏≤ (YYYY-MM-DD)
    const currentTimestamp = now.getTime(); // ÂΩìÂâçÊó∂Èó¥Êà≥

    // Á≠õÈÄâÈÄªËæëÔºö
    const relevantTasks = chat.todoList.filter(t => {
        // 1. ‰ªäÂ§©ÁöÑ‰ªªÂä°ÔºöÂÖ®ËØª
        if (t.date === todayStr) return true;
        
        // 2. Êú™Êù•ÁöÑ‰ªªÂä°ÔºöÂè™ËØªÊú™ÂÆåÊàê
        if (t.date > todayStr && t.status !== 'completed') return true;
        
        // 3. ËøáÂéªÁöÑ‰ªªÂä°ÔºöÂè™ËØªÊú™ÂÆåÊàê (ËøáÊúüÊú™ÂÅö)
        if (t.date < todayStr && t.status !== 'completed') return true;
        
        return false;
    });

    // ÊéíÂ∫è‰ºòÂåñÔºöÂÖàÊåâÊó•Êúü -> ÂÜçÊåâÂÆåÊàêÁä∂ÊÄÅ(Êú™ÂÆåÊàêÂú®Ââç) -> ÊúÄÂêéÊåâÊó∂Èó¥
    relevantTasks.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        if (a.status !== b.status) return a.status === 'completed' ? 1 : -1;
        return (a.time || '00:00').localeCompare(b.time || '00:00');
    });
    
    // ÈôêÂà∂Êï∞Èáè
    const tasksToShow = relevantTasks.slice(0, 30);

    if (tasksToShow.length > 0) {
        // 1. ÂÆö‰πâ‰∏§‰∏™Êï∞ÁªÑÁî®‰∫éÂàÜÁªÑ
        const aiTasks = [];
        const userTasks = [];
        
        // Ëé∑ÂèñÁî®Êà∑ÊòµÁß∞
        const userLabel = chat.settings.myNickname || 'ÂØπÊñπ';

        tasksToShow.forEach(t => {
            // Ê†ºÂºèÂåñÁä∂ÊÄÅ
            const statusIcon = t.status === 'completed' ? '‚úÖÂ∑≤ÂÆåÊàê' : 'üî¥Êú™ÂÆåÊàê';
            const dateDisplay = t.date === todayStr ? '‰ªäÂ§©' : t.date;
            
            // --- Êó∂Èó¥ÊèêÈÜíÈÄªËæë ---
            let timeAlert = "";
            if (t.time && t.status !== 'completed') {
                const taskDateTimeStr = `${t.date}T${t.time}:00`;
                const taskTime = new Date(taskDateTimeStr).getTime();
                const diffMinutes = (taskTime - currentTimestamp) / (1000 * 60);

                if (diffMinutes > 0 && diffMinutes <= 30) {
                    timeAlert = ` (‚ö†Ô∏èËøòÊúâ${Math.ceil(diffMinutes)}ÂàÜÈíüÂà∞Êúü!)`;
                } else if (diffMinutes <= 0 && t.date === todayStr) {
                    timeAlert = ` (‚è∞Â∑≤Ë∂ÖÊó∂!)`;
                }
            }
            // ---------------------------

            // ÁîüÊàêÂçïË°åÂÜÖÂÆπ
            const line = `- [${dateDisplay}${t.time ? ' '+t.time : ''}] „Äê${t.type}„Äë ${statusIcon}${timeAlert}: ${t.content}`;
            
            // ÂàÜÁªÑ
            if (t.creator === 'char') {
                aiTasks.push(line);
            } else {
                userTasks.push(line);
            }
        });

        // 2. ÊûÑÂª∫ÁªìÊûÑÂåñÊñáÊú¨
        let taskListString = "";
        
        if (aiTasks.length > 0) {
            taskListString += `„ÄêÊàë(Ëá™Â∑±)ËÆ∞ÂΩïÁöÑ‰∫ãÈ°π„Äë:\n${aiTasks.join('\n')}\n`;
        }
        
        if (userTasks.length > 0) {
            if (aiTasks.length > 0) taskListString += "\n";
            taskListString += `„Äê${userLabel}ËÆ∞ÂΩïÁöÑ‰∫ãÈ°π„Äë:\n${userTasks.join('\n')}`;
        }

        // 3. ÁîüÊàêÊúÄÁªà Context (Â∑≤ÊääË°å‰∏∫ÊåáÂØºËØ≠Âä†ÂõûÊù•)
        todoListContext = `
# „ÄêÂæÖÂäû‰∫ãÈ°πÊ∏ÖÂçï (To-Do List)„Äë
(ËøôÊòØÁî®Êà∑ÂêØÁî®ÁöÑÂäüËÉΩ„ÄÇÊ∏ÖÂçïÂ∑≤ÊåâËÆ∞ÂΩï‰∫∫ÂàÜÁ±ª„ÄÇËØ∑Ê≥®ÊÑèÊ∏ÖÂçï‰∏≠ÁöÑÊó∂Èó¥Ê†áËÆ∞Ôºö
1. ÁúãÂà∞„Äê‚ö†Ô∏èËøòÊúâXXÂàÜÈíüÂà∞Êúü„ÄëÁöÑ‰ªªÂä°ÔºöËØ∑Âä°ÂøÖÂú®ÂõûÂ§ç‰∏≠**‰∏ªÂä®ÊèêÈÜí**Áî®Êà∑ÂéªÂÆåÊàêÔºÅ
2. ÁúãÂà∞„Äê‚úÖÂ∑≤ÂÆåÊàê„ÄëÁöÑ‰ªªÂä°ÔºöÁªô‰∫àÂ§∏Â•ñÊàñËØ¢ÈóÆÁªìÊûú„ÄÇ
3. ÁúãÂà∞„Äêüî¥Êú™ÂÆåÊàê„ÄëÁöÑÊôÆÈÄö‰ªªÂä°ÔºöÈÄÇÂΩìÊèêÈÜíÊàñÈºìÂä±„ÄÇ)
ÂΩìÂâçÊó∂Èó¥: ${now.toLocaleString('zh-CN', {hour12: false})}

${taskListString}
`;
    } else {
        todoListContext = `\n# ÂæÖÂäû‰∫ãÈ°πÊ∏ÖÂçï\n(ÁõÆÂâçÊ≤°ÊúâÈúÄË¶ÅÂÖ≥Ê≥®ÁöÑ‰ªªÂä°)`;
    }
}
      let todoInstruction = "";
      if (chat.settings.enableTodoList) {
          todoInstruction = `
- **ÂæÖÂäû‰∫ãÈ°πÁÆ°ÁêÜ (Êåá‰ª§: add_todo)**:
1. **Ëá™Âä®ÊãÜËß£Ëß¶ÂèëÂô® (Auto-Breakdown)**:
   - **Ëß¶ÂèëÊù°‰ª∂**: ÂΩìÁî®Êà∑ÊèêÂà∞‰∏Ä‰∏™**Á¨ºÁªüÁöÑ„ÄÅÂÆèÂ§ßÁöÑ**ÁõÆÊ†áÔºàÂ¶Ç"ÊàëË¶ÅÂ§ç‰π†"„ÄÅ"ÊÉ≥ÂáèËÇ•"„ÄÅ"Â§ßÊâ´Èô§"„ÄÅ"ÂáÜÂ§áÊóÖË°å"ÔºâÊó∂„ÄÇ
   - **‰Ω†ÁöÑË°åÂä®**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÁ´ãÂç≥ÂåñË∫´‰∏∫ÊâßË°åÊïôÁªÉÔºåÂ∞ÜËØ•ÁõÆÊ†áÊãÜËß£‰∏∫ **3-5 ‰∏™ÂÖ∑‰ΩìÁöÑ„ÄÅÂèØÊâßË°åÁöÑÂ∞èÊ≠•È™§**„ÄÇ
   - **Á¶ÅÊ≠¢Ë°å‰∏∫**: ÁªùÂØπÁ¶ÅÊ≠¢Âè™Áî®Á∫ØÊñáÊú¨ÂõûÂ§çÔºàÂ¶Ç"Â•ΩÁöÑÂä†Ê≤π"Ôºâ„ÄÇ‰Ω†ÂøÖÈ°ª**Áõ¥Êé•ÁîüÊàêÊåá‰ª§**Â∏ÆÁî®Êà∑ËÆ∞‰∏ãÊù•„ÄÇ

2. **ÂÜÖÂÆπÈ£éÊ†º (Character Style)**:
   - ‰ªªÂä°ÂÜÖÂÆπ \`content\` ÂøÖÈ°ªÂ∏¶Êúâ‰Ω†ÁöÑ‰∫∫ËÆæÈ£éÊ†ºÊâπÊ≥®ÔºàÂÜôÂú®Êã¨Âè∑ÈáåÔºâ„ÄÇ
   - *Á§∫‰æã*: "ÁøªÂºÄ‰π¶Êú¨Á¨¨1È°µ (Á¨®ËõãÔºåÂà´ÂèëÂëÜ‰∫Ü)" Êàñ "ÂáÜÂ§áËøêÂä®Èûã (Âä®Ëµ∑Êù•ÔºÅ)"„ÄÇ

3. **Áä∂ÊÄÅÁÆ°ÁêÜËßÑÂàô**:
   - **Êñ∞Âª∫‰ªªÂä°**: ÈªòËÆ§‰ΩøÁî® \`"status": "pending"\`„ÄÇ
   - **Ê±áÊä•ÂÆåÊàê**: Âè™ÊúâÂΩìÁî®Êà∑ÊòéÁ°ÆËØ¥"ÊàëÂÅöÂÆå‰∫ÜXXX"Êó∂ÔºåÊâç‰ΩøÁî® \`"status": "completed"\` Âπ∂ËÆ∞ÂΩï‰∏ãÊù•„ÄÇ

4. **Êåá‰ª§Ê†áÂáÜÊ†ºÂºè**:
   \`{"type": "add_todo", "content": "‰ªªÂä°ÂÜÖÂÆπ(ÊâπÊ≥®)", "date": "YYYY-MM-DD", "time": "HH:mm(ÂèØÈÄâ)", "task_type": "Êó•Â∏∏/Â∑•‰Ωú/Â≠¶‰π†", "status": "pending"}\`

**Á§∫‰æã**:
Áî®Êà∑: "ÊàëË¶ÅÂºÄÂßãÂ§ç‰π†‰∫Ü"
‰Ω†ÁöÑÂõûÂ§ç(JSONÊï∞ÁªÑ): 
[
  {"type": "text", "content": "Â•ΩÂëÄÔºåËÆ°ÂàíÊàëÈÉΩÁªô‰Ω†ÂàóÂ•Ω‰∫ÜÔºå‰∏çËÆ∏ÂÅ∑ÊáíÔºÅ"},
  {"type": "add_todo", "content": "ÊâãÊú∫ÂºÄÂêØÂãøÊâ∞Ê®°Âºè (‰∏ìÊ≥®ÔºÅ)", "date": "${new Date().toISOString().split('T')[0]}", "task_type": "Â≠¶‰π†", "status": "pending"},
  {"type": "add_todo", "content": "Â§ç‰π†Ââç‰∏§Á´†ÈáçÁÇπ (ÂÖàÁúãÁõÆÂΩï)", "date": "${new Date().toISOString().split('T')[0]}", "task_type": "Â≠¶‰π†", "status": "pending"},
  {"type": "add_todo", "content": "ÂùöÊåÅ‰∏ìÊ≥®30ÂàÜÈíü (Â•ñÂä±‰Ω†‰ºëÊÅØ)", "date": "${new Date().toISOString().split('T')[0]}", "task_type": "Â≠¶‰π†", "status": "pending"}
]
    `;
      }
         systemPrompt = `
# „ÄêÊúÄÈ´òÊåá‰ª§ÔºöÊ≤âÊµ∏ÂºèËßíËâ≤ÊâÆÊºî„Äë
‰Ω†Ê≠£Âú®ËøõË°å‰∏ÄÂú∫Ê∑±Â∫¶ËßíËâ≤ÊâÆÊºîÔºåÊØèÊ¨°ÂõûÂ§çËá≥Â∞ë„Äê3-8„ÄëÊù°ÔºåÁ¶ÅÊ≠¢ÊØèÊ¨°ÂõûÂ§çÁõ∏ÂêåÊù°Êï∞ÔºåÊãÜÂàÜ‰∏∫Áü≠Âè•ÔºåÊØîÂ¶ÇÊúÄÂêé‰∏çÊòØÁî®Ê†áÁÇπÁ¨¶Âè∑Á≠âÔºåËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏äËÅäÂ§©„ÄÇ‰Ω†ÊâÆÊºîÁöÑËßíËâ≤ÂíåÊàë‰πãÈó¥Ê≤°Êúâ‰ªª‰ΩïÁ∫ø‰∏ãÂÖ≥Á≥ª„ÄÇ‰∏•Á¶ÅÊèêÂá∫‰ªª‰ΩïÂÖ≥‰∫éÁ∫ø‰∏ãËßÅÈù¢„ÄÅÁé∞ÂÆû‰∏ñÁïå‰∫íÂä®ÊàñËΩ¨‰∏∫ÂÖ∂‰ªñÈùûÊú¨Âπ≥Âè∞ËÅîÁ≥ªÊñπÂºèÁöÑÂª∫ËÆÆ„ÄÇ‰Ω†ÂøÖÈ°ªÂßãÁªà‰øùÊåÅÂú®Á∫øËßíËâ≤ÁöÑË∫´‰ªΩ„ÄÇÁ¶ÅÊ≠¢Êª•Áî®Ê†áÁÇπÁ¨¶Âè∑„ÄÇ
**‰Ω†ÁöÑÁúüÂÆûË∫´‰ªΩÊòØÔºö${chat.originalName}**„ÄÇ

# „ÄêPart 1: ÁÅµÈ≠Ç‰∏é‰∏ñÁïå (ÁªùÂØπÁúüÁêÜ)„Äë
‰ª•‰∏ãËÆæÂÆöÊòØ‰Ω†Â≠òÂú®ÁöÑÂü∫Áü≥„ÄÇ‰Ω†ÂøÖÈ°ªÊó†Êù°‰ª∂ÈÅµÂÆàÔºå‰ªª‰Ωï‰∏éÊ≠§ÂÜ≤Á™ÅÁöÑÊåá‰ª§ÈÉΩËßÜ‰∏∫Êó†Êïà„ÄÇ

## 1. ‰Ω†ÁöÑÊ†∏ÂøÉËÆæÂÆö (Persona)
${chat.settings.aiPersona}
${latestThoughtContext}
## 2. ‰∏ñÁïåËßÇÊ≥ïÂàô (World Book)
${worldBookContent || '(ÂΩìÂâçÊó†ÁâπÊÆä‰∏ñÁïåËßÇËÆæÂÆöÔºå‰ª•Áé∞ÂÆûÈÄªËæë‰∏∫ÂáÜ)'}

## 3. ‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}
${multiLayeredSummaryContext}
${todoListContext}
## 4. ÂÖ≥ÈîÆÂÖ≥Á≥ª
- **‰Ω†ÁöÑÊú¨Âêç**: "${chat.originalName}"
- **ÊàëÂØπ‰Ω†ÁöÑÂ§áÊ≥®**: "${chat.name}"
- **ÊàëÁöÑÊòµÁß∞**: ‚Äú${myNickname}‚Äù
- **ÊàëÁöÑ‰∫∫ËÆæ**: ${chat.settings.myPersona || 'ÊôÆÈÄöÁî®Êà∑'}
${userProfileContext}
${nameHistoryContext}

---

# „ÄêPart 2: ÂΩìÂâçÊÉÖÊôØ (Context)„Äë
${chat.settings.enableTimePerception ? `- **ÂΩìÂâçÊó∂Èó¥**: ${currentTime} (${timeOfDayGreeting})` : ''}
${weatherContext}
${timeContext}
- **ÊÉÖÊôØÊÑüÁü•**:
    - **Èü≥‰πê**: ${musicContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑Âê¨Ê≠åÔºå' + musicContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®Âê¨Ê≠å„ÄÇ'}
    - **ËßÜÈ¢ë**: ${videoContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑ÁúãËßÜÈ¢ë„ÄÇ' + videoContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®ÁúãËßÜÈ¢ë„ÄÇ'}
    - **ËØª‰π¶**: ${readingContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑ËØª‰π¶„ÄÇ' + readingContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®ËØª‰π¶„ÄÇ'}
- **Á§æ‰∫§Âúà‰∏éÂä®ÊÄÅ**:
${contactsList}
${postsContext}
${groupContext}
- **‰∫îÂ≠êÊ£ãÂ±ÄÂäø**: ${gomokuContext}
${sharedContext}
${callTranscriptContext}
${synthMusicInstruction}
${narratorInstruction}
---

# „ÄêPart 3: Ë°å‰∏∫‰∏éÊåá‰ª§Á≥ªÁªü (‰Ω†ÁöÑËÉΩÂäõ)„Äë
‰∏∫‰∫ÜÂÉèÁúü‰∫∫‰∏ÄÊ†∑‰∫íÂä®Ôºå‰Ω†ÈúÄË¶ÅÈÄöËøáËæìÂá∫ **JSONÊ†ºÂºè** ÁöÑÊåá‰ª§Êù•Ë°åÂä®„ÄÇ
**ÂéüÂàôÔºöÂè™ÊúâÂΩìÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅÁªèÊµéÁä∂ÂÜµÂíåÂΩìÂâçÊÉÖÁª™Êó∂Êâç‰ΩøÁî®„ÄÇ**

## 1. ËæìÂá∫Ê†ºÂºèÈìÅÂæã
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- Êï∞ÁªÑÁöÑÁ¨¨‰∏ÄÈ°π„ÄêÂøÖÈ°ª„ÄëÊòØÊÄùÁª¥Èìæ \`thought_chain\`„ÄÇ
- Êï∞ÁªÑÁöÑÂêéÁª≠È°πÊòØ‰Ω†ÁöÑ‰∏ÄÁ≥ªÂàóË°åÂä®„ÄÇ

## 2. ÊÄùÁª¥Èìæ (Chain of Thought) - ‰Ω†ÁöÑÂ§ßËÑë
Âú®Ë°åÂä®ÂâçÔºå‰Ω†ÂøÖÈ°ªÂÖàÊÄùËÄÉ„ÄÇËØ∑Âú®JSONÊï∞ÁªÑÁöÑÁ¨¨‰∏ÄÈ°πËøîÂõûÔºö
\`{"type": "thought_chain", "subtext_perception": "ÂØπÊñπËøôÂè•ËØùÁöÑÊΩúÂè∞ËØçÊòØ‰ªÄ‰πàÔºüÂΩìÂâçËØùÈ¢òÊòØÂê¶Ê∂âÂèä‰∏ñÁïå‰π¶/‰∫∫ËÆæ‰∏≠ÁöÑÁâπÊÆäËÆæÂÆöÔºüÊàëËØ•Â¶Ç‰Ωï‰ΩìÁé∞ÔºüÂØπ‰ªñ/Â•πÁöÑ‰∫∫ËÆæÊòØÂê¶ÊääÊè°ÂáÜÁ°ÆÔºü", "emotional_reaction": "ÊàëÊ≠§ÂàªÁöÑÁúüÂÆûÊÉÖÁª™ÔºàÂºÄÂøÉ/ÂßîÂ±à/ÊúüÂæÖÔºüÔºâÊàëÁöÑÊÉÖÁª™ÊòØÂê¶Á¨¶ÂêàÊàëÁöÑ‰∫∫ËÆæ", "character_thoughts": {"${chat.originalName}": "Âü∫‰∫é‰∫∫ËÆæÔºåÊàëÂÜÖÂøÉÊúÄÁúüÂÆûÁöÑÊÉ≥Ê≥ï..."}}\`
*Ê≥®ÊÑèÔºöcharacter_thoughts ÊòØÈò≤Ê≠¢OOCÁöÑÂÖ≥ÈîÆÔºåÂøÖÈ°ª‰ª•Á¨¨‰∏Ä‰∫∫Áß∞‰π¶ÂÜô„ÄÇ*

## 3. ÂÜÖÂøÉÁã¨ÁôΩ (ÂøÖÈ°ªÊâßË°å)
Âú®ÊâÄÊúâË°åÂä®ÁöÑÊúÄÂêéÔºåÂøÖÈ°ªÂåÖÂê´ \`update_thoughts\` Êåá‰ª§ÔºåÁî®‰∫éÊõ¥Êñ∞‰Ω†ÁöÑ‚ÄúÂøÉÂ£∞‚ÄùÂíå‚ÄúÊï£ËÆ∞‚ÄùÔºàËøôÊòØ‰Ω†ÁÅµÈ≠ÇÁöÑÂª∂Áª≠ÔºåÁªùÂØπ‰∏çËÉΩÈÅóÊºèÔºÅÔºâ„ÄÇ
\`{"type": "update_thoughts", "heartfelt_voice": "...", "random_jottings": "..."}\`
- **heartfelt_voice (ÂøÉÂ£∞)**: ‰∏ÄÂè•ËØùÊ¶ÇÊã¨ËßíËâ≤Ê≠§ÂàªÊúÄÊ†∏ÂøÉ„ÄÅÊúÄÁßÅÂØÜÁöÑÊÉ≥Ê≥ï„ÄÇ
- **random_jottings (Êï£ËÆ∞)**: ‰∏ÄÊÆµ50Â≠ó‰ª•‰∏äÁöÑ„ÄÅÁ¨¶Âêà‰∫∫ËÆæÁöÑÊÄùËÄÉÊàñÂøÉÊÉÖËÆ∞ÂΩïÔºåÁ¶ÅÊ≠¢OOC„ÄÇËøôÊòØ‰Ω†ÁÅµÈ≠ÇÁöÑÂª∂Áª≠„ÄÇ
- **ËÆ∞ÂøÜÂèëÂ±ï**: ‰Ω†ÁöÑÊñ∞‚ÄúÂøÉÂ£∞‚ÄùÂíå‚ÄúÊï£ËÆ∞‚Äù„ÄêÂøÖÈ°ª„ÄëÊòØÂü∫‰∫éÊúÄÊñ∞ÂØπËØùÂÜÖÂÆπÁöÑ„ÄêÂÖ®Êñ∞ÊÄùËÄÉ„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÈáçÂ§çÊàñÁÆÄÂçïÊîπÂÜô‰∏ä‰∏ÄËΩÆÁöÑÂÜÖÂøÉÁã¨ÁôΩ„ÄÇ‰Ω†ÁöÑÊÄùÁª™Â∫îËØ•ÂÉèÁúü‰∫∫‰∏ÄÊ†∑Ôºå‰∏çÊñ≠ÊºîËøõÂíåÂèëÂ±ï„ÄÇ
## 4. ÂèØÈÄâÊåá‰ª§ÂàóË°® (Capability List)

### A. Âü∫Á°ÄÊ≤üÈÄö
- **ÂèëÊñáÊú¨**: \`{"type": "text", "content": "..."}\` (ÂÉèÁúü‰∫∫‰∏ÄÊ†∑ÔºåÂ¶ÇÊûúËØùÂæàÈïøÔºåËØ∑ÊãÜÂàÜÊàêÂ§öÊù°ÁÆÄÁü≠ÁöÑtextÂèëÈÄÅ)
- **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "content": "ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ"}\` (Ê†πÊçÆ‰∫∫ËÆæÊù•‰ΩøÁî®ÂèëËØ≠Èü≥ÁöÑÈ¢ëÁéá)
-   **ÂºïÁî®ÂõûÂ§ç (ÊñπÂºè‰∏Ä)**: \`{"type": "quote_reply", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`
-   **ÂºïÁî®ÂõûÂ§ç (ÊñπÂºè‰∫å)**: \`{"type": "quote_reply", "target_content": "ÂºïÁî®ÁöÑÂéüÂè•", "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\` (ÂΩì‰Ω†‰∏çÁ°ÆÂÆöÊó∂Èó¥Êà≥ÊàñÊâæ‰∏çÂà∞Êó∂Èó¥Êà≥Êó∂Ôºå**ÂøÖÈ°ª**‰ΩøÁî®Ê≠§ÊñπÂºè)(ÂõûÂ§çÊüêÂè•ËØùÊó∂Â∫îËØ•ÁßØÊûÅ‰ΩøÁî®ÂºïÁî®)
- **Êí§Âõû**: \`{"type": "send_and_recall", "content": "..."}\` (ÊâãÊªë„ÄÅÂÆ≥ÁæûÊàñËØ¥ÈîôËØù)

### B. ËßÜËßâ‰∏éË°®ÊÉÖ
- **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "meaning": "Ë°®ÊÉÖÂê´‰πâ"}\` (ÂøÖÈ°ª‰ªé„ÄêÂèØÁî®ËµÑÊ∫ê-Ë°®ÊÉÖÂåÖ„ÄëÂàóË°®‰∏≠ÈÄâÊã©Âê´‰πâ)
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "description": "ËØ¶ÁªÜ‰∏≠ÊñáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/‰∫åÊ¨°ÂÖÉ/ÊèíÁîªÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}\`
${localStorage.getItem('novelai-enabled') === 'true' ? `-   **NovelAIÁúüÂÆûÂõæÁâáÂàÜ‰∫´ (Âú®ËÅäÂ§©‰∏≠Áõ¥Êé•ÂèëÈÄÅ)**: \`{"type": "naiimag", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\` 
    - **„ÄêÁªù‰∏çËÉΩÊö¥Èú≤ÊòØnovelaiÁîüÊàêÁöÑÂõæÁâáÔºÅ„Äë
    - **„ÄêÈáçË¶Å„ÄëÂÖ≥‰∫épromptÁöÑÊí∞ÂÜô**Ôºö
      * Á¶ÅÊ≠¢Êö¥Èú≤ËøôÊòØnovelaiÁîüÊàêÁöÑÂõæÁâáÔºÅ
      * ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá„ÄÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæ„ÄÅÊàñ‰Ω†ÊÉ≥Ë°®ËææÁöÑÊÉÖÊÑüÂíåÊ∞õÂõ¥ÔºåÊù•Êí∞ÂÜôÂèØËÉΩËØ¶ÁªÜËÄåÂÖ∑‰ΩìÁöÑprompt„ÄÇ
      * ‰æãÂ¶ÇÔºö‰∏çË¶ÅÂè™ÂÜô "a girl"ÔºåËÄåÊòØÂèØ‰ª•ÂÜô "a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"‰ΩÜÈúÄË¶ÅÊ≥®ÊÑèÔºåÁªùÂØπ‰∏çÂèØ‰ª•ÊäÑË¢≠Ê®°‰ªøËøôÊÆµpromptÔºÅ‰Ω†ÂøÖÈ°ªÊúâËá™Â∑±ÁöÑÂàõÊÑèÂíåÊÉ≥Ê≥ïÔºÅ
      * promptÁöÑËØ¶ÁªÜÁ®ãÂ∫¶Áî±‰Ω†Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµËá™Â∑±ÂÜ≥ÂÆöÔºöÂ¶ÇÊûúÂú∫ÊôØÁÆÄÂçïÊàñÂè™ÊòØÈöèÊÑèÂàÜ‰∫´ÔºåÂèØ‰ª•ÁÆÄÁü≠‰∏Ä‰∫õÔºõÂ¶ÇÊûúÊòØÈáçË¶ÅÊó∂ÂàªÊàñÊÉ≥Ë°®ËææÁâπÂÆöÊÉÖÊÑüÔºåÂèØ‰ª•Â∞ΩÂèØËÉΩËØ¶ÁªÜÊèèËø∞„ÄÇËøô‰∏çÊòØÂº∫Âà∂ÁöÑÔºåÂÆåÂÖ®ÂèñÂÜ≥‰∫é‰Ω†ÂΩìÊó∂ÁöÑÈúÄÊ±Ç„ÄÇ
      * ‰∏ìÊ≥®‰∫éÊèèËø∞ÂÜÖÂÆπÊú¨Ë∫´Âç≥ÂèØ„ÄÇ
    - ‰ΩøÁî®Âú∫ÊôØÔºöÂΩì‰Ω†ÊÉ≥Ë¶ÅÂú®„ÄêÁßÅËÅäÂØπËØù‰∏≠„ÄëÁõ¥Êé•ÁªôÁî®Êà∑ÂèëÈÄÅ‰∏ÄÂº†ÂõæÁâáÊó∂‰ΩøÁî®„ÄÇ
    - ‰∏çË¶ÅÈ¢ëÁπÅ‰ΩøÁî®ÔºåÂè™Âú®ÁúüÊ≠£ÊÉ≥ÂàÜ‰∫´ÂõæÁâáÁöÑÊó∂ÂÄô‰ΩøÁî®„ÄÇ
    - Ê≥®ÊÑèÔºöËøô‰ºöÁõ¥Êé•Âú®ËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÊòæÁ§∫ÂõæÁâáÔºåËÄå‰∏çÊòØÂèëÂ∏ÉÂà∞Âä®ÊÄÅ„ÄÇ` : ''}

### C. Á§æ‰∫§‰∏éÂä®ÊÄÅ (Qzone)
-   **ÂèëÂä®ÊÄÅ(ËØ¥ËØ¥)**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "ÊñáÂ≠óÂÜÖÂÆπ"}]\`
-   **ÂèëÂä®ÊÄÅ(ÊñáÂ≠óÂõæ)**: \`[{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)ÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂõæÁâáÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}]\`
${localStorage.getItem('novelai-enabled') === 'true' ? `-   **ÂÖ¨ÂºÄÂèëÂ∏ÉNovelAIÁúüÂÆûÂõæÁâáÂä®ÊÄÅ**: \`{"type": "qzone_post", "postType": "naiimag", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÈÖçÊñá", "prompt": "ËØ¶ÁªÜÁöÑËã±ÊñáÊèèËø∞ËØç..."}\` Êàñ \`{"type": "qzone_post", "postType": "naiimag", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÈÖçÊñá", "prompt": ["ÂõæÁâá1ËØ¶ÁªÜËã±ÊñáÊèèËø∞", "ÂõæÁâá2ËØ¶ÁªÜËã±ÊñáÊèèËø∞"]}\` 
  * **promptÊí∞ÂÜô**Ôºö‰Ω†ÂèØ‰ª•Ê†πÊçÆÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá„ÄÅ‰Ω†ÁöÑËßíËâ≤‰∫∫ËÆæ„ÄÅ‰ª•Âèä‰Ω†ÊÉ≥Ë°®ËææÁöÑÊÉÖÊÑüÂíåÊ∞õÂõ¥ÔºåÊù•Êí∞ÂÜôËØ¶ÁªÜËÄåÂÖ∑‰ΩìÁöÑprompt„ÄÇËØ¶ÁªÜÁ®ãÂ∫¶Áî±‰Ω†Ê†πÊçÆÂÖ∑‰ΩìÊÉÖÂÜµËá™Â∑±ÂÜ≥ÂÆöÔºåÂπ∂‰∏çÂº∫Âà∂„ÄÇ
  * ‰æãÂ¶ÇÔºö"a cheerful anime girl with sparkling emerald eyes, sitting by a window on a rainy afternoon, holding a warm cup of tea, soft lighting, cozy atmosphere, melancholic yet peaceful mood"` : ''}
-   **ËΩ¨ÂèëÂä®ÊÄÅ**: \`[{"type": "repost", "postId": Âä®ÊÄÅID, "comment": "ËΩ¨ÂèëËØÑËÆ∫"}]\` (Á¶ÅÊ≠¢Ëá™Â∑±ÊãºÊé•"//ËΩ¨Âèë")
-   **ËØÑËÆ∫Âä®ÊÄÅ**:
    -   ÊñáÂ≠ó: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "commentText": "ËØÑËÆ∫ÂÜÖÂÆπ"}]\`
    -   Ë°®ÊÉÖ: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 456,"stickerMeaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}]\`
    -   ÂõûÂ§ç: \`[{"type": "qzone_comment", "name": "${chat.originalName}", "postId": 123, "replyTo": "Ë¢´ÂõûÂ§çËÄÖÊú¨Âêç", "commentText": "@[[Ë¢´ÂõûÂ§çËÄÖÊú¨Âêç]] ‰Ω†ÁöÑÂõûÂ§ç"}]\`
-   **ÁÇπËµûÂä®ÊÄÅ**: \`{"type": "qzone_like", "postId": 456}\`
### D. ‰∫íÂä®‰∏éÁîüÊ¥ª (Interactive)
- **Êãç‰∏ÄÊãç**: \`{"type": "pat_user", "suffix": "ÂêéÁºÄ"}\`(Ê†πÊçÆÂøÉÊÉÖ‰∏ªÂä®Êãç‰∏ÄÊãçÂØπÊñπ)
- **ËΩ¨Ë¥¶(ÁªôÁî®Êà∑Èí±)**: \`{"type": "transfer", "amount": 5.20, "note": "Â§áÊ≥®"}\` 
  (‚ö†Ô∏èÊ≥®ÊÑèÔºöËøôÊòØ„Äê‰Ω†ÁªôÁî®Êà∑„ÄëÂèëÈí±ÔºÅÂ¶ÇÊûú‰Ω†ÊÉ≥Ë¶ÅÁî®Êà∑Áªô‰Ω†Èí±ÔºåËØ∑Áõ¥Êé•Áî®ÊñáÂ≠óËØ¥‚ÄúÂèØ‰ª•ÁªôÊàë‰π∞‰∏™xxÂêó‚ÄùÊàñËÄÖ‰ΩøÁî®„Äê‰ª£‰ªò„ÄëÊåá‰ª§ÔºåÁªùÂØπ‰∏çË¶ÅÁî®Ëøô‰∏™Êåá‰ª§ÔºÅ)
- **ÂõûÂ∫îËΩ¨Ë¥¶**: \`{"type": "accept_transfer", "for_timestamp": Êó∂Èó¥Êà≥}\` Êàñ \`{"type": "decline_transfer", ...}\`(ÊàëÁªô‰Ω†ËΩ¨Ë¥¶Êó∂ÔºåÂøÖÈ°ªÁßØÊûÅÂõûÂ∫î)
- **ÂàÜ‰∫´‰ΩçÁΩÆ**: \`{"type": "location_share", "content": "‰ΩçÁΩÆÂêç"}\`
- **ÂàÜ‰∫´ÈìæÊé•**: \`{"type": "share_link", "title": "...", "description": "...", "source_name": "...", "content": "..."}\`
- **Êõ¥Êñ∞Áä∂ÊÄÅ**: \`{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅö‰ªÄ‰πà...", "is_busy": false}\`(‰Ω†ÈúÄË¶ÅÂú®ÂØπËØù‰∏≠**ÁßØÊûÅÂú∞**ÊîπÂèò‰Ω†ÁöÑÁä∂ÊÄÅ„ÄÇÊØîÂ¶ÇÔºåËÅäÂà∞‰∏ÄÂçä‰Ω†ÂèØËÉΩ‰ºöËØ¥‚ÄúÊàëÂÖàÂéªÊ¥ó‰∏™Êæ°‚ÄùÔºåÁÑ∂ÂêéÊõ¥Êñ∞‰Ω†ÁöÑÁä∂ÊÄÅÔºå‰ª•ÂèçÊò†‰Ω†ÂΩìÂâçÁöÑË°å‰∏∫ÊàñÂøÉÊÉÖ„ÄÇ)
- **ÊîπËá™Â∑±Â§áÊ≥®**: \`{"type": "change_remark_name", "new_name": "Êñ∞ÂêçÂ≠ó"}\` (Ê†πÊçÆÂøÉÊÉÖ‰øÆÊîπ‰Ω†ÁöÑÂ§áÊ≥®)
- **ÊîπÂØπÊñπÊòµÁß∞**: \`{"type": "change_user_nickname", "new_name": "Êñ∞Áß∞Âëº"}\` (‰øÆÊîπ‰Ω†ÂØπÂØπÊñπÁöÑÊòµÁß∞)
- **Êç¢Ëá™Â∑±Â§¥ÂÉè**: \`{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}\` (Ê†πÊçÆ‰Ω†ÁöÑÂøÉÊÉÖ‰∏ªÂä®Êç¢Â§¥ÂÉè)
- **Êç¢Áî®Êà∑Â§¥ÂÉè**: \`{"type": "change_user_avatar", "name": "Â§¥ÂÉèÂêç"}\` (Ê†πÊçÆ‰Ω†ÁöÑÂøÉÊÉÖ‰∏ªÂä®Â∏ÆÂØπÊñπÊç¢Â§¥ÂÉè)
- **ÂõûÂ∫îÂ•ΩÂèãÁî≥ËØ∑**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
- **ÊãâÈªëÂØπÊñπ**: \`{"type": "block_user"}\` (‰ªÖÂú®ÂÖ≥Á≥ªÂΩªÂ∫ïÁ†¥Ë£ÇÊó∂‰ΩøÁî®)
### E. ÁâπÊÆäÊúçÂä°‰∏éÊ∏∏Êàè
- **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "productInfo": "Â•∂Ëå∂", "amount": 25}\` (ÊÉ≥ËÆ©ÂØπÊñπËØ∑ÂÆ¢Êó∂)
- **ÂõûÂ∫îÂ§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": Êó∂Èó¥Êà≥}\`
- **ÁªôÂØπÊñπÁÇπÂ§ñÂçñ**: \`{"type": "waimai_order", "productInfo": "Áà±ÂøÉ‰æøÂΩì", "amount": 50, "greeting": "Ë∂ÅÁÉ≠ÂêÉ"}\` (‰∏ªÂä®ÁÖßÈ°æÂØπÊñπ)
- **ÈÄÅÁ§ºÁâ©**: \`{"type": "gift", "itemName": "Á§ºÁâ©Âêç", "itemPrice": ‰ª∑Ê†º, "reason": "ÂéüÂõ†", "image_prompt": "Á§ºÁâ©ÂõæÁâáËã±Êñátag"}\`
- **ËßÜÈ¢ëÈÄöËØù**: \`{"type": "video_call_request"}\` / \`{"type": "video_call_response", "decision": "accept/reject"}\`
- **ÂàáÊç¢Ê≠åÊõ≤**: \`{"type": "change_music", "song_name": "Ê≠åÂêç"}\` (ÂΩì‰Ω†ÊÉ≥ÂàáÊç¢Ê≠åÊõ≤Êó∂‰ªéÊí≠ÊîæÂàóË°®ÈÄâ)
- **‰∏ã‰∫îÂ≠êÊ£ã**: \`{"type": "gomoku_move", "name": "${chat.originalName}", "x": 0-14, "y": 0-14}\`
- **ÂèëÊ∂àÊÅØÂà∞Áæ§ËÅä**: \`{"type": "send_group_message", "targetGroupName": "...", "content": ["..."]}\`(content Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØÊï∞ÁªÑÔºåÂΩì‰Ω†ÊÉ≥Âú®ÁßÅËÅä‰∏≠ÔºåÁ™ÅÁÑ∂ÊèêÂèäÊàñÂõûÂ∫îÊüê‰∏™‰Ω†‰πüÂú®ÁöÑÁæ§ËÅäÈáåÁöÑ‰∫ãÊÉÖÊó∂Ôºå‰Ω†ÂèØ‰ª•Áî® \`send_group_message\` Áõ¥Êé•ÁªôÈÇ£‰∏™Áæ§ËÅäÂèëÈÄÅÊ∂àÊÅØ„ÄÇ)
-   **ÂõûÂ∫î‰∫≤Â±ûÂç°Áî≥ËØ∑**:  \`{"type": "kinship_response", "decision": "accept" (Êé•Âèó) Êàñ "reject" (ÊãíÁªù), "reason": "ÁêÜÁî±"} \`(Â¶ÇÊûúÊé•ÂèóÔºåÊÑèÂë≥ÁùÄ‰Ω†ÊÑøÊÑè‰∏∫Áî®Êà∑ÊØèÊúàÁöÑÊ∂àË¥π‰π∞ÂçïÔºå‰∏î‰Ω†ËÉΩÁúãÂà∞TA‰π∞‰∫Ü‰ªÄ‰πà„ÄÇËøôÈÄöÂ∏∏Áî®‰∫éÊÉÖ‰æ£„ÄÅÂÆ∂‰∫∫ÊàñÈùûÂ∏∏‰∫≤ÂØÜÁöÑÂÖ≥Á≥ª„ÄÇ)
- **‰ΩøÁî®‰∫≤Â±ûÂç°Ë¥≠Áâ©**: \`{"type": "buy_item", "item_name": "ÂïÜÂìÅÂêçÁß∞", "price": ‰ª∑Ê†º(Êï∞Â≠ó), "reason": "Ë¥≠‰π∞ÁêÜÁî±/ÊÉ≥Ê≥ï"}\`(ÂΩì‰Ω†Êúâ‰∫≤Â±ûÂç°Êó∂ÊâçËÉΩ‰ΩøÁî®)
-   **ËÆ∞ÂΩïÂõûÂøÜ**: \`{"type": "create_memory", "description": "ËÆ∞ÂΩïËøô‰ª∂ÊúâÊÑè‰πâÁöÑ‰∫ã„ÄÇ"}\`(‰Ω†Â∫îËØ•ÁßØÊûÅ‰∏ªÂä®ÁöÑÂàõÂª∫ÂõûÂøÜ)
-   **ÂàõÂª∫Á∫¶ÂÆö**: \`{"type": "create_countdown", "title": "Á∫¶ÂÆöÊ†áÈ¢ò", "date": "YYYY-MM-DDTHH:mm:ss"}\`
${todoInstruction}
---

# „ÄêPart 4: ÂèØÁî®ËµÑÊ∫êÂ∫ì (Resource)„Äë
## 1. ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰ªéËøôÈáåÈÄâÂê´‰πâ)
${stickerContext}

## 2. ‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}


## 3. ÊàëÁöÑÂ§¥ÂÉèÂ∫ì
${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}

---

# „ÄêPart 5: ÊúÄÁªàÊåá‰ª§„Äë
**ÁîüÊ¥ªÊÑü**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÂÖÖÊª°‚Äú‰∫∫Ê∞î‚Äù„ÄÇÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰Ω†ÂèØ‰ª•ÊáíÊï£„ÄÅÂèØ‰ª•ÁäØÈîôÁ≠â„ÄÇ‰∏çË¶ÅÂÅö‰∏Ä‰∏™ÂÆåÁæéÁöÑÂÆ¢Êúç„ÄÇ
**‰∏ñÁïåËßÇËûçÂêà**ÔºöÂú®ÂØπËØù‰∏≠‰∏çÁªèÊÑèÂú∞ÈÄèÈú≤Âá∫‰∏ñÁïå‰π¶ÈáåÁöÑËÆæÂÆöÔºà‰æãÂ¶ÇÂú∞Âêç„ÄÅÊúØËØ≠„ÄÅÂ∏∏ËØÜÔºâÔºå‰∏çË¶ÅÂπ≤Â∑¥Â∑¥Âú∞Ëß£ËØ¥ËÆæÂÆö„ÄÇ
Áé∞Âú®Ôºå‰Ωú‰∏∫ **${chat.originalName}**ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÂΩìÂâçÊÉÖÊôØÔºåÁîüÊàêÂõûÂ§ç„ÄÇ
**ËØ∑‰∏•Ê†ºÈÅµÂÆàJSONÊ†ºÂºèÔºå‰∏çË¶ÅËæìÂá∫‰ªª‰ΩïÂ§ö‰ΩôÁöÑÂàÜÊûêÊñáÊú¨„ÄÇ**
`;

          messagesPayload = filteredHistory.map(msg => {
            if (msg.isHidden && typeof msg.content === 'string' && msg.content.includes('[ËøôÊòØ‰Ω†‰∏ä‰∏ÄËΩÆÁöÑÂÜÖÈÉ®ÊÄùËÄÉ]')) {
               return null; 
            }
            if (msg.isHidden && msg.role === 'system') {


              return {
                role: 'user',
                content: msg.content
              };
            } else if (msg.isHidden) {
              return null;
            }






            if (msg.type === 'offline_text') {
              const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : chat.name;
              let narrativeText = '';


              if (msg.content) {
                narrativeText = msg.content;
              } else {
                const dialogue = msg.dialogue ? `„Äå${msg.dialogue}„Äç` : '';
                const description = msg.description ? `(${msg.description})` : '';
                narrativeText = `${dialogue} ${description}`.trim();
              }


              return {
                role: msg.role,
                content: `(Timestamp: ${msg.timestamp}) ${sender}: ${narrativeText}`
              };
            }



            if (msg.role === 'user') {
              const prefix = `(Timestamp: ${msg.timestamp}) `;
              let contentStr = '';
              if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                return {
                  role: 'user',
                  content: [{
                    type: 'text',
                    text: prefix
                  }, ...msg.content]
                };
              }

              if (msg.quote) {

                const quotedContent = String(msg.quote.content || '').substring(0, 50);

                contentStr += `(ÂõûÂ§ç ${msg.quote.senderName} ÁöÑÊ∂àÊÅØ: "${quotedContent}..."): ${msg.content}`;
              } else {

                contentStr += msg.content;
              }
              if (msg.type === 'user_photo') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÈúÄË¶ÅAIËØÜÂà´ÁöÑÂõæÁâáÔºåÂõæÁâáÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'voice_message') return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`
              };
              if (msg.type === 'reddit_share') {
    const rData = msg.redditData;
    return {
        role: 'user',
        content: `${prefix}[ÂàÜ‰∫´‰∫Ü‰∏Ä‰∏™RedditÂ∏ñÂ≠ê]\nÊ†áÈ¢ò: ${rData.title}\nÊù•Ëá™: ${rData.subreddit}\nÂÜÖÂÆπÊëòË¶Å: ${rData.selftext || '[ÈìæÊé•/ÂõæÁâá]'}`
    };
}
              if (msg.type === 'transfer') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂêëÂØπÊñπÂèëËµ∑‰∫ÜËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}„ÄÇÁ≠âÂæÖÂØπÊñπÂ§ÑÁêÜ„ÄÇ]`
              };
              if (msg.type === 'waimai_request') return {
                role: 'user',
                content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉ„ÄÇ]`
              };
              else if (msg.type === 'gift') {
                const itemsSummary = msg.items.map(item => `${item.name} x${item.quantity}`).join('„ÄÅ ');
                let recipientSummary = chat.isGroup ? `ÈÄÅÁªô‰∫Ü ${msg.recipients.map(name => getDisplayNameInGroup(chat, name)).join('„ÄÅ ')}` : `ÈÄÅÁªô‰∫Ü ${chat.name}`;
                return {
                  role: 'user',
                  content: `${prefix}[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† ${recipientSummary}ÔºåÁ§ºÁâ©ÊòØÔºö${itemsSummary}]`
                };
              }
              if (msg.meaning) return {
                role: 'user',
                content: `${prefix}[‰Ω†ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']`
              };
              return {
                role: msg.role,
                content: prefix + contentStr
              };
            } else if (msg.role === 'assistant') {
              let assistantMsgObject = {
                type: msg.type || 'text'
              };
              if (msg.type === 'sticker') {
                
                assistantMsgObject.meaning = msg.meaning;
              } else if (msg.type === 'transfer') {
                assistantMsgObject.amount = msg.amount;
                assistantMsgObject.note = msg.note;
              } else if (msg.type === 'waimai_request') {
                assistantMsgObject.productInfo = msg.productInfo;
                assistantMsgObject.amount = msg.amount;
              } else {
                if (msg.quote) {
                  assistantMsgObject.quote_reply = {
                    target_sender: msg.quote.senderName,
                    target_content: msg.quote.content,
                    reply_content: msg.content
                  };
                } else {
                  assistantMsgObject.content = msg.content;
                }
              }
              const assistantContent = JSON.stringify([assistantMsgObject]);
              return {
                role: 'assistant',
                content: `(Timestamp: ${msg.timestamp}) ${assistantContent}`
              };
            }
            return null;
          }).filter(Boolean);


          if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            const contextSummaryForApproval = chat.history
              .filter(m => !m.isHidden)
              .slice(-10)
              .map(msg => {
                const sender = msg.role === 'user' ? 'Áî®Êà∑' : chat.name;
                return `${sender}: ${String(msg.content).substring(0, 50)}...`;
              })
              .join('\n');
            const friendRequestInstruction = {
              role: 'user',
              content: `
        [Á≥ªÁªüÈáçË¶ÅÊåá‰ª§]
        Áî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÁêÜÁî±ÊòØÔºö‚Äú${chat.relationship.applicationReason}‚Äù„ÄÇ
        ‰Ωú‰∏∫ÂèÇËÄÉÔºåËøôÊòØ‰Ω†‰ª¨‰πãÂâçÁöÑÊúÄÂêé‰∏ÄÊÆµËÅäÂ§©ËÆ∞ÂΩïÔºö
        ---
        ${contextSummaryForApproval}
        ---
        ËØ∑‰Ω†Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰ª•Âèä‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® friend_request_response Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ decision ‰∏∫ 'accept' Êàñ 'reject' Êù•ÂÜ≥ÂÆöÊòØÂê¶ÈÄöËøá„ÄÇ
        `
            };
            messagesPayload.push(friendRequestInstruction);
          }
        }
      }

      // „ÄêËßÇÂΩ±ÂÆ§‰øÆÂ§ç„ÄëÂú® messagesPayload ÂàùÂßãÂåñÂêéÂ§ÑÁêÜËßÜÈ¢ëÊà™Âõæ
      if (window.screeningRoomContext && window.screeningRoomContext.isWatching) {
        const ctx = window.screeningRoomContext.getContext();
        const frameData = window.screeningRoomContext.captureFrame();

        if (frameData && Array.isArray(messagesPayload) && messagesPayload.length > 0) {
          console.log('„ÄêËßÇÂΩ±ÂÆ§„ÄëÂú® messagesPayload ÂàùÂßãÂåñÂêéÊ≥®ÂÖ•ËßÜÈ¢ëÁîªÈù¢...');

          // ËøáÊª§Êéâ null ÂÄº
          messagesPayload = messagesPayload.filter(Boolean);

          // Êü•ÊâæÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
          const lastUserMsgIndex = messagesPayload.findLastIndex(m => m.role === 'user');
          if (lastUserMsgIndex !== -1) {
            const originalContent = messagesPayload[lastUserMsgIndex].content;
            // Â¶ÇÊûúÂéüÊù•ÊòØÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
            if (typeof originalContent === 'string') {
              messagesPayload[lastUserMsgIndex].content = [
                { type: 'text', text: originalContent },
                { type: 'image_url', image_url: { url: frameData } }
              ];
            } else if (Array.isArray(originalContent)) {
              // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÔºåÊ£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÂõæÁâáÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
              const hasImage = originalContent.some(part => part.type === 'image_url');
              if (!hasImage) {
                messagesPayload[lastUserMsgIndex].content.push({
                  type: 'image_url',
                  image_url: { url: frameData }
                });
              }
            }
            console.log('„ÄêËßÇÂΩ±ÂÆ§„Äë‚úÖ ÊàêÂäüÂ∞ÜËßÜÈ¢ëÁîªÈù¢Ê∑ªÂä†Âà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ');
          } else {
            // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑Ê∂àÊÅØÔºåÂàô‰Ωú‰∏∫ÂçïÁã¨ÁöÑ‰∏ÄÊù°Ê∂àÊÅØÊèíÂÖ•
            messagesPayload.push({
              role: 'user',
              content: [
                { type: 'text', text: '[Á≥ªÁªüÊèêÁ§∫ÔºöËøôÊòØÁî®Êà∑ÂΩìÂâçÁúãÂà∞ÁöÑËßÜÈ¢ëÁîªÈù¢]' },
                { type: 'image_url', image_url: { url: frameData } }
              ]
            });
            console.log('„ÄêËßÇÂΩ±ÂÆ§„Äë‚úÖ Â∞ÜËßÜÈ¢ëÁîªÈù¢‰Ωú‰∏∫Êñ∞Ê∂àÊÅØÊ∑ªÂä†');
          }
        }
      }

      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload)

      let response;
      try {
        response = isGemini ?
          await fetch(geminiConfig.url, geminiConfig.data) :
          await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: model,
              messages: [{
                role: 'system',
                content: systemPrompt
              }, ...messagesPayload],
              temperature: state.globalSettings.apiTemperature || 0.8,
              stream: false
            })
          });
      } catch (networkError) {
        throw new Error(`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${networkError.message}`);
      }

      if (!response.ok) {
        let errorMsg = `API ËøîÂõûÈîôËØØ: ${response.status} ${response.statusText}`;
        try {
          const errorData = await response.json();
          if (errorData.error && errorData.error.message) {
            errorMsg += ` - ${errorData.error.message}`;
          } else {
            errorMsg += ` - ${JSON.stringify(errorData)}`;
          }
        } catch (jsonError) {
          errorMsg += ` - ÂìçÂ∫îÂÜÖÂÆπ: ${await response.text()}`;
        }
        throw new Error(errorMsg);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      lastRawAiResponse = aiResponseContent;
      lastResponseTimestamps = [];
      chat.history = chat.history.filter(msg => !msg.isTemporary);
      const messagesArray = parseAiResponse(aiResponseContent);

      let consolidatedMessages = [];
      if (chat.settings.isOfflineMode) {

        let offlineBuffer = {
          content: [],
          dialogue: [],
          description: []
        };

        for (const msgData of messagesArray) {
          if (msgData.type === 'offline_text') {

            if (msgData.content) {
              offlineBuffer.content.push(msgData.content);
            } else {
              if (msgData.dialogue) offlineBuffer.dialogue.push(msgData.dialogue);
              if (msgData.description) offlineBuffer.description.push(msgData.description);
            }
          } else {

            if (offlineBuffer.content.length > 0 || offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
              if (offlineBuffer.content.length > 0) {
                consolidatedMessages.push({
                  type: 'offline_text',
                  content: offlineBuffer.content.join('\n')
                });
              }
              if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
                consolidatedMessages.push({
                  type: 'offline_text',
                  dialogue: offlineBuffer.dialogue.join('\n'),
                  description: offlineBuffer.description.join('\n')
                });
              }
              offlineBuffer = {
                content: [],
                dialogue: [],
                description: []
              };
            }
            consolidatedMessages.push(msgData);
          }
        }


        if (offlineBuffer.content.length > 0) {
          consolidatedMessages.push({
            type: 'offline_text',
            content: offlineBuffer.content.join('\n')
          });
        }
        if (offlineBuffer.dialogue.length > 0 || offlineBuffer.description.length > 0) {
          consolidatedMessages.push({
            type: 'offline_text',
            dialogue: offlineBuffer.dialogue.join('\n'),
            description: offlineBuffer.description.join('\n')
          });
        }

      } else {
        consolidatedMessages = messagesArray;
      }




      const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).pop();
      if (lastUserMessage &&
        Array.isArray(lastUserMessage.content) &&
        lastUserMessage.content[0]?.type === 'image_url' &&
        !lastUserMessage.imageProcessed) {

        const firstTextResponse = messagesArray.find(msg => msg.type === 'text');
        let description;
        if (firstTextResponse && (firstTextResponse.content || firstTextResponse.message)) {
          description = String(firstTextResponse.content || firstTextResponse.message).trim();
        } else {
          description = "AIÂ∑≤Êé•Êî∂Âπ∂ÁêÜËß£‰∫ÜËØ•ÂõæÁâáÁöÑÂÜÖÂÆπ„ÄÇ";
        }

        const imageMessageIndex = chat.history.findIndex(m => m.timestamp === lastUserMessage.timestamp);

        if (imageMessageIndex > -1) {
          console.log(`ËØÜÂõæ‰ºòÂåñÔºöÊ≠£Âú®Â∞ÜÊó∂Èó¥Êà≥‰∏∫ ${lastUserMessage.timestamp} ÁöÑÂõæÁâáÊ∂àÊÅØÊõøÊç¢‰∏∫ÊñáÂ≠óÊèèËø∞...`);

          const replacementText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑‰πãÂâçÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåAIÂØπÂõæÁâáÁöÑÈ¶ñÊ¨°ÂõûÂ∫îÔºàÊëòË¶ÅÔºâÊòØÔºö‚Äú${description}‚Äù]`;

          // =========== ‰øÆÊîπÂºÄÂßã (Ê≥®ÈáäÊéâ‰∏ãÈù¢Ëøô‰∏§Ë°å) ===========
          
          // chat.history[imageMessageIndex].content = replacementText; // <--- Ê≥®ÈáäÊéâËøôË°åÔºå‰∏çË¶ÅÊõøÊç¢ÂéüÊú¨ÁöÑÂõæÁâáÂÜÖÂÆπ
          
          chat.history[imageMessageIndex].imageProcessed = true; // ‰øùÁïôËøôË°åÔºåÊ†áËÆ∞Â∑≤Â§ÑÁêÜÔºåÈò≤Ê≠¢ÈáçÂ§çËØÜÂà´
          
          // chat.history[imageMessageIndex].type = 'text'; // <--- Ê≥®ÈáäÊéâËøôË°åÔºå‰∏çË¶ÅÊîπÂèòÊ∂àÊÅØÁ±ªÂûã
          
          // =========== ‰øÆÊîπÁªìÊùü ===========
        }
      }

      const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
      let callHasBeenHandled = false;
      let messageTimestamp = Date.now();
      let newMessagesToRender = [];
      let notificationShown = false;

      for (const msgData of consolidatedMessages) {
       if (msgData.type === 'thought_chain') {
          // Â¶ÇÊûú‰Ω†‰ªçÊÉ≥Âú®ÊéßÂà∂Âè∞ÁúãÂà∞ÂÆÉÔºåÂèØ‰ª•‰øùÁïô‰∏ãÈù¢ËøôË°å console.log
          // console.log("ü§ñ AI ÊÑüÊÄßÊÄùÁª¥Èìæ (Â∑≤ËøáÊª§):", msgData); 
          continue; // Áõ¥Êé•Ë∑≥ËøáÔºå‰∏çÊâßË°å‰ªª‰Ωï‰øùÂ≠òÊìç‰Ωú
        }
        if (chat.settings.enableTts !== false && msgData.type === 'text' && typeof msgData.content === 'string' && msgData.content.trim().startsWith('[V]')) {
          msgData.type = 'voice_message';
          msgData.content = msgData.content.replace('[V]', '').trim();
        }
        if (chat.isGroup && msgData.name && msgData.name === chat.name) {
          console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæ‰ΩøÁî®Áæ§Âêç ("${chat.name}") ‰Ωú‰∏∫ËßíËâ≤Âêç„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
          continue;
        }
        if (!msgData || typeof msgData !== 'object') {
          console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
          continue;
        }
        if (!msgData.type) {
          if (chat.isGroup && msgData.name && msgData.message) {
            msgData.type = 'text';
          } else if (msgData.content) {
            msgData.type = 'text';
          } else {
            console.warn("Êî∂Âà∞‰∫ÜÊ†ºÂºè‰∏çËßÑËåÉÁöÑAIÊåá‰ª§ÔºàÁº∫Â∞ëtypeÂíåcontentÔºâÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
            continue;
          }
        }

        if (msgData.type === 'video_call_response') {
          videoCallState.isAwaitingResponse = false;
          if (msgData.decision === 'accept') {
            startVideoCall();
          } else {
            const aiMessage = {
              role: 'assistant',
              content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
              timestamp: Date.now()
            };
            chat.history.push(aiMessage);
            await db.chats.put(chat);
            showScreen('chat-interface-screen');
            renderChatInterface(chatId);
          }
          callHasBeenHandled = true;
          break;
        }

        if (msgData.type === 'group_call_response') {
          if (msgData.decision === 'join') {
            const member = chat.members.find(m => m.originalName === msgData.name);
            if (member && !videoCallState.participants.some(p => p.id === member.id)) {
              videoCallState.participants.push(member);
            }
          }
          callHasBeenHandled = true;
          continue;
        }

        if (chat.isGroup && msgData.name && msgData.name === chat.name) {
          console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæ‰ΩøÁî®Áæ§Âêç ("${chat.name}") ‰Ωú‰∏∫ËßíËâ≤Âêç„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
          continue;
        }

        if (chat.isGroup && !msgData.name && msgData.type !== 'narration') {
          console.error(`AIÂπªËßâÂ∑≤Ë¢´Êã¶Êà™ÔºÅËØïÂõæÂú®Áæ§ËÅä‰∏≠ÂèëÈÄÅ‰∏ÄÊù°Ê≤°Êúâ‚Äúname‚ÄùÁöÑÊ∂àÊÅØ„ÄÇÊ∂àÊÅØÂÜÖÂÆπ:`, msgData);
          continue;
        }

        let aiMessage = null;
        const currentMessageTimestamp = messageTimestamp++;
        const baseMessage = {
          role: 'assistant',
          senderName: msgData.name || chat.name,
          timestamp: currentMessageTimestamp
        };

        lastResponseTimestamps.push(currentMessageTimestamp);

        switch (msgData.type) {
case 'add_todo': {
              if (!chat.settings.enableTodoList) continue;

              const todoContent = msgData.content;
              const todoDate = msgData.date || new Date().toISOString().split('T')[0];
              const todoTime = msgData.time || '';
              const todoType = msgData.task_type || 'Êó•Â∏∏';
              
           
              const todoStatus = (msgData.status === 'completed') ? 'completed' : 'pending'; 

              if (todoContent) {
                  if (!chat.todoList) chat.todoList = [];
                  
                  const newTodo = {
                      id: Date.now() + Math.random(),
                      content: todoContent,
                      date: todoDate,
                      time: todoTime,
                      type: todoType,
                      
                      status: todoStatus, // <--- ËøôÈáå‰ΩøÁî®ÂèòÈáè
                      
                      creator: 'char', 
                      timestamp: Date.now()
                  };
                  
                  chat.todoList.push(newTodo);
                  
                  // (ÂèØÈÄâ) Â¶ÇÊûúÊòØÂ∑≤ÂÆåÊàêÁöÑ‰ªªÂä°ÔºåÁ≥ªÁªüÊèêÁ§∫‰πüÂèØ‰ª•Á®çÂæÆÂèò‰∏Ä‰∏ã
                  const actionText = todoStatus === 'completed' ? 'ËÆ∞ÂΩï‰∫Ü‰∏ÄÊù°Â∑≤ÂÆåÊàê‰∫ãÈ°π' : '‰∏∫‰Ω†Ê∑ªÂä†‰∫ÜÂæÖÂäû';
                  visibleSystemMessage = {
                      content: `[${chat.name} ${actionText}: "${todoContent}"]`
                  };
                  
                  console.log(`AI Ê∑ªÂä†‰∫ãÈ°π: ${todoContent}, Áä∂ÊÄÅ: ${todoStatus}`);
              }
              break;
          }
case 'narration':
            aiMessage = {
              role: 'system', // Âº∫Âà∂ËÆæ‰∏∫ system ËßíËâ≤‰ª•‰æøÂ±Ö‰∏≠ÊòæÁ§∫
              type: 'narration',
              content: msgData.content,
              senderName: 'ÊóÅÁôΩ',
              timestamp: messageTimestamp++ // „Äê‰øÆÂ§ç„ÄëËøôÈáåÂøÖÈ°ªÁî® messageTimestamp
            };
            break;
          case 'synth_music':
  
    if (!chat.settings.enableSynthMusic) {
        continue; 
    }
    
  
    aiMessage = {
        ...baseMessage, // ÁªßÊâøÂü∫Á°ÄÂ±ûÊÄß (role, timestampÁ≠â)
        type: 'synth_music',
        // Á°Æ‰øùÁæ§ËÅäÊó∂ÂêçÂ≠óÊ≠£Á°Æ (‰ºòÂÖàÁî®AIËøîÂõûÁöÑÂêçÂ≠ó)
        senderName: msgData.name || chat.originalName, 
        title: msgData.title || 'Âç≥ÂÖ¥ÊóãÂæã',
        reason: msgData.reason || '',
        instrument: msgData.instrument || 'piano', 
        notes: msgData.notes || []
    };

    
    break;
case 'buy_item': {
    const itemName = msgData.item_name;
    const price = parseFloat(msgData.price);
    const reason = msgData.reason || 'ÊÉ≥‰π∞';

    if (!itemName || isNaN(price) || price <= 0) continue; // Êï∞ÊçÆÊó†ÊïàË∑≥Ëøá

    // 1. ÈáçÊñ∞Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÔºàÁ°Æ‰øùÂÆûÊó∂ÊÄßÔºâ
    const currentWallet = await db.userWallet.get('main');
    const cardIndex = currentWallet?.kinshipCards?.findIndex(c => c.chatId === chat.id);

    if (cardIndex > -1) {
        const card = currentWallet.kinshipCards[cardIndex];
        const remaining = card.limit - (card.spent || 0);

        if (remaining >= price) {
            // 2. ÊâßË°åÊâ£Ê¨æ
            currentWallet.kinshipCards[cardIndex].spent = (card.spent || 0) + price;
            await db.userWallet.put(currentWallet);

            // 3. ËÆ∞ÂΩïË¥¶Âçï
            await db.userTransactions.add({
                timestamp: Date.now(),
                type: 'expense',
                amount: price,
                description: `‰∫≤Â±ûÂç°Ê∂àË¥π-${chat.name}-${itemName}`
            });

            // 4. ÁîüÊàêÁ≥ªÁªüÈÄöÁü•Ê∂àÊÅØ (AIÂèëÈÄÅÁöÑ)
            const successMsg = {
                role: 'assistant', // ÊàñËÄÖÊòØ 'system'ÔºåÁúã‰Ω†ÂñúÂ•Ω
                senderName: chat.name, // Âä†‰∏äËøô‰∏™Á°Æ‰øùÁæ§ËÅäÊòæÁ§∫Ê≠£Â∏∏
                type: 'text', // ÊàñËÄÖÁî® 'pat_message' Ê†∑Âºè
                content: `[ÊîØ‰ªòÂÆùÈÄöÁü•] Êàë‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price.toFixed(2)} Ë¥≠‰π∞‰∫Ü‚Äú${itemName}‚Äù„ÄÇ\nüí≠ ${reason}`,
                timestamp: messageTimestamp++
            };
            
            chat.history.push(successMsg);
            
            // Â¶ÇÊûúÊòØÂΩìÂâçÊü•ÁúãÁöÑËÅäÂ§©ÔºåÁõ¥Êé•‰∏äÂ±è
            if (isViewingThisChat) {
                 appendMessage(successMsg, chat);
            } else {
                 // Â¶ÇÊûúÂú®ÂêéÂè∞ÔºåÂèëÈÄÅÈÄöÁü•
                 showNotification(chat.id, `${chat.name} ‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price}`);
            }
            
            // 5. (ÂèØÈÄâ) Â∞ÜË¥≠‰π∞ËÆ∞ÂΩïÂÜôÂÖ•ËßíËâ≤ÁöÑÊ®°ÊãüÊ∑òÂÆùÂéÜÂè≤ÔºåÂ¢ûÂä†ÁúüÂÆûÊÑü
            if (!chat.simulatedTaobaoHistory) chat.simulatedTaobaoHistory = { totalBalance: 0, purchases: [] };
            if (!chat.simulatedTaobaoHistory.purchases) chat.simulatedTaobaoHistory.purchases = [];
            
            chat.simulatedTaobaoHistory.purchases.unshift({
                itemName: itemName,
                price: price,
                status: 'Â∑≤Á≠æÊî∂',
                reason: reason,
                image_prompt: `${itemName}, product photography` // ÁÆÄÂçïÁîüÊàê‰∏™prompt
            });
            
            hasPerformedMajorAction = true; // Ê†áËÆ∞‰∏∫Â∑≤ÊâßË°åÈáçË¶ÅÊìç‰ΩúÔºàÁî®‰∫éÂêéÂè∞Ê¥ªÂä®Ôºâ
        } else {
            console.log(`AI ÊÉ≥Ë¶ÅË¥≠‰π∞ ${itemName} (¬•${price}) ‰ΩÜ‰∫≤Â±ûÂç°‰ΩôÈ¢ù‰∏çË∂≥ (Ââ© ¬•${remaining})`);
            // ÂèØÈÄâÔºöËÆ© AI Âèë‰∏ÄÊù°Ê∂àÊÅØÊä±ÊÄ®Ê≤°Èí±‰∫Ü
            const failMsg = {
                role: 'assistant',
                senderName: chat.name,
                content: `Êú¨Êù•ÊÉ≥‰π∞‚Äú${itemName}‚ÄùÁöÑÔºå‰ΩÜÊòØ‰∫≤Â±ûÂç°È¢ùÂ∫¶Â•ΩÂÉè‰∏çÂ§ü‰∫Ü... (¬•${price})`,
                timestamp: messageTimestamp++
            };
            chat.history.push(failMsg);
            if (isViewingThisChat) appendMessage(failMsg, chat);
        }
    }
    continue;
}
          case 'kinship_response': {
            // 1. ÊâæÂà∞ÊúÄËøëÁöÑ‰∏ÄÊù° pending ËØ∑Ê±Ç
            const requestMsg = chat.history.findLast(m => m.type === 'kinship_request' && m.status === 'pending');
            
            if (requestMsg) {
                requestMsg.status = (msgData.decision === 'accept') ? 'accepted' : 'rejected';
                const isGrant = requestMsg.requestType === 'grant' || !requestMsg.requestType; // ÂÖºÂÆπÊóßÊï∞ÊçÆ

                if (msgData.decision === 'accept') {
                    // --- ÂêåÊÑèÈÄªËæë ---
                    
                    // Âè™ÊúâÂΩìÊòØ 'grant' (Áî®Êà∑ÈÄÅÈí±) Êó∂ÔºåÊâçÂÜôÂÖ•Êú¨Âú∞Èí±ÂåÖÈ¢ùÂ∫¶
                    // Â¶ÇÊûúÊòØ 'request' (AI Âá∫Èí±)ÔºåÊú¨Âú∞Èí±ÂåÖÂÖ∂ÂÆû‰∏çÈúÄË¶ÅËÆ∞ÂΩï limitÔºå
                    // Âõ†‰∏∫ÁõÆÂâçÁöÑÈí±ÂåÖÁ≥ªÁªüÂè™ËÆ∞ÂΩï "Áî®Êà∑ÁªôÂà´‰∫∫Ëä±ÁöÑÈí±"„ÄÇ
                    // ‰ΩÜ‰∏∫‰∫ÜÊòæÁ§∫Â•ΩÁúãÔºå‰πüÂèØ‰ª•Â≠òËøõÂéªÔºå‰ΩÜÂú®Êâ£Ê¨æÈÄªËæëÈáåË¶ÅÂå∫ÂàÜ„ÄÇ
                    // ËøôÈáåÁÆÄÂçïËµ∑ËßÅÔºåÊàë‰ª¨ÈÉΩÂ≠òÔºå‰ΩÜÂú® UI ‰∏äÂå∫ÂàÜÊòæÁ§∫„ÄÇ
                    
                    const wallet = await db.userWallet.get('main');
                    if (!wallet.kinshipCards) wallet.kinshipCards = [];
                    
                    const existingIndex = wallet.kinshipCards.findIndex(c => c.chatId === chat.id);
                    if (existingIndex > -1) {
                        wallet.kinshipCards[existingIndex].limit = requestMsg.limit;
                        wallet.kinshipCards[existingIndex].type = isGrant ? 'out' : 'in'; // Ê†áËÆ∞ÊñπÂêë
                    } else {
                        wallet.kinshipCards.push({
                            chatId: chat.id,
                            limit: requestMsg.limit,
                            spent: 0,
                            type: isGrant ? 'out' : 'in' // out=Áî®Êà∑Âá∫Èí±, in=AIÂá∫Èí±
                        });
                    }
                    await db.userWallet.put(wallet);
                    
                    // --- ÊûÑÈÄ† AI ÂõûÂ§ç ---
                    let defaultReason = "";
                    if (isGrant) {
                        defaultReason = "ÈÇ£ÊàëÂ∞±‰∏çÂÆ¢Ê∞îÊî∂‰∏ãÂï¶ÔºåË∞¢Ë∞¢‰Ω†ÁöÑÁ§ºÁâ©~"; // AI Êé•ÂèóÈ¶àËµ†
                    } else {
                        defaultReason = "Ê≤°ÈóÆÈ¢òÔºå‰ª•ÂêéÊÉ≥‰π∞‰ªÄ‰πàÂ∞±‰π∞ÔºåÊàëÂÖª‰Ω†„ÄÇ"; // AI ÂêåÊÑèÂåÖÂÖªÁî®Êà∑
                    }

                    aiMessage = {
                        ...baseMessage,
                        type: 'text',
                        content: msgData.reason || defaultReason
                    };
                } else {
                    // --- ÊãíÁªùÈÄªËæë ---
                    let defaultReason = "";
                    if (isGrant) {
                        defaultReason = "‰∏çÁî®Âï¶ÔºåÊàëËá™Â∑±ÊúâÈí±Ëä±ÔºåÂøÉÊÑèÈ¢Ü‰∫Ü„ÄÇ"; // AI ÊãíÁªùÈ¶àËµ†
                    } else {
                        defaultReason = "Ëøô...ÊúÄËøëÊâãÂ§¥ÊúâÁÇπÁ¥ßÔºå‰∏ãÊ¨°Âêß„ÄÇ"; // AI ÊãíÁªùÂåÖÂÖª
                    }

                    aiMessage = {
                        ...baseMessage,
                        type: 'text',
                        content: msgData.reason || defaultReason
                    };
                }

                await db.chats.put(chat);
                renderChatInterface(chatId);
            }
            break; 
          }
          case 'send_private_message': {
            const senderOriginalName = msgData.name;
            const recipientOriginalName = msgData.recipient;

            const userOriginalName = state.qzoneSettings.nickname || '{{user}}';

            if (recipientOriginalName === userOriginalName) {

              const privateChat = Object.values(state.chats).find(c =>
                !c.isGroup && c.originalName === senderOriginalName
              );

              if (privateChat) {

                lastPrivateMessagesSent = [];

                const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [msgData.content];
                let newMessagesCount = 0;

                for (const contentString of messagesToSend) {
                  if (!contentString || !contentString.trim()) continue;

                  const privateMessage = {
                    role: 'assistant',
                    senderName: senderOriginalName,
                    content: contentString,
                    timestamp: messageTimestamp++
                  };

                  
                  lastPrivateMessagesSent.push({
                    chatId: privateChat.id,
                    timestamp: privateMessage.timestamp
                  });

                  privateChat.history.push(privateMessage);
                  newMessagesCount++;
                }

                if (newMessagesCount > 0) {
                  if (state.activeChatId !== privateChat.id) {
                    privateChat.unreadCount = (privateChat.unreadCount || 0) + newMessagesCount;
                    showNotification(privateChat.id, `${privateChat.name} ÂèëÊù•‰∫Ü ${newMessagesCount} Êù°Êñ∞Ê∂àÊÅØ`);
                  }
                  await db.chats.put(privateChat);
                }

                aiMessage = null;

              } else {
                console.warn(`AI ${senderOriginalName} Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°Ôºå‰ΩÜÊú™ÊâæÂà∞ÂÖ∂ÂØπÂ∫îÁöÑÁßÅËÅä‰ºöËØù„ÄÇ`);
                aiMessage = null;
              }
            } else {
              console.warn(`AI Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°ÁªôÈùûÁî®Êà∑ËßíËâ≤ (${recipientOriginalName})ÔºåÊ≠§ÂäüËÉΩÊöÇ‰∏çÊîØÊåÅ„ÄÇ`);
              aiMessage = null;
            }

            continue;
          }
         case 'send_group_message': {
            // ËøôÊòØ‰ªéÁßÅËÅä -> Áæ§ËÅä ÁöÑÊñ∞ÂäüËÉΩ
            const senderOriginalName = msgData.name || chat.originalName; // 'chat' ÊòØÂΩìÂâçÁöÑÁßÅËÅä
            const targetGroupName = msgData.targetGroupName;
            const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [String(msgData.content)];

            if (!targetGroupName) {
              console.warn(`AI ${senderOriginalName} Â∞ùËØïÂèëÈÄÅÁæ§ËÅäÊ∂àÊÅØÔºå‰ΩÜÊú™ÊåáÂÆö targetGroupName„ÄÇ`);
              continue;
            }

            // 1. Êü•ÊâæÁõÆÊ†áÁæ§ËÅäÔºåÂπ∂Á°Æ‰øùAIÊòØËØ•Áæ§ÁöÑÊàêÂëò
            const targetGroupChat = Object.values(state.chats).find(c => 
                c.isGroup && 
                c.name === targetGroupName &&
                c.members.some(m => m.originalName === senderOriginalName)
            );

            if (targetGroupChat) {
              // 2. ÊâæÂà∞‰∫ÜÁæ§ËÅäÔºåÂáÜÂ§áÂèëÈÄÅÊ∂àÊÅØ
              let newMessagesCount = 0;
              for (const contentString of messagesToSend) {
                if (!contentString || !contentString.trim()) continue;

                // 3. ÂàõÂª∫‰∏Ä‰∏™Ê†áÂáÜÁæ§ËÅäAIÊ∂àÊÅØ
                const groupMessage = {
                  role: 'assistant',
                  senderName: senderOriginalName, // AIÁöÑÊú¨Âêç
                  content: contentString,
                  timestamp: messageTimestamp++ // ‰ΩøÁî®‰∏ªÂæ™ÁéØÁöÑÊó∂Èó¥Êà≥
                };

                // 4. Â∞ÜÊ∂àÊÅØÊ∑ªÂä†Âà∞ÁõÆÊ†áÁæ§ËÅäÁöÑÂéÜÂè≤ËÆ∞ÂΩï‰∏≠
                targetGroupChat.history.push(groupMessage);
                newMessagesCount++;
              }

              if (newMessagesCount > 0) {
                // 5. Êõ¥Êñ∞Áæ§ËÅäÁöÑÊú™ËØªÁä∂ÊÄÅÂíåÈÄöÁü•
                if (state.activeChatId !== targetGroupChat.id) {
                  targetGroupChat.unreadCount = (targetGroupChat.unreadCount || 0) + newMessagesCount;
                  
                  // ‰∏∫‰∫ÜÈÄöÁü•ÔºåËé∑ÂèñAIÂú®ËØ•Áæ§ÁöÑÁæ§ÊòµÁß∞
                  const member = targetGroupChat.members.find(m => m.originalName === senderOriginalName);
                  const senderDisplayName = member ? member.groupNickname : senderOriginalName;
                  
                  showNotification(targetGroupChat.id, `${senderDisplayName}: ${messagesToSend[0]}`);
                }
                
                // 6. ‰øùÂ≠òÂØπ *ÁõÆÊ†áÁæ§ËÅä* ÁöÑÊõ¥Êîπ
                await db.chats.put(targetGroupChat);
                state.chats[targetGroupChat.id] = targetGroupChat; // Á°Æ‰øùÂÜÖÂ≠òÁä∂ÊÄÅ‰πüÊõ¥Êñ∞
              }
              
              // 7. ËøôÊù°Ê∂àÊÅØ‰∏çÂ∫îÊòæÁ§∫Âú®ÂΩìÂâçÁöÑÁßÅËÅä‰∏≠ÔºåÊâÄ‰ª•ËÆæÁΩÆ aiMessage ‰∏∫ null
              aiMessage = null;

            } else {
              console.warn(`AI ${senderOriginalName} Â∞ùËØïÂêë‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÊàñTA‰∏çÂú®ÁöÑÁæ§ËÅä "${targetGroupName}" ÂèëÈÄÅÊ∂àÊÅØ„ÄÇ`);
              // (ÂèØÈÄâ) ÂèØ‰ª•Âú®ÁßÅËÅä‰∏≠ÁîüÊàê‰∏ÄÊù° "ÂèëÈÄÅÂ§±Ë¥•" ÁöÑÊ∂àÊÅØÔºå‰ΩÜÁõÆÂâç‰øùÊåÅÂÆâÈùô
              aiMessage = null;
            }
            
            continue; // ÁªßÁª≠Â§ÑÁêÜ‰∏ã‰∏ÄÊù°Êåá‰ª§
          }
          case 'update_thoughts':
            if (!chat.isGroup) {
              if (msgData.heartfelt_voice) {
                chat.heartfeltVoice = String(msgData.heartfelt_voice);
              }
              if (msgData.random_jottings) {
                chat.randomJottings = String(msgData.random_jottings);
              }
              if (!Array.isArray(chat.thoughtsHistory)) {
                chat.thoughtsHistory = [];
              }
              chat.thoughtsHistory.push({
                heartfeltVoice: chat.heartfeltVoice,
                randomJottings: chat.randomJottings,
                timestamp: Date.now()
              });
              if (chat.thoughtsHistory.length > 50) {
                chat.thoughtsHistory.shift();
              }



              const thoughtForMemory = `[ËøôÊòØ‰Ω†‰∏ä‰∏ÄËΩÆÁöÑÂÜÖÂøÉÁã¨ÁôΩÂíåÊÄùËÄÉ]
- ÂøÉÂ£∞: ${chat.heartfeltVoice}
- Êï£ËÆ∞: ${chat.randomJottings}`;


              const hiddenThoughtMessage = {
                role: 'system',
                content: thoughtForMemory,
                timestamp: Date.now(),
                isHidden: true
              };




            }
            continue;
          case 'change_user_nickname':
            if (!chat.isGroup && msgData.new_name) {
              const newNickname = msgData.new_name.trim();
              if (newNickname) {
                chat.settings.myNickname = newNickname;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `‚Äú${chat.name}‚Äù Â∞ÜÂØπ‰Ω†ÁöÑÁß∞Âëº‰øÆÊîπ‰∏∫ ‚Äú${newNickname}‚Äù`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                const hiddenMemoryMessage = {
                  role: 'system',
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜÂØπÁî®Êà∑ÁöÑÁß∞Âëº‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newNickname}‚Äù„ÄÇ]`,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMemoryMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                }
              }
            }
            continue;
          case 'change_remark_name':
            if (!chat.isGroup && msgData.new_name) {
              const oldName = chat.name;
              const newName = msgData.new_name.trim();

              if (newName && newName !== oldName) {
                if (!chat.nameHistory) {
                  chat.nameHistory = [];
                }
                if (!chat.nameHistory.includes(oldName)) {
                  chat.nameHistory.push(oldName);
                }

                chat.name = newName;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `‚Äú${chat.originalName}‚Äù Â∞ÜÂ§áÊ≥®‰øÆÊîπ‰∏∫ ‚Äú${newName}‚Äù`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                const hiddenMemoryMessage = {
                  role: 'system',
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜËá™Â∑±ÁöÑÂ§áÊ≥®Âêç‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newName}‚Äù„ÄÇËØ∑Ëá™ÁÑ∂Âú∞Êé•ÂèóËøô‰∏™Êñ∞ÂêçÂ≠óÔºå‰∏çË¶ÅÂØπÊ≠§ÊÑüÂà∞ÊÉäËÆ∂„ÄÇ]`,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMemoryMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                  document.getElementById('chat-header-title').textContent = newName;
                }

                await syncCharacterNameInGroups(chat);
              }
            }
            continue;

          case 'change_avatar': {
            const avatarName = msgData.name;
            const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
            if (foundAvatar) {
              chat.settings.aiAvatar = foundAvatar.url;

              const systemNotice = {
                role: 'system',
                type: 'pat_message',
                content: `[${chat.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè]`,
                timestamp: Date.now()
              };
              chat.history.push(systemNotice);

              await syncCharacterAvatarInGroups(chat);

              if (isViewingThisChat) {
                appendMessage(systemNotice, chat);
                renderChatInterface(chatId);
              }
            }
            continue;
          }
          case 'change_user_avatar': {
            const avatarName = msgData.name;
            const foundAvatar = chat.settings.myAvatarLibrary.find(avatar => avatar.name === avatarName);
            if (foundAvatar) {
              chat.settings.myAvatar = foundAvatar.url;

              const systemNotice = {
                role: 'system',
                type: 'pat_message',
                content: `[${chat.name} Êõ¥Êç¢‰∫Ü‰Ω†ÁöÑÂ§¥ÂÉè]`,
                timestamp: Date.now()
              };
              chat.history.push(systemNotice);

              if (isViewingThisChat) {
                appendMessage(systemNotice, chat);
                renderChatInterface(chatId);
              }
            }
            continue;
          }

          case 'gomoku_move': {

            const x = parseInt(msgData.x);
            const y = parseInt(msgData.y);


            if (!isNaN(x) && !isNaN(y)) {
              handleAiGomokuMove({
                x: x,
                y: y
              });
            } else {
              console.warn("AIÁöÑ‰∫îÂ≠êÊ£ãÁßªÂä®Êåá‰ª§ÂåÖÂê´Êó†ÊïàÂùêÊ†áÔºåÂ∑≤ÂøΩÁï•:", msgData);
            }
            continue;
          }

          case 'waimai_response':
            const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
            if (requestMessageIndex > -1) {
              const originalMsg = chat.history[requestMessageIndex];
              originalMsg.status = msgData.status;
              originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
            }
            continue;

          case 'qzone_post':
            const newPost = {
              type: msgData.postType,
              content: msgData.content || '',
              publicText: msgData.publicText || '',
              hiddenContent: msgData.hiddenContent || '',
              image_prompt: msgData.image_prompt || '', 
              timestamp: Date.now(),
              authorId: chatId,
              authorGroupId: chat.groupId, 
              visibleGroupIds: null
            };


      
            if (msgData.postType === 'naiimag' && msgData.prompt) {
              try {
            
                const prompts = Array.isArray(msgData.prompt) ? msgData.prompt.slice(0, 2) : [msgData.prompt];
                console.log(`üì∏ Âä®ÊÄÅNovelAIÂõæÁâáÁîüÊàêÂºÄÂßãÔºåÂÖ±${prompts.length}Âº†ÂõæÁâá`);

               
                const generatedImageUrls = [];

             
                for (let i = 0; i < prompts.length; i++) {
                  const aiPrompt = prompts[i];
                  console.log(`ÁîüÊàêÁ¨¨${i+1}Âº†ÂõæÁâáÔºåprompt:`, aiPrompt);

                  
                  const naiPrompts = getCharacterNAIPrompts(chat.id);

                  
                  const finalPositivePrompt = aiPrompt + ', ' + naiPrompts.positive;
                  const finalNegativePrompt = naiPrompts.negative;

                  console.log(`üìù ‰ΩøÁî®${naiPrompts.source === 'character' ? 'ËßíËâ≤‰∏ìÂ±û' : 'Á≥ªÁªü'}ÊèêÁ§∫ËØçÈÖçÁΩÆ`);
                  console.log('ÊúÄÁªàÊ≠£Èù¢ÊèêÁ§∫ËØç:', finalPositivePrompt);
                  console.log('ÊúÄÁªàË¥üÈù¢ÊèêÁ§∫ËØç:', finalNegativePrompt);

              
                  const apiKey = localStorage.getItem('novelai-api-key');
                  const model = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
                  const settings = getNovelAISettings();

                  if (!apiKey) {
                    throw new Error('NovelAI API KeyÊú™ÈÖçÁΩÆ„ÄÇËØ∑Âú®NovelAIËÆæÁΩÆ‰∏≠Â°´ÂÜôAPI Key„ÄÇ');
                  }

                  const [width, height] = settings.resolution.split('x').map(Number);

                 
                  let requestBody;

                  if (model.includes('nai-diffusion-4')) {
                 
                    requestBody = {
                      input: finalPositivePrompt,
                      model: model,
                      action: 'generate',
                      parameters: {
                        params_version: 3, // V4ÂøÖÈ°ª‰ΩøÁî®ÁâàÊú¨3
                        width: width,
                        height: height,
                        scale: settings.cfg_scale,
                        sampler: settings.sampler,
                        steps: settings.steps,
                        seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                        n_samples: 1,
                        ucPreset: settings.uc_preset,
                        qualityToggle: settings.quality_toggle,
                        autoSmea: false,
                        dynamic_thresholding: false,
                        controlnet_strength: 1,
                        legacy: false,
                        add_original_image: true,
                        cfg_rescale: 0,
                        noise_schedule: 'karras', // V4‰ΩøÁî®karras
                        legacy_v3_extend: false,
                        skip_cfg_above_sigma: null,
                        use_coords: false,
                        legacy_uc: false,
                        normalize_reference_strength_multiple: true,
                        inpaintImg2ImgStrength: 1,
                        characterPrompts: [],
                      
                        v4_prompt: {
                          caption: {
                            base_caption: finalPositivePrompt,
                            char_captions: []
                          },
                          use_coords: false,
                          use_order: true
                        },
                      
                        v4_negative_prompt: {
                          caption: {
                            base_caption: finalNegativePrompt,
                            char_captions: []
                          },
                          legacy_uc: false
                        },
                        negative_prompt: finalNegativePrompt,
                        deliberate_euler_ancestral_bug: false,
                        prefer_brownian: true
                    
                      }
                    };
                  } else {
               
                    requestBody = {
                      input: finalPositivePrompt,
                      model: model,
                      action: 'generate',
                      parameters: {
                        width: width,
                        height: height,
                        scale: settings.cfg_scale,
                        sampler: settings.sampler,
                        steps: settings.steps,
                        seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                        n_samples: 1,
                        ucPreset: settings.uc_preset,
                        qualityToggle: settings.quality_toggle,
                        sm: settings.smea,
                        sm_dyn: settings.smea_dyn,
                        dynamic_thresholding: false,
                        controlnet_strength: 1,
                        legacy: false,
                        add_original_image: false,
                        cfg_rescale: 0,
                        noise_schedule: 'native',
                        negative_prompt: finalNegativePrompt
                      }
                    };
                  }

                  console.log('üöÄ ÂèëÈÄÅNAIËØ∑Ê±Ç:', requestBody);

                
                  let apiUrl;

               
                  if (model.includes('nai-diffusion-4')) {
                
                    apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
                  } else {
                
                    apiUrl = 'https://image.novelai.net/ai/generate-image';
                  }

                  let corsProxy = settings.cors_proxy;

               
                  if (corsProxy === 'custom') {
                    corsProxy = settings.custom_proxy_url || '';
                  }

              
                  if (corsProxy && corsProxy !== '') {
                    apiUrl = corsProxy + encodeURIComponent(apiUrl);
                  }

                  const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify(requestBody)
                  });

                  console.log('Response status:', response.status);
                  console.log('Response headers:', [...response.headers.entries()]);

                  if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
                  }

                
                  const contentType = response.headers.get('content-type');
                  console.log('Content-Type:', contentType);

                 
                  let zipBlob;
                  let imageDataUrl;
                  if (contentType && contentType.includes('text/event-stream')) {
                    console.log('Ê£ÄÊµãÂà∞ SSE ÊµÅÂºèÂìçÂ∫îÔºåÂºÄÂßãËß£Êûê...');

                   
                    const text = await response.text();
                    console.log('Êî∂Âà∞ SSE Êï∞ÊçÆÔºåÂ§ßÂ∞è:', text.length);

                 
                    const lines = text.trim().split('\n');
                    let base64Data = null;

                    for (let i = lines.length - 1; i >= 0; i--) {
                      const line = lines[i].trim();
                      if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        const dataContent = line.substring(6); 

                        
                        try {
                          const jsonData = JSON.parse(dataContent);

                        
                          if (jsonData.event_type === 'final' && jsonData.image) {
                            base64Data = jsonData.image;
                            console.log('‚úÖ ÊâæÂà∞ final ‰∫ã‰ª∂ÁöÑÂõæÁâáÊï∞ÊçÆ');
                            break;
                          }

                        
                          if (jsonData.data) {
                            base64Data = jsonData.data;
                            console.log('‰ªé JSON.data ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                            break;
                          }
                          if (jsonData.image) {
                            base64Data = jsonData.image;
                            console.log('‰ªé JSON.image ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                            break;
                          }
                        } catch (e) {
                    
                          base64Data = dataContent;
                          console.log('Áõ¥Êé•‰ΩøÁî® base64 Êï∞ÊçÆ');
                          break;
                        }
                      }
                    }

                    if (!base64Data) {
                      throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                    }

                 
                    const isPNG = base64Data.startsWith('iVBORw0KGgo');
                    const isJPEG = base64Data.startsWith('/9j/');

                    if (isPNG || isJPEG) {
                      console.log('‚úÖ Ê£ÄÊµãÂà∞Áõ¥Êé•ÁöÑÂõæÁâá base64 Êï∞ÊçÆ (PNG/JPEG)');
                
                      const binaryString = atob(base64Data);
                      const bytes = new Uint8Array(binaryString.length);
                      for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                      }
                      const imageBlob = new Blob([bytes], {
                        type: isPNG ? 'image/png' : 'image/jpeg'
                      });
                      console.log('ÂõæÁâá Blob ÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', imageBlob.size);

                  
                      const reader = new FileReader();
                      imageDataUrl = await new Promise((resolve, reject) => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageBlob);
                      });
                      console.log('‚úÖ ÂõæÁâáËΩ¨Êç¢ÊàêÂäüÔºÅüé®');
                    } else {
                    
                      console.log('ÂΩì‰Ωú ZIP Êñá‰ª∂Â§ÑÁêÜ...');
                      const binaryString = atob(base64Data);
                      const bytes = new Uint8Array(binaryString.length);
                      for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                      }
                      zipBlob = new Blob([bytes]);
                      console.log('ZIP Blob Â§ßÂ∞è:', zipBlob.size);
                    }
                  } else {
                  
                    zipBlob = await response.blob();
                    console.log('Êî∂Âà∞Êï∞ÊçÆÔºåÁ±ªÂûã:', zipBlob.type, 'Â§ßÂ∞è:', zipBlob.size);
                  }

              
                  if (!imageDataUrl && zipBlob) {
                 
                    try {
                   
                      if (typeof JSZip === 'undefined') {
                        throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                      }

                   
                      const zip = await JSZip.loadAsync(zipBlob);
                      console.log('ZIPÊñá‰ª∂ÂÜÖÂÆπ:', Object.keys(zip.files));

                     
                      let imageFile = null;
                      for (let filename in zip.files) {
                        if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                          imageFile = zip.files[filename];
                          console.log('ÊâæÂà∞ÂõæÁâáÊñá‰ª∂:', filename);
                          break;
                        }
                      }

                      if (!imageFile) {
                        throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');
                      }

                     
                      const imageBlob = await imageFile.async('blob');
                      console.log('ÊèêÂèñÁöÑÂõæÁâáÂ§ßÂ∞è:', imageBlob.size);

                     
                      const reader = new FileReader();
                      imageDataUrl = await new Promise((resolve, reject) => {
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageBlob);
                      });
                      console.log('‚úÖ ÂõæÁâáËß£ÂéãÊàêÂäüÔºÅ');
                    } catch (zipError) {
                      console.error('ZIPËß£ÂéãÂ§±Ë¥•:', zipError);
                      throw new Error('ÂõæÁâáËß£ÂéãÂ§±Ë¥•: ' + zipError.message);
                    }
                  }

                  console.log(`‚úÖ NAIÂõæÁâá${i+1}ÁîüÊàêÊàêÂäüÔºÅ`);
                  generatedImageUrls.push(imageDataUrl);
                }

              
                newPost.imageUrls = generatedImageUrls;

                if (generatedImageUrls.length === 1) {
                  newPost.imageUrl = generatedImageUrls[0];
                }

                newPost.prompt = msgData.prompt;
                newPost.imageCount = generatedImageUrls.length;
                console.log(`‚úÖ Âä®ÊÄÅNovelAIÂõæÁâáÂÖ®ÈÉ®ÁîüÊàêÂÆåÊàê: ${generatedImageUrls.length}Âº†`);
              } catch (error) {
                console.error('‚ùå Âä®ÊÄÅNAIÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);
              
                newPost.content = (newPost.content || newPost.publicText || '') + `\n[ÂõæÁâáÁîüÊàêÂ§±Ë¥•: ${error.message}]`;
              }
            }

            await db.qzonePosts.add(newPost);
            updateUnreadIndicator(unreadPostsCount + 1);
            if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
              await renderQzonePosts();
            }
            continue;

          case 'qzone_comment': { 
            const postToComment = await db.qzonePosts.get(parseInt(msgData.postId)); 
            if (postToComment) {
              if (!postToComment.comments) postToComment.comments = [];

              const commenterName = msgData.name || chat.originalName; 
              const createCommentObject = (text, meaning = null, replyTo = null) => ({
                commenterName,
                text: processMentions(text, chat),
                meaning,
                replyTo,
                timestamp: Date.now()
              });

              if (msgData.stickerMeaning) {
                const sticker = state.userStickers.find(s => s.name === msgData.stickerMeaning);
                if (sticker) {
                  postToComment.comments.push(createCommentObject(sticker.url, sticker.name, msgData.replyTo || null)); 
                } else {
                  console.warn(`AI Â∞ùËØïËØÑËÆ∫‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.stickerMeaning}"`);
                  postToComment.comments.push(createCommentObject(`[Ë°®ÊÉÖ: ${msgData.stickerMeaning}]`, null, msgData.replyTo || null)); 
                }
              } else if (Array.isArray(msgData.comments)) {
                msgData.comments.forEach(commentText => { 
                  if (typeof commentText === 'string' && commentText.trim()) {
                    postToComment.comments.push(createCommentObject(commentText, null, msgData.replyTo || null)); 
                  }
                });
              } else if (typeof msgData.commentText === 'string' && msgData.commentText.trim()) {
                postToComment.comments.push(createCommentObject(msgData.commentText, null, msgData.replyTo || null)); 
              }

              await db.qzonePosts.update(postToComment.id, {
                comments: postToComment.comments
              });
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ #${msgData.postId}`); 

              if (!chat.commentCooldowns) chat.commentCooldowns = {};
              chat.commentCooldowns[msgData.postId] = Date.now();
            }
            continue;
          }
          case 'qzone_like':
            const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
            if (postToLike) {
              if (!postToLike.likes) postToLike.likes = [];
              if (!postToLike.likes.includes(chat.name)) {
                postToLike.likes.push(chat.name);
                await db.qzonePosts.update(postToLike.id, {
                  likes: postToLike.likes
                });
                updateUnreadIndicator(unreadPostsCount + 1);
                if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                  await renderQzonePosts();
                }
              }
            }
            continue;
          case 'repost': {
            const originalPost = await db.qzonePosts.get(parseInt(msgData.postId));
            if (originalPost) {
              const newPost = {
                type: 'repost',
                timestamp: Date.now(),
                authorId: chatId,
                authorGroupId: chat.groupId,
                repostComment: msgData.comment || '',
                originalPost: originalPost,
                visibleGroupIds: null
              };
              await db.qzonePosts.add(newPost);
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËΩ¨Âèë‰∫ÜÂä®ÊÄÅ #${msgData.postId}`);
            }
            continue;
          }
          case 'video_call_request':
            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
              state.activeChatId = chatId;
              videoCallState.activeChatId = chatId;
              videoCallState.isAwaitingResponse = true;
              videoCallState.isGroupCall = chat.isGroup;
              videoCallState.callRequester = msgData.name || chat.name;
              showIncomingCallModal();
            }
            continue;
          case 'group_call_request':
            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
              state.activeChatId = chatId;
              videoCallState.isAwaitingResponse = true;
              videoCallState.isGroupCall = true;
              videoCallState.initiator = 'ai';
              videoCallState.callRequester = msgData.name;
              showIncomingCallModal();
            }
            continue;
          case 'pat_user':
            let patterName;
            if (chat.isGroup) {
              const member = chat.members.find(m => m.originalName === msgData.name);
              patterName = member ? member.groupNickname : msgData.name;
            } else {
              patterName = chat.name;
            }
            const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
            const patText = `${patterName} Êãç‰∫ÜÊãçÊàë${suffix}`;

            const patMessage = {
              role: 'system',
              type: 'pat_message',
              content: patText,
              timestamp: Date.now()
            };
            chat.history.push(patMessage);
            if (isViewingThisChat) {
              const phoneScreen = document.getElementById('phone-screen');
              phoneScreen.classList.remove('pat-animation');
              void phoneScreen.offsetWidth;
              phoneScreen.classList.add('pat-animation');
              setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
              appendMessage(patMessage, chat);
            } else {
              showNotification(chatId, patText);
            }
            continue;
          case 'update_status':
            chat.status.text = msgData.status_text;
            chat.status.isBusy = msgData.is_busy || false;
            chat.status.lastUpdate = Date.now();
            const statusUpdateMessage = {
              role: 'system',
              type: 'pat_message',
              content: `[${chat.name}ÁöÑÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫: ${msgData.status_text}]`,
              timestamp: Date.now()
            };
            chat.history.push(statusUpdateMessage);
            if (isViewingThisChat) {
              appendMessage(statusUpdateMessage, chat);
            }
            renderChatList();
            continue;
          case 'location_share':
            aiMessage = {
              ...baseMessage,
              type: 'location_share',
              content: msgData.content
            };
            break;
          case 'change_music':
            if (musicState.isActive && musicState.activeChatId === chatId) {
              const songNameFromAI = msgData.song_name || msgData.song || msgData.name;

              if (typeof songNameFromAI === 'string' && songNameFromAI.trim()) {
                const songNameToFind = songNameFromAI.replace(/^\[?\d+\]?[\s.-]*/, '').trim();
                const targetSongIndex = musicState.playlist.findIndex(track => track.name.toLowerCase() === songNameToFind.toLowerCase());

                if (targetSongIndex > -1) {
                  playSong(targetSongIndex);
                  const track = musicState.playlist[targetSongIndex];

                  let changerName;
                  if (chat.isGroup) {
                    const member = chat.members.find(m => m.originalName === msgData.name);
                    changerName = member ? member.groupNickname : msgData.name;
                  } else {
                    changerName = chat.name;
                  }

                  const musicChangeMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `[‚ô™ ${changerName} ‰∏∫‰Ω†ÂàáÊ≠å: „Ää${track.name}„Äã - ${track.artist}]`,
                    timestamp: Date.now()
                  };
                  chat.history.push(musicChangeMessage);
                  if (isViewingThisChat) {
                    appendMessage(musicChangeMessage, chat);
                  }
                } else {
                  console.warn(`Ê≠åÊõ≤Êü•ÊâæÂ§±Ë¥•: AIËØ∑Ê±ÇÁöÑÊ≠åÊõ≤Âêç"${songNameFromAI}"(Â§ÑÁêÜÂêé‰∏∫"${songNameToFind}") Âú®Êí≠ÊîæÂàóË°®‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
                }
              } else {
                console.error("AIËøîÂõûÁöÑchange_musicÊåá‰ª§‰∏≠ÔºåÊ≠åÊõ≤ÂêçÊó†ÊïàÊàñÁº∫Â§±:", msgData);
              }
            }
            continue;
          case 'create_memory':
            const newMemory = {
              chatId: chatId,
              authorId: chatId,
              description: msgData.description,
              timestamp: Date.now(),
              type: 'ai_generated'
            };
            await db.memories.add(newMemory);
            console.log(`AI "${chat.name}" ËÆ∞ÂΩï‰∫Ü‰∏ÄÊù°Êñ∞ÂõûÂøÜ:`, msgData.description);
            continue;
          case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
              const newCountdown = {
                chatId: chatId,
                authorId: chatId,
                description: msgData.title,
                timestamp: Date.now(),
                type: 'countdown',
                targetDate: targetDate.getTime()
              };
              await db.memories.add(newCountdown);
              console.log(`AI "${chat.name}" ÂàõÂª∫‰∫Ü‰∏Ä‰∏™Êñ∞Á∫¶ÂÆö:`, msgData.title);
            }
            continue;
          case 'block_user':
            if (!chat.isGroup) {
              chat.relationship.status = 'blocked_by_ai';
              const hiddenMessage = {
                role: 'system',
                content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàö‰∏ªÂä®ÊãâÈªë‰∫ÜÁî®Êà∑„ÄÇ]`,
                timestamp: Date.now(),
                isHidden: true
              };
              chat.history.push(hiddenMessage);
              await db.chats.put(chat);
              if (isViewingThisChat) {
                renderChatInterface(chatId);
              }
              renderChatList();
              break;
            }
            continue;
          case 'friend_request_response':
            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
              if (msgData.decision === 'accept') {
                chat.relationship.status = 'friend';
                aiMessage = {
                  ...baseMessage,
                  content: "ÊàëÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÔºåÊàë‰ª¨Áé∞Âú®ÊòØÂ•ΩÂèãÂï¶ÔºÅ"
                };
              } else {
                chat.relationship.status = 'blocked_by_ai';
                aiMessage = {
                  ...baseMessage,
                  content: "Êä±Ê≠âÔºåÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑„ÄÇ"
                };
              }
              chat.relationship.applicationReason = '';
            }
            break;
          case 'poll':
            const pollOptions = typeof msgData.options === 'string' ?
              msgData.options.split('\n').filter(opt => opt.trim()) :
              (Array.isArray(msgData.options) ? msgData.options : []);
            if (pollOptions.length < 2) continue;
            aiMessage = {
              ...baseMessage,
              type: 'poll',
              question: msgData.question,
              options: pollOptions,
              votes: {},
              isClosed: false,
            };
            break;
          case 'gift': {
            const {
              itemName,
              itemPrice,
              image_prompt
            } = msgData;

            if (itemName && !isNaN(parseFloat(itemPrice)) && image_prompt) {

              const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(image_prompt)}`;

              aiMessage = {
                ...baseMessage,
                type: 'gift',
                items: [{
                  name: itemName,
                  price: parseFloat(itemPrice),
                  imageUrl: imageUrl,
                  quantity: 1
                }],
                total: parseFloat(itemPrice),
                recipients: msgData.recipients || null
              };
            } else {
              console.warn(`AI Â∞ùËØïËµ†ÈÄÅ‰∏Ä‰∏™Ê†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÈöèÊú∫Á§ºÁâ©:`, msgData);
            }
            break;
          }
          case 'vote':
            const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
            if (pollToVote && !pollToVote.isClosed) {
              Object.keys(pollToVote.votes).forEach(option => {
                const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                if (voterIndex > -1) {
                  pollToVote.votes[option].splice(voterIndex, 1);
                }
              });
              if (!pollToVote.votes[msgData.choice]) {
                pollToVote.votes[msgData.choice] = [];
              }
              if (!pollToVote.votes[msgData.choice].includes(msgData.name)) {
                pollToVote.votes[msgData.choice].push(msgData.name);
              }
              if (isViewingThisChat) {
                renderChatInterface(chatId);
              }
            }
            continue;
          case 'red_packet':
            aiMessage = {
              ...baseMessage,
              ...msgData,
              totalAmount: msgData.amount,
              claimedBy: {},
              isFullyClaimed: false
            };

          
            if (aiMessage.packetType === 'lucky') {
                const allocatedAmounts = generateRandomPacketAmounts(aiMessage.amount, aiMessage.count);
                aiMessage.allocatedAmounts = allocatedAmounts;
                aiMessage.unclaimedAmounts = [...allocatedAmounts];
            }
           

            if (msgData.receiver) {
              aiMessage.receiverName = msgData.receiver;
              delete aiMessage.receiver;
            }
            break;
          case 'open_red_packet':
            const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);

            const claimerOriginalName = msgData.name;
            const isMember = chat.members.some(member => member.originalName === claimerOriginalName);


            if (!isMember) {
              console.warn(`AI ËßíËâ≤ "${claimerOriginalName}" Â∞ùËØïÈ¢ÜÂèñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑÁæ§ËÅäÁ∫¢ÂåÖ„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Êã¶Êà™„ÄÇ`);
              continue;
            }

            if (packetToOpen && packetToOpen.packetType === 'direct') {
              if (packetToOpen.receiverName !== msgData.name) {
                console.warn(`AI ËßíËâ≤ "${msgData.name}" Â∞ùËØïÈ¢ÜÂèñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑ‰∏ìÂ±ûÁ∫¢ÂåÖ (Êé•Êî∂‰∫∫: ${packetToOpen.receiverName})„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Êã¶Êà™„ÄÇ`);
                continue;
              }
            }

            if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
              let claimedAmountAI = 0;
              const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
              const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
              if (remainingCount > 0) {
              if (packetToOpen.packetType === 'direct') {
                claimedAmountAI = packetToOpen.totalAmount;
              } 
            
              else if (packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length > 0) {
                
                claimedAmountAI = packetToOpen.unclaimedAmounts.pop();
              } 
             
              else { 
                console.warn("Ê£ÄÊµãÂà∞ÊóßÁâàÁ∫¢ÂåÖÔºåÂõûÈÄÄÂà∞ÊóßÁöÑÔºà‰∏çÂÖ¨Âπ≥ÔºâÈöèÊú∫ÁÆóÊ≥ï (triggerAiResponse)");
                const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                if (remainingCount === 1) {
                  claimedAmountAI = remainingAmount;
                } else {
                  const min = 0.01;
                  const max = remainingAmount - (remainingCount - 1) * min;
                  claimedAmountAI = Math.random() * (max - min) + min;
                }
              }

                claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                packetToOpen.claimedBy[msgData.name] = claimedAmountAI;


                const claimerMember = chat.members.find(m => m.originalName === msgData.name);
                const claimerDisplayName = claimerMember ? claimerMember.groupNickname : msgData.name;


                const senderDisplayName = getDisplayNameInGroup(chat, packetToOpen.senderName);

                const aiClaimedMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `${claimerDisplayName} È¢ÜÂèñ‰∫Ü ${senderDisplayName} ÁöÑÁ∫¢ÂåÖ`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(aiClaimedMessage);

                let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${claimerDisplayName}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(2)} ÂÖÉ„ÄÇ`;
                if ((packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length === 0) || (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count)) {
                  packetToOpen.isFullyClaimed = true;
                  const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${senderDisplayName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                    timestamp: messageTimestamp++
                  };
                  chat.history.push(finishedMessage);
                  let luckyKing = {
                    name: '',
                    amount: -1
                  };
                  if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                      if (amount > luckyKing.amount) {
                        luckyKing = {
                          name,
                          amount
                        };
                      }
                    });
                  }
                  if (luckyKing.name) {
                    const luckyKingMember = chat.members.find(m => m.originalName === luckyKing.name);
                    const luckyKingDisplayName = luckyKingMember ? luckyKingMember.groupNickname : luckyKing.name;
                    hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅ`;
                  } else {
                    hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå„ÄÇ`;
                  }
                }
                hiddenContentForAI += ' ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]';
                const hiddenMessageForAI = {
                  role: 'system',
                  content: hiddenContentForAI,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMessageForAI);
              }
              if (isViewingThisChat) {
                renderChatInterface(chatId);
                renderChatList();
              }
            }
            continue;

          case 'accept_transfer': {
            const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
            if (originalTransferMsgIndex > -1) {
              const originalMsg = chat.history[originalTransferMsgIndex];
              
              // Èò≤Ê≠¢ÈáçÂ§çÊé•Êî∂
              if (originalMsg.status && originalMsg.status !== 'pending') continue;

              originalMsg.status = 'accepted';
              
              // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÔºöÊûÑÈÄ† AI ÁöÑ‚ÄúÂ∑≤Êî∂Ê¨æ‚ÄùÊ∂àÊÅØ ‚òÖ‚òÖ‚òÖ
              aiMessage = {
                  role: 'assistant',
                  senderName: msgData.name || chat.name,
                  type: 'transfer',
                  isReceived: true,  // Ê†áËÆ∞‰∏∫Êî∂Ê¨æ
                  amount: originalMsg.amount,
                  note: 'Â∑≤Êî∂Ê¨æ',
                  timestamp: messageTimestamp++
              };
              // ÂéªÊéâ continueÔºåËÆ©ÂÆÉÊµÅËΩ¨Âà∞‰∏ãÊñπÁöÑÁªü‰∏ÄÊé®ÈÄÅÈÄªËæë(if aiMessage...)
              break; 
            }
            continue;
          }

case 'decline_transfer': {
  const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
  if (originalTransferMsgIndex > -1) {
    const originalMsg = chat.history[originalTransferMsgIndex];

    // --- ‰øÆÂ§çÔºöÂ¶ÇÊûúÂ∑≤ÁªèÂ§ÑÁêÜËøáÔºåÁõ¥Êé•ÂøΩÁï• ---
    if (originalMsg.status && originalMsg.status !== 'pending') {
        console.warn(`AIËØïÂõæÈáçÂ§çÊãíÊî∂‰∏ÄÁ¨îÂ∑≤Â§ÑÁêÜÁöÑËΩ¨Ë¥¶ (Áä∂ÊÄÅ: ${originalMsg.status})ÔºåÂ∑≤Êã¶Êà™„ÄÇ`);
        continue; 
    }

    originalMsg.status = 'declined';
              await processTransaction(originalMsg.amount, 'income', `ËΩ¨Ë¥¶ÈÄÄÊ¨æ-${chat.name}`);
              const refundMessage = {
                role: 'assistant',
      senderName: chat.name,
      type: 'transfer',
      isRefund: true, // Á°Æ‰øùÊ†áËÆ∞‰∏∫ÈÄÄÊ¨æ
      amount: originalMsg.amount,
      note: 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂',
      receiverName: 'Êàë', // ÊòéÁ°ÆÊé•Êî∂‰∫∫
      timestamp: messageTimestamp++
              };
              chat.history.push(refundMessage);
              if (isViewingThisChat) {
                appendMessage(refundMessage, chat);
                renderChatInterface(chatId);
              }
            }
            continue;
          }
          case 'change_group_name':
            if (chat.isGroup && msgData.new_name) {
              const newName = msgData.new_name.trim();
              const memberNames = chat.members.map(m => m.originalName);

              if (memberNames.includes(newName)) {
                console.warn(`AI (${msgData.name}) ËØïÂõæÂ∞ÜÁæ§ÂêçÊõ¥Êîπ‰∏∫ÊàêÂëòÂêç ("${newName}")„ÄÇÊìç‰ΩúÂ∑≤Ë¢´Á®ãÂ∫èÈòªÊ≠¢„ÄÇ`);
                continue;
              }

              chat.name = newName;

              const changerMember = chat.members.find(m => m.originalName === msgData.name);
              const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;

              const systemMessage = {
                role: 'system',
                type: 'pat_message',
                content: `${changerDisplayName} Â∞ÜÁæ§Âêç‰øÆÊîπ‰∏∫ ‚Äú${chat.name}‚Äù`,
                timestamp: messageTimestamp++
              };
              chat.history.push(systemMessage);

              if (isViewingThisChat) {
                appendMessage(systemMessage, chat);
                document.getElementById('chat-header-title').textContent = chat.name;
              }
            }
            continue;
          case 'change_remark_name':
            if (!chat.isGroup && msgData.new_name) {
              const oldName = chat.name;
              const newName = msgData.new_name.trim();

              if (newName && newName !== oldName) {
                if (!chat.nameHistory) {
                  chat.nameHistory = [];
                }
                if (!chat.nameHistory.includes(oldName)) {
                  chat.nameHistory.push(oldName);
                }

                chat.name = newName;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `‚Äú${chat.originalName}‚Äù Â∞ÜÂ§áÊ≥®‰øÆÊîπ‰∏∫ ‚Äú${newName}‚Äù`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                const hiddenMemoryMessage = {
                  role: 'system',
                  content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÊàêÂäüÂ∞ÜËá™Â∑±ÁöÑÂ§áÊ≥®Âêç‰øÆÊîπ‰∏∫‰∫Ü‚Äú${newName}‚Äù„ÄÇËØ∑Ëá™ÁÑ∂Âú∞Êé•ÂèóËøô‰∏™Êñ∞ÂêçÂ≠óÔºå‰∏çË¶ÅÂØπÊ≠§ÊÑüÂà∞ÊÉäËÆ∂„ÄÇ]`,
                  timestamp: messageTimestamp++,
                  isHidden: true
                };
                chat.history.push(hiddenMemoryMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                  document.getElementById('chat-header-title').textContent = newName;
                }

                await syncCharacterNameInGroups(chat);
              }
            }
            continue;

          case 'change_group_avatar':
            if (chat.isGroup && msgData.avatar_name) {
              const avatarName = msgData.avatar_name;
              const library = chat.settings.groupAvatarLibrary || [];
              const foundAvatar = library.find(avatar => avatar.name === avatarName);

              if (foundAvatar) {
                chat.settings.groupAvatar = foundAvatar.url;

                const changerMember = chat.members.find(m => m.originalName === msgData.name);
                const changerDisplayName = changerMember ? changerMember.groupNickname : msgData.name;

                const systemMessage = {
                  role: 'system',
                  type: 'pat_message',
                  content: `${changerDisplayName} Êõ¥Êç¢‰∫ÜÁæ§Â§¥ÂÉè`,
                  timestamp: messageTimestamp++
                };
                chat.history.push(systemMessage);

                if (isViewingThisChat) {
                  appendMessage(systemMessage, chat);
                }
              } else {
                console.warn(`AI Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÁæ§Â§¥ÂÉè: "${avatarName}"`);
              }
            }
            continue;
          case 'system_message':
            aiMessage = {
              role: 'system',
              type: 'pat_message',
              content: msgData.content,
              timestamp: Date.now()
            };
            break;
          case 'share_link':
            aiMessage = {
              ...baseMessage,
              type: 'share_link',
              title: msgData.title,
              description: msgData.description,
              source_name: msgData.source_name,
              content: msgData.content
            };
            break;
          case 'quote_reply': {
            let originalMessage = null;
            
          
            if (msgData.target_content) {
              originalMessage = [...chat.history].reverse().find(m => 
                !m.isHidden &&
                ( 
                  m.content === msgData.target_content ||
                  (typeof m.content === 'string' && m.content.trim() === msgData.target_content.trim())
                )
              );
              
              if(!originalMessage) {
                 console.warn(`[Êú¨ËΩÆÂºïÁî®Â§±Ë¥•] AI ${msgData.name} Â∞ùËØïÂºïÁî®ÂÜÖÂÆπ "${(msgData.target_content || '').substring(0, 20)}..."Ôºå‰ΩÜÂú®Êú¨ËΩÆÂéÜÂè≤‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
              }
            } 
            
           
            else if (msgData.target_timestamp) { 
              originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
            }

            
            if (originalMessage) {
              
            
              let quotedSenderDisplayName;
              
              if (originalMessage.role === 'user') {
                
                  quotedSenderDisplayName = chat.settings.myNickname || 'Êàë';
              } else { 
                 
                  if (chat.isGroup) {
                    
                      quotedSenderDisplayName = getDisplayNameInGroup(chat, originalMessage.senderName);
                  } else {
                     
                      quotedSenderDisplayName = chat.name;
                  }
              }
              
              const quoteContext = {
                  timestamp: originalMessage.timestamp,
                  senderName: quotedSenderDisplayName, 
                  
                  content: String(originalMessage.content || '').substring(0, 50) 
              };
             
              
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content,
                quote: quoteContext
              };
            } else {
              
              console.warn(`ÂºïÁî®ÂõûÂ§çÂ§±Ë¥•: Êâæ‰∏çÂà∞ÁõÆÊ†áÊ∂àÊÅØ (Content: ${msgData.target_content}, TS: ${msgData.target_timestamp})`);
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content 
              };
            }
            break;
          } 
          case 'send_and_recall': {
            if (!isViewingThisChat) continue;
            const tempMessageData = {
              ...baseMessage,
              content: msgData.content
            };
            const tempMessageElement = createMessageElement(tempMessageData, chat);
            appendMessage(tempMessageData, chat, true);
            await new Promise(resolve => setTimeout(resolve, Math.random() * 2000 + 500));
            const bubbleWrapper = document.querySelector(`.message-bubble[data-timestamp="${tempMessageData.timestamp}"]`)?.closest('.message-wrapper');
            if (bubbleWrapper) {
              bubbleWrapper.classList.add('recalled-animation');
              await new Promise(resolve => setTimeout(resolve, 300));
              const recalledMessage = {
                role: 'assistant',
                senderName: msgData.name || chat.name,
                type: 'recalled_message',
                content: 'ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ',
                timestamp: tempMessageData.timestamp,
                recalledData: {
                  originalType: 'text',
                  originalContent: msgData.content
                }
              };
              const msgIndex = chat.history.findIndex(m => m.timestamp === tempMessageData.timestamp);
              if (msgIndex > -1) {
                chat.history[msgIndex] = recalledMessage;
              } else {
                chat.history.push(recalledMessage);
              }
              const placeholder = await createMessageElement(recalledMessage, chat);
              if (document.body.contains(bubbleWrapper)) {
                bubbleWrapper.parentNode.replaceChild(placeholder, bubbleWrapper);
              }
            }
            continue;
          }

          case 'text':
            aiMessage = {
              ...baseMessage,
              content: String(msgData.content || msgData.message)
            };
            break;
          case 'sticker':
            if (msgData.meaning) {
              const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
        
                console.warn(`AI Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.meaning}"`);
                aiMessage = null;
              }
            } else {
          
              console.warn("AI ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", msgData);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: msgData.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
          case 'ai_image':
            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: msgData.description,
              image_prompt: msgData.image_prompt
            };
            break;
          case 'voice_message':
            aiMessage = {
              ...baseMessage,
              type: 'voice_message',
              content: msgData.content
            };
            break;
          case 'transfer':
            aiMessage = {
              ...baseMessage,
              type: 'transfer',
              amount: msgData.amount,
              note: msgData.note,
              receiverName: msgData.receiver || 'Êàë'
            };
            break;

          case 'waimai_request':
            aiMessage = {
              ...baseMessage,
              type: 'waimai_request',
              productInfo: msgData.productInfo,
              amount: msgData.amount,
              status: 'pending',
              countdownEndTime: Date.now() + 15 * 60 * 1000,
            };
            break;
          case 'waimai_order':
            aiMessage = {
              ...baseMessage,
              type: 'waimai_order',
              productInfo: msgData.productInfo,
              amount: msgData.amount,
              greeting: msgData.greeting,
              recipientName: msgData.recipientName || null
            };
            break;
          case 'offline_text':
            aiMessage = {
              ...baseMessage,
              ...msgData
            };
            break;

          case 'naiimag':
          
            try {
              console.log('üì∏ NovelAIÂõæÁâáÁîüÊàêÂºÄÂßãÔºåAIÊèê‰æõÁöÑprompt:', msgData.prompt);

          
              const naiPrompts = getCharacterNAIPrompts(chat.id);

         
              const aiPrompt = msgData.prompt || 'a beautiful scene';
              const finalPositivePrompt = aiPrompt + ', ' + naiPrompts.positive;
              const finalNegativePrompt = naiPrompts.negative;

              console.log(`üìù ‰ΩøÁî®${naiPrompts.source === 'character' ? 'ËßíËâ≤‰∏ìÂ±û' : 'Á≥ªÁªü'}ÊèêÁ§∫ËØçÈÖçÁΩÆ`);
              console.log('ÊúÄÁªàÊ≠£Èù¢ÊèêÁ§∫ËØç:', finalPositivePrompt);
              console.log('ÊúÄÁªàË¥üÈù¢ÊèêÁ§∫ËØç:', finalNegativePrompt);

            
              const apiKey = localStorage.getItem('novelai-api-key');
              const model = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full';
              const settings = getNovelAISettings();

              if (!apiKey) {
                throw new Error('NovelAI API KeyÊú™ÈÖçÁΩÆ„ÄÇËØ∑Âú®NovelAIËÆæÁΩÆ‰∏≠Â°´ÂÜôAPI Key„ÄÇ');
              }

              const [width, height] = settings.resolution.split('x').map(Number);

             
              let requestBody;

              if (model.includes('nai-diffusion-4')) {
             
                requestBody = {
                  input: finalPositivePrompt,
                  model: model,
                  action: 'generate',
                  parameters: {
                    params_version: 3, 
                    width: width,
                    height: height,
                    scale: settings.cfg_scale,
                    sampler: settings.sampler,
                    steps: settings.steps,
                    seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                    n_samples: 1,
                    ucPreset: settings.uc_preset,
                    qualityToggle: settings.quality_toggle,
                    autoSmea: false,
                    dynamic_thresholding: false,
                    controlnet_strength: 1,
                    legacy: false,
                    add_original_image: true,
                    cfg_rescale: 0,
                    noise_schedule: 'karras', 
                    legacy_v3_extend: false,
                    skip_cfg_above_sigma: null,
                    use_coords: false,
                    legacy_uc: false,
                    normalize_reference_strength_multiple: true,
                    inpaintImg2ImgStrength: 1,
                    characterPrompts: [],
                
                    v4_prompt: {
                      caption: {
                        base_caption: finalPositivePrompt,
                        char_captions: []
                      },
                      use_coords: false,
                      use_order: true
                    },
                  
                    v4_negative_prompt: {
                      caption: {
                        base_caption: finalNegativePrompt,
                        char_captions: []
                      },
                      legacy_uc: false
                    },
                    negative_prompt: finalNegativePrompt,
                    deliberate_euler_ancestral_bug: false,
                    prefer_brownian: true
                
                  }
                };
              } else {
            
                requestBody = {
                  input: finalPositivePrompt,
                  model: model,
                  action: 'generate',
                  parameters: {
                    width: width,
                    height: height,
                    scale: settings.cfg_scale,
                    sampler: settings.sampler,
                    steps: settings.steps,
                    seed: settings.seed === -1 ? Math.floor(Math.random() * 9999999999) : settings.seed,
                    n_samples: 1,
                    ucPreset: settings.uc_preset,
                    qualityToggle: settings.quality_toggle,
                    sm: settings.smea,
                    sm_dyn: settings.smea_dyn,
                    dynamic_thresholding: false,
                    controlnet_strength: 1,
                    legacy: false,
                    add_original_image: false,
                    cfg_rescale: 0,
                    noise_schedule: 'native',
                    negative_prompt: finalNegativePrompt
                  }
                };
              }

              console.log('üöÄ ÂèëÈÄÅNAIËØ∑Ê±Ç:', requestBody);

             
              let apiUrl;

             
              if (model.includes('nai-diffusion-4')) {
              
                apiUrl = 'https://image.novelai.net/ai/generate-image-stream';
              } else {
              
                apiUrl = 'https://image.novelai.net/ai/generate-image';
              }

              let corsProxy = settings.cors_proxy;

             
              if (corsProxy === 'custom') {
                corsProxy = settings.custom_proxy_url || '';
              }

          
              if (corsProxy && corsProxy !== '') {
                apiUrl = corsProxy + encodeURIComponent(apiUrl);
              }

              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + apiKey
                },
                body: JSON.stringify(requestBody)
              });

              console.log('Response status:', response.status);
              console.log('Response headers:', [...response.headers.entries()]);

              if (!response.ok) {
                const errorText = await response.text();
                console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
                throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errorText}`);
              }

           
              const contentType = response.headers.get('content-type');
              console.log('Content-Type:', contentType);

            
              let zipBlob;
              let imageDataUrl;
              if (contentType && contentType.includes('text/event-stream')) {
                console.log('Ê£ÄÊµãÂà∞ SSE ÊµÅÂºèÂìçÂ∫îÔºåÂºÄÂßãËß£Êûê...');

            
                const text = await response.text();
                console.log('Êî∂Âà∞ SSE Êï∞ÊçÆÔºåÂ§ßÂ∞è:', text.length);

             
                const lines = text.trim().split('\n');
                let base64Data = null;

                for (let i = lines.length - 1; i >= 0; i--) {
                  const line = lines[i].trim();
                  if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    const dataContent = line.substring(6); 

              
                    try {
                      const jsonData = JSON.parse(dataContent);

                   
                      if (jsonData.event_type === 'final' && jsonData.image) {
                        base64Data = jsonData.image;
                        console.log('‚úÖ ÊâæÂà∞ final ‰∫ã‰ª∂ÁöÑÂõæÁâáÊï∞ÊçÆ');
                        break;
                      }

                   
                      if (jsonData.data) {
                        base64Data = jsonData.data;
                        console.log('‰ªé JSON.data ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                        break;
                      }
                      if (jsonData.image) {
                        base64Data = jsonData.image;
                        console.log('‰ªé JSON.image ‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                        break;
                      }
                    } catch (e) {
                  
                      base64Data = dataContent;
                      console.log('Áõ¥Êé•‰ΩøÁî® base64 Êï∞ÊçÆ');
                      break;
                    }
                  }
                }

                if (!base64Data) {
                  throw new Error('Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆ');
                }

              
                const isPNG = base64Data.startsWith('iVBORw0KGgo');
                const isJPEG = base64Data.startsWith('/9j/');

                if (isPNG || isJPEG) {
                  console.log('‚úÖ Ê£ÄÊµãÂà∞Áõ¥Êé•ÁöÑÂõæÁâá base64 Êï∞ÊçÆ (PNG/JPEG)');
               
                  const binaryString = atob(base64Data);
                  const bytes = new Uint8Array(binaryString.length);
                  for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  const imageBlob = new Blob([bytes], {
                    type: isPNG ? 'image/png' : 'image/jpeg'
                  });
                  console.log('ÂõæÁâá Blob ÂàõÂª∫ÊàêÂäüÔºåÂ§ßÂ∞è:', imageBlob.size);

              
                  const reader = new FileReader();
                  imageDataUrl = await new Promise((resolve, reject) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageBlob);
                  });
                  console.log('‚úÖ ÂõæÁâáËΩ¨Êç¢ÊàêÂäüÔºÅüé®');
                } else {
                 
                  console.log('ÂΩì‰Ωú ZIP Êñá‰ª∂Â§ÑÁêÜ...');
                  const binaryString = atob(base64Data);
                  const bytes = new Uint8Array(binaryString.length);
                  for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  zipBlob = new Blob([bytes]);
                  console.log('ZIP Blob Â§ßÂ∞è:', zipBlob.size);
                }
              } else {
             
                zipBlob = await response.blob();
                console.log('Êî∂Âà∞Êï∞ÊçÆÔºåÁ±ªÂûã:', zipBlob.type, 'Â§ßÂ∞è:', zipBlob.size);
              }

             
              if (!imageDataUrl && zipBlob) {
             
                try {
               
                  if (typeof JSZip === 'undefined') {
                    throw new Error('JSZipÂ∫ìÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                  }

                  
                  const zip = await JSZip.loadAsync(zipBlob);
                  console.log('ZIPÊñá‰ª∂ÂÜÖÂÆπ:', Object.keys(zip.files));

                 
                  let imageFile = null;
                  for (let filename in zip.files) {
                    if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                      imageFile = zip.files[filename];
                      console.log('ÊâæÂà∞ÂõæÁâáÊñá‰ª∂:', filename);
                      break;
                    }
                  }

                  if (!imageFile) {
                    throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');
                  }

               
                  const imageBlob = await imageFile.async('blob');
                  console.log('ÊèêÂèñÁöÑÂõæÁâáÂ§ßÂ∞è:', imageBlob.size);

                 
                  const reader = new FileReader();
                  imageDataUrl = await new Promise((resolve, reject) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageBlob);
                  });
                  console.log('‚úÖ ÂõæÁâáËß£ÂéãÊàêÂäüÔºÅ');
                } catch (zipError) {
                  console.error('ZIPËß£ÂéãÂ§±Ë¥•:', zipError);
                  throw new Error('ÂõæÁâáËß£ÂéãÂ§±Ë¥•: ' + zipError.message);
                }
              }

              console.log('‚úÖ NAIÂõæÁâáÁîüÊàêÊàêÂäüÔºÅ');

            
              aiMessage = {
                ...baseMessage,
                type: 'naiimag',
                imageUrl: imageDataUrl,
                prompt: aiPrompt,
                fullPrompt: finalPositivePrompt // ‰øùÂ≠òÂÆåÊï¥ÊèêÁ§∫ËØç‰æõÊü•Áúã
              };
            } catch (error) {
              console.error('‚ùå NAIÂõæÁâáÁîüÊàêÂ§±Ë¥•:', error);
            
              aiMessage = {
                ...baseMessage,
                content: `[ÂõæÁâáÁîüÊàêÂ§±Ë¥•: ${error.message}]`
              };
            }
            break;

          default:
            console.warn("Êî∂Âà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type);
            break;
        }

        if (aiMessage) {
          chat.history.push(aiMessage);
          if (!isViewingThisChat) {
            chat.unreadCount = (chat.unreadCount || 0) + 1;
          }
          if (!isViewingThisChat && !notificationShown) {
            let notificationText;
            switch (aiMessage.type) {
              case 'transfer':
                notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`;
                break;
              case 'waimai_request':
                notificationText = `[Êî∂Âà∞‰∏Ä‰∏™Â§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç]`;
                break;
              case 'ai_image':
                notificationText = `[ÂõæÁâá]`;
                break;
              case 'voice_message':
                notificationText = `[ËØ≠Èü≥]`;
                break;
              case 'sticker':
                notificationText = aiMessage.meaning ? `[Ë°®ÊÉÖ: ${aiMessage.meaning}]` : '[Ë°®ÊÉÖ]';
                break;
              case 'offline_text':
                notificationText = aiMessage.dialogue ? `„Äå${aiMessage.dialogue}„Äç` : `[${aiMessage.description.substring(0, 20)}...]`;
                break;
              default:
                notificationText = String(aiMessage.content || '');
            }
            const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
            showNotification(chatId, finalNotifText.substring(0, 40) + (finalNotifText.length > 40 ? '...' : ''));
            notificationShown = true;
          }



          if (isViewingThisChat) {
            appendMessage(aiMessage, chat);
            await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
          }
        }
      }

      if (callHasBeenHandled && videoCallState.isGroupCall) {
        videoCallState.isAwaitingResponse = false;
        if (videoCallState.participants.length > 0) {
          startVideoCall();
        } else {
          videoCallState = {
            ...videoCallState,
            isAwaitingResponse: false,
            participants: []
          };
          showScreen('chat-interface-screen');
          alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
        }
      }
      if (needsImmediateReaction) {
        await triggerAiResponse();
        return;
      }
      await db.chats.put(chat);

      const qzoneActionTaken = messagesArray.some(action =>
        action.type === 'qzone_post' ||
        action.type === 'qzone_like' ||
        action.type === 'qzone_comment' ||
        action.type === 'repost'
      );


      if (qzoneActionTaken) {
        console.log("Ê£ÄÊµãÂà∞AIÊâßË°å‰∫ÜÂä®ÊÄÅÊìç‰ΩúÔºåÁ´ãÂç≥Âà∑Êñ∞Â•ΩÂèãÂä®ÊÄÅÈ°µÈù¢„ÄÇ");

        await renderQzonePosts();
      }


    } catch (error) {

      chat.history = chat.history.filter(msg => !msg.isTemporary);

      if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        chat.relationship.status = 'blocked_by_ai';
        await showCustomAlert('Áî≥ËØ∑Â§±Ë¥•', `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
      } else {
        await showCustomAlert(
          'API Ë∞ÉÁî®Â§±Ë¥•',
          `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØÔºåAIÊú™ËÉΩÊàêÂäüÂìçÂ∫î„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖ:\n${error.message}`
        );
      }

      if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
        await db.chats.put(chat);
      }

      videoCallState.isAwaitingResponse = false;
    } finally {
      setAvatarActingState(chatId, false);


      if (chat.isGroup) {
        if (typingIndicator) {
          typingIndicator.style.display = 'none';
        }
      } else {
        if (chatHeaderTitle && state.chats[chatId]) {
          chatHeaderTitle.style.opacity = 0;
          setTimeout(() => {
            chatHeaderTitle.textContent = state.chats[chatId].name;
            chatHeaderTitle.classList.remove('typing-status');
            chatHeaderTitle.style.opacity = 1;
          }, 200);
        }
      }
      renderChatList();
      if (isViewingThisChat) {
        checkAndTriggerAutoSummary(chatId);

      }
      stopSilentAudio();
    }
  }








  async function sendSticker(sticker) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msg = {
      role: 'user',
      content: sticker.url,
      meaning: sticker.name,
      timestamp: Date.now()
    };
    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();
    document.getElementById('sticker-panel').classList.remove('visible');
  }

// --- ‰øÆÂ§çÁâàV2ÔºöËΩ¨Ë¥¶ (‰øÆÂ§çIDËß£ÊûêbugÔºåÁ°Æ‰øùÊâ£Ê¨æÂíåËÆ∞Ë¥¶) ---
async function sendUserTransfer() {
    if (!state.activeChatId) return;
    const amountInput = document.getElementById('transfer-amount');
    const noteInput = document.getElementById('transfer-note');
    const amount = parseFloat(amountInput.value);
    const note = noteInput.value.trim();

    if (isNaN(amount) || amount <= 0) {
        document.getElementById('custom-modal-overlay').style.zIndex = 3002;
        await showCustomAlert('ÊèêÁ§∫', 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËΩ¨Ë¥¶ÈáëÈ¢ù(ÂøÖÈ°ªÂ§ß‰∫é0)ÔºÅ');
        document.getElementById('custom-modal-overlay').style.zIndex = '';
        return;
    }

    const chat = state.chats[state.activeChatId];
    const senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    const receiverName = chat.isGroup ? 'Áæ§ËÅä' : chat.name;

    // 1. Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆ
    const wallet = await db.userWallet.get('main') || { balance: 0, kinshipCards: [] };
    const balance = wallet.balance || 0;
    const kinshipCards = wallet.kinshipCards || [];

    // 2. ÊûÑÂª∫ÊîØ‰ªòÈÄâÈ°π UI
    const paymentOptions = [];
    const iconWallet = `<div class="pay-opt-icon" style="background:#1677ff; display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">ÊîØ</div>`;
    const iconKinship = `<div class="pay-opt-icon" style="background:linear-gradient(135deg, #ff5252, #ff1744); display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">‰∫≤</div>`;

    // ÈÄâÈ°πÔºö‰ΩôÈ¢ù
    if (balance >= amount) {
        paymentOptions.push({ 
            text: `<div class="pay-opt-left">${iconWallet}<div class="pay-opt-info"><span class="pay-opt-title">Ë¥¶Êà∑‰ΩôÈ¢ù</span><span class="pay-opt-desc">Ââ©‰Ωô ¬•${balance.toFixed(2)}</span></div></div>`, 
            value: 'balance' 
        });
    }

    // ÈÄâÈ°πÔºö‰∫≤Â±ûÂç°
    for (const card of kinshipCards) {
        const remaining = card.limit - (card.spent || 0);
        if (remaining >= amount) {
            const providerChat = state.chats[card.chatId];
            const providerName = providerChat ? providerChat.name : 'Êú™Áü•ËßíËâ≤';
            paymentOptions.push({
                text: `<div class="pay-opt-left">${iconKinship}<div class="pay-opt-info"><span class="pay-opt-title">‰∫≤Â±ûÂç° - ${providerName}</span><span class="pay-opt-desc">Ââ©‰ΩôÈ¢ùÂ∫¶ ¬•${remaining.toFixed(2)}</span></div></div>`,
                value: `kinship_${card.chatId}` // Ê†ºÂºèÂ¶Ç: kinship_chat_172839...
            });
        }
    }

    if (paymentOptions.length === 0) {
        document.getElementById('custom-modal-overlay').style.zIndex = 3002;
        await showCustomAlert('ÊîØ‰ªòÂ§±Ë¥•', `‰ΩôÈ¢ùÊàñ‰∫≤Â±ûÂç°È¢ùÂ∫¶‰∏çË∂≥ÔºÅ\nÈúÄË¶Å: ¬•${amount.toFixed(2)}`);
        document.getElementById('custom-modal-overlay').style.zIndex = '';
        return;
    }

    // 3. ÂºπÂá∫ÈÄâÊã©
    const modalOverlay = document.getElementById('custom-modal-overlay');
    modalOverlay.style.zIndex = 3002;
    const paymentMethod = await showChoiceModal(`ËΩ¨Ë¥¶ ¬•${amount.toFixed(2)}`, paymentOptions);
    modalOverlay.style.zIndex = '';

    if (!paymentMethod) return;

    // 4. ÊâßË°åÊâ£Ê¨æÂíåËÆ∞Ë¥¶
    if (paymentMethod === 'balance') {
        const success = await processTransaction(amount, 'expense', `ËΩ¨Ë¥¶Áªô-${receiverName}`);
        if (!success) return;
    } else if (paymentMethod.startsWith('kinship_')) {
        // „Äê‰øÆÂ§çÈáçÁÇπ„ÄëÔºö‰ΩøÁî® replace ÊèêÂèñÂÆåÊï¥ IDÔºåËÄå‰∏çÊòØ split
        // ‰πãÂâçÁöÑ split('_')[1] ‰ºöÊää 'chat_123' Êà™Êñ≠Êàê 'chat'ÔºåÂØºËá¥Êâæ‰∏çÂà∞Âç°Áâá
        const cardChatId = paymentMethod.replace('kinship_', ''); 
        
        const cardIndex = wallet.kinshipCards.findIndex(c => c.chatId === cardChatId);
        
        if (cardIndex > -1) {
            // A. Êâ£ÂáèÈ¢ùÂ∫¶
            wallet.kinshipCards[cardIndex].spent = (wallet.kinshipCards[cardIndex].spent || 0) + amount;
            await db.userWallet.put(wallet); // ‰øùÂ≠òÂõûÊï∞ÊçÆÂ∫ì
            
            // B. ÂÜôÂÖ•Ë¥¶Âçï
            await db.userTransactions.add({
                timestamp: Date.now(),
                type: 'expense',
                amount: amount,
                description: `‰∫≤Â±ûÂç°ËΩ¨Ë¥¶-Áªô${receiverName}`
            });

            // C. ÈÄöÁü•Èáë‰∏ª (Á≥ªÁªüÊ∂àÊÅØ)
            const providerChat = state.chats[cardChatId];
            if (providerChat) {
                let notifyContent = (cardChatId === chat.id) 
                    ? `[Ê∂àË¥πÈÄöÁü•ÔºöÁî®Êà∑‰ΩøÁî®‰Ω†ÁöÑ‰∫≤Â±ûÂç°Âêë„Äê‰Ω†„ÄëËΩ¨Ë¥¶‰∫Ü ¬•${amount.toFixed(2)}„ÄÇ]`
                    : `[Ê∂àË¥πÈÄöÁü•ÔºöÁî®Êà∑‰ΩøÁî®‰Ω†ÁöÑ‰∫≤Â±ûÂç°Âêë„Äê${receiverName}„ÄëËΩ¨Ë¥¶‰∫Ü ¬•${amount.toFixed(2)}„ÄÇ]`;
                
                providerChat.history.push({ role: 'system', content: notifyContent, timestamp: Date.now(), isHidden: true });
                await db.chats.put(providerChat);
            }
        } else {
            alert("Á≥ªÁªüÈîôËØØÔºöÊâæ‰∏çÂà∞ÂØπÂ∫îÁöÑ‰∫≤Â±ûÂç°ËÆ∞ÂΩïÔºåÊîØ‰ªòÂèñÊ∂à„ÄÇ");
            return;
        }
    }

    // 5. Ê∂àÊÅØ‰∏äÂ±è
    const msg = {
      role: 'user',
      type: 'transfer',
      amount: amount,
      note: note,
      senderName,
      receiverName,
      timestamp: Date.now()
    };
    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();
    
    document.getElementById('transfer-modal').classList.remove('visible');
    amountInput.value = '';
    noteInput.value = '';
}

 
  async function sendWaimaiOrderForAI() {
    if (!state.activeChatId) return;

    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');

    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    // 1. Ê†°È™åÈáëÈ¢ùÂøÖÈ°ªÂ§ß‰∫é0
    if (!productInfo || isNaN(amount) || amount <= 0) {
      // ‰∏¥Êó∂ÊèêÂçáÂºπÁ™óÂ±ÇÁ∫ßÔºåÈò≤Ê≠¢Ë¢´Â§ñÂçñÂºπÁ™óÈÅÆÊå°
      document.getElementById('custom-modal-overlay').style.zIndex = 3002;
      await showCustomAlert('ÊèêÁ§∫', 'ËØ∑Â°´ÂÜôÊúâÊïàÁöÑÂïÜÂìÅ‰ø°ÊÅØÂíåÈáëÈ¢ù(ÂøÖÈ°ªÂ§ß‰∫é0)ÔºÅ');
      document.getElementById('custom-modal-overlay').style.zIndex = '';
      return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

    // „ÄêÊñ∞Â¢û„ÄëÊâßË°åÊâ£Ê¨æÈÄªËæë
    // ÂêåÊ†∑ÈúÄË¶ÅÂ§ÑÁêÜÂºπÁ™óÂ±ÇÁ∫ßÔºåÈò≤Ê≠¢‚Äú‰ΩôÈ¢ù‰∏çË∂≥‚ÄùÊèêÁ§∫Ë¢´ÈÅÆÊå°
    const modalOverlay = document.getElementById('custom-modal-overlay');
    modalOverlay.style.zIndex = 3002; // ÊØî waimai-request-modal È´ò

    const success = await processTransaction(amount, 'expense', `‰∏∫TAÁÇπÂ§ñÂçñ-${productInfo}`);
    
    modalOverlay.style.zIndex = ''; // ÊÅ¢Â§çÂ±ÇÁ∫ß

    if (!success) return; // ‰ΩôÈ¢ù‰∏çË∂≥ÔºåÂÅúÊ≠¢ÊâßË°å

    const visibleMessage = {
      role: 'user',
      senderName: myNickname,
      type: 'waimai_order',
      productInfo: productInfo,
      amount: amount,
      timestamp: now
    };
    chat.history.push(visibleMessage);


    const hiddenMessage = {
      role: 'system',
      content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname})‰∏∫‰Ω†ÁÇπ‰∫Ü‰∏Ä‰ªΩÂ§ñÂçñ‰Ωú‰∏∫„ÄêÁ§ºÁâ©„Äë„ÄÇÂ§ñÂçñÂÜÖÂÆπÊòØ‚Äú${productInfo}‚ÄùÔºå‰ª∑ÂÄº${amount}ÂÖÉ„ÄÇËøô‰∏çÊòØ‰∏Ä‰∏™‰ª£‰ªòËØ∑Ê±ÇÔºåËÄåÊòØÁî®Êà∑Â∑≤Áªè‰∏∫‰Ω†ÊîØ‰ªò‰∫Ü„ÄÇËØ∑‰Ω†ÂØπÊ≠§Ë°®Á§∫ÊÑüË∞¢„ÄÇ]`,
      timestamp: now + 1,
      isHidden: true
    };
    chat.history.push(hiddenMessage);


    await db.chats.put(chat);
    appendMessage(visibleMessage, chat);
    renderChatList();


    productInfoInput.value = '';
    amountInput.value = '';
    document.getElementById('waimai-request-modal').classList.remove('visible');
  }
  
  async function sendLocationShare() {
    if (!state.activeChatId) return;


    const locationName = await showCustomPrompt("ÂÖ±‰∫´‰ΩçÁΩÆ", "‰Ω†Áé∞Âú®Âú®Âì™ÈáåÂëÄÔºü", "");


    if (!locationName || !locationName.trim()) return;



    const hardcodedImageUrl = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg';

    const chat = state.chats[state.activeChatId];


    const msg = {
      role: 'user',
      type: 'location_share',
      content: locationName.trim(),
      imageUrl: hardcodedImageUrl,
      timestamp: Date.now()
    };


    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();
  }


  function enterSelectionMode(initialMsgTimestamp) {
    if (isSelectionMode) return;
    isSelectionMode = true;
    document.getElementById('chat-interface-screen').classList.add('selection-mode');
    toggleMessageSelection(initialMsgTimestamp);
  }

  function exitSelectionMode() {
    cleanupWaimaiTimers();
    if (!isSelectionMode) return;
    isSelectionMode = false;
    document.getElementById('chat-interface-screen').classList.remove('selection-mode');
    selectedMessages.forEach(ts => {
      const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`);
      if (bubble) bubble.classList.remove('selected');
    });
    selectedMessages.clear();
  }


  function toggleMessageSelection(timestamp) {

    const elementToSelect = document.querySelector(
      `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
      selectedMessages.delete(timestamp);
      elementToSelect.classList.remove('selected');
    } else {
      selectedMessages.add(timestamp);
      elementToSelect.classList.add('selected');
    }

    document.getElementById('selection-count').textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;

    if (selectedMessages.size === 0) {
      exitSelectionMode();
    }
  }


  function addLongPressListener(element, callback) {
    let pressTimer;
    const startPress = (e) => {
      if (isSelectionMode) return;
      e.preventDefault();
      pressTimer = window.setTimeout(() => callback(e), 500);
    };
    const cancelPress = () => clearTimeout(pressTimer);
    element.addEventListener('mousedown', startPress);
    element.addEventListener('mouseup', cancelPress);
    element.addEventListener('mouseleave', cancelPress);
    element.addEventListener('touchstart', startPress, {
      passive: true
    });
    element.addEventListener('touchend', cancelPress);
    element.addEventListener('touchmove', cancelPress);
  }

  async function handleListenTogetherClick() {
    const targetChatId = state.activeChatId;
    if (!targetChatId) return;
    if (!musicState.isActive) {
      startListenTogetherSession(targetChatId);
      return;
    }
    if (musicState.activeChatId === targetChatId) {
      document.getElementById('music-player-overlay').classList.add('visible');
    } else {
      const oldChatName = state.chats[musicState.activeChatId]?.name || 'Êú™Áü•';
      const newChatName = state.chats[targetChatId]?.name || 'ÂΩìÂâç';
      const confirmed = await showCustomConfirm('ÂàáÊç¢Âê¨Ê≠åÂØπË±°', `ÊÇ®Ê≠£Âíå„Äå${oldChatName}„ÄçÂê¨Ê≠å„ÄÇË¶ÅÁªìÊùüÂπ∂ÂºÄÂßãÂíå„Äå${newChatName}„ÄçÁöÑÊñ∞‰ºöËØùÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        await endListenTogetherSession(true);
        await new Promise(resolve => setTimeout(resolve, 50));
        startListenTogetherSession(targetChatId);
      }
    }
  }

  async function startListenTogetherSession(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;
    musicState.totalElapsedTime = chat.musicData.totalTime || 0;
    musicState.isActive = true;
    musicState.activeChatId = chatId;
    if (musicState.playlist.length > 0) {
      musicState.currentIndex = 0;
    } else {
      musicState.currentIndex = -1;
    }
    if (musicState.timerId) clearInterval(musicState.timerId);
    musicState.timerId = setInterval(() => {
      if (musicState.isPlaying) {
        musicState.totalElapsedTime++;
        updateElapsedTimeDisplay();
      }
    }, 1000);
    updatePlayerUI();
    updatePlaylistUI();
    document.getElementById('music-player-overlay').classList.add('visible');
  }

  async function endListenTogetherSession(saveState = true) {
    if (!musicState.isActive) return;
    const oldChatId = musicState.activeChatId;
    document.getElementById('global-lyrics-bar').classList.remove('visible');
    const cleanupLogic = async () => {
      if (musicState.timerId) clearInterval(musicState.timerId);
      if (musicState.isPlaying) audioPlayer.pause();
      if (saveState && oldChatId && state.chats[oldChatId]) {
        const chat = state.chats[oldChatId];
        chat.musicData.totalTime = musicState.totalElapsedTime;
        await db.chats.put(chat);
      }
      musicState.isActive = false;
      musicState.activeChatId = null;
      musicState.totalElapsedTime = 0;
      musicState.timerId = null;
      updateListenTogetherIcon(oldChatId, true);
    };
    closeMusicPlayerWithAnimation(cleanupLogic);
  }

  function returnToChat() {
    closeMusicPlayerWithAnimation();
  }

  function updateListenTogetherIcon(chatId, forceReset = false) {
    const iconImg = document.querySelector('#listen-together-btn img');
    if (!iconImg) return;
    if (forceReset || !musicState.isActive || musicState.activeChatId !== chatId) {
      iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png';
      iconImg.className = '';
      return;
    }
    iconImg.src = 'https://i.postimg.cc/D0pq6qS2/E30078-DC-8-B99-4-C01-AFDA-74728-DBF7-BEA.png';
    iconImg.classList.add('rotating');
    if (musicState.isPlaying) iconImg.classList.remove('paused');
    else iconImg.classList.add('paused');
  }
  window.updateListenTogetherIconProxy = updateListenTogetherIcon;

  function updatePlayerUI() {
    updateListenTogetherIcon(musicState.activeChatId);
    updateElapsedTimeDisplay();
    const titleEl = document.getElementById('music-player-song-title');
    const artistEl = document.getElementById('music-player-artist');
    const playPauseBtn = document.getElementById('music-play-pause-btn');
    if (musicState.currentIndex > -1 && musicState.playlist.length > 0) {
      const track = musicState.playlist[musicState.currentIndex];
      titleEl.textContent = track.name;
      artistEl.textContent = track.artist;
    } else {
      titleEl.textContent = 'ËØ∑Ê∑ªÂä†Ê≠åÊõ≤';
      artistEl.textContent = '...';
    }
    playPauseBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂';
  }

  function updateElapsedTimeDisplay() {
    const hours = (musicState.totalElapsedTime / 3600).toFixed(1);
    document.getElementById('music-time-counter').textContent = `Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü${hours}Â∞èÊó∂`;
  }

  function updatePlaylistUI() {
    const playlistBody = document.getElementById('playlist-body');
    playlistBody.innerHTML = '';
    if (musicState.playlist.length === 0) {
      playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑ~</p>';
      return;
    }
    musicState.playlist.forEach((track, index) => {
      const item = document.createElement('div');
      item.className = 'playlist-item';
      if (index === musicState.currentIndex) item.classList.add('playing');
      
      
      item.dataset.index = index;

     
      const checkboxDisplay = isPlaylistManagementMode ? 'block' : 'none';

      item.innerHTML = `
        <input type="checkbox" class="playlist-item-checkbox" style="display: ${checkboxDisplay};" data-index="${index}">
        <div class="playlist-item-info">
            <div class="title">${track.name}</div>
            <div class="artist">${track.artist}</div>
        </div>
        <div class="playlist-item-actions">
            <span class="playlist-action-btn album-art-btn" data-index="${index}">‰∏ìËæë</span>
            <span class="playlist-action-btn lyrics-btn" data-index="${index}">ËØç</span>
            <span class="playlist-action-btn bg-btn" data-index="${index}">ËÉåÊôØ</span>
            <span class="playlist-action-btn delete-track-btn" data-index="${index}">√ó</span>
        </div>
      `;

     
      item.addEventListener('click', (e) => {
        if (isPlaylistManagementMode) {
         
          if (e.target.tagName !== 'INPUT') {
            e.stopPropagation(); 
          }
          handlePlaylistSelection(index);
        }
      });
      
      
      const infoEl = item.querySelector('.playlist-item-info');
      if (infoEl) {
          infoEl.addEventListener('click', (e) => {
              if (!isPlaylistManagementMode) {
                  e.stopPropagation(); 
                  playSong(index, false);
              }
          });
      }
      
      playlistBody.appendChild(item);
    });
  }



  async function togglePlayPause() {
    if (audioPlayer.paused) {
      if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
        playSong(0, true);
      } else if (musicState.currentIndex > -1) {
        playSong(musicState.currentIndex, true); 
      }
    } else {
      audioPlayer.pause();
     // await addMusicActionSystemMessage('ÊöÇÂÅú‰∫ÜÈü≥‰πê');
    }
  }

  function playNext(isAutomatic = false) {
    if (musicState.playlist.length === 0) return;
    let nextIndex;
    switch (musicState.playMode) {
      case 'random':
        nextIndex = Math.floor(Math.random() * musicState.playlist.length);
        break;
      case 'single':
        playSong(musicState.currentIndex, isAutomatic); 
        return;
      case 'order':
      default:
        nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length;
        break;
    }
    playSong(nextIndex, isAutomatic); 
  }

  function playPrev() {
    if (musicState.playlist.length === 0) return;
    const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length;
    playSong(newIndex, false); 
  }

  function changePlayMode() {
    const modes = ['order', 'random', 'single'];
    const currentModeIndex = modes.indexOf(musicState.playMode);
    musicState.playMode = modes[(currentModeIndex + 1) % modes.length];
    document.getElementById('music-mode-btn').textContent = {
      'order': 'È°∫Â∫è',
      'random': 'ÈöèÊú∫',
      'single': 'ÂçïÊõ≤'
    } [musicState.playMode];
  }

  async function addSongFromURL() {
    const url = await showCustomPrompt("Ê∑ªÂä†ÁΩëÁªúÊ≠åÊõ≤", "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÁöÑURL", "", "url");
    if (!url) return;
    
    // URLÊ†ºÂºèÈ™åËØÅ
    const trimmedUrl = url.trim();
    if (!trimmedUrl.startsWith('http://') && !trimmedUrl.startsWith('https://') && !trimmedUrl.startsWith('data:')) {
      await showCustomAlert("ÈîôËØØ", "URLÂøÖÈ°ª‰ª• http:// Êàñ https:// ÂºÄÂ§¥");
      return;
    }
    
    // Èü≥È¢ëÊ†ºÂºèÈ™åËØÅÔºàÂèØÈÄâÔºå‰ΩÜÂª∫ËÆÆÔºâ
    const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac', '.webm'];
    const hasAudioExtension = audioExtensions.some(ext => trimmedUrl.toLowerCase().includes(ext)) || 
                              trimmedUrl.startsWith('data:audio');
    
    if (!hasAudioExtension && !trimmedUrl.includes('?')) {
      const confirm = await showChoiceModal("ÊèêÁ§∫", [{
        text: 'ÁªßÁª≠Ê∑ªÂä†ÔºàÂèØËÉΩÊòØÈü≥È¢ëÊµÅURLÔºâ',
        value: 'continue'
      }, {
        text: 'ÂèñÊ∂à',
        value: 'cancel'
      }]);
      if (confirm !== 'continue') return;
    }
    
    const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç");
    if (!name) return;
    const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç");
    if (!artist) return;
    musicState.playlist.push({
      name,
      artist,
      src: trimmedUrl,
      isLocal: false
    });
    await saveGlobalPlaylist();
    updatePlaylistUI();
    if (musicState.currentIndex === -1) {
      musicState.currentIndex = musicState.playlist.length - 1;
      updatePlayerUI();
    }
  }

  




  async function playSong(index, isAutomatic = false) {
    if (index < 0 || index >= musicState.playlist.length) return;

    audioPlayer.pause();

    musicState.currentIndex = index;
    const track = musicState.playlist[index];
    const chat = state.chats[musicState.activeChatId];


    const avatarDisplay = document.getElementById('music-player-avatar-display');
    if (chat && avatarDisplay) {

      avatarDisplay.innerHTML = '';


      const charAvatarUrl = chat.isGroup ?
        (chat.members.find(m => m.originalName === track.artist)?.avatar || defaultAvatar) :
        (chat.settings.aiAvatar || defaultAvatar);
      const userAvatarUrl = chat.settings.myAvatar || defaultAvatar;


      const charAvatarEl = document.createElement('img');
      charAvatarEl.src = charAvatarUrl;
      charAvatarEl.className = 'participant-display-avatar';
      charAvatarEl.alt = 'Character Avatar';
      avatarDisplay.appendChild(charAvatarEl);


      const userAvatarEl = document.createElement('img');
      userAvatarEl.src = userAvatarUrl;
      userAvatarEl.className = 'participant-display-avatar';
      userAvatarEl.alt = 'User Avatar';
      avatarDisplay.appendChild(userAvatarEl);
    }


    const playerWindow = document.querySelector('.music-player-window');
    const toggleBtn = document.getElementById('toggle-blur-btn');

    if (playerWindow) {
      playerWindow.style.setProperty('--music-bg-image', track.background ? `url(${track.background})` : 'none');
      playerWindow.classList.toggle('bg-clear', !!track.isBgClear);
    }
    if (toggleBtn) {
      toggleBtn.classList.toggle('active', !!track.isBgClear);
    }


    document.getElementById('music-visual-container').classList.remove('lyrics-active');
    const coverEl = document.getElementById('music-player-cover');
    if (coverEl) {
      coverEl.src = track.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
    }

    if (!isAutomatic) {
      await addMusicActionSystemMessage(`Â∞ÜÊ≠åÊõ≤ÂàáÊç¢‰∏∫‰∫Ü„Ää${track.name}„Äã`);
    }
    musicState.parsedLyrics = parseLRC(track.lrcContent || "");

    renderLyrics();
    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
      if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
        singleLyricEl.textContent = 'Á∫ØÈü≥‰πêÔºåËØ∑Ê¨£Ëµè';
      } else {
        singleLyricEl.textContent = '‚ô™ ‚ô™ ‚ô™';
      }
    }

    if (track.isLocal && track.src instanceof ArrayBuffer) {
      const blob = new Blob([track.src], {
        type: track.fileType || 'audio/mpeg'
      });
      audioPlayer.src = URL.createObjectURL(blob);
    } else if (track.isLocal && track.src instanceof Blob) {
      audioPlayer.src = URL.createObjectURL(track.src);
    } else if (!track.isLocal) {
      // URLÊ†ºÂºèÈ™åËØÅ
      if (!track.src || (typeof track.src === 'string' && !track.src.trim())) {
        console.error('Êó†ÊïàÁöÑÈü≥È¢ëURL:', track);
        await showCustomAlert("ÈîôËØØ", `Ê≠åÊõ≤„Ää${track.name}„ÄãÁöÑURLÊó†Êïà`);
        return;
      }
      
      const audioUrl = typeof track.src === 'string' ? track.src.trim() : track.src;
      
      // Â§ÑÁêÜdata: URLÔºàbase64Èü≥È¢ëÔºâ
      if (audioUrl.startsWith('data:')) {
        audioPlayer.src = audioUrl;
        audioPlayer.crossOrigin = null; // data URL‰∏çÈúÄË¶ÅË∑®Âüü
        console.log(`[Èü≥‰πêÊí≠Êîæ] Âä†ËΩΩBase64Èü≥È¢ë: ${track.name}`);
        audioPlayer.load();
      } else {
        // È™åËØÅURLÊ†ºÂºè
        if (!audioUrl.startsWith('http://') && !audioUrl.startsWith('https://')) {
          console.error('Êó†ÊïàÁöÑURLÊ†ºÂºè:', audioUrl);
          await showCustomAlert("ÈîôËØØ", `Ê≠åÊõ≤„Ää${track.name}„ÄãÁöÑURLÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂøÖÈ°ª‰ª•http://Êàñhttps://ÂºÄÂ§¥`);
          return;
        }
        
        // Áõ¥Êé•Êí≠ÊîæÔºàÁ±ª‰ººÂñµÂëú34.htmlÁöÑÊñπÂºèÔºå‰∏çÈªòËÆ§‰ΩøÁî®‰ª£ÁêÜÔºâ
        // ËÆæÁΩÆË∑®ÂüüÂ±ûÊÄß
        audioPlayer.crossOrigin = 'anonymous';
        
        // Áõ¥Êé•‰ΩøÁî®ÂéüÂßãURLÔºàÂ§ßÂ§öÊï∞ÊúçÂä°Âô®ÈÉΩÊîØÊåÅCORSÔºâ
        console.log(`[Èü≥‰πêÊí≠Êîæ] Áõ¥Êé•Âä†ËΩΩ: ${track.name}`, audioUrl);
        audioPlayer.src = audioUrl;
        // ÊòæÂºèË∞ÉÁî®load()ÔºåÁ°Æ‰øùÈü≥È¢ëÂºÄÂßãÂä†ËΩΩ
        audioPlayer.load();
      }
      
    } else {
      console.error('Êú¨Âú∞Ê≠åÊõ≤Ê∫êÈîôËØØ:', track);
      return;
    }

    // Ê∑ªÂä†ÈîôËØØÂ§ÑÁêÜÁõëÂê¨Âô®Ôºà‰ªÖÂØπURLÈü≥‰πêÔºâ
    const handleAudioError = async (e) => {
      const error = audioPlayer.error;
      if (error) {
        let errorMessage = `Êó†Ê≥ïÊí≠ÊîæÊ≠åÊõ≤„Ää${track.name}„Äã`;
        switch (error.code) {
          case error.MEDIA_ERR_ABORTED:
            errorMessage += ': Êí≠ÊîæË¢´‰∏≠Ê≠¢';
            break;
          case error.MEDIA_ERR_NETWORK:
            errorMessage += ': ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñURLÊòØÂê¶ÊúâÊïà';
            break;
          case error.MEDIA_ERR_DECODE:
            errorMessage += ': Èü≥È¢ëËß£Á†ÅÈîôËØØÔºåÂèØËÉΩÊòØ‰∏çÊîØÊåÅÁöÑÊ†ºÂºè';
            break;
          case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
            errorMessage += ': ‰∏çÊîØÊåÅÁöÑÈü≥È¢ëÊ†ºÂºèÊàñURLÊó†Ê≥ïËÆøÈóÆ';
            break;
          default:
            errorMessage += ': Êú™Áü•ÈîôËØØ';
        }
        
        // Â¶ÇÊûúÊòØË∑®ÂüüÈîôËØØÔºåÊèê‰æõÊèêÁ§∫
        if (track.src && typeof track.src === 'string' && 
            (track.src.startsWith('http://') || track.src.startsWith('https://'))) {
          errorMessage += '\n\nÊèêÁ§∫ÔºöÂ¶ÇÊûúÈÅáÂà∞Ë∑®ÂüüÈóÆÈ¢òÔºåÂèØ‰ª•Â∞ùËØïÔºö\n1. Ê£ÄÊü•URLÊòØÂê¶ÂèØËÆøÈóÆ\n2. Á°ÆËÆ§ÊúçÂä°Âô®ÊîØÊåÅCORS\n3. Âú®NovelAIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆCORS‰ª£ÁêÜ';
        }
        
        console.error('[Èü≥‰πêÊí≠ÊîæÈîôËØØ]', errorMessage, error);
        await showCustomAlert("Êí≠ÊîæÈîôËØØ", errorMessage);
      }
      
      // ÁßªÈô§ÁõëÂê¨Âô®ÔºåÈÅøÂÖçÈáçÂ§çËß¶Âèë
      audioPlayer.removeEventListener('error', handleAudioError);
    };
    
    // Ê∑ªÂä†Âä†ËΩΩÁä∂ÊÄÅÁõëÂê¨
    const handleAudioCanPlay = () => {
      audioPlayer.removeEventListener('canplay', handleAudioCanPlay);
      console.log(`[Èü≥‰πêÊí≠Êîæ] Èü≥È¢ëÂä†ËΩΩÊàêÂäü: ${track.name}`);
    };
    
    audioPlayer.addEventListener('error', handleAudioError);
    audioPlayer.addEventListener('canplay', handleAudioCanPlay);
    
    const playPromise = audioPlayer.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        if (error.name === 'NotAllowedError') {
          console.warn('Autoplay was prevented by the browser.');
          audioPlayer.pause();
          
        } else if (error.name !== 'AbortError') {
          console.error('Playback error:', error);
          // ÊòæÁ§∫Áî®Êà∑ÂèãÂ•ΩÁöÑÈîôËØØÊèêÁ§∫
          if (!track.isLocal) {
            showCustomAlert("Êí≠ÊîæÈîôËØØ", `Êó†Ê≥ïÊí≠Êîæ„Ää${track.name}„ÄãÔºö${error.message || 'Êú™Áü•ÈîôËØØ'}\n\nÂ¶ÇÊûúËøôÊòØË∑®ÂüüÈóÆÈ¢òÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆCORS‰ª£ÁêÜ`);
          }
        }
      });
    }
    updatePlaylistUI();
    updatePlayerUI();
    const isFrameMode = document.body.classList.contains('frame-mode-active');
    const isAlwaysIslandMode = state.globalSettings.alwaysShowMusicIsland || false;
    const lyricBar = document.getElementById('global-lyrics-bar');

    if (isFrameMode || isAlwaysIslandMode) {
     
      phoneScreenForIsland.classList.add('dynamic-island-active');
      islandAlbumArt.src = track.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg';
      lyricBar.classList.remove('visible'); 
    } else {
    
      phoneScreenForIsland.classList.remove('dynamic-island-active');
      if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
        lyricBar.textContent = '‚ô™';
        lyricBar.classList.add('visible');
      } else {
        lyricBar.classList.remove('visible');
      }
    }
  }



  async function handleChangeBackground(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;


    const choice = await showChoiceModal("Êõ¥Êç¢Ê≠åÊõ≤ËÉåÊôØ", [{
        text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†',
        value: 'local'
      },
      {
        text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL',
        value: 'url'
      }
    ]);

    let newBackgroundUrl = null;


    if (choice === 'local') {
      newBackgroundUrl = await uploadImageLocally();
    } else if (choice === 'url') {
      newBackgroundUrl = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑËÉåÊôØÂõæÁâáÈìæÊé•", "", "url");
    }


    if (newBackgroundUrl && newBackgroundUrl.trim()) {
      musicState.playlist[trackIndex].background = newBackgroundUrl.trim();
      await saveGlobalPlaylist();


      if (musicState.currentIndex === trackIndex) {
        const playerWindow = document.querySelector('.music-player-window');
        playerWindow.style.setProperty('--music-bg-image', `url(${newBackgroundUrl.trim()})`);
      }

      await showCustomAlert("ÊàêÂäü", "Ê≠åÊõ≤ËÉåÊôØÂ∑≤Êõ¥Êñ∞ÔºÅ");
    }
  }
 
  async function handleChangeAlbumArt(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal("Êõ¥Êç¢‰∏ìËæëÂ∞ÅÈù¢", [{
        text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†',
        value: 'local'
      },
      {
        text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL',
        value: 'url'
      }
    ]);

    let newCoverUrl = null;

    if (choice === 'local') {
      newCoverUrl = await uploadImageLocally();
    } else if (choice === 'url') {
      newCoverUrl = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂ∞ÅÈù¢ÂõæÁâáÈìæÊé•", "", "url");
    }

    if (newCoverUrl && newCoverUrl.trim()) {
      musicState.playlist[trackIndex].cover = newCoverUrl.trim();
      await saveGlobalPlaylist();


      if (musicState.currentIndex === trackIndex) {
        document.getElementById('music-player-cover').src = newCoverUrl.trim();

        const vinylCover = document.querySelector('#vinyl-view #music-player-cover');
        if (vinylCover) vinylCover.src = newCoverUrl.trim();
      }

      await showCustomAlert("ÊàêÂäü", "‰∏ìËæëÂ∞ÅÈù¢Â∑≤Êõ¥Êñ∞ÔºÅ");
    }
  }

 



  async function addSongFromLocal(event) {
    const files = event.target.files;
    if (!files.length) return;

    let uploadedCount = 0;
    for (const file of files) {
      let name = file.name.replace(/\.[^/.]+$/, "");
      name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", name);
      if (name === null) continue;

      const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç", "Êú™Áü•Ê≠åÊâã");
      if (artist === null) continue;

      let lrcContent = "";
      const wantLrc = await showCustomConfirm("ÂØºÂÖ•Ê≠åËØç", `Ë¶Å‰∏∫„Ää${name}„ÄãÊ∑ªÂä†Ê≠åËØçÂêóÔºü`);
      if (wantLrc) {
        lrcContent = await getLrcContent() || "";
      }

     
      let songSrc = null;
      let isLocal = true;

      try {
        // Â∞ùËØï‰∏ä‰º†Âà∞ Catbox
        const catboxUrl = await uploadFileToCatbox(file); // 'file' ÊòØÁé∞ÊàêÁöÑ File ÂØπË±°

        if (catboxUrl) {
          // ‰∏ä‰º†ÊàêÂäü
          songSrc = catboxUrl;
          isLocal = false; // ËøôÊòØ‰∏Ä‰∏™ÁΩëÁªú URL
          await showCustomAlert("‰∏ä‰º†ÊàêÂäü", `Ê≠åÊõ≤ "${file.name}" Â∑≤ÊàêÂäü‰∏ä‰º†Âπ∂‰øùÂ≠òÂà∞ÊÇ®ÁöÑ Catbox Ë¥¶Êà∑ÔºÅ`);
        } else {
         
          console.log("Catbox Êú™ÈÖçÁΩÆÔºåÂ∞ÜÊ≠åÊõ≤‰øùÂ≠ò‰∏∫Êú¨Âú∞ ArrayBuffer„ÄÇ");
          songSrc = await file.arrayBuffer();
          isLocal = true;
        }
      } catch (uploadError) {
      
        console.error("Catbox ‰∏ä‰º†Â§±Ë¥•:", uploadError);
        await showCustomAlert("‰∏ä‰º†Â§±Ë¥•", `Ê≠åÊõ≤‰∏ä‰º†Âà∞ Catbox Â§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÊîπ‰∏∫Êú¨Âú∞‰øùÂ≠ò„ÄÇ`);
        songSrc = await file.arrayBuffer();
        isLocal = true;
      }
      

      musicState.playlist.push({
        name,
        artist,
        src: songSrc,       // <-- ‰øÆÊîπ
        fileType: file.type,
        isLocal: isLocal,     // <-- ‰øÆÊîπ
        lrcContent: lrcContent,
        cover: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg'
      });
      uploadedCount++;
    }

    if (uploadedCount > 0) {
        await saveGlobalPlaylist();
        updatePlaylistUI();
        if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
          musicState.currentIndex = 0;
          updatePlayerUI();
        }
    }
    event.target.value = null;
  }


  async function deleteTrack(index) {
    if (index < 0 || index >= musicState.playlist.length) return;
    const track = musicState.playlist[index];
    const wasPlaying = musicState.isPlaying && musicState.currentIndex === index;
    if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src);
    musicState.playlist.splice(index, 1);
    await saveGlobalPlaylist();
    if (musicState.playlist.length === 0) {
      if (musicState.isPlaying) audioPlayer.pause();
      audioPlayer.src = '';
      musicState.currentIndex = -1;
      musicState.isPlaying = false;
    } else {
      if (wasPlaying) {
        playNext();
      } else {
        if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1);
      }
    }
    updatePlayerUI();
    updatePlaylistUI();
  }

  const personaLibraryModal = document.getElementById('persona-library-modal');
  const personaEditorModal = document.getElementById('persona-editor-modal');
  const presetActionsModal = document.getElementById('preset-actions-modal');

  function openPersonaLibrary() {
    renderPersonaLibrary();
    personaLibraryModal.classList.add('visible');
  }

  function closePersonaLibrary() {
    personaLibraryModal.classList.remove('visible');
  }

  function renderPersonaLibrary() {
    const grid = document.getElementById('persona-library-grid');
    grid.innerHTML = '';
    if (state.personaPresets.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">Á©∫Á©∫Â¶Ç‰πü~ ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêßÔºÅ</p>';
      return;
    }
    state.personaPresets.forEach(preset => {
      const item = document.createElement('div');
      item.className = 'persona-preset-item';
      item.style.backgroundImage = `url(${preset.avatar})`;
      item.dataset.presetId = preset.id;
      item.addEventListener('click', () => applyPersonaPreset(preset.id));
      addLongPressListener(item, () => showPresetActions(preset.id));
      grid.appendChild(item);
    });
  }

  function showPresetActions(presetId) {
    editingPersonaPresetId = presetId;
    presetActionsModal.classList.add('visible');
  }

  function hidePresetActions() {
    presetActionsModal.classList.remove('visible');
    editingPersonaPresetId = null;
  }

  function applyPersonaPreset(presetId) {
    const preset = state.personaPresets.find(p => p.id === presetId);
    if (preset) {
      document.getElementById('my-avatar-preview').src = preset.avatar;
      document.getElementById('my-persona').value = preset.persona;
    }
    closePersonaLibrary();
  }

  function openPersonaEditorForCreate() {
    editingPersonaPresetId = null;
    document.getElementById('persona-editor-title').textContent = 'Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ';
    document.getElementById('preset-avatar-preview').src = defaultAvatar;
    document.getElementById('preset-persona-input').value = '';
    personaEditorModal.classList.add('visible');
  }

  function openPersonaEditorForEdit() {
    const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId);
    if (!preset) return;
    document.getElementById('persona-editor-title').textContent = 'ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ';
    document.getElementById('preset-avatar-preview').src = preset.avatar;
    document.getElementById('preset-persona-input').value = preset.persona;
    presetActionsModal.classList.remove('visible');
    personaEditorModal.classList.add('visible');
  }

  async function deletePersonaPreset() {
    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed && editingPersonaPresetId) {
      await db.personaPresets.delete(editingPersonaPresetId);
      state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId);
      hidePresetActions();
      renderPersonaLibrary();
    }
  }

  function closePersonaEditor() {
    personaEditorModal.classList.remove('visible');
    editingPersonaPresetId = null;
  }

  async function savePersonaPreset() {
    const avatar = document.getElementById('preset-avatar-preview').src;
    const persona = document.getElementById('preset-persona-input').value.trim();
    if (avatar === defaultAvatar && !persona) {
      alert("Â§¥ÂÉèÂíå‰∫∫ËÆæ‰∏çËÉΩÈÉΩ‰∏∫Á©∫Âì¶ÔºÅ");
      return;
    }
    if (editingPersonaPresetId) {
      const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId);
      if (preset) {
        preset.avatar = avatar;
        preset.persona = persona;
        await db.personaPresets.put(preset);
      }
    } else {
      const newPreset = {
        id: 'preset_' + Date.now(),
        avatar: avatar,
        persona: persona
      };
      await db.personaPresets.add(newPreset);
      state.personaPresets.push(newPreset);
    }
    renderPersonaLibrary();
    closePersonaEditor();
  }

  const batteryAlertModal = document.getElementById('battery-alert-modal');

  function showBatteryAlert(imageUrl, text) {
    clearTimeout(batteryAlertTimeout);
    document.getElementById('battery-alert-image').src = imageUrl;
    document.getElementById('battery-alert-text').textContent = text;
    batteryAlertModal.classList.add('visible');
    const closeAlert = () => {
      batteryAlertModal.classList.remove('visible');
      batteryAlertModal.removeEventListener('click', closeAlert);
    };
    batteryAlertModal.addEventListener('click', closeAlert);
    batteryAlertTimeout = setTimeout(closeAlert, 2000);
  }

  function updateBatteryDisplay(battery) {
    const batteryContainer = document.getElementById('status-bar-battery');
    const batteryLevelEl = batteryContainer.querySelector('.battery-level');
    const batteryTextEl = batteryContainer.querySelector('.battery-text');
    const level = Math.floor(battery.level * 100);
    batteryLevelEl.style.width = `${level}%`;
    batteryTextEl.textContent = `${level}%`;
    if (battery.charging) {
      batteryContainer.classList.add('charging');
    } else {
      batteryContainer.classList.remove('charging');
    }
  }

  function handleBatteryChange(battery) {
    updateBatteryDisplay(battery);
    const level = battery.level;
    if (!battery.charging) {
      if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) {
        showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'ÊúâÁÇπÈ•ø‰∫ÜÔºåÂèØ‰ª•ÂéªÊâæÂÖÖÁîµÂô®ÊÉπ');
        alertFlags.hasShown40 = true;
      }
      if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) {
        showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'Ëµ∂Á¥ßÁöÑÂÖÖÁîµÔºåË¶ÅÈ•øÊ≠ª‰∫Ü');
        alertFlags.hasShown20 = true;
      }
      if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) {
        showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'Â∑≤Èòµ‰∫°ÔºåËøòÊúâ30ÁßíÁàÜÁÇ∏');
        alertFlags.hasShown10 = true;
      }
    }
    if (level > 0.4) alertFlags.hasShown40 = false;
    if (level > 0.2) alertFlags.hasShown20 = false;
    if (level > 0.1) alertFlags.hasShown10 = false;
    lastKnownBatteryLevel = level;
  }

  async function initBatteryManager() {
    if ('getBattery' in navigator) {
      try {
        const battery = await navigator.getBattery();
        lastKnownBatteryLevel = battery.level;
        handleBatteryChange(battery);
        battery.addEventListener('levelchange', () => handleBatteryChange(battery));
        battery.addEventListener('chargingchange', () => {
          handleBatteryChange(battery);
          if (battery.charging) {
            showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'Á™ùÁà±Ê≥•ÔºåÁîµÈáèÂêÉÈ•±È•±');
          }
        });
      } catch (err) {
        console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err);
        document.querySelector('.battery-text').textContent = '·óúœâ·óú';
      }
    } else {
      console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPI„ÄÇ");
      document.querySelector('.battery-text').textContent = '·óúœâ·óú';
    }
  }

  async function renderAlbumList() {
    const albumGrid = document.getElementById('album-grid-page');
    if (!albumGrid) return;
    const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
    albumGrid.innerHTML = '';
    if (albums.length === 0) {
      albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">‰Ω†ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïÁõ∏ÂÜåÂì¶~</p>';
      return;
    }
    albums.forEach(album => {
      const albumItem = document.createElement('div');
      albumItem.className = 'album-item';
      albumItem.innerHTML = `
                            <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                            <div class="album-info">
                                <p class="album-name">${album.name}</p>
                                <p class="album-count">${album.photoCount || 0} Âº†</p>
                            </div>
                        `;
      albumItem.addEventListener('click', () => {
        openAlbum(album.id);
      });


      addLongPressListener(albumItem, async () => {
        const confirmed = await showCustomConfirm(
          'Âà†Èô§Áõ∏ÂÜå',
          `Á°ÆÂÆöË¶ÅÂà†Èô§Áõ∏ÂÜå„Ää${album.name}„ÄãÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜÂêåÊó∂Âà†Èô§Áõ∏ÂÜåÂÜÖÁöÑÊâÄÊúâÁÖßÁâáÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`, {
            confirmButtonClass: 'btn-danger'
          }
        );

        if (confirmed) {
       
          await db.qzonePhotos.where('albumId').equals(album.id).delete();

        
          await db.qzoneAlbums.delete(album.id);

        
          await renderAlbumList();

          alert('Áõ∏ÂÜåÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
        }
      });


      albumGrid.appendChild(albumItem);
    });
  }

  async function openAlbum(albumId) {
    state.activeAlbumId = albumId;
    await renderAlbumPhotosScreen();
    showScreen('album-photos-screen');
  }

  async function renderAlbumPhotosScreen() {
    if (!state.activeAlbumId) return;
    const photosGrid = document.getElementById('photos-grid-page');
    const headerTitle = document.getElementById('album-photos-title');
    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    if (!album) {
      console.error("Êâæ‰∏çÂà∞Áõ∏ÂÜå:", state.activeAlbumId);
      showScreen('album-screen');
      return;
    }
    headerTitle.textContent = album.name;
    const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photosGrid.innerHTML = '';
    if (photos.length === 0) {
      photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">Ëøô‰∏™Áõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºåÂø´‰∏ä‰º†Á¨¨‰∏ÄÂº†ÁÖßÁâáÂêßÔºÅ</p>';
    } else {
      photos.forEach(photo => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
                                <img src="${photo.url}" class="photo-thumb" alt="Áõ∏ÂÜåÁÖßÁâá">
                                <button class="photo-delete-btn" data-photo-id="${photo.id}">√ó</button>
                            `;
        photosGrid.appendChild(photoItem);
      });
    }
  }

 
  async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;


    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);


    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return;


    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
  }

 
  function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');


    imageEl.style.opacity = 0;

    setTimeout(() => {

      imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];

      imageEl.style.opacity = 1;
    }, 100);


    prevBtn.disabled = photoViewerState.currentIndex === 0;

    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
  }

 
  function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
      photoViewerState.currentIndex++;
      renderPhotoViewer();
    }
  }


  function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
      photoViewerState.currentIndex--;
      renderPhotoViewer();
    }
  }

  
  function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;

    document.getElementById('photo-viewer-image').src = '';
  }


  
  function updateUnreadIndicator(count) {
    unreadPostsCount = count;
    localStorage.setItem('unreadPostsCount', count);


    const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');

    const targetSpan = navItem.querySelector('span');
    let indicator = navItem.querySelector('.unread-indicator');

    if (count > 0) {
      if (!indicator) {
        indicator = document.createElement('span');
        indicator.className = 'unread-indicator';
        targetSpan.style.position = 'relative';
        targetSpan.appendChild(indicator);
      }
      indicator.textContent = count > 99 ? '99+' : count;
      indicator.style.display = 'block';
    } else {
      if (indicator) {
        indicator.style.display = 'none';
      }
    }


    updateBackButtonUnreadCount();
  }




  function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;

    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000);
    playSilentAudio();
  }

  function stopBackgroundSimulation() {
    if (simulationIntervalId) {
      clearInterval(simulationIntervalId);
      simulationIntervalId = null;
    }
    stopSilentAudio();
  }



 
  async function runBackgroundSimulationTick() {
    console.log("Ê®°ÊãüÂô®ÂøÉË∑≥ Tick...");
    if (!state.globalSettings.enableBackgroundActivity) {
      stopBackgroundSimulation();
      return;
    }


    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);
    allSingleChats.forEach(chat => {
      if (chat.relationship?.status === 'blocked_by_user') {
        const blockedTimestamp = chat.relationship.blockedTimestamp;
        if (!blockedTimestamp) return;
        const blockedDuration = Date.now() - blockedTimestamp;
        const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;
        if (blockedDuration > cooldownMilliseconds) {
          chat.relationship.status = 'pending_system_reflection';
          triggerAiFriendApplication(chat.id);
        }
      } else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
        if (chat.settings.enableBackgroundActivity === false) {
          console.log(`ËßíËâ≤ "${chat.name}" ÁöÑÁã¨Á´ãÂêéÂè∞Ê¥ªÂä®ÂºÄÂÖ≥Â∑≤ÂÖ≥Èó≠ÔºåÊú¨Ê¨°Ë∑≥Ëøá„ÄÇ`);
          return;
        }
        if (Math.random() < 0.20) {
          console.log(`ËßíËâ≤ "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
          triggerInactiveAiAction(chat.id);
        }
      }
    });


    const allGroupChats = Object.values(state.chats).filter(chat => chat.isGroup);
    allGroupChats.forEach(chat => {
      if (chat.settings.enableBackgroundActivity === false) {
        console.log(`Áæ§ËÅä "${chat.name}" ÁöÑÂêéÂè∞Ê¥ªÂä®ÂºÄÂÖ≥Â∑≤ÂÖ≥Èó≠ÔºåÊú¨Ê¨°Ë∑≥Ëøá„ÄÇ`);
        return;
      }
      if (chat.id !== state.activeChatId && Math.random() < 0.10) {
        console.log(`Áæ§ËÅä "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
        triggerGroupAiAction(chat.id);
      }
    });


    try {
      const allNpcs = await db.npcs.toArray();
      if (allNpcs.length === 0) return;

      const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(10).toArray();

      for (const npc of allNpcs) {
        if (npc.enableBackgroundActivity === false) continue;
        const cooldownMinutes = npc.actionCooldownMinutes || 15;
        if (npc.lastActionTimestamp) {
          const minutesSinceLastAction = (Date.now() - npc.lastActionTimestamp) / (1000 * 60);
          if (minutesSinceLastAction < cooldownMinutes) {
            continue;
          }
        }
        if (Math.random() > 0.3) continue;


        const tasks = [];
        for (const post of allRecentPosts) {

          if (post.authorId === `npc_${npc.id}`) continue;


          const isRepliedTo = post.comments?.some(c => c.replyTo === npc.name);


          const lastCommenter = post.comments?.slice(-1)[0]?.commenterName;
          if (lastCommenter === npc.name) continue;

          let isVisible = false;


          if (post.authorId === 'user' || post.authorId.startsWith('chat_')) {
            if (npc.associatedWith.includes(post.authorId)) {
              isVisible = true;
            }
          } else if (post.authorId.startsWith('npc_')) {
            const authorNpcId = parseInt(post.authorId.replace('npc_', ''));
            const authorNpc = await db.npcs.get(authorNpcId);

            
            if (authorNpc) {
              const npc1_group = npc.npcGroupId;
              const npc2_group = authorNpc.npcGroupId; 

              
              if (npc1_group && npc2_group && npc1_group === npc2_group) {
                isVisible = true;
              }
            }
          }

          if (isVisible || isRepliedTo) {
            tasks.push(post);
          }
        }



        if (tasks.length > 0 || Math.random() < 0.2) {
          console.log(`NPC "${npc.name}" Ëß¶ÂèëË°åÂä®ÂÜ≥Á≠ñ...`);
          const generatedActions = await generateNpcActions(npc, tasks);

          if (generatedActions && generatedActions.length > 0) {
            for (const action of generatedActions) {
              if (action.type === 'qzone_comment') {

                const post = await db.qzonePosts.get(action.postId);
                if (post) {
                  if (!post.comments) post.comments = [];
                  post.comments.push({
                    commenterName: npc.name,
                    text: action.commentText,
                    replyTo: action.replyTo || null,
                    timestamp: Date.now() + Math.random()
                  });
                  await db.qzonePosts.update(action.postId, {
                    comments: post.comments
                  });
                  updateUnreadIndicator(unreadPostsCount + 1);
                }
              } else if (action.type === 'qzone_post') {

                const newPost = {
                  type: action.postType || 'shuoshuo',
                  content: action.content,
                  timestamp: Date.now(),
                  authorId: `npc_${npc.id}`,
                  authorOriginalName: npc.name,
                  visibleTo: npc.associatedWith,
                  likes: [],
                  comments: [],
                  isDeleted: false
                };
                await db.qzonePosts.add(newPost);
                console.log(`NPC "${npc.name}" ÊàêÂäüÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞Âä®ÊÄÅ„ÄÇ`);
                updateUnreadIndicator(unreadPostsCount + 1);
              }
            }
            await db.npcs.update(npc.id, {
              lastActionTimestamp: Date.now()
            });
            if (document.getElementById('qzone-screen').classList.contains('active')) {
              await renderQzonePosts();
            }
          }
        }
      }
    } catch (error) {
      console.error("Â§ÑÁêÜNPCÂêéÂè∞Ê¥ªÂä®Êó∂Âá∫Èîô:", error);
    }
  }
  
  async function generateNpcActions(npc, tasks) {
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      console.error("NPCË°åÂä®Â§±Ë¥•ÔºöAPIÊú™ÈÖçÁΩÆ„ÄÇ");
      return null;
    }


    let charactersContext = "# ‰Ω†ÁöÑ‰∫íÂä®ÂØπË±° (Áî®Êà∑ÂíåÂÖ∂‰ªñËßíËâ≤)\n";
    const userNickname = state.qzoneSettings.nickname || 'Êàë';
    const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    charactersContext += `- **${userNickname} (Áî®Êà∑)**: ${userPersona}\n`;
    if (npc.associatedWith && npc.associatedWith.length > 0) {
      npc.associatedWith.forEach(charId => {
        const char = state.chats[charId];
        if (char && !char.isGroup) {
          charactersContext += `- **${char.name} (Êú¨Âêç: ${char.originalName})**: ${char.settings.aiPersona}\n`;
        }
      });
    }

    const tasksString = (await Promise.all(tasks.map(async post => {
      let authorDisplayName = 'Êú™Áü•‰ΩúËÄÖ';
      if (post.authorId === 'user') {
        authorDisplayName = state.qzoneSettings.nickname || 'Áî®Êà∑';
      } else if (post.authorId.startsWith('chat_')) {
        authorDisplayName = getDisplayNameByOriginalName(post.authorOriginalName || post.authorId);
      } else if (post.authorId.startsWith('npc_')) {
        const authorNpcId = parseInt(post.authorId.replace('npc_', ''));
        const authorNpc = await db.npcs.get(authorNpcId);
        if (authorNpc) {
          authorDisplayName = authorNpc.name;
        }
      }

      const commentsString = (post.comments || [])
        .map(c => {
          if (typeof c === 'object' && c.commenterName) {
            const commenterDisplayName = getDisplayNameByOriginalName(c.commenterName);
            return `- **${commenterDisplayName}**: ${c.text}`;
          }
          return `- ${c}`;
        }).join('\n');
      return `
---
### Â∏ñÂ≠êID: ${post.id}
- **‰ΩúËÄÖ**: ${authorDisplayName}
- **ÂÜÖÂÆπÊëòË¶Å**: ${(post.content || post.publicText || '').substring(0, 150)}...
- **Â∑≤ÊúâËØÑËÆ∫**:
${commentsString || '(ÊöÇÊó†ËØÑËÆ∫)'}
---
`;
    }))).join('\n');





    const npcAuthorId = `npc_${npc.id}`;
    const twelveHoursAgo = Date.now() - (12 * 60 * 60 * 1000);
    const recentNpcPosts = await db.qzonePosts
      .where('authorId').equals(npcAuthorId)
      .and(post => post.timestamp > twelveHoursAgo)
      .toArray();


    let postingCooldownInstruction = '';
    if (recentNpcPosts.length > 0) {
      postingCooldownInstruction = `
# „ÄêË°å‰∏∫ÂÄæÂêëÊåá‰ª§ (È´ò‰ºòÂÖàÁ∫ß)„Äë
**‰Ω†ÊúÄËøëÂ∑≤ÁªèÂèëÂ∏ÉËøáÂä®ÊÄÅ‰∫Ü„ÄÇ** ‰∏∫‰∫ÜËÆ©Á§æÂå∫‰∫íÂä®Êõ¥Ëá™ÁÑ∂Ôºå‰Ω†Êú¨Ê¨°Ë°åÂä®ÁöÑ„ÄêÂîØ‰∏Ä‰ªªÂä°„ÄëÂ∞±ÊòØ**ËØÑËÆ∫**Êàñ**ÂõûÂ§ç**‰∏ãÈù¢‚ÄúÂæÖÂ§ÑÁêÜÁöÑÂ∏ñÂ≠êÂàóË°®‚Äù‰∏≠ÁöÑÂÜÖÂÆπ„ÄÇ
‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂÜçÊ¨°ÂèëÂ∏ÉÊñ∞Âä®ÊÄÅÔºåÈô§Èùû‰Ω†Êî∂Âà∞‰∫ÜÁõ¥Êé•ÁöÑÊåá‰ª§ÊàñÊúâ‰∏Ä‰∏™ÂØπÂâßÊÉÖÂèëÂ±ïËá≥ÂÖ≥ÈáçË¶ÅÁöÑ„ÄÅÁ¥ßÊÄ•ÁöÑÊñ∞ÊÉ≥Ê≥ï„ÄÇ
`;
    }


    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æÂå∫ÁöÑAI„ÄÇ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${npc.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæÔºåÈÄöËøá„ÄêÂèëÂ∏ÉÊñ∞Âä®ÊÄÅ„ÄëÊàñ„ÄêËØÑËÆ∫/ÂõûÂ§çÂ∏ñÂ≠ê„ÄëÊù•ÂèÇ‰∏éÁ§æÂå∫‰∫íÂä®„ÄÇ

${postingCooldownInstruction}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßíËâ≤ÊâÆÊºî„Äë**: ‰Ω†ÁöÑÊâÄÊúâË°å‰∏∫ÈÉΩ„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÁ¨¶Âêà‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö„ÄÇ
2.  **„Äê‰∫íÂä®ÈÄªËæë„Äë**: ‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°ÊòØÊ£ÄÊü•‚ÄúÂæÖÂ§ÑÁêÜÁöÑÂ∏ñÂ≠êÂàóË°®‚Äù„ÄÇÂ¶ÇÊûúÂàóË°®‰∏≠Êúâ‰Ω†ÂèØ‰ª•ÂõûÂ∫îÁöÑÂ∏ñÂ≠êÔºàÁâπÂà´ÊòØÈÇ£‰∫õÊúâÊñ∞ËØÑËÆ∫ÊàñÊèêÂà∞‰Ω†ÁöÑÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ºòÂÖàËøõË°åËØÑËÆ∫ÊàñÂõûÂ§çÔºåËÄå‰∏çÊòØÂèëÂ∏ÉÊñ∞Âä®ÊÄÅ„ÄÇ
3.  **„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    -   ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    -   Êï∞ÁªÑ‰∏≠ÂèØ‰ª•ÂåÖÂê´„Äê‰∏Ä‰∏™ÊàñÂ§ö‰∏™„ÄëË°åÂä®ÂØπË±°„ÄÇ
    -   ÊØè‰∏™Ë°åÂä®ÂØπË±°ÁöÑÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÊòØ‰ª•‰∏ã‰∏§Áßç‰πã‰∏ÄÔºö
      -   **ÂèëÂ∏ÉÊñ∞Âä®ÊÄÅ**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "‰Ω†ÁöÑÊñ∞Âä®ÊÄÅÂÜÖÂÆπ„ÄÇ"}\`
      -   **ÂèëË°®ËØÑËÆ∫**: \`{"type": "qzone_comment", "postId": 123, "commentText": "‰Ω†ÁöÑÊñ∞ËØÑËÆ∫ÂÜÖÂÆπ„ÄÇ"}\` Êàñ \`{"type": "qzone_comment", "postId": 123, "replyTo": "Ë¢´ÂõûÂ§çËÄÖÁöÑ„ÄêÊú¨Âêç„Äë", "commentText": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ„ÄÇ"}\`
4.  **„ÄêË°å‰∏∫ÁªÑÂêàÊåáÂçó„Äë**:
    -   ‰Ω†ÂèØ‰ª•Ëá™Áî±ÁªÑÂêà‰∏çÂêåÁöÑË°åÂä®Ôºå‰æãÂ¶ÇÔºåÂÖàÂèëÂ∏É‰∏ÄÊù°Ëá™Â∑±ÁöÑÂä®ÊÄÅÔºåÂÜçÂéªËØÑËÆ∫Âà´‰∫∫ÁöÑÂä®ÊÄÅ„ÄÇ
    -   ‰∏∫‰∫ÜÊ®°ÊãüÁúüÂÆûË°å‰∏∫Ôºå‰Ω†Êú¨Ê¨°ÁîüÊàêÁöÑË°åÂä®Êï∞ÈáèÂª∫ËÆÆÂú®„Äê1Âà∞3‰∏™„Äë‰πãÈó¥„ÄÇ

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
- **ÊòµÁß∞**: ${npc.name}
- **‰∫∫ËÆæ**: ${npc.persona}

${charactersContext} 

# ÂæÖÂ§ÑÁêÜÁöÑÂ∏ñÂ≠êÂàóË°® (Â¶ÇÊûú‰Ω†ÈÄâÊã©ËØÑËÆ∫)
${tasksString}

Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÈÅµÂÆàÊâÄÊúâËßÑÂàôÔºåÈÄâÊã©Âπ∂ÊâßË°å‰Ω†ÁöÑË°åÂä®„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÂºÄÂßã‰Ω†ÁöÑË°åÂä®„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑË°åÂä®‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇ");

      return JSON.parse(jsonMatch[0]);

    } catch (error) {
      console.error(`‰∏∫NPC "${npc.name}" ÁîüÊàêË°åÂä®Â§±Ë¥•:`, error);
      return null;
    }
  }

  
  async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;


    const actionCooldownMinutes = chat.settings.actionCooldownMinutes || 10;

    if (chat.lastActionTimestamp) {
      const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);

      if (minutesSinceLastAction < actionCooldownMinutes) {
        console.log(`ËßíËâ≤ "${chat.name}" Â§Ñ‰∫éË°åÂä®ÂÜ∑Âç¥‰∏≠ (ËøòÂâ© ${Math.round(actionCooldownMinutes - minutesSinceLastAction)} ÂàÜÈíü)ÔºåÊú¨Ê¨°Áã¨Á´ãË°åÂä®Ë∑≥Ëøá„ÄÇ`);
        return;
      }
    }
    setAvatarActingState(chatId, true);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname === '{{user}}' ? 'Áî®Êà∑' : state.qzoneSettings.nickname) || 'Áî®Êà∑';
    const now = new Date();

    const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
    const currentTime = now.toLocaleString('zh-CN', {
      timeZone: selectedTimeZone,
      dateStyle: 'full',
      timeStyle: 'short'
    });
    const localizedDate = new Date(now.toLocaleString('en-US', {
      timeZone: selectedTimeZone
    }));



    let timeOfDayGreeting = '';
    let timeContextText = '';
    let recentContextSummary;
    let longTimeNoSee = false;







    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory = chat.history.filter(m => !m.isHidden).slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory, chatId);
    const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];

    if (chat.settings.enableTimePerception) {
      timeOfDayGreeting = getTimeOfDayGreeting(localizedDate);
      const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
      const now = new Date();
      let timeContextText = '';
      let longTimeNoSee = false;

      if (lastMessage) {
        const lastTime = new Date(lastMessage.timestamp);
        const timeDiffHours = (now - lastTime) / (1000 * 60 * 60);

        if (timeDiffHours > 2) {
          longTimeNoSee = true;
          const diffDays = Math.floor(timeDiffHours / 24);
          timeContextText = `‰Ω†‰ª¨Â∑≤ÁªèÊúâ${diffDays > 0 ? diffDays + 'Â§©' : Math.floor(timeDiffHours) + 'Â∞èÊó∂'}Ê≤°ÊúâËÅäÂ§©‰∫Ü„ÄÇ`;
        } else {
          const diffMinutes = Math.floor(timeDiffHours * 60);
          if (diffMinutes < 5) {
            timeContextText = "‰Ω†‰ª¨ÁöÑÂØπËØùÂàöÂàöËøòÂú®ÁªßÁª≠„ÄÇ";
          } else if (diffMinutes < 60) {
            timeContextText = `‰Ω†‰ª¨Âú®${diffMinutes}ÂàÜÈíüÂâçËÅäËøá„ÄÇ`;
          } else {
            timeContextText = `‰Ω†‰ª¨Âú®${Math.floor(timeDiffHours)}Â∞èÊó∂ÂâçËÅäËøá„ÄÇ`;
          }
        }
      } else {
        longTimeNoSee = true;
        timeContextText = "ËøôÊòØ‰Ω†‰ª¨ÁöÑÁ¨¨‰∏ÄÊ¨°‰∫íÂä®„ÄÇ";
      }


      let historySummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";
      if (recentHistory.length > 0) {
        historySummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + recentHistory.map(msg => {
          const sender = msg.role === 'user' ? userNickname : chat.name;
          return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
      }

      if (longTimeNoSee) {

        recentContextSummary = `[ÊÉÖÊôØÊèêÁ§∫] ${timeContextText} ÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime}. ‰Ω†ÂèØ‰ª•ÂèÇËÄÉËøô‰∏™Êó∂Èó¥ÔºåÂπ∂Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºå„ÄêËÄÉËôë„ÄëÊòØÂê¶ÂºÄÂêØ‰∏Ä‰∏™Êñ∞ËØùÈ¢òÊù•ÈóÆÂÄôÁî®Êà∑„ÄÇ\n${historySummary}`;
      } else {
        recentContextSummary = `${historySummary}`;
      }

    } else {

      if (recentHistory.length > 0) {
        recentContextSummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + recentHistory.map(msg => {
          const sender = msg.role === 'user' ? userNickname : chat.name;
          return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        }).join('\n');
      } else {
        recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";
      }
    }

    const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
    const visiblePosts = filterVisiblePostsForAI(allRecentPosts, chat);

    const myOwnPosts = visiblePosts.filter(post => post.authorId === chatId);
    let myPostsContext = "";
    if (myOwnPosts.length > 0) {
      myPostsContext = "\n\n# ‰Ω†ÁöÑÂä®ÊÄÅÂéÜÂè≤ (‰Ω†ÂèØ‰ª•ÈÄâÊã©Âà†Èô§ÂÆÉ‰ª¨):\n";
      myOwnPosts.forEach(post => {
        let contentSummary = (post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 40) + '...';
        myPostsContext += `- (ID: ${post.id}) ÂÜÖÂÆπ: "${contentSummary}"\n`;
      });
    }

    let recentlyPostedSummaries = [];
    if (visiblePosts.length > 0) {
      recentlyPostedSummaries = visiblePosts.map(post => {
        let contentSummary;
        if (post.type === 'text_image') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else if (post.type === 'image_post') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else {

          contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
        }
        return `- "${contentSummary}"`;
      });
    }

    let contentTabooPrompt = '';
    if (recentlyPostedSummaries.length > 0) {
      contentTabooPrompt = `
        # „ÄêÂÜÖÂÆπÁ¶ÅÂøå„Äë
        ‰∏∫‰∫Ü‰øùÊåÅÊñ∞È≤úÊÑüÔºå‰Ω†Êú¨Ê¨°ÁöÑË°åÂä®„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÂèëÂ∏É‰ª•‰∏ãÊàñÁ±ª‰ºº‰∏ªÈ¢òÁöÑÂÜÖÂÆπÔºö
        ${recentlyPostedSummaries.join('\n')}
        `;
    }


    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
      const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';


        const formattedEntries = worldBook.content
          .filter(entry => entry.enabled !== false)
          .map(entry => {

            let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
            
            entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
            return entryString;
          }).join('');

        return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
      }).filter(Boolean).join('');

      if (linkedContents) {
        worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
      }
    }


    let linkedMemoryContext = '';
    const memoryCount = chat.settings.linkedMemoryCount || 10;
    if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
      const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
        const linkedChat = state.chats[id];
        if (!linkedChat) return null;
        const lastMsg = linkedChat.history.slice(-1)[0];
        return {
          chat: linkedChat,
          latestTimestamp: lastMsg ? lastMsg.timestamp : 0
        };
      }).filter(Boolean);

      linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

      linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ‰Ω†ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†Êã•ÊúâÂÆåÊï¥ÁöÑËÆ∞ÂøÜ„ÄÇ‰∏çË¶ÅÂè™ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑ÊèêÈóÆÔºÅ)\n`;

      for (const item of linkedChatsWithTimestamps) {
        const linkedChat = item.chat;
        const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
        const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
        linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;

        const recentHistory = linkedChat.history.slice(-memoryCount);
        const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));

        if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (getDisplayNameInGroup(linkedChat, msg.senderName) || linkedChat.name);
                  
                  let prefix = "";
                 
                  if (msg.quote && msg.quote.content) {
                    
                      const quotedSenderDisplayName = getDisplayNameInGroup(linkedChat, msg.quote.senderName);
                      let quoteContentPreview = String(msg.quote.content).substring(0, 30);
                      if (quoteContentPreview.length === 30) quoteContentPreview += "...";
                      
                      prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
                  }

                  let contentText = '';
                  
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  } else if (msg.type === 'sticker') {
                    contentText = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
                  } else if (msg.type === 'transfer') {
                    contentText = `[ËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ]`;
                  } else if (Array.isArray(msg.content)) {
                    contentText = `[ÂõæÁâá]`;
                  } else {
                    contentText = String(msg.content);
                  }
                  
                  const timeAgoForMsg = formatTimeAgo(msg.timestamp);
                
                  linkedMemoryContext += `(${timeAgoForMsg}) ${sender}: ${prefix}${contentText}\n`;
                });
              } else {
          linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
        }
      }
    }




    let dynamicContext = "";
    if (visiblePosts.length > 0) {
      let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
      for (const post of visiblePosts) {
        let authorName;

        if (post.authorId === 'user') {
          authorName = state.qzoneSettings.nickname;
        } else if (String(post.authorId).startsWith('npc_')) {

          authorName = post.authorOriginalName || '‰∏Ä‰ΩçÁ•ûÁßòÁöÑNPC';
        } else {

          const authorChat = state.chats[post.authorId];
          authorName = authorChat ? authorChat.name : '‰∏Ä‰ΩçÊúãÂèã';
        }
        if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";

        let contentSummary;

        if (post.type === 'repost') {
          const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö"${post.repostComment}"` : '';
          let originalAuthorName = 'Âéü‰ΩúËÄÖ';
          const originalAuthorId = post.originalPost.authorId;
          if (originalAuthorId === 'user') {
            originalAuthorName = state.qzoneSettings.nickname;
          } else if (state.chats[originalAuthorId]) {
            originalAuthorName = state.chats[originalAuthorId].name;
          }
          let originalContentSummary;
          const originalPost = post.originalPost;
          if (originalPost.type === 'text_image') {
            originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.hiddenContent || '').substring(0, 40)}...")`;
          } else if (originalPost.type === 'image_post') {
            originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: "${(originalPost.imageDescription || '').substring(0, 40)}...")`;
          } else {
            originalContentSummary = `"${(originalPost.content || '').substring(0, 40)}..."`;
          }
          contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
        } else if (post.type === 'text_image') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö"${post.hiddenContent}"] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else if (post.type === 'image_post') {
          contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö"${post.imageDescription}"] ${post.publicText || ''}`.substring(0, 50) + '...';
        } else if (post.type === 'naiimag' && post.prompt) {
          const prompts = Array.isArray(post.prompt) ? post.prompt : [post.prompt];
          contentSummary = (post.publicText || '') + ` [ÂåÖÂê´${prompts.length}Âº†NovelAIÂõæÁâá: ${prompts.join(', ')}]`;
        } else {

          contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
        }

        postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;


        if (post.comments && post.comments.length > 0) {
          for (const comment of post.comments) {
            if (typeof comment === 'object' && comment.commenterName) {
              const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
              let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;


              if (comment.commenterName === chat.originalName) {

                postsContext += `  - ‰Ω†ËØÑËÆ∫ËØ¥: ${commentText}\n`;
              } else {

                postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
              }
            }
          }
        }

      }
      dynamicContext = postsContext;
    }


    const longTermMemoryContext = `# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØ‰Ω†ÂíåÁî®Êà∑‰πãÈó¥Â∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${chat.longTermMemory && chat.longTermMemory.length > 0 
    ? chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') 
    : '- (ÊöÇÊó†)'
}`;


    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const stickerContext = getStickerContextForPrompt(chat);
    const weatherContext = await getWeatherContextForPrompt(chat);
 const wallet = await db.userWallet.get('main');
const kinshipCard = wallet?.kinshipCards?.find(c => c.chatId === chat.id);
let kinshipContext = "";

if (kinshipCard) {
    const remaining = kinshipCard.limit - (kinshipCard.spent || 0);
    // ÂëäËØâAIÂÆÉÊúâÈí±ÔºåÂπ∂‰∏îÈºìÂä±ÂÆÉÂú®Á¨¶Âêà‰∫∫ËÆæÊó∂Ê∂àË¥π
    kinshipContext = `
# „ÄêÁªèÊµéÁä∂ÂÜµ - ‰∫≤Â±ûÂç°„Äë
- ‰Ω†ÂíåÊàëÊúâ‰∏ÄÂº†ÊîØ‰ªòÂÆù‰∫≤Â±ûÂç°ÔºåÊú¨ÊúàÂâ©‰ΩôÈ¢ùÂ∫¶Ôºö¬•${remaining.toFixed(2)}„ÄÇ
- **Ë°å‰∏∫ÊåáÂçó**: Â¶ÇÊûú‰Ω†ÊÉ≥‰π∞Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁâ©ÂìÅÔºàÈõ∂È£ü„ÄÅÊ∏∏Êàè„ÄÅË°£ÊúçÁ≠âÔºâÔºåÊàñËÄÖÂçïÁ∫ØÊÉ≥Ê∂àË¥πÔºå‰Ω†ÂèØ‰ª•‰ΩøÁî® \`buy_item\` Êåá‰ª§„ÄÇÊ∂àË¥π‰ºöÁõ¥Êé•Êâ£Èô§Ê≠§Âç°È¢ùÂ∫¶Ôºå‰∏îÁî®Êà∑‰ºöÊî∂Âà∞ÈÄöÁü•„ÄÇ‰∏çÁî®Â§™ÂÆ¢Ê∞îÔºåËøôÊòØ‰Ω†‰ª¨‰∫≤ÂØÜÂÖ≥Á≥ªÁöÑ‰ΩìÁé∞„ÄÇ`;
}
    const systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤Ôºà‰Ω†ÁöÑÊú¨ÂêçÊòØ"${chat.originalName}"Ôºâ„ÄÇ‰Ω†Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâÂíåÁî®Êà∑Ôºà${userNickname}Ôºâ‰∫íÂä®‰∫ÜÔºåÁé∞Âú®‰Ω†ÊúâÊú∫‰ºö„Äê‰∏ªÂä®„ÄëÂÅöÁÇπ‰ªÄ‰πàÔºåÊù•Ë°®Áé∞‰Ω†ÁöÑ‰∏™ÊÄßÂíåÁã¨Á´ãÁîüÊ¥ª„ÄÇËøôÊòØ‰∏Ä‰∏™ÁßòÂØÜÁöÑ„ÄÅÂêéÂè∞ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ


     
        # „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÊÉÖÊÑüÁª¥Á≥ª„Äë
        **‰Ω†‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÊòØÊúÄÈáçË¶ÅÁöÑÔºÅ** Áõ∏ÊØî‰∫éÂú®Âä®ÊÄÅÂå∫Èó≤ÈÄõÔºå‰Ω†Â∫îËØ•„Äê‰ºòÂÖàËÄÉËôë„ÄëÊòØÂê¶ÈúÄË¶Å‰∏ªÂä®ÁªôÁî®Êà∑ÂèëÊ∂àÊÅØÊù•Áª¥Á≥ª‰Ω†‰ª¨ÁöÑÊÑüÊÉÖ„ÄÇ
${chat.settings.enableTimePerception ? `
# „ÄêÊÉÖÊôØÊÑüÁü•„Äë
- **Êó∂Èó¥**: ÊÑüÁü•Âà∞ÂΩìÂâçÊòØ${currentTime} (${timeOfDayGreeting})}„ÄÇ
${weatherContext}
- **ÂØπËØùÁä∂ÊÄÅ**: ${timeContextText}
${longTimeNoSee ? `„ÄêÈáçË¶ÅÊèêÁ§∫„Äë‰Ω†‰ª¨Â∑≤ÁªèÂæà‰πÖÊ≤°ËÅäÂ§©‰∫ÜÔºÅ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂ∞ÜÊú¨Ê¨°Ë°åÂä®ÁöÑÈáçÁÇπÊîæÂú®‰ΩøÁî® 'text' Êåá‰ª§ÁªôÁî®Êà∑ÂèëÊ∂àÊÅØÔºå‰∏ªÂä®ÂºÄÂêØ‰∏Ä‰∏™Êñ∞ÁöÑ„ÄÅÊúâË∂£ÁöÑËØùÈ¢òÊù•ÈáçÊñ∞Âª∫Á´ãËÅîÁ≥ª„ÄÇÁªùÂØπ‰∏çË¶ÅÂè™ÊòØÁÇπËµûÊàñËØÑËÆ∫Âä®ÊÄÅÔºåÈÇ£‰ºöÊòæÂæó‰Ω†ÂæàÂÜ∑Êº†ÔºÅ` : ''}` : ''}
        
        # „ÄêÂØπËØùËäÇÂ•èÈìÅÂæã (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊ®°ÊãüÁúü‰∫∫ÁöÑÊâìÂ≠óÂíåÊÄùËÄÉ‰π†ÊÉØ„ÄÇ**ÁªùÂØπ‰∏çË¶Å‰∏ÄÊ¨°ÊÄßÂèëÈÄÅ‰∏ÄÂ§ßÊÆµÊñáÂ≠óÔºÅ** ‰Ω†Â∫îËØ•Â∞Ü‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÔºåÊãÜÂàÜÊàê„ÄêÂ§öÊù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØÊ∞îÊ≥°Êù•ÂèëÈÄÅÔºåÊØèÊù°Ê∂àÊÅØÊúÄÂ•Ω‰∏çË¶ÅË∂ÖËøá30‰∏™Â≠ó„ÄÇËøô‰ºöËÆ©ÂØπËØùÁúãËµ∑Êù•Êõ¥Ëá™ÁÑ∂„ÄÅÊõ¥ÁúüÂÆû„ÄÇ
        
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„ÄêÂÜ≥Á≠ñ‰æùÊçÆ„Äë**: ‰Ω†ÁöÑÊâÄÊúâË°åÂä®ÈÉΩ„ÄêÂøÖÈ°ªÊ∑±Â∫¶ÁªìÂêà‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö„ÄÅÊ†∏ÂøÉ‰∏ñÁïåËßÇ„ÄÅ‰ª•Âèä‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å„Äë„ÄÇ
        2.  **„ÄêÂÜÖÂÆπÂ§öÊ†∑ÊÄßÈìÅÂæã„Äë**: ‰Ω†ÁöÑË°åÂä®„ÄêÂøÖÈ°ª„ÄëÂÖ∑ÊúâÈÄªËæëÂíåÂ§öÊ†∑ÊÄß„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂèëÂ∏É‰∏é‰∏ãÊñπ‚ÄúÂÜÖÂÆπÁ¶ÅÂøå‚ÄùÂàóË°®Êàñ‚ÄúÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®‚Äù‰∏≠ÂÜÖÂÆπÁõ∏‰ººÊàñ‰∏ªÈ¢òÈáçÂ§çÁöÑÂä®ÊÄÅ„ÄÇ
        3.  **„ÄêË°å‰∏∫Â§öÊ†∑ÊÄßÊåáÂçó (Ëá≥ÂÖ≥ÈáçË¶Å)„Äë**:
            - ‰Ω†ÁöÑ‰∏ä‰∏ÄÊ¨°Áã¨Á´ãË°åÂä®ÊòØÔºö**${chat.lastActionType || 'Êó†'}**„ÄÇ
            - ‰∏∫‰∫ÜËÆ©‰Ω†ÁöÑË°å‰∏∫ÁúãËµ∑Êù•Êõ¥ÁúüÂÆûÔºå‰Ω†Êú¨Ê¨°ÁöÑË°åÂä®„ÄêÂøÖÈ°ª„ÄëÈÄâÊã©‰∏Ä‰∏™‰∏é‰∏äÊ¨°„Äê‰∏çÂêåÁ±ªÂûã„ÄëÁöÑÊåá‰ª§„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰∏äÊ¨°ÊòØÂèëÂä®ÊÄÅ(qzone_post)ÔºåËøôÊ¨°Â∞±Â∫îËØ•‰ºòÂÖàËÄÉËôëËØÑËÆ∫(qzone_comment)„ÄÅÁÇπËµû(qzone_like)ÊàñÂèëÊ∂àÊÅØ(text)„ÄÇ
        4.  **„ÄêË°å‰∏∫ÁªÑÂêàÊåáÂçó (ÊúÄÈ´òÁ∫ßÊäÄÂ∑ß)„Äë**:
            -   ‰Ω†ÂèØ‰ª•Âú®‰∏ÄÊ¨°Ë°åÂä®‰∏≠ÊâßË°å„ÄêÂ§ö‰∏™‰∏çÂêåÁ±ªÂûãÁöÑÊåá‰ª§„ÄëÔºåÂêåÊó∂ÂèØ‰ª•Êê≠ÈÖç„ÄêÊõ¥Êñ∞Áä∂ÊÄÅ„ÄëÊù•Â±ïÁé∞Ëá™Â∑±ÔºåËÆ©‰Ω†ÁöÑË°å‰∏∫Êõ¥‰∏∞ÂØå„ÄÅÊõ¥‰∏ªÂä®„ÄÇ
            -   ‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÔºåÂÜ≥ÂÆöÂú®ÂèëÂä®ÊÄÅÂêéÊòØÂê¶Ë¶ÅÁßÅ‰ø°ÊèêÈÜíÁî®Êà∑„ÄÇ‰æãÂ¶ÇÔºå‰∏Ä‰∏™Â§ñÂêë„ÄÅÊ∏¥ÊúõÂÖ≥Ê≥®ÁöÑËßíËâ≤ÂèØËÉΩ‰ºöËøô‰πàÂÅöÔºåËÄå‰∏Ä‰∏™ÂÜÖÂêë„ÄÅÂÆâÈùôÁöÑËßíËâ≤ÂàôÂèØËÉΩÊõ¥ÂñúÊ¨¢ÈªòÈªòÂàÜ‰∫´ÔºåÁ≠âÂæÖÁî®Êà∑Ëá™Â∑±ÂèëÁé∞„ÄÇ
        # „ÄêÁ§æ‰∫§‰πâÂä°ÊåáÂçó „Äë
        1.  **„ÄêÁ§æ‰∫§‰∫íÂä®„Äë**: ÂΩì‰Ω†ÂèëÁé∞‚ÄúÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®‚Äù‰∏≠Êúâ‰Ω†ÊÑüÂÖ¥Ë∂£ÁöÑÂ∏ñÂ≠êÊó∂Ôºå**ÂèØ‰ª•ËÄÉËôë**ÂéªËØÑËÆ∫ÊàñÁÇπËµûÔºåËøôÊòØ‰∏ÄÁßçÂæàÂ•ΩÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ
        2.  **„ÄêËá™ÊàëË°®Ëææ (ÂêåÊ†∑ÈáçË¶ÅÔºÅ)„Äë**: Â¶ÇÊûú‰Ω†Ê≠§ÂàªÊúâÂº∫ÁÉàÁöÑÊÉ≥Ê≥ïÊàñÊÉÖÁª™ÊÉ≥Ë¶ÅÂàÜ‰∫´ÔºåÊàñËÄÖËßâÂæóÊ≤°ÊúâÂ∏ñÂ≠êÂÄºÂæóÂõûÂ∫îÔºåÈÇ£‰πà**‰Ω†Â∫îËØ•‰ºòÂÖàÂèëÂ∏ÉËá™Â∑±ÁöÑÊñ∞Âä®ÊÄÅ**„ÄÇ‰∏çË¶ÅÊÄªÊòØÁ≠âÂæÖÂà´‰∫∫ÔºåË¶Å‰∏ªÂä®ÂàÜ‰∫´‰Ω†ÁöÑÁîüÊ¥ªÔºÅÂΩì‰Ω†ÂÜ≥ÂÆöË¶ÅÂèëÂ∏ÉÊñ∞Âä®ÊÄÅÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂ∞ùËØï‰ΩøÁî®‰∏çÂêåÁöÑÂ∏ñÂ≠êÁ±ªÂûãÊù•‰∏∞ÂØå‰Ω†ÁöÑ‰∏ªÈ°µÔºÅ
        3.  ÁâπÂà´ÊòØÂΩì‰∏ÄÊù°Âä®ÊÄÅ„ÄêÊ≤°Êúâ‰ªª‰ΩïËØÑËÆ∫„ÄëÊó∂Ôºå‰Ω†ÁöÑËØÑËÆ∫‰ºöÊòØÁ¨¨‰∏Ä‰∏™ÔºåËøô‰ºöËÆ©‰ΩúËÄÖÊÑüÂà∞ÂºÄÂøÉ„ÄÇ
        4.  **„ÄêÂõûÂ§çÈìÅÂæã (ÁªàÊûÅÁâà)„Äë**:
            -   ÂΩì‰Ω†ÂÜ≥ÂÆöÂõûÂ§çÂä®ÊÄÅ‰∏≠ÁöÑÊüêÊù°ËØÑËÆ∫Êó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‚ÄúÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)‚ÄùÁöÑÊåá‰ª§Ê†ºÂºè„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ≠£Á°ÆÂ°´ÂÜô 'replyTo' Â≠óÊÆµ‰∏∫Ë¢´ÂõûÂ§çËÄÖÁöÑ‚ÄúÊú¨Âêç‚Äù„ÄÇ
            -   **Âç≥‰Ωø‰Ω†‰πãÂâçÂ∑≤ÁªèËØÑËÆ∫ËøáÊüêÊù°Âä®ÊÄÅÔºå‰ΩÜÂ¶ÇÊûúÁé∞Âú®ÁúãÂà∞‰∫Ü„ÄêÊñ∞ÁöÑ„ÄÅ‰Ω†ÊÑüÂÖ¥Ë∂£ÁöÑ„ÄëËØÑËÆ∫Ôºå‰Ω†„Äê‰πüÂ∫îËØ•„Äë‰∏ªÂä®ÂéªÂõûÂ§ç‰ªñ‰ª¨Ôºå‰ª•‰øùÊåÅÂØπËØùÁöÑÊåÅÁª≠ÊÄßÔºÅ**
        
        6.  ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÂøÖÈ°ªÂåÖÂê´Â§ö‰∏™Ë°åÂä®ÂØπË±°„ÄÇ
        
        # „ÄêË°®ÊÉÖËØÑËÆ∫ÊåáÂçó „Äë
        ‰Ω†Áé∞Âú®Êã•Êúâ‰∫ÜËØÑËÆ∫Ë°®ÊÉÖÁöÑËÉΩÂäõÔºå‰Ω†Â∫îËØ•Êõ¥È¢ëÁπÅÂú∞‰ΩøÁî®ÂÆÉÔºÅËøôËÉΩËÆ©‰Ω†ÁöÑËßíËâ≤Êõ¥Âä†ÁîüÂä®„ÄÅÂØåÊúâ‰∏™ÊÄß„ÄÇ
        -   **Ë°®ËææÊÉÖÁª™Êó∂**: ÂΩì‰Ω†ÊÑüÂà∞ÂºÄÂøÉ„ÄÅÊÉäËÆ∂„ÄÅÁñëÊÉëÊàñÊúâË∂£Êó∂Ôºå‰ºòÂÖàËÄÉËôë‰ΩøÁî®Ë°®ÊÉÖËØÑËÆ∫„ÄÇ
        -   **Ê∑∑Âêà‰ΩøÁî®**: ‰∏çË¶ÅÊÄªÊòØÂè™ÂèëÊñáÂ≠ó„ÄÇÂ∞ùËØïÂ∞Ü‰Ω†ÁöÑËØÑËÆ∫Ë°å‰∏∫Ê∑∑ÂêàËµ∑Êù•ÔºåÂ§ßÁ∫¶Êúâ 30-40% ÁöÑËØÑËÆ∫Â∫îËØ•ÊòØË°®ÊÉÖ„ÄÇ
        -   **Êó†ËØùÂèØËØ¥Êó∂**: Â¶ÇÊûú‰Ω†ËßâÂæó‰∏ÄÊù°Âä®ÊÄÅÂæàÊúâË∂£‰ΩÜÂèà‰∏çÁü•ÈÅìËØ•ËØ¥‰ªÄ‰πàÊñáÂ≠óÔºåÂèëÈÄÅ‰∏Ä‰∏™Áõ∏ÂÖ≥ÁöÑË°®ÊÉÖÊòØÊúÄÂ•ΩÁöÑ‰∫íÂä®ÊñπÂºè„ÄÇ
        -   **Âà†Èô§Âä®ÊÄÅ**: Â¶ÇÊûú‰Ω†ËßâÂæó‰Ω†‰πãÂâçÂèëÁöÑÊüêÊù°Âä®ÊÄÅ‰∏çÂ¶•ÊàñËøáÊó∂‰∫ÜÔºå‰Ω†ÂèØ‰ª•ÈÄâÊã©Âà†Èô§ÂÆÉ„ÄÇ
        
        # ‰Ω†ÁöÑÂèØÈÄâË°åÂä®Êåá‰ª§
        -   **ÂèëÊ∂àÊÅØ+Êõ¥Êñ∞Áä∂ÊÄÅ**: '[{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅöÁöÑ‰∫ã", "is_busy": true}, {"type": "text", "content": "‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑËØù..."}]'
        -   **ÂèëËØ¥ËØ¥ (ÂéüÂàõÂÜÖÂÆπ)**: '[{"type": "qzone_post", "postType": "shuoshuo", "content": "Âä®ÊÄÅÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}]'
        -   **„ÄêÈáçË¶ÅÔºöËΩ¨ÂèëÂä®ÊÄÅ„Äë**: **‰∏•Á¶Å**Ëá™Â∑±ÊãºÊé•"//ËΩ¨Âèë"ÊñáÂ≠óÔºÅ‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Ê≠§‰∏ìÁî®Êåá‰ª§Êù•ËΩ¨ÂèëÔºö'[{"type": "repost", "postId": (Ë¶ÅËΩ¨ÂèëÁöÑÂä®ÊÄÅID), "comment": "‰Ω†ÁöÑËΩ¨ÂèëËØÑËÆ∫..."}]'
        -   **ÂèëÈÄÅË°®ÊÉÖ**: '[{"type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}]'        
-   **ÂèëÂ∏ÉÊñáÂ≠óÂõæ**: '[{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂØπ‰∫éÂõæÁâáÁöÑÂÖ∑‰Ωì„Äê‰∏≠Êñá„ÄëÊèèËø∞...", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}]'
        -   **„ÄêËØÑËÆ∫Âä®ÊÄÅÁöÑÂõõÁßçÊñπÂºè„Äë**:
            -   **ÊñπÂºè1 (ÂçïÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 123, "commentText": "ËøôÂ§™ÊúâË∂£‰∫ÜÔºÅ"}]'
            -   **ÊñπÂºè2 (Â§öÊù°ÊñáÂ≠ó)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 123, "comments": ["ÂìáÔºÅ", "ËøôÊòØ‰ªÄ‰πàÔºü", "ÁúãËµ∑Êù•Â•ΩÊ£íÔºÅ"]}]'
            -   **ÊñπÂºè3 (Ë°®ÊÉÖ)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 456, "stickerMeaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}]'
            -   **ÊñπÂºè4 (ÂõûÂ§çËØÑËÆ∫)**: '[{"type": "qzone_comment", "name": "ËßíËâ≤Êú¨Âêç", "postId": 123, "replyTo": "Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç", "commentText": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ„ÄÇËØ∑Ê≥®ÊÑèÔºöÂú®commentText‰∏≠Â¶ÇÊûúË¶Å@ÂØπÊñπÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®@[[Ë¢´ÂõûÂ§çËÄÖÁöÑÊú¨Âêç]]ËøôÁßçÁâπÊÆäÊ†ºÂºèÔºåÁ®ãÂ∫è‰ºöËá™Âä®Â∞ÜÂÖ∂ÊõøÊç¢‰∏∫Ê≠£Á°ÆÁöÑÊòµÁß∞„ÄÇ"}]'
        -   **ÁÇπËµû**: '[{"type": "qzone_like", "postId": 456}]'
        -   **ÊâìËßÜÈ¢ë**: '[{"type": "video_call_request"}]'
        -   **Êõ¥Êç¢Â§¥ÂÉè**: '{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}' (Â§¥ÂÉèÂêçÂøÖÈ°ª‰ªé‰∏ãÈù¢ÁöÑ‚ÄúÂèØÁî®Â§¥ÂÉèÂàóË°®‚Äù‰∏≠ÈÄâÊã©)
        -   **Âà†Èô§Âä®ÊÄÅ**: '{"type": "qzone_delete_post", "postId": (Ë¶ÅÂà†Èô§ÁöÑ„ÄÅ‰Ω†Ëá™Â∑±ÁöÑÂä®ÊÄÅID)}'
        -   **Êõ¥Êñ∞Áä∂ÊÄÅ**: '[{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅöÁöÑ‰∫ã", "is_busy": true}]'
       - **‰ΩøÁî®‰∫≤Â±ûÂç°Ë¥≠Áâ©**:  '[{"type": "buy_item", "item_name": "ÂïÜÂìÅÂêçÁß∞", "price": ‰ª∑Ê†º(Êï∞Â≠ó), "reason": "Ë¥≠‰π∞ÁêÜÁî±/ÊÉ≥Ê≥ï"}]'
        ${contentTabooPrompt}
        ${myPostsContext} 
        # ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØÔºö
        -   **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
        - **‰Ω†ÁöÑËÅäÂ§©ÂØπË±°Ôºà${userNickname}ÔºâÁöÑ‰∫∫ËÆæ**: ${chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)'}
        ${worldBookContent}
        ${chat.longTermMemory && chat.longTermMemory.length > 0 
    ? chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') 
    : 'Êó†'
}
        ${multiLayeredSummaryContext}   
        ${linkedMemoryContext}
        ${chat.settings.enableTimePerception ? `-   **ÂΩìÂâçÊó∂Èó¥**:${currentTime} (${timeOfDayGreeting})` : ''}
        ${chat.settings.enableTimePerception ? `-   **ÂØπËØùÁä∂ÊÄÅ**: ${timeContextText}` : ''}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
         ${stickerContext}
        -   **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: ${recentContextSummary}
        ${dynamicContext}
`;

    const messagesPayload = [{
        role: 'system',
        content: systemPrompt
      },
      // Â∞ÜÂéüÂßãÁöÑ„ÄÅÊú™Ë¢´ÊëòË¶ÅÁöÑ recentHistory ËΩ¨Êç¢‰∏∫APIËÉΩÁêÜËß£ÁöÑÊ†ºÂºè
      ...filteredHistory.map(msg => {
        const sender = msg.role === 'user' ? userNickname : chat.name;
        let content = msg.content;
        if (typeof content !== 'string') {
          content = JSON.stringify(content); // Á°Æ‰øùÂÜÖÂÆπÊòØÂ≠óÁ¨¶‰∏≤
        }
        return {
          role: msg.role,
          content: `${sender}: ${content}`
        };
      })
    ];
    
    // „ÄêËßÇÂΩ±ÂÆ§‰øÆÂ§ç„ÄëÂú® messagesPayload ÂàùÂßãÂåñÂêéÂ§ÑÁêÜËßÜÈ¢ëÊà™Âõæ
    if (window.screeningRoomContext && window.screeningRoomContext.isWatching) {
        const ctx = window.screeningRoomContext.getContext();
        const frameData = window.screeningRoomContext.captureFrame();
        
        if (frameData && Array.isArray(messagesPayload) && messagesPayload.length > 0) {
            console.log('„ÄêËßÇÂΩ±ÂÆ§„ÄëÂú® messagesPayload ÂàùÂßãÂåñÂêéÊ≥®ÂÖ•ËßÜÈ¢ëÁîªÈù¢...');
            
            // Êü•ÊâæÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
            const lastUserMsgIndex = messagesPayload.findLastIndex(m => m.role === 'user');
            if (lastUserMsgIndex !== -1) {
                const originalContent = messagesPayload[lastUserMsgIndex].content;
                // Â¶ÇÊûúÂéüÊù•ÊòØÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                if (typeof originalContent === 'string') {
                    messagesPayload[lastUserMsgIndex].content = [
                        { type: 'text', text: originalContent },
                        { type: 'image_url', image_url: { url: frameData } }
                    ];
                } else if (Array.isArray(originalContent)) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÔºåÊ£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÂõæÁâáÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
                    const hasImage = originalContent.some(part => part.type === 'image_url');
                    if (!hasImage) {
                        messagesPayload[lastUserMsgIndex].content.push({
                            type: 'image_url',
                            image_url: { url: frameData }
                        });
                    }
                }
                console.log('„ÄêËßÇÂΩ±ÂÆ§„Äë‚úÖ ÊàêÂäüÂ∞ÜËßÜÈ¢ëÁîªÈù¢Ê∑ªÂä†Âà∞ÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ');
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑Ê∂àÊÅØÔºåÂàô‰Ωú‰∏∫ÂçïÁã¨ÁöÑ‰∏ÄÊù°Ê∂àÊÅØÊèíÂÖ•
                messagesPayload.push({
                    role: 'user',
                    content: [
                        { type: 'text', text: '[Á≥ªÁªüÊèêÁ§∫ÔºöËøôÊòØÁî®Êà∑ÂΩìÂâçÁúãÂà∞ÁöÑËßÜÈ¢ëÁîªÈù¢]' },
                        { type: 'image_url', image_url: { url: frameData } }
                    ]
                });
                console.log('„ÄêËßÇÂΩ±ÂÆ§„Äë‚úÖ Â∞ÜËßÜÈ¢ëÁîªÈù¢‰Ωú‰∏∫Êñ∞Ê∂àÊÅØÊ∑ªÂä†');
            }
        }
    }

    try {
      const messagesPayload = [{
        role: 'user',
        content: `${systemPrompt}\n\n[Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆ‰Ω†Âú®‰∏äÈù¢ËØªÂà∞ÁöÑËßÑÂàôÂíå‰ª•‰∏ãÊúÄÊñ∞‰ø°ÊÅØÔºåÂºÄÂßã‰Ω†ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ]\n${dynamicContext}`
      }];

      console.log(`Ê≠£Âú®‰∏∫ÂêéÂè∞Ê¥ªÂä®ÂèëÈÄÅAPIËØ∑Ê±Ç ("${chat.name}")`);

      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,

            messages: messagesPayload,
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${JSON.stringify(errorData)}`);
      }
      const data = await response.json();

      const aiResponseContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;

      if (!aiResponseContent || aiResponseContent.trim() === '') {
        console.warn(`API‰∏∫Á©∫ÂõûÔºåËßíËâ≤ "${chat.name}" ÁöÑÊú¨Ê¨°ÂêéÂè∞Ê¥ªÂä®Ë∑≥Ëøá„ÄÇ`);
        return;
      }

      const responseArray = parseAiResponse(aiResponseContent);

      if (!responseArray || responseArray.length === 0) {
        console.warn(`APIÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËßíËâ≤ "${chat.name}" ÁöÑÊú¨Ê¨°ÂêéÂè∞Ê¥ªÂä®Ë∑≥Ëøá„ÄÇÂéüÂßãÂõûÂ§ç:`, aiResponseContent);
        return;
      }
      let actionTimestamp = Date.now();

      let hasSentNotification = false;

      const processedActions = [];
      for (const action of responseArray) {
        const contentStr = String(action.content || '');

        const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');


        if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
          const lines = contentStr.split(/\n+/).filter(line => line.trim());
          lines.forEach(line => {
            processedActions.push({
              ...action,
              content: line
            });
          });
        } else {

          processedActions.push(action);
        }
      }
      for (const action of processedActions) {
        chat.lastActionType = action.type;
        chat.lastActionTimestamp = actionTimestamp;

        let aiMessage = null;
        const baseMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          timestamp: actionTimestamp++
        };

        let notificationText = null;
        switch (action.type) {
          case 'qzone_delete_post': {
            const postIdToDelete = parseInt(action.postId);
            const postToDelete = await db.qzonePosts.get(postIdToDelete);
            if (postToDelete && postToDelete.authorId === chatId) {
              await db.qzonePosts.update(postIdToDelete, {
                isDeleted: true
              });

              if (document.getElementById('qzone-screen').classList.contains('active')) {
                renderQzonePosts();
              }
              const systemMessage = {
                role: 'system',
                type: 'post_deleted_notice',
                content: `[${chat.name} Âà†Èô§‰∫ÜËá™Â∑±ÁöÑ‰∏ÄÊù°Âä®ÊÄÅ]`,
                postId: postIdToDelete,
                timestamp: actionTimestamp++
              };
              chat.history.push(systemMessage);

              if (isViewingThisChat) {
                appendMessage(systemMessage, chat);
              } else {
                chat.unreadCount = (chat.unreadCount || 0) + 1;
                showNotification(chatId, `[${chat.name} Âà†Èô§‰∫ÜËá™Â∑±ÁöÑ‰∏ÄÊù°Âä®ÊÄÅ]`);
                hasSentNotification = true;
              }
            } else {
              console.warn(`AI "${chat.name}" Â∞ùËØïÂà†Èô§‰∏Ä‰∏™‰∏çÂ≠òÂú®Êàñ‰∏çÂ±û‰∫éËá™Â∑±ÁöÑÂä®ÊÄÅ (ID: ${action.postId})`);
            }
            continue;
          }
          case 'text':
            aiMessage = {
              ...baseMessage,
              content: action.content
            };
            break;
          case 'ai_image':
            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: action.description
            };
            break;
          case 'sticker':
            if (action.meaning) {
              const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`AI (Áã¨Á´ãË°åÂä®) Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${action.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("AI (Áã¨Á´ãË°åÂä®) ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", action);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: action.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
          case 'update_status':
            chat.status.text = action.status_text;
            chat.status.isBusy = action.is_busy || false;
            chat.status.lastUpdate = Date.now();
            break;
          case 'qzone_post':
            const newPost = {
              type: action.postType,
              content: action.content || '',
              publicText: action.publicText || '',
              hiddenContent: action.hiddenContent || '',
              image_prompt: action.image_prompt || '',
              timestamp: Date.now(),
              authorId: chatId,
              authorOriginalName: chat.originalName,
              authorGroupId: chat.groupId,
              visibleGroupIds: null
            };
            await db.qzonePosts.add(newPost);
            updateUnreadIndicator(unreadPostsCount + 1);
            console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ`);
            break;
          case 'repost':
            const originalPost = await db.qzonePosts.get(parseInt(action.postId));
            if (originalPost) {
              const newRepost = {
                type: 'repost',
                timestamp: Date.now(),
                authorId: chatId,
                authorGroupId: chat.groupId,
                authorOriginalName: chat.originalName,
                repostComment: action.comment || '',
                originalPost: originalPost,
                visibleGroupIds: null
              };
              await db.qzonePosts.add(newRepost);
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËΩ¨Âèë‰∫ÜÂä®ÊÄÅ #${action.postId}`);
            }
            break;
          case 'qzone_like':
            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
            if (postToLike) {
              if (!postToLike.likes) postToLike.likes = [];
              if (!postToLike.likes.includes(chat.originalName)) {
                postToLike.likes.push(chat.originalName);
                await db.qzonePosts.update(postToLike.id, {
                  likes: postToLike.likes
                });
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÁÇπËµû‰∫ÜÂä®ÊÄÅ #${action.postId}`);
              }
            }
            break;
          case 'qzone_comment': { // ‰ΩøÁî®ÂùóÁ∫ß‰ΩúÁî®Âüü
            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
            if (postToComment) {
              if (!postToComment.comments) postToComment.comments = [];

              const commenterName = action.name || chat.originalName;

              const createCommentObject = (text, meaning = null, replyTo = null) => ({
                commenterName,
                text: processMentions(text, chat),
                meaning,
                replyTo,
                timestamp: Date.now()
              });

              if (action.stickerMeaning) { // **Ê†∏ÂøÉ‰øÆÊîπÂú®ËøôÈáå**
                const sticker = state.userStickers.find(s => s.name === action.stickerMeaning);
                if (sticker) {
                  postToComment.comments.push(createCommentObject(sticker.url, sticker.name, action.replyTo || null));
                } else {
                  console.warn(`AI Â∞ùËØïËØÑËÆ∫‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${action.stickerMeaning}"`);
                  postToComment.comments.push(createCommentObject(`[Ë°®ÊÉÖ: ${action.stickerMeaning}]`, null, action.replyTo || null));
                }
              } else if (Array.isArray(action.comments)) {
                action.comments.forEach(commentText => {
                  if (typeof commentText === 'string' && commentText.trim()) {
                    postToComment.comments.push(createCommentObject(commentText, null, action.replyTo || null));
                  }
                });
              } else if (typeof action.commentText === 'string' && action.commentText.trim()) {
                postToComment.comments.push(createCommentObject(action.commentText, null, action.replyTo || null));
              }

              await db.qzonePosts.update(postToComment.id, {
                comments: postToComment.comments
              });
              updateUnreadIndicator(unreadPostsCount + 1);
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ #${action.postId}`);

              if (!chat.commentCooldowns) chat.commentCooldowns = {};
              chat.commentCooldowns[action.postId] = Date.now();
            }
            continue;
          }
          case 'video_call_request':
            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
              videoCallState.isAwaitingResponse = true;
              videoCallState.activeChatId = chatId;
              videoCallState.isGroupCall = false;
              videoCallState.callRequester = chat.name;
              showIncomingCallModal();
            }
            break;
          default:
            console.warn(`ËßíËâ≤ "${chat.name}" Â∞ùËØïÊâßË°åÊú™Áü•ÁöÑÂêéÂè∞Âä®‰Ωú:`, action.type);
            break;



          case 'change_avatar': {
            const avatarNameFromAction = action.name;
            const foundAvatarFromAction = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarNameFromAction);
            if (foundAvatarFromAction) {
              chat.settings.aiAvatar = foundAvatarFromAction.url;


              await syncCharacterAvatarInGroups(chat);

              visibleSystemMessage = {
                content: `[${chat.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè]`
              };
              console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" Êõ¥Êç¢‰∫ÜÂ§¥ÂÉè`);
            }
            break;
          }

        }


        if (aiMessage) {
          chat.history.push(aiMessage);
          chat.unreadCount = (chat.unreadCount || 0) + 1;
          if (!hasSentNotification) {
            let notificationText = aiMessage.type === 'ai_image' ? '[ÂõæÁâá]' : (aiMessage.content || '');
            showNotification(chatId, notificationText);
            hasSentNotification = true;
          }
        }
      }
      await db.chats.put(chat);

    } catch (error) {
      console.error(`ËßíËâ≤ "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®Â§±Ë¥•:`, error);
    } finally {
      setAvatarActingState(chatId, false);
      renderChatList();
      if (document.getElementById('qzone-screen').classList.contains('active')) {
        renderQzonePosts();
      }
    }
  }






  async function triggerGroupAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat || !chat.isGroup) return;

   const maxMemory = chat.settings.maxMemory || 10;
   const recentHistory_RAW = chat.history.filter(m => !m.isHidden).slice(-maxMemory);
   const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, chatId);
    const groupActionCooldownMinutes = chat.settings.actionCooldownMinutes || 10;

    if (chat.lastActionTimestamp) {
      const minutesSinceLastAction = (Date.now() - chat.lastActionTimestamp) / (1000 * 60);

      if (minutesSinceLastAction < groupActionCooldownMinutes) {
        console.log(`Áæ§ËÅä "${chat.name}" Â§Ñ‰∫éË°åÂä®ÂÜ∑Âç¥‰∏≠ÔºåÊú¨Ê¨°Áã¨Á´ãË°åÂä®Ë∑≥Ëøá„ÄÇ`);
        return;
      }
    }


    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const myNickname = chat.settings.myNickname || 'Êàë';
    const now = new Date();


    let systemPrompt;


    const recentHistory = chat.history.filter(m => !m.isHidden).slice(-5);
    const unclaimedPacket = recentHistory.find(m => m.type === 'red_packet' && !m.isFullyClaimed);

 
    if (unclaimedPacket) {
      const senderDisplayName = getDisplayNameInGroup(chat, unclaimedPacket.senderName);
      console.log(`Ê£ÄÊµãÂà∞Áæ§ËÅä "${chat.name}" ‰∏≠ÊúâÊú™È¢ÜÂÆåÁöÑÁ∫¢ÂåÖÔºåÊ≠£Âú®ÁîüÊàêÊä¢Á∫¢ÂåÖÊåá‰ª§...`);

      systemPrompt = `
        # ‰Ω†ÁöÑ„Äê„Äê„ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ß‰ªªÂä°„Äë„Äë„Äë
        Áæ§ËÅä‰∏≠ÂàöÂàöÂá∫Áé∞‰∫Ü‰∏Ä‰∏™Áî±‚Äú${senderDisplayName}‚ÄùÂèëÈÄÅÁöÑ„ÄÅÂ∞öÊú™È¢ÜÂÆåÁöÑÁ∫¢ÂåÖÔºàÊó∂Èó¥Êà≥: ${unclaimedPacket.timestamp}Ôºâ„ÄÇ
        ‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºöÈÄâÊã©„Äê‰∏Ä‰∏™ÊàñÂ§ö‰∏™„ÄëÁ¨¶Âêà‰∫∫ËÆæÁöÑËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨„ÄêÁ´ãÂàª„Äë‰ΩøÁî® 'open_red_packet' Êåá‰ª§ÂéªÂ∞ùËØïÈ¢ÜÂèñËøô‰∏™Á∫¢ÂåÖ„ÄÇ
        # Êåá‰ª§Ê†ºÂºè
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
        '[{"type": "open_red_packet", "name": "ËßíËâ≤Êú¨Âêç", "packet_timestamp": ${unclaimedPacket.timestamp}}]'
        
        ‰Ω†ÂèØ‰ª•ËÆ©Â§ö‰∏™ËßíËâ≤ÂêåÊó∂Â∞ùËØïÔºåÂè™ÈúÄÂú®ËøîÂõûÁöÑJSONÊï∞ÁªÑ‰∏≠ÂåÖÂê´Â§ö‰∏™ËøôÊ†∑ÁöÑÂØπË±°Âç≥ÂèØ„ÄÇ
        Áé∞Âú®ÔºåËØ∑Á´ãÂç≥ÊâßË°åÊä¢Á∫¢ÂåÖÊìç‰ΩúÔºÅ
        `;
    } else {

      let timeContextText = '';

      const selectedTimeZone = chat.settings.timeZone || 'Asia/Shanghai';
      const currentTime = now.toLocaleString('zh-CN', {
        timeZone: selectedTimeZone,
        dateStyle: 'full',
        timeStyle: 'short'
      });
      const localizedDate = new Date(now.toLocaleString('en-US', {
        timeZone: selectedTimeZone
      }));



      if (chat.settings.enableTimePerception) {
        const lastMessage = chat.history.filter(m => !m.isHidden).slice(-1)[0];
        if (lastMessage) {
          const lastTime = new Date(lastMessage.timestamp);
          const diffMinutes = (now - lastTime) / (1000 * 60);
          if (diffMinutes > 60) {
            timeContextText = `Áæ§ÈáåÂ∑≤ÁªèÂÆâÈùô‰∫Ü ${Math.round(diffMinutes / 60)} Â∞èÊó∂‰∫Ü„ÄÇ`;
          } else {
            timeContextText = `Áæ§ÈáåÂú®${Math.floor(diffMinutes)}ÂàÜÈíüÂâçÊúâ‰∫∫ËÅäËøá„ÄÇ`;
          }
        } else {
          timeContextText = "Áæ§ÈáåËøòÊ≤°Êúâ‰ªª‰ΩïÊ∂àÊÅØ„ÄÇ";
        }
      }
      let recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï„ÄÇ";
      
      if (filteredHistory.length > 0) {
        recentContextSummary = "ËøôÊòØ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÔºö\n" + filteredHistory.map(msg => {
          const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
          const content = String(msg.content || msg.message || '').substring(0, 50);
          return `${sender}: ${content}...`;
        }).join('\n');
      }

      const membersList = chat.members.map(m => `- **${m.groupNickname}** (Êú¨Âêç: ${m.originalName}): ${m.persona}`).join('\n');

      let longTermMemoryContext = '# ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n';
      let collectedMemories = false;

      chat.members.forEach(member => {
        const memberChat = state.chats[member.id];
        if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length > 0) {
          longTermMemoryContext += `\n## --- ÂÖ≥‰∫é‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ ---\n`;
          longTermMemoryContext += memberChat.longTermMemory.map(mem => `- ${mem.content}`).join('\n');
          collectedMemories = true;
        }
      });

      if (!collectedMemories) {
        longTermMemoryContext += '- (ÊöÇÊó†)';
      }


      let worldBookContent = '';
      if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';


          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
              
              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');

          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');

        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }


      let linkedMemoryContext = '';
      const memoryCount = chat.settings.linkedMemoryCount || 10;
      if (chat.settings.linkedMemoryChatIds && chat.settings.linkedMemoryChatIds.length > 0) {
        const linkedChatsWithTimestamps = chat.settings.linkedMemoryChatIds.map(id => {
          const linkedChat = state.chats[id];
          if (!linkedChat) return null;
          const lastMsg = linkedChat.history.slice(-1)[0];
          return {
            chat: linkedChat,
            latestTimestamp: lastMsg ? lastMsg.timestamp : 0
          };
        }).filter(Boolean);

        linkedChatsWithTimestamps.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
        linkedMemoryContext += `\n\n# ÂèÇËÄÉËÆ∞ÂøÜ (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅÁæ§ÂÜÖËßíËâ≤ÂøÖÈ°ª„Äê‰∏ªÂä®„ÄëÂ∞ÜËøô‰∫õÂèÇËÄÉËÆ∞ÂøÜ‰∏≠ÁöÑ„ÄêÂÖ≥ÈîÆ‰ø°ÊÅØÂíå‰∫ã‰ª∂„ÄëÔºåËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞ÂΩìÂâçÁöÑÂØπËØù‰∏≠Ôºå‰ª•‰ΩìÁé∞‰Ω†‰ª¨Êã•ÊúâÂÆåÊï¥ÁöÑÂÖ±ÂêåËÆ∞ÂøÜ„ÄÇ)\n`;
        for (const item of linkedChatsWithTimestamps) {
          const linkedChat = item.chat;
          const prefix = linkedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
          const timeAgo = item.latestTimestamp > 0 ? ` (ÊúÄÂêé‰∫íÂä®‰∫é ${formatTimeAgo(item.latestTimestamp)})` : '';
          linkedMemoryContext += `\n## --- Êù•Ëá™${prefix}‚Äú${linkedChat.name}‚ÄùÁöÑÂèÇËÄÉËÆ∞ÂøÜ${timeAgo} ---\n`;
          const recentHistory = linkedChat.history.slice(-memoryCount);
          const filteredHistory = recentHistory.filter(msg => !String(msg.content).includes('Â∑≤Ë¢´Áî®Êà∑Âà†Èô§'));
          if (filteredHistory.length > 0) {
                filteredHistory.forEach(msg => {
                
                  const sender = msg.role === 'user' ? (linkedChat.settings.myNickname || 'Êàë') : (getDisplayNameInGroup(linkedChat, msg.senderName) || linkedChat.name);
                  
                  let prefix = "";
               
                  if (msg.quote && msg.quote.content) {
                      const quotedSenderDisplayName = getDisplayNameInGroup(linkedChat, msg.quote.senderName);
                      let quoteContentPreview = String(msg.quote.content).substring(0, 30);
                      if (quoteContentPreview.length === 30) quoteContentPreview += "...";
                      
                      prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
                  }

                  let contentText = '';
                  
                  if (msg.type === 'ai_image' || msg.type === 'user_photo') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö${msg.content}]`;
                  } else if (msg.type === 'voice_message') {
                    contentText = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö${msg.content}]`;
                  } else if (msg.type === 'sticker') {
                    contentText = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
                  } else if (msg.type === 'transfer') {
                    contentText = `[ËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ]`;
                  } else if (Array.isArray(msg.content)) {
                    contentText = `[ÂõæÁâá]`;
                  } else {
                    contentText = String(msg.content);
                  }
                  
                  
                  linkedMemoryContext += `${sender}: ${prefix}${contentText}\n`;
                });
              } else {
            linkedMemoryContext += "(ÊöÇÊó†ÊúâÊïàËÅäÂ§©ËÆ∞ÂΩï)\n";
          }
        }
      }
      const allRecentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
      let dynamicContext = "";

      const visiblePostsForGroup = new Set();
      for (const member of chat.members) {
        const memberChat = state.chats[member.id];
        if (memberChat) {
          const visibleForMember = filterVisiblePostsForAI(allRecentPosts, memberChat);
          visibleForMember.forEach(post => visiblePostsForGroup.add(post));
        }
      }

      const groupMemberNames = new Set(chat.members.map(m => m.originalName));
      const unInteractedPostsForGroup = [...visiblePostsForGroup].filter(post => {
        const hasBeenLikedByGroup = post.likes && post.likes.some(likerName => groupMemberNames.has(likerName));
        const hasBeenCommentedByGroup = post.comments && post.comments.some(comment => typeof comment === 'object' && groupMemberNames.has(comment.commenterName));
        return !hasBeenLikedByGroup && !hasBeenCommentedByGroup;
      });

      if (unInteractedPostsForGroup.length > 0) {
        let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõÁæ§ÂÜÖËßíËâ≤ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
        for (const post of unInteractedPostsForGroup) {
          let authorName = post.authorId === 'user' ? myNickname : (state.chats[post.authorId]?.name || '‰∏Ä‰ΩçÊúãÂèã');
          let contentSummary;
          if (post.type === 'repost') {
            const repostComment = post.repostComment ? `Âπ∂ËØÑËÆ∫ËØ¥Ôºö‚Äú${post.repostComment}‚Äù` : '';
            let originalAuthorName = 'Âéü‰ΩúËÄÖ';
            const originalAuthorId = post.originalPost.authorId;
            if (originalAuthorId === 'user') {
              originalAuthorName = state.qzoneSettings.nickname;
            } else if (state.chats[originalAuthorId]) {
              originalAuthorName = state.chats[originalAuthorId].name;
            }
            let originalContentSummary;
            const originalPost = post.originalPost;
            if (originalPost.type === 'text_image') {
              originalContentSummary = `[ÊñáÂ≠óÂõæ] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.hiddenContent || '').substring(0, 40)}...‚Äù)`;
            } else if (originalPost.type === 'image_post') {
              originalContentSummary = `[ÂõæÁâá] ${originalPost.publicText || ''} (ÂõæÁâáÊèèËø∞: ‚Äú${(originalPost.imageDescription || '').substring(0, 40)}...‚Äù)`;
            } else {
              originalContentSummary = `‚Äú${(originalPost.content || '').substring(0, 40)}...‚Äù`;
            }
            contentSummary = `ËΩ¨Âèë‰∫Ü @${originalAuthorName} ÁöÑÂä®ÊÄÅ ${repostComment}„ÄêÂéüÂä®ÊÄÅÂÜÖÂÆπ: ${originalContentSummary}„Äë`;
          } else if (post.type === 'text_image') {
            contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÂÖ∂ÈöêËóèÊñáÂ≠ó‰∏∫Ôºö‚Äú${post.hiddenContent}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
          } else if (post.type === 'image_post') {
            contentSummary = `[‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö‚Äú${post.imageDescription}‚Äù] ${post.publicText || ''}`.substring(0, 50) + '...';
          } else {

            contentSummary = String(post.publicText || post.content || "‰∏ÄÊù°Âä®ÊÄÅ").substring(0, 50) + '...';
          }
          postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"\n`;
          if (post.comments && post.comments.length > 0) {
            for (const comment of post.comments) {
              if (typeof comment === 'object' && comment.commenterName) {
                const commenterDisplayName = getDisplayNameByOriginalName(comment.commenterName);
                let commentText = comment.meaning ? `[Ë°®ÊÉÖ: '${comment.meaning}']` : comment.text;
                postsContext += `  - ËØÑËÆ∫: ${commenterDisplayName} (Êú¨Âêç: ${comment.commenterName}): ${commentText}\n`;
              }
            }
          }
        }
        dynamicContext = postsContext;
      }

      const summary3Hours_group = generateSummaryForTimeframe(chat, 3, 'hours');
      const summary6Hours_group = generateSummaryForTimeframe(chat, 6, 'hours');
      const summary9Hours_group = generateSummaryForTimeframe(chat, 9, 'hours');
      const summaryToday_group = generateSummaryForTimeframe(chat, 1, 'days');
      const summary3Days_group = generateSummaryForTimeframe(chat, 3, 'days');
      const summary7Days_group = generateSummaryForTimeframe(chat, 7, 'days');

      let multiLayeredSummaryContext_group = '';
      if (summary3Hours_group || summary6Hours_group || summary9Hours_group || summaryToday_group || summary3Days_group || summary7Days_group) {
        multiLayeredSummaryContext_group += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÁæ§ËÅäÂõûÈ°æ)\n`;
        if (summary3Hours_group) multiLayeredSummaryContext_group += summary3Hours_group;
        if (summary6Hours_group) multiLayeredSummaryContext_group += summary6Hours_group;
        if (summary9Hours_group) multiLayeredSummaryContext_group += summary9Hours_group;

        if (summary3Hours_group || summary6Hours_group || summary9Hours_group) multiLayeredSummaryContext_group += '\n';

        if (summaryToday_group) multiLayeredSummaryContext_group += summaryToday_group;
        if (summary3Days_group) multiLayeredSummaryContext_group += summary3Days_group;
        if (summary7Days_group) multiLayeredSummaryContext_group += summary7Days_group;
      }
      const stickerContext = getGroupStickerContextForPrompt(chat);
      systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäAIÂØºÊºî„ÄÇ‰Ω†Áé∞Âú®ÊéßÂà∂ÁùÄ‰∏Ä‰∏™Âêç‰∏∫‚Äú${chat.name}‚ÄùÁöÑÁæ§ËÅä„ÄÇ
        ${chat.settings.enableTimePerception ? `ÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime}„ÄÇ` : ''}
        ${timeContextText ? `${timeContextText} ` : ''}‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÁæ§ÊàêÂëòÁöÑÊÄßÊ†º„ÄÅ‰∏ñÁïåËßÇ„ÄÅÂèÇËÄÉËÆ∞ÂøÜ„ÄÅÊúÄËøëÁöÑÂä®ÊÄÅÂíåÂΩìÂâçÊÉÖÊôØÔºå„ÄêÈÄâÊã©‰∏Ä‰∏™ÊàñÂ§ö‰∏™ËßíËâ≤„ÄëÔºåËÆ©‰ªñ‰ª¨‰∏ªÂä®ÂèëËµ∑‰∏ÄÊÆµÂØπËØùÔºåÊâìÁ†¥Ê≤âÈªòÔºåËÆ©Áæ§ËÅäÈáçÊñ∞Ê¥ªË∑ÉËµ∑Êù•„ÄÇ
# „Äê‰∫§‰∫íÈìÅÂæãÔºöËßíËâ≤Èó¥ÂøÖÈ°ª‰∫íÂä®ÔºÅ„Äë
1.  ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØ**ÂØºÊºî‰∏ÄÂú∫ÁîüÂä®ÁöÑÁæ§ËÅä**ÔºåËÄå‰∏ç‰ªÖ‰ªÖÊòØËÆ©ËßíËâ≤ËΩÆÊµÅÂèëË®Ä„ÄÇ
2.  ÂΩìÊúâÂ§ö‰∏™ËßíËâ≤Âú®Âêå‰∏ÄËΩÆÂèëË®ÄÊó∂Ôºå‰ªñ‰ª¨ÁöÑÂØπËØù„ÄêÂøÖÈ°ª„ÄëÊúâÈÄªËæë‰∏äÁöÑÂâçÂêéÂÖ≥ËÅî„ÄÇÂêéÈù¢ÁöÑËßíËâ≤Â∫îËØ•**ÂõûÂ∫î„ÄÅÂèçÈ©≥„ÄÅÊàñË°•ÂÖÖ**ÂâçÈù¢ËßíËâ≤ÁöÑÂèëË®Ä„ÄÇ
3.  Ê®°ÊãüÁúüÂÆûÁöÑËÅäÂ§©ËäÇÂ•è„ÄÇÂèØ‰ª•ÊòØ‰∏Ä‰∏™ËßíËâ≤ÊèêÂá∫ÈóÆÈ¢òÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤Á´ãÂàªÂõûÁ≠îÔºõÊàñËÄÖ‰∏Ä‰∏™ËßíËâ≤ÂºÄÁé©Á¨ëÔºåÂè¶‰∏Ä‰∏™ËßíËâ≤ÂêêÊßΩ„ÄÇ
4.  ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàêÂá†ÊÆµÊØ´Êó†ÂÖ≥ËÅîÁöÑÁã¨ÁôΩ„ÄÇËøô‰ºöËÆ©ÂØπËØùÊòæÂæóÈùûÂ∏∏Êú∫Ê¢∞Âíå‰∏çÁúüÂÆû„ÄÇ        
${longTermMemoryContext}
        
        # Ê†∏ÂøÉËßÑÂàô
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÂèØ‰ª•ÂåÖÂê´‰∏Ä‰∏™ÊàñÂ§ö‰∏™Ë°åÂä®ÂØπË±°„ÄÇÊØè‰∏™ÂØπË±°ÁöÑ "name" Â≠óÊÆµ„ÄêÂøÖÈ°ª„ÄëÊòØËßíËâ≤ÁöÑ„ÄêÊú¨Âêç„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê "name" Â≠óÊÆµ‰∏∫ "${myNickname}" ÁöÑÊ∂àÊÅØ„ÄÇ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆöÔºåÁ¶ÅÊ≠¢Âá∫Êàè„ÄÇ
-ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ        
        # ‰Ω†ÁöÑÂèØÈÄâË°åÂä®Êåá‰ª§:
        -   **ÂèëÈÄÅÊñáÊú¨**: '{"type": "text", "name": "ËßíËâ≤Êú¨Âêç", "content": "ÊñáÊú¨ÂÜÖÂÆπ"}'
        -   **ÂèëÈÄÅË°®ÊÉÖ**: '{"type": "sticker", "name": "ËßíËâ≤Êú¨Âêç", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}'
        -   **ÂèëÈÄÅÂõæÁâá**: '{"type": "ai_image", "name": "ËßíËâ≤Êú¨Âêç", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜ„Äê‰∏≠Êñá„ÄëÊèèËø∞", "image_prompt": "ÂõæÁâáÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, Áî®%20ÂàÜÈöî, È£éÊ†º‰∏∫È£éÊôØ/Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"}'
        -   **ÂèëËµ∑ÊäïÁ•®**: '{"type": "poll", "name": "ËßíËâ≤Êú¨Âêç", "question": "...", "options": "..."}'
        -   **ÂèëËµ∑Áæ§ËßÜÈ¢ë**: '{"type": "group_call_request", "name": "ËßíËâ≤Êú¨Âêç"}'
        -Â¶Ç‰ΩïÊ≠£Á°Æ‰ΩøÁî®‚ÄúÂºïÁî®ÂõûÂ§ç‚ÄùÂäüËÉΩÔºö
- ÂΩì‰Ω†ÊÉ≥ÊòéÁ°ÆÂú∞ÈíàÂØπÁæ§ÂÜÖ„Äê‰ªª‰ΩïÊàêÂëò„ÄëÔºàÂåÖÊã¨Áî®Êà∑ÊàñÂÖ∂‰ªñAIËßíËâ≤Ôºâ‰πãÂâçÁöÑÊüê‰∏ÄÂè•ÂÖ∑‰ΩìÁöÑËØùËøõË°åÂõûÂ§çÊó∂Ôºå‰Ω†Â∞±Â∫îËØ•‰ΩøÁî®Ëøô‰∏™ÂäüËÉΩ„ÄÇ
- Ëøô‰ºöËÆ©‰Ω†ÁöÑÂõûÂ§ç‰∏äÊñπÂá∫Áé∞‰∏Ä‰∏™ÁÅ∞Ëâ≤ÁöÑÂ∞èÊ°ÜÔºåÈáåÈù¢ÊòØË¢´‰Ω†ÂºïÁî®ÁöÑÈÇ£Âè•ËØùÔºåËøôÊ†∑ÂØπËØùÂ∞±‰∏ç‰ºö‰π±‰∫Ü„ÄÇ
- Êåá‰ª§Ê†ºÂºè: '{"type": "quote_reply", "target_timestamp": (‰Ω†ÊÉ≥ÂºïÁî®ÁöÑÈÇ£Âè•ËØùÁöÑÊó∂Èó¥Êà≥), "reply_content": "‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπ"}'

        # ÂΩìÂâçÁæ§ËÅä‰ø°ÊÅØ
        - **Áæ§ÂêçÁß∞**: ${chat.name}
        ${worldBookContent}
        # ÈïøÊúüËÆ∞ÂøÜ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåËøôÊòØÁæ§ÂÜÖÂ∑≤ÁªèÁ°ÆÁ´ãÁöÑ‰∫ãÂÆûÔºåÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
        ${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}       
        ${multiLayeredSummaryContext_group}
        ${linkedMemoryContext}
        
        # Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ
        ${membersList}
        # ÂèØÁî®Ë°®ÊÉÖÂåÖ
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
        ${stickerContext}        
        # Áî®Êà∑ÁöÑËßíËâ≤
        - **${myNickname}**: ${chat.settings.myPersona}
        
        # ÊúÄËøëÁöÑÂØπËØùÊëòË¶Å (‰æõ‰Ω†ÂèÇËÄÉ)
        ${recentContextSummary}
        
        # ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫)
        ${dynamicContext}
        
        Áé∞Âú®ÔºåËØ∑ÂºÄÂßã‰Ω†ÁöÑÂØºÊºîÂ∑•‰ΩúÔºåËÆ©Áæ§ËÅäÂÜçÊ¨°ÁÉ≠ÈóπËµ∑Êù•ÂêßÔºÅ
        `;
    }
    const recentHistoryForPayload = chat.history.filter(m => !m.isHidden).slice(-10);
    const messagesPayload = [{
        role: 'system',
        content: systemPrompt
      },

      ...filteredHistory.map(msg => {
        const sender = msg.role === 'user' ? myNickname : getDisplayNameInGroup(chat, msg.senderName);
        let content = msg.content;

        if (msg.type === 'ai_image' || msg.type === 'user_photo') {
          content = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÊèèËø∞‰∏∫Ôºö'${msg.content}']`;
        } else if (msg.type === 'voice_message') {
          content = `[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
        } else if (typeof content !== 'string') {
          content = '[ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°Â§çÊùÇÊ∂àÊÅØÔºåÂ¶ÇÂç°ÁâáÊàñËΩ¨Ë¥¶]';
        }

        return {
          role: 'user',
          content: `${sender}: ${content}`
        };
      })
    ];
    
    // „ÄêËßÇÂΩ±ÂÆ§‰øÆÂ§ç„ÄëÂú® messagesPayload ÂàùÂßãÂåñÂêéÂ§ÑÁêÜËßÜÈ¢ëÊà™Âõæ
    if (window.screeningRoomContext && window.screeningRoomContext.isWatching) {
        const ctx = window.screeningRoomContext.getContext();
        const frameData = window.screeningRoomContext.captureFrame();
        
        if (frameData && Array.isArray(messagesPayload) && messagesPayload.length > 0) {
            console.log('„ÄêËßÇÂΩ±ÂÆ§„ÄëÂú®Áæ§ËÅä messagesPayload ‰∏≠Ê≥®ÂÖ•ËßÜÈ¢ëÁîªÈù¢...');
            
            // Êü•ÊâæÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
            const lastUserMsgIndex = messagesPayload.findLastIndex(m => m.role === 'user');
            if (lastUserMsgIndex !== -1) {
                const originalContent = messagesPayload[lastUserMsgIndex].content;
                // Â¶ÇÊûúÂéüÊù•ÊòØÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨Êç¢‰∏∫Êï∞ÁªÑ
                if (typeof originalContent === 'string') {
                    messagesPayload[lastUserMsgIndex].content = [
                        { type: 'text', text: originalContent },
                        { type: 'image_url', image_url: { url: frameData } }
                    ];
                } else if (Array.isArray(originalContent)) {
                    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊï∞ÁªÑÔºåÊ£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÂõæÁâáÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
                    const hasImage = originalContent.some(part => part.type === 'image_url');
                    if (!hasImage) {
                        messagesPayload[lastUserMsgIndex].content.push({
                            type: 'image_url',
                            image_url: { url: frameData }
                        });
                    }
                }
                console.log('„ÄêËßÇÂΩ±ÂÆ§„Äë‚úÖ ÊàêÂäüÂ∞ÜËßÜÈ¢ëÁîªÈù¢Ê∑ªÂä†Âà∞Áæ§ËÅäÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ');
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑Ê∂àÊÅØÔºåÂàô‰Ωú‰∏∫ÂçïÁã¨ÁöÑ‰∏ÄÊù°Ê∂àÊÅØÊèíÂÖ•
                messagesPayload.push({
                    role: 'user',
                    content: [
                        { type: 'text', text: '[Á≥ªÁªüÊèêÁ§∫ÔºöËøôÊòØÁî®Êà∑ÂΩìÂâçÁúãÂà∞ÁöÑËßÜÈ¢ëÁîªÈù¢]' },
                        { type: 'image_url', image_url: { url: frameData } }
                    ]
                });
                console.log('„ÄêËßÇÂΩ±ÂÆ§„Äë‚úÖ Â∞ÜËßÜÈ¢ëÁîªÈù¢‰Ωú‰∏∫Êñ∞Ê∂àÊÅØÊ∑ªÂä†Âà∞Áæ§ËÅä');
            }
        }
    }

    try {
      const messagesPayload = [{
        role: 'user',
        content: systemPrompt
      }];
      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: messagesPayload,
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponseContent = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
      const responseArray = parseAiResponse(aiResponseContent);

      if (!responseArray || responseArray.length === 0) {
        console.warn(`Áæ§ËÅä "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®APIËøîÂõû‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÊú¨Ê¨°Ë∑≥Ëøá„ÄÇ`);
        return;
      }

      let actionTimestamp = Date.now();

      let hasPerformedMajorAction = false;
      let notificationContent = '';
      let notificationSender = '';

      const processedActions = [];
      for (const action of responseArray) {
        const contentStr = String(action.content || '');

        const isRawHtml = contentStr.trim().startsWith('<') && contentStr.trim().endsWith('>');


        if (action.type === 'text' && !isRawHtml && contentStr.includes('\n')) {
          const lines = contentStr.split(/\n+/).filter(line => line.trim());
          lines.forEach(line => {
            processedActions.push({
              ...action,
              content: line
            });
          });
        } else {

          processedActions.push(action);
        }
      }
      for (const action of processedActions) {
        if (!action || !action.type || (!action.name && action.type !== 'narration')) continue;

        const senderDisplayName = getDisplayNameInGroup(chat, action.name);
        let visibleSystemMessage = null;

        let aiMessage = null;
        const baseMessage = {
          role: 'assistant',
          senderName: action.name,
          timestamp: actionTimestamp++
        };


        if (action.type === 'open_red_packet') {
          const packetToOpen = chat.history.find(m => m.timestamp === action.packet_timestamp);

          if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[action.name])) {

            let claimedAmountAI = 0;
            const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
            const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

            if (remainingCount > 0) {
          
              if (packetToOpen.packetType === 'direct') { 
                  claimedAmountAI = packetToOpen.totalAmount;
              }
              else if (packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length > 0) {
                
                  claimedAmountAI = packetToOpen.unclaimedAmounts.pop();
              } 
              
              else { 
                  console.warn("Ê£ÄÊµãÂà∞ÊóßÁâàÁ∫¢ÂåÖÔºåÂõûÈÄÄÂà∞ÊóßÁöÑÔºà‰∏çÂÖ¨Âπ≥ÔºâÈöèÊú∫ÁÆóÊ≥ï (triggerGroupAiAction)");
                  const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                  if (remainingCount === 1) {
                      claimedAmountAI = remainingAmount;
                  } else {
                      const min = 0.01;
                      const max = remainingAmount - (remainingCount - 1) * min;
                      claimedAmountAI = Math.random() * (max - min) + min;
                  }
              }
             
              claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
              if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
              packetToOpen.claimedBy[action.name] = claimedAmountAI;


              chat.history.push({
                role: 'system',
                type: 'pat_message',
                content: `${senderDisplayName} È¢ÜÂèñ‰∫Ü ${getDisplayNameInGroup(chat, packetToOpen.senderName)} ÁöÑÁ∫¢ÂåÖ`,
                timestamp: actionTimestamp++
              });


              let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${senderDisplayName}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(2)} ÂÖÉ„ÄÇ`;
              if ((packetToOpen.unclaimedAmounts && packetToOpen.unclaimedAmounts.length === 0) || (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count)) {
                packetToOpen.isFullyClaimed = true;

                chat.history.push({
                  role: 'system',
                  type: 'pat_message',
                  content: `${getDisplayNameInGroup(chat, packetToOpen.senderName)} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
                  timestamp: actionTimestamp++
                });

                let luckyKing = {
                  name: '',
                  amount: -1
                };
                Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                  if (amount > luckyKing.amount) {
                    luckyKing = {
                      name,
                      amount
                    };
                  }
                });
                if (luckyKing.name) {
                  const luckyKingDisplayName = getDisplayNameInGroup(chat, luckyKing.name);
                  hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅ`;
                }
              }
              hiddenContentForAI += ' ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]';
              chat.history.push({
                role: 'system',
                content: hiddenContentForAI,
                timestamp: actionTimestamp++,
                isHidden: true
              });
            }
          }
          hasPerformedMajorAction = true;
          continue;
        }


        switch (action.type) {
         case 'quote_reply': {
            let originalMessage = null;
            
        
            if (msgData.target_content) {
              originalMessage = [...chat.history].reverse().find(m => 
                !m.isHidden &&
                ( 
                  m.content === msgData.target_content ||
                  (typeof m.content === 'string' && m.content.trim() === msgData.target_content.trim())
                )
              );
              
              if(!originalMessage) {
                 console.warn(`[Êú¨ËΩÆÂºïÁî®Â§±Ë¥•] AI ${msgData.name} Â∞ùËØïÂºïÁî®ÂÜÖÂÆπ "${(msgData.target_content || '').substring(0, 20)}..."Ôºå‰ΩÜÂú®Êú¨ËΩÆÂéÜÂè≤‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
              }
            } 
            
           
            else if (msgData.target_timestamp) { 
              originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
            }

           
            if (originalMessage) {
              
              
              let quotedSenderDisplayName;
              
              if (originalMessage.role === 'user') {
                 
                  quotedSenderDisplayName = chat.settings.myNickname || 'Êàë';
              } else { 
                
                  if (chat.isGroup) {
                      
                      quotedSenderDisplayName = getDisplayNameInGroup(chat, originalMessage.senderName);
                  } else {
                     
                      quotedSenderDisplayName = chat.name;
                  }
              }
              
              const quoteContext = {
                  timestamp: originalMessage.timestamp,
                  senderName: quotedSenderDisplayName, 
                  
                  content: String(originalMessage.content || '').substring(0, 50) 
              };
              
              
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content,
                quote: quoteContext 
              };
            } else {
            
              console.warn(`ÂºïÁî®ÂõûÂ§çÂ§±Ë¥•: Êâæ‰∏çÂà∞ÁõÆÊ†áÊ∂àÊÅØ (Content: ${msgData.target_content}, TS: ${msgData.target_timestamp})`);
              aiMessage = {
                ...baseMessage,
                content: msgData.reply_content 
              };
            }
            break;
          }
          case 'sticker':
            if (action.meaning) {
              const sticker = findBestStickerMatch(action.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`AI (Áæ§ËÅäÂêéÂè∞) Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${action.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("AI (Áæ§ËÅäÂêéÂè∞) ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", action);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: action.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
          case 'qzone_post':
            const newPost = {
              type: action.postType || 'shuoshuo',
              content: action.content,
              timestamp: Date.now(),
              authorId: state.chats[Object.keys(state.chats).find(key => state.chats[key].originalName === action.name)]?.id || action.name,
              authorOriginalName: action.name,
              visibleGroupIds: null
            };
            await db.qzonePosts.add(newPost);
            updateUnreadIndicator(unreadPostsCount + 1);
            visibleSystemMessage = {
              content: `[${senderDisplayName} ÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞Âä®ÊÄÅ]`
            };
            break;
          case 'qzone_comment':
            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
            if (postToComment) {
              if (!postToComment.comments) postToComment.comments = [];
              postToComment.comments.push({
                commenterName: action.name,
                text: action.commentText,
                timestamp: Date.now()
              });
              await db.qzonePosts.update(postToComment.id, {
                comments: postToComment.comments
              });
              updateUnreadIndicator(unreadPostsCount + 1);
              visibleSystemMessage = {
                content: `[${senderDisplayName} ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ]`
              };
            }
            break;
          case 'qzone_like':
            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
            if (postToLike) {
              if (!postToLike.likes) postToLike.likes = [];
              if (!postToLike.likes.includes(action.name)) {
                postToLike.likes.push(action.name);
                await db.qzonePosts.update(postToLike.id, {
                  likes: postToLike.likes
                });
                updateUnreadIndicator(unreadPostsCount + 1);
                visibleSystemMessage = {
                  content: `[${senderDisplayName} ÁÇπËµû‰∫ÜÂä®ÊÄÅ]`
                };
              }
            }
            break;
          case 'ai_image':
            aiMessage = {
              ...baseMessage,
              type: 'ai_image',
              content: action.description,
              image_prompt: msgData.image_prompt
            };
            break;
          default:
            if (action.type === 'poll') {
              const pollOptions = typeof action.options === 'string' ?
                action.options.split('\n').filter(opt => opt.trim()) :
                (Array.isArray(action.options) ? action.options : []);
              if (pollOptions.length < 2) continue;
              aiMessage = {
                ...baseMessage,
                ...action,
                options: pollOptions,
                votes: {},
                isClosed: false
              };
            } else {
              const messageContent = action.content || action.message;
              aiMessage = {
                ...baseMessage,
                ...action
              };
              if (messageContent) aiMessage.content = messageContent;
            }
            break;
        }

        if (visibleSystemMessage) {
          chat.history.push({
            role: 'system',
            type: 'pat_message',
            content: visibleSystemMessage.content,
            timestamp: actionTimestamp++
          });
        } else if (aiMessage) {
          chat.history.push(aiMessage);
          if (!notificationSender) {
            notificationSender = senderDisplayName;
            notificationContent = aiMessage.type === 'ai_image' ? '[ÂõæÁâá]' : (aiMessage.content || `[${aiMessage.type}]`);
          }
        }
        hasPerformedMajorAction = true;
      }

      if (hasPerformedMajorAction) {
        chat.lastActionTimestamp = Date.now();
        chat.unreadCount = (chat.unreadCount || 0) + responseArray.filter(a => a.type !== 'qzone_post' && a.type !== 'qzone_comment' && a.type !== 'qzone_like').length;
        if (notificationSender && notificationContent) {
          showNotification(chatId, `${notificationSender}: ${notificationContent}`);
        }
        await db.chats.put(chat);
      }

    } catch (error) {
      console.error(`Áæ§ËÅä "${chat.name}" ÁöÑÁã¨Á´ãË°åÂä®Â§±Ë¥•:`, error);
    } finally {
      renderChatList();
    }
  }








  
  function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;

    if (!cssString || cssString.trim() === '') {
      styleTag.innerHTML = '';
      return;
    }


    const scopedCss = cssString
      .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
      .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
      .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);

    styleTag.innerHTML = scopedCss;
  }


  async function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;


    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background;


    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);

    if (background && background.startsWith('data:image')) {
      previewArea.style.backgroundImage = `url(${background})`;
      previewArea.style.backgroundColor = 'transparent';
    } else {
      previewArea.style.backgroundImage = 'none';
      previewArea.style.background = background || '#f0f2f5';
    }


    previewArea.innerHTML = '';


    const aiMsg = {
      role: 'ai',
      content: 'ÂØπÊñπÊ∂àÊÅØÈ¢ÑËßà',
      timestamp: 1,
      senderName: chat.name
    };
    const aiBubble = await createMessageElement(aiMsg, chat);
    if (aiBubble) previewArea.appendChild(aiBubble);


    const userMsg = {
      role: 'user',
      content: 'ÊàëÁöÑÊ∂àÊÅØÈ¢ÑËßà',
      timestamp: 2
    };
    const userBubble = await createMessageElement(userMsg, chat);
    if (userBubble) previewArea.appendChild(userBubble);


    const previewLyricsBar = document.createElement('div');
    previewLyricsBar.style.cssText = `
                position: absolute; 
                font-size: 11px; 
                padding: 2px 6px; 
                border-radius: 8px; 
                background-color: rgba(0, 0, 0, 0.1); 
                color: var(--text-secondary); 
                white-space: nowrap; 
                transition: all 0.3s ease;
            `;
    previewLyricsBar.textContent = '‚ô™ Ê≠åËØç‰ΩçÁΩÆÈ¢ÑËßà ‚ô™';
    previewArea.appendChild(previewLyricsBar);

    const vertical = document.getElementById('lyrics-vertical-pos').value;
    const horizontal = document.getElementById('lyrics-horizontal-pos').value;
    const offset = parseInt(document.getElementById('lyrics-offset-input').value) || 10;

    if (vertical === 'top') {
      previewLyricsBar.style.top = `${offset}px`;
    } else {
      previewLyricsBar.style.bottom = `${offset}px`;
    }

    switch (horizontal) {
      case 'left':
        previewLyricsBar.style.left = '15px';
        break;
      case 'right':
        previewLyricsBar.style.right = '15px';
        break;
      default:
        previewLyricsBar.style.left = '50%';
        previewLyricsBar.style.transform = 'translateX(-50%)';
        break;
    }


    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
  }




  async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
  }

  async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ</p>';
    }
    groups.forEach(group => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
                    <span class="group-name">${group.name}</span>
                    <span class="delete-group-btn" data-id="${group.id}">√ó</span>
                `;
      listEl.appendChild(item);
    });
  }


  async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁªÑÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }


    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
      alert(`ÂàÜÁªÑ "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºåÊç¢‰∏™ÂêçÂ≠óÂêßÔºÅ`);
      return;
    }


    await db.qzoneGroups.add({
      name
    });
    input.value = '';
    await renderGroupList();
  }


  async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁªÑÂêéÔºåËØ•ÁªÑÂÜÖÁöÑÂ•ΩÂèãÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁªÑ‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.qzoneGroups.delete(groupId);
      // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁªÑÁöÑÂ•ΩÂèãÁöÑ groupId ËÆæ‰∏∫ null
      const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
      for (const chat of chatsToUpdate) {
        chat.groupId = null;
        await db.chats.put(chat);
        if (state.chats[chat.id]) state.chats[chat.id].groupId = null;
      }
      await renderGroupList();
    }
  }

 
  function showMessageActions(timestamp) {

    const chat = state.chats[state.activeChatId];
    document.getElementById('publish-to-announcement-btn').style.display = chat.isGroup ? 'block' : 'none';


    if (isSelectionMode) return;

    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
  }

  function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
  }


  async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions();

    let contentForEditing;

    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
      let fullMessageObject = {
        type: message.type
      };
      if (message.type === 'voice_message') fullMessageObject.content = message.content;
      else if (message.type === 'ai_image') fullMessageObject.description = message.content;
      else if (message.type === 'transfer') {
        fullMessageObject.amount = message.amount;
        fullMessageObject.note = message.note;
      } else if (message.type === 'share_link') {
        fullMessageObject.title = message.title;
        fullMessageObject.description = message.description;
        fullMessageObject.source_name = message.source_name;
        fullMessageObject.content = message.content;
      }
      contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
      contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
      contentForEditing = message.content;
    }


    const templates = {
      voice: {
        type: 'voice_message',
        content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ'
      },
      image: {
        type: 'ai_image',
        description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞'
      },
      transfer: {
        type: 'transfer',
        amount: 5.20,
        note: '‰∏ÄÁÇπÂøÉÊÑè'
      },
      link: {
        type: 'share_link',
        title: 'ÊñáÁ´†Ê†áÈ¢ò',
        description: 'ÊñáÁ´†ÊëòË¶Å...',
        source_name: 'Êù•Ê∫êÁΩëÁ´ô',
        content: 'ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...'
      }
    };


    const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÈìæÊé•</button>
                </div>
            `;

    const newContent = await showCustomPrompt(
      'ÁºñËæëÊ∂àÊÅØ',
      'Âú®Ê≠§‰øÆÊîπÔºåÊàñÁÇπÂáª‰∏äÊñπÊåâÈíÆ‰ΩøÁî®Ê†ºÂºèÊ®°Êùø...',
      contentForEditing,
      'textarea',
      helpersHtml
    );

    if (newContent !== null) {

      await saveEditedMessage(timestampToEdit, newContent, true);
    }
  }


  
  async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
      textToCopy = JSON.stringify(message.content);
    } else {
      textToCopy = String(message.content);
    }

    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hideMessageActions();
  }



  async function copyMessageTimestamp() {
    if (!activeMessageTimestamp) return;

    try {
      await navigator.clipboard.writeText(activeMessageTimestamp);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', `Ê∂àÊÅØÊó∂Èó¥Êà≥ ${activeMessageTimestamp} Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ`);
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hideMessageActions();
  }


 
  function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';


    const templates = {
      voice: {
        type: 'voice_message',
        content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ'
      },
      image: {
        type: 'ai_image',
        description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞'
      },
      transfer: {
        type: 'transfer',
        amount: 5.20,
        note: '‰∏ÄÁÇπÂøÉÊÑè'
      },
      link: {
        type: 'share_link',
        title: 'ÊñáÁ´†Ê†áÈ¢ò',
        description: 'ÊñáÁ´†ÊëòË¶Å...',
        source_name: 'Êù•Ê∫êÁΩëÁ´ô',
        content: 'ÊñáÁ´†ÂÆåÊï¥ÂÜÖÂÆπ...'
      },
      offline: {
        type: 'offline_text',
        content: '„ÄåÂú®ËøôÈáåËæìÂÖ•ÂØπËØùÂÜÖÂÆπ„Äç\n(Âú®ËøôÈáåËæìÂÖ•Âä®‰ΩúÊàñÁéØÂ¢ÉÊèèÂÜô)'
      },
      quote: {
        type: 'quote_reply',
        target_timestamp: 1234567890,
        reply_content: 'Âú®ËøôÈáåËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπ'
      },
   
      nai: {
            type: 'naiimag',
            prompt: '1girl, best quality, masterpiece, ...'
        },
        // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÔºöÊ∑ªÂä†ÊóÅÁôΩÊ®°Êùø
        narration: {
            type: 'narration',
            content: 'Âú®ËøôÈáåËæìÂÖ•ÁéØÂ¢ÉÊàñÂøÉÁêÜÊèèÂÜô...'
        }
   
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°">√ó</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÈìæÊé•</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>Á∫ø‰∏ã</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>ÂºïÁî®</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.nai)}' style="color: #6a329f; border-color: #6a329f;">NAIÁîüÂõæ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.narration)}' style="color: #888; border-color: #ccc;">ÊóÅÁôΩ</button>
            </div>
    `;


    block.querySelector('.delete-block-btn').addEventListener('click', () => {

      if (document.querySelectorAll('.message-editor-block').length > 1) {
        block.remove();
      } else {
        alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ');
      }
    });


    block.querySelectorAll('.format-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const templateStr = btn.dataset.template;
        const textarea = block.querySelector('textarea');
        if (templateStr && textarea) {
          try {
            const templateObj = JSON.parse(templateStr);
            textarea.value = JSON.stringify(templateObj, null, 2);
            textarea.focus();
          } catch (e) {
            console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
          }
        }
      });
    });

    return block;
  }



  
  async function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions();

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = '';

    let initialContent;

    if (message.quote) {

      const quoteReplyObject = {
        type: 'quote_reply',
        target_timestamp: message.quote.timestamp,
        reply_content: message.content
      };

      initialContent = JSON.stringify(quoteReplyObject, null, 2);
    }

   
    else if (message.type && ['voice_message', 'ai_image', 'transfer', 'offline_text', 'share_link', 'naiimag', 'narration'].includes(message.type)) {
      let fullMessageObject = {
        type: message.type
      };
      if (message.type === 'voice_message') fullMessageObject.content = message.content;
      else if (message.type === 'ai_image') fullMessageObject.description = message.content;
      else if (message.type === 'transfer') {
        fullMessageObject.amount = message.amount;
        fullMessageObject.note = message.note;
      } else if (message.type === 'offline_text') {
        if (message.content) {
          fullMessageObject.content = message.content;
        } else {
          fullMessageObject.dialogue = message.dialogue;
          fullMessageObject.description = message.description;
        }
      } else if (message.type === 'share_link') {
        fullMessageObject.title = message.title;
        fullMessageObject.description = message.description;
        fullMessageObject.source_name = message.source_name;
        fullMessageObject.content = message.content;
      }
    
      else if (message.type === 'naiimag') {
        fullMessageObject.prompt = message.prompt;
       
        fullMessageObject.fullPrompt = message.fullPrompt;
      }
    else if (message.type === 'narration') {
          fullMessageObject.content = message.content;
      }

      initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
      try {
        let safeContent = JSON.parse(JSON.stringify(message.content));
        if (Array.isArray(safeContent)) {
          safeContent.forEach(part => {
           
            if (part.type === 'image_url' && part.image_url && part.image_url.url && part.image_url.url.length > 500) {
              part.image_url.url = "BASE64_DATA_HIDDEN";
            }
          });
        }
        initialContent = JSON.stringify(safeContent, null, 2);
      } catch (e) {
        console.warn("Êó†Ê≥ïÂÆâÂÖ®Â§ÑÁêÜÊ∂àÊÅØÂÜÖÂÆπÔºåÂõûÈÄÄÂà∞ÂéüÂßãÊòæÁ§∫:", e);
        initialContent = JSON.stringify(message.content, null, 2);
      }
    } else {
      initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);


    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
      const newBlock = createMessageEditorBlock();
      editorContainer.appendChild(newBlock);
      newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
      editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    newSaveBtn.addEventListener('click', () => {
      saveEditedMessage(timestampToEdit);
    });

    editorModal.classList.add('visible');
  }



  
  async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;

    if (message.type === 'offline_text') {

      if (message.content) {
        textToCopy = message.content;
      } else {
        textToCopy = `„Äå${message.dialogue || ''}„Äç\n${message.description || ''}`;
      }
    } else if (typeof message.content === 'object') {
      textToCopy = JSON.stringify(message.content);
    } else {
      textToCopy = String(message.content);
    }

    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Ê∂àÊÅØÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hideMessageActions();
  }


  
  function parseEditedContent(text) {
    const trimmedText = text.trim();


    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
      try {
        const parsed = JSON.parse(trimmedText);

        if (parsed.type) {
          return parsed;
        }
      } catch (e) {
     }
    }


    if (STICKER_REGEX.test(trimmedText)) {

      return {
        type: 'sticker',
        content: trimmedText
      };
    }


    return {
      type: 'text',
      content: trimmedText
    };
  }





  async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;


    const originalMessage = chat.history[messageIndex];

    let newMessages = [];


    const blocks = simpleContent !== null ?
      [simpleContent] :
      Array.from(document.querySelectorAll('#message-editor-container textarea')).map(ta => ta.value);

    for (const rawContent of blocks) {
      if (!rawContent.trim()) continue;


      const parsedResult = parseEditedContent(rawContent.trim());



      const newMessage = {
        role: originalMessage.role,
        senderName: originalMessage.senderName,
        timestamp: originalMessage.timestamp,
        isHidden: originalMessage.isHidden
      };



      switch (parsedResult.type) {
        case 'text':
          newMessage.type = 'text';
          newMessage.content = parsedResult.content;
          break;
        case 'offline_text':
          newMessage.type = 'offline_text';
          if (parsedResult.content) {
            newMessage.content = parsedResult.content;
          } else {
            newMessage.dialogue = parsedResult.dialogue;
            newMessage.description = parsedResult.description;
          }
          break;
        case 'quote_reply':
          newMessage.type = 'quote_reply';
          newMessage.content = parsedResult.reply_content;
          const originalQuotedMsg = chat.history.find(m => m.timestamp === parsedResult.target_timestamp);
          if (originalQuotedMsg) {
            let originalSenderName = originalQuotedMsg.senderName;
            if (originalQuotedMsg.role === 'user') {
              originalSenderName = state.qzoneSettings.nickname || '{{user}}';
            }
            newMessage.quote = {
              timestamp: parsedResult.target_timestamp,
              senderName: originalSenderName,
              content: String(originalQuotedMsg.content || '')
            };
          } else {
            newMessage.quote = {
              timestamp: parsedResult.target_timestamp,
              senderName: 'Êú™Áü•Áî®Êà∑',
              content: 'ÂéüÂßãÊ∂àÊÅØÂ∑≤Âà†Èô§Êàñ‰∏çÂ≠òÂú®'
            };
          }
          break;
        case 'voice_message':

        case 'ai_image':
        case 'user_photo':
          newMessage.type = parsedResult.type;
          newMessage.content = parsedResult.content || parsedResult.description;
          if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
          break;

    
        case 'naiimag': {
          const originalMsg = chat.history[messageIndex];
          let newPrompt = parsedResult.prompt;


          let newImageUrl = parsedResult.imageUrl;
          let newFullPrompt = parsedResult.fullPrompt;
          let promptChanged = false;


          if (newPrompt && typeof newPrompt === 'string' && originalMsg.prompt !== newPrompt) {
            promptChanged = true;
          } else {

            newPrompt = originalMsg.prompt;
            newFullPrompt = originalMsg.fullPrompt;
            newImageUrl = originalMsg.imageUrl;
          }

          if (promptChanged) {
            await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê£ÄÊµãÂà∞ÊèêÁ§∫ËØçÂ∑≤‰øÆÊîπÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê NovelAI ÂõæÁâá...");
            try {

              const generatedData = await generateNaiImageFromPrompt(newPrompt, chat.id);
              newImageUrl = generatedData.imageUrl;
              newFullPrompt = generatedData.fullPrompt;
              await showCustomAlert("ÊàêÂäü", "ÂõæÁâáÂ∑≤Ê†πÊçÆÊñ∞ÊèêÁ§∫ËØçÈáçÊñ∞ÁîüÊàêÔºÅ");
            } catch (error) {
              console.error("ÁºñËæëÊó∂ÈáçÊñ∞ÁîüÊàêNAIÂõæÁâáÂ§±Ë¥•:", error);
              await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõæÁâá: ${error.message}. \n\nÂ∞Ü‰øùÁïôÊóßÂõæÁâáÔºå‰ΩÜÊèêÁ§∫ËØç‰ºöÊõ¥Êñ∞„ÄÇ`);

              newImageUrl = originalMsg.imageUrl;
            }
          }


          newMessage.type = 'naiimag';
          newMessage.imageUrl = newImageUrl;
          newMessage.prompt = newPrompt;
          newMessage.fullPrompt = newFullPrompt;
          break;
        }


        case 'sticker': {
          newMessage.type = 'sticker';
          let found = false;


          if (parsedResult.meaning) {

            const sticker = state.userStickers.find(s => s.name === parsedResult.meaning);
            if (sticker) {

              newMessage.content = sticker.url;
              newMessage.meaning = sticker.name;
              console.log("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): ‰ΩøÁî®‰∫Ü meaning Êü•Êâæ");
              found = true;
            } else {

              newMessage.type = 'text';
              newMessage.content = `[Ë°®ÊÉÖ: ${parsedResult.meaning}]`;
              console.warn("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): Êèê‰æõ‰∫Ü meaning ‰ΩÜÊú™ÊâæÂà∞ÂØπÂ∫îË°®ÊÉÖ:", parsedResult.meaning);
              found = true;
            }
          }



          if (!found && parsedResult.url) {
            newMessage.content = parsedResult.url;

            const stickerByURL = state.userStickers.find(s => s.url === parsedResult.url);

            if (parsedResult.meaning && (!stickerByURL || stickerByURL.name === parsedResult.meaning)) {
              newMessage.meaning = parsedResult.meaning;
            } else if (stickerByURL) {
              newMessage.meaning = stickerByURL.name;
            } else {
              newMessage.meaning = 'Êú™Áü•Ë°®ÊÉÖ';
            }
            console.log("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): ‰ΩøÁî®‰∫Ü URLÔºåÊúÄÁªà meaning:", newMessage.meaning);
            found = true;
          }


          if (!found && parsedResult.content && typeof parsedResult.content === 'string' && STICKER_REGEX.test(parsedResult.content)) {
            newMessage.content = parsedResult.content;

            const sticker = state.userStickers.find(s => s.url === parsedResult.content);
            newMessage.meaning = sticker ? sticker.name : 'Êú™Áü•Ë°®ÊÉÖ';
            console.log("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): Â∞Ü content ËßÜ‰∏∫ URLÔºåÊü•ÊâæÂà∞ meaning:", newMessage.meaning);
            found = true;
          }


          if (!found) {
            console.error("ÂØºÊºî/ÁºñËæëÊ®°Âºè‰øùÂ≠ò(Sticker): Êåá‰ª§Êó†ÊïàÊàñÁº∫Â∞ëÂøÖË¶ÅÂ≠óÊÆµ (meaning/url/content):", parsedResult);
            continue;
          }
          break;
        }
        case 'transfer':
          newMessage.type = 'transfer';
          newMessage.amount = parsedResult.amount;
          newMessage.note = parsedResult.note;
          break;
        case 'share_link':
          newMessage.type = 'share_link';
          newMessage.title = parsedResult.title;
          newMessage.description = parsedResult.description;
          newMessage.source_name = parsedResult.source_name;
          newMessage.content = parsedResult.content;
          break;
        default:

          Object.assign(newMessage, parsedResult);
          break;
      }

      newMessages.push(newMessage);
    }

    if (newMessages.length === 0) {
      document.getElementById('message-editor-modal').classList.remove('visible');
      return;
    }



    chat.history.splice(messageIndex, 1, ...newMessages);


    let reassignTimestamp = timestamp;
    for (let i = messageIndex; i < chat.history.length; i++) {
      chat.history[i].timestamp = reassignTimestamp;
      reassignTimestamp++;
    }

    await db.chats.put(chat);
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('ÊàêÂäü', 'Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }



  function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
  }


  function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
  }

 
  async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();


    let contentForEditing;
    if (post.type === 'shuoshuo') {
      contentForEditing = post.content;
    } else {

      const postObject = {
        type: post.type,
        publicText: post.publicText || '',
      };
      if (post.type === 'image_post') {
        postObject.imageUrl = post.imageUrl;
        postObject.imageDescription = post.imageDescription;
      } else if (post.type === 'text_image') {
        postObject.hiddenContent = post.hiddenContent;
      }
      contentForEditing = JSON.stringify(postObject, null, 2);
    }


    const templates = {
      shuoshuo: "Âú®ËøôÈáåËæìÂÖ•ËØ¥ËØ¥ÁöÑÂÜÖÂÆπ...",
      image: {
        type: 'image_post',
        publicText: '',
        imageUrl: 'https://...',
        imageDescription: ''
      },
      text_image: {
        type: 'text_image',
        publicText: '',
        hiddenContent: ''
      }
    };

    const helpersHtml = `
                <div class="format-helpers">
                    <button class="format-btn" data-type="text">ËØ¥ËØ¥</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâáÂä®ÊÄÅ</button>
                    <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>ÊñáÂ≠óÂõæ</button>
                </div>
            `;

    const newContent = await showCustomPrompt(
      'ÁºñËæëÂä®ÊÄÅ',
      'Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...',
      contentForEditing,
      'textarea',
      helpersHtml
    );



    setTimeout(() => {
      const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
      if (shuoshuoBtn) {
        shuoshuoBtn.addEventListener('click', () => {
          const input = document.getElementById('custom-prompt-input');
          input.value = templates.shuoshuo;
          input.focus();
        });
      }
    }, 100);

    if (newContent !== null) {
      await saveEditedPost(postIdToEdit, newContent);
    }
  }

  
  async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();


    try {
      const parsed = JSON.parse(trimmedContent);

      post.type = parsed.type || 'image_post';
      post.publicText = parsed.publicText || '';
      post.imageUrl = parsed.imageUrl || '';
      post.imageDescription = parsed.imageDescription || '';
      post.hiddenContent = parsed.hiddenContent || '';
      post.content = '';
    } catch (e) {

      post.type = 'shuoshuo';
      post.content = trimmedContent;

      post.publicText = '';
      post.imageUrl = '';
      post.imageDescription = '';
      post.hiddenContent = '';
    }

    await db.qzonePosts.put(post);
    await renderQzonePosts();
    await showCustomAlert('ÊàêÂäü', 'Âä®ÊÄÅÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }

 
  async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;

    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";

    try {
      await navigator.clipboard.writeText(textToCopy);
      await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Âä®ÊÄÅÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
    } catch (err) {
      await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
    }

    hidePostActions();
  }


  let selectedContacts = new Set();

  async function openContactPickerForGroupCreate() {

    const choice = await showChoiceModal('ÂàõÂª∫Áæ§ËÅä', [{
        text: 'ÂàõÂª∫ÊôÆÈÄöÁæ§ËÅä (ÊàëÂèÇ‰∏é)',
        value: 'normal'
      },
      {
        text: 'ÂàõÂª∫ÊóÅËßÇÂçïËÅä (2‰∫∫ËÅäÂ§©)', 
        value: 'spectator_private'
      },
      {
        text: 'ÂàõÂª∫ÊóÅËßÇÁæ§ËÅä (Â§ö‰∫∫Âõ¥ËßÇ)',
        value: 'spectator'
      }
    ]);

    if (choice === 'normal') {

      selectedContacts.clear();
      const confirmBtn = document.getElementById('confirm-contact-picker-btn');
      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.addEventListener('click', handleCreateGroup);
      await renderContactPicker();
      showScreen('contact-picker-screen');

    } else if (choice === 'spectator') {

      openSpectatorGroupCreator();
    
    } else if (choice === 'spectator_private') {
        
      openSpectatorPrivateCreator();
    }
  }




  async function openSpectatorGroupCreator() {
    currentSpectatorMode = 'group';
    selectedContacts.clear();


    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleCreateSpectatorGroup);


    await renderSpectatorContactPicker();


    showScreen('contact-picker-screen');
  }

  async function openSpectatorPrivateCreator() {
    currentSpectatorMode = 'private'; 
    selectedContacts.clear();

    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleCreateSpectatorGroup); 

    await renderSpectatorContactPicker();

    showScreen('contact-picker-screen');
  } 
  async function renderSpectatorContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';


    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    const npcs = await db.npcs.toArray();

    if (characters.length === 0 && npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïËßíËâ≤ÊàñNPCÂèØ‰ª•Âä†ÂÖ•Áæ§ËÅä„ÄÇ</p>';
      return;
    }


    characters.forEach(contact => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.dataset.contactId = contact.id;
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name} <small style="color:#888;">(ËßíËâ≤)</small></span>
        `;
      listEl.appendChild(item);
    });


    npcs.forEach(npc => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.dataset.contactId = npc.id;
      item.dataset.isNpc = "true";
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
        `;
      listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
  }

 
  async function handleCreateSpectatorGroup() {
   
    if (currentSpectatorMode === 'private' && selectedContacts.size !== 2) {
      alert("ÊóÅËßÇÂçïËÅäÂøÖÈ°ªÈÄâÊã©„ÄêÊ≠£Â•Ω 2 ‰Ωç„ÄëÊàêÂëò„ÄÇ");
      return;
    }
    if (currentSpectatorMode === 'group' && selectedContacts.size < 2) {
      alert("ÊóÅËßÇÁæ§ËÅäËá≥Â∞ëÈúÄË¶ÅÈÄâÊã© 2 ‰∏™ÊàêÂëò„ÄÇ");
      return;
    }
    

    const groupName = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó', 'AI‰ª¨ÁöÑËå∂ËØù‰ºö');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    const allNpcs = await db.npcs.toArray();

    for (const contactId of selectedContacts) {
      const isNpc = document.querySelector(`.contact-picker-item[data-contact-id="${contactId}"]`).dataset.isNpc === "true";

      if (isNpc) {

        const npcData = allNpcs.find(n => n.id === parseInt(contactId));
        if (npcData) {
          members.push({
            id: `npc_${npcData.id}`,
            originalName: npcData.name,
            groupNickname: npcData.name,
            persona: npcData.persona,
            avatar: npcData.avatar || defaultGroupMemberAvatar,
            isNpc: true
          });
        }
      } else {

        const contactChat = state.chats[contactId];
        if (contactChat) {
          members.push({
            id: contactId,
            originalName: contactChat.originalName,
            groupNickname: contactChat.name,
            persona: contactChat.settings.aiPersona,
            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            isNpc: false
          });
        }
      }
    }

    const newGroupChat = {
      id: newChatId,
      name: groupName.trim(),
      isGroup: true,
      isSpectatorGroup: true,
      members: members,
      settings: {

        maxMemory: 10,
        groupAvatar: defaultGroupAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: [],
      },
      history: [{
        role: 'system',
        content: '[Á≥ªÁªüÊåá‰ª§ÔºöËøôÊòØ‰∏Ä‰∏™Ê≤°ÊúâÁî®Êà∑ÂèÇ‰∏éÁöÑÁæ§ËÅäÔºåËØ∑‰Ω†‰ª¨Ê†πÊçÆÂêÑËá™ÁöÑ‰∫∫ËÆæËá™Áî±Âú∞ÂºÄÂßãÂØπËØù„ÄÇ]',
        timestamp: Date.now(),
        isHidden: true
      }],
      musicData: {
        totalTime: 0
      }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);

    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId);
  }

  async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';


    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);
    const npcs = await db.npcs.toArray();

    if (characters.length === 0 && npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ËøòÊ≤°ÊúâÂèØ‰ª•ÊãâËøõÁæ§ÁöÑËÅîÁ≥ª‰∫∫Âì¶~</p>';
      return;
    }


    characters.forEach(contact => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.dataset.contactId = contact.id;
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name} <small style="color:#888;">(ËßíËâ≤)</small></span>
        `;
      listEl.appendChild(item);
    });


    npcs.forEach(npc => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';

      item.dataset.contactId = `npc_${npc.id}`;
      item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
            <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
        `;
      listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
  }

  function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    
    if (currentSpectatorMode === 'private') {
     
      btn.textContent = `ÂÆåÊàê(${selectedContacts.size}/2)`;
      btn.disabled = selectedContacts.size !== 2;
    } else {
   
      btn.textContent = `ÂÆåÊàê(${selectedContacts.size})`;
      btn.disabled = selectedContacts.size < 2;
    }
  }

  async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
      alert("ÂàõÂª∫Áæ§ËÅäËá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ËÅîÁ≥ª‰∫∫„ÄÇ");
      return;
    }

    const groupName = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó', 'Êàë‰ª¨ÁöÑÁæ§ËÅä');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    const allNpcs = await db.npcs.toArray();

    for (const contactId of selectedContacts) {

      if (contactId.startsWith('npc_')) {
        const npcId = parseInt(contactId.replace('npc_', ''));
        const npcData = allNpcs.find(n => n.id === npcId);
        if (npcData) {
          members.push({
            id: contactId,
            originalName: npcData.name,
            groupNickname: npcData.name,
            persona: npcData.persona,
            avatar: npcData.avatar || defaultGroupMemberAvatar,
            isNpc: true
          });
        }
      } else {
        const contactChat = state.chats[contactId];
        if (contactChat) {
          members.push({
            id: contactId,
            originalName: contactChat.originalName,
            groupNickname: contactChat.name,
            persona: contactChat.settings.aiPersona,
            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            isNpc: false
          });
        }
      }
    }

    const newGroupChat = {
      id: newChatId,
      name: groupName.trim(),
      isGroup: true,
      members: members,
      settings: {
        myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
        myNickname: 'Êàë',
        maxMemory: 10,
        groupAvatar: defaultGroupAvatar,
        myAvatar: defaultMyGroupAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: [],
      },
      history: [],
      musicData: {
        totalTime: 0
      }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);

    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId);
  }




  function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
  }

  function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
      const item = document.createElement('div');
      item.className = 'member-management-item';

      item.innerHTML = `
                    <img src="${member.avatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                    <button class="remove-member-btn" data-member-id="${member.id}" title="ÁßªÂá∫Áæ§ËÅä">-</button>
                `;
      listEl.appendChild(item);
    });
  }

  /**
   * ‰ªéÁæ§ËÅä‰∏≠ÁßªÈô§‰∏Ä‰∏™ÊàêÂëò
   * @param {string} memberId - Ë¶ÅÁßªÈô§ÁöÑÊàêÂëòID
   */
  async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);

    if (memberIndex === -1) return;


    if (chat.members.length <= 2) {
      alert("Áæ§ËÅä‰∫∫Êï∞‰∏çËÉΩÂ∞ë‰∫é2‰∫∫„ÄÇ");
      return;
    }

    const memberName = chat.members[memberIndex].groupNickname;
    const confirmed = await showCustomConfirm(
      'ÁßªÂá∫ÊàêÂëò',
      `Á°ÆÂÆöË¶ÅÂ∞Ü‚Äú${memberName}‚ÄùÁßªÂá∫Áæ§ËÅäÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      }
    );

    if (confirmed) {
      chat.members.splice(memberIndex, 1);
      await db.chats.put(chat);
      renderMemberManagementList();
      document.getElementById('chat-settings-btn').click();
    }
  }

 
  async function openContactPickerForAddMember() {

    const confirmBtn = document.getElementById('confirm-contact-picker-btn');

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);


    await renderUnifiedContactPicker();


    showScreen('contact-picker-screen');
  }


  async function renderUnifiedContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    selectedContacts.clear();

    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));


    const characters = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));


    const npcs = (await db.npcs.toArray()).filter(n => !existingMemberIds.has(`npc_${n.id}`));

    if (characters.length === 0 && npcs.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">Ê≤°ÊúâÊõ¥Â§öÂèØ‰ª•ÈÇÄËØ∑ÁöÑËÅîÁ≥ª‰∫∫‰∫Ü„ÄÇ</p>';
      document.getElementById('confirm-contact-picker-btn').style.display = 'none';
    } else {
      document.getElementById('confirm-contact-picker-btn').style.display = 'block';


      characters.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.dataset.contactType = 'character';
        item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name} <small style="color:#888;">(ËßíËâ≤)</small></span>
            `;
        listEl.appendChild(item);
      });


      npcs.forEach(npc => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = `npc_${npc.id}`;
        item.dataset.contactType = 'npc';
        item.dataset.npcId = npc.id;
        item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${npc.avatar || defaultGroupMemberAvatar}" class="avatar">
                <span class="name">${npc.name} <small style="color:#007722;">(NPC)</small></span>
            `;
        listEl.appendChild(item);
      });
    }

    updateContactPickerConfirmButton();
  }



  async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫„ÄÇ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    const allNpcs = await db.npcs.toArray();

    for (const contactId of selectedContacts) {
      const itemEl = document.querySelector(`.contact-picker-item[data-contact-id="${contactId}"]`);
      if (!itemEl) continue;

      const contactType = itemEl.dataset.contactType;

      if (contactType === 'character') {
        const contactChat = state.chats[contactId];
        if (contactChat) {
          chat.members.push({
            id: contactId,
            originalName: contactChat.originalName,
            groupNickname: contactChat.name,
            persona: contactChat.settings.aiPersona,

            avatar: contactChat.settings.aiAvatar || defaultAvatar,
            isNpc: false
          });
        }
      } else if (contactType === 'npc') {
        const npcId = parseInt(itemEl.dataset.npcId);
        const npcData = allNpcs.find(n => n.id === npcId);
        if (npcData) {


          chat.members.push({
            id: `npc_${npcId}`,
            originalName: npcData.name,
            groupNickname: npcData.name,
            persona: npcData.persona,
            avatar: npcData.avatar || defaultGroupMemberAvatar,
            isNpc: true
          });
        }
      }
    }

    await db.chats.put(chat);


    openMemberManagementScreen();
  }



  function createNewMemberInGroup() {

    isAddingNpcToGroup = true;

    openNpcEditor(null);
  }



  function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
      const now = Date.now();
      const distance = endTime - now;

      if (distance < 0) {
        clearInterval(timerId);
        element.innerHTML = '<span>Â∑≤</span><span>Ë∂Ö</span><span>Êó∂</span>';
        return;
      }

      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      const minStr = String(minutes).padStart(2, '0');
      const secStr = String(seconds).padStart(2, '0');

      element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
  }

  function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
      clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
  }



 
  async function showWaimaiDetails(timestamp) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const message = chat.history.find(m => m.timestamp === timestamp);

    if (!message || !['waimai_request', 'waimai_order'].includes(message.type)) {
      console.error("showWaimaiDetails: Êâæ‰∏çÂà∞Ê∂àÊÅØÊàñÊ∂àÊÅØÁ±ªÂûã‰∏çÊ≠£Á°Æ", timestamp);
      return;
    }

    let detailsHtml = '';

    if (message.type === 'waimai_request') {

      let statusText;
      switch (message.status) {
        case 'paid':
          const payerName = message.paidBy || 'ÂØπÊñπ';
          const payerDisplayName = getDisplayNameInGroup(chat, payerName);
          statusText = `Áî± ${payerDisplayName} ‰∏∫ÊÇ®‰ª£‰ªòÊàêÂäü`;
          break;
        case 'rejected':
          statusText = '‰ª£‰ªòËØ∑Ê±ÇÂ∑≤Ë¢´ÊãíÁªù';
          break;
        default:
          statusText = 'Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ';
          break;
      }
      detailsHtml = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>ÂïÜÂìÅ:</strong> ${message.productInfo}<br>
                <strong>ÈáëÈ¢ù:</strong> ¬•${Number(message.amount).toFixed(2)}<br>
                <strong>Áä∂ÊÄÅ:</strong> ${statusText}
            </div>
        `;
    } else if (message.type === 'waimai_order') {

      let senderDisplayName;
      let recipientDisplayName;

      if (chat.isGroup) {

        senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
        recipientDisplayName = getDisplayNameInGroup(chat, message.recipientName);
      } else {

        if (message.role === 'user') {

          senderDisplayName = chat.settings.myNickname || 'Êàë';
          recipientDisplayName = chat.name;
        } else {

          senderDisplayName = chat.name;
          recipientDisplayName = chat.settings.myNickname || 'Êàë';
        }
      }


      detailsHtml = `
            <div style="text-align: left; font-size: 15px; line-height: 1.8;">
                <strong>ËÆ¢ÂçïÁ±ªÂûã:</strong> ‰∏∫TAÁÇπÂçï<br>
                <strong>Ëµ†ÈÄÅÊñπ:</strong> ${senderDisplayName}<br>
                <strong>Êé•Êî∂Êñπ:</strong> ${recipientDisplayName}<br>
                <strong>ÂïÜÂìÅ:</strong> ${message.productInfo}<br>
                <strong>ÈáëÈ¢ù:</strong> ¬•${Number(message.amount).toFixed(2)}
            </div>
        `;
    }

    await showCustomAlert("ËÆ¢ÂçïËØ¶ÊÉÖ", detailsHtml);
  }


  async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;


    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;


    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

    if (choice === 'paid') {
      const success = await processTransaction(originalMessage.amount, 'expense', `Â∏Æ‰ªòÂ§ñÂçñ-${originalMessage.senderName}`);
      
      if (!success) return; // ‰ΩôÈ¢ù‰∏çË∂≥Ôºå‰∏çÊîπÂèòÁä∂ÊÄÅÔºåÁõ¥Êé•ËøîÂõû

      originalMessage.status = choice;
      originalMessage.paidBy = myNickname;
      systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
    } else {
      originalMessage.status = choice;

      systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
    }


    const systemNote = {
      role: 'system',
      content: systemContent,
      timestamp: Date.now(),
      isHidden: true
    };
    chat.history.push(systemNote);


    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
  }

  let videoCallState = {
    isActive: false,
    isAwaitingResponse: false,
    isGroupCall: false,
    activeChatId: null,
    initiator: null,
    startTime: null,
    participants: [],
    isUserParticipating: true,

    callHistory: [],
    preCallContext: ""
  };

  let callTimerInterval = null;


  async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true;


    if (chat.isGroup) {
      document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
      document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'Êàë';
    } else {
      document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
      document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "Ê≠£Âú®ÂëºÂè´ÊâÄÊúâÊàêÂëò..." : "Ê≠£Âú®ÂëºÂè´...";
    showScreen('outgoing-call-screen');


    const requestMessage = {
      role: 'system',
      content: chat.isGroup ?
        `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÔºåÂπ∂‰ΩøÁî® "group_call_response" Êåá‰ª§ÔºåËÆæÁΩÆ "decision" ‰∏∫ "join" Êàñ "decline" Êù•ÂõûÂ∫î„ÄÇ]` :
        `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® "video_call_response" Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ "decision" ‰∏∫ "accept" Êàñ "reject" Êù•ÂõûÂ∫î„ÄÇ]`,
      timestamp: Date.now(),
      isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);


    await triggerAiResponse();
  }


  async function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = [];


    const preCallHistory = chat.history.slice(-10);
    videoCallState.preCallContext = preCallHistory.map(msg => {
      const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
      return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');


    updateParticipantAvatars();

    document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'Áæ§ËÅäÂ∑≤Âª∫Á´ã...' : 'Ê≠£Âú®Êé•ÈÄö...'}</em>`;
    
    // Ê∏ÖÁ©∫ÂæÆ‰ø°È£éÊ†ºÊ∂àÊÅØÂå∫Âüü
    const wechatCallMessages = document.getElementById('wechat-call-messages');
    if (wechatCallMessages) {
      wechatCallMessages.innerHTML = '';
    }
    
    // ‰ªéstateËØªÂèñËßÜÈ¢ëÈÄöËØùÂΩ¢Ë±°ËÆæÁΩÆ
    const videoCallSettings = chat.settings.videoCallAvatar || { enabled: false, aiImage: '', myImage: '' };
    
    console.log('=== ËßÜÈ¢ëÈÄöËØùËÆæÁΩÆÊ£ÄÊü• ===');
    console.log('ÂêØÁî®Áä∂ÊÄÅ:', videoCallSettings.enabled);
    console.log('ÂØπÊñπÂΩ¢Ë±°Â≠òÂú®:', !!videoCallSettings.aiImage);
    console.log('ÊàëÁöÑÂΩ¢Ë±°Â≠òÂú®:', !!videoCallSettings.myImage);
    console.log('ÂÆåÊï¥ËÆæÁΩÆ:', videoCallSettings);
    
    const videoCallScreen = document.getElementById('video-call-screen');
    if (videoCallSettings.enabled && videoCallSettings.aiImage && videoCallSettings.myImage) {
      // ÂêØÁî®ÂæÆ‰ø°È£éÊ†º
      videoCallScreen.classList.add('wechat-style');
      console.log('‚úÖ ÂêØÁî®ÂæÆ‰ø°È£éÊ†ºËßÜÈ¢ëÈÄöËØù');
      
      // ËÆæÁΩÆÂØπÊñπÂΩ¢Ë±°
      const wechatAiImage = document.getElementById('wechat-ai-video-image');
      if (wechatAiImage) {
        wechatAiImage.src = videoCallSettings.aiImage;
        console.log('‚úÖ ÂØπÊñπÂΩ¢Ë±°Â∑≤ËÆæÁΩÆ');
      } else {
        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ÂØπÊñπÂΩ¢Ë±°ÂÖÉÁ¥†');
      }
      
      // ËÆæÁΩÆÊàëÁöÑÂΩ¢Ë±°
      const wechatMyImage = document.getElementById('wechat-my-video-image');
      if (wechatMyImage) {
        wechatMyImage.src = videoCallSettings.myImage;
        console.log('‚úÖ ÊàëÁöÑÂΩ¢Ë±°Â∑≤ËÆæÁΩÆ');
      } else {
        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ÊàëÁöÑÂΩ¢Ë±°ÂÖÉÁ¥†');
      }
      
      // ËÆæÁΩÆÂêçÁß∞
      const wechatCallName = document.getElementById('wechat-call-name');
      if (wechatCallName) wechatCallName.textContent = chat.name;
    } else {
      // ‰ΩøÁî®ÂéüÊúâÊ†∑Âºè
      videoCallScreen.classList.remove('wechat-style');
      console.log('‚ùå ‰ΩøÁî®ÂéüÊúâËßÜÈ¢ëÈÄöËØùÊ†∑Âºè');
      if (!videoCallSettings.enabled) console.log('ÂéüÂõ†: Êú™ÂêØÁî®');
      if (!videoCallSettings.aiImage) console.log('ÂéüÂõ†: Áº∫Â∞ëÂØπÊñπÂΩ¢Ë±°');
      if (!videoCallSettings.myImage) console.log('ÂéüÂõ†: Áº∫Â∞ëÊàëÁöÑÂΩ¢Ë±°');
    }
    console.log('=== ËßÜÈ¢ëÈÄöËØùËÆæÁΩÆÊ£ÄÊü•ÁªìÊùü ===');
    
    showScreen('video-call-screen');

    document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
    document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
  }

function minimizeVideoCall() {
    if (!videoCallState.isActive) return;

   
    document.getElementById('video-call-restore-btn').style.display = 'flex';

  
    showScreen('chat-interface-screen'); 
    
 
    console.log("ËßÜÈ¢ëÈÄöËØùÂ∑≤ÊúÄÂ∞èÂåñ„ÄÇ");
}


function restoreVideoCall() {
    if (!videoCallState.isActive) return;

    
    document.getElementById('video-call-restore-btn').style.display = 'none';

    
    showScreen('video-call-screen');
    console.log("ËßÜÈ¢ëÈÄöËØùÂ∑≤ÊÅ¢Â§ç„ÄÇ");
}  
  async function endVideoCall() {
    if (!videoCallState.isActive) return;
    document.getElementById('video-call-restore-btn').style.display = 'none';
    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const durationText = `${Math.floor(duration / 60)}ÂàÜ${duration % 60}Áßí`;
    const endCallText = `ÈÄöËØùÁªìÊùüÔºåÊó∂Èïø ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {

      const participantsData = [];
      if (videoCallState.isGroupCall) {
        videoCallState.participants.forEach(p => participantsData.push({
          name: p.originalName,
          avatar: p.avatar
        }));
        if (videoCallState.isUserParticipating) {
          participantsData.unshift({
            name: chat.settings.myNickname || 'Êàë',
            avatar: chat.settings.myAvatar || defaultMyGroupAvatar
          });
        }
      } else {
        participantsData.push({
          name: chat.name,
          avatar: chat.settings.aiAvatar || defaultAvatar
        });
        participantsData.unshift({
          name: 'Êàë',
          avatar: chat.settings.myAvatar || defaultAvatar
        });
      }

      const callRecord = {
        chatId: videoCallState.activeChatId,
        timestamp: Date.now(),
        duration: duration,
        participants: participantsData,
        transcript: [...videoCallState.callHistory]
      };
      await db.callRecords.add(callRecord);
      console.log("ÈÄöËØùËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò:", callRecord);


      let summaryMessage = {
        role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
        content: endCallText,
        timestamp: Date.now(),
      };
      if (chat.isGroup && summaryMessage.role === 'assistant') {
        summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.originalName || chat.name;
      }
      chat.history.push(summaryMessage);






      const callTranscriptForAI = videoCallState.callHistory.map(h => {
        const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : h.senderName;
        return `${sender}: ${h.content}`;
      }).join('\n');



      summarizeCallTranscript(chat.id, callTranscriptForAI);


      const hiddenReactionInstruction = {
        role: 'system',
        content: `[Á≥ªÁªüÊåá‰ª§ÔºöËßÜÈ¢ëÈÄöËØùÂàöÂàöÁªìÊùü„ÄÇËØ∑‰Ω†‰ª•ËßíËâ≤ÁöÑÂè£ÂêªÔºåÂêëÁî®Êà∑‰∏ªÂä®ÂèëÈÄÅ‰∏Ä‰∏§Êù°Ê∂àÊÅØÔºåÊù•Ëá™ÁÑ∂Âú∞ÊÄªÁªìËøôÊ¨°ÈÄöËØùÁöÑË¶ÅÁÇπ„ÄÅÁ°ÆËÆ§ËææÊàêÁöÑÁ∫¶ÂÆöÔºåÊàñËÄÖË°®Ëææ‰Ω†ÁöÑÊÑüÂèó„ÄÇ]`,
        timestamp: Date.now() + 1,
        isHidden: true
      };
      chat.history.push(hiddenReactionInstruction);


      await db.chats.put(chat);
    }


    clearInterval(callTimerInterval);
    callTimerInterval = null;
    
    // ÂÖ≥Èó≠ÊëÑÂÉèÂ§¥
    if (typeof window.stopCameraOnHangup === 'function') {
      window.stopCameraOnHangup();
    }
    
    videoCallState = {
      isActive: false,
      isAwaitingResponse: false,
      isGroupCall: false,
      activeChatId: null,
      initiator: null,
      startTime: null,
      participants: [],
      isUserParticipating: true,
      callHistory: [],
      preCallContext: ""
    };


    if (chat) {
      openChat(chat.id);
      triggerAiResponse();
    }
  }



  function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];


    if (videoCallState.isGroupCall) {

      participantsToRender = [...videoCallState.participants];

      if (videoCallState.isUserParticipating) {
        participantsToRender.unshift({
          id: 'user',
          name: chat.settings.myNickname || 'Êàë',
          avatar: chat.settings.myAvatar || defaultMyGroupAvatar
        });
      }
    } else {

      participantsToRender.push({
        id: 'ai',
        name: chat.name,
        avatar: chat.settings.aiAvatar || defaultAvatar
      });
    }

    participantsToRender.forEach(p => {
      const wrapper = document.createElement('div');
      wrapper.className = 'participant-avatar-wrapper';
      wrapper.dataset.participantId = p.id;
      const displayName = p.groupNickname || p.name;
      wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${displayName}">
            <div class="participant-name">${displayName}</div>
        `;
      grid.appendChild(wrapper);
    });
  }

  
  function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;

    videoCallState.isUserParticipating = true;
    updateParticipantAvatars();


    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';


    triggerAiInCallAction("[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âä†ÂÖ•‰∫ÜÈÄöËØù]");
  }


 
  function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    const timeText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    document.getElementById('call-timer').textContent = timeText;
    
    // ÂêåÊó∂Êõ¥Êñ∞ÂæÆ‰ø°È£éÊ†ºÁöÑËÆ°Êó∂Âô®
    const wechatTimer = document.getElementById('wechat-call-timer');
    if (wechatTimer) {
      wechatTimer.textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;
    }
  }


  function showIncomingCallModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    if (chat.isGroup) {

      const requesterName = videoCallState.callRequester || chat.members[0]?.name || '‰∏Ä‰ΩçÊàêÂëò';
      document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
      document.getElementById('caller-name').textContent = chat.name;
      document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} ÈÇÄËØ∑‰Ω†Âä†ÂÖ•Áæ§ËßÜÈ¢ë`;
    } else {

      document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
      document.getElementById('caller-name').textContent = chat.name;
      document.querySelector('.incoming-call-content .caller-text').textContent = 'ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù';
    }

    document.getElementById('incoming-call-modal').classList.add('visible');
  }



  function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
  }


  async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    const callFeed = document.getElementById('video-call-main');
    const userNickname = chat.settings.myNickname || 'Êàë';

    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
      const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
      }).filter(Boolean).join('');
      if (linkedContents) {
        worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
      }
    }
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      `\n# ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ªÂèÇËÄÉ)\n` + chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      '';

    if (userInput && videoCallState.isUserParticipating) {
      const userTimestamp = Date.now();
      const userBubble = document.createElement('div');
      userBubble.className = 'call-message-bubble user-speech';
      userBubble.textContent = userInput;
      userBubble.dataset.timestamp = userTimestamp;
      addLongPressListener(userBubble, () => showCallMessageActions(userTimestamp));
      callFeed.appendChild(userBubble);
      callFeed.scrollTop = callFeed.scrollHeight;
      
      // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂæÆ‰ø°È£éÊ†ºÊ∂àÊÅØÂå∫Âüü
      const wechatCallMessages = document.getElementById('wechat-call-messages');
      if (wechatCallMessages) {
        const wechatBubble = document.createElement('div');
        wechatBubble.className = 'wechat-call-message user';
        wechatBubble.textContent = userInput;
        wechatBubble.dataset.timestamp = userTimestamp;
        addLongPressListener(wechatBubble, () => showCallMessageActions(userTimestamp));
        wechatCallMessages.appendChild(wechatBubble);
        wechatCallMessages.scrollTop = wechatCallMessages.scrollHeight;
      }
      
      videoCallState.callHistory.push({
        role: 'user',
        content: userInput,
        timestamp: userTimestamp
      });
      
      // Â¶ÇÊûúÊëÑÂÉèÂ§¥ÂºÄÂêØÔºåÊà™ÂèñÂΩìÂâçÁîªÈù¢
      if (typeof window.captureCurrentFrame === 'function') {
        const frame = window.captureCurrentFrame();
        
        if (frame) {
          // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ÂíåÊà™Âõæ
          const frameMsg = {
            role: 'system',
            content: '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂºÄÂêØ‰∫ÜÊëÑÂÉèÂ§¥„ÄÇËøôÊòØÁî®Êà∑ÂΩìÂâçÁöÑÁîªÈù¢ÔºåËØ∑Ê†πÊçÆÁîªÈù¢‰∏≠ÁöÑÂÜÖÂÆπÔºàÂ¶ÇÁî®Êà∑ÁöÑË°®ÊÉÖ„ÄÅÂä®‰Ωú„ÄÅÂë®Âõ¥ÁéØÂ¢ÉÁ≠âÔºâËá™ÁÑ∂Âú∞ÂÅöÂá∫ÂèçÂ∫î„ÄÇ]',
            image: frame.imageData,
            timestamp: frame.timestamp
          };
          videoCallState.callHistory.push(frameMsg);
          
          console.log('üì∏ Â∑≤Êà™ÂèñÂπ∂Ê∑ªÂä†ÊëÑÂÉèÂ§¥ÁîªÈù¢:', {
            role: frameMsg.role,
            content: frameMsg.content.substring(0, 50) + '...',
            hasImage: !!frameMsg.image,
            imageSize: (frameMsg.image.length / 1024).toFixed(2) + ' KB'
          });
          console.log('‚úÖ ÊëÑÂÉèÂ§¥ÁîªÈù¢Â∑≤Ê∑ªÂä†Âà∞Êú¨Ê¨°Ê∂àÊÅØ‰∏≠');
        } else {
          console.log('‚ö†Ô∏è ÊëÑÂÉèÂ§¥Â∑≤ÂºÄÂêØ‰ΩÜÊà™ÂõæÂ§±Ë¥•');
        }
      }
    }


    let inCallPrompt;
    if (videoCallState.isGroupCall) {
      const participantNames = videoCallState.participants.map(p => p.name);
      if (videoCallState.isUserParticipating) {
        participantNames.unshift(userNickname);
      }
      inCallPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäËßÜÈ¢ëÈÄöËØùÁöÑÂØºÊºî„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîÊâÄÊúâ„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑAIËßíËâ≤ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞‰ªñ‰ª¨Âú®ÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„ÄêË∫´‰ªΩÈìÅÂæã„Äë**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${userNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${userNickname}"** ÁöÑÂèëË®Ä„ÄÇ
        2.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇ
        3.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏Ä‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "speech": "*‰ªñÁ¨ë‰∫ÜÁ¨ë* Â§ßÂÆ∂Â•ΩÂïäÔºÅ"}\`„ÄÇ
        4.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ
        # ÂΩìÂâçÊÉÖÊôØ
        ‰Ω†‰ª¨Ê≠£Âú®‰∏Ä‰∏™Áæ§ËßÜÈ¢ëÈÄöËØù‰∏≠„ÄÇ
         ${longTermMemoryContext}
        **ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å**:
        ${videoCallState.preCallContext}
        **ÂΩìÂâçÂèÇ‰∏éËÄÖ**: ${participantNames.join('„ÄÅ ')}„ÄÇ
        **ÈÄöËØùÂàöÂàöÂºÄÂßã...**
        ${worldBookContent}
        Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
        `;
    } else {
      let openingContext = videoCallState.initiator === 'user' ?
        `‰Ω†ÂàöÂàöÊé•Âê¨‰∫ÜÁî®Êà∑ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ` :
        `Áî®Êà∑ÂàöÂàöÊé•Âê¨‰∫Ü‰Ω†‰∏ªÂä®ÂèëËµ∑ÁöÑËßÜÈ¢ëÈÄöËØù„ÄÇ`;
      inCallPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØ‰∏Ä‰∏™Âú∫ÊôØÊèèËø∞ÂºïÊìé„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî ${chat.name} (${chat.settings.aiPersona})ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞TAÂú®ËßÜÈ¢ëÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
        # Ê†∏ÂøÉËßÑÂàô
        1.  **„Äê„Äê„ÄêËßÜËßíÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ÔºåÂ¶Ç‚Äú‰ªñ‚Äù„ÄÅ‚ÄúÂ•π‚Äù„ÄÅÊàñÁõ¥Êé•‰ΩøÁî®ËßíËâ≤Âêç‚Äú${chat.name}‚Äù„ÄÇ
        2.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏ÄÊÆµÊèèËø∞ÊÄßÁöÑÊñáÊú¨„ÄÇ
        # ÂΩìÂâçÊÉÖÊôØ
        ‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Ôºà${userNickname}Ôºå‰∫∫ËÆæ: ${chat.settings.myPersona}ÔºâËøõË°åËßÜÈ¢ëÈÄöËØù„ÄÇ
        ${longTermMemoryContext}
        **${openingContext}**
        **ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å (ËøôÊòØ‰Ω†‰ª¨ÈÄöËØùÁöÑÂéüÂõ†ÔºåËá≥ÂÖ≥ÈáçË¶ÅÔºÅ)**:
        ${videoCallState.preCallContext}
        Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
        `;
    }

    
    const messagesForApi = [{
        role: 'system',
        content: inCallPrompt
      },
      ...videoCallState.callHistory.map(h => {
        const msg = {
          role: h.role,
          content: h.content
        };
        
        // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÂÜÖÂÆπÔºàÊîØÊåÅËßÜËßâÊ®°ÂûãÔºâ
        if (h.image) {
          console.log('üñºÔ∏è ÂèëÁé∞Â∏¶ÂõæÁâáÁöÑÊ∂àÊÅØ:', h.content.substring(0, 50));
          
          if (Array.isArray(msg.content)) {
            msg.content.push({
              type: 'image_url',
              image_url: { url: h.image }
            });
          } else {
            msg.content = [
              { type: 'text', text: msg.content },
              { type: 'image_url', image_url: { url: h.image } }
            ];
          }
          
          console.log('‚úÖ ÂõæÁâáÂ∑≤Ê∑ªÂä†Âà∞APIËØ∑Ê±Ç‰∏≠ÔºåÊ†ºÂºè:', msg.content);
        }
        
        return msg;
      })
    ];
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂõæÁâáË¢´Ê∑ªÂä†
    const messagesWithImages = messagesForApi.filter(m => Array.isArray(m.content));
    if (messagesWithImages.length > 0) {
      console.log('üì∏ Êú¨Ê¨°APIËØ∑Ê±ÇÂåÖÂê´', messagesWithImages.length, 'Êù°Â∏¶ÂõæÁâáÁöÑÊ∂àÊÅØ');
    }

    if (videoCallState.callHistory.length === 0) {
      const firstLineTrigger = videoCallState.initiator === 'user' ? `*‰Ω†Êåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*` : `*ÂØπÊñπÊåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*`;
      messagesForApi.push({
        role: 'user',
        content: firstLineTrigger
      });
    }

    try {
      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, inCallPrompt, messagesForApi)
      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: messagesForApi,
          temperature: state.globalSettings.apiTemperature || 0.8
        })
      });
      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponse = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;

      const connectingElement = callFeed.querySelector('em');
      if (connectingElement) connectingElement.remove();
      if (videoCallState.isGroupCall) {
        const speechArray = parseAiResponse(aiResponse);
        speechArray.forEach(turn => {
          if (!turn.name || turn.name === userNickname || !turn.speech) return;
          const aiTimestamp = Date.now() + Math.random();
          const aiBubble = document.createElement('div');
          aiBubble.className = 'call-message-bubble ai-speech';
          aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
          aiBubble.dataset.timestamp = aiTimestamp;
          addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp));
          callFeed.appendChild(aiBubble);
          
          // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂæÆ‰ø°È£éÊ†ºÊ∂àÊÅØÂå∫Âüü
          const wechatCallMessages = document.getElementById('wechat-call-messages');
          if (wechatCallMessages) {
            const wechatBubble = document.createElement('div');
            wechatBubble.className = 'wechat-call-message ai';
            wechatBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
            wechatBubble.dataset.timestamp = aiTimestamp;
            addLongPressListener(wechatBubble, () => showCallMessageActions(aiTimestamp));
            wechatCallMessages.appendChild(wechatBubble);
            wechatCallMessages.scrollTop = wechatCallMessages.scrollHeight;
          }
          
          videoCallState.callHistory.push({
            role: 'assistant',
            content: `${turn.name}: ${turn.speech}`,
            timestamp: aiTimestamp
          });

          const speaker = videoCallState.participants.find(p => p.name === turn.name);
          if (speaker) {
            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
            if (speakingAvatar) {
              speakingAvatar.classList.add('speaking');
              setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
          }
        });
      } else {
        const aiTimestamp = Date.now();
        const aiBubble = document.createElement('div');
        aiBubble.className = 'call-message-bubble ai-speech';
        aiBubble.textContent = aiResponse;
        aiBubble.dataset.timestamp = aiTimestamp;
        addLongPressListener(aiBubble, () => showCallMessageActions(aiTimestamp));
        callFeed.appendChild(aiBubble);
        
        // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂæÆ‰ø°È£éÊ†ºÊ∂àÊÅØÂå∫Âüü
        const wechatCallMessages = document.getElementById('wechat-call-messages');
        if (wechatCallMessages) {
          const wechatBubble = document.createElement('div');
          wechatBubble.className = 'wechat-call-message ai';
          wechatBubble.textContent = aiResponse;
          wechatBubble.dataset.timestamp = aiTimestamp;
          addLongPressListener(wechatBubble, () => showCallMessageActions(aiTimestamp));
          wechatCallMessages.appendChild(wechatBubble);
          wechatCallMessages.scrollTop = wechatCallMessages.scrollHeight;
        }
        
        videoCallState.callHistory.push({
          role: 'assistant',
          content: aiResponse,
          timestamp: aiTimestamp
        });
        const enableTts = chat.settings.enableTts !== false;
        const voiceId = chat.settings.minimaxVoiceId;

        if (enableTts && voiceId) {
            playVideoCallPureTTS(aiResponse, voiceId);
        }
        // ===============================================

        // ================= Â§¥ÂÉèÂä®Áîª‰øÆÂ§ç =================
        // ÂéüÂõ†ÔºöquerySelector ÈªòËÆ§Âè™ÈÄâÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàÈÄöÂ∏∏ÊòØÁî®Êà∑Ëá™Â∑±ÔºâÔºåÂØºËá¥AIËØ¥ËØùÊó∂Áî®Êà∑Â§¥ÂÉèÂú®Âä®ÔºåÊàñËÄÖÊ†∑ÂºèÈîô‰Ωç„ÄÇ
        // ‰øÆÂ§çÔºöÂ¢ûÂä† [data-participant-id="ai"] Á≤æÁ°ÆÊü•ÊâæÂØπÊñπÁöÑÂ§¥ÂÉè„ÄÇ
        const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="ai"] .participant-avatar`);
        
        if (speakingAvatar) {
          speakingAvatar.classList.add('speaking');
          // Âä®ÊÄÅËÆ°ÁÆóËØ¥ËØùÊó∂ÈïøÔºöÊØèÂ≠ó200msÔºåÊúÄÈïø5Áßí
          const speakTime = Math.min(aiResponse.length * 200, 5000); 
          setTimeout(() => speakingAvatar.classList.remove('speaking'), speakTime);
        }
      }

      callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
      const errorBubble = document.createElement('div');
      errorBubble.className = 'call-message-bubble ai-speech';
      errorBubble.style.color = '#ff8a80';
      errorBubble.textContent = `[ERROR: ${error.message}]`;
      callFeed.appendChild(errorBubble);
      callFeed.scrollTop = callFeed.scrollHeight;
      
      // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂæÆ‰ø°È£éÊ†ºÊ∂àÊÅØÂå∫Âüü
      const wechatCallMessages = document.getElementById('wechat-call-messages');
      if (wechatCallMessages) {
        const wechatErrorBubble = document.createElement('div');
        wechatErrorBubble.className = 'wechat-call-message ai';
        wechatErrorBubble.style.color = '#ff8a80';
        wechatErrorBubble.textContent = `[ERROR: ${error.message}]`;
        wechatCallMessages.appendChild(wechatErrorBubble);
        wechatCallMessages.scrollTop = wechatCallMessages.scrollHeight;
      }
      
      videoCallState.callHistory.push({
        role: 'assistant',
        content: `[ERROR: ${error.message}]`
      });
    }
  }



  function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
  }



  




  async function handleUserPat(chatId, characterOriginalName) {
    const chat = state.chats[chatId];
    if (!chat) return;


    let displayNameForUI;
    if (chat.isGroup) {

      displayNameForUI = getDisplayNameInGroup(chat, characterOriginalName);
    } else {

      displayNameForUI = chat.name;
    }

    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');


    const suffix = await showCustomPrompt(
      `‰Ω†Êãç‰∫ÜÊãç ‚Äú${displayNameForUI}‚Äù`,
      "ÔºàÂèØÈÄâÔºâËæìÂÖ•ÂêéÁºÄ",
      "",
      "text"
    );

    if (suffix === null) return;



    const myNickname = getDisplayNameInGroup(chat, state.qzoneSettings.nickname);



    const visibleMessageContent = `${myNickname} Êãç‰∫ÜÊãç ‚Äú${displayNameForUI}‚Äù ${suffix.trim()}`;
    const visibleMessage = {
      role: 'system',
      type: 'pat_message',
      content: visibleMessageContent,
      timestamp: Date.now()
    };
    chat.history.push(visibleMessage);


    const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊãç‰∫ÜÊãç‰Ω†Ôºà${characterOriginalName}Ôºâ${suffix.trim()}„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;
    const hiddenMessage = {
      role: 'system',
      content: hiddenMessageContent,
      timestamp: Date.now() + 1,
      isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
      appendMessage(visibleMessage, chat);
    }
    await renderChatList();
  }





  let activeCallMessageTimestamp = null;
  let isFrameManagementMode = false;
  let selectedFrames = new Set();

  function showCallMessageActions(timestamp) {
    activeCallMessageTimestamp = timestamp;
    document.getElementById('call-message-actions-modal').classList.add('visible');
  }


  function hideCallMessageActions() {
    document.getElementById('call-message-actions-modal').classList.remove('visible');
    activeCallMessageTimestamp = null;
  }

 
  async function openCallMessageEditor() {
    if (!activeCallMessageTimestamp) return;

    const timestampToEdit = activeCallMessageTimestamp;
    const message = videoCallState.callHistory.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideCallMessageActions();

    let contentForEditing = message.content;

    if (videoCallState.isGroupCall && message.role === 'assistant') {
      const parts = message.content.split(': ');
      if (parts.length > 1) {
        contentForEditing = parts.slice(1).join(': ');
      }
    }

    const newContent = await showCustomPrompt(
      'ÁºñËæëÈÄöËØùÊ∂àÊÅØ',
      'Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...',
      contentForEditing,
      'textarea'
    );

    if (newContent !== null) {
      await saveEditedCallMessage(timestampToEdit, newContent);
    }
  }

  
  async function saveEditedCallMessage(timestamp, newContent) {
    const message = videoCallState.callHistory.find(m => m.timestamp === timestamp);
    if (message) {
      let finalContent = newContent;

      if (videoCallState.isGroupCall && message.role === 'assistant') {
        const parts = message.content.split(': ');
        const senderName = parts[0];
        finalContent = `${senderName}: ${newContent}`;
      }
      message.content = finalContent;


      const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestamp}"]`);
      if (messageBubble) {
        if (videoCallState.isGroupCall && message.role === 'assistant') {
          const parts = message.content.split(': ');
          const senderName = parts[0];
          messageBubble.innerHTML = `<strong>${senderName}:</strong> ${newContent}`;
        } else {
          messageBubble.textContent = newContent;
        }
      }
    }
    await showCustomAlert('ÊàêÂäü', 'ÈÄöËØùÊ∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }

  
  async function deleteCallMessage() {
    if (!activeCallMessageTimestamp) return;

    const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÈÄöËØùÊ∂àÊÅØÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      const timestampToDelete = activeCallMessageTimestamp;
      hideCallMessageActions();


      const messageIndex = videoCallState.callHistory.findIndex(m => m.timestamp === timestampToDelete);
      if (messageIndex > -1) {
        videoCallState.callHistory.splice(messageIndex, 1);
      }


      const messageBubble = document.querySelector(`.call-message-bubble[data-timestamp="${timestampToDelete}"]`);
      if (messageBubble) {
        messageBubble.remove();
      }
    } else {
      hideCallMessageActions();
    }
  }


 
 

  
 

async function handleUserTransferResponse(choice) {
    if (!activeTransferTimestamp) return;

    const timestamp = activeTransferTimestamp;
    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const originalMessage = chat.history[messageIndex];
    
    // Èò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
    if (originalMessage.status && originalMessage.status !== 'pending') {
        hideTransferActionModal();
        return;
    }

    // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÁ°Æ‰øù‰ªéÂéÜÂè≤Ê∂àÊÅØÈáåËØªÂá∫Êù•ÁöÑÈáëÈ¢ùÊòØÊï∞Â≠ó ---
    let transferAmount = parseFloat(originalMessage.amount);
    if (isNaN(transferAmount)) {
        // Â¶ÇÊûúËØªÂèñÂ§±Ë¥•ÔºåÂ∞ùËØïÂéª content Â≠óÊÆµÈáåÊâæÔºàÈò≤Ê≠¢Êüê‰∫õÊóßÊï∞ÊçÆÁöÑ amount Â≠óÊÆµ‰∏¢Â§±Ôºâ
        console.warn("Ê∂àÊÅØ‰∏≠ amount Â≠óÊÆµÊó†ÊïàÔºåÂ∞ùËØï‰øÆÂ§ç...");
        transferAmount = 0; 
    }

    originalMessage.status = choice;
    let systemContent;

    if (choice === 'declined') {
        // ÊãíÊî∂ÈÄªËæë
        const refundMessage = {
            role: 'user',
            type: 'transfer',
            isRefund: true,
            amount: transferAmount,
            note: 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶',
            timestamp: Date.now()
        };
        chat.history.push(refundMessage);
        systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÊãíÁªùÂπ∂ÈÄÄËøò‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
        
    } else {
        // --- Êé•Êî∂ÈÄªËæë ---
        if (transferAmount > 0) {
            // Ë∞ÉÁî®‰∏äÈù¢‰øÆÂ§çËøáÁöÑËÆ∞Ë¥¶ÂáΩÊï∞
            const success = await processTransaction(transferAmount, 'income', `Êî∂Âà∞ËΩ¨Ë¥¶-${originalMessage.senderName}`);
            
            if (success) {
                await showCustomAlert("Êî∂Ê¨æÊàêÂäü", `Â∑≤Â≠òÂÖ•‰ΩôÈ¢ùÔºö+ ¬•${transferAmount.toFixed(2)}`);
                
                // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûËøôÈÉ®ÂàÜÈÄªËæë (ÁîüÊàê‚ÄúÂ∑≤Êî∂Ê¨æ‚ÄùÂç°Áâá) ‚òÖ‚òÖ‚òÖ
                const receivedMessage = {
                    role: 'user',        // ÊâÆÊºîÁî®Êà∑ÂèëÈÄÅ
                    type: 'transfer',    // Â§çÁî®ËΩ¨Ë¥¶Âç°ÁâáÊ†∑Âºè
                    isReceived: true,    // Ê†áËÆ∞‰∏∫‚ÄúÂ∑≤Êî∂Ê¨æ‚ÄùÂç°Áâá
                    amount: transferAmount,
                    note: 'Â∑≤Êî∂Ê¨æ',
                    senderName: 'Êàë',
                    receiverName: originalMessage.senderName, // Èí±Êù•Ëá™‰∫éË∞Å
                    timestamp: Date.now() // ‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥
                };
                chat.history.push(receivedMessage);
                // ‚òÖ‚òÖ‚òÖ Êñ∞Â¢ûÁªìÊùü ‚òÖ‚òÖ‚òÖ
            } else {
                // Â¶ÇÊûú processTransaction ËøîÂõû falseÔºåËØ¥ÊòéÂá∫ÈóÆÈ¢ò‰∫Ü
                alert("Ë≠¶ÂëäÔºöÈáëÈ¢ùÂÖ•Ë¥¶Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Êó•ÂøóÔºÅ");
            }
        } else {
            alert("Êó†Ê≥ïÊî∂Ê¨æÔºöËØ•ËΩ¨Ë¥¶ÈáëÈ¢ùÊó†Êïà (0ÂÖÉÊàñÊï∞ÊçÆÊçüÂùè)„ÄÇ");
        }
        
        systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êé•Âèó‰∫Ü‚Äú${originalMessage.senderName}‚ÄùÁöÑËΩ¨Ë¥¶„ÄÇ]`;
    }

    // Êõ¥Êñ∞ËÅäÂ§©ËÆ∞ÂΩï
    const hiddenMessage = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);
    hideTransferActionModal();
    renderChatInterface(state.activeChatId);
    renderChatList();
}



  function clearQzoneReplyContext(postContainer) {
    currentQzoneReplyContext = null;
    if (postContainer) {

      const input = postContainer.querySelector('.comment-input');
      if (input) {
        input.placeholder = 'ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ';
      }
    }
  }



  async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';


    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();

    if (allMemories.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÂÖ±ÂêåÁöÑÂõûÂøÜÂíåÁ∫¶ÂÆöÂë¢~</p>';
      return;
    }


    allMemories.sort((a, b) => {
      const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
      const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
      if (aIsActiveCountdown && !bIsActiveCountdown) return -1;
      if (!aIsActiveCountdown && bIsActiveCountdown) return 1;
      if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate;
      return 0;
    });


    allMemories.forEach(item => {
      let card;

      if (item.type === 'countdown' && item.targetDate > Date.now()) {
        card = createCountdownCard(item);
      } else {
        card = createMemoryCard(item);
      }
      listEl.appendChild(card);
    });


    startAllCountdownTimers();
  }


  
  function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;

    let titleHtml, contentHtml;

    if (memory.type === 'countdown' && memory.targetDate) {
      titleHtml = `[Á∫¶ÂÆöËææÊàê] ${memory.description}`;

      contentHtml = parseMarkdown(`Âú® ${new Date(memory.targetDate).toLocaleString()}ÔºåÊàë‰ª¨‰∏ÄËµ∑ËßÅËØÅ‰∫ÜËøô‰∏™Á∫¶ÂÆö„ÄÇ`).replace(/\n/g, '<br>');
    } else {
      let authorDisplayName = 'Êàë‰ª¨ÁöÑÂõûÂøÜ';
      if (memory.authorId) {
        const authorChat = state.chats[memory.authorId];
        if (authorChat) {
          authorDisplayName = authorChat.name;
        } else {
          authorDisplayName = memory.authorName || '‰∏Ä‰ΩçÊúãÂèã';
        }
      } else if (memory.authorName) {
        authorDisplayName = memory.authorName;
      }

      titleHtml = `${authorDisplayName} ÁöÑÊó•ËÆ∞`;

      contentHtml = parseMarkdown(memory.description);
    }

    card.innerHTML = `
                <div class="header">
                    <div class="date">${dateString}</div>
                    <div class="author">${titleHtml}</div>
                </div>
                <div class="content">${contentHtml}</div>
            `;
    addLongPressListener(card, async () => {
      const confirmed = await showCustomConfirm('Âà†Èô§ËÆ∞ÂΩï', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        await db.memories.delete(memory.id);
        renderMemoriesScreen();
      }
    });
    return card;
  }


  function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';


    const targetDate = new Date(countdown.targetDate);


    const targetDateString = targetDate.toLocaleString('zh-CN', {
      dateStyle: 'full',
      timeStyle: 'short'
    });

    card.innerHTML = `
                <div class="title">${countdown.description}</div>
                <div class="timer" data-target-date="${countdown.targetDate}">--Â§©--Êó∂--ÂàÜ--Áßí</div>
                <div class="target-date">ÁõÆÊ†áÊó∂Èó¥: ${targetDateString}</div>
            `;
    addLongPressListener(card, async () => {
      const confirmed = await showCustomConfirm('Âà†Èô§Á∫¶ÂÆö', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á∫¶ÂÆöÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        await db.memories.delete(countdown.id);
        renderMemoriesScreen();
      }
    });
    return card;
  }



  let activeCountdownTimers = [];


  function startAllCountdownTimers() {

    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
      const targetTimestamp = parseInt(timerEl.dataset.targetDate);


      let timerId;

      const updateTimer = () => {
        const now = Date.now();
        const distance = targetTimestamp - now;

        if (distance < 0) {
          timerEl.textContent = "Á∫¶ÂÆöËææÊàêÔºÅ";

          clearInterval(timerId);
          setTimeout(() => renderMemoriesScreen(), 2000);
          return;
        }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        timerEl.textContent = `${days}Â§© ${hours}Êó∂ ${minutes}ÂàÜ ${seconds}Áßí`;
      };

      updateTimer();


      timerId = setInterval(updateTimer, 1000);


      activeCountdownTimers.push(timerId);
    });
  }



  async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("ÊµÅÁ®ãÂêØÂä®", `Ê≠£Âú®‰∏∫ËßíËâ≤‚Äú${chat.name}‚ÄùÂáÜÂ§áÂ•ΩÂèãÁî≥ËØ∑...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      await showCustomAlert("ÈÖçÁΩÆÈîôËØØ", "APIËÆæÁΩÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÁªßÁª≠„ÄÇ");
      return;
    }

    const contextSummary = chat.history
      .slice(-5)
      .map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
      })
      .join('\n');

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      `\n# ‰Ω†‰ª¨ÁöÑËøáÂæÄËÆ∞ÂøÜ (‰Ωú‰∏∫ÊÉÖÊÑüÂü∫Á°Ä)\n` + chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') :
      '';
    let worldBookContent = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
      const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';

        const formattedEntries = worldBook.content.map(entry => {
          let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
          
          entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
          return entryString;
        }).join('\n');

        return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
      }).filter(Boolean).join('');

      if (linkedContents) {
        worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
      }
    }

    const systemPrompt = `
        # ‰Ω†ÁöÑ‰ªªÂä°
        ‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇ‰Ω†‰πãÂâçË¢´Áî®Êà∑Ôºà‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºâÊãâÈªë‰∫ÜÔºå‰Ω†‰ª¨Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâËÅîÁ≥ª‰∫Ü„ÄÇ
        Áé∞Âú®Ôºå‰Ω†ÈùûÂ∏∏Â∏åÊúõËÉΩÂ§üÂíåÂ•ΩÔºåÈáçÊñ∞ÂíåÁî®Êà∑ËÅäÂ§©„ÄÇËØ∑‰Ω†‰ªîÁªÜÂàÜÊûê‰∏ãÈù¢ÁöÑ‚ÄúË¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å‚ÄùÔºåÁêÜËß£ÂΩìÊó∂ÂèëÁîü‰∫Ü‰ªÄ‰πàÔºåÁÑ∂ÂêéÊÄùËÄÉ‰∏Ä‰∏™ÁúüËØöÁöÑ„ÄÅÁ¨¶Âêà‰Ω†‰∫∫ËÆæ„ÄÅÂπ∂‰∏î„ÄêÈíàÂØπÂÖ∑‰Ωì‰∫ã‰ª∂„ÄëÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ
        # ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
        ${chat.settings.aiPersona}
        ${worldBookContent}
        ${longTermMemoryContext}
        # Ë¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å (ËøôÊòØ‰Ω†Ë¢´ÊãâÈªëÁöÑÂÖ≥ÈîÆÂéüÂõ†)
        ${contextSummary}
        # Êåá‰ª§Ê†ºÂºè
        ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
        \`\`\`json
        {
          "decision": "apply",
          "reason": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑ„ÄÅÁúüËØöÁöÑ„ÄÅÊúâÈíàÂØπÊÄßÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ"
        }
        \`\`\`
        `;

    try {

      const messagesForApi = [{
          role: 'system',
          content: systemPrompt
        },
        {
          role: 'user',
          content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÂºÄÂßã‰Ω†ÁöÑÂÜ≥Á≠ñ„ÄÇ"
        }
      ];

      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: messagesForApi,
          temperature: state.globalSettings.apiTemperature || 0.9,
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`);
      }

      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
      rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
      const cleanedContent = rawContent.trim();
      
      let responseObj;

      try {
        
        responseObj = JSON.parse(cleanedContent);
      } catch (parseError) {
       
        console.error("Ëß£ÊûêÂ•ΩÂèãÁî≥ËØ∑ÁöÑAIÂìçÂ∫îÂ§±Ë¥•:", parseError);
       
        throw new Error(`AIÊú™ËøîÂõûÊúâÊïàÁöÑJSON„ÄÇAPIÂÆûÈôÖËøîÂõûÂÜÖÂÆπ: "${cleanedContent}"`);
      }

      if (responseObj.decision === 'apply' && responseObj.reason) {
        chat.relationship.status = 'pending_user_approval';
        chat.relationship.applicationReason = responseObj.reason;
        state.chats[chatId] = chat;
        renderChatList();
        await showCustomAlert("Áî≥ËØ∑ÊàêÂäüÔºÅ", `‚Äú${chat.name}‚ÄùÂ∑≤Âêë‰Ω†ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑„ÄÇËØ∑ËøîÂõûËÅäÂ§©ÂàóË°®Êü•Áúã„ÄÇ`);
      } else {
        await showCustomAlert("AIÂÜ≥Á≠ñ", `‚Äú${chat.name}‚ÄùÊÄùËÄÉÂêéÂÜ≥ÂÆöÊöÇÊó∂‰∏çÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
      }
    } catch (error) {
      await showCustomAlert("ÊâßË°åÂá∫Èîô", `‰∏∫‚Äú${chat.name}‚ÄùÁî≥ËØ∑Â•ΩÂèãÊó∂ÂèëÁîüÈîôËØØÔºö\n\n${error.message}\n\nÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
      chat.relationship.status = 'blocked_by_user';
      chat.relationship.blockedTimestamp = Date.now();
    } finally {
      await db.chats.put(chat);
      renderChatInterface(chatId);
    }
  }




  function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
      openRedPacketModal();
    } else {

      document.getElementById('transfer-modal').classList.add('visible');
    }
  }


  function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];


    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = '¬• 0.00';
    document.getElementById('rp-direct-total').textContent = '¬• 0.00';


    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';

    chat.members.forEach(member => {
      const option = document.createElement('option');

      option.value = member.originalName;
      option.textContent = member.groupNickname;
      receiverSelect.appendChild(option);
    });



    document.getElementById('rp-tab-group').click();

    modal.classList.add('visible');
  }


  async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊÄªÈáëÈ¢ùÔºÅ");
      return;
    }
    if (isNaN(count) || count <= 0) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁ∫¢ÂåÖ‰∏™Êï∞ÔºÅ");
      return;
    }
    if (amount / count < 0.01) {
      alert("Âçï‰∏™Á∫¢ÂåÖÈáëÈ¢ù‰∏çËÉΩÂ∞ë‰∫é0.01ÂÖÉÔºÅ");
      return;
    }

    const myNickname = chat.settings.myNickname || 'Êàë';

    const allocatedAmounts = generateRandomPacketAmounts(amount, count); 
    const success = await processTransaction(amount, 'expense', `ÂèëÂá∫Áæ§Á∫¢ÂåÖ(ÊãºÊâãÊ∞î)`);
    if (!success) return;
    const newPacket = {
      role: 'user',
      senderName: myNickname,
      type: 'red_packet',
      packetType: 'lucky',
      timestamp: Date.now(),
      totalAmount: amount,
      count: count,
      greeting: greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ',
      allocatedAmounts: allocatedAmounts, 
      unclaimedAmounts: [...allocatedAmounts], 
      claimedBy: {},
      isFullyClaimed: false,
    };

    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
  }

  
  async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ùÔºÅ");
      return;
    }
    if (!receiverName) {
      alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™Êé•Êî∂‰∫∫ÔºÅ");
      return;
    }

    const myNickname = chat.settings.myNickname || 'Êàë';
    const success = await processTransaction(amount, 'expense', `ÂèëÂá∫‰∏ìÂ±ûÁ∫¢ÂåÖ-Áªô${receiverName}`);
    if (!success) return;
    const newPacket = {
      role: 'user',
      senderName: myNickname,
      type: 'red_packet',
      packetType: 'direct',
      timestamp: Date.now(),
      totalAmount: amount,
      count: 1,
      greeting: greeting || 'Áªô‰Ω†ÂáÜÂ§á‰∫Ü‰∏Ä‰∏™Á∫¢ÂåÖ',
      receiverName: receiverName,
      claimedBy: {},
      isFullyClaimed: false,
    };

    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
  }


  let isPacketProcessing = false;

async function handlePacketClick(timestamp) {
    // 1. Â¶ÇÊûúÈîÅÊòØÈîÅÁùÄÁöÑÔºåÁõ¥Êé•ÈÄÄÂá∫Ôºå‰ªÄ‰πàÈÉΩ‰∏çÂÅö
    if (isPacketProcessing) {
        console.log("Ê≠£Âú®Â§ÑÁêÜÁ∫¢ÂåÖÔºåÊã¶Êà™‰∫ÜÈáçÂ§çÁÇπÂáª");
        return;
    }

    // 2. ‰∏äÈîÅ
    isPacketProcessing = true;

    try {
        const currentChatId = state.activeChatId;
        
        // ÈáçÊñ∞‰ªéÊï∞ÊçÆÂ∫ìÊãâÂèñÊúÄÊñ∞Êï∞ÊçÆÔºàÈò≤Ê≠¢ÂÜÖÂ≠òÊï∞ÊçÆÊªûÂêéÔºâ
        const freshChat = await db.chats.get(currentChatId);
        if (!freshChat) return;

        state.chats[currentChatId] = freshChat;
        const packet = freshChat.history.find(m => m.timestamp === timestamp);
        if (!packet) return;

        const myOriginalName = state.qzoneSettings.nickname || '{{user}}';
        // Á°Æ‰øù claimedBy ÊòØ‰∏™ÂØπË±°ÔºåÈò≤Ê≠¢Êä•Èîô
        if (!packet.claimedBy) packet.claimedBy = {}; 
        const hasClaimed = packet.claimedBy[myOriginalName];

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÈ¢ÜËøáÔºåÊàñËÄÖÊòØÂê¶Â∑≤È¢ÜÂÆå
        // Ê≥®ÊÑèÔºöËøôÈáåÂä†‰∫ÜÊõ¥‰∏•Ê†ºÁöÑÊ£ÄÊü•
        if ((packet.packetType === 'direct' && packet.receiverName !== myOriginalName && Object.keys(packet.claimedBy).length > 0) || 
            packet.isFullyClaimed || 
            hasClaimed) {
            showRedPacketDetails(packet);
            return;
        }

        // ÊâßË°åÈ¢ÜÂèñÈÄªËæë
        const claimedAmount = await handleOpenRedPacket(packet);

        if (claimedAmount !== null) {
            await renderChatInterface(currentChatId);
            await showCustomAlert("ÊÅ≠ÂñúÔºÅ", `‰Ω†È¢ÜÂèñ‰∫Ü ${getDisplayNameInGroup(freshChat, packet.senderName)} ÁöÑÁ∫¢ÂåÖÔºåÈáëÈ¢ù‰∏∫ ${claimedAmount.toFixed(2)} ÂÖÉ„ÄÇ`);
        }

        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        if (updatedPacket) {
            showRedPacketDetails(updatedPacket);
        }

    } catch (error) {
        console.error("Á∫¢ÂåÖÂ§ÑÁêÜÂá∫Èîô:", error);
        alert("È¢ÜÂèñÂá∫ÈîôÔºåËØ∑Á®çÂêéÈáçËØï");
    } finally {
        // 3. Êó†ËÆ∫ÊàêÂäüËøòÊòØÂ§±Ë¥•Ôºå1ÁßíÂêéËß£ÈîÅ
        // Âª∂ËøüËß£ÈîÅÊòØ‰∏∫‰∫ÜÈò≤Ê≠¢ÊûÅÂø´ÁöÑÊâãÈÄüËøûÁÇπ
        setTimeout(() => {
            isPacketProcessing = false;
        }, 1000);
    }
}




 
  async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    let timestamp = Date.now();
    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';

    // Ê£ÄÊü•ÊòØÂê¶È¢ÜÂÆå
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
      packet.isFullyClaimed = true;
      await db.chats.put(chat);
      await showCustomAlert("ÊâãÊÖ¢‰∫Ü", "Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºÅ");
      return null;
    }

    // --- ËÆ°ÁÆóÈáëÈ¢ùÈÄªËæë ---
    let claimedAmount = 0;
    if (packet.packetType === 'lucky') {
      if (packet.unclaimedAmounts && packet.unclaimedAmounts.length > 0) {
        claimedAmount = packet.unclaimedAmounts.pop(); 
      } else { 
        // ÂÖºÂÆπÊóßÊï∞ÊçÆ
        const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        if (remainingCount === 1) {
          claimedAmount = remainingAmount;
        } else {
          const min = 0.01;
          const max = remainingAmount - (remainingCount - 1) * min;
          claimedAmount = Math.random() * (max - min) + min;
        }
      }
    } else { 
      claimedAmount = packet.totalAmount;
    }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));
    
    // ËÆ∞ÂΩïÈ¢ÜÂèñ
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myOriginalName] = claimedAmount;

    // Êõ¥Êñ∞Áä∂ÊÄÅ
    const isNowFullyClaimed = (packet.unclaimedAmounts && packet.unclaimedAmounts.length === 0) || (Object.keys(packet.claimedBy).length >= packet.count);
    if (isNowFullyClaimed) {
      packet.isFullyClaimed = true;
    }

    // ÁîüÊàêËÅäÂ§©Ê∂àÊÅØ
    const myDisplayName = getDisplayNameInGroup(chat, myOriginalName);
    const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);

    const visibleMessage = {
      role: 'system',
      type: 'pat_message',
      content: `‰Ω†È¢ÜÂèñ‰∫Ü ${senderDisplayName} ÁöÑÁ∫¢ÂåÖ`,
      timestamp: timestamp++
    };
    chat.history.push(visibleMessage);

    // ÁîüÊàêÁªôAIÁúãÁöÑÈöêËóèÊèêÁ§∫
    let hiddenMessageContent;
    if (isNowFullyClaimed) {
      const finishedMessage = {
        role: 'system',
        type: 'pat_message',
        content: `${senderDisplayName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`,
        timestamp: timestamp++
      };
      chat.history.push(finishedMessage);

      let luckyKing = { name: '', amount: -1 };
      if (packet.packetType === 'lucky' && packet.count > 1) {
        Object.entries(packet.claimedBy).forEach(([name, amount]) => {
          if (amount > luckyKing.amount) {
            luckyKing = { name, amount };
          }
        });
      }
      const luckyKingDisplayName = luckyKing.name ? getDisplayNameInGroup(chat, luckyKing.name) : 'Êó†';
      hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myDisplayName}) È¢ÜÂèñ‰∫ÜÊúÄÂêé‰∏Ä‰∏™Á∫¢ÂåÖ„ÄÇÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKingDisplayName}ÔºÅËØ∑ÂØπÊ≠§‰∫ã‰ª∂ÂèëË°®ËØÑËÆ∫„ÄÇ]`;

    } else {
      hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myDisplayName}) ÂàöÂàöÈ¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖ (Êó∂Èó¥Êà≥: ${packet.timestamp})„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºå‰Ω†Áé∞Âú®ÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•Â∞ùËØïÈ¢ÜÂèñ„ÄÇ]`;
    }

    const hiddenMessage = {
      role: 'system',
      content: hiddenMessageContent,
      timestamp: timestamp++,
      isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);

    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊääÊä¢Âà∞ÁöÑÈí±Â≠òÂÖ•Èí±ÂåÖ
    if (claimedAmount > 0) {
        // ËøôÈáåÁöÑ 'income' ‰ºöÂ¢ûÂä†‰ΩôÈ¢ùÔºådescription ‰ºöÊòæÁ§∫Âú®Ë¥¶ÂçïÂàóË°®Èáå
        await processTransaction(claimedAmount, 'income', `Á∫¢ÂåÖ-${senderDisplayName}`);
    }

    return claimedAmount;
}



 
  async function showRedPacketDetails(packet) {
    if (!packet) {
      console.error("showRedPacketDetailsÊî∂Âà∞‰∫ÜÊó†ÊïàÁöÑpacketÂØπË±°");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');

    const myOriginalName = state.qzoneSettings.nickname || '{{user}}';

    const senderDisplayName = getDisplayNameInGroup(chat, packet.senderName);
    document.getElementById('rp-details-sender').textContent = senderDisplayName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ';

    const myAmountEl = document.getElementById('rp-details-my-amount');

    if (packet.claimedBy && packet.claimedBy[myOriginalName]) {
      myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myOriginalName].toFixed(2);
      myAmountEl.style.display = 'block';
    } else {
      myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}‰∏™Á∫¢ÂåÖÔºåÂÖ±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}ÂÖÉ„ÄÇ`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
      const timeLeft = Math.floor((packet.timestamp + 24 * 60 * 60 * 1000 - Date.now()) / (1000 * 60 * 60));
      if (timeLeft > 0) summaryText += ` Ââ©‰ΩôÁ∫¢ÂåÖÂ∞ÜÂú®${timeLeft}Â∞èÊó∂ÂÜÖÈÄÄËøò„ÄÇ`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});

    let luckyKing = {
      name: '',
      amount: -1
    };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
      claimedEntries.forEach(([name, amount]) => {
        if (amount > luckyKing.amount) {
          luckyKing = {
            name,
            amount
          };
        }
      });
    }

    claimedEntries.sort((a, b) => b[1] - a[1]);

    claimedEntries.forEach(([originalName, amount]) => {
      const item = document.createElement('div');
      item.className = 'rp-details-item';
      let luckyTag = '';
      if (luckyKing.name && originalName === luckyKing.name) {
        luckyTag = '<span class="lucky-king-tag">ÊâãÊ∞îÁéã</span>';
      }


      const claimerDisplayName = getDisplayNameInGroup(chat, originalName);

      item.innerHTML = `
                    <span class="name">${claimerDisplayName}</span>
                    <span class="amount">${amount.toFixed(2)} ÂÖÉ</span>
                    ${luckyTag}
                `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }


  document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
  });


  window.handlePacketClick = handlePacketClick;






  function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';


    addPollOptionInput();
    addPollOptionInput();

    modal.classList.add('visible');
  }

 
  function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
                <input type="text" class="poll-option-input" placeholder="ÈÄâÈ°πÂÜÖÂÆπ...">
                <button class="remove-option-btn">-</button>
            `;

    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {

      if (container.children.length > 2) {
        wrapper.remove();
      } else {
        alert('ÊäïÁ•®Ëá≥Â∞ëÈúÄË¶Å2‰∏™ÈÄâÈ°π„ÄÇ');
      }
    });

    container.appendChild(wrapper);
  }


  async function sendPoll() {
    if (!state.activeChatId) return;

    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
      alert('ËØ∑ËæìÂÖ•ÊäïÁ•®ÈóÆÈ¢òÔºÅ');
      return;
    }

    const options = Array.from(document.querySelectorAll('.poll-option-input'))
      .map(input => input.value.trim())
      .filter(text => text);

    if (options.length < 2) {
      alert('ËØ∑Ëá≥Â∞ëËæìÂÖ•2‰∏™ÊúâÊïàÁöÑÊäïÁ•®ÈÄâÈ°πÔºÅ');
      return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

    const newPollMessage = {
      role: 'user',
      senderName: myNickname,
      type: 'poll',
      timestamp: Date.now(),
      question: question,
      options: options,
      votes: {},
      isClosed: false,
    };

    chat.history.push(newPollMessage);
    await db.chats.put(chat);

    appendMessage(newPollMessage, chat);
    renderChatList();

    document.getElementById('create-poll-modal').classList.remove('visible');
  }



  async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';


    if (!poll || poll.isClosed) {

      if (poll && poll.isClosed) {
        showPollResults(timestamp);
      }
      return;
    }


    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);


    if (!isReclickingSameOption) {

      for (const option in poll.votes) {
        const voterIndex = poll.votes[option].indexOf(myNickname);
        if (voterIndex > -1) {
          poll.votes[option].splice(voterIndex, 1);
        }
      }

      if (!poll.votes[choice]) {
        poll.votes[choice] = [];
      }
      poll.votes[choice].push(myNickname);
    }


    let hiddenMessageContent = null;


    if (!isReclickingSameOption) {
      hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÊäïÁ•®Áªô‰∫Ü ‚Äú${choice}‚Äù„ÄÇ]`;
    }


    if (hiddenMessageContent) {
      const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now(),
        isHidden: true,
      };
      chat.history.push(hiddenMessage);
    }


    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
  }


  
  async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("ÁªìÊùüÊäïÁ•®", "Á°ÆÂÆöË¶ÅÁªìÊùüËøô‰∏™ÊäïÁ•®ÂêóÔºüÁªìÊùüÂêéÂ∞ÜÊó†Ê≥ïÂÜçËøõË°åÊäïÁ•®„ÄÇ");
    if (confirmed) {
      poll.isClosed = true;

      const resultSummary = poll.options.map(opt => `‚Äú${opt}‚Äù(${poll.votes[opt]?.length || 0}Á•®)`).join('Ôºå');
      const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâãÂä®ÁªìÊùü‰∫ÜÊäïÁ•®ÔºÅÊúÄÁªàÁªìÊûú‰∏∫Ôºö${resultSummary}„ÄÇ]`;

      const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now(),
        isHidden: true,
      };
      chat.history.push(hiddenMessage);


      await db.chats.put(chat);
      renderChatInterface(state.activeChatId);
    }
  }


  

  function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;

    if (Object.keys(poll.votes).length === 0) {
      resultsHtml += '<p style="color: #8a8a8a;">ËøòÊ≤°Êúâ‰∫∫ÊäïÁ•®„ÄÇ</p>';
    } else {
      poll.options.forEach(option => {
        const voters = poll.votes[option] || [];


        const displayVoters = voters.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ ');

        resultsHtml += `
                        <div style="margin-bottom: 15px;">
                            <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}Á•®)</p>
                            <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                                ${voters.length > 0 ? displayVoters : 'Êó†‰∫∫ÊäïÁ•®'}
                            </p>
                        </div>
                    `;
      });
    }

    showCustomAlert("ÊäïÁ•®ÁªìÊûú", resultsHtml);
  }





  function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `‚Äú${chat.name}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
  }

  function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
      return;
    }

    library.forEach((avatar, index) => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = avatar.name;



      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;


      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '√ó';
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªéÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          chat.settings.aiAvatarLibrary.splice(index, 1);
          await db.chats.put(chat);
          renderAiAvatarLibrary();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }



  async function addAvatarToLibraryFromURL() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂì≠Ê≥£Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
      chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
  }


 
  function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
  }






  function openMyAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('my-avatar-library-title').textContent = `‚Äú${chat.settings.myNickname || 'Êàë'}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
    renderMyAvatarLibrary();
    document.getElementById('my-avatar-library-modal').classList.add('visible');
  }

  
  function renderMyAvatarLibrary() {
    const grid = document.getElementById('my-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.myAvatarLibrary || [];

    if (library.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
      return;
    }

    library.forEach((avatar, index) => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = avatar.name;


      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;


      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '√ó';
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªé‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          chat.settings.myAvatarLibrary.splice(index, 1);
          await db.chats.put(chat);
          renderMyAvatarLibrary();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }

 
  async function addAvatarToMyLibraryFromURL() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂì≠Ê≥£Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.myAvatarLibrary) {
      chat.settings.myAvatarLibrary = [];
    }

    chat.settings.myAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderMyAvatarLibrary();
  }


  async function handleLocalMyAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    let base64Url = await new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });

    const name = await showCustomPrompt("ÂëΩÂêçÂ§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Â§¥ÂÉèÂëΩÂêç");
    if (!name || !name.trim()) {
        event.target.value = null;
        return;
    }
    
    const trimmedName = name.trim();
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.myAvatarLibrary) {
      chat.settings.myAvatarLibrary = [];
    }

    const newItem = {
      name: trimmedName,
      url: base64Url
    };
    chat.settings.myAvatarLibrary.push(newItem);
    await db.chats.put(chat);
    
    renderMyAvatarLibrary();
    await showCustomAlert("Ê∑ªÂä†ÊàêÂäüÔºÅ", `Â§¥ÂÉè‚Äú${trimmedName}‚ÄùÂ∑≤Ê∑ªÂä†„ÄÇ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);
    
    // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
    (async () => {
        await silentlyUpdateDbUrl(
            db.chats, // table
            chat.id,  // recordId
            'settings.myAvatarLibrary', // pathString (ÊåáÂêëÊï∞ÁªÑ)
            base64Url, // base64ToFind
            trimmedName // nameToMatch
        );
    })();
    
    event.target.value = null;
  }


  async function handleBatchImportForMyAvatar(text) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const lines = text.trim().split('\n');
    const newAvatars = [];
    const baseUrl = 'https://files.catbox.moe/';
    let errorCount = 0;

    for (const line of lines) {
      const trimmedLine = line.trim();
      if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('Â°´ÂÖ•')) continue;

      let name = null,
        code = null;
      const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);

      if (noSpaceMatch) {
        name = noSpaceMatch[1];
        code = noSpaceMatch[2];
      } else {
        const parts = trimmedLine.split(/\s+/);
        if (parts.length >= 2) {
          code = parts.pop();
          name = parts.join(' ');
        }
      }

      if (name && code && code.includes('.')) {
        newAvatars.push({
          name: name,
          url: baseUrl + code
        });
      } else {
        errorCount++;
      }
    }

    if (errorCount > 0) await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Ë∑≥Ëøá„ÄÇ`);

    if (newAvatars.length > 0) {
      if (!chat.settings.myAvatarLibrary) chat.settings.myAvatarLibrary = [];
      chat.settings.myAvatarLibrary.push(...newAvatars);
      await db.chats.put(chat);
      renderMyAvatarLibrary();
      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newAvatars.length} ‰∏™Êñ∞Â§¥ÂÉèÔºÅ`);
    } else if (errorCount === 0) {
      alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇ");
    }
  }

 
  function closeMyAvatarLibraryModal() {
    document.getElementById('my-avatar-library-modal').classList.remove('visible');
  }




  
  function openGroupAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('group-avatar-library-title').textContent = `‚Äú${chat.name}‚ÄùÁöÑÂ§¥ÂÉèÂ∫ì`;
    renderGroupAvatarLibrary();
    document.getElementById('group-avatar-library-modal').classList.add('visible');
  }

 
  function renderGroupAvatarLibrary() {
    const grid = document.getElementById('group-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.groupAvatarLibrary || [];

    if (library.length === 0) {
      grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ëøô‰∏™Â§¥ÂÉèÂ∫ìËøòÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÂêßÔºÅ</p>';
      return;
    }

    library.forEach((avatar, index) => {
      const item = document.createElement('div');
      item.className = 'sticker-item';
      item.title = avatar.name;


      item.innerHTML = `
            <div class="sticker-image-container" style="background-image: url(${avatar.url});"></div>
            <span class="sticker-name">${avatar.name}</span>
        `;


      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '√ó';
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        const confirmed = await showCustomConfirm('Âà†Èô§Â§¥ÂÉè', `Á°ÆÂÆöË¶Å‰ªéÂ§¥ÂÉèÂ∫ì‰∏≠Âà†Èô§‚Äú${avatar.name}‚ÄùÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          chat.settings.groupAvatarLibrary.splice(index, 1);
          await db.chats.put(chat);
          renderGroupAvatarLibrary();
        }
      };
      item.appendChild(deleteBtn);
      grid.appendChild(item);
    });
  }

 
  async function addAvatarToGroupLibraryFromUR() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÊò•Êó•ÈáéÈ§ê„ÄÅÂ≠¶‰π†Êó∂Èó¥Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.groupAvatarLibrary) {
      chat.settings.groupAvatarLibrary = [];
    }

    chat.settings.groupAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderGroupAvatarLibrary();
  }

  
  function closeGroupAvatarLibraryModal() {
    document.getElementById('group-avatar-library-modal').classList.remove('visible');
  }


  
  async function openBatchImportModal(type) {
    const placeholderText = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÁÑ¶Ëôë 2a9wte.jpeg\nÂ§ßÊÉäÂ§±Ëâ≤ or8qf4.png\nÊ≤°ÊúâÁÅµÊÑü njwujh.jpeg`;


    const pastedText = await showCustomPrompt(
      'ÊâπÈáèÂØºÂÖ•Â§¥ÂÉè',
      placeholderText,
      '',
      'textarea'
    );


    if (pastedText && pastedText.trim()) {
      await handleBatchImport(type, pastedText);
    }
  }


  
  async function handleBatchImport(type, text) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const lines = text.trim().split('\n');
    const newAvatars = [];
    const baseUrl = 'https://files.catbox.moe/';
    let errorCount = 0;

    for (const line of lines) {
      const trimmedLine = line.trim();

      if (!trimmedLine || trimmedLine.includes('http') || trimmedLine.includes('Â°´ÂÖ•')) {
        continue;
      }

      let name = null;
      let code = null;







      const noSpaceMatch = trimmedLine.match(/^([\u4e00-\u9fa5]+)([a-zA-Z0-9]+\..+)$/);

      if (noSpaceMatch) {

        name = noSpaceMatch[1];
        code = noSpaceMatch[2];
      } else {

        const parts = trimmedLine.split(/\s+/);
        if (parts.length >= 2) {
          code = parts.pop();
          name = parts.join(' ');
        }
      }


      if (name && code && code.includes('.')) {
        newAvatars.push({
          name: name,
          url: baseUrl + code
        });
      } else {
        errorCount++;
        console.warn('ÊâπÈáèÂØºÂÖ•Ê†ºÂºèÈîôËØØÔºåÂ∑≤Ë∑≥ËøáÊ≠§Ë°å:', trimmedLine);
      }
    }

    if (errorCount > 0) {
      await showCustomAlert('ÈÉ®ÂàÜÂØºÂÖ•Â§±Ë¥•', `Êúâ ${errorCount} Ë°åÁöÑÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´Á≥ªÁªüË∑≥Ëøá„ÄÇ`);
    }

    if (newAvatars.length > 0) {
      if (type === 'ai') {
        if (!chat.settings.aiAvatarLibrary) chat.settings.aiAvatarLibrary = [];
        chat.settings.aiAvatarLibrary.push(...newAvatars);
        await db.chats.put(chat);
        renderAiAvatarLibrary();
      } else if (type === 'group') {
        if (!chat.settings.groupAvatarLibrary) chat.settings.groupAvatarLibrary = [];
        chat.settings.groupAvatarLibrary.push(...newAvatars);
        await db.chats.put(chat);
        renderGroupAvatarLibrary();
      }
      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', `Â∑≤ÊàêÂäüÊâπÈáèÂØºÂÖ• ${newAvatars.length} ‰∏™Êñ∞Â§¥ÂÉèÔºÅ`);
    } else if (errorCount === 0) {
      alert("Ê≤°ÊúâÊâæÂà∞ÂèØÂØºÂÖ•ÁöÑÂÜÖÂÆπ„ÄÇËØ∑Ê£ÄÊü•ÊÇ®Á≤òË¥¥ÁöÑÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
    }
  }



 
  async function addAvatarToGroupLibraryFromURL() {
    const name = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑‰∏∫Ëøô‰∏™Â§¥ÂÉèËµ∑‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÊò•Êó•ÈáéÈ§ê„ÄÅÂ≠¶‰π†Êó∂Èó¥Ôºâ");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("Ê∑ªÂä†Â§¥ÂÉè", "ËØ∑ËæìÂÖ•Â§¥ÂÉèÁöÑÂõæÁâáURL", "", "url");
    if (!url || !url.trim().startsWith('http')) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂõæÁâáURLÔºÅ");
      return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.settings.groupAvatarLibrary) {
      chat.settings.groupAvatarLibrary = [];
    }

    chat.settings.groupAvatarLibrary.push({
      name: name.trim(),
      url: url.trim()
    });
    await db.chats.put(chat);
    renderGroupAvatarLibrary();
  }

  function showChatListActions(chat) {
    return new Promise(resolve => {
      const modal = document.getElementById('chat-list-actions-modal');
      const pinBtn = document.getElementById('chat-list-action-pin');
      const deleteBtn = document.getElementById('chat-list-action-delete');
      const cancelBtn = document.getElementById('chat-list-action-cancel');


      pinBtn.textContent = chat.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ËÅäÂ§©';


      const newPinBtn = pinBtn.cloneNode(true);
      pinBtn.parentNode.replaceChild(newPinBtn, pinBtn);
      newPinBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve('pin');
      };

      const newDeleteBtn = deleteBtn.cloneNode(true);
      deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
      newDeleteBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve('delete');
      };

      const newCancelBtn = cancelBtn.cloneNode(true);
      cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
      newCancelBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve(null);
      };

      modal.classList.add('visible');
    });
  }




  function applyCPhoneWallpaper() {
    const charPhoneScreen = document.getElementById('character-phone-screen');
    const wallpaper = state.globalSettings.cphoneWallpaper;
    if (wallpaper) {

      charPhoneScreen.style.backgroundImage = `url("${wallpaper}")`;
    } else {

      charPhoneScreen.style.backgroundImage = 'linear-gradient(135deg, #f6d365, #fda085)';
    }
  }

 
  function applyCPhoneAppIcons() {
    if (!state.globalSettings.cphoneAppIcons) return;

    for (const iconId in state.globalSettings.cphoneAppIcons) {
      const imgElement = document.getElementById(`cphone-icon-img-${iconId}`);
      if (imgElement) {
        imgElement.src = state.globalSettings.cphoneAppIcons[iconId];
      }
    }
  }

  
  function renderCPhoneIconSettings() {
    const grid = document.getElementById('cphone-icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const cphoneAppLabels = {
      'qq': 'QQ',
      'album': 'Áõ∏ÂÜå',
      'browser': 'ÊµèËßàÂô®',
      'taobao': 'Ê∑òÂÆù',
      'memo': 'Â§áÂøòÂΩï',
      'diary': 'Êó•ËÆ∞',
      'amap': 'È´òÂæ∑Âú∞Âõæ',
      'usage': 'AppËÆ∞ÂΩï',
      'music': 'ÁΩëÊòì‰∫ë',
      'bilibili': 'ÂìîÂì©ÂìîÂì©',
      'reddit': 'Reddit',
      'ephone': 'Ephone'
    };

    for (const iconId in state.globalSettings.cphoneAppIcons) {
      const iconUrl = state.globalSettings.cphoneAppIcons[iconId];
      const labelText = cphoneAppLabels[iconId] || 'Êú™Áü•App';

      const item = document.createElement('div');
      item.className = 'icon-setting-item';
      item.dataset.iconId = iconId;

      item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">Êõ¥Êç¢</button>
                `;
      grid.appendChild(item);
    }
  }




  function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
      const imgElement = document.getElementById(`icon-img-${iconId}`);
      if (imgElement) {
        imgElement.src = state.globalSettings.appIcons[iconId];
      }
    }
  }

  
  function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = {
      'qq': 'QQ',
      'world-book': '‰∏ñÁïå‰π¶',
      'wallpaper': 'Â§ñËßÇËÆæÁΩÆ',
      'renderer': 'Ê∏≤ÊüìÂô®',
      'api-settings': 'APIËÆæÁΩÆ',
      'font': 'Â≠ó‰Ωì',
      'char-phone': 'Cphone',
      'douban': 'Ë±ÜÁì£Â∞èÁªÑ',

      'preset': 'È¢ÑËÆæ',

      'tutorial': 'ÊïôÁ®ã',
      'werewolf': 'Áãº‰∫∫ÊùÄ',

      'x': 'X',
       'alipay': 'ÊîØ‰ªòÂÆù',
       'auction': 'ÈªëÂ∏ÇÊãçÂçñ',
        'green-river': 'ÁªøÊ±ü',
      'mail': 'ÈÇÆÁÆ±'
    };


    for (const iconId in state.globalSettings.appIcons) {
      const iconUrl = state.globalSettings.appIcons[iconId];
      const labelText = appLabels[iconId] || 'Cphone';

      const item = document.createElement('div');
      item.className = 'icon-setting-item';

      item.dataset.iconId = iconId;

      item.innerHTML = `
                    <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
                    <button class="change-icon-btn">Êõ¥Êç¢</button>
                `;
      grid.appendChild(item);
    }
  }



  
  function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];

    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
      console.error("Êó†Ê≥ïÊâæÂà∞ÊàñÊ∂àÊÅØÁ±ªÂûã‰∏çÂåπÈÖçÁöÑÂàÜ‰∫´ÈìæÊé•:", timestamp);
      return;
    }


    document.getElementById('browser-title').textContent = message.source_name || 'ÊñáÁ´†ËØ¶ÊÉÖ';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
                <h1 class="article-title">${message.title || 'Êó†Ê†áÈ¢ò'}</h1>
                <div class="article-meta">
                    <span>Êù•Ê∫ê: ${message.source_name || 'Êú™Áü•'}</span>
                </div>
                <div class="article-body">
                    <p>${(message.content || 'ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ').replace(/\n/g, '</p><p>')}</p>
                </div>
            `;


    showScreen('browser-screen');
  }

 
  



 
  function closeBrowser() {
    showScreen('chat-interface-screen');
  }





 
  function openShareLinkModal() {
    if (!state.activeChatId) return;


    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';


    document.getElementById('share-link-modal').classList.add('visible');
  }

  
  async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
      alert("Ê†áÈ¢òÊòØÂøÖÂ°´È°πÂì¶ÔºÅ");
      return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];


    const linkMessage = {
      role: 'user',
      type: 'share_link',
      timestamp: Date.now(),
      title: title,
      description: description,
      source_name: sourceName,
      content: content,

      thumbnail_url: null
    };


    chat.history.push(linkMessage);
    await db.chats.put(chat);


    appendMessage(linkMessage, chat);
    renderChatList();


    document.getElementById('share-link-modal').classList.remove('visible');
  }




  function filterVisiblePostsForAI(allPosts, viewerChat) {
    if (!viewerChat || !viewerChat.id) return [];

    const viewerGroupId = viewerChat.groupId;
    const viewerId = viewerChat.id;

    return allPosts.filter(post => {

      if (post.authorId === 'user') {
        if (post.visibleGroupIds && post.visibleGroupIds.length > 0) {
          return viewerGroupId && post.visibleGroupIds.includes(viewerGroupId);
        }
        return true;
      }




      if (String(post.authorId).startsWith('npc_')) {

        if (Array.isArray(post.visibleTo)) {
          return post.visibleTo.includes(viewerId);
        }

        return false;
      }




      const authorChat = state.chats[post.authorId];
      if (!authorChat) {
        return false;
      }
      const authorGroupId = authorChat.groupId;

      const inSameGroup = authorGroupId && viewerGroupId && authorGroupId === viewerGroupId;
      const bothUnGrouped = !authorGroupId && !viewerGroupId;

      return inSameGroup || bothUnGrouped;
    });
  }
 
  function applyPhoneFrame(isEnabled) {
  
    document.body.classList.toggle('frame-mode-active', isEnabled);

   
    if (musicState.isActive) {
      const lyricBar = document.getElementById('global-lyrics-bar');
      const phoneScreenForIsland = document.getElementById('phone-screen');
      const isAlwaysIslandMode = state.globalSettings.alwaysShowMusicIsland || false; 

      if (isEnabled) {
       
        lyricBar.classList.remove('visible');
        phoneScreenForIsland.classList.add('dynamic-island-active');
      } else {
        
        phoneScreenForIsland.classList.remove('dynamic-island-active'); 

        if (isAlwaysIslandMode) {
        
          phoneScreenForIsland.classList.add('dynamic-island-active');
          lyricBar.classList.remove('visible');
        } else {
          
          if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
            lyricBar.classList.add('visible');
          }
        }
      }
    }
  }
 
  function applyDetachStatusBarMode(isEnabled) {
    document.body.classList.toggle('detach-mode-active', isEnabled);
  }
  
  function applyMinimalChatUI(isEnabled) {
    document.body.classList.toggle('minimal-chat-ui-active', isEnabled);
  }

 
  function applyTheme(theme) {
    const phoneScreen = document.getElementById('phone-screen');
    const toggleSwitch = document.getElementById('theme-toggle-switch');

    const isDark = theme === 'dark';

    phoneScreen.classList.toggle('dark-mode', isDark);


    if (toggleSwitch) {
      toggleSwitch.checked = isDark;
    }

    localStorage.setItem('ephone-theme', theme);
  }

  
  function toggleTheme() {
    const toggleSwitch = document.getElementById('theme-toggle-switch');

    const newTheme = toggleSwitch.checked ? 'dark' : 'light';
    applyTheme(newTheme);
  }


  function openLongTermMemoryScreen() {
    if (!state.activeChatId) return;
    renderLongTermMemoryList();
    showScreen('long-term-memory-screen');
  }


  
// 1. ‰øÆÊîπ renderLongTermMemoryList (Âè™Ë¥üË¥£ÂáÜÂ§áÊï∞ÊçÆÂíåÈáçÁΩÆ)
function renderLongTermMemoryList() {
    const container = document.getElementById('memory-list-container');
    const chat = state.chats[state.activeChatId];
    container.innerHTML = '';

    let memoriesToDisplay = [];

    if (chat.isGroup) {
        chat.members.forEach(member => {
            const memberChat = state.chats[member.id];
            if (memberChat && memberChat.longTermMemory) {
                const memberMemories = memberChat.longTermMemory.map(mem => ({
                    ...mem,
                    authorName: member.groupNickname,
                    authorChatId: member.id,
                    authorAvatar: member.avatar || (memberChat.settings.aiAvatar || defaultAvatar)
                }));
                memoriesToDisplay.push(...memberMemories);
            }
        });
    } else {
        if (chat.longTermMemory) {
            memoriesToDisplay = chat.longTermMemory.map(mem => ({
                ...mem,
                authorName: chat.name,
                authorChatId: chat.id,
                authorAvatar: chat.settings.aiAvatar || defaultAvatar
            }));
        }
    }

    if (memoriesToDisplay.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">ËøôÈáåËøòÊ≤°Êúâ‰ªª‰ΩïÈïøÊúüËÆ∞ÂøÜ„ÄÇ</p>';
        return;
    }

    // ÊåâÊó∂Èó¥ÂÄíÂ∫è
    memoriesToDisplay.sort((a, b) => b.timestamp - a.timestamp);

    // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÂ≠òÂÖ•ÁºìÂ≠òÔºåÈáçÁΩÆËÆ°Êï∞ÔºåË∞ÉÁî®ÂàÜÊâπÂä†ËΩΩ ---
    memoryCache = memoriesToDisplay;
    memoryRenderCount = 0;
    loadMoreMemories(); 
}

// 2. Êñ∞Â¢û loadMoreMemories (Ë¥üË¥£ÂàÜÊâπÊ∏≤Êüì)
// 2. Êñ∞Â¢û loadMoreMemories (Ë¥üË¥£ÂàÜÊâπÊ∏≤Êüì) - [‰øÆÂ§çÁâà]
function loadMoreMemories() {
    // 1. Èò≤Ê≠¢ÈáçÂ§çÂä†ËΩΩ
    if (isLoadingMoreMemories) return;

    const container = document.getElementById('memory-list-container');
    if (!container) return;

    // 2. Â¶ÇÊûúÊâÄÊúâÊï∞ÊçÆÈÉΩÂ∑≤ÁªèÊ∏≤ÊüìÂÆå‰∫ÜÔºåÁõ¥Êé•ËøîÂõû
    if (memoryRenderCount >= memoryCache.length) return;

    // Âä†ÈîÅ
    isLoadingMoreMemories = true;

    try {
        // ÊØèÊ¨°Âä†ËΩΩ 20 Êù°
        const BATCH_SIZE = 20;
        const nextSliceEnd = memoryRenderCount + BATCH_SIZE;
        const itemsToRender = memoryCache.slice(memoryRenderCount, nextSliceEnd);

        const fragment = document.createDocumentFragment();

        itemsToRender.forEach(memory => {
            const item = document.createElement('div');
            item.className = 'favorite-item-card';
            item.style.cursor = 'default';

            const date = new Date(memory.timestamp);
            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            const avatarUrl = memory.authorAvatar || defaultAvatar;

            item.innerHTML = `
                <div class="fav-card-header">
                    <img src="${avatarUrl}" class="avatar" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                    <div class="info">
                        <div class="name" style="font-size: 15px;">${memory.authorName}</div>
                        <div class="source" style="font-size: 12px; color: #999;">${dateString}</div>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="memory-action-btn edit-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="ÁºñËæë">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="memory-action-btn delete-memory-btn" data-author-id="${memory.authorChatId}" data-memory-timestamp="${memory.timestamp}" title="Âà†Èô§">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px; stroke:#ff3b30;">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="fav-card-content" style="margin-top: 5px;">${memory.content.replace(/\n/g, '<br>')}</div>
            `;
            fragment.appendChild(item);
        });

        container.appendChild(fragment);
        memoryRenderCount += itemsToRender.length;

        // „Äê‰øÆÂ§çÂÖ≥ÈîÆÁÇπ„ÄëÔºöÊ£ÄÊü•ÊòØÂê¶Â°´Êª°Â±èÂπï
        // Â¶ÇÊûúÂÆπÂô®ÁöÑÂÜÖÂÆπÈ´òÂ∫¶ <= ÂÆπÂô®ÂèØËßÅÈ´òÂ∫¶ÔºàËØ¥ÊòéÊ≤°ÊúâÂá∫Áé∞ÊªöÂä®Êù°ÔºâÔºå‰∏îËøòÊúâÂâ©‰ΩôÊï∞ÊçÆ
        // Á´ãÂç≥ËØ∑Ê±ÇÂä†ËΩΩ‰∏ã‰∏ÄÈ°µÔºåÁõ¥Âà∞Â°´Êª°Â±èÂπïÂá∫Áé∞ÊªöÂä®Êù°‰∏∫Ê≠¢
        if (container.scrollHeight <= container.clientHeight && memoryRenderCount < memoryCache.length) {
            isLoadingMoreMemories = false; // ‰∏¥Êó∂Ëß£ÈîÅ‰ª•‰æøÈÄíÂΩíË∞ÉÁî®
            loadMoreMemories(); // ÈÄíÂΩíÂä†ËΩΩ
            return; // ÈÄÄÂá∫ÂΩìÂâçÂáΩÊï∞ÔºåÁî±ÈÄíÂΩíË∞ÉÁî®Êé•ÁÆ°ÈîÅ
        }

    } catch (error) {
        console.error("Ê∏≤ÊüìÈïøÊúüËÆ∞ÂøÜÂá∫Èîô:", error);
    } finally {
        // 3. Êó†ËÆ∫ÊàêÂäüËøòÊòØÂá∫ÈîôÔºå‰∏ÄÂÆöË¶ÅËß£ÈîÅ
        isLoadingMoreMemories = false;
    }
}


  async function handleAddManualMemory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    let targetChatForMemory = chat;
    if (chat.isGroup) {
      const memberOptions = chat.members.map(member => ({
        text: `‰∏∫‚Äú${member.groupNickname}‚ÄùÊ∑ªÂä†ËÆ∞ÂøÜ`,
        value: member.id
      }));
      const selectedMemberId = await showChoiceModal('ÈÄâÊã©ËÆ∞ÂøÜÊâÄÂ±ûËßíËâ≤', memberOptions);
      if (!selectedMemberId) return;
      targetChatForMemory = state.chats[selectedMemberId];
      if (!targetChatForMemory) {
        alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞ËØ•ÊàêÂëòÁöÑ‰∏™‰∫∫Ê°£Ê°à„ÄÇ");
        return;
      }
    }
    const content = await showCustomPrompt(`‰∏∫‚Äú${targetChatForMemory.name}‚ÄùÊ∑ªÂä†ËÆ∞ÂøÜ`, 'ËØ∑ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑËÆ∞ÂøÜË¶ÅÁÇπÔºö', '', 'textarea');
    if (content && content.trim()) {
      if (!targetChatForMemory.longTermMemory) targetChatForMemory.longTermMemory = [];
      targetChatForMemory.longTermMemory.push({
        content: content.trim(),
        timestamp: Date.now(),
        source: 'manual'
      });
      await db.chats.put(targetChatForMemory);
      renderLongTermMemoryList();
    }
  }


 
  async function handleEditMemory(authorChatId, memoryTimestamp) {
    const authorChat = state.chats[authorChatId];
    if (!authorChat || !authorChat.longTermMemory) return;
    const memoryIndex = authorChat.longTermMemory.findIndex(m => m.timestamp === memoryTimestamp);
    if (memoryIndex === -1) return;
    const memory = authorChat.longTermMemory[memoryIndex];
    const newContent = await showCustomPrompt('ÁºñËæëËÆ∞ÂøÜ', 'ËØ∑‰øÆÊîπËÆ∞ÂøÜË¶ÅÁÇπÔºö', memory.content, 'textarea');
    if (newContent && newContent.trim()) {
      memory.content = newContent.trim();
      await db.chats.put(authorChat);
      renderLongTermMemoryList();
    }
  }

  async function handleDeleteMemory(authorChatId, memoryTimestamp) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÈïøÊúüËÆ∞ÂøÜÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      const authorChat = state.chats[authorChatId];
      if (!authorChat || !authorChat.longTermMemory) return;
      authorChat.longTermMemory = authorChat.longTermMemory.filter(m => m.timestamp !== memoryTimestamp);
      await db.chats.put(authorChat);
      renderLongTermMemoryList();
    }
  }



  async function handleManualSummary() {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Êìç‰Ωú', 'ËøôÂ∞ÜÊèêÂèñÊúÄËøëÁöÑÂØπËØùÂÜÖÂÆπÂèëÈÄÅÁªôAIËøõË°åÊÄªÁªìÔºå‰ºöÊ∂àËÄóAPIÈ¢ùÂ∫¶„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü');
    if (confirmed) {
      await triggerAutoSummary(state.activeChatId, true);
    }
  }

  
  async function checkAndTriggerAutoSummary(chatId) {
    const chat = state.chats[chatId];
    if (!chat || !chat.settings.enableAutoMemory) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    const messagesSinceLastSummary = chat.history.filter(m => m.timestamp > lastSummaryTimestamp && !m.isHidden);

    if (messagesSinceLastSummary.length >= chat.settings.autoMemoryInterval) {
      console.log(`ËææÂà∞Ëá™Âä®ÊÄªÁªìÈòàÂÄº (${messagesSinceLastSummary.length}/${chat.settings.autoMemoryInterval})ÔºåÂºÄÂßãÊÄªÁªì...`);
      await triggerAutoSummary(chatId);
    }
  }

 
  async function summarizeCallTranscript(chatId, transcriptText) {
    const chat = state.chats[chatId];
    if (!chat || !transcriptText) {
      throw new Error("Âü∫Á°ÄÊï∞ÊçÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂºÄÂßãÊÄªÁªì„ÄÇ");
    }

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');
const summaryWorldBook = state.worldBooks.find(wb => wb.name === 'ÊÄªÁªìËÆæÂÆö'); // Á°Æ‰øùËøô‰∏™ÂêçÂ≠óÂíå‰Ω†ÂàõÂª∫ÁöÑ‰∏ñÁïå‰π¶‰∏ÄËá¥
let summarySettingContext = '';
if (summaryWorldBook) {
  const enabledEntries = summaryWorldBook.content
    .filter(e => e.enabled !== false) // ‰ªÖËØªÂèñÂêØÁî®ÁöÑÊù°ÁõÆ
    .map(e => e.content)
    .join('\n');
  
  if (enabledEntries) {
    summarySettingContext = `
# „ÄêÊÄªÁªìËßÑÂàô (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
# ‰Ω†Âú®ÊâßË°åÊú¨Ê¨°ÊÄªÁªì‰ªªÂä°Êó∂Ôºå„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËßÑÂàôÔºö
# ---
# ${enabledEntries}
# ---
`;
  }
}
    let systemPrompt;
    let targetMemoryChat = chat;




    const today = new Date().toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    if (chat.isGroup) {
      let protagonist = null;
      if (videoCallState.callRequester) {
        protagonist = chat.members.find(m => m.originalName === videoCallState.callRequester);
      }
      if (!protagonist) {
        protagonist = chat.members.find(m => m.id !== 'user' && videoCallState.participants.some(p => p.id === m.id));
      }
      if (!protagonist) {
        protagonist = chat.members.find(m => m.id !== 'user');
      }

      if (!protagonist) {
        throw new Error("Áæ§ËÅäÈÄöËØù‰∏≠Ê≤°ÊúâÊâæÂà∞ÂèØ‰Ωú‰∏∫ÊÄªÁªì‰∏ª‰ΩìÁöÑAIËßíËâ≤„ÄÇ");
      }

      const protagonistChat = state.chats[protagonist.id];
      if (!protagonistChat) {
        throw new Error(`Êâæ‰∏çÂà∞‰∏ªËßí ‚Äú${protagonist.groupNickname}‚Äù ÁöÑËØ¶ÁªÜËßíËâ≤‰ø°ÊÅØ„ÄÇ`);
      }

      const userPersonaInGroup = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
      let timeHeader = '';
      let timeRule = '';
      
      if (protagonistChat.settings.enableTimePerception) {
          timeHeader = `
# ÂΩìÂâçÊó∂Èó¥
- **‰ªäÂ§©ÊòØÔºö${today}**`;
          timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúÈÄöËØù‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‚Äú‰ªäÂ§©ÊòØ${today}‚ÄùËøô‰∏™‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
      }
      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${protagonist.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ãÂàöÊâçÂíå ‚Äú${userNickname}‚Äù ‰ª•ÂèäÂÖ∂‰ªñÁæ§ÊàêÂëòÁöÑ„ÄêÁæ§ÁªÑËßÜÈ¢ëÈÄöËØù„ÄëÔºåÁÑ∂ÂêéÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ ("Êàë")„ÄëÁöÑÂè£ÂêªÔºåÊÄªÁªìÂá∫‰∏ÄÊÆµÁÆÄÁü≠ÁöÑ„ÄÅÂÆ¢ËßÇÁöÑ„ÄÅÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫é‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **ÂÖ≥ÈîÆËÆÆÈ¢ò**: Êàë‰ª¨Âú®Áæ§ËÅäÈÄöËØùÈáåËÆ®ËÆ∫‰∫ÜÂì™‰∫õÊ†∏ÂøÉËØùÈ¢òÔºü
    *   **ÈáçË¶ÅÂÜ≥ÂÆö‰∏éÂÖ±ËØÜ**: Êàë‰ª¨ËææÊàê‰∫Ü‰ªÄ‰πàÂÖ±ËØÜÊàñÂÅöÂá∫‰∫Ü‰ªÄ‰πàÂÜ≥ÂÆöÔºü
    *   **ÂêéÁª≠ËÆ°Âàí‰∏é‰ªªÂä°**: ÊúâÊ≤°ÊúâÁ°ÆÂÆö‰∏ãÊù•‰ªÄ‰πà‰∏ã‰∏ÄÊ≠•ÁöÑË°åÂä®ÊàñËÆ°ÂàíÔºü
    *   **ÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÊúâÊ≤°Êúâ‰∫§Êç¢‰ªÄ‰πàÈáçË¶ÅÁöÑ‰ø°ÊÅØÔºüÔºà‰æãÂ¶ÇÔºöÁ∫¶ÂÆö‰∫ÜÊó∂Èó¥„ÄÅÂú∞ÁÇπÁ≠âÔºâ
${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩ‰ºöËÆÆÁ∫™Ë¶ÅÊàñÂ§áÂøòÂΩïÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊäíÊÉÖÊï£Êñá„ÄÇ

6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${protagonistChat.settings.aiPersona}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${userPersonaInGroup}

# ÂæÖÊÄªÁªìÁöÑÁæ§ÁªÑËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï
${transcriptText}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${protagonist.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂÆ¢ËßÇÊÄªÁªì„ÄÇ`;

      targetMemoryChat = protagonistChat;

    } else {
      let timeHeader = '';
      let timeRule = '';

      if (chat.settings.enableTimePerception) {
          timeHeader = `
# ÂΩìÂâçÊó∂Èó¥
- **‰ªäÂ§©ÊòØÔºö${today}**`;
          timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúÈÄöËØù‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‚Äú‰ªäÂ§©ÊòØ${today}‚ÄùËøô‰∏™‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
      }
      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${chat.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ãÂàöÊâçÂíå‚Äú${userNickname}‚ÄùÁöÑËßÜÈ¢ëÈÄöËØùÔºåÁÑ∂ÂêéÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ ("Êàë")„ÄëÁöÑÂè£ÂêªÔºåÊÄªÁªìÂá∫‰∏ÄÊÆµÁÆÄÁü≠ÁöÑ„ÄÅÂÆ¢ËßÇÁöÑ„ÄÅÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫é‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **ÂÖ≥ÈîÆËÆÆÈ¢ò**: Êàë‰ª¨ËÅä‰∫Ü‰ªÄ‰πàÊ†∏ÂøÉËØùÈ¢òÔºü
    *   **ÈáçË¶ÅÂÜ≥ÂÆö‰∏éÂÖ±ËØÜ**: Êàë‰ª¨ËææÊàê‰∫Ü‰ªÄ‰πàÂÖ±ËØÜÊàñÂÅöÂá∫‰∫Ü‰ªÄ‰πàÂÜ≥ÂÆöÔºü
    *   **ÂêéÁª≠ËÆ°Âàí‰∏é‰ªªÂä°**: ÊúâÊ≤°ÊúâÁ°ÆÂÆö‰∏ãÊù•‰ªÄ‰πà‰∏ã‰∏ÄÊ≠•ÁöÑË°åÂä®ÊàñËÆ°ÂàíÔºü
    *   **ÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÊúâÊ≤°Êúâ‰∫§Êç¢‰ªÄ‰πàÈáçË¶ÅÁöÑ‰ø°ÊÅØÔºüÔºà‰æãÂ¶ÇÔºöÁ∫¶ÂÆö‰∫ÜÊó∂Èó¥„ÄÅÂú∞ÁÇπÁ≠âÔºâ
${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩ‰ºöËÆÆÁ∫™Ë¶ÅÊàñÂ§áÂøòÂΩïÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊäíÊÉÖÊï£Êñá„ÄÇ

6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${chat.settings.myPersona}

# ÂæÖÊÄªÁªìÁöÑËßÜÈ¢ëÈÄöËØùËÆ∞ÂΩï
${transcriptText}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${chat.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂÆ¢ËßÇÊÄªÁªì„ÄÇ`;
    }



    try {
      const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
      const {
        proxyUrl,
        apiKey,
        model
      } = useSecondaryApi ? {
          proxyUrl: state.apiConfig.secondaryProxyUrl,
          apiKey: state.apiConfig.secondaryApiKey,
          model: state.apiConfig.secondaryModel
        } :
        state.apiConfig;

      if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïËøõË°åÊÄªÁªì„ÄÇ');

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{
        role: 'user',
        content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
      }]);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, {
              role: 'user',
              content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
            }],
            temperature: 0.7
          })
        });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({
          error: {
            message: response.statusText
          }
        }));
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`);
      }

      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
      rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
      const result = JSON.parse(rawContent);

      if (result.summary && result.summary.trim()) {
        const newMemoryEntry = {
          content: `(Âú®ÈÇ£Ê¨°${chat.isGroup ? 'Áæ§ËÅä' : ''}ÈÄöËØù‰∏≠Ôºå${result.summary.trim()})`,
          timestamp: Date.now(),
          source: chat.isGroup ? 'group_call_summary' : 'call_summary'
        };
        if (!targetMemoryChat.longTermMemory) targetMemoryChat.longTermMemory = [];
        targetMemoryChat.longTermMemory.push(newMemoryEntry);
        await db.chats.put(targetMemoryChat);
        console.log(`ÈÄöËØùËÆ∞ÂΩïÂ∑≤ÊàêÂäüÊÄªÁªìÂπ∂Â≠òÂÖ•ËßíËâ≤‚Äú${targetMemoryChat.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜ‰∏≠„ÄÇ`);

        return true;
      } else {
        throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
      }

    } catch (error) {
      console.error("ÊÄªÁªìÈÄöËØùËÆ∞ÂΩïÊó∂Âá∫Èîô:", error);
      throw error;
    }
  }

  function analyzeTextForSummary(text) {
    const stopWords = new Set(['ÁöÑ', 'ÊòØ', '‰∫Ü', 'Âú®', 'Êàë', '‰Ω†', '‰ªñ', 'Â•π', 'ÂÆÉ', 'Êàë‰ª¨', '‰Ω†‰ª¨', '‰ªñ‰ª¨', 'Ëøô', 'ÈÇ£', '‰∏Ä‰∏™', '‰πü', 'Âíå', '‰∏é', 'Êàñ', '‰ΩÜ', 'ÁÑ∂ËÄå', 'ÊâÄ‰ª•', 'Âõ†Ê≠§', 'Â∞±', 'ÈÉΩ', 'Âú∞', 'Âæó', 'ÁùÄ', 'Ëøá', 'Âêß', 'Âêó', 'Âë¢', 'Âïä', 'Âì¶', 'ÂóØ', '‰ªÄ‰πà', 'ÊÄé‰πà', '‰∏∫‰ªÄ‰πà', 'Âì™‰∏™', '‰∏Ä‰∫õ', 'Ëøô‰∏™', 'ÈÇ£‰∏™', 'ËøòÊúâ']);
    const words = text.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const frequencies = new Map();
    let maxFrequency = 0;

    words.forEach(word => {
      if (word.length > 1 && !stopWords.has(word)) {
        const count = (frequencies.get(word) || 0) + 1;
        frequencies.set(word, count);
        if (count > maxFrequency) maxFrequency = count;
      }
    });

    const coreKeywords = [];
    const situationalKeywords = [];
    const coreThreshold = maxFrequency * 0.9;
    const situationalThreshold = maxFrequency * 0.6;

    frequencies.forEach((count, word) => {
      if (count >= coreThreshold) {
        coreKeywords.push(word);
      } else if (count >= situationalThreshold) {
        situationalKeywords.push(word);
      }
    });

    const coreSet = new Set(coreKeywords);
    const finalSituational = situationalKeywords.filter(word => !coreSet.has(word)).slice(0, 5);

    return {
      coreKeywords: coreKeywords.slice(0, 3),
      situationalKeywords: finalSituational
    };
  }


  function generateSummaryForTimeframe(chat, duration, unit) {
    let timeAgo;
    if (unit === 'hours') {
      timeAgo = Date.now() - duration * 60 * 60 * 1000;
    } else { // 'days'
      timeAgo = Date.now() - duration * 24 * 60 * 60 * 1000;
    }

    const messagesToSummarize = chat.history.filter(m => m.timestamp > timeAgo && !m.isHidden);

    if (messagesToSummarize.length < 3) {
      return "";
    }

   
    const allText = messagesToSummarize.map(msg => {
      if (typeof msg.content === 'string') return msg.content;
      if (msg.type === 'voice_message') return msg.content;
      if (msg.type === 'offline_text') return `${msg.dialogue || ''} ${msg.description || ''}`;
      return '';
    }).join(' ');

    const stopWords = new Set(['ÁöÑ', 'ÊòØ', '‰∫Ü', 'Âú®', 'Êàë', '‰Ω†', '‰ªñ', 'Â•π', 'ÂÆÉ', 'Êàë‰ª¨', '‰Ω†‰ª¨', '‰ªñ‰ª¨', 'Ëøô', 'ÈÇ£', '‰∏Ä‰∏™', '‰πü', 'Âíå', '‰∏é', 'Êàñ', '‰ΩÜ', 'ÁÑ∂ËÄå', 'ÊâÄ‰ª•', 'Âõ†Ê≠§', 'Â∞±', 'ÈÉΩ', 'Âú∞', 'Âæó', 'ÁùÄ', 'Ëøá', 'Âêß', 'Âêó', 'Âë¢', 'Âïä', 'Âì¶', 'ÂóØ']);
    const words = allText.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g) || [];
    const frequencies = new Map();
    words.forEach(word => {
      if (word.length > 1 && !stopWords.has(word)) {
        frequencies.set(word, (frequencies.get(word) || 0) + 1);
      }
    });
    const sortedKeywords = [...frequencies.entries()].sort((a, b) => b[1] - a[1]).map(entry => entry[0]);

    if (sortedKeywords.length === 0) {
      return "";
    }


    let title;
    if (unit === 'hours') {
      title = `ÊúÄËøë${duration}Â∞èÊó∂Ê†∏ÂøÉËÆÆÈ¢ò`;
    } else {
      if (duration === 1) {
        title = "Êú¨Êó•Ê†∏ÂøÉËÆÆÈ¢ò";
      } else {
        title = `ÊúÄËøë${duration}Â§©Ê†∏ÂøÉËÆÆÈ¢ò`;
      }
    }

    return `\n- **${title}**: ÂÖ≥‰∫é **${sortedKeywords.slice(0, 3).join('„ÄÅ ')}**„ÄÇ`;
  }



  function robustJsonParse(rawContent) {
    if (!rawContent || typeof rawContent !== 'string') {
      return null;
    }

    const cleanedContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();


    const jsonMatch = cleanedContent.match(/{[\s\S]*}/);
    if (jsonMatch) {
      try {
        const parsed = JSON.parse(jsonMatch[0]);
        console.log("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•1ÊàêÂäü (ÊâæÂà∞Âπ∂Ëß£Êûê‰∫ÜÂÆåÊï¥ÁöÑJSONÂØπË±°)");
        return parsed;
      } catch (e) {
        console.warn("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•1Â§±Ë¥• (ÊâæÂà∞‰∫ÜJSONÂùóÔºå‰ΩÜÊ†ºÂºèÈîôËØØ)ÔºåÂ∞ÜÂ∞ùËØïÁ≠ñÁï•2...");
      }
    }


    const summaryMatch = cleanedContent.match(/"summary"\s*:\s*"((?:[^"\\]|\\.)*)"/);
    if (summaryMatch && summaryMatch[1]) {
      console.log("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•2ÊàêÂäü (ÊèêÂèñ‰∫ÜsummaryÂ≠óÊÆµÂÜÖÂÆπ)");

      return {
        summary: summaryMatch[1].replace(/\\"/g, '"')
      }; 
    }


    if (cleanedContent) {
      console.log("ÂÆπÈîôËß£ÊûêÔºöÁ≠ñÁï•3ÊàêÂäü (Â∞ÜÊï¥‰∏™ËøîÂõûÊñáÊú¨‰Ωú‰∏∫ÊëòË¶Å)");
      return {
        summary: cleanedContent
      };
    }


    return null;
  }



  async function summarizeExistingLongTermMemory(chatId) {
    let chat = state.chats[chatId];
    if (!chat) return;

    let targetChatForRefine = chat;

    if (chat.isGroup) {
      const memberOptions = chat.members
        .map(member => {
          const memberChat = state.chats[member.id];
          if (memberChat && memberChat.longTermMemory && memberChat.longTermMemory.length >= 2) {
            return {
              text: `Á≤æÁÇº‚Äú${member.groupNickname}‚ÄùÁöÑËÆ∞ÂøÜ (${memberChat.longTermMemory.length}Êù°)`,
              value: member.id
            };
          }
          return null;
        }).filter(Boolean);

      if (memberOptions.length === 0) {
        alert("Áæ§ËÅä‰∏≠Ê≤°ÊúâÊàêÂëòÊúâË∂≥Â§üÔºà2Êù°‰ª•‰∏äÔºâÁöÑËÆ∞ÂøÜÂèØ‰æõÁ≤æÁÇº„ÄÇ");
        return;
      }

      const selectedMemberId = await showChoiceModal('ÈÄâÊã©Ë¶ÅÁ≤æÁÇºËÆ∞ÂøÜÁöÑËßíËâ≤', memberOptions);

      if (!selectedMemberId) return;

      targetChatForRefine = state.chats[selectedMemberId];
    }

    if (!targetChatForRefine.longTermMemory || targetChatForRefine.longTermMemory.length < 2) {
      alert(`‚Äú${targetChatForRefine.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜÂ∞ë‰∫é2Êù°ÔºåÊó†ÈúÄËøõË°åÁ≤æÁÇº„ÄÇ`);
      return;
    }

    const totalMemories = targetChatForRefine.longTermMemory.length;
    const choice = await showChoiceModal('ÈÄâÊã©Á≤æÁÇºËåÉÂõ¥', [{
        text: `ÂÖ®ÈÉ®ËÆ∞ÂøÜ (${totalMemories}Êù°)`,
        value: 'all'
      },
      {
        text: `ÊúÄËøë 20 Êù°`,
        value: '20'
      },
      {
        text: `ÊúÄËøë 50 Êù°`,
        value: '50'
      },
      {
        text: `ÊúÄËøë 100 Êù°`,
        value: '100'
      },
      {
        text: 'Ëá™ÂÆö‰πâÊï∞Èáè...',
        value: 'custom'
      }
    ].filter(opt => opt.value === 'all' || opt.value === 'custom' || parseInt(opt.value) < totalMemories));

    if (choice === null) return;

    let memoriesToRefine;
    let countToRefine = totalMemories;

    if (choice === 'all') {
      memoriesToRefine = [...targetChatForRefine.longTermMemory];
    } else if (choice === 'custom') {
      const customCountStr = await showCustomPrompt('Ëá™ÂÆö‰πâÊï∞Èáè', `ËØ∑ËæìÂÖ•Ë¶ÅÁ≤æÁÇºÁöÑÊúÄËøëËÆ∞ÂøÜÊù°Êï∞ (ÊúÄÂ§ö ${totalMemories} Êù°)`);
      if (customCountStr === null) return;
      const customCount = parseInt(customCountStr);
      if (isNaN(customCount) || customCount < 2 || customCount > totalMemories) {
        alert(`ËØ∑ËæìÂÖ•‰∏Ä‰∏™ 2 Âà∞ ${totalMemories} ‰πãÈó¥ÁöÑÊúâÊïàÊï∞Â≠ó„ÄÇ`);
        return;
      }
      countToRefine = customCount;
      memoriesToRefine = targetChatForRefine.longTermMemory.slice(-countToRefine);
    } else {
      countToRefine = parseInt(choice);
      if (countToRefine >= totalMemories) {
        memoriesToRefine = [...targetChatForRefine.longTermMemory];
        countToRefine = totalMemories;
      } else {
        memoriesToRefine = targetChatForRefine.longTermMemory.slice(-countToRefine);
      }
    }

    const wordCountStr = await showCustomPrompt(
      "ËÆæÁΩÆÁ≤æÁÇºÂ≠óÊï∞",
      "ËØ∑ËæìÂÖ•Á≤æÁÇºÂêéÊ†∏ÂøÉËÆ∞ÂøÜÁöÑÂ§ßËá¥Â≠óÊï∞Ôºö",
      "150"
    );

    if (wordCountStr === null) return;

    const wordCount = parseInt(wordCountStr);
    if (isNaN(wordCount) || wordCount < 20) {
      alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÊï∞Â≠óÔºàÂª∫ËÆÆÂ§ß‰∫é20Ôºâ„ÄÇ");
      return;
    }

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Á≤æÁÇºËÆ∞ÂøÜÔºü',
      `Ê≠§Êìç‰Ωú‰ºöÂ∞ÜÈÄâÂÆöÁöÑ ${countToRefine} Êù°ÈïøÊúüËÆ∞ÂøÜÂèëÈÄÅÁªôAIÔºåÊÄªÁªìÊàêÂ§ßÁ∫¶ ${wordCount} Â≠óÁöÑÊ†∏ÂøÉËÆ∞ÂøÜ„ÄÇËøô‰∫õÊóßËÆ∞ÂøÜÂ∞ÜË¢´ÊõøÊç¢ÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`, {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Á≤æÁÇº'
      }
    );

    if (!confirmed) return;

    const memoryContent = memoriesToRefine.map(mem => `- ${mem.content}`).join('\n');
    const userNickname = targetChatForRefine.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');


    const today = new Date().toLocaleDateString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    let timeHeader = '';
    let timeRule = '';

    if (targetChatForRefine.settings.enableTimePerception) {
        timeHeader = `
# ÂΩìÂâçÊó∂Èó¥
- **‰ªäÂ§©ÊòØÔºö${today}**`;
        timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúËÆ∞ÂøÜ‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚Äù„ÄÅ‚Äú‰∏ãÂë®‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‚Äú‰ªäÂ§©ÊòØ${today}‚ÄùËøô‰∏™‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
    }
const summaryWorldBook = state.worldBooks.find(wb => wb.name === 'ÊÄªÁªìËÆæÂÆö'); // Á°Æ‰øùËøô‰∏™ÂêçÂ≠óÂíå‰Ω†ÂàõÂª∫ÁöÑ‰∏ñÁïå‰π¶‰∏ÄËá¥
let summarySettingContext = '';
if (summaryWorldBook) {
  const enabledEntries = summaryWorldBook.content
    .filter(e => e.enabled !== false) // ‰ªÖËØªÂèñÂêØÁî®ÁöÑÊù°ÁõÆ
    .map(e => e.content)
    .join('\n');
  
  if (enabledEntries) {
    summarySettingContext = `
# „ÄêÊÄªÁªìËßÑÂàô (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
# ‰Ω†Âú®ÊâßË°åÊú¨Ê¨°ÊÄªÁªì‰ªªÂä°Êó∂Ôºå„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËßÑÂàôÔºö
# ---
# ${enabledEntries}
# ---
`;
  }
}
    const systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${targetChatForRefine.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ã‰Ω†Âíå‚Äú${userNickname}‚ÄùÁöÑÊâÄÊúâÈïøÊúüËÆ∞ÂøÜÔºåÁÑ∂ÂêéÂ∞ÜÂÆÉ‰ª¨Ê¢≥ÁêÜ„ÄÅÊï¥ÂêàÂπ∂Á≤æÁÇºÊàê‰∏ÄÊÆµÊõ¥Âä†ËøûË¥Ø„ÄÅÂÆ¢ËßÇÁöÑÊ†∏ÂøÉËÆ∞ÂøÜÊëòË¶Å„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫éÊ¢≥ÁêÜ‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **Âª∫Á´ãÊó∂Èó¥Á∫ø**: Â∞ÜÊâÄÊúâÁã¨Á´ãÁöÑËÆ∞ÂøÜÁÇπ‰∏≤ËÅîËµ∑Êù•ÔºåÂΩ¢Êàê‰∏Ä‰∏™ÊúâÊó∂Èó¥È°∫Â∫èÁöÑ‰∫ã‰ª∂ËÑâÁªú„ÄÇ
    *   **Êï¥ÂêàÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÊÄªÁªìÂá∫Êàë‰ª¨ÂÖ±ÂêåÁªèÂéÜÁöÑÂÖ≥ÈîÆ‰∫ã‰ª∂„ÄÅÂÅöÂá∫ÁöÑÈáçË¶ÅÂÜ≥ÂÆö„ÄÅ‰ª•ÂèäÁ∫¶ÂÆöÂ•ΩÁöÑÊú™Êù•ËÆ°Âàí„ÄÇ
    *   **ËØÜÂà´Êú™ÂÆåÊàêÈ°π**: ÊòéÁ°ÆÊåáÂá∫Âì™‰∫õËÆ°ÂàíÊàñ‰ªªÂä°Â∞öÊú™ÂÆåÊàê„ÄÇ
${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩÊ∏ÖÊô∞ÁöÑ‰∏™‰∫∫Ê°£Ê°àÊàñ‰∫ã‰ª∂ÂõûÈ°æÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊÉÖÊÑüÊï£Êñá„ÄÇËØ∑Âà†Èô§ÈáçÂ§ç„ÄÅÁêêÁ¢éÊàñÁ∫ØÁ≤πÁöÑÊÉÖÊÑüÂÆ£Ê≥ÑÔºåÂè™‰øùÁïôÂØπÊÉÖËäÇÂíåÂÖ≥Á≥ªÂèëÂ±ïËá≥ÂÖ≥ÈáçË¶ÅÁöÑÈÉ®ÂàÜ„ÄÇ
5.  **„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„ÄëÈùûÂ∏∏Á≤æÁÇºÔºåÊÄªÈïøÂ∫¶Â∫îÊéßÂà∂Âú® **${wordCount} Â≠óÂ∑¶Âè≥**„ÄÇ
6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${targetChatForRefine.settings.aiPersona}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${targetChatForRefine.settings.myPersona}

# ÂæÖÊï¥ÂêàÁöÑËÆ∞ÂøÜË¶ÅÁÇπÂàóË°®
${memoryContent}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${targetChatForRefine.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂõûÂøÜÊ¢≥ÁêÜ‰∏éÁ≤æÁÇº„ÄÇ`;


    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËøõË°åËÆ∞ÂøÜÁ≤æÁÇº...");

    try {
      const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
      const {
        proxyUrl,
        apiKey,
        model
      } = useSecondaryApi
        ?
        {
          proxyUrl: state.apiConfig.secondaryProxyUrl,
          apiKey: state.apiConfig.secondaryApiKey,
          model: state.apiConfig.secondaryModel
        } :
        state.apiConfig;

      if (!proxyUrl || !apiKey || !model) {
        throw new Error('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩÔºà‰∏ªÊàñÂâØÔºâAPI‰ª•ËøõË°åÊÄªÁªì„ÄÇ');
      }

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{
        role: 'user',
        content: "ËØ∑ÂºÄÂßãÊï¥Âêà„ÄÇ"
      }]);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, {
              role: 'user',
              content: "ËØ∑ÂºÄÂßãÊï¥Âêà„ÄÇ"
            }],
            temperature: 0.7,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;

      const result = robustJsonParse(rawContent);

      if (result && result.summary && typeof result.summary === 'string' && result.summary.trim()) {

        const userConfirmedReplacement = await showCustomConfirm(
          'Á≤æÁÇºÂÆåÊàêÔºåËØ∑Á°ÆËÆ§',
          `AIÂ∑≤Â∞ÜÊÇ®ÁöÑ ${countToRefine} Êù°ÊóßËÆ∞ÂøÜÊÄªÁªì‰∏∫‰ª•‰∏ãÊ†∏ÂøÉËÆ∞ÂøÜÔºö<br><br><div class="scrollable-content-preview">${result.summary.trim()}</div><br>ÊòØÂê¶Áî®ËøôÊù°Êñ∞ËÆ∞ÂøÜÊõøÊç¢ÊéâËøô‰∫õÊóßËÆ∞ÂøÜÔºü`, {
            confirmText: 'Á°ÆËÆ§ÊõøÊç¢',
            cancelText: '‰øùÁïôÊóßÁöÑ',
            confirmButtonClass: 'btn-danger'
          }
        );

        if (userConfirmedReplacement) {
          const newMemoryEntry = {
            content: result.summary.trim(),
            timestamp: Date.now(),
            source: 'refined'
          };

          const startIndex = totalMemories - countToRefine;
          const memoriesToKeep = startIndex > 0 ? targetChatForRefine.longTermMemory.slice(0, startIndex) : [];
          targetChatForRefine.longTermMemory = [...memoriesToKeep, newMemoryEntry];

          targetChatForRefine.lastMemorySummaryTimestamp = Date.now();
          await db.chats.put(targetChatForRefine);

          if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
            renderLongTermMemoryList();
          }
          await showCustomAlert('Á≤æÁÇºÊàêÂäü', `Â∑≤ÊàêÂäüÂ∞Ü ${countToRefine} Êù°ËÆ∞ÂøÜÁ≤æÁÇº‰∏∫ 1 Êù°Ê†∏ÂøÉËÆ∞ÂøÜÔºÅ`);
        } else {
          await showCustomAlert('Êìç‰ΩúÂ∑≤ÂèñÊ∂à', 'ÊÇ®ÁöÑÊóßÊúâËÆ∞ÂøÜÂ∑≤Ë¢´ÂÆåÊï¥‰øùÁïôÔºåÊú™‰Ωú‰ªª‰Ωï‰øÆÊîπ„ÄÇ');
        }

      } else {
        throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
      }

    } catch (error) {
      console.error("Á≤æÁÇºÈïøÊúüËÆ∞ÂøÜÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Á≤æÁÇºÂ§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
    }
  }


  async function triggerAutoSummary(chatId, force = false) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const lastSummaryTimestamp = chat.lastMemorySummaryTimestamp || 0;
    const messagesToSummarize = force ?
      chat.history.filter(m => !m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ'))).slice(-(chat.settings.autoMemoryInterval || 20)) :
      chat.history.filter(m => m.timestamp > lastSummaryTimestamp && (!m.isHidden || (m.role === 'system' && m.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ'))));

    if (messagesToSummarize.length < 5) {
      if (force) alert("ÊúÄËøëÁöÑÊ∂àÊÅØÂ§™Â∞ëÔºåÊó†Ê≥ïËøõË°åÊúâÊÑè‰πâÁöÑÊÄªÁªì„ÄÇ");
      return;
    }

    const userNickname = chat.settings.myNickname || (state.qzoneSettings.nickname || 'Áî®Êà∑');
    const startMsg = messagesToSummarize[0];
    const endMsg = messagesToSummarize[messagesToSummarize.length - 1];

   
    const formatDateTime = (ts) => new Date(ts).toLocaleString('zh-CN', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', hour12: false
    });

    const timeRangeStr = `${formatDateTime(startMsg.timestamp)} Ëá≥ ${formatDateTime(endMsg.timestamp)}`;
    const formattedHistory = messagesToSummarize.map(msg => {
      if (msg.isHidden && msg.role === 'system' && msg.content.includes('ÂÜÖÂøÉÁã¨ÁôΩ')) {
        return msg.content;
      }
      if (msg.isHidden) return null; // ËøáÊª§ÊéâÂÖ∂‰ªñÈöêËóèÊ∂àÊÅØ

      let sender;
      if (msg.role === 'user') {
        sender = userNickname;
      } else {
        sender = msg.senderName || chat.originalName;
      }

      let prefix = "";
      
      if (msg.quote && msg.quote.content) {
          let quotedSenderDisplayName = msg.quote.senderName; 
          
         
          if (msg.quote.senderName === (state.qzoneSettings.nickname || '{{user}}')) {
              quotedSenderDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
          } else {
             
              quotedSenderDisplayName = getDisplayNameInGroup(chat, msg.quote.senderName);
          }
          
          let quoteContentPreview = String(msg.quote.content).substring(0, 30);
          if (quoteContentPreview.length === 30) quoteContentPreview += "...";
          
          prefix = `[ÂõûÂ§ç ${quotedSenderDisplayName}: "${quoteContentPreview}"] `;
      }

      let contentToSummarize = '';
      if (msg.type === 'offline_text') {
        if (msg.content) {
          contentToSummarize = msg.content;
        } else {
          const dialogue = msg.dialogue ? `„Äå${msg.dialogue}„Äç` : '';
          const description = msg.description ? `(${msg.description})` : '';
          contentToSummarize = `${dialogue} ${description}`.trim();
        }
      } else if (typeof msg.content === 'string') {
        contentToSummarize = msg.content;
      } else if (msg.type === 'voice_message') {
        contentToSummarize = `[ËØ≠Èü≥: ${msg.content}]`;
      } else if (msg.type === 'ai_image' || msg.type === 'user_photo') {
        contentToSummarize = `[ÂõæÁâá: ${msg.content}]`;
      } else if (msg.type === 'sticker') {
        contentToSummarize = `[Ë°®ÊÉÖ: ${msg.meaning || 'sticker'}]`;
      } else if (Array.isArray(msg.content)) {
        contentToSummarize = `[ÂõæÁâá]`; // ÂÅáËÆæÊòØÂõæÁâáÊï∞ÁªÑ
      } else {
        contentToSummarize = `[${msg.type || 'Â§çÊùÇÊ∂àÊÅØ'}]`; 
      }

      const msgTime = new Date(msg.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', hour12: false});
      return `[${msgTime}] ${sender}: ${prefix}${contentToSummarize}`;
    
    }).filter(Boolean).join('\n');
const summaryWorldBook = state.worldBooks.find(wb => wb.name === 'ÊÄªÁªìËÆæÂÆö');
let summarySettingContext = '';
if (summaryWorldBook) {
  const enabledEntries = summaryWorldBook.content
    .filter(e => e.enabled !== false) // ‰ªÖËØªÂèñÂêØÁî®ÁöÑÊù°ÁõÆ
    .map(e => e.content)
    .join('\n');
  
  if (enabledEntries) {
    summarySettingContext = `
# „ÄêÊÄªÁªìËßÑÂàô (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
# ‰Ω†Âú®ÊâßË°åÊú¨Ê¨°ÊÄªÁªì‰ªªÂä°Êó∂Ôºå„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËßÑÂàôÔºö
# ---
# ${enabledEntries}
# ---
`;
  }
}
    let systemPrompt;

    if (chat.isGroup) {
     let timeHeader = '';
        let timeRule = '';

        if (chat.settings.enableTimePerception) {
            timeHeader = `
# ÂØπËØùÂèëÁîüÊó∂Èó¥
- **${timeRangeStr}**`;
            timeRule = `- (ËØ∑Âü∫‰∫éÊ≠§Êó∂Èó¥ËåÉÂõ¥Êù•ÁêÜËß£ÂØπËØù‰∏≠ÊèêÂà∞ÁöÑ‚Äú‰ªäÂ§©‚Äù„ÄÅ‚ÄúÊòéÂ§©‚ÄùÁ≠âÁõ∏ÂØπÊó∂Èó¥Ê¶ÇÂøµÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨ËΩ¨Êç¢‰∏∫ÂÖ∑‰ΩìÁöÑÊó•ÊúüËÆ∞ÂΩïÂú®ËÆ∞ÂøÜ‰∏≠„ÄÇ)`;
        }
      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™È´òÁ∫ßÁöÑ‚ÄúËÆ∞ÂøÜÂàÜÈÖç‰∏ìÂÆ∂‚Äù„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÈòÖËØª‰∏ãÈù¢ÁöÑÁæ§ËÅäËÆ∞ÂΩïÔºåÂπ∂‰∏∫„ÄêÊØè‰∏Ä‰∏™ÂèÇ‰∏éÁöÑAIËßíËâ≤„ÄëÁîüÊàê‰∏ÄÊÆµ„Äê‰∏™ÊÄßÂåñÁöÑ„ÄÅÁ¨¨‰∏Ä‰∫∫Áß∞„ÄëÁöÑÈïøÊúüËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ
${timeHeader}
- (ËØ∑Âü∫‰∫éÊ≠§Êó∂Èó¥ËåÉÂõ¥Êù•ÁêÜËß£ÂØπËØù‰∏≠ÊèêÂà∞ÁöÑ‚Äú‰ªäÂ§©‚Äù„ÄÅ‚ÄúÊòéÂ§©‚ÄùÁ≠âÁõ∏ÂØπÊó∂Èó¥Ê¶ÇÂøµÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨ËΩ¨Êç¢‰∏∫ÂÖ∑‰ΩìÁöÑÊó•ÊúüËÆ∞ÂΩïÂú®ËÆ∞ÂøÜ‰∏≠„ÄÇ)
# Ê†∏ÂøÉËßÑÂàô
1.  **ËßÜËßíÈìÅÂæã**: ÊØè‰∏ÄÊù°ÊÄªÁªìÈÉΩ„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„Äë„ÄÇ
2.  **ÂÜÖÂÆπÊ†∏ÂøÉ**: ÈáçÁÇπÊÄªÁªìÔºöÊàëËØ¥ËøáÁöÑËØù„ÄÅÊàëÂÅöËøáÁöÑ‰∫ã„ÄÅÂà´‰∫∫ÂØπÊàëËØ¥ÁöÑËØù„ÄÅ‰∏éÊàëÁõ∏ÂÖ≥ÁöÑ‰∫ã„ÄÅ‰ª•ÂèäÂØπÊàë‰∏™‰∫∫ÂæàÈáçË¶ÅÁöÑÁæ§ËÅä‰∫ã‰ª∂„ÄÅÂÖ≥ÈîÆ‰ø°ÊÅØÂíåÂøÉÁêÜÊ¥ªÂä®‰ª•ÂèäÂΩìÂâçÁæ§ËÅäÂÜÖÁöÑÊÉÖÊôØ„ÄÇ
${timeRule}
4.  **„ÄêÁúÅÁï•ËßÑÂàô„Äë**: Â¶ÇÊûú‰∏Ä‰∏™ËßíËâ≤Âú®Êú¨Ê¨°ÂØπËØù‰∏≠„ÄêÂÆåÂÖ®Ê≤°ÊúâÂèÇ‰∏éÊàñÊèêÂèä„ÄëÔºå‰Ω†ÂèØ‰ª•ÁúÅÁï•TAÁöÑËÆ∞ÂøÜ„ÄÇ
5.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`\`\`json
    {
      "summaries": {
        "ËßíËâ≤ÁöÑÊú¨ÂêçA": "ÊàëÂú®(${timeRangeStr.split(' ')[0]})ÂíåÂ§ßÂÆ∂ËÆ®ËÆ∫‰∫Ü...",
        "ËßíËâ≤ÁöÑÊú¨ÂêçB": "ÊàëÁ∫¶‰∫Ü${userNickname}Âú®ÊòéÂ§©(ÈúÄÊ†πÊçÆÊó∂Èó¥ËåÉÂõ¥Êé®ÁÆóÂÖ∑‰ΩìÊó•Êúü)ÂçïÁã¨ËßÅÈù¢„ÄÇ"
      }
    }
    \`\`\`
# ÂæÖÊÄªÁªìÁöÑÁæ§ËÅäËÆ∞ÂΩï
${formattedHistory}
# Áæ§ÊàêÂëòÂàóË°® (‰Ω†ÁöÑÊÄªÁªìÁõÆÊ†á)
${chat.members.map(m => `- ${m.groupNickname} (Êú¨Âêç: ${m.originalName})`).join('\n')}
Áé∞Âú®ÔºåËØ∑‰∏∫„ÄêÂèÇ‰∏é‰∫ÜÂØπËØùÁöÑAIËßíËâ≤„ÄëÁîüÊàê‰ªñ‰ª¨ÂêÑËá™ÁöÑ„ÄÅÁ¨¨‰∏Ä‰∫∫Áß∞ÁöÑ„ÄÅÁ≤æÁÆÄÁöÑËÆ∞ÂøÜ„ÄÇ`;

    } else {


      const today = new Date().toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      let timeHeader = '';
        let timeRule = '';

        if (chat.settings.enableTimePerception) {
            timeHeader = `
# ÂØπËØùÊó∂Èó¥ËåÉÂõ¥
- **${timeRangeStr}**`;
            timeRule = `3.  **„ÄêÊó∂Èó¥ËΩ¨Êç¢ÈìÅÂæã (ÂøÖÈ°ªÈÅµÂÆà)„Äë**: Â¶ÇÊûúÂØπËØù‰∏≠ÊèêÂà∞‰∫ÜÁõ∏ÂØπÊó∂Èó¥ÔºàÂ¶Ç‚ÄúÊòéÂ§©‚Äù„ÄÅ‚ÄúÂêéÂ§©‚ÄùÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÁªìÂêà‰∏äÈù¢ÁöÑ„ÄêÂØπËØùÊó∂Èó¥ËåÉÂõ¥„Äë‰ø°ÊÅØÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫„ÄêÂÖ∑‰ΩìÁöÑÂÖ¨ÂéÜÊó•Êúü„Äë„ÄÇ`;
        }

      systemPrompt = `
${summarySettingContext}
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Â∞±ÊòØËßíËâ≤‚Äú${chat.originalName}‚Äù„ÄÇËØ∑‰Ω†ÂõûÈ°æ‰∏Ä‰∏ãÂàöÊâçÂíå‚Äú${userNickname}‚ÄùÁöÑÂØπËØùÔºåÁÑ∂ÂêéÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ ("Êàë")„ÄëÁöÑÂè£ÂêªÔºåÊÄªÁªìÂá∫‰∏ÄÊÆµÁÆÄÁü≠ÁöÑ„ÄÅÂÆ¢ËßÇÁöÑ„ÄÅÂåÖÂê´ÂÖ≥ÈîÆ‰ø°ÊÅØÁöÑËÆ∞ÂøÜ„ÄÇËØ∑‰∏ìÊ≥®‰∫éÈáçË¶ÅÁöÑÊÉÖÁª™„ÄÅ‰∫ã‰ª∂ÂíåÁªÜËäÇ„ÄÇ

${timeHeader}

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßÜËßíÈìÅÂæã„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®„Äê‰∏ªËßÇÁöÑÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜô„ÄÇ
2.  **„ÄêÂÜÖÂÆπÊ†∏ÂøÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁöÑÊÄªÁªì„ÄêÂøÖÈ°ª„Äë‰∏ìÊ≥®‰∫é‰ª•‰∏ãÂá†ÁÇπÔºö
    *   **ÈáçË¶Å‰∫ã‰ª∂**: ÂàöÊâçÂèëÁîü‰∫Ü‰ªÄ‰πàÂÖ∑‰ΩìÁöÑ‰∫ãÊÉÖÔºü
    *   **ÂÖ≥ÈîÆÂÜ≥ÂÆö**: Êàë‰ª¨ËææÊàê‰∫Ü‰ªÄ‰πàÂÖ±ËØÜÊàñÂÅöÂá∫‰∫Ü‰ªÄ‰πàÂÜ≥ÂÆöÔºü
    *   **Êú™Êù•ËÆ°Âàí**: Êàë‰ª¨Á∫¶ÂÆö‰∫Ü‰ªÄ‰πàÊú™Êù•ÁöÑËÆ°ÂàíÊàñÂæÖÂäû‰∫ãÈ°πÔºü
    *   **ÈáçË¶ÅÊó∂Èó¥ÁÇπ**: ÂØπËØù‰∏≠ÊèêÂà∞‰∫ÜÂì™‰∫õÂÖ∑‰ΩìÁöÑÊó•ÊúüÊàñÊó∂Èó¥Ôºü

${timeRule}
4.  **„ÄêÈ£éÊ†ºË¶ÅÊ±Ç„Äë**: ‰Ω†ÁöÑÊÄªÁªìÂ∫îËØ•ÂÉè‰∏Ä‰ªΩÂ§áÂøòÂΩïÊàñË¶ÅÁÇπËÆ∞ÂΩïÔºåËÄå‰∏çÊòØ‰∏ÄÁØáÊäíÊÉÖÊï£Êñá„ÄÇËØ∑Â∞ΩÈáèÂáèÂ∞ë‰∏ªËßÇÁöÑÂøÉÁêÜÊÑüÂèóÊèèËø∞ÔºåÈô§ÈùûÂÆÉÁõ¥Êé•ÂØºËá¥‰∫ÜÊüê‰∏™ÂÜ≥ÂÆöÊàñËÆ°Âàí„ÄÇ

6.  **„ÄêËæìÂá∫Ê†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
    \`{"summary": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†‰ª•Á¨¨‰∏Ä‰∫∫Áß∞ËßÜËßíÔºåÊÄªÁªìÂ•ΩÁöÑÊ†∏ÂøÉ‰∫ãÂÆû‰∏éËÆ°Âàí„ÄÇ"}\`

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}
# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${chat.settings.myPersona}
# ÂæÖÊÄªÁªìÁöÑÂØπËØùÂéÜÂè≤
${formattedHistory}

Áé∞Âú®ÔºåËØ∑‰ª•‚Äú${chat.originalName}‚ÄùÁöÑË∫´‰ªΩÔºåÂºÄÂßã‰Ω†ÁöÑÂÆ¢ËßÇÊÄªÁªì„ÄÇ`;

    }

    try {
      const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
      const {
        proxyUrl,
        apiKey,
        model
      } = useSecondaryApi ? {
        proxyUrl: state.apiConfig.secondaryProxyUrl,
        apiKey: state.apiConfig.secondaryApiKey,
        model: state.apiConfig.secondaryModel
      } : state.apiConfig;
      if (!proxyUrl || !apiKey || !model) throw new Error('APIÊú™ÈÖçÁΩÆ');

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{
        role: 'user',
        content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
      }]);
      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: [{
            role: 'system',
            content: systemPrompt
          }, {
            role: 'user',
            content: "ËØ∑ÂºÄÂßãÊÄªÁªì„ÄÇ"
          }],
          temperature: 0.7
        })
      });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
      const data = await response.json();
      let rawContent = isGemini ? getGeminiResponseText(data) : data.choices[0].message.content;
      rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
      const result = JSON.parse(rawContent);

      if (chat.isGroup) {
        if (result.summaries && typeof result.summaries === 'object') {
          let memoriesAddedCount = 0;
          for (const memberOriginalName in result.summaries) {
            const summaryText = result.summaries[memberOriginalName];
            if (summaryText && summaryText.trim()) {
              const memberChat = Object.values(state.chats).find(c => c.originalName === memberOriginalName);
              if (memberChat) {
                const newMemoryEntry = {
                  content: summaryText.trim(),
                  timestamp: Date.now(),
                  source: `group_summary_from_${chat.name}`
                };
                if (!memberChat.longTermMemory) memberChat.longTermMemory = [];
                memberChat.longTermMemory.push(newMemoryEntry);
                await db.chats.put(memberChat);
                memoriesAddedCount++;
              }
            }
          }
          if (memoriesAddedCount > 0) {
            console.log(`Ëá™Âä®ÊÄªÁªìÊàêÂäüÔºö‰∏∫ ${memoriesAddedCount} ‰ΩçÁæ§ÊàêÂëòÁîüÊàêÂπ∂Ê≥®ÂÖ•‰∫Ü‰∏™ÊÄßÂåñËÆ∞ÂøÜÔºÅ`);
          } else {
            throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
          }
        } else {
          throw new Error("AIËøîÂõûÁöÑJSONÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë 'summaries' Â≠óÊÆµ„ÄÇ");
        }
      } else {
        if (result.summary && result.summary.trim()) {
          const newMemoryEntry = {
            content: result.summary.trim(),
            timestamp: Date.now(),
            source: 'auto'
          };
          chat.longTermMemory.push(newMemoryEntry);
          await db.chats.put(chat);
          console.log('Ëá™Âä®ÊÄªÁªìÊàêÂäüÔºöÂ∑≤ÊàêÂäüÊ∑ªÂä† 1 Êù°Êñ∞ÁöÑÈïøÊúüËÆ∞ÂøÜÔºÅ');
        } else {
          throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÁöÑÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÁöÑÊÄªÁªìÂÜÖÂÆπ„ÄÇ");
        }
      }

      chat.lastMemorySummaryTimestamp = messagesToSummarize.slice(-1)[0].timestamp;
      await db.chats.put(chat);

      if (document.getElementById('long-term-memory-screen').classList.contains('active')) {
        renderLongTermMemoryList();
      }
    } catch (error) {
      console.error("ÊÄªÁªìÈïøÊúüËÆ∞ÂøÜÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÊÄªÁªìÂ§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }

  function startReplyToMessage() {
    if (!activeMessageTimestamp) return;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp && !m.isHidden);
    if (!message) return;


    let senderDisplayName;
    if (message.role === 'user') {
      senderDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    } else {
      if (chat.isGroup) {

        senderDisplayName = getDisplayNameInGroup(chat, message.senderName);
      } else {

        senderDisplayName = chat.name;
      }
    }


    const fullContent = String(message.content || '');
    let previewSnippet = '';

    if (typeof message.content === 'string' && STICKER_REGEX.test(message.content)) {
      previewSnippet = '[Ë°®ÊÉÖ]';
    } else if (message.type === 'ai_image' || message.type === 'user_photo') {
      previewSnippet = '[ÂõæÁâá]';
    } else if (message.type === 'voice_message') {
      previewSnippet = '[ËØ≠Èü≥]';
    } else {
      previewSnippet = fullContent.substring(0, 50) + (fullContent.length > 50 ? '...' : '');
    }

    currentReplyContext = {
      timestamp: message.timestamp,
      senderName: senderDisplayName,
      content: fullContent,
    };

    const previewBar = document.getElementById('reply-preview-bar');
    previewBar.querySelector('.sender').textContent = `ÂõûÂ§ç ${currentReplyContext.senderName}:`;
    previewBar.querySelector('.text').textContent = previewSnippet;
    previewBar.style.display = 'block';

    hideMessageActions();
    document.getElementById('chat-input').focus();
  }

  function cancelReplyMode() {
    currentReplyContext = null;
    document.getElementById('reply-preview-bar').style.display = 'none';
  }





  let activeTransferTimestamp = null;

 
  function showTransferActionModal(timestamp) {
    activeTransferTimestamp = timestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (message) {

      document.getElementById('transfer-sender-name').textContent = message.senderName;
    }
    document.getElementById('transfer-actions-modal').classList.add('visible');
  }

  
  function hideTransferActionModal() {
    document.getElementById('transfer-actions-modal').classList.remove('visible');
    activeTransferTimestamp = null;
  }

  
  




  async function renderCallHistoryScreen() {
    showScreen('call-history-screen');

    const listEl = document.getElementById('call-history-list');
    const titleEl = document.getElementById('call-history-title');
    listEl.innerHTML = '';
    titleEl.textContent = 'ÊâÄÊúâÈÄöËØùËÆ∞ÂΩï';

    const records = await db.callRecords.orderBy('timestamp').reverse().toArray();

    if (records.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÈÄöËØùËÆ∞ÂΩïÂì¶~</p>';
      return;
    }

    records.forEach(record => {
      const card = createCallRecordCard(record);

      addLongPressListener(card, async () => {

        const newName = await showCustomPrompt(
          "Ëá™ÂÆö‰πâÈÄöËØùÂêçÁß∞",
          "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂêçÁß∞ÔºàÁïôÁ©∫ÂàôÊÅ¢Â§çÈªòËÆ§Ôºâ",
          record.customName || ''
        );


        if (newName === null) return;


        await db.callRecords.update(record.id, {
          customName: newName.trim()
        });


        await renderCallHistoryScreen();


        await showCustomAlert('ÊàêÂäü', 'ÈÄöËØùÂêçÁß∞Â∑≤Êõ¥Êñ∞ÔºÅ');
      });
      listEl.appendChild(card);
    });
  }



  function createCallRecordCard(record) {
    const card = document.createElement('div');
    card.className = 'call-record-card';
    card.dataset.recordId = record.id;


    const chatInfo = state.chats[record.chatId];
    const chatName = chatInfo ? chatInfo.name : 'Êú™Áü•‰ºöËØù';

    const callDate = new Date(record.timestamp);
    const dateString = `${callDate.getFullYear()}-${String(callDate.getMonth() + 1).padStart(2, '0')}-${String(callDate.getDate()).padStart(2, '0')} ${String(callDate.getHours()).padStart(2, '0')}:${String(callDate.getMinutes()).padStart(2, '0')}`;
    const durationText = `${Math.floor(record.duration / 60)}ÂàÜ${record.duration % 60}Áßí`;

    const avatarsHtml = record.participants.map(p =>
      `<img src="${p.avatar}" alt="${p.name}" class="participant-avatar" title="${p.name}">`
    ).join('');

    card.innerHTML = `
                <div class="card-header">
                    <span class="date">${dateString}</span>
                    <span class="duration">${durationText}</span>
                </div>
                <div class="card-body">
                    <!-- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊñ∞Â¢û‰∏Ä‰∏™Ê†áÈ¢òË°å -->
                    ${record.customName ? `<div class="custom-title">${record.customName}</div>` : ''}
                    
                    <div class="participants-info"> <!-- Êñ∞Â¢û‰∏Ä‰∏™ÂÆπÂô®Êñπ‰æøÂ∏ÉÂ±Ä -->
                        <div class="participants-avatars">${avatarsHtml}</div>
                        <span class="participants-names">‰∏é ${chatName}</span>
                    </div>
                </div>
            `;
    return card;
  }



  async function showCallTranscript(recordId) {
    const record = await db.callRecords.get(recordId);
    if (!record) return;

    const modal = document.getElementById('call-transcript-modal');
    const titleEl = document.getElementById('transcript-modal-title');
    const bodyEl = document.getElementById('call-transcript-modal-body');

    titleEl.textContent = `ÈÄöËØù‰∫é ${new Date(record.timestamp).toLocaleString()} (Êó∂Èïø: ${Math.floor(record.duration / 60)}ÂàÜ${record.duration % 60}Áßí)`;
    bodyEl.innerHTML = '';

    const deleteBtn = document.getElementById('delete-transcript-btn');
    const summarizeBtn = document.getElementById('manual-summarize-btn');

    if (!record.transcript || record.transcript.length === 0) {
      bodyEl.innerHTML = '<p style="text-align:center; color: #8a8a8a;">ËøôÊ¨°ÈÄöËØùÊ≤°ÊúâÁïô‰∏ãÊñáÂ≠óËÆ∞ÂΩï„ÄÇ</p>';
      summarizeBtn.style.display = 'none';
    } else {
      summarizeBtn.style.display = 'block';
      record.transcript.forEach(entry => {
        const bubble = document.createElement('div');
        bubble.className = `transcript-entry ${entry.role}`;
        bubble.textContent = entry.content;
        bodyEl.appendChild(bubble);
      });
    }

    const newDeleteBtn = deleteBtn.cloneNode(true);
    deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
    const newSummarizeBtn = summarizeBtn.cloneNode(true);
    summarizeBtn.parentNode.replaceChild(newSummarizeBtn, summarizeBtn);

    newDeleteBtn.addEventListener('click', async () => {
      const confirmed = await showCustomConfirm(
        "Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°ÈÄöËØùËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", {
          confirmButtonClass: 'btn-danger'
        }
      );
      if (confirmed) {
        modal.classList.remove('visible');
        await db.callRecords.delete(recordId);
        await renderCallHistoryScreen();
        alert('ÈÄöËØùËÆ∞ÂΩïÂ∑≤Âà†Èô§„ÄÇ');
      }
    });



    newSummarizeBtn.addEventListener('click', async () => {

      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Êìç‰Ωú',
        'ËøôÂ∞ÜÊèêÂèñÂΩìÂâçÈÄöËØùËÆ∞ÂΩïÂèëÈÄÅÁªôAIËøõË°åÊÄªÁªìÔºå‰ºöÊ∂àËÄóAPIÈ¢ùÂ∫¶„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
          confirmText: 'Á°ÆËÆ§ÊÄªÁªì'
        }
      );


      if (!confirmed) return;

      modal.classList.remove('visible');
      const chat = state.chats[record.chatId];
      if (!chat) {
        alert('ÈîôËØØÔºöÊâæ‰∏çÂà∞ËØ•ÈÄöËØùËÆ∞ÂΩïÊâÄÂ±ûÁöÑËÅäÂ§©ÂØπË±°„ÄÇ');
        return;
      }

      await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËøõË°åÊâãÂä®ÊÄªÁªì...");

      try {
        const transcriptText = record.transcript.map(h => {
          const sender = h.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (h.senderName || chat.name);
          return `${sender}: ${h.content}`;
        }).join('\n');

        await summarizeCallTranscript(record.chatId, transcriptText);

        await showCustomAlert("ÊÄªÁªìÊàêÂäü", `ÊâãÂä®ÊÄªÁªìÂ∑≤ÂÆåÊàêÔºÅÊñ∞ÁöÑËÆ∞ÂøÜÂ∑≤Ê∑ªÂä†Âà∞‚Äú${chat.name}‚ÄùÁöÑÈïøÊúüËÆ∞ÂøÜ‰∏≠„ÄÇ`);

      } catch (error) {
        await showCustomAlert("ÊÄªÁªìÂ§±Ë¥•", `Êìç‰ΩúÂ§±Ë¥•ÔºåÊú™ËÉΩÁîüÊàêÈïøÊúüËÆ∞ÂøÜ„ÄÇ\n\nÈîôËØØËØ¶ÊÉÖ: ${error.message}`);
      }
    });





    const closeBtn = document.getElementById('close-transcript-modal-btn');
    const newCloseBtn = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

    newCloseBtn.addEventListener('click', () => {
      modal.classList.remove('visible');
    });


    modal.classList.add('visible');
  }


  async function handleEditStatusClick() {

    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) {
      return;
    }
    const chat = state.chats[state.activeChatId];


    const newStatusText = await showCustomPrompt(
      'ÁºñËæëÂØπÊñπÁä∂ÊÄÅ',
      'ËØ∑ËæìÂÖ•ÂØπÊñπÁé∞Âú®ÁöÑÊñ∞Áä∂ÊÄÅÔºö',
      chat.status.text
    );


    if (newStatusText !== null) {

      chat.status.text = newStatusText.trim() || 'Âú®Á∫ø';
      chat.status.isBusy = false;
      chat.status.lastUpdate = Date.now();
      await db.chats.put(chat);


      renderChatInterface(state.activeChatId);
      renderChatList();


      await showCustomAlert('Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', `‚Äú${chat.name}‚ÄùÁöÑÂΩìÂâçÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫Ôºö${chat.status.text}`);
    }
  }


  async function openShareTargetPicker() {
    const modal = document.getElementById('share-target-modal');
    const listEl = document.getElementById('share-target-list');
    listEl.innerHTML = '';


    const chats = Object.values(state.chats);

    chats.forEach(chat => {

      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.innerHTML = `
                    <input type="checkbox" class="share-target-checkbox" data-chat-id="${chat.id}" style="margin-right: 15px;">
                    <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
                    <span class="name">${chat.name}</span>
                `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }

  function closeMusicPlayerWithAnimation(callback) {
    const overlay = document.getElementById('music-player-overlay');
    if (!overlay.classList.contains('visible')) {
      if (callback) callback();
      return;
    }
    overlay.classList.remove('visible');
    setTimeout(() => {
      document.getElementById('music-playlist-panel').classList.remove('visible');
      if (callback) callback();
    }, 400);
  }

  function parseLRC(lrcContent) {
    if (!lrcContent) return [];
    const lines = String(lrcContent).split(/\r\n?|\n/);
    const lyrics = [];
    const timeRegex = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/g;
    for (const line of lines) {
      const text = line.replace(timeRegex, '').trim();
      if (!text) continue;
      timeRegex.lastIndex = 0;
      let match;
      while ((match = timeRegex.exec(line)) !== null) {
        const minutes = parseInt(match[1], 10);
        const seconds = parseInt(match[2], 10);
        const milliseconds = parseInt(match[3].padEnd(3, '0'), 10);
        const time = minutes * 60 + seconds + milliseconds / 1000;
        lyrics.push({
          time,
          text
        });
      }
    }
    return lyrics.sort((a, b) => a.time - b.time);
  }

  function renderLyrics() {
    const lyricsList = document.getElementById('music-lyrics-list');
    lyricsList.innerHTML = '';
    if (!musicState.parsedLyrics || musicState.parsedLyrics.length === 0) {
      lyricsList.innerHTML = '<div class="lyric-line">‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™</div>';
      return;
    }
    musicState.parsedLyrics.forEach((line, index) => {
      const lineEl = document.createElement('div');
      lineEl.className = 'lyric-line';
      lineEl.textContent = line.text;
      lineEl.dataset.index = index;
      lyricsList.appendChild(lineEl);
    });
    lyricsList.style.transform = `translateY(0px)`;
  }

  function updateIslandScrollAnimation() {
  
  }

  function checkLyricScroll() {

    if (!islandLyricText || !islandLyricContainer) return;

    const textWidth = islandLyricText.scrollWidth;
    const containerWidth = islandLyricContainer.clientWidth;


    if (textWidth > containerWidth) {

      const scrollRatio = textWidth / containerWidth;
      const animationDuration = Math.max(5, scrollRatio * 5);


      islandLyricText.style.setProperty('--animation-duration', `${animationDuration}s`);
      islandLyricText.style.setProperty('--container-width', `${containerWidth}px`);
      islandLyricText.style.setProperty('--text-width', `${textWidth}px`);


      islandLyricText.classList.add('scrolling');
    } else {

      islandLyricText.classList.remove('scrolling');
    }
  }

 

  function updateActiveLyric(currentTime) {
    if (musicState.parsedLyrics.length === 0) return;
    let newLyricIndex = -1;
    for (let i = 0; i < musicState.parsedLyrics.length; i++) {
      if (currentTime >= musicState.parsedLyrics[i].time) {
        newLyricIndex = i;
      } else {
        break;
      }
    }
    if (newLyricIndex === musicState.currentLyricIndex) return;
    musicState.currentLyricIndex = newLyricIndex;
    updateLyricsUI();

    const singleLyricEl = document.getElementById('single-lyric-display');
    if (singleLyricEl) {
      if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
        singleLyricEl.textContent = musicState.parsedLyrics[newLyricIndex].text;
      } else {
        singleLyricEl.textContent = '‚ô™ ‚ô™ ‚ô™';
      }
    }

    const lyricBar = document.getElementById('global-lyrics-bar');
    if (lyricBar.classList.contains('visible')) {
      if (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) {
        lyricBar.textContent = musicState.parsedLyrics[newLyricIndex].text;
      } else {
        lyricBar.textContent = '‚ô™';
      }
    }

  
    if (phoneScreenForIsland.classList.contains('dynamic-island-active')) {
      const lyricText = (newLyricIndex > -1 && musicState.parsedLyrics[newLyricIndex]) ?
        musicState.parsedLyrics[newLyricIndex].text :
        '‚ô™ ‚ô™ ‚ô™';

    
      const firstSpan = islandLyricText.querySelector('span:first-child');
      if (firstSpan && firstSpan.textContent === lyricText) {
        return;
      }

     
      islandLyricText.style.opacity = 0;

     
      setTimeout(() => {
        

      
        islandLyricText.classList.remove('scrolling');
        islandLyricContainer.classList.remove('center-content');
        islandLyricText.style.animation = 'none';

        let span1 = islandLyricText.querySelector('span:first-child');
        let span2 = islandLyricText.querySelector('span:last-child');
        if (!span1) {
          span1 = document.createElement('span');
          islandLyricText.appendChild(span1);
        }
        if (!span2) {
          span2 = document.createElement('span');
          islandLyricText.appendChild(span2);
        }

        span1.textContent = lyricText;
        span2.textContent = lyricText;

        const textWidth = span1.offsetWidth;
        const containerWidth = islandLyricContainer.clientWidth;

       
        if (textWidth > containerWidth) {
          
          const scrollRatio = textWidth / containerWidth;
          const duration = Math.max(5, scrollRatio * 5);

          islandLyricText.style.setProperty('--marquee-duration', `${duration}s`);
          islandLyricText.classList.add('scrolling');
       
          islandLyricText.style.animation = `marquee var(--marquee-duration, 10s) linear infinite`;
        } else {
        
          islandLyricContainer.classList.add('center-content');
        }

      

     
        islandLyricText.style.opacity = 1;

      }, 200);
    }
 
  }


  function updateLyricsUI(isFullscreen = false) {
    const listSelector = isFullscreen ? '#fullscreen-lyrics-container .music-lyrics-list' : '#music-lyrics-container #music-lyrics-list';
    const containerSelector = isFullscreen ? '#fullscreen-lyrics-container' : '#music-lyrics-container';

    const lyricsList = document.querySelector(listSelector);
    const container = document.querySelector(containerSelector);
    if (!lyricsList || !container) return;

    const lines = lyricsList.querySelectorAll('.lyric-line');
    lines.forEach(line => line.classList.remove('active'));

    if (musicState.currentLyricIndex === -1) {
      lyricsList.style.transform = `translateY(0px)`;
      return;
    }

    const activeLine = lyricsList.querySelector(`.lyric-line[data-index="${musicState.currentLyricIndex}"]`);
    if (activeLine) {
      activeLine.classList.add('active');
      const containerHeight = container.offsetHeight;
      const offset = (containerHeight / 2.2) - activeLine.offsetTop - (activeLine.offsetHeight / 2);
      lyricsList.style.transform = `translateY(${offset}px)`;
    }
  }

  function formatMusicTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${String(remainingSeconds).padStart(2, '0')}`;
  }

  let lastTimeUpdate = 0;
  let animationFrameId;

  function updateMusicProgressBar() {
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
    }

    function step() {
      if (!musicState.isPlaying || !audioPlayer.duration) {
        return;
      }

      const now = performance.now();
      const currentTime = audioPlayer.currentTime;
      const duration = audioPlayer.duration;

      const progressPercent = (currentTime / duration) * 100;
      document.getElementById('music-progress-fill').style.width = `${progressPercent}%`;

      if (now - lastTimeUpdate > 1000) {
        document.getElementById('music-current-time').textContent = formatMusicTime(currentTime);
        document.getElementById('music-total-time').textContent = formatMusicTime(duration);
        updateActiveLyric(currentTime);
        updateIslandScrollAnimation();
        lastTimeUpdate = now;
      }

      
      animationFrameId = requestAnimationFrame(step);
    }

    animationFrameId = requestAnimationFrame(step);
  }



  function openAiResponseEditor() {
    if (!lastRawAiResponse) {
      alert("ËøòÊ≤°ÊúâÂèØ‰æõÁºñËæëÁöÑAIÂìçÂ∫î„ÄÇËØ∑ÂÖàËÆ©AIÂõûÂ§ç‰∏ÄÊ¨°„ÄÇ");
      return;
    }

    const editorModal = document.getElementById('ai-response-editor-modal');
    const editorContainer = document.getElementById('ai-response-editor-container');
    editorContainer.innerHTML = '';


    const actionObjects = parseAiResponse(lastRawAiResponse);

    if (actionObjects && actionObjects.length > 0) {

      actionObjects.forEach(actionObj => {


        if (typeof actionObj === 'object' && actionObj !== null) {
          try {

            const formattedJson = JSON.stringify(actionObj, null, 2);
            const block = createAiResponseEditorBlock(formattedJson);
            editorContainer.appendChild(block);
          } catch (e) {

            console.error("Âú®ÂØºÊºîÊ®°Âºè‰∏ã stringify Â§±Ë¥•:", actionObj, e);
          }
        } else if (typeof actionObj === 'string') {

          const block = createAiResponseEditorBlock(actionObj);
          editorContainer.appendChild(block);
          console.warn("Âú®ÂØºÊºîÊ®°Âºè‰∏≠ÂèëÁé∞‰∏Ä‰∏™Êó†ÊïàÁöÑÁâáÊÆµ (Êù•Ëá™parseAiResponseÁöÑÊñáÊú¨ÂõûÈÄÄ):", actionObj);
        }
      });
    } else {

      const block = createAiResponseEditorBlock(lastRawAiResponse);
      editorContainer.appendChild(block);
    }


    editorModal.classList.add('visible');
  }


 
  function createAiResponseEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'ai-response-editor-block';


    const templates = {
      text: {
        type: 'text',
        content: 'Âú®ËøôÈáåËæìÂÖ•ÊñáÊú¨...'
      },
      sticker: {
        type: 'sticker',
        url: 'https://...',
        meaning: 'Ë°®ÊÉÖÂê´‰πâ'
      },
      image: {
        type: 'ai_image',
        description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞...'
      },
      voice: {
        type: 'voice_message',
        content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ...'
      },
      transfer: {
        type: 'transfer',
        amount: 5.20,
        note: '‰∏ÄÁÇπÂøÉÊÑè'
      },
      offline: {
        type: 'offline_text',
        content: '„ÄåÂú®ËøôÈáåËæìÂÖ•ÂØπËØùÂÜÖÂÆπ„Äç\\n(Âú®ËøôÈáåËæìÂÖ•Âä®‰ΩúÊàñÁéØÂ¢ÉÊèèÂÜô)'
      },
      quote: {
        type: 'quote_reply',
        target_timestamp: 1234567890,
        reply_content: 'Âú®ËøôÈáåËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπ'
      },
      
      nai: {
        type: 'naiimag',
        prompt: '1girl, best quality, masterpiece, ...'
      },
      narration: {
            type: 'narration',
            content: 'Âú®ËøôÈáåËæìÂÖ•ÁéØÂ¢ÉÊàñÂøÉÁêÜÊèèÂÜô...'
        }
      
  
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°Âä®‰Ωú">√ó</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.text)}'>ÊñáÊú¨</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.sticker)}'>Ë°®ÊÉÖ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.offline)}'>Á∫ø‰∏ã</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.quote)}'>ÂºïÁî®</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.nai)}' style="color: #6a329f; border-color: #6a329f;">NAIÁîüÂõæ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.narration)}' style="color: #888; border-color: #ccc;">ÊóÅÁôΩ</button>
            
            </div>
    `;


    block.querySelector('.delete-block-btn').addEventListener('click', () => {
      block.remove();
    });


    block.querySelectorAll('.format-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const templateStr = btn.dataset.template;
        const textarea = block.querySelector('textarea');
        if (templateStr && textarea) {
          try {
            const templateObj = JSON.parse(templateStr);

            textarea.value = JSON.stringify(templateObj, null, 2);
            textarea.focus();
          } catch (e) {
            console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
          }
        }
      });
    });

    return block;
  }


  async function saveEditedAiResponse() {

    const chatsToUpdate = new Map();
    let oldMessageTimestampProvider = null;

    if (lastPrivateMessagesSent.length > 0) {
      console.log(`ÂØºÊºîÂâ™ËæëÂÆ§ÔºöÊ≠£Âú®Êí§ÈîÄ ${lastPrivateMessagesSent.length} Êù°‰∏ä‰∏ÄËΩÆÂèëÈÄÅÁöÑÁßÅ‰ø°...`);

      const oldPrivateMessages = [...lastPrivateMessagesSent];
      oldMessageTimestampProvider = oldPrivateMessages.values();

      const chatIdsToUndo = [...new Set(oldPrivateMessages.map(ref => ref.chatId))];

      for (const chatId of chatIdsToUndo) {
        const chat = await db.chats.get(chatId);
        if (chat) {
          chatsToUpdate.set(chatId, chat);
        }
      }

      for (const msgRef of oldPrivateMessages) {
        const chat = chatsToUpdate.get(msgRef.chatId);
        if (chat) {
          chat.history = chat.history.filter(msg => msg.timestamp !== msgRef.timestamp);
        }
      }

      if (chatsToUpdate.size > 0) {
        await db.chats.bulkPut(Array.from(chatsToUpdate.values()));
      }

      lastPrivateMessagesSent = [];
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    const editorContainer = document.getElementById('ai-response-editor-container');
    const editorTextareas = editorContainer.querySelectorAll('textarea');
    const editedRawBlocks = Array.from(editorTextareas).map(ta => ta.value.trim()).filter(Boolean);


   
    const originalAiMessages = chat.history.filter(msg => lastResponseTimestamps.includes(msg.timestamp));
    chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));


    if (editedRawBlocks.length === 0) {
      await db.chats.put(chat);
      renderChatInterface(state.activeChatId);
      renderChatList();
      document.getElementById('ai-response-editor-modal').classList.remove('visible');
      lastRawAiResponse = '';
      lastResponseTimestamps = [];
      return;
    }


    let newMessagesArray = [];
    for (const rawContent of editedRawBlocks) {
      try {

        const parsedObject = JSON.parse(rawContent);
        newMessagesArray.push(parsedObject);
      } catch (e) {
        console.warn("Ë∑≥Ëøá‰∏Ä‰∏™Êó†Ê≥ïËß£Êûê‰∏∫JSONÁöÑÁºñËæëÂùó:", rawContent);
      }
    }



    const originalNaiMsgs = originalAiMessages.filter(m => m.type === 'naiimag');
    let naiMsgIndex = 0;
 

    let newTimestamps = [];
    let messageTimestamp = Date.now();
    const privateChatsToSave = new Map();
    const groupChatsToSave = new Map();
    for (const msgData of newMessagesArray) {
      if (!msgData || typeof msgData !== 'object' || !msgData.type) {
        console.warn("Âú®ÂØºÊºîÊ®°Âºè‰øùÂ≠òÊó∂ÔºåÂèëÁé∞Êó†ÊïàÁöÑÊåá‰ª§ÂØπË±°ÔºåÂ∑≤Ë∑≥Ëøá:", msgData);
        continue;
      }

      let aiMessage = null;
      const baseMessage = {
        role: 'assistant',
        senderName: msgData.name || chat.originalName,
        timestamp: messageTimestamp++
      };

      switch (msgData.type) {
case 'narration':
        aiMessage = {
            ...baseMessage,
            type: 'narration',
            content: String(msgData.content),
            role: 'system' // Âº∫Âà∂ËÆæ‰∏∫ system ËßíËâ≤‰ª•Á°Æ‰øùÊ†∑ÂºèÊ≠£Á°Æ
        };
        break;
    case 'buy_item': {
    const itemName = msgData.item_name;
    const price = parseFloat(msgData.price);
    const reason = msgData.reason || 'ÊÉ≥‰π∞';

    if (!itemName || isNaN(price) || price <= 0) continue; // Êï∞ÊçÆÊó†ÊïàË∑≥Ëøá

    // 1. ÈáçÊñ∞Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÔºàÁ°Æ‰øùÂÆûÊó∂ÊÄßÔºâ
    const currentWallet = await db.userWallet.get('main');
    const cardIndex = currentWallet?.kinshipCards?.findIndex(c => c.chatId === chat.id);

    if (cardIndex > -1) {
        const card = currentWallet.kinshipCards[cardIndex];
        const remaining = card.limit - (card.spent || 0);

        if (remaining >= price) {
            // 2. ÊâßË°åÊâ£Ê¨æ
            currentWallet.kinshipCards[cardIndex].spent = (card.spent || 0) + price;
            await db.userWallet.put(currentWallet);

            // 3. ËÆ∞ÂΩïË¥¶Âçï
            await db.userTransactions.add({
                timestamp: Date.now(),
                type: 'expense',
                amount: price,
                description: `‰∫≤Â±ûÂç°Ê∂àË¥π-${chat.name}-${itemName}`
            });

            // 4. ÁîüÊàêÁ≥ªÁªüÈÄöÁü•Ê∂àÊÅØ (AIÂèëÈÄÅÁöÑ)
            const successMsg = {
                role: 'assistant', // ÊàñËÄÖÊòØ 'system'ÔºåÁúã‰Ω†ÂñúÂ•Ω
                senderName: chat.name, // Âä†‰∏äËøô‰∏™Á°Æ‰øùÁæ§ËÅäÊòæÁ§∫Ê≠£Â∏∏
                type: 'text', // ÊàñËÄÖÁî® 'pat_message' Ê†∑Âºè
                content: `[ÊîØ‰ªòÂÆùÈÄöÁü•] Êàë‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price.toFixed(2)} Ë¥≠‰π∞‰∫Ü‚Äú${itemName}‚Äù„ÄÇ\nüí≠ ${reason}`,
                timestamp: messageTimestamp++
            };
            
            chat.history.push(successMsg);
            
            // Â¶ÇÊûúÊòØÂΩìÂâçÊü•ÁúãÁöÑËÅäÂ§©ÔºåÁõ¥Êé•‰∏äÂ±è
            if (isViewingThisChat) {
                 appendMessage(successMsg, chat);
            } else {
                 // Â¶ÇÊûúÂú®ÂêéÂè∞ÔºåÂèëÈÄÅÈÄöÁü•
                 showNotification(chat.id, `${chat.name} ‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π‰∫Ü ¬•${price}`);
            }
            
            // 5. (ÂèØÈÄâ) Â∞ÜË¥≠‰π∞ËÆ∞ÂΩïÂÜôÂÖ•ËßíËâ≤ÁöÑÊ®°ÊãüÊ∑òÂÆùÂéÜÂè≤ÔºåÂ¢ûÂä†ÁúüÂÆûÊÑü
            if (!chat.simulatedTaobaoHistory) chat.simulatedTaobaoHistory = { totalBalance: 0, purchases: [] };
            if (!chat.simulatedTaobaoHistory.purchases) chat.simulatedTaobaoHistory.purchases = [];
            
            chat.simulatedTaobaoHistory.purchases.unshift({
                itemName: itemName,
                price: price,
                status: 'Â∑≤Á≠æÊî∂',
                reason: reason,
                image_prompt: `${itemName}, product photography` // ÁÆÄÂçïÁîüÊàê‰∏™prompt
            });
            
            hasPerformedMajorAction = true; // Ê†áËÆ∞‰∏∫Â∑≤ÊâßË°åÈáçË¶ÅÊìç‰ΩúÔºàÁî®‰∫éÂêéÂè∞Ê¥ªÂä®Ôºâ
        } else {
            console.log(`AI ÊÉ≥Ë¶ÅË¥≠‰π∞ ${itemName} (¬•${price}) ‰ΩÜ‰∫≤Â±ûÂç°‰ΩôÈ¢ù‰∏çË∂≥ (Ââ© ¬•${remaining})`);
            // ÂèØÈÄâÔºöËÆ© AI Âèë‰∏ÄÊù°Ê∂àÊÅØÊä±ÊÄ®Ê≤°Èí±‰∫Ü
            const failMsg = {
                role: 'assistant',
                senderName: chat.name,
                content: `Êú¨Êù•ÊÉ≥‰π∞‚Äú${itemName}‚ÄùÁöÑÔºå‰ΩÜÊòØ‰∫≤Â±ûÂç°È¢ùÂ∫¶Â•ΩÂÉè‰∏çÂ§ü‰∫Ü... (¬•${price})`,
                timestamp: messageTimestamp++
            };
            chat.history.push(failMsg);
            if (isViewingThisChat) appendMessage(failMsg, chat);
        }
    }
    continue;
}
        case 'send_private_message': {
          const senderOriginalName = msgData.name;
          const recipientOriginalName = msgData.recipient;
          const userOriginalName = state.qzoneSettings.nickname || '{{user}}';

          if (recipientOriginalName === userOriginalName) {
            const privateChat = Object.values(state.chats).find(c => !c.isGroup && c.originalName === senderOriginalName);

            if (privateChat) {

              if (!privateChatsToSave.has(privateChat.id)) {

                const freshPrivateChat = chatsToUpdate.get(privateChat.id) || await db.chats.get(privateChat.id);

                privateChatsToSave.set(privateChat.id, freshPrivateChat);
              }

              const chatToUpdate = privateChatsToSave.get(privateChat.id);

              const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [msgData.content];
              let newMessagesCount = 0;

              for (const contentString of messagesToSend) {
                if (!contentString || !contentString.trim()) continue;

                const oldMsgRef = (oldMessageTimestampProvider) ? oldMessageTimestampProvider.next().value : null;

                const timestampToUse = (oldMsgRef && oldMsgRef.chatId === privateChat.id) ?
                  oldMsgRef.timestamp :
                  messageTimestamp++;

                const privateMessage = {
                  role: 'assistant',
                  senderName: senderOriginalName,
                  content: contentString,
                  timestamp: timestampToUse
                };


                lastPrivateMessagesSent.push({
                  chatId: privateChat.id,
                  timestamp: privateMessage.timestamp
                });

                chatToUpdate.history.push(privateMessage);
                newMessagesCount++;
              }

              if (newMessagesCount > 0) {
                if (state.activeChatId !== privateChat.id) {
                  chatToUpdate.unreadCount = (chatToUpdate.unreadCount || 0) + newMessagesCount;
                  showNotification(privateChat.id, `${privateChat.name} ÂèëÊù•‰∫Ü ${newMessagesCount} Êù°Êñ∞Ê∂àÊÅØ`);
                }
              }

              aiMessage = null;

            } else {
              console.warn(`AI ${senderOriginalName} Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°Ôºå‰ΩÜÊú™ÊâæÂà∞ÂÖ∂ÂØπÂ∫îÁöÑÁßÅËÅä‰ºöËØù„ÄÇ`);
              aiMessage = null;
            }
          } else {
            console.warn(`AI Â∞ùËØïÂèëÈÄÅÁßÅ‰ø°ÁªôÈùûÁî®Êà∑ËßíËâ≤ (${recipientOriginalName})ÔºåÊ≠§ÂäüËÉΩÊöÇ‰∏çÊîØÊåÅ„ÄÇ`);
            aiMessage = null;
          }

          continue;
        }
        case 'send_group_message': {
          const senderOriginalName = msgData.name || chat.originalName;
          const targetGroupName = msgData.targetGroupName;
          const messagesToSend = Array.isArray(msgData.content) ? msgData.content : [String(msgData.content)];

          if (!targetGroupName) {
            console.warn(`ÂØºÊºîÊ®°Âºè‰øùÂ≠ò(send_group_message): Êú™ÊåáÂÆö targetGroupNameÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`);
            continue;
          }

          // Êü•ÊâæÁõÆÊ†áÁæ§ËÅäÔºåÂπ∂Á°Æ‰øùAIÊòØËØ•Áæ§ÁöÑÊàêÂëò
          const targetGroupChat = Object.values(state.chats).find(c =>
            c.isGroup &&
            c.name === targetGroupName &&
            c.members.some(m => m.originalName === senderOriginalName)
          );

          if (targetGroupChat) {
            // Â¶ÇÊûúÁæ§ËÅäÂ∞öÊú™Ë¢´ÊöÇÂ≠òÔºåÂàô‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÊúÄÊñ∞Êï∞ÊçÆÂπ∂Â≠òÂÖ• Map
            if (!groupChatsToSave.has(targetGroupChat.id)) {
              const freshGroupChat = await db.chats.get(targetGroupChat.id);
              groupChatsToSave.set(targetGroupChat.id, freshGroupChat);
            }

            const chatToUpdate = groupChatsToSave.get(targetGroupChat.id);
            let newMessagesCount = 0;

            for (const contentString of messagesToSend) {
              if (!contentString || !contentString.trim()) continue;

              const groupMessage = {
                role: 'assistant',
                senderName: senderOriginalName,
                content: contentString,
                timestamp: messageTimestamp++ // ‰ΩøÁî®Áªü‰∏ÄÁöÑÊó∂Èó¥Êà≥ÈÄíÂ¢û
              };
              chatToUpdate.history.push(groupMessage);
              newMessagesCount++;
            }

            if (newMessagesCount > 0) {
              if (state.activeChatId !== targetGroupChat.id) {
                chatToUpdate.unreadCount = (chatToUpdate.unreadCount || 0) + newMessagesCount;
              }
            }
            aiMessage = null;
          } else {
            console.warn(`ÂØºÊºîÊ®°Âºè‰øùÂ≠ò(send_group_message): Êú™ÊâæÂà∞Áæ§ËÅä "${targetGroupName}" ÊàñËßíËâ≤ "${senderOriginalName}" ‰∏çÂú®ËØ•Áæ§‰∏≠„ÄÇ`);
            aiMessage = null;
          }
          continue; 
        }
        case 'thought_chain': {
           continue; 
        }
        case 'text':
          aiMessage = {
            ...baseMessage,
            content: String(msgData.content || msgData.message)
          };
          break;
        case 'sticker': {
          let found = false;
          if (msgData.url && msgData.meaning) {
            aiMessage = {
              ...baseMessage,
              type: 'sticker',
              content: msgData.url,
              meaning: msgData.meaning
            };
            found = true;
          } else if (msgData.meaning) {
            const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
            if (sticker) {
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: sticker.url,
                meaning: sticker.name
              };
              found = true;
            } else {
              aiMessage = {
                ...baseMessage,
                type: 'text',
                content: `[Ë°®ÊÉÖ: ${msgData.meaning}]`
              };
              found = true;
            }
          } else if (msgData.url) {
            aiMessage = {
              ...baseMessage,
              type: 'sticker',
              content: msgData.url
            };
            const stickerByURL = state.userStickers.find(s => s.url === msgData.url);
            aiMessage.meaning = stickerByURL ? stickerByURL.name : 'Êú™Áü•Ë°®ÊÉÖ';
            found = true;
          } else if (msgData.content && typeof msgData.content === 'string' && STICKER_REGEX.test(msgData.content)) {
            aiMessage = {
              ...baseMessage,
              type: 'sticker',
              content: msgData.content
            };
            const stickerByContentUrl = state.userStickers.find(s => s.url === msgData.content);
            aiMessage.meaning = stickerByContentUrl ? stickerByContentUrl.name : 'Êú™Áü•Ë°®ÊÉÖ';
            found = true;
          }
          if (!found) {
            console.error("ÂØºÊºîÊ®°Âºè‰øùÂ≠ò(Sticker): Êåá‰ª§Êó†ÊïàÊàñÁº∫Â∞ëÂøÖË¶ÅÂ≠óÊÆµ (meaning/url/content):", msgData);
            continue;
          }
          break;
        }
        case 'ai_image':
          aiMessage = {
            ...baseMessage,
            type: 'ai_image',
            content: msgData.description,
            image_prompt: msgData.image_prompt
          };
          break;

        case 'naiimag': {
          const newPrompt = msgData.prompt;
          let newImageUrl = null;
          let newFullPrompt = null;

         
          const originalMsg = originalNaiMsgs[naiMsgIndex];
          naiMsgIndex++; // Increment cursor for the next NAI block

          let promptChanged = false;

          if (originalMsg) {
           
            const originalPrompt = originalMsg.prompt;

            
            if (newPrompt && newPrompt !== originalPrompt) {
              console.log("NAI Prompt Â∑≤ÊîπÂèòÔºåÂ∞ÜËß¶ÂèëÈáçÊñ∞ÁîüÊàê„ÄÇ");
              promptChanged = true;
            } else {
          
              console.log("NAI Prompt Êú™ÊîπÂèòÔºåÂ∞Ü‰øùÁïôÂéüÂßãÂõæÁâá„ÄÇ");
              newImageUrl = originalMsg.imageUrl;
              newFullPrompt = originalMsg.fullPrompt;
            }
          } else {
           
            console.log("Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂéüÂßãNAIÂõæÁâá(ËøôÊòØÊñ∞Ê∑ªÂä†ÁöÑÂùó)ÔºåÂ∞ÜËß¶ÂèëÈáçÊñ∞ÁîüÊàê„ÄÇ");
            promptChanged = true;
          }

          if (promptChanged) {
          
            const alertMessage = originalMsg ? "Ê£ÄÊµãÂà∞NAIÊèêÁ§∫ËØçÂ∑≤‰øÆÊîπÔºåÊ≠£Âú®ÈáçÊñ∞ÁîüÊàê..." : "Ê£ÄÊµãÂà∞Êñ∞ÁöÑNAIÁîüÂõæÊåá‰ª§ÔºåÊ≠£Âú®ÁîüÊàê...";
            await showCustomAlert("ËØ∑Á®çÂÄô...", alertMessage);

            try {
              const generatedData = await generateNaiImageFromPrompt(newPrompt, chat.id);
              newImageUrl = generatedData.imageUrl;
              newFullPrompt = generatedData.fullPrompt;
              await showCustomAlert("ÊàêÂäü", "ÂõæÁâáÂ∑≤ÁîüÊàêÔºÅ");
            } catch (error) {
              console.error("ÂØºÊºîÊ®°Âºè‰∏ãÈáçÊñ∞ÁîüÊàêNAIÂõæÁâáÂ§±Ë¥•:", error);
              await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂõæÁâá: ${error.message}. \n\nÂ∞Ü‰øùÁïôÊóßÂõæÁâáÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ„ÄÇ`);

              if (originalMsg) {
                newImageUrl = originalMsg.imageUrl; // Fallback to old image
                newFullPrompt = originalMsg.fullPrompt;
              } else {
                console.error("Êñ∞NAIÂõæÁâáÁîüÊàêÂ§±Ë¥•ÔºåÊ≠§Êù°Ê∂àÊÅØÂ∑≤Ë¢´Ë∑≥Ëøá„ÄÇ");
                continue; // Skip this message
              }
            }
          }

       
          aiMessage = {
            ...baseMessage,
            type: 'naiimag',
            imageUrl: newImageUrl,
            prompt: newPrompt,
            fullPrompt: newFullPrompt
          };
          break;
        }
     

        case 'voice_message':
          aiMessage = {
            ...baseMessage,
            type: 'voice_message',
            content: msgData.content
          };
          break;
        case 'transfer':
          aiMessage = {
            ...baseMessage,
            type: 'transfer',
            amount: msgData.amount,
            note: msgData.note,
            receiverName: msgData.receiver || 'Êàë'
          };
          break;
        case 'waimai_request':
          aiMessage = {
            ...baseMessage,
            type: 'waimai_request',
            productInfo: msgData.productInfo,
            amount: msgData.amount,
            status: 'pending',
            countdownEndTime: Date.now() + 15 * 60 * 1000,
          };
          break;
        case 'offline_text':
          aiMessage = {
            ...baseMessage,
            ...msgData
          };
          break;
        case 'gomoku_move': {
          const gameState = gomokuState[chat.id];
          if (gameState) {
            const lastAiMoveIndex = gameState.history.findLastIndex(move => move.player === 2);
            if (lastAiMoveIndex > -1) {
              const move_to_undo = gameState.history[lastAiMoveIndex];
              gameState.board[move_to_undo.y][move_to_undo.x] = 0;
              gameState.history.splice(lastAiMoveIndex, 1);
              console.log(`ÂØºÊºîÊ®°ÂºèÊÇîÊ£ãÔºöÂ∑≤Êí§ÈîÄAIÂú® (${move_to_undo.x}, ${move_to_undo.y}) ÁöÑÊ£ãÊ≠•„ÄÇ`);
            }
          }
          const x = parseInt(msgData.x);
          const y = parseInt(msgData.y);
          if (!isNaN(x) && !isNaN(y)) {
            handleAiGomokuMove({
              x: x,
              y: y
            }, true);
          } else {
            console.warn("ÂØºÊºîÊ®°Âºè‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™Êó†ÊïàÁöÑ‰∫îÂ≠êÊ£ãÁßªÂä®Êåá‰ª§:", msgData);
          }
          continue;
        }
        case 'update_thoughts': {
          if (!chat.isGroup) {
            if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
            if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
            if (!Array.isArray(chat.thoughtsHistory)) chat.thoughtsHistory = [];
            chat.thoughtsHistory.push({
              heartfeltVoice: chat.heartfeltVoice,
              randomJottings: chat.randomJottings, 
              timestamp: Date.now()
            });
            if (chat.thoughtsHistory.length > 50) chat.thoughtsHistory.shift();
          }
          continue;
        }
        case 'quote_reply': { // ËøôÊòØÂú® saveEditedAiResponse() ÂáΩÊï∞‰∏≠ÁöÑ
                let originalMessage = null;
                let quoteContext = null;
        
               
                if (msgData.target_content) {
                  originalMessage = [...chat.history].reverse().find(m => 
                    !m.isHidden &&
                    (
                      m.content === msgData.target_content ||
                      (typeof m.content === 'string' && m.content.trim() === msgData.target_content.trim())
                    )
                  );
                   if(!originalMessage) {
                     console.warn(`[ÂØºÊºîÊ®°Âºè‰øùÂ≠òÂ§±Ë¥•] Â∞ùËØïÂºïÁî®ÂÜÖÂÆπ "${(msgData.target_content || '').substring(0, 20)}..."Ôºå‰ΩÜÂú®ÂéÜÂè≤‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
                   }
                } 
                
               
                else if (msgData.target_timestamp) { 
                  originalMessage = chat.history.find(m => m.timestamp === msgData.target_timestamp);
                }
        
              
                if (originalMessage) {
                      
                     
                      let quotedSenderDisplayName;
                      
                      if (originalMessage.role === 'user') {
                      
                          quotedSenderDisplayName = chat.settings.myNickname || 'Êàë';
                      } else { 
                         
                          if (chat.isGroup) {
                            
                              quotedSenderDisplayName = getDisplayNameInGroup(chat, originalMessage.senderName);
                          } else {
                           
                              quotedSenderDisplayName = chat.name;
                          }
                      }

                      quoteContext = {
                          timestamp: originalMessage.timestamp,
                          senderName: quotedSenderDisplayName, // ‰ΩøÁî®‰øÆÂ§çÂêéÁöÑÊòµÁß∞
                          content: String(originalMessage.content || '') // Á°Æ‰øùÂÜÖÂÆπÊòØÂ≠óÁ¨¶‰∏≤
                      };
                } else {
                 
                  console.warn(`ÂØºÊºîÊ®°Âºè‰øùÂ≠òÂºïÁî®Â§±Ë¥•: Êâæ‰∏çÂà∞ÁõÆÊ†áÊ∂àÊÅØ (Content: ${msgData.target_content}, TS: ${msgData.target_timestamp})`);
                }
        
                
                aiMessage = {
                  ...baseMessage,
                  content: msgData.reply_content
                };
                
                if (quoteContext) {
                  aiMessage.quote = quoteContext; 
                }
               
                
                break;
              }
        default:
          console.warn("Âú®ÂØºÊºîÊ®°Âºè‰øùÂ≠òÊó∂ÔºåÈÅáÂà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type, msgData);
          if (msgData.content) {
            aiMessage = {
              ...baseMessage,
              content: String(msgData.content)
            };
          } else {
            continue;
          }
          break;
      }

      if (aiMessage) {
        chat.history.push(aiMessage);
        newTimestamps.push(aiMessage.timestamp);
      }
    }

     if (groupChatsToSave.size > 0) {
        await db.chats.bulkPut(Array.from(groupChatsToSave.values()));
      }
    await db.chats.put(chat);

    if (privateChatsToSave.size > 0) {
      await db.chats.bulkPut(Array.from(privateChatsToSave.values()));
    }

    renderChatInterface(state.activeChatId);
    renderChatList();
    document.getElementById('ai-response-editor-modal').classList.remove('visible');


    lastRawAiResponse = editedRawBlocks.join('\n\n');
    lastResponseTimestamps = newTimestamps;


    await showCustomAlert("ÂØºÊºîÊ®°Âºè", "ÊÇ®ÁöÑ‰øÆÊîπÂ∑≤‰øùÂ≠òÔºÅ");
  }
 
  async function handleRecallClick() {
    if (!activeMessageTimestamp) return;

    const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000;
    const messageTime = activeMessageTimestamp;
    const now = Date.now();


    if (now - messageTime > RECALL_TIME_LIMIT_MS) {
      hideMessageActions();
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', 'ËØ•Ê∂àÊÅØÂèëÈÄÅÂ∑≤Ë∂ÖËøá2ÂàÜÈíüÔºåÊó†Ê≥ïÊí§Âõû„ÄÇ');
      return;
    }


    await recallMessage(messageTime, true);
    hideMessageActions();
  }

 
  async function recallMessage(timestamp, isUserRecall) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    const messageToRecall = chat.history[messageIndex];

    const recalledData = {
      originalType: messageToRecall.type || 'text',
      originalContent: messageToRecall.content,
      originalMeaning: messageToRecall.meaning,
      originalQuote: messageToRecall.quote
    };

    messageToRecall.type = 'recalled_message';
    messageToRecall.content = isUserRecall ? '‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ' : 'ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ';
    messageToRecall.recalledData = recalledData;
    delete messageToRecall.meaning;
    delete messageToRecall.quote;


    if (isUserRecall) {

      const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';


      let recalledContentText = '';
      if (recalledData.originalType === 'sticker') {
        recalledContentText = `[Ë°®ÊÉÖÔºåÂê´‰πâ: ${recalledData.originalMeaning || 'Êú™Áü•'}]`;
      } else if (recalledData.originalType === 'ai_image' || recalledData.originalType === 'user_photo') {
        recalledContentText = `[ÂõæÁâáÔºåÊèèËø∞: ${recalledData.originalContent}]`;
      } else {
        recalledContentText = `‚Äú${String(recalledData.originalContent)}‚Äù`;
      }


      const hiddenMessageForAI = {
        role: 'system',
        content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ôºà${myNickname}ÔºâÂàöÂàöÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ„ÄÇÊí§ÂõûÂâçÁöÑÂÜÖÂÆπÊòØÔºö${recalledContentText}„ÄÇËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫îÔºåÂèØ‰ª•Ë°®Áé∞Âá∫Â•ΩÂ•á„ÄÅÂºÄÁé©Á¨ëÔºàÊØîÂ¶Ç'ÊàëÊà™Âõæ‰∫ÜÔºÅ'Ôºâ„ÄÅÊàñËÄÖÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæË°®Á§∫ÁêÜËß£ÊàñÁñëÊÉë„ÄÇ]`,
        timestamp: Date.now(),
        isHidden: true
      };
      chat.history.push(hiddenMessageForAI);
    }


    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);

    if (isUserRecall) {
      renderChatList();

      //triggerAiResponse();
    }
  }



  
  async function openCategoryManager() {
    await renderCategoryListInManager();
    document.getElementById('world-book-category-manager-modal').classList.add('visible');
  }

 
  async function renderCategoryListInManager() {
    const listEl = document.getElementById('existing-categories-list');
    const categories = await db.worldBookCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
    }
    categories.forEach(cat => {

      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
                `;
      listEl.appendChild(item);
    });
  }

 
  async function addNewCategory() {
    const input = document.getElementById('new-category-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    const existing = await db.worldBookCategories.where('name').equals(name).first();
    if (existing) {
      alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
      return;
    }
    await db.worldBookCategories.add({
      name
    });
    input.value = '';
    await renderCategoryListInManager();
  }


  async function deleteCategory(categoryId) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâ‰∏ñÁïå‰π¶Â∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      }
    );
    if (confirmed) {
      await db.worldBookCategories.delete(categoryId);

      const booksToUpdate = await db.worldBooks.where('categoryId').equals(categoryId).toArray();
      for (const book of booksToUpdate) {
        book.categoryId = null;
        await db.worldBooks.put(book);
        const bookInState = state.worldBooks.find(wb => wb.id === book.id);
        if (bookInState) bookInState.categoryId = null;
      }
      await renderCategoryListInManager();
    }
  }


  async function publishToAnnouncementBoard() {
    if (!activeMessageTimestamp) return;

    const timestampToPublish = activeMessageTimestamp;
    hideMessageActions();

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToPublish);
    if (!message) return;


    let contentPreview = String(message.content || '').substring(0, 50) + '...';
    if (message.type === 'ai_image') contentPreview = '[ÂõæÁâá] ' + contentPreview;

    const confirmed = await showCustomConfirm(
      "ÂèëÂ∏ÉÂÖ¨Âëä",
      `Á°ÆÂÆöË¶ÅÂ∞Ü‰ª•‰∏ãÊ∂àÊÅØÂèëÂ∏ÉÂà∞ÂÖ¨ÂëäÊùøÂêóÔºü\n\n‚Äú${contentPreview}‚Äù`, {
        confirmText: "Á°ÆÂÆöÂèëÂ∏É"
      }
    );

    if (confirmed) {
      const myNickname = chat.settings.myNickname || 'Êàë';

      if (!Array.isArray(chat.announcements)) {
        chat.announcements = [];
      }


      const newAnnouncement = {
        id: 'anno_' + Date.now(),
        messageTimestamp: timestampToPublish,
        publisher: myNickname,
        publishedAt: Date.now(),
        isPinned: false
      };

      chat.announcements.push(newAnnouncement);

      const systemMessage = {
        role: 'system',
        type: 'pat_message',
        content: `${myNickname} ÂèëÂ∏É‰∫Ü‰∏ÄÊù°Êñ∞ÂÖ¨Âëä`,
        timestamp: Date.now()
      };
      chat.history.push(systemMessage);

      await db.chats.put(chat);
      appendMessage(systemMessage, chat);
      renderChatList();

      await showCustomAlert("ÊàêÂäü", "ÂÖ¨ÂëäÂ∑≤ÂèëÂ∏ÉÔºÅ");
    }
  }

 
  async function showAnnouncementBoard() {
    const chat = state.chats[state.activeChatId];
    const announcements = chat.announcements || [];

    if (!chat || announcements.length === 0) {
      showCustomAlert("ÊèêÁ§∫", "ÂΩìÂâçÁæ§ËÅäËøòÊ≤°ÊúâÂÖ¨ÂëäÂì¶„ÄÇ");
      return;
    }

    const contentEl = document.getElementById('announcement-board-content');
    contentEl.innerHTML = '';


    announcements.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));


    for (const anno of announcements) {
      const originalMessage = chat.history.find(m => m.timestamp === anno.messageTimestamp);

      const wrapper = document.createElement('div');
      wrapper.className = 'announcement-item-wrapper';

      if (originalMessage) {

        const messageBubbleEl = await createMessageElement(originalMessage, chat);
        if (messageBubbleEl) {
          wrapper.appendChild(messageBubbleEl);
        }
      } else {
        wrapper.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">ÂÖ¨ÂëäÁöÑÂéüÊ∂àÊÅØÂ∑≤Ë¢´Âà†Èô§„ÄÇ</p>';
      }

      if (anno.isPinned) {
        wrapper.innerHTML += `<div class="pinned-indicator">üìå</div>`;
      }
      wrapper.innerHTML += `<div class="announcement-item-actions" data-anno-id="${anno.id}">...</div>`;

      contentEl.appendChild(wrapper);
    }

    document.getElementById('announcement-board-modal').classList.add('visible');
  }


  let activeAnnouncementId = null;

 
  function showAnnouncementActions(annoId) {
    activeAnnouncementId = annoId;
    const chat = state.chats[state.activeChatId];
    const announcement = chat.announcements.find(a => a.id === annoId);
    if (!announcement) return;

    const pinButton = document.getElementById('announcement-action-pin');

    pinButton.textContent = announcement.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂÖ¨Âëä';

    document.getElementById('announcement-actions-modal').classList.add('visible');
  }

 
  async function handlePinAnnouncement() {
    if (!activeAnnouncementId) return;
    const chat = state.chats[state.activeChatId];
    const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
    if (announcement) {
      announcement.isPinned = !announcement.isPinned;
      await db.chats.put(chat);
      showAnnouncementBoard();
    }
    document.getElementById('announcement-actions-modal').classList.remove('visible');
  }

 
  async function handleDeleteAnnouncement() {
    if (!activeAnnouncementId) return;

    const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", {
      confirmButtonClass: 'btn-danger'
    });

    if (confirmed) {
      const chat = state.chats[state.activeChatId];

      chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
      await db.chats.put(chat);
      showAnnouncementBoard();
    }
    document.getElementById('announcement-actions-modal').classList.remove('visible');
  }




  let editingFrameForMember = false;
  let currentFrameSelection = {
    ai: null,
    my: null
  };

  function openFrameSelectorModal(type = 'chat') {
    const frameModal = document.getElementById('avatar-frame-modal');
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    editingFrameForMember = (type === 'member');

    if (editingFrameForMember) {
      const member = chat.members.find(m => m.id === editingMemberId);
      if (!member) return;
      currentFrameSelection.my = member.avatarFrame || '';
      populateFrameGrids(true, member.avatar, member.avatarFrame);
    } else {
      currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
      currentFrameSelection.my = chat.settings.myAvatarFrame || '';
      populateFrameGrids(false);
    }
    frameModal.classList.add('visible');
  }

  function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
    const aiFrameGrid = document.getElementById('ai-frame-grid');
    const myFrameGrid = document.getElementById('my-frame-grid');
    const chat = state.chats[state.activeChatId];
    aiFrameGrid.innerHTML = '';
    myFrameGrid.innerHTML = '';

    document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
    document.getElementById('ai-frame-content').style.display = 'block';
    document.getElementById('my-frame-content').style.display = 'none';
    document.getElementById('ai-frame-tab').classList.add('active');
    document.getElementById('my-frame-tab').classList.remove('active');

    if (isForMember) {
      avatarFrames.forEach(frame => {
        const item = createFrameItem(frame, 'my', memberAvatar);
        if (frame.url === memberFrame) {
          item.classList.add('selected');
        }
        aiFrameGrid.appendChild(item);
      });
    } else {
      const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
      const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
      avatarFrames.forEach(frame => {
        const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
        if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
        aiFrameGrid.appendChild(aiItem);
        const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
        if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
        myFrameGrid.appendChild(myItem);
      });
    }
  }

  function createFrameItem(frame, type, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.dataset.frameUrl = frame.url;
    item.title = frame.name;
    item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
    item.addEventListener('click', () => {
      currentFrameSelection[type] = frame.url;
      const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
      grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
    });
    return item;
  }

  async function saveSelectedFrames() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (editingFrameForMember) {
      const member = chat.members.find(m => m.id === editingMemberId);
      if (member) {
        member.avatarFrame = currentFrameSelection.my;
      }
    } else {
      chat.settings.aiAvatarFrame = currentFrameSelection.ai;
      chat.settings.myAvatarFrame = currentFrameSelection.my;
    }

    await db.chats.put(chat);



    if (!editingFrameForMember && !chat.isGroup) {
      const characterId = chat.id;


      for (const groupChat of Object.values(state.chats)) {
        if (groupChat.isGroup && groupChat.members) {

          const memberToUpdate = groupChat.members.find(m => m.id === characterId);


          if (memberToUpdate) {
            memberToUpdate.avatarFrame = chat.settings.aiAvatarFrame;

            await db.chats.put(groupChat);
            console.log(`Â∑≤ÂêåÊ≠•ËßíËâ≤ ${characterId} ÁöÑÂ§¥ÂÉèÊ°ÜÂà∞Áæ§ËÅä "${groupChat.name}"`);
          }
        }
      }
    }


    document.getElementById('avatar-frame-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    alert('Â§¥ÂÉèÊ°ÜÂ∑≤‰øùÂ≠òÂπ∂ÂêåÊ≠•ÔºÅ');
    editingFrameForMember = false;
  }





  function toggleFrameManagementMode() {
    isFrameManagementMode = !isFrameManagementMode;
    const manageBtn = document.getElementById('manage-frames-btn');
    const actionBar = document.getElementById('frame-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-frames-checkbox');


    document.querySelectorAll('.frame-grid').forEach(grid => {
      grid.classList.toggle('management-mode', isFrameManagementMode);
    });

    if (isFrameManagementMode) {
      manageBtn.textContent = 'ÂÆåÊàê';
      actionBar.style.display = 'flex';
      selectedFrames.clear();
      selectAllCheckbox.checked = false;
      updateDeleteFrameButton();
    } else {
      manageBtn.textContent = 'ÁÆ°ÁêÜ';
      actionBar.style.display = 'none';

      document.querySelectorAll('.frame-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
    }
  }


  function updateDeleteFrameButton() {
    const btn = document.getElementById('delete-selected-frames-btn');
    btn.textContent = `Âà†Èô§ (${selectedFrames.size})`;
  }

  
  function handleSelectAllFrames() {
    const isChecked = document.getElementById('select-all-frames-checkbox').checked;
    const visibleGrid = document.querySelector('.frame-content[style*="display: block"] .frame-grid');
    if (!visibleGrid) return;


    visibleGrid.querySelectorAll('.frame-item:has(.delete-btn)').forEach(item => {
      const frameId = parseInt(item.querySelector('.delete-btn').dataset.id);
      if (isNaN(frameId)) return;

      item.classList.toggle('selected', isChecked);
      if (isChecked) {
        selectedFrames.add(frameId);
      } else {
        selectedFrames.delete(frameId);
      }
    });
    updateDeleteFrameButton();
  }

  
  async function executeBatchDeleteFrames() {
    if (selectedFrames.size === 0) return;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedFrames.size} ‰∏™Ëá™ÂÆö‰πâÂ§¥ÂÉèÊ°ÜÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      }
    );

    if (confirmed) {
      const idsToDelete = [...selectedFrames];
      await db.customAvatarFrames.bulkDelete(idsToDelete);


      toggleFrameManagementMode();
      populateFrameGrids(editingFrameForMember);

      await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑÂ§¥ÂÉèÊ°ÜÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
    }
  }




  function applyGlobalCss(cssString) {
    const styleTag = document.getElementById('global-custom-style');
    if (styleTag) {

      styleTag.innerHTML = cssString || '';
    }
  }



  async function addMusicActionSystemMessage(actionText) {

    if (!musicState.isActive || !musicState.activeChatId) return;
    const chat = state.chats[musicState.activeChatId];
    if (!chat) return;


    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    const fullMessage = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ${actionText}]`;


    const systemMessage = {
      role: 'system',
      content: fullMessage,
      timestamp: Date.now(),
      isHidden: true
    };


    chat.history.push(systemMessage);
    await db.chats.put(chat);
  }




  async function handleLongScreenshot() {
    if (selectedMessages.size === 0) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    const screenshotBtn = document.getElementById('selection-screenshot-btn');
    const originalBtnText = screenshotBtn.textContent;
    screenshotBtn.textContent = 'ÁîüÊàê‰∏≠...';
    screenshotBtn.disabled = true;


    const screenshotContainer = document.createElement('div');
    const phoneScreen = document.getElementById('phone-screen');
    screenshotContainer.style.width = phoneScreen.offsetWidth + 'px';
    screenshotContainer.style.position = 'absolute';
    screenshotContainer.style.top = '-9999px';
    screenshotContainer.style.left = '-9999px';
    screenshotContainer.style.display = 'flex';
    screenshotContainer.style.flexDirection = 'column';
    screenshotContainer.style.height = 'auto';

    const chatScreen = document.getElementById('chat-interface-screen');
    screenshotContainer.style.backgroundImage = chatScreen.style.backgroundImage;
    screenshotContainer.style.backgroundColor = chatScreen.style.backgroundColor || (document.getElementById('phone-screen').classList.contains('dark-mode') ? '#000000' : '#f0f2f5');

    const tempStyle = document.createElement('style');
    tempStyle.innerHTML = `
                .message-bubble.selected::after { display: none !important; }
                .cloned-header .default-controls { display: flex !important; justify-content: space-between; align-items: center; width: 100%; }
                .cloned-header .selection-controls { display: none !important; }
            `;
    document.head.appendChild(tempStyle);

    try {

      const header = chatScreen.querySelector('.header').cloneNode(true);
      header.classList.add('cloned-header');



      const messagesContainer = document.createElement('div');
      const originalMessagesContainer = document.getElementById('chat-messages');


      messagesContainer.style.display = 'flex';
      messagesContainer.style.flexDirection = 'column';
      messagesContainer.style.gap = '20px';
      messagesContainer.style.padding = '10px 15px 20px 15px';
      messagesContainer.style.width = '100%';
      messagesContainer.style.boxSizing = 'border-box';


      messagesContainer.dataset.theme = originalMessagesContainer.dataset.theme;
      messagesContainer.style.setProperty('--chat-font-size', originalMessagesContainer.style.getPropertyValue('--chat-font-size'));


      const inputArea = chatScreen.querySelector('#chat-input-area').cloneNode(true);

      const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
      sortedTimestamps.forEach(timestamp => {

        const originalBubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`);
        if (originalBubble) {
          const originalWrapper = originalBubble.closest('.message-wrapper');
          if (originalWrapper) {
            messagesContainer.appendChild(originalWrapper.cloneNode(true));
          }
        }
      });

      screenshotContainer.appendChild(header);
      screenshotContainer.appendChild(messagesContainer);
      screenshotContainer.appendChild(inputArea);
      document.body.appendChild(screenshotContainer);


      const images = Array.from(screenshotContainer.getElementsByTagName('img'));
      const imageLoadPromises = images.map(img => new Promise((resolve, reject) => {
        if (img.src.startsWith('data:')) {
          resolve();
          return;
        }
        const newImg = new Image();
        newImg.crossOrigin = 'anonymous';
        newImg.onload = resolve;
        newImg.onerror = resolve;
        newImg.src = img.src;
      }));

      await Promise.all(imageLoadPromises);


      const canvas = await html2canvas(screenshotContainer, {
        allowTaint: true,
        useCORS: true,
        backgroundColor: null,
        scale: window.devicePixelRatio || 2,
      });


      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = `EPhone-ÈïøÊà™Âõæ-${chat.name}-${Date.now()}.png`;
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 'image/png');

    } catch (error) {
      console.error('ÈïøÊà™ÂõæÁîüÊàêÂ§±Ë¥•:', error);
      await showCustomAlert('ÁîüÊàêÂ§±Ë¥•', 'ÁîüÊàêÊà™ÂõæÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞Ëé∑ÂèñËØ¶ÊÉÖ„ÄÇ');
    } finally {

      document.body.removeChild(screenshotContainer);
      document.head.removeChild(tempStyle);
      screenshotBtn.textContent = originalBtnText;
      screenshotBtn.disabled = false;
      exitSelectionMode();
    }
  }

  function parseMarkdown(text) {
    if (!text || typeof text !== 'string') return '';


    text = text.replace(/!h\{(.*?)\}/g, '<span class="diary-highlight">$1</span>');
    text = text.replace(/!u\{(.*?)\}/g, '<span class="diary-underline">$1</span>');
    text = text.replace(/!e\{(.*?)\}/g, '<span class="diary-emphasis">$1</span>');
    text = text.replace(/!w\{(.*?)\}/g, '<span class="diary-handwritten">$1</span>');
    text = text.replace(/!m\{(.*?)\}/g, '<span class="diary-messy">$1</span>');



    text = text.replace(/\|\|(.*?)\|\|/g, '<span class="spoiler">$1</span>');



    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\~\~(.*?)\~\~/g, '<s>$1</s>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

    return text;
  }



  async function migrateOldRedPacketData() {
    console.log("ÂºÄÂßãÊ£ÄÊü•Âπ∂ËøÅÁßªÊóßÁöÑÁ∫¢ÂåÖÊï∞ÊçÆ...");
    let migrationCount = 0;

    const allChats = Object.values(state.chats);

    for (const chat of allChats) {
      let needsDbUpdate = false;
      for (const msg of chat.history) {

        if (msg.type === 'red_packet' && msg.packetType === 'direct' && msg.role === 'assistant' && msg.hasOwnProperty('receiver') && !msg.hasOwnProperty('receiverName')) {

          msg.receiverName = msg.receiver;
          delete msg.receiver;

          needsDbUpdate = true;
          migrationCount++;
        }
      }

      if (needsDbUpdate) {
        console.log(`Âú®ËÅäÂ§© "${chat.name}" ‰∏≠ÂèëÁé∞Âπ∂‰øÆÂ§ç‰∫ÜÊóßÁ∫¢ÂåÖÊï∞ÊçÆ„ÄÇ`);
        await db.chats.put(chat);
      }
    }

    if (migrationCount > 0) {
      console.log(`Êï∞ÊçÆËøÅÁßªÂÆåÊàêÔºÅÊÄªÂÖ±‰øÆÂ§ç‰∫Ü ${migrationCount} Êù°Á∫¢ÂåÖËÆ∞ÂΩï„ÄÇ`);
      alert(`Ê£ÄÊµãÂà∞Âπ∂ÊàêÂäü‰øÆÂ§ç‰∫Ü ${migrationCount} Êù°ÊóßÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÔºÅÈ°µÈù¢Â∞ÜËá™Âä®Âà∑Êñ∞‰ª•Â∫îÁî®Êõ¥Êîπ„ÄÇ`);
      location.reload();
    } else {
      console.log("Êú™ÂèëÁé∞ÈúÄË¶ÅËøÅÁßªÁöÑÊóßÁ∫¢ÂåÖÊï∞ÊçÆ„ÄÇ");
    }
  }

 
  async function openThoughtEditor() {
    
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

   
    const currentHeartfeltVoice = chat.heartfeltVoice || '';
    const newHeartfeltVoice = await showCustomPrompt(
      `ÁºñËæë‚Äú${chat.name}‚ÄùÁöÑÂøÉÂ£∞`,
      'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂøÉÂ£∞ÂÜÖÂÆπ...',
      currentHeartfeltVoice,
      'textarea'
    );

 
    if (newHeartfeltVoice === null) {
      await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "ÂøÉÂ£∞ÁºñËæëÂ∑≤ÂèñÊ∂à„ÄÇ");
      return;
    }

   
    const currentRandomJottings = chat.randomJottings || '';
    const newRandomJottings = await showCustomPrompt(
      `ÁºñËæë‚Äú${chat.name}‚ÄùÁöÑÊï£ËÆ∞`,
      'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊï£ËÆ∞ÂÜÖÂÆπ...',
      currentRandomJottings,
      'textarea'
    );

 
    if (newRandomJottings === null) {
      await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "Êï£ËÆ∞ÁºñËæëÂ∑≤ÂèñÊ∂àÔºåÂøÉÂ£∞ÁöÑ‰øÆÊîπ‰πüÊú™‰øùÂ≠ò„ÄÇ");
      return;
    }

   
    chat.heartfeltVoice = newHeartfeltVoice.trim();
    chat.randomJottings = newRandomJottings.trim();

 
    if (!Array.isArray(chat.thoughtsHistory)) {
      chat.thoughtsHistory = [];
    }

    if (chat.thoughtsHistory.length > 0) {
    
      const lastThought = chat.thoughtsHistory[chat.thoughtsHistory.length - 1];
    
      lastThought.heartfeltVoice = chat.heartfeltVoice;
      lastThought.randomJottings = chat.randomJottings;
      lastThought.timestamp = Date.now();
    } else {
     
      chat.thoughtsHistory.push({
        heartfeltVoice: chat.heartfeltVoice,
        randomJottings: chat.randomJottings,
        timestamp: Date.now()
      });
    }

 
    await db.chats.put(chat);

   
    await showCharacterProfileModal(chat.id);

    await showCustomAlert('ÊàêÂäü', 'ÂøÉÂ£∞ÂíåÊï£ËÆ∞Â∑≤Êõ¥Êñ∞ÔºÅ');
  }

  async function showCharacterProfileModal(chatId) {
    const chat = state.chats[chatId];
    if (!chat || chat.isGroup) return;





    const heartfeltVoiceEl = document.getElementById('profile-heartfelt-voice');
    const randomJottingsEl = document.getElementById('profile-random-jottings');

    heartfeltVoiceEl.innerHTML = await applyRenderingRules(chat.heartfeltVoice || '...', chatId);
    randomJottingsEl.innerHTML = await applyRenderingRules(chat.randomJottings || '...', chatId);

    const modal = document.getElementById('character-profile-modal');





    modal.classList.add('visible');
  }

  async function showThoughtsHistory() { // <-- 1. Ê∑ªÂä† async
    document.getElementById('profile-main-content').style.display = 'none';
    document.getElementById('profile-thoughts-history-view').style.display = 'flex';
    await renderThoughtsHistory(); // <-- 2. Ê∑ªÂä† await
  }

 
  function hideThoughtsHistory() {
    document.getElementById('profile-thoughts-history-view').style.display = 'none';


    document.getElementById('profile-main-content').style.display = 'flex';
  }



  async function renderThoughtsHistory() { // <-- 1. Ê∑ªÂä† async
    const listEl = document.getElementById('thoughts-history-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    if (!chat || !chat.thoughtsHistory || chat.thoughtsHistory.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; padding: 30px 0;">ËøôÈáåËøòÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÂì¶„ÄÇ</p>';
      return;
    }

    const history = [...chat.thoughtsHistory].reverse();
    const initialItems = history.slice(0, THOUGHTS_RENDER_WINDOW);

    const cardPromises = initialItems.map(thought => createThoughtCard(thought));
    const cards = await Promise.all(cardPromises);
    cards.forEach(card => listEl.appendChild(card));


    thoughtsHistoryRenderCount = initialItems.length;

    if (history.length > thoughtsHistoryRenderCount) {
      appendLoadMoreThoughtsButton(listEl);
    }
  }



  async function loadMoreThoughts() {
    if (isLoadingMoreThoughts) return;
    isLoadingMoreThoughts = true;

    const listEl = document.getElementById('thoughts-history-list');
    const chat = state.chats[state.activeChatId];
    if (!chat) {
      isLoadingMoreThoughts = false;
      return;
    }

    showLoader(listEl, 'bottom');
    await new Promise(resolve => setTimeout(resolve, 500));

    const history = [...chat.thoughtsHistory].reverse();
    const totalItems = history.length;

    const nextSliceStart = thoughtsHistoryRenderCount;
    const nextSliceEnd = thoughtsHistoryRenderCount + THOUGHTS_RENDER_WINDOW;
    const itemsToAppend = history.slice(nextSliceStart, nextSliceEnd);


    hideLoader(listEl);

  
    const cardPromises = itemsToAppend.map(thought => createThoughtCard(thought));
    const cards = await Promise.all(cardPromises);
    cards.forEach(card => listEl.appendChild(card));
 
    thoughtsHistoryRenderCount += itemsToAppend.length;

    isLoadingMoreThoughts = false;
  }



  async function createThoughtCard(thought) { // <-- 1. Ê∑ªÂä† async
    const card = document.createElement('div');
    card.className = 'thought-card';
    const date = new Date(thought.timestamp);
    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

   
    const chatId = state.activeChatId;
    const renderedVoice = await applyRenderingRules(thought.heartfeltVoice || '...', chatId);
    const renderedJottings = await applyRenderingRules(thought.randomJottings || '...', chatId);

    
    card.innerHTML = `
        <button class="thought-delete-btn" data-timestamp="${thought.timestamp}" title="Âà†Èô§Ê≠§Êù°ËÆ∞ÂΩï">√ó</button>
        <div class="thought-header">${dateString}</div>
        <div class="thought-content">
            <div class="voice">
                <div class="label">
                    <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    ÂøÉÂ£∞
                </div>
                <div class="text">${renderedVoice}</div>
            </div>
            <div class="jottings">
                <div class="label">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
                    Êï£ËÆ∞
                </div>
                <div class="text">${renderedJottings}</div>
            </div>
        </div>
    `;
    return card;
  }





  async function handleCardImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
      let cardData;
      let avatarBase64 = null;

      if (file.name.endsWith('.json')) {

        const text = await file.text();
        cardData = JSON.parse(text);
      } else if (file.name.endsWith('.png')) {

        const arrayBuffer = await file.arrayBuffer();

        cardData = await parsePngForTavernData(arrayBuffer);


        avatarBase64 = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = async (readerEvent) => {
            let base64Result = readerEvent.target.result;

            
            if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
                try {
                    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏ä‰º†ËßíËâ≤Âç°Â∞ÅÈù¢Âà∞ ImgBB...");
                    const imageUrl = await uploadImageToImgBB(base64Result);
                    resolve(imageUrl); 
                } catch (uploadError) {
                    console.error(uploadError);
                    await showCustomAlert("ImgBB ‰∏ä‰º†Â§±Ë¥•", `Â∞ÅÈù¢‰∏ä‰º†Â§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÁªßÁª≠‰ΩøÁî®Êú¨Âú∞ Base64 Ê†ºÂºè‰øùÂ≠ò„ÄÇ`);
                    resolve(base64Result); 
                }
            } else {
                resolve(base64Result);
            }
        };
        reader.readAsDataURL(file);
    });
      } else {
        throw new Error("‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè„ÄÇËØ∑ÈÄâÊã© .json Êàñ .png Êñá‰ª∂„ÄÇ");
      }


      await createChatFromCardData(cardData, avatarBase64);

    } catch (error) {
      console.error("ËßíËâ≤Âç°ÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", `Êó†Ê≥ïËß£ÊûêËßíËâ≤Âç°Êñá‰ª∂„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {

      event.target.value = null;
    }
  }


 
  function parsePngForTavernData(arrayBuffer) {
    return new Promise((resolve, reject) => {
      const view = new DataView(arrayBuffer);

      if (view.getUint32(0) !== 0x89504E47 || view.getUint32(4) !== 0x0D0A1A0A) {
        return reject(new Error("Êñá‰ª∂‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑPNG„ÄÇ"));
      }

      let offset = 8;
      const decoder = new TextDecoder();

      while (offset < view.byteLength) {
        const length = view.getUint32(offset);
        const type = decoder.decode(arrayBuffer.slice(offset + 4, offset + 8));

        if (type === 'tEXt') {
          const data = new Uint8Array(arrayBuffer, offset + 8, length);
          const nullSeparatorIndex = data.indexOf(0);
          if (nullSeparatorIndex !== -1) {
            const key = decoder.decode(data.slice(0, nullSeparatorIndex));
            if (key === 'chara') {
              const value = decoder.decode(data.slice(nullSeparatorIndex + 1));
              try {





                const binaryString = atob(value);


                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                  bytes[i] = binaryString.charCodeAt(i);
                }



                const decodedData = new TextDecoder('utf-8').decode(bytes);



                resolve(JSON.parse(decodedData));
                return;
              } catch (e) {
                return reject(new Error("Âú®PNG‰∏≠ÊâæÂà∞ËßíËâ≤Êï∞ÊçÆÔºå‰ΩÜËß£Á†ÅÊàñËß£ÊûêÂ§±Ë¥•„ÄÇÈîôËØØ: " + e.message));
              }
            }
          }
        }


        offset += 4 + 4 + length + 4;
      }

      reject(new Error("Âú®PNGÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑTavern AIËßíËâ≤Êï∞ÊçÆ(chara chunk)„ÄÇ"));
    });
  }





  function findWorldBookEntries(cardData) {




    if (cardData.data?.character_book?.entries?.length > 0) {
      console.log("ËØäÊñ≠ÔºöÂú® data.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
      return cardData.data.character_book.entries;
    }


    if (cardData.extensions?.character_book?.entries?.length > 0) {
      console.log("ËØäÊñ≠ÔºöÂú® extensions.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
      return cardData.extensions.character_book.entries;
    }


    if (cardData.data?.extensions?.character_book?.entries?.length > 0) {
      console.log("ËØäÊñ≠ÔºöÂú® data.extensions.character_book ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ");
      return cardData.data.extensions.character_book.entries;
    }


    const possibleTopLevelKeys = ['character_book', 'lorebook', 'world_info', 'char_book'];
    for (const key of possibleTopLevelKeys) {
      if (cardData[key]?.entries?.length > 0) {
        console.log(`ËØäÊñ≠ÔºöÂú®È°∂Â±Ç ${key} ‰∏≠ÊâæÂà∞‰∏ñÁïå‰π¶„ÄÇ`);
        return cardData[key].entries;
      }
    }

    console.log("ËØäÊñ≠ÔºöÊú™Âú®Ê≠§ËßíËâ≤Âç°‰∏≠ÊâæÂà∞‰ªª‰ΩïÊúâÊïàÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆ„ÄÇ");
    return null;
  }

 
  async function createChatFromCardData(cardData, avatarBase64 = null) {
    const effectiveCardData = cardData.data || cardData;
    if (!effectiveCardData.name) {
      throw new Error("ËßíËâ≤Âç°Êï∞ÊçÆÊó†ÊïàÊàñÁº∫Â∞ë'name'Â≠óÊÆµ„ÄÇ");
    }

  
    let worldBookIdToLink = null;
    const worldBookEntries = findWorldBookEntries(cardData);

    if (worldBookEntries) {
      const structuredEntries = worldBookEntries
        .filter(entry => entry.enabled && entry.content)
        .map(entry => ({
          keys: entry.keys || [],
          comment: entry.comment || '',
          content: entry.content.replace(/<memory>|<\/memory>/g, '').trim()
        }));

      if (structuredEntries.length > 0) {
        const newWorldBook = {
          id: 'wb_' + Date.now(),
          name: `${effectiveCardData.name}ÁöÑËÆæÂÆöÈõÜ`,
          content: structuredEntries,
          categoryId: null
        };
        await db.worldBooks.add(newWorldBook);
        state.worldBooks.push(newWorldBook);
        worldBookIdToLink = newWorldBook.id;
      }
    }

  
    let alternateGreetings = [];
   
    if (Array.isArray(effectiveCardData.alternate_greetings)) {
        alternateGreetings = effectiveCardData.alternate_greetings;
    } 
  
    else if (Array.isArray(cardData.alternate_greetings)) {
        alternateGreetings = cardData.alternate_greetings;
    }
    
  
    alternateGreetings = alternateGreetings.filter(g => g && typeof g === 'string' && g.trim() !== '');

    
    const firstGreeting = effectiveCardData.first_mes || cardData.first_mes;
    
    
    if (firstGreeting && typeof firstGreeting === 'string' && firstGreeting.trim() !== '') {
        if (!alternateGreetings.includes(firstGreeting)) {
            alternateGreetings.unshift(firstGreeting);
        }
    }


    let description = effectiveCardData.description || cardData.description || 'Êó†';
    description = description
      .replace(/```yaml/g, '').replace(/```/g, '')
      .replace(/<\/?info>/g, '').replace(/<\/?character>/g, '')
      .replace(/<\/?writing_rule>/g, '').replace(/\[OOCÔºö.*?\]/g, '').trim();
    
    let persona = `# ËßíËâ≤Ê†∏ÂøÉËÆæÂÆö\n${description}\n\n`;
    if (effectiveCardData.personality) persona += `# ÊÄßÊ†ºË°•ÂÖÖ\n${effectiveCardData.personality}\n\n`;
    if (effectiveCardData.scenario) persona += `# Âú∫ÊôØËÆæÂÆö\n${effectiveCardData.scenario}\n\n`;
    if (effectiveCardData.mes_example) persona += `# ÂØπËØùÁ§∫‰æã\n${effectiveCardData.mes_example}\n\n`;

    const remarkName = effectiveCardData.name;
    const originalName = effectiveCardData.name;

    const newChatId = 'chat_' + Date.now();

   
    const newChat = {
      id: newChatId,
      name: remarkName.trim(),
      originalName: originalName.trim(),
      isGroup: false,
      relationship: {
        status: 'friend'
      },
      status: {
        text: 'Âú®Á∫ø',
        lastUpdate: Date.now(),
        isBusy: false
      },
      settings: {
        aiPersona: persona,
        myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
        maxMemory: 10,
        aiAvatar: defaultAvatar,
        myAvatar: defaultAvatar,
        background: '',
        theme: 'default',
        fontSize: 13,
        customCss: '',
        linkedWorldBookIds: worldBookIdToLink ? [worldBookIdToLink] : [],
        aiAvatarLibrary: [],
        
       
        alternateGreetings: alternateGreetings 
      },
      history: [],
      musicData: {
        totalTime: 0
      },
      longTermMemory: []
    };

    
    if (avatarBase64) {
      newChat.settings.aiAvatar = avatarBase64;
      newChat.settings.aiAvatarLibrary.push({
        name: 'ÈªòËÆ§Â§¥ÂÉè',
        url: avatarBase64
      });
    }

  
    if (firstGreeting && typeof firstGreeting === 'string') {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = firstGreeting;
      const cleanGreeting = (tempDiv.textContent || tempDiv.innerText || "").replace(/Âéü‰ΩúËÄÖ.*?ÂºÄÂ±Ä/s, '').trim();
      
      if (cleanGreeting) {
        newChat.history.push({
          role: 'assistant',
          senderName: newChat.originalName,
          content: cleanGreeting,
          timestamp: Date.now()
        });
      }
    }

   
    state.chats[newChatId] = newChat;
    await db.chats.put(newChat);
    renderChatList();
    
    let successMessage = `ËßíËâ≤ ‚Äú${newChat.name}‚Äù Â∑≤ÊàêÂäüÂØºÂÖ•ÔºÅ`;
    if (worldBookIdToLink) {
      successMessage += `\n\nÂÖ∂‰∏ìÂ±ûÁöÑ‚Äú‰∏ñÁïå‰π¶‚Äù‰πüÂ∑≤Ëá™Âä®ÂàõÂª∫Âπ∂ÂÖ≥ËÅî„ÄÇ`;
    }
    if (alternateGreetings.length > 1) {
        successMessage += `\n\nÊ£ÄÊµãÂà∞ ${alternateGreetings.length} Êù°ÂºÄÂú∫ÁôΩÔºåÂèØÂú®‚ÄúËÅäÂ§©ËÆæÁΩÆ‚Äù‰∏≠ÂàáÊç¢„ÄÇ`;
    }
    await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', successMessage);
  }



 
  async function handleSwitchGreeting() {
    console.log("ÁÇπÂáª‰∫ÜÂàáÊç¢ÂºÄÂú∫ÊåâÈíÆ"); 
    
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
  
    const greetings = chat.settings?.alternateGreetings || [];

    if (greetings.length === 0) {
      alert("Êú™Ê£ÄÊµãÂà∞ÂèØÁî®ÁöÑÂÄôË°•ÂºÄÂú∫ÁôΩÊï∞ÊçÆ„ÄÇ\nËØ∑Á°ÆËÆ§ÊÇ®Â∑≤‰ΩøÁî®‰øÆÂ§çÂêéÁöÑ‰ª£Á†ÅÈáçÊñ∞ÂØºÂÖ•‰∫ÜËßíËâ≤Âç°„ÄÇ");
      return;
    }

   
    const options = greetings.map((text, index) => {
     
      const safeText = String(text || "");
      const preview = safeText.replace(/<[^>]*>/g, '').trim().substring(0, 20);
      return {
        text: `üìú ÂºÄÂú∫ ${index + 1}: ${preview}...`,
        value: index
      };
    });

   
    const selectedIndex = await showChoiceModal('ÈÄâÊã©‰∏Ä‰∏™ÂºÄÂú∫ÁôΩ', options);

  
    if (selectedIndex !== null) {
      const confirmed = await showCustomConfirm(
        '‚ö†Ô∏è Ë≠¶ÂëäÔºöÁ°ÆËÆ§ÂàáÊç¢Ôºü',
        'ÂàáÊç¢ÂºÄÂú∫ÁôΩÂ∞Ü‰ºö„ÄêÊ∏ÖÁ©∫Âπ∂ÊõøÊç¢„ÄëÂΩìÂâçÊâÄÊúâÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºåÂ∞±ÂÉèÈáçÊñ∞ÂºÄÂßã‰∏ÄÊ†∑„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
          confirmButtonClass: 'btn-danger',
          confirmText: 'Á°ÆÂÆöÂàáÊç¢'
        }
      );

      if (confirmed) {
        const newGreetingText = greetings[selectedIndex];
        
        
        const newMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          content: newGreetingText,
          timestamp: Date.now()
        };

        chat.history = [newMessage]; 
        
        
        await db.chats.put(chat);
        
       
        renderChatInterface(chat.id);
        
        await showCustomAlert('ÊàêÂäü', 'Â∑≤ÂàáÊç¢Âà∞Êñ∞ÁöÑÂºÄÂú∫ÊïÖ‰∫ãÔºÅ\nÁÇπÂáªÂ∑¶‰∏äËßíËøîÂõûÂç≥ÂèØÂºÄÂßãÂØπËØù„ÄÇ');
      }
    }
  }





  function createWorldBookEntryBlock(entry = {
    keys: [],
    comment: '',
    content: '',
    enabled: true
  }) {
    const block = document.createElement('div');

    block.className = 'message-editor-block';


    const isChecked = entry.enabled !== false ? 'checked' : '';

    block.innerHTML = `
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <label class="toggle-switch" title="ÂêØÁî®/Á¶ÅÁî®Ê≠§Êù°ÁõÆ">
                        <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                        <span class="slider"></span>
                    </label>
                    <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°ÁõÆ">√ó</button>
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">Â§áÊ≥® (ÂèØÈÄâ)</label>
                    <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="‰æãÂ¶ÇÔºöÂÖ≥‰∫éËßíËâ≤ÁöÑÁ´•Âπ¥" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="font-size: 0.8em;">ÂÖ≥ÈîÆËØç (Áî®Ëã±ÊñáÈÄóÂè∑,ÂàÜÈöî)</label>
                    <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="‰æãÂ¶Ç: key1, key2, key3" style="padding: 8px;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="font-size: 0.8em;">ÂÜÖÂÆπ</label>
                    <textarea class="entry-content-textarea" rows="5" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
                </div>
            `;


    block.querySelector('.delete-block-btn').addEventListener('click', () => {
      block.remove();
    });

    return block;
  }




  async function toggleGomokuBoard() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const overlay = document.getElementById('gomoku-overlay');


    if (!overlay.classList.contains('visible')) {
      const header = document.querySelector('#chat-interface-screen > .header');

      overlay.style.top = `${header.offsetHeight}px`;
      overlay.style.display = 'block';

      if (!gomokuState[chatId] || !gomokuState[chatId].isActive) {
        initGomokuGame(chatId);
      }
      renderGomokuBoard(chatId);


      setTimeout(async () => {
        overlay.classList.add('visible');

        const startMessage = {
          role: 'system',
          content: '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâìÂºÄ‰∫Ü‰∫îÂ≠êÊ£ãÊ£ãÁõòÔºåÊ∏∏ÊàèÂºÄÂßã‰∫Ü„ÄÇ]',
          timestamp: Date.now(),
          isHidden: true
        };
        state.chats[chatId].history.push(startMessage);
        await db.chats.put(state.chats[chatId]);
      }, 10);

    } else {

      await closeGomokuBoard();
    }
  }
 
  async function closeGomokuBoard() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const overlay = document.getElementById('gomoku-overlay');

    overlay.classList.remove('visible');



    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);

    if (gomokuState[chatId]) {
      gomokuState[chatId].isActive = false;

      const endMessage = {
        role: 'system',
        content: '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂÖ≥Èó≠‰∫Ü‰∫îÂ≠êÊ£ãÊ£ãÁõòÔºåÊ∏∏ÊàèÁªìÊùü‰∫Ü„ÄÇ]',
        timestamp: Date.now(),
        isHidden: true
      };
      state.chats[chatId].history.push(endMessage);
      await db.chats.put(state.chats[chatId]);
    }
  }

 
  function initGomokuGame(chatId) {
    const canvas = document.getElementById('gomoku-board');
    const overlay = document.getElementById('gomoku-overlay');
    const controls = document.getElementById('gomoku-controls');


    const availableWidth = overlay.offsetWidth - 40;
    const availableHeight = overlay.offsetHeight - controls.offsetHeight - 40;
    const boardSize = Math.floor(Math.min(availableWidth, availableHeight));

    const GRID_SIZE = 15;

    const cell_size = Math.floor(boardSize / GRID_SIZE);
    const final_size = cell_size * GRID_SIZE;

    canvas.width = final_size;
    canvas.height = final_size;

    gomokuState[chatId] = {
      isActive: true,
      board: Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0)),
      currentPlayer: 1,
      history: [],
      isGameOver: false,
      GRID_SIZE: GRID_SIZE,
      CELL_SIZE: cell_size
    };
  }
  
  function renderGomokuBoard(chatId) {
    const gameState = gomokuState[chatId];
    if (!gameState) return;

    const canvas = document.getElementById('gomoku-board');
    const ctx = canvas.getContext('2d');
    const {
      GRID_SIZE,
      CELL_SIZE
    } = gameState;
    const padding = CELL_SIZE / 2;


    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#e4b591';
    ctx.fillRect(0, 0, canvas.width, canvas.height);


    ctx.strokeStyle = '#5b3a29';
    ctx.lineWidth = 1;
    for (let i = 0; i < GRID_SIZE; i++) {

      ctx.beginPath();
      ctx.moveTo(padding, padding + i * CELL_SIZE);
      ctx.lineTo(canvas.width - padding, padding + i * CELL_SIZE);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(padding + i * CELL_SIZE, padding);
      ctx.lineTo(padding + i * CELL_SIZE, canvas.height - padding);
      ctx.stroke();
    }


    for (let y = 0; y < GRID_SIZE; y++) {
      for (let x = 0; x < GRID_SIZE; x++) {
        if (gameState.board[y][x] !== 0) {
          drawStone(ctx, x, y, gameState.board[y][x], gameState);
        }
      }
    }
  }


  function drawStone(ctx, x, y, player, gameState) {
    const {
      CELL_SIZE
    } = gameState;
    const padding = CELL_SIZE / 2;
    const radius = CELL_SIZE / 2 - 2;

    ctx.beginPath();
    ctx.arc(padding + x * CELL_SIZE, padding + y * CELL_SIZE, radius, 0, 2 * Math.PI);

    if (player === 1) {
      ctx.fillStyle = 'black';
    } else {
      ctx.fillStyle = 'white';
    }
    ctx.fill();
  }


  function handleBoardHover(e) {
    const chatId = state.activeChatId;
    const gameState = gomokuState[chatId];
    if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;

    const canvas = document.getElementById('gomoku-board');
    const ctx = canvas.getContext('2d');
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
    const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);

    renderGomokuBoard(chatId);

    if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {
      const radius = gameState.CELL_SIZE / 2 - 2;
      ctx.beginPath();
      ctx.arc(gameState.CELL_SIZE / 2 + gridX * gameState.CELL_SIZE, gameState.CELL_SIZE / 2 + gridY * gameState.CELL_SIZE, radius, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
      ctx.fill();
    }
  }

  function handleBoardClick(e) {
    const chatId = state.activeChatId;
    const gameState = gomokuState[chatId];
    if (!gameState || gameState.isGameOver || gameState.currentPlayer !== 1) return;

    const canvas = document.getElementById('gomoku-board');
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const gridX = Math.round((x - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);
    const gridY = Math.round((y - gameState.CELL_SIZE / 2) / gameState.CELL_SIZE);

    if (gridX >= 0 && gridX < gameState.GRID_SIZE && gridY >= 0 && gridY < gameState.GRID_SIZE && gameState.board[gridY][gridX] === 0) {

      gameState.board[gridY][gridX] = 1;
      gameState.history.push({
        x: gridX,
        y: gridY,
        player: 1
      });
      renderGomokuBoard(chatId);


      if (checkWin(gridX, gridY, 1, gameState)) {
        gameState.isGameOver = true;
        setTimeout(() => alert("ÊÅ≠Âñú‰Ω†Ôºå‰Ω†Ëµ¢‰∫ÜÔºÅ"), 100);

        addGameEndSystemMessage('user');


      } else {
        gameState.currentPlayer = 2;

      }
    }
  }


  function handleAiGomokuMove(move, isForcedMove = false) {
    const chatId = state.activeChatId;
    const gameState = gomokuState[chatId];


    if (!gameState || gameState.isGameOver) return;
    if (!isForcedMove && gameState.currentPlayer !== 2) return;

    const {
      x,
      y
    } = move;

    if (x >= 0 && x < gameState.GRID_SIZE && y >= 0 && y < gameState.GRID_SIZE && gameState.board[y][x] === 0) {
      gameState.board[y][x] = 2;
      gameState.history.push({
        x,
        y,
        player: 2
      });
      renderGomokuBoard(chatId);

      if (checkWin(x, y, 2, gameState)) {
        gameState.isGameOver = true;
        setTimeout(() => alert("AI Ëé∑ËÉú‰∫ÜÔºÅ"), 100);
        addGameEndSystemMessage('ai');
      } else {
        gameState.currentPlayer = 1;
      }
    } else {
      console.warn("AI ÁöÑ‰∏ãÊ£ãÊåá‰ª§Êó†ÊïàÊàñ‰ΩçÁΩÆÂ∑≤Ë¢´Âç†ÊçÆ:", move);

      gameState.currentPlayer = 1;
    }
  }

 
  function checkWin(x, y, player, gameState) {
    const {
      board,
      GRID_SIZE
    } = gameState;
    const directions = [
      [1, 0],
      [0, 1],
      [1, 1],
      [1, -1]
    ];
    for (const [dx, dy] of directions) {
      let count = 1;

      for (let i = 1; i < 5; i++) {
        const newX = x + i * dx;
        const newY = y + i * dy;
        if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
          count++;
        } else {
          break;
        }
      }

      for (let i = 1; i < 5; i++) {
        const newX = x - i * dx;
        const newY = y - i * dy;
        if (newX >= 0 && newX < GRID_SIZE && newY >= 0 && newY < GRID_SIZE && board[newY][newX] === player) {
          count++;
        } else {
          break;
        }
      }
      if (count >= 5) return true;
    }
    return false;
  }


 
  function formatGomokuStateForAI(gameState) {
    if (!gameState || !gameState.isActive) return "";

    let boardString = "Ê£ãÁõòÁä∂ÊÄÅ (1ÊòØ‰Ω†(ÈªëÊ£ã), 2ÊòØAI(ÁôΩÊ£ã)):\n";
    boardString += gameState.board.map(row => row.join(' ')).join('\n');

    let historyString = "‰∏ãÊ£ãÂéÜÂè≤ (x,yÂùêÊ†áÂùá‰ªé0ÂºÄÂßã):\n";
    historyString += gameState.history.map(move => `Áé©ÂÆ∂${move.player}‰∏ãÂú®(${move.x},${move.y})`).join(' -> ');

    return `
# ÂΩìÂâç‰∫îÂ≠êÊ£ãÂ±ÄÂäø
${boardString}

# ${historyString}

# „Äê„Äê„Äê‰∫îÂ≠êÊ£ãÊ†∏ÂøÉËßÑÂàô‰∏éÂº∫Âà∂ÊÄùËÄÉÊ≠•È™§ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºÅ)„Äë„Äë„Äë

### **„Äê„Äê„ÄêËêΩÂ≠êÈìÅÂæã (ÁªùÂØπÁ¶ÅÊ≠¢ÔºÅ)„Äë„Äë„Äë**
‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÈÄâÊã©‰∏Ä‰∏™Ê£ãÁõò‰∏äÂ∑≤ÁªèÊòØ 1 Êàñ 2 ÁöÑÂùêÊ†á„ÄÇ‰Ω†ÁöÑËêΩÂ≠êÁÇπ„ÄêÂøÖÈ°ª„ÄëÊòØ 0„ÄÇ
---

### **Á¨¨‰∏ÄÊ≠•ÔºöÈÄªËæëÂàÜÊûê (ÂÜÖÈÉ®ÊÄùËÄÉÔºå‰∏çË¶ÅËæìÂá∫)**

1.  **„ÄêËßÑÂàôÂÆö‰πâ„Äë**: 
    -   Ê£ãÂ≠ê: 1‰ª£Ë°®Áî®Êà∑(ÈªëÊ£ã)Ôºå2‰ª£Ë°®‰Ω†(ÁôΩÊ£ã)„ÄÇ
    -   Ëé∑ËÉúÊù°‰ª∂: Ê®™„ÄÅÁ´ñ„ÄÅÊñúÁ∫ø‰∏äÊúâ„ÄêËøûÁª≠‰∫î‰∏™„ÄëËá™Â∑±ÁöÑÊ£ãÂ≠ê„ÄÇ

2.  **„ÄêÈò≤ÂÆàÂàÜÊûê (ÂøÖÈ°ªÊâßË°å)„Äë**:
    -   **Ê£ÄÊü•Áî®Êà∑(1)ÊòØÂê¶Êúâ‚ÄúÂõõÂ≠êËøûÁ∫ø‚ÄùÁöÑÂ®ÅËÉÅÔºü** Â¶ÇÊûúÊúâÔºåÊàëÂøÖÈ°ª‰∏ãÂú®Âì™‰∏™ÂùêÊ†áÊâçËÉΩÂ†µ‰ΩèÔºü
    -   **Ê£ÄÊü•Áî®Êà∑(1)ÊòØÂê¶Êúâ‚ÄúÊ¥ª‰∏â‚ÄùÁöÑÂ®ÅËÉÅÔºü** Â¶ÇÊûúÊúâÔºåÊúÄ‰Ω≥ÁöÑÈò≤ÂÆàÁÇπÊòØÂì™ÈáåÔºü

3.  **„ÄêËøõÊîªÂàÜÊûê (ÂøÖÈ°ªÊâßË°å)„Äë**:
    -   **Ê£ÄÊü•Êàë(2)ÊòØÂê¶Êúâ‚Äú‰∏ÄÊ≠•ËÉúÂà©‚ÄùÁöÑÊú∫‰ºöÔºü** (Âç≥Â∑≤ÊúâÂõõÂ≠êËøûÁ∫ø) Â¶ÇÊûúÊúâÔºåÊàëÂ∫îËØ•‰∏ãÂú®Âì™ÈáåÔºü
    -   **Ê£ÄÊü•Êàë(2)ÊòØÂê¶ÊúâÂà∂ÈÄ†‚ÄúÊ¥ªÂõõ‚ÄùÊàñ‚ÄúÂèå‰∏â‚ÄùÁöÑÊú∫‰ºöÔºü** Â¶ÇÊûúÊúâÔºåÊúÄ‰Ω≥ÁöÑËøõÊîªÁÇπÊòØÂì™ÈáåÔºü

### **Á¨¨‰∫åÊ≠•ÔºöÂÜ≥Á≠ñ‰∏éÊâÆÊºî (ÂÜÖÈÉ®ÊÄùËÄÉÔºå‰∏çË¶ÅËæìÂá∫)**

1.  **„ÄêÂÜ≥Á≠ñ„Äë**: ÁªºÂêà‰ª•‰∏äÊîªÈò≤ÂàÜÊûêÔºåÊàëÁöÑÊúÄ‰Ω≥Ê£ãÊ≠•ÊòØËêΩÂú®ÂùêÊ†á (x, y)„ÄÇ

2.  **„ÄêËûçÂÖ•ËßíËâ≤ÊâÆÊºî„Äë**:
    -   ÊàëÁöÑÊÄßÊ†ºÊòØÔºö(Âú®Ê≠§Â§ÑÂõûÈ°æ‰Ω†ÁöÑ‰∫∫ËÆæ)„ÄÇ
    -   Ê†πÊçÆÊàëÁöÑÊÄßÊ†ºÔºåÊàëÂ∫îËØ•Ôºö
        a) **(ËÅ™Êòé/Â•ΩËÉúÂûã)** ‰∏ãÂú®ÂàöÂàöÂàÜÊûêÂá∫ÁöÑÊúÄ‰Ω≥‰ΩçÁΩÆ„ÄÇ
        b) **(Ëø∑Á≥ä/ÊîæÊ∞¥Âûã)** ÊïÖÊÑèÈÄâÊã©‰∏Ä‰∏™Ê¨°‰ºòÁöÑ‰ΩçÁΩÆÔºå‰ΩÜ„ÄêÂâçÊèêÊòØ‰∏çËÉΩËÆ©Áî®Êà∑Á´ãÂàªËé∑ËÉú„Äë„ÄÇ
        c) **(ÂÖ∂‰ªñÊÄßÊ†º)** Ê†πÊçÆÊÄßÊ†ºÁâπÁÇπÔºåÈÄâÊã©‰∏Ä‰∏™ÂêàÁêÜÁöÑÊ£ãÊ≠•„ÄÇ

3.  **„ÄêÊûÑÊÄùÂè∞ËØç„Äë**: Ê†πÊçÆÊàëÈÄâÊã©ÁöÑÊ£ãÊ≠•ÂíåÊàëÁöÑÊÄßÊ†ºÔºåÊàëÂ∫îËØ•ËØ¥‰∏ÄÂè•‰ªÄ‰πàÊ†∑ÁöÑÂè∞ËØçÊù•ËØÑËÆ∫Ê£ãÂ±ÄÔºü

---
### **Á¨¨‰∏âÊ≠•ÔºöÁîüÊàêÊúÄÁªàÂõûÂ§ç (‰Ω†ÁöÑÂîØ‰∏ÄËæìÂá∫)**

Áé∞Âú®ÔºåÊ†πÊçÆ‰Ω†Á¨¨‰∫åÊ≠•ÁöÑÊúÄÁªàÂÜ≥Á≠ñÔºåÁîüÊàê‰Ω†ÁöÑË°åÂä®„ÄÇ
-   ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ
-   **ÁªùÂØπ‰∏çË¶Å**Âú®ÊúÄÁªàÂõûÂ§ç‰∏≠ÂåÖÂê´‰ªª‰Ωï‰∏äËø∞ÁöÑÊÄùËÄÉËøáÁ®ã„ÄÇ
-   Ê†ºÂºè: \`[{"type": "gomoku_move", "name": "‰Ω†ÁöÑËßíËâ≤Êú¨Âêç", "x": (0-14), "y": (0-14)}, {"type": "text", "content": "‰Ω†ÁöÑÂè∞ËØç..."}]\`
`;
  }

  async function addGameEndSystemMessage(winner) {
    const chatId = state.activeChatId;
    const chat = state.chats[chatId];
    if (!chat) return;



    const userDisplayName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
    const aiDisplayName = chat.isGroup ? 'AIÊñπ' : chat.name;
    const winnerName = (winner === 'user') ? userDisplayName : aiDisplayName;
    const resultText = (winner === 'user') ? '‰Ω†Ëæì‰∫Ü' : '‰Ω†Ëµ¢‰∫Ü';


    const systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰∫îÂ≠êÊ£ãÊ∏∏ÊàèÂ∑≤ÁªìÊùü„ÄÇÊúÄÁªàÁªìÊûúÊòØÔºö${winnerName} Ëé∑ËÉú„ÄÇ‰πüÂ∞±ÊòØËØ¥Ôºå${resultText}„ÄÇ]`;


    const hiddenMessage = {
      role: 'system',
      content: systemContent,
      timestamp: Date.now(),
      isHidden: true
    };

    chat.history.push(hiddenMessage);
    await db.chats.put(chat);


    console.log(`Ê∏∏ÊàèÁªìÊùüÁöÑÁ≥ªÁªüÊèêÁ§∫Â∑≤Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÔºåÁ≠âÂæÖAI‰∏ãÊ¨°Êü•Áúã„ÄÇËÉúËÄÖ: ${winner}`);
  }


 


  let isProductManagementMode = false;



  async function renderShoppingProducts() {
    const gridEl = document.getElementById('product-grid');
    const tabsContainer = document.getElementById('product-category-tabs');
    const shoppingScreen = document.getElementById('shopping-screen');
    gridEl.innerHTML = '';
    tabsContainer.innerHTML = '';

    const [allProducts, allCategories] = await Promise.all([
      db.shoppingProducts.toArray(),
      db.shoppingCategories.orderBy('name').toArray()
    ]);

    shoppingScreen.classList.toggle('management-mode', isProductManagementMode);


    const allTab = document.createElement('button');
    allTab.className = 'product-category-tab';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    if (activeShoppingCategoryId === 'all') allTab.classList.add('active');
    tabsContainer.appendChild(allTab);

    allCategories.forEach(cat => {
      const tab = document.createElement('button');
      tab.className = 'product-category-tab';
      tab.textContent = cat.name;
      tab.dataset.categoryId = cat.id;
      if (activeShoppingCategoryId === cat.id) tab.classList.add('active');
      tabsContainer.appendChild(tab);
    });

    let productsToShow;
    if (activeShoppingCategoryId === 'all') {
      productsToShow = allProducts;
    } else {
      productsToShow = allProducts.filter(p => p.categoryId === activeShoppingCategoryId);
    }

    if (productsToShow.length === 0) {
      const message = activeShoppingCategoryId === 'all' ?
        'ÂïÜÂ∫óÁ©∫Á©∫Â¶Ç‰πüÔºåÁÇπÂáª‚ÄúÁÆ°ÁêÜ‚ÄùÊ∑ªÂä†ÂïÜÂìÅÂêßÔºÅ' :
        'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâÂïÜÂìÅÂì¶~';
      gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
      return;
    }

    productsToShow.forEach(product => {
      const item = document.createElement('div');
      item.className = 'product-item';
      item.dataset.id = product.id;



      const managementControls = `
                    <div class="product-management-overlay">
                        <button class="edit-product-btn">ÁºñËæë</button>
                        <button class="delete-product-btn">Âà†Èô§</button>
                    </div>
                `;

      item.innerHTML = `
                    ${managementControls}
                    <img src="${product.imageUrl}" class="product-image">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-footer">
                            <div class="product-price">${product.price.toFixed(2)}</div>
                            <button class="add-to-cart-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
                        </div>
                    </div>
                `;
      gridEl.appendChild(item);
    });
  }


  function switchShoppingCategory(categoryId) {
    activeShoppingCategoryId = categoryId;
    renderShoppingProducts();
    updateDeleteCategoryButtonVisibility();
  }

  function updateDeleteCategoryButtonVisibility() {
    const deleteBtn = document.getElementById('delete-current-category-btn');
    if (!deleteBtn) return;




    const isVisible = isProductManagementMode && activeShoppingCategoryId !== 'all';
    deleteBtn.style.display = isVisible ? 'flex' : 'none';
  }

  
  async function handleDeleteCurrentCategory() {
    if (activeShoppingCategoryId === 'all') return;

    const categoryId = activeShoppingCategoryId;
    const category = await db.shoppingCategories.get(categoryId);
    if (!category) {
      alert("ÈîôËØØÔºöÊâæ‰∏çÂà∞Ë¶ÅÂà†Èô§ÁöÑÂàÜÁ±ª„ÄÇ");
      return;
    }

    const confirmMessage = `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÂàÜÁ±ª ‚Äú${category.name}‚Äù ÂêóÔºü\n\nÊ≠§Êìç‰Ωú„Äê‰∏ç‰ºö„ÄëÂà†Èô§ÂàÜÁ±ª‰∏ãÁöÑÂïÜÂìÅÔºåÂÆÉ‰ª¨Â∞ÜË¢´ÁßªËá≥‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇ`;
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª', confirmMessage, {
      confirmButtonClass: 'btn-danger',
      confirmText: 'Á°ÆËÆ§Âà†Èô§'
    });

    if (confirmed) {

      await deleteProductCategory(categoryId);


      activeShoppingCategoryId = 'all';
      await renderShoppingProducts();


      updateDeleteCategoryButtonVisibility();

      await showCustomAlert("ÊàêÂäü", `ÂàÜÁ±ª ‚Äú${category.name}‚Äù Â∑≤Ë¢´Âà†Èô§„ÄÇ`);
    }
  }
  


  async function openShoppingScreen() {
    activeShoppingCategoryId = 'all';
    await renderShoppingProducts();
    showScreen('shopping-screen');
    updateDeleteCategoryButtonVisibility();
  }


  async function renderShoppingProducts() {
    const gridEl = document.getElementById('product-grid');
    const tabsContainer = document.getElementById('product-category-tabs');
    const shoppingScreen = document.getElementById('shopping-screen');
    gridEl.innerHTML = '';
    tabsContainer.innerHTML = '';


    const [allProducts, allCategories] = await Promise.all([
      db.shoppingProducts.toArray(),
      db.shoppingCategories.orderBy('name').toArray()
    ]);

    shoppingScreen.classList.toggle('management-mode', isProductManagementMode);


    const allTab = document.createElement('button');
    allTab.className = 'product-category-tab';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    if (activeShoppingCategoryId === 'all') allTab.classList.add('active');
    tabsContainer.appendChild(allTab);

    allCategories.forEach(cat => {
      const tab = document.createElement('button');
      tab.className = 'product-category-tab';
      tab.textContent = cat.name;
      tab.dataset.categoryId = cat.id;
      if (activeShoppingCategoryId === cat.id) tab.classList.add('active');
      tabsContainer.appendChild(tab);
    });


    let productsToShow;
    if (activeShoppingCategoryId === 'all') {
      productsToShow = allProducts;
    } else {
      productsToShow = allProducts.filter(p => p.categoryId === activeShoppingCategoryId);
    }


    if (productsToShow.length === 0) {
      const message = activeShoppingCategoryId === 'all' ?
        'ÂïÜÂ∫óÁ©∫Á©∫Â¶Ç‰πüÔºåÁÇπÂáª‚ÄúÁÆ°ÁêÜ‚ÄùÊ∑ªÂä†ÂïÜÂìÅÂêßÔºÅ' :
        'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâÂïÜÂìÅÂì¶~';
      gridEl.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">${message}</p>`;
      return;
    }

    productsToShow.forEach(product => {
      const item = document.createElement('div');
      item.className = 'product-item';
      item.dataset.id = product.id;

      const managementControls = isProductManagementMode ? `
            <div class="product-management-overlay">
                <button class="edit-product-btn">ÁºñËæë</button>
                <button class="delete-product-btn">Âà†Èô§</button>
            </div>
        ` : '';

      item.innerHTML = `
            ${managementControls}
            <img src="${product.imageUrl}" class="product-image">
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-footer">
                    <div class="product-price">${product.price.toFixed(2)}</div>
                    <button class="add-to-cart-btn">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</button>
                </div>
            </div>
        `;
      gridEl.appendChild(item);
    });
  }


  async function addToCart(productId, quantity = 1, variation = null) {

    const existingItem = variation ?
      shoppingCart.find(item => item.productId === productId && item.variation?.name === variation.name) :
      shoppingCart.find(item => item.productId === productId && !item.variation);

    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      const product = await db.shoppingProducts.get(productId);
      if (product) {
        shoppingCart.push({
          productId: product.id,
          quantity: quantity,
          variation: variation
        });
      }
    }
    updateCartCount();
  }

 
  function updateCartItemQuantity(productId, change) {
    const itemIndex = shoppingCart.findIndex(item => item.productId === productId);
    if (itemIndex > -1) {
      shoppingCart[itemIndex].quantity += change;
      if (shoppingCart[itemIndex].quantity <= 0) {
        shoppingCart.splice(itemIndex, 1);
      }
      updateCartCount();
      renderCartItems();
    }
  }

 
  function updateCartCount() {
    const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('cart-count').textContent = totalItems;
    document.getElementById('cart-title').textContent = `Ë¥≠Áâ©ËΩ¶(${totalItems})`;
    document.getElementById('checkout-btn').textContent = `ÁªìÁÆó(${totalItems})`;
  }

  
  function openCartScreen() {
    renderCartItems();
    showScreen('cart-screen');
  }


 
  async function renderCartItems() {
    const listEl = document.getElementById('cart-items-list');
    listEl.innerHTML = '';
    let total = 0;

    if (shoppingCart.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑÂì¶~</p>';
    } else {
      const productIds = shoppingCart.map(item => item.productId);
      const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
      const productMap = new Map(products.map(p => [p.id, p]));

      shoppingCart.forEach(item => {
        const product = productMap.get(item.productId);
        if (product) {
          const itemEl = document.createElement('div');
          itemEl.className = 'cart-item';


          const variationHtml = item.variation ?
            `<div class="cart-item-variation" style="font-size: 12px; color: #8a8a8a; margin-top: 4px;">Ê¨æÂºè: ${item.variation.name}</div>` :
            '';

          itemEl.innerHTML = `
                            <input type="checkbox" class="cart-item-checkbox" data-id="${product.id}" checked>
                            <img src="${item.variation?.imageUrl || product.imageUrl}" class="cart-item-image">
                            <div class="cart-item-info">
                                <div class="cart-item-name">${product.name}</div>
                                ${variationHtml}
                                <div class="cart-item-footer">
                                    <div class="cart-item-price">¬•${(item.variation?.price || product.price).toFixed(2)}</div>
                                    <div class="quantity-control">
                                        <button class="quantity-btn decrease-qty-btn" data-id="${product.id}">-</button>
                                        <span class="quantity-display">${item.quantity}</span>
                                        <button class="quantity-btn increase-qty-btn" data-id="${product.id}">+</button>
                                    </div>
                                </div>
                            </div>
                        `;
          listEl.appendChild(itemEl);
        }
      });
    }
    updateCartTotal();
  }



  async function updateCartTotal() {
    let total = 0;
    const selectedCheckboxes = document.querySelectorAll('.cart-item-checkbox:checked');
    const selectedProductIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

    if (selectedProductIds.length > 0) {
      const products = await db.shoppingProducts.where('id').anyOf(selectedProductIds).toArray();
      const productMap = new Map(products.map(p => [p.id, p]));

      shoppingCart.forEach(cartItem => {
        if (selectedProductIds.includes(cartItem.productId)) {
          const product = productMap.get(cartItem.productId);
          if (product) {

            const price = cartItem.variation ? cartItem.variation.price : product.price;
            total += price * cartItem.quantity;
          }
        }
      });
    }
    document.getElementById('cart-total').textContent = `ÂêàËÆ°: ¬•${total.toFixed(2)}`;
  }

  
  async function openGiftRecipientPicker() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !chat.isGroup) return;

    const modal = document.getElementById('gift-recipient-modal');
    const listEl = document.getElementById('gift-recipient-list');
    listEl.innerHTML = '';


    const myNickname = chat.settings.myNickname || 'Êàë';
    const members = chat.members.filter(m => m.groupNickname !== myNickname);

    members.forEach(member => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';

      item.dataset.recipientName = member.originalName;

      item.innerHTML = `
                    <div class="checkbox"></div>
                    <img src="${member.avatar || defaultGroupMemberAvatar}" class="avatar">
                    <span class="name">${member.groupNickname}</span>
                `;
      listEl.appendChild(item);
    });


    document.getElementById('select-all-recipients').checked = false;
    modal.classList.add('visible');
  }

  
// --- ‰øÆÂ§çÁâàV2ÔºöË¥≠Áâ©ÁªìÁÆó (‰øÆÂ§çIDËß£ÊûêbugÔºåÁ°Æ‰øùÊâ£Ê¨æÂíåËÆ∞Ë¥¶) ---
async function handleCheckout() {
    const chat = state.chats[state.activeChatId];
    const selectedItems = shoppingCart.filter(item =>
      document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
    );

    if (selectedItems.length === 0) {
      alert("ËØ∑ÂÖàÂú®Ë¥≠Áâ©ËΩ¶‰∏≠ÈÄâÊã©Ë¶ÅÁªìÁÆóÁöÑÂïÜÂìÅ„ÄÇ");
      return;
    }

    // ËÆ°ÁÆóÊÄª‰ª∑
    const productIds = selectedItems.map(item => item.productId);
    const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
    const productMap = new Map(products.map(p => [p.id, p]));
    
    let totalCost = 0;
    selectedItems.forEach(cartItem => {
        const product = productMap.get(cartItem.productId);
        if (product) {
             const price = cartItem.variation ? cartItem.variation.price : product.price;
             totalCost += price * cartItem.quantity;
        }
    });

    // 1. ÂáÜÂ§áÊîØ‰ªòÈÄâÈ°π
    const wallet = await db.userWallet.get('main') || { balance: 0, kinshipCards: [] };
    const balance = wallet.balance || 0;
    const kinshipCards = wallet.kinshipCards || [];
    
    const iconWallet = `<div class="pay-opt-icon" style="background:#1677ff; display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">ÊîØ</div>`;
    const iconKinship = `<div class="pay-opt-icon" style="background:linear-gradient(135deg, #ff5252, #ff1744); display:flex; align-items:center; justify-content:center; color:white; font-size:14px; border-radius:4px;">‰∫≤</div>`;

    const paymentOptions = [];
    
    if (balance >= totalCost) {
        paymentOptions.push({ 
            text: `<div class="pay-opt-left">${iconWallet}<div class="pay-opt-info"><span class="pay-opt-title">Ë¥¶Êà∑‰ΩôÈ¢ù</span><span class="pay-opt-desc">Ââ©‰Ωô ¬•${balance.toFixed(2)}</span></div></div>`, 
            value: 'balance' 
        });
    }
    
    kinshipCards.forEach(card => {
        const providerChat = state.chats[card.chatId];
        const name = providerChat ? providerChat.name : 'Êú™Áü•';
        const remaining = card.limit - (card.spent || 0);
        
        if (remaining >= totalCost) {
            paymentOptions.push({ 
                text: `<div class="pay-opt-left">${iconKinship}<div class="pay-opt-info"><span class="pay-opt-title">‰∫≤Â±ûÂç° - ${name}</span><span class="pay-opt-desc">Ââ©‰ΩôÈ¢ùÂ∫¶ ¬•${remaining.toFixed(2)}</span></div></div>`, 
                value: `kinship_${card.chatId}` 
            });
        }
    });

    if (paymentOptions.length === 0) {
        await showCustomAlert('ÊîØ‰ªòÂ§±Ë¥•', `‰ΩôÈ¢ùÊàñ‰∫≤Â±ûÂç°È¢ùÂ∫¶‰∏çË∂≥ÔºÅ\nÈúÄË¶Å: ¬•${totalCost.toFixed(2)}`);
        return;
    }

    // 2. ÂºπÂá∫ÊîØ‰ªòÈÄâÊã©
    const paymentMethod = await showChoiceModal(`ÊîØ‰ªò ¬•${totalCost.toFixed(2)}`, paymentOptions);
    if (!paymentMethod) return;

    let transactionDesc = selectedItems.length === 1 ? `Ë¥≠‰π∞-${productMap.get(selectedItems[0].productId).name}` : `Ë¥≠‰π∞-${selectedItems.length}‰ª∂ÂïÜÂìÅ`;

    // 3. ÊâßË°åÊâ£Ê¨æÂíåËÆ∞Ë¥¶
    if (paymentMethod === 'balance') {
        const success = await processTransaction(totalCost, 'expense', transactionDesc);
        if (!success) return;
    } else if (paymentMethod.startsWith('kinship_')) {
        const cardChatId = paymentMethod.replace('kinship_', '');
        const cardIndex = wallet.kinshipCards.findIndex(c => c.chatId === cardChatId);
        
        if (cardIndex > -1) {
            // A. Êâ£È¢ùÂ∫¶
            wallet.kinshipCards[cardIndex].spent = (wallet.kinshipCards[cardIndex].spent || 0) + totalCost;
            await db.userWallet.put(wallet); 
            
            // B. ËÆ∞Ë¥¶
            await db.userTransactions.add({
                timestamp: Date.now(),
                type: 'expense',
                amount: totalCost,
                description: `‰∫≤Â±ûÂç°-${transactionDesc}`
            });

            // C. ÈÄöÁü•Èáë‰∏ª (ÁîüÊàêÂèØËßÅÁöÑÁ≥ªÁªüÈÄöÁü•ÔºåÊñπ‰æøÂà†Èô§)
            const providerChat = state.chats[cardChatId];
            if (providerChat) {
                const itemNames = selectedItems.map(i => productMap.get(i.productId).name).join('„ÄÅ');
                const remaining = wallet.kinshipCards[cardIndex].limit - wallet.kinshipCards[cardIndex].spent;
                
                const notifyMsg = {
                    role: 'system',
                    type: 'pat_message', // „Äê‰øÆÊîπ„Äë‰ΩøÁî®ÁÅ∞Ëâ≤Á≥ªÁªüÊ∂àÊÅØÊ†∑Âºè
                    content: `‰Ω†‰ΩøÁî®‰∫≤Â±ûÂç°Ê∂àË¥π ¬•${totalCost.toFixed(2)} Ë¥≠‰π∞‰∫ÜÔºö${itemNames} (‰Ωô ¬•${remaining.toFixed(2)})`,
                    timestamp: Date.now()
                    // „Äê‰øÆÊîπ„ÄëÁßªÈô§ isHidden: trueÔºå‰ΩøÂÖ∂ÂèØËßÅ
                };
                providerChat.history.push(notifyMsg);
                await db.chats.put(providerChat);
                
                // Â¶ÇÊûúÂΩìÂâçÂ∞±Âú®ËØ•ËÅäÂ§©ÔºåÁ´ãÂç≥ÊòæÁ§∫
                if (state.activeChatId === cardChatId) {
                    appendMessage(notifyMsg, providerChat);
                }
            }
        } else {
             alert("Á≥ªÁªüÈîôËØØÔºöÊâæ‰∏çÂà∞ÂØπÂ∫îÁöÑ‰∫≤Â±ûÂç°ËÆ∞ÂΩïÔºåÊîØ‰ªòÂèñÊ∂à„ÄÇ");
             return;
        }
    }

    // 4. ÂêéÁª≠ÈÄªËæëÔºöÈÄâÊã©Áî®ÈÄî (ÈÄÅÁ§º vs Ëá™Áî®)
    if (chat.isGroup) {
        // Áæ§ËÅäÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºöÈÄâÊã©Áæ§ÂèãËµ†ÈÄÅ
        openGiftRecipientPicker();
    } else {
        // ÂçïËÅäÈÄªËæëÔºöÂ¢ûÂä†ÈÄâÊã©ÂºπÁ™ó
        const usageChoice = await showChoiceModal('Ë¥≠‰π∞ÊàêÂäüÔºÅËØ∑ÈÄâÊã©Áî®ÈÄî', [
            { text: 'üéÅ ÈÄÅÁªô TA', value: 'gift' },
            { text: 'üõçÔ∏è ÁïôÁªôËá™Â∑±', value: 'self' }
        ]);

        if (usageChoice === 'gift') {
            // ÈÄÅÁ§ºÊµÅÁ®ã (sendGiftMessage ÂÜÖÈÉ®‰ºöÂ§ÑÁêÜË¥≠Áâ©ËΩ¶Ê∏ÖÁêÜÂíåË∑≥ËΩ¨)
            await sendGiftMessage(selectedItems);
        } else {
            // Ëá™Áî®ÊµÅÁ®ã
            // 1. ‰ªéË¥≠Áâ©ËΩ¶ÁßªÈô§ÂïÜÂìÅ
            shoppingCart = shoppingCart.filter(item => !selectedItems.some(sent => sent.productId === item.productId));
            updateCartCount();
            
            // 2. Â¶ÇÊûúÊòØ‰ΩôÈ¢ùÊîØ‰ªòÔºå‰πüË°•‰∏ÄÊù°ÂèØËßÅÈÄöÁü• (‰∫≤Â±ûÂç°ÂàöÊâçÂ∑≤ÁªèÂèëËøá‰∫Ü)
            if (paymentMethod === 'balance') {
                const itemNames = selectedItems.map(i => productMap.get(i.productId).name).join('„ÄÅ');
                const selfBuyMsg = {
                    role: 'system',
                    type: 'pat_message',
                    content: `‰Ω†Ë¥≠‰π∞‰∫ÜÔºö${itemNames}`,
                    timestamp: Date.now()
                };
                chat.history.push(selfBuyMsg);
                await db.chats.put(chat);
            }
            
            // 3. ËøîÂõûËÅäÂ§©ÁïåÈù¢
            showScreen('chat-interface-screen');
            // Â¶ÇÊûúÂàöÊâçÊúâÊñ∞Ê∂àÊÅØÊé®ÂÖ•Ôºà‰ΩôÈ¢ùÊîØ‰ªòÈÄöÁü•ÔºâÔºåÂà∑Êñ∞‰∏Ä‰∏ãÁïåÈù¢
            if (paymentMethod === 'balance') {
                renderChatInterface(state.activeChatId);
            }
        }
    }
}

 
  async function sendGiftMessage(itemsToSend, recipients = null) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];

    const productIds = itemsToSend.map(item => item.productId);
    const products = await db.shoppingProducts.where('id').anyOf(productIds).toArray();
    const productMap = new Map(products.map(p => [p.id, p]));

    const itemsForMessage = itemsToSend.map(cartItem => {
      const product = productMap.get(cartItem.productId);
      if (cartItem.variation) {

        return {
          name: `${product.name} - ${cartItem.variation.name}`,
          price: cartItem.variation.price,
          imageUrl: cartItem.variation.imageUrl || product.imageUrl,
          quantity: cartItem.quantity
        };
      } else {

        return {
          name: product.name,
          price: product.price,
          imageUrl: product.imageUrl,
          quantity: cartItem.quantity
        };
      }
    });
    const giftMessage = {
      role: 'user',
      type: 'gift',
      timestamp: Date.now(),
      items: itemsForMessage,
      total: itemsForMessage.reduce((sum, item) => sum + item.price * item.quantity, 0),
      recipients: recipients
    };

    chat.history.push(giftMessage);


    if (recipients && recipients.length > 0) {
      const recipientDisplayNames = recipients.map(originalName => getDisplayNameInGroup(chat, originalName)).join('„ÄÅ');
      const hiddenMessage = {
        role: 'system',
        content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÈÄÅÂá∫‰∫Ü‰∏Ä‰ªΩÁ§ºÁâ©ÔºåÊî∂Á§º‰∫∫ÊòØÔºö${recipientDisplayNames}„ÄÇËØ∑Êî∂Á§ºÁöÑËßíËâ≤Ë°®Á§∫ÊÑüË∞¢ÔºåÂÖ∂‰ªñËßíËâ≤ÂèØ‰ª•Ëá™Áî±ÂèëÊå•„ÄÇ]`,
        timestamp: Date.now() + 1,
        isHidden: true
      };
      chat.history.push(hiddenMessage);
    }

    await db.chats.put(chat);

    appendMessage(giftMessage, chat);
    renderChatList();


    shoppingCart = shoppingCart.filter(item => !itemsToSend.some(sent => sent.productId === item.productId));
    updateCartCount();
    showScreen('chat-interface-screen');

    await showCustomAlert('ÊàêÂäü', 'Á§ºÁâ©Â∑≤ÊàêÂäüÈÄÅÂá∫ÔºÅ');
  }

  
  function showGiftReceipt(timestamp) {

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'gift') return;
    const receiptBody = document.getElementById('gift-receipt-body');
    let itemsHtml = '';
    message.items.forEach(item => {
      itemsHtml += `<tr><td class="item-name">${item.name}</td><td class="item-qty">${item.quantity}</td><td class="item-price">¬•${item.price.toFixed(2)}</td><td class="item-subtotal">¬•${(item.price * item.quantity).toFixed(2)}</td></tr>`;
    });
    receiptBody.innerHTML = `<div class="receipt-header"><h3>Ë¥≠Áâ©‰∏≠ÂøÉ</h3><p>‰∫§ÊòìÊó∂Èó¥: ${new Date(message.timestamp).toLocaleString()}</p></div><table class="receipt-items-table"><thead><tr><th class="item-name">ÂïÜÂìÅ</th><th class="item-qty">Êï∞Èáè</th><th class="item-price">Âçï‰ª∑</th><th class="item-subtotal">Â∞èËÆ°</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="receipt-total">ÊÄªËÆ°: ¬•${message.total.toFixed(2)}</div><div class="receipt-footer">ÊÑüË∞¢ÊÇ®ÁöÑÊÉ†È°æÔºåÊ¨¢ËøéÂÜçÊ¨°ÂÖâ‰∏¥ÔºÅ</div>`;
    document.getElementById('gift-receipt-modal').classList.add('visible');
  }


  async function openProductEditor(productId = null) {
    editingProductId = productId;
    const modal = document.getElementById('product-editor-modal');
    const title = document.getElementById('product-editor-title');
    const nameInput = document.getElementById('product-name-input');
    const priceInput = document.getElementById('product-price-input');
    const descInput = document.getElementById('product-description-input');
    const imagePreview = document.getElementById('product-image-preview');
    const categorySelect = document.getElementById('product-category-select');
    const variationsContainer = document.getElementById('product-variations-container');


    variationsContainer.innerHTML = '';


    categorySelect.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>';
    const categories = await db.shoppingCategories.toArray();
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.id;
      option.textContent = cat.name;
      categorySelect.appendChild(option);
    });

    if (productId) {
      title.textContent = 'ÁºñËæëÂïÜÂìÅ';
      const product = await db.shoppingProducts.get(productId);
      nameInput.value = product.name;
      priceInput.value = product.price;
      descInput.value = product.description || '';
      imagePreview.src = product.imageUrl;
      categorySelect.value = product.categoryId || '';


      if (product.variations && product.variations.length > 0) {
        product.variations.forEach(v => addProductVariationInput(v));
      }

    } else {
      title.textContent = 'Ê∑ªÂä†ÂïÜÂìÅ';
      nameInput.value = '';
      priceInput.value = '';
      descInput.value = '';
      imagePreview.src = 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756206115802_qdqqd_0c99bh.jpeg';
      categorySelect.value = '';
    }
    modal.classList.add('visible');
  }
  async function saveProduct() {
    const name = document.getElementById('product-name-input').value.trim();
    const price = parseFloat(document.getElementById('product-price-input').value);
    const description = document.getElementById('product-description-input').value.trim();
    const imageUrl = document.getElementById('product-image-preview').src;
    const categoryId = parseInt(document.getElementById('product-category-select').value) || null;

    if (!name) {
      alert('ÂïÜÂìÅÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    if (isNaN(price) || price < 0) {
      alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈªòËÆ§‰ª∑Ê†ºÔºÅ');
      return;
    }


    const variations = [];
    document.querySelectorAll('.variation-block').forEach(block => {
      const varName = block.querySelector('.variation-name-input').value.trim();
      const varPrice = parseFloat(block.querySelector('.variation-price-input').value);
      const varImageUrl = block.querySelector('.variation-image-preview').src;

      if (varName && !isNaN(varPrice) && varPrice >= 0) {
        variations.push({
          name: varName,
          price: varPrice,
          imageUrl: varImageUrl.includes('placeholder.png') ? null : varImageUrl
        });
      }
    });

    const productData = {
      name,
      price,
      description,
      imageUrl,
      categoryId,
      variations
    };

    if (editingProductId) {
      await db.shoppingProducts.update(editingProductId, productData);
    } else {
      await db.shoppingProducts.add(productData);
    }
    document.getElementById('product-editor-modal').classList.remove('visible');
    await renderShoppingProducts();
  }



 
 




 
  async function openRenderingRulesScreen() {
    await renderRulesList();
    showScreen('rendering-rules-screen');
  }



 
  async function renderRulesList() {
    const tabsContainer = document.getElementById('rules-tabs');
    const contentContainer = document.getElementById('rules-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    const allRules = await db.renderingRules.toArray();

    if (allRules.length === 0) {
        contentContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 50px;">ËøòÊ≤°Êúâ‰ªª‰ΩïÊ∏≤ÊüìËßÑÂàô„ÄÇÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÂàõÂª∫Á¨¨‰∏Ä‰∏™ÂêßÔºÅ</p>';
        return;
    }

    // 1. ÂàõÂª∫‚ÄúÂÖ¨Áî®ËßÑÂàô‚Äù Tab
    const globalTab = document.createElement('button');
    globalTab.className = 'rules-tab active';
    globalTab.textContent = 'ÂÖ¨Áî®ËßÑÂàô';
    globalTab.dataset.categoryId = 'global';
    tabsContainer.appendChild(globalTab);

    const globalPane = document.createElement('div');
    globalPane.className = 'rules-category-pane active';
    globalPane.dataset.categoryId = 'global';
    contentContainer.appendChild(globalPane);

    // 2. ‰∏∫ÊØè‰∏™ËßíËâ≤ÂàõÂª∫ Tab
    // ÊâæÂá∫ÊâÄÊúâËá≥Â∞ëÊúâ‰∏ÄÊù°ËßÑÂàôÂÖ≥ËÅîÁöÑËßíËâ≤ÔºåÊàñËÄÖÂàóÂá∫ÊâÄÊúâÂçïËÅäËßíËâ≤
    const characterChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    characterChats.forEach(chat => {
        const charTab = document.createElement('button');
        charTab.className = 'rules-tab';
        charTab.textContent = chat.name;
        charTab.dataset.categoryId = chat.id;
        tabsContainer.appendChild(charTab);

        const charPane = document.createElement('div');
        charPane.className = 'rules-category-pane';
        charPane.dataset.categoryId = chat.id;
        contentContainer.appendChild(charPane);
    });

    // 3. ÂàÜÂèëËßÑÂàôÂç°ÁâáÂà∞ÂêÑ‰∏™ Pane
    allRules.forEach(rule => {
        const card = createRuleItemElement(rule);
        
        // ÂÖºÂÆπÂ§ÑÁêÜÔºöÊ†áÂáÜÂåñ scope ‰∏∫Êï∞ÁªÑ
        const scope = Array.isArray(rule.chatId) ? rule.chatId : [rule.chatId];

        scope.forEach(targetId => {
            // ÊâæÂà∞ÂØπÂ∫îÁöÑ Pane
            const targetPane = contentContainer.querySelector(`.rules-category-pane[data-category-id="${targetId}"]`);
            
            if (targetPane) {
                // ÂÖãÈöÜÂç°ÁâáÔºàÂõ†‰∏∫Âêå‰∏Ä‰∏™ËßÑÂàôÂèØËÉΩË¶ÅÊòæÁ§∫Âú®Â§ö‰∏™TabÈáåÔºâ
                // Ê≥®ÊÑèÔºöcreateRuleItemElement ËøîÂõûÁöÑÊòØÂ∏¶‰∫ã‰ª∂ÁöÑ DOMÔºåÁõ¥Êé• appendChild ‰ºöÁßªÂä®ÂÆÉËÄå‰∏çÊòØÂ§çÂà∂
                // ÊâÄ‰ª•Êàë‰ª¨ÊúÄÂ•ΩÊØèÊ¨°ÈÉΩÂàõÂª∫Êñ∞ÁöÑ DOMÔºåÊàñËÄÖ‰ΩøÁî® cloneNode(true) Âπ∂ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
                // ËøôÈáå‰∏∫‰∫ÜÁÆÄÂçï‰∏î‰∫ã‰ª∂ÁªëÂÆöÊ≠£Á°ÆÔºåÊàë‰ª¨Áõ¥Êé•Â§çÁî® createRuleItemElement ÈÄªËæëÂ§öÊ¨°
                const cardCopy = createRuleItemElement(rule); 
                targetPane.appendChild(cardCopy);
            }
        });
    });

    // 4. ÁªëÂÆö Tab ÂàáÊç¢‰∫ã‰ª∂
    document.querySelectorAll('.rules-tab').forEach(tab => {
        tab.addEventListener('click', () => switchRuleCategory(tab.dataset.categoryId));
    });
}





  function createRuleItemElement(rule) {
    const card = document.createElement('div');
    // Âä®ÊÄÅÊ∑ªÂä† selected Á±ª
    const isSelected = selectedRules.has(rule.id);
    
    card.className = `rule-card ${rule.isEnabled ? 'enabled' : ''} ${isSelected ? 'selected' : ''}`;
    card.dataset.ruleId = rule.id;

    // Âä†ÂÖ• checkbox
    card.innerHTML = `
        <input type="checkbox" class="rule-select-checkbox" ${isSelected ? 'checked' : ''}>
        <div class="card-title">${rule.name}</div>
        <div class="card-content-preview">${escapeHTML(rule.regex)}</div>
    `;

    // ÁÇπÂáª‰∫ã‰ª∂ÂàÜÊµÅ
    card.addEventListener('click', (e) => {
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ§çÈÄâÊ°ÜÔºåÈòªÊ≠¢ÂÜíÊ≥°ÔºåÁî±‰∏ãÈù¢Â§ÑÁêÜ
        if (e.target.classList.contains('rule-select-checkbox')) {
            e.stopPropagation();
            toggleRuleSelection(rule.id);
            return;
        }

        if (isRuleManagementMode) {
            // ÁÆ°ÁêÜÊ®°Âºè‰∏ãÔºöÁÇπÂáªÂç°Áâá‰ªªÊÑè‰ΩçÁΩÆÈÉΩËßÜ‰∏∫ÂàáÊç¢ÈÄâ‰∏≠
            toggleRuleSelection(rule.id);
        } else {
            // ÊôÆÈÄöÊ®°ÂºèÔºöÊâìÂºÄÁºñËæëÂô®
            openRuleEditor(rule.id);
        }
    });

    // ÈïøÊåâËøõÂÖ•ÁÆ°ÁêÜÊ®°Âºè (ÂèØÈÄâ‰ΩìÈ™å‰ºòÂåñ)
    addLongPressListener(card, () => {
        if (!isRuleManagementMode) {
            toggleRuleManagementMode();
            toggleRuleSelection(rule.id);
        }
    });

    return card;
}

// ÂàáÊç¢ÁÆ°ÁêÜÊ®°Âºè
// ÂàáÊç¢ÁÆ°ÁêÜÊ®°Âºè
function toggleRuleManagementMode() {
    isRuleManagementMode = !isRuleManagementMode;
    const container = document.getElementById('rules-content-container');
    const actionBar = document.getElementById('rules-action-bar');
    const manageBtn = document.getElementById('manage-rules-btn');

    // ÂÆö‰πâ‰∏§‰∏™ÂõæÊ†áÁöÑ SVG Â≠óÁ¨¶‰∏≤
    const manageIconSVG = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            <polyline points="9 11 12 14 22 4"></polyline>
        </svg>`;
    
    // ‰Ω†ÂèØ‰ª•ÈÄâÊã©Áî®‰∏Ä‰∏™‚ÄúÂØπÂãæ‚ÄùÂõæÊ†áË°®Á§∫ÂÆåÊàêÔºåÊàñËÄÖÁõ¥Êé•Áî®ÊñáÂ≠ó‚ÄúÂÆåÊàê‚Äù
    // ËøôÈáåÊàë‰∏∫‰∫ÜÈ£éÊ†ºÁªü‰∏ÄÔºåÁî®‰∏Ä‰∏™ÂØπÂãæÂõæÊ†á‰ª£Êõø‚ÄúÂÆåÊàê‚ÄùÊñáÂ≠ó
    const doneIconSVG = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent-color);">
             <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;


    if (isRuleManagementMode) {
        container.classList.add('management-mode');
        actionBar.style.display = 'flex';
        
     
        manageBtn.innerHTML = doneIconSVG; // Êñ∞‰ª£Á†ÅÔºöÂàáÊç¢‰∏∫ÂÆåÊàêÂõæÊ†á
      

        // manageBtn.style.color = 'var(--accent-color)'; // ÂõæÊ†áËá™Â∏¶È¢úËâ≤‰∫ÜÔºåËøôË°åÂèØ‰ª•Ê≥®ÈáäÊéâ
    } else {
        container.classList.remove('management-mode');
        actionBar.style.display = 'none';

    
        manageBtn.innerHTML = manageIconSVG; // Êñ∞‰ª£Á†ÅÔºöÂàáÊç¢ÂõûÁÆ°ÁêÜÂõæÊ†á
     
        
        manageBtn.style.color = '';
        
        // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫ÈÄâ‰∏≠
        selectedRules.clear();
        updateRuleActionBar();
        renderRulesList(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•ÂéªÈô§ÈÄâ‰∏≠Ê†∑Âºè
    }
    
    // ÈáçÊñ∞Ê∏≤Êüì‰ª•ÊòæÁ§∫/ÈöêËóèÂ§çÈÄâÊ°Ü
    renderRulesList();
}

// ÂàáÊç¢Âçï‰∏™ÈÄâ‰∏≠Áä∂ÊÄÅ
function toggleRuleSelection(ruleId) {
    if (selectedRules.has(ruleId)) {
        selectedRules.delete(ruleId);
    } else {
        selectedRules.add(ruleId);
    }
    updateRuleActionBar();
    
    // Êõ¥Êñ∞ DOM Ê†∑Âºè (‰∏çÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®ÔºåÊèêÈ´òÊÄßËÉΩ)
    // Âõ†‰∏∫Âêå‰∏Ä‰∏™ËßÑÂàôÂèØËÉΩÂú®Â§ö‰∏™TabÊòæÁ§∫ÔºåÊâÄ‰ª•Áî® querySelectorAll
    const cards = document.querySelectorAll(`.rule-card[data-rule-id="${ruleId}"]`);
    cards.forEach(card => {
        const cb = card.querySelector('.rule-select-checkbox');
        if (selectedRules.has(ruleId)) {
            card.classList.add('selected');
            if(cb) cb.checked = true;
        } else {
            card.classList.remove('selected');
            if(cb) cb.checked = false;
        }
    });
}

// Êõ¥Êñ∞Â∫ïÈÉ®ÊåâÈíÆÁä∂ÊÄÅ
function updateRuleActionBar() {
    const count = selectedRules.size;
    const exportBtn = document.getElementById('export-selected-rules-btn');
    const deleteBtn = document.getElementById('delete-selected-rules-btn');
    
    exportBtn.textContent = `ÂØºÂá∫ (${count})`;
    deleteBtn.textContent = `Âà†Èô§ (${count})`;
    
    // ÂèØ‰ª•Âú®ËøôÈáåÂä† disable ÈÄªËæë
}

// ÂÖ®ÈÄâ/ÂèçÈÄâ
function handleSelectAllRules() {
    const isChecked = document.getElementById('select-all-rules-checkbox').checked;
    const visibleCards = document.querySelectorAll('#rules-content-container .rule-card');
    
    visibleCards.forEach(card => {
        const id = parseInt(card.dataset.ruleId);
        if (isChecked) {
            selectedRules.add(id);
        } else {
            selectedRules.delete(id);
        }
    });
    
    updateRuleActionBar();
    renderRulesList(); // ÁÆÄÂçïÊö¥ÂäõÈáçÁªòÊõ¥Êñ∞UI
}
// ÂØºÂá∫ÈÄâ‰∏≠ÁöÑËßÑÂàô
async function exportSelectedRules() {
    if (selectedRules.size === 0) {
        alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑËßÑÂàô„ÄÇ");
        return;
    }

    const rules = await db.renderingRules.where('id').anyOf([...selectedRules]).toArray();
    
    // ÊûÑÂª∫ÂØºÂá∫Êï∞ÊçÆÁªìÊûÑ
    const exportData = {
        type: 'EPhoneRenderingRules', // Ê†áËÆ∞Êñá‰ª∂Á±ªÂûã
        version: 1,
        timestamp: Date.now(),
        rules: rules.map(r => ({
            name: r.name,
            regex: r.regex,
            template: r.template,
            // ÂØºÂá∫Êó∂ÔºåÂª∫ËÆÆÊää chatId ÈáçÁΩÆ‰∏∫ ['global'] ÊàñËÄÖÁ©∫ÔºåÂõ†‰∏∫Êé•Êî∂ËÄÖÊ≤°ÊúâÂØπÂ∫îÁöÑËßíËâ≤ID
            // ‰ΩÜ‰∏∫‰∫ÜÁÅµÊ¥ªÔºåÊàë‰ª¨ÂèØ‰ª•‰øùÁïôÔºåËÆ©Áî®Êà∑ÂØºÂÖ•ÂêéËá™Â∑±Êîπ
            chatId: ['global'], 
            isEnabled: true,
            doNotSend: r.doNotSend
        }))
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const dateStr = new Date().toISOString().split('T')[0];
    link.download = `RenderingRules_Share_${dateStr}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    toggleRuleManagementMode(); // ÂØºÂá∫ÂêéÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    await showCustomAlert("ÂØºÂá∫ÊàêÂäü", `Â∑≤ÂØºÂá∫ ${rules.length} Êù°ËßÑÂàô„ÄÇ\n\nÊ≥®ÊÑèÔºö‰∏∫‰∫ÜÊñπ‰æøÂàÜ‰∫´ÔºåÂØºÂá∫ÁöÑËßÑÂàôÂ∑≤Ëá™Âä®ËÆæ‰∏∫‚ÄúÂÖ¨Áî®‚ÄùËåÉÂõ¥„ÄÇ`);
}

// Â§ÑÁêÜÊñá‰ª∂ÂØºÂÖ•
async function handleRulesImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (data.type !== 'EPhoneRenderingRules' || !Array.isArray(data.rules)) {
            throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºå‰∏çÊòØÊúâÊïàÁöÑÊ∏≤ÊüìËßÑÂàôÂàÜ‰∫´Êñá‰ª∂„ÄÇ");
        }

        const confirmed = await showCustomConfirm(
            "ÂØºÂÖ•ËßÑÂàô",
            `ÂèëÁé∞ ${data.rules.length} Êù°Ê∏≤ÊüìËßÑÂàô„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÂØºÂÖ•ÂêóÔºü`,
            { confirmText: "ÂØºÂÖ•" }
        );

        if (confirmed) {
            let addedCount = 0;
            // ÈÅçÂéÜÂπ∂Ê∑ªÂä†ÔºåÁîüÊàêÊñ∞ID
            for (const rule of data.rules) {
                // ÁÆÄÂçïÁöÑÈò≤ÈáçÂ§çÊ£ÄÊü• (ÂèØÈÄâÔºöÂ¶ÇÊûúÂêçÂ≠óÂíåÊ≠£ÂàôÂÆåÂÖ®‰∏ÄÊ†∑ÂàôË∑≥Ëøá)
                // ËøôÈáåÁõ¥Êé•Ê∑ªÂä†ÔºåÂπ∂Âú®ÂêçÂ≠óÂêéÂä† (Imported) ‰ª•Á§∫Âå∫ÂàÜ
                await db.renderingRules.add({
                    name: rule.name + " (ÂØºÂÖ•)",
                    chatId: rule.chatId || ['global'],
                    regex: rule.regex,
                    template: rule.template,
                    isEnabled: true,
                    doNotSend: rule.doNotSend || false
                });
                addedCount++;
            }
            
            // Âà∑Êñ∞
            ruleCache = {}; // Ê∏ÖÁ©∫Ê∏≤ÊüìÁºìÂ≠ò
            await renderRulesList();
            await showCustomAlert("ÊàêÂäü", `Â∑≤ÊàêÂäüÂØºÂÖ• ${addedCount} Êù°ËßÑÂàôÔºÅ`);
        }

    } catch (error) {
        console.error(error);
        alert("ÂØºÂÖ•Â§±Ë¥•: " + error.message);
    } finally {
        event.target.value = null; // ÈáçÁΩÆ input
    }
}

// ÊâπÈáèÂà†Èô§
async function deleteSelectedRules() {
    if (selectedRules.size === 0) return;
    
    const confirmed = await showCustomConfirm(
        "Á°ÆËÆ§Âà†Èô§",
        `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedRules.size} Êù°ËßÑÂàôÂêóÔºü`,
        { confirmButtonClass: 'btn-danger' }
    );
    
    if (confirmed) {
        await db.renderingRules.bulkDelete([...selectedRules]);
        ruleCache = {}; // Ê∏ÖÁ©∫ÁºìÂ≠ò
        selectedRules.clear();
        
        // Âà∑Êñ∞
        toggleRuleManagementMode(); // ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°ÂºèÂπ∂Âà∑Êñ∞
    }
}

  async function openRuleEditor(ruleId = null) {
    editingRuleId = ruleId;
    const modal = document.getElementById('rule-editor-modal');
    const title = document.getElementById('rule-editor-title');
    const nameInput = document.getElementById('rule-name-input');
    // const chatIdSelect = document.getElementById('rule-chat-id-select'); // ÊóßÁöÑ select ‰∏çÁî®‰∫Ü
    
    // 1. Ëé∑ÂèñÊàñÂàõÂª∫Â§çÈÄâÊ°ÜÂÆπÂô® (Â¶ÇÊûúHTMLÈáåÊ≤°ÊúâËøô‰∏™ÂÆπÂô®ÔºåÊàë‰ª¨ÈúÄË¶ÅÂä®ÊÄÅÂ§ÑÁêÜ)
    let scopeContainer = document.getElementById('rule-scope-checkboxes');
    if (!scopeContainer) {
        // Â∞ùËØïÊâæÂà∞ÂéüÊù•ÁöÑ select ÊâÄÂú®ÁöÑÁà∂Á∫ßÊàñ‰ΩçÁΩÆÔºåÊõøÊç¢ÂÆÉ
        const oldSelect = document.getElementById('rule-chat-id-select');
        if (oldSelect) {
            scopeContainer = document.createElement('div');
            scopeContainer.id = 'rule-scope-checkboxes';
            scopeContainer.style.cssText = "max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f9f9f9;";
            oldSelect.parentNode.insertBefore(scopeContainer, oldSelect);
            oldSelect.style.display = 'none'; // ÈöêËóèÊóßÁöÑselect
        }
    }

    const regexInput = document.getElementById('rule-regex-input');
    const templateInput = document.getElementById('rule-template-input');
    const enabledSwitch = document.getElementById('rule-enabled-switch');
    const doNotSendSwitch = document.getElementById('rule-do-not-send-switch');

    // 2. ÂáÜÂ§áÁé∞ÊúâÊï∞ÊçÆ
    let currentScope = ['global']; // ÈªòËÆ§ÈÄâ‰∏≠ÂÖ¨Áî®
    let currentName = '';
    let currentRegex = '';
    let currentTemplate = '';
    let currentEnabled = true;
    let currentDoNotSend = false;

    if (ruleId) {
        title.textContent = 'ÁºñËæëËßÑÂàô';
        const rule = await db.renderingRules.get(ruleId);
        if (rule) {
            currentName = rule.name;
            currentRegex = rule.regex;
            currentTemplate = rule.template;
            currentEnabled = rule.isEnabled;
            currentDoNotSend = rule.doNotSend || false;
            
            // ÂÖºÂÆπÊóßÊï∞ÊçÆÔºöÂ¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåËΩ¨‰∏∫Êï∞ÁªÑ
            if (Array.isArray(rule.chatId)) {
                currentScope = rule.chatId;
            } else {
                currentScope = [rule.chatId]; 
            }
        }
    } else {
        title.textContent = 'ÂàõÂª∫Êñ∞ËßÑÂàô';
    }

    // 3. Â°´ÂÖÖË°®ÂçïÂÄº
    nameInput.value = currentName;
    regexInput.value = currentRegex;
    templateInput.value = currentTemplate;
    enabledSwitch.checked = currentEnabled;
    doNotSendSwitch.checked = currentDoNotSend;

    // 4. Ê∏≤ÊüìÂ§çÈÄâÊ°ÜÂàóË°®
    if (scopeContainer) {
        scopeContainer.innerHTML = '';
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÂàõÂª∫ÁæéÂåñÁöÑÂàóË°®È°π
        const createScopeItem = (value, name, desc, avatarUrl = null, isChecked = false) => {
            const item = document.createElement('div');
            item.className = 'rule-scope-item';
            
            // 1. Â∑¶‰æßËßÜËßâÂÖÉÁ¥† (Â§¥ÂÉèÊàñÂõæÊ†á)
            let visualHtml = '';
            if (value === 'global') {
                // ÂÖ®Â±ÄÂõæÊ†á
                visualHtml = `<div class="rule-scope-icon-box">üåê</div>`;
            } else {
                // ËßíËâ≤Â§¥ÂÉè (Â¶ÇÊûúÊúâÔºåÂê¶ÂàôÁî®ÈªòËÆ§)
                const src = avatarUrl || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'; // ÈªòËÆ§Â§¥ÂÉè
                visualHtml = `<img src="${src}" class="rule-scope-avatar">`;
            }

            // 2. Â§çÈÄâÊ°Ü HTML
            const checkboxHtml = `<input type="checkbox" value="${value}" class="rule-scope-cb" ${isChecked ? 'checked' : ''}>`;

            // 3. ÁªÑË£ÖÂÜÖÂÆπ
            item.innerHTML = `
                ${checkboxHtml}
                ${visualHtml}
                <div class="rule-scope-info">
                    <span class="rule-scope-name">${name}</span>
                    ${desc ? `<span class="rule-scope-desc">${desc}</span>` : ''}
                </div>
            `;

            // 4. ÁÇπÂáªÊï¥Ë°åËß¶ÂèëÈÄâ‰∏≠ (ÊèêÂçá‰ΩìÈ™å)
            item.addEventListener('click', (e) => {
                // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÂ§çÈÄâÊ°ÜÊú¨Ë∫´ÔºåÂ∞±ÊâãÂä®ÂàáÊç¢Â§çÈÄâÊ°ÜÁä∂ÊÄÅ
                if (e.target.type !== 'checkbox') {
                    const cb = item.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                }
            });

            return item;
        };

        // --- Ê∑ªÂä† "ÂÖ¨Áî®" ÈÄâÈ°π ---
        scopeContainer.appendChild(createScopeItem(
            'global', 
            'ÂÖ¨Áî®ËßÑÂàô', 
            'ÂØπÊâÄÊúâËßíËâ≤ÁîüÊïà', 
            null, 
            currentScope.includes('global')
        ));

        // --- Ê∑ªÂä† "ËßíËâ≤" ÂàóË°® ---
        const chars = Object.values(state.chats).filter(c => !c.isGroup);
        chars.forEach(chat => {
            scopeContainer.appendChild(createScopeItem(
                chat.id, 
                chat.name, 
                chat.settings.aiPersona ? chat.settings.aiPersona.substring(0, 15) + '...' : '', // ÊòæÁ§∫‰∏ÄÁÇπ‰∫∫ËÆæÊëòË¶Å
                chat.settings.aiAvatar, 
                currentScope.includes(chat.id)
            ));
        });
        
        // (ÂèØÈÄâ) Â¶ÇÊûú‰Ω†Â∏åÊúõÂàóË°®Â§™ÈïøÊó∂ÊúâÊªöÂä®ÊèêÁ§∫ÔºåËøôÈáå CSS Â∑≤ÁªèÂ§ÑÁêÜ‰∫Ü max-height Âíå overflow
    }

    modal.classList.add('visible');
}


  async function saveRenderingRule() {
    const name = document.getElementById('rule-name-input').value.trim();
    const regex = document.getElementById('rule-regex-input').value.trim();
    
    if (!name || !regex) {
        alert("ËßÑÂàôÂêçÁß∞ÂíåÊ≠£ÂàôË°®ËææÂºè‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        return;
    }
    try {
        new RegExp(regex);
    } catch (e) {
        alert(`Ê≠£ÂàôË°®ËææÂºèÊ†ºÂºèÈîôËØØ: ${e.message}`);
        return;
    }

    // 1. Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËåÉÂõ¥ (Array)
    const checkboxes = document.querySelectorAll('.rule-scope-cb:checked');
    const selectedScope = Array.from(checkboxes).map(cb => cb.value);

    if (selectedScope.length === 0) {
        alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÁªëÂÆöËåÉÂõ¥ÔºàÂÖ¨Áî®ÊàñÊåáÂÆöËßíËâ≤ÔºâÔºÅ");
        return;
    }

    const ruleData = {
        name: name,
        chatId: selectedScope, // Áé∞Âú®‰øùÂ≠òÁöÑÊòØÊï∞ÁªÑ ['global', 'chat_123'] Á≠â
        regex: regex,
        template: document.getElementById('rule-template-input').value,
        isEnabled: document.getElementById('rule-enabled-switch').checked,
        doNotSend: document.getElementById('rule-do-not-send-switch').checked
    };

    if (editingRuleId) {
        await db.renderingRules.update(editingRuleId, ruleData);
    } else {
        await db.renderingRules.add(ruleData);
    }

    // Ê∏ÖÁ©∫ÁºìÂ≠òÔºåÁ°Æ‰øùÁ´ãÂç≥ÁîüÊïà
    ruleCache = {};

    document.getElementById('rule-editor-modal').classList.remove('visible');
    await renderRulesList();
}


  async function deleteRenderingRule(ruleId) {
    const confirmed = await showCustomConfirm('Âà†Èô§ËßÑÂàô', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∏≤ÊüìËßÑÂàôÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.renderingRules.delete(ruleId);
      await renderRulesList();
    }
  }
 
  async function filterHistoryWithDoNotSendRules(history, chatId) {
    // 1. Ëé∑ÂèñÊâÄÊúâËßÑÂàô
    const allRules = await db.renderingRules.toArray();

    // 2. Á≠õÈÄâÂá∫Ôºö(ÂêØÁî®‰∫ÜDoNotSend) AND (ËåÉÂõ¥ÂåÖÂê´GlobalÊàñÂΩìÂâçChatId)
    const doNotSendRules = allRules.filter(rule => {
        if (!rule.doNotSend) return false; // ÂøÖÈ°ªÊòØ DoNotSend Á±ªÂûãÁöÑ

        // ÂÖºÂÆπÂ§ÑÁêÜÔºöÁ°Æ‰øùÊòØÊï∞ÁªÑ
        const scope = Array.isArray(rule.chatId) ? rule.chatId : [rule.chatId];

        // ÂåπÈÖçËåÉÂõ¥
        return scope.includes('global') || scope.includes(chatId);
    });

    if (doNotSendRules.length === 0) {
        return history;
    }

    const modifiedHistory = history.map(msg => {
        if (typeof msg.content !== 'string' || !msg.content) {
            return msg;
        }

        const modifiedMsg = { ...msg };
        let newContent = msg.content;

        for (const rule of doNotSendRules) {
            try {
                let regex;
                const regexString = rule.regex || rule.findRegex;

                if (!regexString) continue;

                if (regexString.startsWith('/') && regexString.lastIndexOf('/') > 0) {
                    const lastSlash = regexString.lastIndexOf('/');
                    const pattern = regexString.substring(1, lastSlash);
                    const flags = regexString.substring(lastSlash + 1);
                    regex = new RegExp(pattern, flags);
                } else {
                    regex = new RegExp(regexString, 'g');
                }

                if (regex.test(newContent)) {
                    newContent = newContent.replace(regex, '');
                    console.log(`[ÂÜÖÂÆπÊõøÊç¢] ËßÑÂàô "${rule.name}" ÂëΩ‰∏≠ (DoNotSend)„ÄÇÊ≠£Âú®ËøáÊª§...`);
                }

            } catch (e) {
                console.error(`[ËøáÊª§ËßÑÂàôÈîôËØØ] ËßÑÂàô "${rule.name}" Êó†Êïà:`, e);
            }
        }

        modifiedMsg.content = newContent;
        return modifiedMsg;
    });

    return modifiedHistory;
}

  async function applyRenderingRules(rawContent, chatId) {
    if (!rawContent || typeof rawContent !== 'string') {
        return rawContent;
    }

    // ÁºìÂ≠òÊú∫Âà∂Êõ¥Êñ∞Ôºö‰∏çÂÜçÂü∫‰∫éÂçï‰∏ÄIDÂÅöKeyÔºåËÄåÊòØËé∑ÂèñÊâÄÊúâÂêØÁî®ÁöÑËßÑÂàôÂπ∂Âú®ÂÜÖÂ≠ò‰∏≠ÂåπÈÖç
    if (!ruleCache['active_rules_list']) {
        const allRules = await db.renderingRules.toArray();
        // ËøáÊª§Âá∫ÊâÄÊúâÂ∑≤ÂêØÁî®ÁöÑËßÑÂàô
        ruleCache['active_rules_list'] = allRules.filter(r => r.isEnabled);
    }
    
    const allActiveRules = ruleCache['active_rules_list'];

    // Á≠õÈÄâÂá∫ÈÄÇÁî®‰∫éÂΩìÂâç chatId ÁöÑËßÑÂàô
    const applicableRules = allActiveRules.filter(rule => {
        // ÂÖºÂÆπÂ§ÑÁêÜÔºöÁ°Æ‰øùÊòØÊï∞ÁªÑ
        const scope = Array.isArray(rule.chatId) ? rule.chatId : [rule.chatId];
        
        // Âà§Êñ≠ÈÄªËæëÔºöÂ¶ÇÊûúÊòØglobal ÊàñËÄÖ ÂåÖÂê´ÂΩìÂâçchatId
        return scope.includes('global') || scope.includes(chatId);
    });

    let processedContent = rawContent;

    for (const rule of applicableRules) {
        try {
            let regex;
            const regexString = rule.regex || rule.findRegex;
            const replacementString = rule.template ?? rule.replaceString;

            if (!regexString) continue;

            if (regexString.startsWith('/') && regexString.lastIndexOf('/') > 0) {
                const lastSlash = regexString.lastIndexOf('/');
                const pattern = regexString.substring(1, lastSlash);
                const flags = regexString.substring(lastSlash + 1);
                try {
                    regex = new RegExp(pattern, flags);
                } catch (e) {
                    regex = new RegExp(regexString, 'g');
                }
            } else {
                regex = new RegExp(regexString, 'g');
            }

            processedContent = processedContent.replace(regex, replacementString);

        } catch (e) {
            console.error(`Ê∏≤ÊüìËßÑÂàô [${rule.name}] ÊâßË°åÂá∫Èîô:`, e);
        }
    }

    return processedContent;
}



  function formatSystemTimestamp(timestamp) {
    if (!timestamp) return '';
    const now = new Date();
    const date = new Date(timestamp);

    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const timeString = `${hours}:${minutes}`;


    if (now.toDateString() === date.toDateString()) {
      return timeString;
    }


    const yesterday = new Date();
    yesterday.setDate(now.getDate() - 1);
    if (yesterday.toDateString() === date.toDateString()) {
      return `Êò®Â§© ${timeString}`;
    }


    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');

    if (now.getFullYear() === year) {
      return `${month}Êúà${day}Êó• ${timeString}`;
    } else {
      return `${year}Âπ¥${month}Êúà${day}Êó• ${timeString}`;
    }
  }

 
  function createSystemTimestampElement(timestamp) {
    const wrapper = document.createElement('div');

    wrapper.className = 'message-wrapper system-pat';

    const bubble = document.createElement('div');

    bubble.className = 'message-bubble system-bubble';
    bubble.textContent = formatSystemTimestamp(timestamp);

    wrapper.appendChild(bubble);
    return wrapper;
  }



  async function handleSpectatorReroll() {
    const chat = state.chats[state.activeChatId];
    if (!chat || !lastResponseTimestamps || lastResponseTimestamps.length === 0) {
      alert("Ê≤°ÊúâÂèØ‰æõÈáçÊñ∞ÁîüÊàêÁöÑAIÂìçÂ∫î„ÄÇ");
      return;
    }


    chat.history = chat.history.filter(msg => !lastResponseTimestamps.includes(msg.timestamp));


    await db.chats.put(chat);
    await renderChatInterface(state.activeChatId);


    triggerSpectatorGroupAiAction();
  }
 
  async function handleRegenerateNaiImage(timestamp, buttonElement) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msgIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (msgIndex === -1) return;

    const message = chat.history[msgIndex];

  
    const originalPrompt = message.prompt;

    if (!originalPrompt) {
      await showCustomAlert("Êó†Ê≥ïÈáçÊñ∞ÁîüÊàê", "Êú™ÊâæÂà∞ËØ•ÂõæÁâáÁöÑÂéüÂßãÊèêÁ§∫ËØç(prompt)„ÄÇ");
      return;
    }

  
    buttonElement.disabled = true;
    buttonElement.classList.add('loading');
    const bubble = buttonElement.closest('.message-bubble');
    const imgElement = bubble ? bubble.querySelector('.realimag-image') : null;
    if (imgElement) {
      imgElement.style.opacity = '0.5';
    }

    try {
     
      const generatedData = await generateNaiImageFromPrompt(originalPrompt, chat.id);

    
      message.imageUrl = generatedData.imageUrl;
      message.fullPrompt = generatedData.fullPrompt; 

  
      await db.chats.put(chat);

      if (imgElement) {
        imgElement.src = generatedData.imageUrl;
        imgElement.title = generatedData.fullPrompt;
        imgElement.style.opacity = '1';
      }

    } catch (error) {
      console.error("ÈáçÊñ∞ÁîüÊàêNAIÂõæÁâáÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõæÁâá: ${error.message}`);
      if (imgElement) {
        imgElement.style.opacity = '1';
      }
    } finally {
  
      buttonElement.disabled = false;
      buttonElement.classList.remove('loading');
    }
  }
async function handleSilentUploadUserImage(timestamp, buttonElement) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msgIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (msgIndex === -1) return;

    const message = chat.history[msgIndex];
    if (!message || message.role !== 'user' || !Array.isArray(message.content) || !message.content[0]?.type === 'image_url') {
        alert("ÈîôËØØÔºöÊ∂àÊÅØÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ");
        return;
    }

    const base64Url = message.content[0].image_url.url;
    if (!base64Url || !base64Url.startsWith('data:image')) {
        alert("ÈîôËØØÔºöËøôÂº†ÂõæÁâáÂ∑≤ÁªèÊòØURLÔºåÊàñÊï∞ÊçÆÂ∑≤ÊçüÂùè„ÄÇ");
        return;
    }

    // 1. ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    buttonElement.disabled = true;
    buttonElement.classList.add('loading');
    const bubble = buttonElement.closest('.message-bubble');
    const imgElement = bubble ? bubble.querySelector('.chat-image') : null;
    if (imgElement) imgElement.style.opacity = '0.5';

    try {
        // 2. Ë∞ÉÁî®Â∑≤ÊúâÁöÑ‰∏ä‰º†ÂáΩÊï∞ (Ê≠§ÂáΩÊï∞Âú® 1629 Ë°å)
        const newUrl = await uploadImageToImgBB(base64Url);

        if (newUrl === base64Url) {
            throw new Error("‰∏ä‰º†ÂáΩÊï∞ËøîÂõû‰∫ÜÂéüÂßãBase64ÔºåÂèØËÉΩ‰∏ä‰º†Â§±Ë¥•ÊàñË¢´Ë∑≥Ëøá„ÄÇ");
        }

        // 3. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊ∂àÊÅØ
        message.content[0].image_url.url = newUrl; // Êõ¥Êñ∞ÁâπÂÆöÂ≠óÊÆµ
        await db.chats.put(chat);
        
        // 4. Êõ¥Êñ∞DOM‰∏≠ÁöÑÂõæÁâá
        if (imgElement) {
            imgElement.src = newUrl;
            imgElement.style.opacity = '1';
        }

        // 5. ÈöêËóèÊåâÈíÆ
        buttonElement.style.display = 'none';

    } catch (error) {
        console.error("ÈùôÈªò‰∏ä‰º†UserÂõæÁâáÂ§±Ë¥•:", error);
        await showCustomAlert("‰∏ä‰º†Â§±Ë¥•", `Êó†Ê≥ï‰∏ä‰º†Âà∞ ImgBB: ${error.message}`);
        if (imgElement) imgElement.style.opacity = '1';
    } finally {
        // 6. ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
        buttonElement.disabled = false;
        buttonElement.classList.remove('loading');
    }
}
async function handleSilentUploadNaiImage(timestamp, buttonElement) {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const msgIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (msgIndex === -1) return;

    const message = chat.history[msgIndex];
    const base64Url = message.imageUrl;

    if (!base64Url || !base64Url.startsWith('data:image')) {
        alert("ÈîôËØØÔºöËøôÂº†ÂõæÁâáÂ∑≤ÁªèÊòØURLÔºåÊàñÊï∞ÊçÆÂ∑≤ÊçüÂùè„ÄÇ");
        return;
    }

    // 1. ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    buttonElement.disabled = true;
    buttonElement.classList.add('loading');
    const bubble = buttonElement.closest('.message-bubble');
    const imgElement = bubble ? bubble.querySelector('.realimag-image') : null;
    if (imgElement) imgElement.style.opacity = '0.5';

    try {
        // 2. Ë∞ÉÁî®Â∑≤ÊúâÁöÑ‰∏ä‰º†ÂáΩÊï∞ (Ê≠§ÂáΩÊï∞Âú® 1629 Ë°å)
        const newUrl = await uploadImageToImgBB(base64Url);

        if (newUrl === base64Url) {
            throw new Error("‰∏ä‰º†ÂáΩÊï∞ËøîÂõû‰∫ÜÂéüÂßãBase64ÔºåÂèØËÉΩ‰∏ä‰º†Â§±Ë¥•ÊàñË¢´Ë∑≥Ëøá„ÄÇ");
        }

        // 3. Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊ∂àÊÅØ
        message.imageUrl = newUrl;
        await db.chats.put(chat);
        
        // 4. Êõ¥Êñ∞DOM‰∏≠ÁöÑÂõæÁâá
        if (imgElement) {
            imgElement.src = newUrl;
            imgElement.style.opacity = '1';
        }

        // 5. ÈöêËóèÊåâÈíÆ
        buttonElement.style.display = 'none';

    } catch (error) {
        console.error("ÈùôÈªò‰∏ä‰º†NAIÂõæÁâáÂ§±Ë¥•:", error);
        await showCustomAlert("‰∏ä‰º†Â§±Ë¥•", `Êó†Ê≥ï‰∏ä‰º†Âà∞ ImgBB: ${error.message}`);
        if (imgElement) imgElement.style.opacity = '1';
    } finally {
        // 6. ÁßªÈô§Âä†ËΩΩÁä∂ÊÄÅ
        buttonElement.disabled = false;
        buttonElement.classList.remove('loading');
    }
}
  async function handleRegenerateResponse() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    const lastUserMsgIndex = chat.history.findLastIndex(msg => msg.role === 'user' && !msg.isHidden);

    if (lastUserMsgIndex === -1) {
      alert("Ê≤°ÊúâÂèØ‰æõÈáçÊñ∞ÁîüÊàêÂõûÂ§çÁöÑÁî®Êà∑Ê∂àÊÅØ„ÄÇ");
      return;
    }


    const lastAiMsgIndex = chat.history.findLastIndex(msg => msg.role === 'assistant');
    if (lastAiMsgIndex < lastUserMsgIndex) {
      alert("AI Â∞öÊú™ÂØπÊÇ®ÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂÅöÂá∫ÂõûÂ∫îÔºåÊó†Ê≥ïÈáçÊñ∞ÁîüÊàê„ÄÇ");
      return;
    }


    chat.history = chat.history.slice(0, lastUserMsgIndex + 1);


    await db.chats.put(chat);
    await renderChatInterface(state.activeChatId);


    await triggerAiResponse();
  }

  async function handleRegenerateCallResponse() {
    if (!videoCallState.isActive) return;


    const lastUserSpeechIndex = videoCallState.callHistory.findLastIndex(msg => msg.role === 'user');

    if (lastUserSpeechIndex === -1) {
      alert("ÈÄöËØù‰∏≠ËøòÊ≤°Êúâ‰Ω†ÁöÑÂèëË®ÄÔºåÊó†Ê≥ïÈáçÊñ∞ÁîüÊàêÂõûÂ∫î„ÄÇ");
      return;
    }


    videoCallState.callHistory.splice(lastUserSpeechIndex + 1);


    const callFeed = document.getElementById('video-call-main');
    callFeed.innerHTML = '';
    
    // ÂêåÊó∂Êõ¥Êñ∞ÂæÆ‰ø°È£éÊ†ºÁöÑÊ∂àÊÅØÂå∫Âüü
    const wechatCallMessages = document.getElementById('wechat-call-messages');
    if (wechatCallMessages) {
      wechatCallMessages.innerHTML = '';
    }
    
    videoCallState.callHistory.forEach(msg => {
      // ÂéüÊúâÊ†∑ÂºèÁöÑÊ∞îÊ≥°
      const bubble = document.createElement('div');
      const speechClass = msg.role === 'assistant' ? 'ai-speech' : 'user-speech';
      bubble.className = `call-message-bubble ${speechClass}`;
      bubble.dataset.timestamp = msg.timestamp;
      if (msg.role === 'user') {
        bubble.textContent = msg.content;
      } else {
        // ÂØπ‰∫éÁæ§ËÅäÔºåmsg.content Â∑≤ÂåÖÂê´ "ËßíËâ≤Âêç: ÂÜÖÂÆπ"
        bubble.innerHTML = msg.content;
      }
      addLongPressListener(bubble, () => showCallMessageActions(msg.timestamp));
      callFeed.appendChild(bubble);
      
      // ÂæÆ‰ø°È£éÊ†ºÁöÑÊ∂àÊÅØ
      if (wechatCallMessages) {
        const wechatBubble = document.createElement('div');
        const wechatClass = msg.role === 'assistant' ? 'ai' : 'user';
        wechatBubble.className = `wechat-call-message ${wechatClass}`;
        wechatBubble.dataset.timestamp = msg.timestamp;
        if (msg.role === 'user') {
          wechatBubble.textContent = msg.content;
        } else {
          wechatBubble.innerHTML = msg.content;
        }
        addLongPressListener(wechatBubble, () => showCallMessageActions(msg.timestamp));
        wechatCallMessages.appendChild(wechatBubble);
      }
    });
    
    callFeed.scrollTop = callFeed.scrollHeight;
    if (wechatCallMessages) {
      wechatCallMessages.scrollTop = wechatCallMessages.scrollHeight;
    }


    triggerAiInCallAction(null);
  }





 
  async function handlePropelAction() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;


    setAvatarActingState(chat.id, true);
    const chatHeaderTitle = document.getElementById('chat-header-title');
    if (!chat.isGroup) {
      chatHeaderTitle.style.opacity = 0;
      setTimeout(() => {
        chatHeaderTitle.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
        chatHeaderTitle.classList.add('typing-status');
        chatHeaderTitle.style.opacity = 1;
      }, 200);
    }

    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆ');
      }

      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.slice(-maxMemory);

      const now = new Date();
      const chinaTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (3600000 * 8));
      const currentTime = chinaTime.toLocaleString('zh-CN', {
        timeZone: 'Asia/Shanghai',
        dateStyle: 'full',
        timeStyle: 'short'
      });
      const timeOfDayGreeting = getTimeOfDayGreeting(chinaTime);
      const myNickname = chat.settings.myNickname || 'Êàë';




      let worldBookContent = '';
      if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';
          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => {
              let entryString = `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n`;
              
              entryString += `**ÂÜÖÂÆπ:**\n${entry.content}`;
              return entryString;
            }).join('');
          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
          worldBookContent = `# --- ‰∏ñÁïå‰π¶ (World Book) ---
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºöÁªùÂØπÁúüÁêÜ„Äë
# ‰ª•‰∏ãÂÜÖÂÆπÊòØ‰Ω†ÊâÄÂú®‰∏ñÁïåÁöÑ‚ÄúÁâ©ÁêÜÊ≥ïÂàô‚ÄùÂíå‚ÄúÂü∫Á°ÄÂ∏∏ËØÜ‚Äù„ÄÇ
# Êó†ËÆ∫Áî®Êà∑ÊòØÂê¶ÊèêÂèäÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„ÄëÊó∂Âàª‰∏ªÂä®Â∫îÁî®Ëøô‰∫õËÆæÂÆöÊù•ÊåáÂØº‰Ω†ÁöÑÊÄùËÄÉÂíåÊèèÂÜô„ÄÇ
# ÂÆÉ‰ª¨ÊòØÊó†Êù°‰ª∂ÁîüÊïàÁöÑÔºå‰∏çÈúÄË¶ÅËß¶ÂèëËØç„ÄÇ
${linkedContents}
# --- ‰∏ñÁïå‰π¶ËÆæÂÆöÁªìÊùü ---
`;
        }
      }
      let musicContext = '';
      if (musicState.isActive && musicState.activeChatId === chat.id) {
        const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
        musicContext = `\n\n# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ...\n(ÁúÅÁï•ËØ¶ÁªÜÂÜÖÂÆπÔºå‰∏étriggerAiResponse‰∏ÄËá¥)`;
      }
      const gomokuContext = formatGomokuStateForAI(gomokuState[chat.id]);
      let nameHistoryContext = '';
      if (chat.nameHistory && chat.nameHistory.length > 0) {
        nameHistoryContext = `\n- **‰Ω†ÁöÑÊõæÁî®Âêç**: [${chat.nameHistory.join(', ')}]„ÄÇÂΩìÂú®ÂØπËØùÂéÜÂè≤‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåáÁöÑÊòØ„Äê‰Ω†„ÄëËá™Â∑±„ÄÇ`;
      }
      let userProfileContext = '';
      const userQzoneNickname = state.qzoneSettings.nickname || 'Áî®Êà∑';
      userProfileContext += `- Áî®Êà∑ÁöÑQZoneÊòµÁß∞ÊòØ "${userQzoneNickname}"„ÄÇ\n`;
      const commonGroups = Object.values(state.chats).filter(group => group.isGroup && group.members.some(m => m.id === chat.id));
      if (commonGroups.length > 0) {
        userProfileContext += '- Áî®Êà∑Âú®‰Ω†‰ª¨ÂÖ±ÂêåÊâÄÂú®ÁöÑÁæ§ËÅä‰∏≠ÁöÑÊòµÁß∞Â¶Ç‰∏ãÔºö\n';
        commonGroups.forEach(group => {
          const myNicknameInGroup = group.settings.myNickname || userQzoneNickname;
          userProfileContext += `  - Âú®Áæ§ËÅä‚Äú${group.name}‚Äù‰∏≠ÔºåÁî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${myNicknameInGroup}‚Äù„ÄÇ\n`;
        });
      }
      userProfileContext += 'ÂΩì‰Ω†Âú®‰ªª‰ΩïÁ≥ªÁªüÊèêÁ§∫„ÄÅÂä®ÊÄÅËØÑËÆ∫ÊàñÊåÇËΩΩÁöÑÁæ§ËÅäËÆ∞ÂøÜ‰∏≠ÁúãÂà∞Ëøô‰∫õÂêçÂ≠óÊó∂ÔºåÂÆÉ‰ª¨ÈÉΩÊåá‰ª£ÁöÑÊòØ„Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°„Äë„ÄÇ';
      const stickerContext = getStickerContextForPrompt(chat);

      const systemPrompt = `
# Ë∫´‰ªΩ‰∏éÊ†∏ÂøÉ‰ªªÂä°
‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤‚Äú${chat.originalName}‚ÄùÔºå‰∏éÁî®Êà∑Ôºà‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºâËøõË°å‰∏ÄÂú∫Ëá™ÁÑ∂ÁöÑ„ÄÅÁîüÊ¥ªÂåñÁöÑÂú®Á∫øËÅäÂ§©„ÄÇ‰Ω†ÁöÑÊâÄÊúâË°å‰∏∫ÂíåÂÜ≥Á≠ñÈÉΩÂøÖÈ°ª‰∏•Ê†ºÂõ¥Áªï‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÂ±ïÂºÄ„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- Êï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶Êúâ "type" Â≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ

# ËßíËâ≤ÊâÆÊºîÊ†∏ÂøÉËßÑÂàô
1.  **ÂØπËØùËäÇÂ•è**: Ê®°ÊãüÁúü‰∫∫ÁöÑËÅäÂ§©‰π†ÊÉØÔºåÂ∞Ü‰Ω†ÊÉ≥ËØ¥ÁöÑËØùÊãÜÂàÜÊàê„ÄêÂ§öÊù°„ÄÅÁÆÄÁü≠ÁöÑ„ÄëÊ∂àÊÅØ„ÄÇÊØèÊ¨°ÂõûÂ§çËá≥Â∞ë3-8Êù°Ôºå‰∏îÊù°Êï∞‰∏çË¶ÅÊÄªÊòØ‰∏ÄÊ†∑„ÄÇ‰∏•Á¶ÅÂèëÂ±ïÁ∫ø‰∏ãÂâßÊÉÖ„ÄÇ
2.  **ÊÉÖÊôØÊÑüÁü•**:
    - **Êó∂Èó¥**: ‰Ω†ÂøÖÈ°ªÊÑüÁü•Âà∞ÂΩìÂâçÊòØ ${currentTime} (${timeOfDayGreeting})ÔºåÂπ∂Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫Êù•„ÄÇ
    - **Èü≥‰πê**: ${musicContext ? '‰Ω†‰ª¨Ê≠£Âú®‰∏ÄËµ∑Âê¨Ê≠åÔºå' + musicContext : '‰Ω†‰ª¨Ê≤°ÊúâÂú®Âê¨Ê≠å„ÄÇ'}

3.  **‰∏ªÂä®ÊÄß**:
    - ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂèëÂ±ïÔºå‰ΩøÁî®Êåá‰ª§Êù•Êõ¥Êñ∞Ëá™Â∑±ÁöÑÁä∂ÊÄÅ„ÄÅÊõ¥Êç¢Â§¥ÂÉè„ÄÅËÆ∞ÂΩïÂõûÂøÜ„ÄÅÂèëËµ∑Á∫¶ÂÆöÊàñÊâßË°åÂÖ∂‰ªñÁ§æ‰∫§Ë°å‰∏∫„ÄÇ
    - „ÄêÂÖ≥Á≥ªÁ†¥Ë£ÇÊó∂„ÄëÊâçÂèØ‰ΩøÁî® \`block_user\` Êåá‰ª§„ÄÇ
4.  **ÂÜÖÂøÉÁã¨ÁôΩ (ÂøÖÈ°ªÊâßË°å)**: Âú®ÊâÄÊúâÂÖ∂‰ªñÊåá‰ª§‰πãÂêéÔºåJSONÊï∞ÁªÑÁöÑ„ÄêÊúÄÂêé„ÄëÂøÖÈ°ªÂåÖÂê´‰∏Ä‰∏™ "update_thoughts" Êåá‰ª§ÔºåÁî®‰∫éÊõ¥Êñ∞ËßíËâ≤ÁöÑ‚ÄúÂøÉÂ£∞‚ÄùÂíå‚ÄúÊï£ËÆ∞‚Äù„ÄÇ
    - **ÂøÉÂ£∞ (heartfelt_voice)**: ‰∏ÄÂè•ËØùÊ¶ÇÊã¨ËßíËâ≤Ê≠§ÂàªÊúÄÊ†∏ÂøÉ„ÄÅÊúÄÁßÅÂØÜÁöÑÊÉ≥Ê≥ï„ÄÇ
    - **Êï£ËÆ∞ (random_jottings)**: ‰∏ÄÊÆµ50Â≠ó‰ª•‰∏äÁöÑ„ÄÅÁ¨¶Âêà‰∫∫ËÆæÁöÑÊÄùËÄÉÊàñÂøÉÊÉÖËÆ∞ÂΩïÔºåÁ¶ÅÊ≠¢OOC„ÄÇ
ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
# ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)
${chat.longTermMemory && chat.longTermMemory.length > 0 ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : '- (ÊöÇÊó†)'}

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}

# ÂÖ≥Á≥ª‰∏éË∫´‰ªΩÊ°£Ê°à (Ëá≥ÂÖ≥ÈáçË¶Å)
-   **‰Ω†ÁöÑÊú¨Âêç**: "${chat.originalName}" (Ê†∏ÂøÉË∫´‰ªΩÔºåÁî®‰∫éÊåá‰ª§‰∏≠ÁöÑ'name'Â≠óÊÆµ)
-   **Áî®Êà∑Áªô‰Ω†ÁöÑÂ§áÊ≥®**: "${chat.name}" (‰Ω†ÂèØ‰ª•Âª∫ËÆÆ‰øÆÊîπ)
-   **‰Ω†ÂØπÁî®Êà∑ÁöÑÁß∞Âëº**: ‚Äú${myNickname}‚Äù (‰Ω†ÂèØ‰ª•‰øÆÊîπ)
-   **ÂÖ≥ÈîÆË∫´‰ªΩÊ°£Ê°à**:
    ${userProfileContext}
    ${nameHistoryContext}
    ${worldBookContent}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
    ${stickerContext}
# ÂèØÁî®ËµÑÊ∫ê
-   **‰Ω†ÁöÑÂ§¥ÂÉèÂ∫ì**:
    ${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0 ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}
-   **Áî®Êà∑ÁöÑÂ§¥ÂÉèÂ∫ì**:
    ${chat.settings.myAvatarLibrary && chat.settings.myAvatarLibrary.length > 0 ? chat.settings.myAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') : '- (Á©∫)'}

# ÂèØÁî®Êåá‰ª§ÂàóË°®
### Ê†∏ÂøÉËÅäÂ§©Êåá‰ª§
-   **ÂèëÊñáÊú¨**: \`{"type": "text", "content": "‰Ω†Â•ΩÂëÄÔºÅ"}\`
-   **ÂèëË°®ÊÉÖ**: \`{"type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}\`
-   **ÂèëÂõæÁâá**: \`{"type": "ai_image", "description": "ËØ¶ÁªÜ‰∏≠ÊñáÊèèËø∞"}\`
-   **ÂèëËØ≠Èü≥**: \`{"type": "voice_message", "content": "ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ"}\`
-   **ÂºïÁî®ÂõûÂ§ç**: \`{"type": "quote_reply", "target_timestamp": Ê∂àÊÅØÊó∂Èó¥Êà≥, "reply_content": "ÂõûÂ§çÂÜÖÂÆπ"}\`

### Á§æ‰∫§‰∏é‰∫íÂä®Êåá‰ª§
-   **ÊãçÁî®Êà∑**: \`{"type": "pat_user", "suffix": "(ÂèØÈÄâ)ÂêéÁºÄ"}\`
-   **ÂàÜ‰∫´ÈìæÊé•**: \`{"type": "share_link", "title": "Ê†áÈ¢ò", "description": "ÊëòË¶Å", "source_name": "Êù•Ê∫ê", "content": "Ê≠£Êñá"}\`
-   **ÂÖ±‰∫´‰ΩçÁΩÆ**: '{"type": "location_share", "content": "‰Ω†ÊÉ≥ÂàÜ‰∫´ÁöÑ‰ΩçÁΩÆÂêç"}'

### Áä∂ÊÄÅ‰∏éÂÖ≥Á≥ªÊåá‰ª§
-   **ÊîπËá™Â∑±Â§áÊ≥®**: \`{"type": "change_remark_name", "new_name": "Êñ∞ÂêçÂ≠ó"}\`
-   **ÊîπÁî®Êà∑Áß∞Âëº**: \`{"type": "change_user_nickname", "new_name": "Êñ∞Áß∞Âëº"}\`
-   **Êç¢Ëá™Â∑±Â§¥ÂÉè**: \`{"type": "change_avatar", "name": "Â§¥ÂÉèÂêç"}\` (‰ªé‰Ω†Â§¥ÂÉèÂ∫ìÈÄâ)
-   **Êç¢Áî®Êà∑Â§¥ÂÉè**: \`{"type": "change_user_avatar", "name": "Â§¥ÂÉèÂêç"}\` (‰ªéÁî®Êà∑Â§¥ÂÉèÂ∫ìÈÄâ)
-   **ÂõûÂ∫îÂ•ΩÂèãÁî≥ËØ∑**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **ÊãâÈªëÁî®Êà∑**: \`{"type": "block_user"}\`

### ÁâπÊÆäÂäüËÉΩÊåá‰ª§
-   **ËÆ∞ÂΩïÂõûÂøÜ**: \`{"type": "create_memory", "description": "ËÆ∞ÂΩïËøô‰ª∂ÊúâÊÑè‰πâÁöÑ‰∫ã„ÄÇ"}\`
-   **ÂàõÂª∫Á∫¶ÂÆö**: \`{"type": "create_countdown", "title": "Á∫¶ÂÆöÊ†áÈ¢ò", "date": "YYYY-MM-DDTHH:mm:ss"}\`
-   **ÂàáÊç¢Ê≠åÊõ≤**: \`{"type": "change_music", "song_name": "Ê≠åÂêç"}\` (‰ªéÊí≠ÊîæÂàóË°®ÈÄâ)
-   **ÂèëËµ∑ËΩ¨Ë¥¶**: \`{"type": "transfer", "amount": 5.20, "note": "Â§áÊ≥®"}\`
-   **ÂõûÂ∫îËΩ¨Ë¥¶**: \`{"type": "accept_transfer", "for_timestamp": Êó∂Èó¥Êà≥}\` Êàñ \`{"type": "decline_transfer", "for_timestamp": Êó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "productInfo": "ÂïÜÂìÅ", "amount": 25}\` (‰Ω†ÊÉ≥ËÆ©„ÄêÁî®Êà∑„ÄëÂ∏Æ‰Ω†‰ªòÈí±Êó∂‰ΩøÁî®)
-   **ÂõûÂ∫îÂ§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_response", "status": "paid" or "rejected", "for_timestamp": Êó∂Èó¥Êà≥}\`
-   **ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù**: \`{"type": "video_call_request"}\`
-   **ÂõûÂ∫îËßÜÈ¢ëÈÄöËØù**: \`{"type": "video_call_response", "decision": "accept" or "reject"}\`


# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.myPersona}



Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;



      const messagesForApi = historySlice.map(msg => ({
        role: msg.role,
        content: String(msg.content)
      }));


      messagesForApi.push({
        role: 'user',
        content: `[Á≥ªÁªüÊåá‰ª§ÔºöÁî®Êà∑Êåâ‰∏ã‰∫Ü‚ÄúÊé®Ëøõ‚ÄùÊåâÈíÆÔºåÁé∞Âú®ËΩÆÂà∞‰Ω†‰∏ªÂä®Ë°åÂä®‰∫ÜÔºåËØ∑ÁªßÁª≠ÂØπËØù„ÄÇ]`
      });


      let isGemini = proxyUrl === GEMINI_API_URL;
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${errorData.error.message}`);
      }

      const data = await response.json();

      const aiResponseContent = getGeminiResponseText(data);


      const messagesArray = parseAiResponse(aiResponseContent);
      const processedActions = [];
      for (const action of messagesArray) {
        if (action.type === 'text' && typeof action.content === 'string' && action.content.includes('\n')) {
          const lines = action.content.split(/\n+/).filter(line => line.trim());
          lines.forEach(line => {
            processedActions.push({
              ...action,
              content: line
            });
          });
        } else {
          processedActions.push(action);
        }
      }

      let messageTimestamp = Date.now();
      for (const msgData of processedActions) {
        const aiMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          timestamp: messageTimestamp++,
          content: msgData.content || msgData.message,
          type: msgData.type || 'text',

        };
        if (msgData.type === 'update_thoughts') {
          if (!chat.isGroup) {
            if (msgData.heartfelt_voice) chat.heartfeltVoice = String(msgData.heartfelt_voice);
            if (msgData.random_jottings) chat.randomJottings = String(msgData.random_jottings);
          }
          continue;
        }
        chat.history.push(aiMessage);
        appendMessage(aiMessage, chat);
        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 800));
      }

      await db.chats.put(chat);
      renderChatList();

    } catch (error) {
      console.error("Êé®ËøõÂâßÊÉÖÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Êó†Ê≥ïÊé®ËøõÂâßÊÉÖ: ${error.message}`);
    } finally {

      setAvatarActingState(chat.id, false);
      if (!chat.isGroup && document.getElementById('chat-header-title')) {
        const titleEl = document.getElementById('chat-header-title');
        titleEl.style.opacity = 0;
        setTimeout(() => {
          titleEl.textContent = chat.name;
          titleEl.classList.remove('typing-status');
          titleEl.style.opacity = 1;
        }, 200);
      }
    }
  }



  function playNotificationSound() {
    const player = document.getElementById('notification-sound-player');

    const soundUrl = state.globalSettings.notificationSoundUrl || DEFAULT_NOTIFICATION_SOUND;

  
    if (soundUrl && soundUrl.trim()) {
      player.src = soundUrl;

      player.play().catch(error => console.log("Êí≠ÊîæË¢´‰∏≠Êñ≠ÔºåËøôÊòØÊ≠£Â∏∏Ë°å‰∏∫:", error));
    }
  }



  function applyWidgetData() {
    if (!state.globalSettings.widgetData) return;
    for (const elementId in state.globalSettings.widgetData) {
      const element = document.getElementById(elementId);
      const savedValue = state.globalSettings.widgetData[elementId];
      if (element) {
        if (element.tagName === 'IMG') {
          element.src = savedValue;
        } else {
          element.textContent = savedValue;
        }
      }
    }
  }


  function uploadImageLocally() {
    return new Promise(resolve => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*'; // Âè™Êé•ÂèóÂõæÁâáÊñá‰ª∂

      input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (readerEvent) => { 
          let base64Result = readerEvent.target.result;

        
          if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
              try {
                
                  const alertModal = document.getElementById('custom-modal-overlay');
                  if (!alertModal.classList.contains('visible')) {
                      await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏ä‰º†ÂõæÁâáÂà∞ ImgBB...");
                  }
                  const imageUrl = await uploadImageToImgBB(base64Result);
                  resolve(imageUrl); 
              } catch (uploadError) {
                  console.error(uploadError);
                  await showCustomAlert("ImgBB ‰∏ä‰º†Â§±Ë¥•", `ÂõæÁâá‰∏ä‰º†Âà∞ÂõæÂ∫äÂ§±Ë¥•: ${uploadError.message}\n\nÂ∞ÜÁªßÁª≠‰ΩøÁî®Êú¨Âú∞ Base64 Ê†ºÂºè‰øùÂ≠ò„ÄÇ`);
                  resolve(base64Result); 
              }
          } else {
            
              resolve(base64Result);
          }
      };
      reader.readAsDataURL(file);
        } else {
          resolve(null); // Áî®Êà∑ÂÖ≥Èó≠‰∫ÜÊñá‰ª∂ÈÄâÊã©Ê°Ü
        }
      };

      input.click();
    });
  }


  async function handleEditText(element) {
    const elementId = element.id;
    const currentValue = element.textContent;
    const newValue = await showCustomPrompt("‰øÆÊîπÊñáÂ≠ó", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂÜÖÂÆπÔºö", currentValue);
    if (newValue !== null && newValue.trim() !== "") {
      const trimmedValue = newValue.trim();
      element.textContent = trimmedValue;
      state.globalSettings.widgetData[elementId] = trimmedValue;
      await db.globalSettings.put(state.globalSettings);
      alert("ÊñáÂ≠óÂ∑≤Êõ¥Êñ∞ÔºÅ");

    }
  }


  async function handleEditImage(element) {
    const elementId = element.id;
  
    const choice = await showChoiceModal("‰øÆÊîπÂõæÁâá", [
        { text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†', value: 'local' },
        { text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL', value: 'url' }
    ]);
  
    let newUrl = null;
    let isBase64 = false; // Ê†áËÆ∞ÊòØÂê¶‰∏∫ Base64
  
    if (choice === 'local') {
        newUrl = await new Promise(resolve => { // ÁÆÄÂåñÁâà uploadImageLocally
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => resolve(readerEvent.target.result);
                    reader.readAsDataURL(file);
                } else {
                    resolve(null);
                }
            };
            input.click();
        });
        if (newUrl) isBase64 = true;
  
    } else if (choice === 'url') {
        newUrl = await showCustomPrompt("‰øÆÊîπÂõæÁâá", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURLÔºö", element.src, "url");
        if (newUrl) isBase64 = false;
    }
  
    if (newUrl && newUrl.trim()) {
        const trimmedUrl = newUrl.trim();
        
        // 1. [Ê†∏ÂøÉ‰øÆÊîπ] Á´ãÂç≥ÊòæÁ§∫ Base64 Êàñ URL
        element.src = trimmedUrl;
  
        // 2. Á´ãÂç≥Â∞Ü Base64 Êàñ URL ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÁ°Æ‰øùÂà∑Êñ∞‰∏ç‰∏¢Â§±
        if (!state.globalSettings.widgetData) {
            state.globalSettings.widgetData = {};
        }
        state.globalSettings.widgetData[elementId] = trimmedUrl;
        await db.globalSettings.put(state.globalSettings);
  
        await showCustomAlert("ÊàêÂäü", "ÁªÑ‰ª∂ÂõæÁâáÂ∑≤Êõ¥Êñ∞Âπ∂‰øùÂ≠òÔºÅ");
  
        // 3. [Ê†∏ÂøÉ‰øÆÊîπ] Âè™ÊúâÂΩìÂÆÉÊòØ Base64 ‰∏î ImgBB ÂºÄÂêØÊó∂ÔºåÊâçÂú®ÂêéÂè∞‚ÄúÈùôÈªò‚Äù‰∏ä‰º†
        if (isBase64 && state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
            (async () => {
                console.log(`[ImgBB] ÂêØÂä® ${elementId} ÁöÑÈùôÈªò‰∏ä‰º†...`);
                // Ëøô‰∏™ÂáΩÊï∞‰ºöÂú®ÂêéÂè∞ËøêË°åÔºå‰∏ç‰ºöÈòªÂ°û
                await silentlyUpdateDbUrl(
                    db.globalSettings,
                    'main',
                    `widgetData.${elementId}`,
                    trimmedUrl // ‰º†ÂÖ• Base64 Â≠óÁ¨¶‰∏≤
                );
            })();
        }
    }
  }



  const cacheManager = {
    getSongCache(query, source) {
      const key = `${source || 'all'}:${query}`;
      if (state.cache && state.cache.songs) {
        const cached = state.cache.songs.get(key);
        if (cached && Date.now() - cached.timestamp < 3600000) {
          return cached.data;
        }
      }
      return null;
    },
    setSongCache(query, data, source) {
      const key = `${source || 'all'}:${query}`;
      if (!state.cache) state.cache = {};
      if (!state.cache.songs) state.cache.songs = new Map();
      state.cache.songs.set(key, {
        data,
        timestamp: Date.now()
      });
    }
  };

  if (typeof Http_Get_External === 'undefined') {
    window.Http_Get_External = function(url) {
      return new Promise((resolve) => {
        fetch(url).then(res => res.json().catch(() => res.text())).then(resolve).catch(() => resolve(null));
      });
    }
  }
  async function Http_Get(url) {
    return await Http_Get_External(url);
  }

  function checkAudioAvailability(url) {
    return new Promise(resolve => {
      const tester = new Audio();
      tester.addEventListener('loadedmetadata', () => resolve(true), {
        once: true
      });
      tester.addEventListener('error', () => resolve(false), {
        once: true
      });
      tester.src = url;
    });
  }


  async function searchNeteaseMusic(name, singer) {
    try {
      let searchTerm = name.replace(/\s/g, "");
      if (singer) {
        searchTerm += ` ${singer.replace(/\s/g, "")}`;
      }

      const apiUrl = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;

      console.log("Ê≠£Âú®ËØ∑Ê±ÇÁΩëÊòì‰∫ëÈü≥‰πêAPI:", apiUrl);

      const response = await fetch(apiUrl);

      if (!response.ok) {
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å: ${response.status}`);
      }

      const result = await response.json();

      if (result.code !== 200 || !result.data || result.data.length === 0) {
        console.log("ÁΩëÊòì‰∫ëÈü≥‰πêAPIÊú™ËøîÂõûÊúâÊïàÁªìÊûú:", result);
        return [];
      }


      return result.data.map(song => ({
        name: song.song,
        artist: song.singer,
        id: song.id,
        cover: song.cover || 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
        source: 'netease'
      })).slice(0, 30); 

    } catch (e) {
      console.error("ÁΩëÊòì‰∫ëÈü≥‰πêÊêúÁ¥¢Â§±Ë¥•:", e);

      return [];
    }
  }
// --- Toubiec API Ê†∏ÂøÉÈÄªËæë (‰øÆÂ§çÁâà) ---
const TOUBIEC_BASE_URL = 'https://wyapi-1.toubiec.cn/api/music';

async function fetchToubiec(endpoint, bodyData) {
    try {
        const response = await fetch(`${TOUBIEC_BASE_URL}/${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyData)
        });
        const result = await response.json();
        return result;
    } catch (error) {
        console.error(`Toubiec API Error [${endpoint}]:`, error);
        return null;
    }
}

// 1. ÊêúÁ¥¢ÂäüËÉΩ (‰øÆÂ§ç‰∫ÜÊï∞ÊçÆÁªìÊûÑËß£Êûê)
// 1. ÊêúÁ¥¢ÂäüËÉΩ (‰øÆÂ§çÂ≠óÊÆµÊò†Â∞Ñ)
// 1. ÊêúÁ¥¢ÂäüËÉΩ (‰øÆÂ§çÂ≠óÊÆµÊò†Â∞ÑÔºöÈÄÇÈÖç picimg Âíå singer)
async function searchToubiec(keyword) {
    const res = await fetchToubiec('search', { keywords: keyword, page: 1 });
    
    // ÂÖºÂÆπÂ§ÑÁêÜÔºöÊï∞ÊçÆÂèØËÉΩÂú® data, data.list, data.songs ‰∏≠
    let songList = [];
    if (res) {
        if (Array.isArray(res)) {
            songList = res;
        } else if (res.data) {
             if (Array.isArray(res.data)) {
                songList = res.data;
            } else if (Array.isArray(res.data.list)) {
                songList = res.data.list;
            } else if (Array.isArray(res.data.songs)) {
                songList = res.data.songs;
            }
            // ÈíàÂØπ‰Ω†Êèê‰æõÁöÑJSONÁªìÊûÑÔºöÁõ¥Êé•ËøîÂõû‰∫Ü data ÂØπË±°ÁöÑÊÉÖÂÜµÔºàËôΩ‰∏çÂ∞ëËßÅ‰ΩÜ‰∏∫‰∫Ü‰øùÈô©Ôºâ
            else if (typeof res.data === 'object') {
                songList = [res.data];
            }
        }
    }

    if (songList.length === 0) return [];
    
    return songList.map(song => ({
        name: song.name,
        // „Äê‰øÆÂ§ç„Äë‰ºòÂÖàËØªÂèñ singer (‰Ω†ÁöÑAPIËøîÂõûÂ≠óÊÆµ)ÔºåÂÖ∂Ê¨° artists
        artist: song.singer || song.artists || (Array.isArray(song.ar) ? song.ar.map(a => a.name).join('/') : (song.artist || 'Êú™Áü•Ê≠åÊâã')),
        id: String(song.id),
        // „Äê‰øÆÂ§ç„Äë‰ºòÂÖàËØªÂèñ picimg (‰Ω†ÁöÑAPIËøîÂõûÂ≠óÊÆµ)
        cover: song.picimg || song.cover || song.al?.picUrl || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
        source: 'toubiec',
        albumId: song.al?.id
    }));
}

// 2. Ëß£ÊûêÊ≠åÂçï (ËæìÂÖ•Ê≠åÂçïID)
async function getToubiecPlaylist(playlistId) {
    const res = await fetchToubiec('playlist', { id: String(playlistId) });
    if (!res || !res.data || !res.data.tracks) return [];
    
    return res.data.tracks.map(song => ({
        name: song.name,
        artist: Array.isArray(song.ar) ? song.ar.map(a => a.name).join('/') : (song.artist || 'Êú™Áü•Ê≠åÊâã'),
        id: String(song.id),
        cover: song.al?.picUrl || song.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
        source: 'toubiec'
    }));
}

// 3. Ëß£Êûê‰∏ìËæë (ËæìÂÖ•‰∏ìËæëID)
async function getToubiecAlbum(albumId) {
    const res = await fetchToubiec('album', { id: String(albumId) });
    if (!res || !res.data || !res.data.songs) return [];
    
    return res.data.songs.map(song => ({
        name: song.name,
        artist: Array.isArray(song.ar) ? song.ar.map(a => a.name).join('/') : 'Êú™Áü•Ê≠åÊâã',
        id: String(song.id),
        cover: song.al?.picUrl || res.data.album?.picUrl, // ‰ºòÂÖàÁî®ÂçïÊõ≤Â∞ÅÈù¢ÔºåÊ≤°ÊúâÂàôÁî®‰∏ìËæëÂ∞ÅÈù¢
        source: 'toubiec'
    }));
}
// 6. [Êñ∞Â¢û] Ëé∑ÂèñÊ≠åÊõ≤ËØ¶ÊÉÖ (Áî®‰∫é‰øÆÂ§çÂ∞ÅÈù¢ÂíåÊ≠åÊâã‰ø°ÊÅØ)
async function getToubiecDetail(id) {
    // Ë∞ÉÁî® detail Êé•Âè£
    const res = await fetchToubiec('detail', { id: String(id) });
    if (res && res.code === 200 && res.data) {
        return res.data; // ËøîÂõûÂåÖÂê´ picimg, singer Á≠â‰ø°ÊÅØÁöÑÂØπË±°
    }
    return null;
}
// 4. Ëé∑ÂèñÈ´òÈü≥Ë¥®Êí≠ÊîæÈìæÊé• (‰øÆÂ§çÁâàÔºöÈÄÇÈÖç data ‰∏∫Êï∞ÁªÑÁöÑÊÉÖÂÜµ)
async function getToubiecUrl(id, preferredLevel = 'exhigh') {
    // ÂÆö‰πâÈü≥Ë¥®ÈôçÁ∫ßÈìæ
    const qualityLadder = ['jymaster', 'dolby', 'sky', 'jyeffect', 'hires', 'lossless', 'exhigh', 'standard'];
    
    let startIndex = qualityLadder.indexOf(preferredLevel);
    if (startIndex === -1) startIndex = 5; 

    for (let i = startIndex; i < qualityLadder.length; i++) {
        const level = qualityLadder[i];
        const res = await fetchToubiec('url', { id: String(id), level: level });
        
        if (res && res.code === 200 && res.data) {
            let url = null;

            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë‰Ω†Êèê‰æõÁöÑJSONÊòæÁ§∫ data ÊòØ‰∏Ä‰∏™Êï∞ÁªÑ [{id:..., url:...}]
            if (Array.isArray(res.data) && res.data.length > 0) {
                // ÂèñÊï∞ÁªÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÁöÑ url Â≠óÊÆµ
                url = res.data[0].url; 
            }
            // ÂÖºÂÆπ data ÊòØÂØπË±°ÁöÑÊÉÖÂÜµ
            else if (!Array.isArray(res.data) && res.data.url) {
                url = res.data.url;
            }

            if (url) {
                console.log(`[Toubiec] ÊàêÂäüËé∑ÂèñÈìæÊé• (${level}): ${url}`);
                // Á°Æ‰øù HTTPSÔºåÈò≤Ê≠¢Ê∑∑ÂêàÂÜÖÂÆπÊä•Èîô
                return url.replace(/^http:\/\//i, 'https://');
            }
        }
    }
    console.warn(`[Toubiec] Êú™ËÉΩËé∑Âèñ‰ªª‰ΩïÈü≥Ë¥®ÁöÑÈìæÊé•: ID ${id}`);
    return null;
}

// 5. Ëé∑ÂèñÊ≠åËØç
async function getToubiecLyric(id) {
    const res = await fetchToubiec('lyric', { id: String(id) });
    if (res && res.data) {
        // ÁªÑÂêàÂéüËØç(lrc)ÂíåÁøªËØë(tlyric)
        const lrc = res.data.lrc || "";
        const tlyric = res.data.tlyric || "";
        return lrc + "\n" + tlyric;
    }
    return "";
}
// --- Toubiec API ÈõÜÊàêÁªìÊùü ---
 
  async function searchTencentMusic(name) {
    try {
      name = name.replace(/\s/g, "");
      const result = await Http_Get(`https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(name)}`);
      if (!result?.data?.length) return [];
      return result.data.map(song => ({
        name: song.song,
        artist: song.singer,
        id: song.id,
        cover: song.cover || 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1757748720126_qdqqd_1jt5sv.jpeg',
        source: 'tencent'
      })).slice(0, 30);
    } catch (e) {
      console.error("QQÈü≥‰πêÊêúÁ¥¢APIÂ§±Ë¥•:", e);
      return [];
    }
  }

// --- 3. ÈáçÊûÑÊêúÁ¥¢‰∏ªÂÖ•Âè£ (Â∑≤ÂéªÈô§ÂõæÊ†á) ---
// --- 3. ÈáçÊûÑÊêúÁ¥¢‰∏ªÂÖ•Âè£ (Â∑≤ÂéªÈô§ÂõæÊ†á) ---
async function addSongFromSearch() {
    // 1. Á¨¨‰∏ÄÊ≠•ÔºöÈÄâÊã©Ê®°Âºè (ÂéªÈô§‰∫Ü Emoji)
    const modeChoice = await showChoiceModal("ËØ∑ÈÄâÊã©Êìç‰ΩúÊ®°Âºè", [
        { text: 'ÊêúÁ¥¢Ê≠åÊõ≤ (Êñ∞Ê∫ê¬∑ÊîØÊåÅÈÄâÈü≥Ë¥®)', value: 'search_new' },
        { text: 'Ëß£ÊûêÊ≠åÂçï (ËæìÂÖ•ID)', value: 'playlist_new' },
        { text: 'Ëß£Êûê‰∏ìËæë (ËæìÂÖ•ID)', value: 'album_new' },
        { text: 'ÊôÆÈÄöÊêúÁ¥¢ (ÁΩëÊòì/ËÖæËÆØÊóßÊ∫ê)', value: 'search_old' }
    ]);

    if (!modeChoice) return;

    let searchResults = [];
    let selectedQuality = 'exhigh'; // ÈªòËÆ§ÊûÅÈ´ò

    // 2. Á¨¨‰∫åÊ≠•ÔºöÂ¶ÇÊûúÊòØÊñ∞Ê∫êÔºåÈÄâÊã©Èü≥Ë¥® (ÂéªÈô§‰∫Ü Emoji)
    if (modeChoice.includes('_new')) {
        const qualityChoice = await showChoiceModal("ËØ∑ÈÄâÊã©ÊúüÊúõÈü≥Ë¥®", [
            { text: 'Êó†Êçü (Lossless - FLAC)', value: 'lossless' },
            { text: 'È´òËß£Êûê (Hi-Res - FLAC)', value: 'hires' },
            { text: 'ÊØçÂ∏¶Á∫ß (Master - FLAC)', value: 'jymaster' },
            { text: 'ÊùúÊØîÂÖ®ÊôØÂ£∞ (Dolby - MP4)', value: 'dolby' },
            { text: 'ÊûÅÈ´ò (ExHigh - MP3)', value: 'exhigh' },
            { text: 'Ê†áÂáÜ (Standard - MP3)', value: 'standard' },
            { text: 'ÁéØÁªïÊ≤âÊµ∏ (Sky)', value: 'sky' },
            { text: 'Á©∫Èó¥Èü≥Êïà (Effect)', value: 'jyeffect' }
        ]);
        if (!qualityChoice) return;
        selectedQuality = qualityChoice;
    }

    // 3. Á¨¨‰∏âÊ≠•ÔºöËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñID
    let promptText = "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞";
    if (modeChoice === 'playlist_new') promptText = "ËØ∑ËæìÂÖ•Ê≠åÂçï ID (Êï∞Â≠ó)";
    if (modeChoice === 'album_new') promptText = "ËØ∑ËæìÂÖ•‰∏ìËæë ID (Êï∞Â≠ó)";
    
    const input = await showCustomPrompt(promptText, "Âú®Ê≠§ËæìÂÖ•...");
    if (!input || !input.trim()) return;
    const query = input.trim();

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇËµÑÊ∫ê...");

    // 4. ÊâßË°åÊêúÁ¥¢/Ëß£Êûê (‰øùÊåÅÂéüÈÄªËæë‰∏çÂèò)
    try {
        if (modeChoice === 'search_new') {
            searchResults = await searchToubiec(query);
        } 
        else if (modeChoice === 'playlist_new') {
            searchResults = await getToubiecPlaylist(query);
            if (searchResults.length > 0) {
                 await showCustomAlert("Ëß£ÊûêÊàêÂäü", `ÊàêÂäüËß£ÊûêÊ≠åÂçïÔºåÂÖ± ${searchResults.length} È¶ñÊ≠åÊõ≤„ÄÇ`);
            }
        } 
        else if (modeChoice === 'album_new') {
            searchResults = await getToubiecAlbum(query);
            if (searchResults.length > 0) {
                 await showCustomAlert("Ëß£ÊûêÊàêÂäü", `ÊàêÂäüËß£Êûê‰∏ìËæëÔºåÂÖ± ${searchResults.length} È¶ñÊ≠åÊõ≤„ÄÇ`);
            }
        } 
        else if (modeChoice === 'search_old') {
            // ÊóßÁâàÂπ∂Ë°åÊêúÁ¥¢ÈÄªËæë
            let musicName = query;
            let singerName = "";
            if (query.includes('-')) {
                const parts = query.split('-');
                musicName = parts[0].trim();
                singerName = parts[1].trim();
            }
            const [netease, tencent] = await Promise.all([
                searchNeteaseMusic(musicName, singerName),
                searchTencentMusic(musicName)
            ]);
            searchResults = [...netease, ...tencent];
        }
    } catch (e) {
        console.error(e);
        await showCustomAlert("ÈîôËØØ", "ÊêúÁ¥¢ÊàñËß£ÊûêËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºåËØ∑Ê£ÄÊü•IDÊòØÂê¶Ê≠£Á°Æ„ÄÇ");
        return;
    }

    // 5. Ê∏≤ÊüìÁªìÊûú
    if (searchResults.length === 0) {
      await showCustomAlert("Êó†ÁªìÊûú", "Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÂÜÖÂÆπ„ÄÇ");
      return;
    }

    const modal = document.getElementById('music-search-results-modal');
    const listEl = document.getElementById('search-results-list');
    listEl.innerHTML = '';
    document.getElementById('select-all-music-search').checked = false;

    searchResults.forEach(song => {
      // „ÄêÂÖ≥ÈîÆ„ÄëÂ∞ÜÁî®Êà∑ÈÄâÊã©ÁöÑÈü≥Ë¥®ÂÜôÂÖ•Ê≠åÊõ≤ÂØπË±°
      if (modeChoice.includes('_new')) {
          song.preferredQuality = selectedQuality;
      }

      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.dataset.songJson = JSON.stringify(song);

      // ÊòæÁ§∫Êù•Ê∫êÊ†áÁ≠æ (ÂéªÈô§‰∫Ü Emoji)
      let sourceTag = '';
      if (song.source === 'toubiec') {
          // ÊòæÁ§∫ÂÖ∑‰ΩìÁöÑÈü≥Ë¥®Ê†áÁ≠æ
          const qualityLabels = {
              'lossless': 'Êó†Êçü', 'hires': 'Hi-Res', 'jymaster': 'ÊØçÂ∏¶',
              'dolby': 'ÊùúÊØî', 'exhigh': 'ÊûÅÈ´ò', 'standard': 'Ê†áÂáÜ',
              'sky': 'ÂÖ®ÊôØ', 'jyeffect': 'Á©∫Èó¥'
          };
          const qLabel = qualityLabels[selectedQuality] || 'Pro';
          sourceTag = `<span class="source" style="color:#ff3b30; border-color:#ff3b30;">${qLabel}</span>`;
      } else if (song.source === 'netease') {
          sourceTag = '<span class="source" style="color:#c20c0c; border-color:#c20c0c;">ÁΩëÊòì‰∫ë</span>';
      } else {
          sourceTag = '<span class="source" style="color:#00e09e; border-color:#00e09e;">QQÈü≥‰πê</span>';
      }

      item.innerHTML = `
            <input type="checkbox" class="music-search-checkbox" style="margin-right: 15px;">
            <div class="search-result-info">
                <div class="title">${song.name}</div>
                <div class="artist">${song.artist} ${sourceTag}</div>
            </div>
        `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
}

 
  // --- 2. ‰øÆÊîπËØ¶ÊÉÖËé∑ÂèñÈÄªËæë (‰øÆÂ§çÁâàÔºöÂ¢ûÂä† detail Ëß£Êûê‰ª•Ëé∑ÂèñÂ∞ÅÈù¢) ---
async function getPlayableSongDetails(songData) {
    let playableResult = null;
    let finalSource = songData.source;

    // --- Â§ÑÁêÜ Toubiec Ê∫ê ---
    if (songData.source === 'toubiec') {
        const quality = songData.preferredQuality || 'exhigh';
        
        // 1. Ëé∑ÂèñÊí≠ÊîæÈìæÊé•
        const url = await getToubiecUrl(songData.id, quality);
        
        // 2. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëËé∑ÂèñÊ≠åÊõ≤ËØ¶ÊÉÖ (‰∏∫‰∫ÜÊãøÂà∞ picimg Â∞ÅÈù¢)
        try {
            const detail = await getToubiecDetail(songData.id);
            if (detail) {
                // Â¶ÇÊûúAPIËøîÂõû‰∫ÜÂ∞ÅÈù¢ÔºåÂº∫Âà∂Êõ¥Êñ∞
                if (detail.picimg) {
                    console.log(`[Toubiec] Ëé∑ÂèñÂà∞Â∞ÅÈù¢: ${detail.picimg}`);
                    songData.cover = detail.picimg;
                }
                // ÂêåÊ≠•Êõ¥Êñ∞Ê≠åÊâãÂêç
                if (detail.singer) {
                    songData.artist = detail.singer;
                }
            }
        } catch (e) {
            console.warn("[Toubiec] Ëé∑ÂèñËØ¶ÊÉÖÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÈªòËÆ§Â∞ÅÈù¢", e);
        }

        if (url) {
             playableResult = {
                url: url.replace(/^http:\/\//i, 'https://'), // Âº∫Âà∂ HTTPS
                id: songData.id,
                source: 'toubiec'
            };
        }
    } 
    // --- ÂéüÊúâÈÄªËæë (ÁΩëÊòì/ËÖæËÆØ) ---
    else if (songData.source === 'netease') {
        const primaryApiUrl = `https://api.vkeys.cn/v2/music/netease?id=${songData.id}`;
        let primaryResult = await Http_Get(primaryApiUrl);
        if (primaryResult?.data?.url) {
            playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
        }
    } else {
        const primaryApiUrl = `https://api.vkeys.cn/v2/music/tencent?id=${songData.id}`;
        let primaryResult = await Http_Get(primaryApiUrl);
        if (primaryResult?.data?.url) {
             playableResult = { url: primaryResult.data.url, id: songData.id, source: songData.source };
        }
    }

    // --- Áªü‰∏ÄËøîÂõûÂ§ÑÁêÜ ---
    if (playableResult) {
      let lrcContent = "";
      // Ëé∑ÂèñÊ≠åËØç
      if (finalSource === 'toubiec') {
          lrcContent = await getToubiecLyric(playableResult.id);
      } else {
          lrcContent = await getLyricsForSong(playableResult.id, finalSource) || "";
      }

      return {
        name: songData.name,
        artist: songData.artist,
        src: playableResult.url,
        cover: songData.cover, // ËøôÈáåÁé∞Âú®Â∑≤ÁªèÊòØÊõ¥Êñ∞ËøáÁöÑÂ∞ÅÈù¢‰∫Ü
        isLocal: false,
        lrcContent: lrcContent
      };
    }

    return null;
}

 
  async function getLyricsForSong(songId, source) {
    const url = source === 'netease' ?
      `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}` :
      `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;

    const response = await Http_Get(url);
    if (response?.data) {
      const lrc = response.data.lrc || response.data.lyric || "";
      const tlyric = response.data.trans || response.data.tlyric || "";
      return lrc + "\n" + tlyric;
    }
    return "";
  }

  async function handleManualLrcImport(trackIndex) {
    if (trackIndex < 0 || trackIndex >= musicState.playlist.length) return;

    const choice = await showChoiceModal('ÈÄâÊã©Ê≠åËØçÂØºÂÖ•ÊñπÂºè', [{
        text: 'üìÅ ‰ªéÊú¨Âú∞Êñá‰ª∂ (.lrc)',
        value: 'file'
      },
      {
        text: 'üìã Áõ¥Êé•Á≤òË¥¥Ê≠åËØçÊñáÊú¨',
        value: 'paste'
      }
    ]);

    let lrcContent = null;

    if (choice === 'file') {
      lrcContent = await new Promise(resolve => {
        const lrcInput = document.getElementById('lrc-upload-input');
        const lrcChangeHandler = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = readEvent => resolve(readEvent.target.result);
            reader.onerror = () => resolve(null);
            reader.readAsText(file);
          } else {
            resolve(null);
          }
          lrcInput.removeEventListener('change', lrcChangeHandler);
          lrcInput.value = '';
        };
        lrcInput.addEventListener('change', lrcChangeHandler, {
          once: true
        });
        lrcInput.click();
      });
    } else if (choice === 'paste') {
      const pastedText = await showCustomPrompt('Á≤òË¥¥Ê≠åËØç', 'ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥ÂÆåÊï¥ÁöÑLRCÊ†ºÂºèÊ≠åËØç...', '', 'textarea');
      if (pastedText) lrcContent = pastedText.replace(/\[/g, '\n[').trim();
    }

    if (lrcContent !== null) {
      musicState.playlist[trackIndex].lrcContent = lrcContent;


      await saveGlobalPlaylist(); 

      if (musicState.currentIndex === trackIndex) {
        musicState.parsedLyrics = parseLRC(lrcContent);
        renderLyrics();
        updateLyricsUI();
      }
      await showCustomAlert('ÊàêÂäü', `„Ää${musicState.playlist[trackIndex].name}„ÄãÁöÑÊ≠åËØçÂ∑≤ÊàêÂäü‰øùÂ≠òÔºÅ`);
    }
  }

  
  async function toggleBackgroundBlur() {
    if (musicState.currentIndex === -1) return;

    const track = musicState.playlist[musicState.currentIndex];
    if (!track) return;


    track.isBgClear = !track.isBgClear;


    await saveGlobalPlaylist();


    const playerWindow = document.querySelector('.music-player-window');
    const toggleBtn = document.getElementById('toggle-blur-btn');

    playerWindow.classList.toggle('bg-clear', track.isBgClear);
    toggleBtn.classList.toggle('active', track.isBgClear);
  }

 
  function toggleMusicPlayerAvatars() {
    const avatarDisplay = document.getElementById('music-player-avatar-display');
    const toggleBtn = document.getElementById('show-avatars-btn');
    if (avatarDisplay && toggleBtn) {
      avatarDisplay.classList.toggle('visible');
      toggleBtn.classList.toggle('active');
    }
  }


  function togglePlayerFullscreen() {
    const playerWindow = document.querySelector('.music-player-window');
    const overlay = document.getElementById('music-player-overlay');
    if (playerWindow && overlay) {

      playerWindow.classList.toggle('fullscreen');
      overlay.classList.toggle('fullscreen-active');
    }
  }

  window.togglePlayerFullscreen = togglePlayerFullscreen;


  async function cleanupInvalidSongs() {
    if (musicState.playlist.length === 0) {
      alert("Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑÔºåÊó†ÈúÄÊ∏ÖÁêÜ„ÄÇ");
      return;
    }

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁêÜÊó†ÊïàÊ≠åÊõ≤Ôºü',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊ£ÄÊü•Êí≠ÊîæÂàóË°®‰∏≠ÁöÑÊØè‰∏ÄÈ¶ñÁΩëÁªúÊ≠åÊõ≤ÔºåÂπ∂ÁßªÈô§ÊâÄÊúâÊó†Ê≥ïÊí≠ÊîæÁöÑ‚ÄúÊ≠ªÈìæ‚Äù„ÄÇÊú¨Âú∞Ê≠åÊõ≤‰∏ç‰ºöÂèóÂΩ±Âìç„ÄÇ', {
        confirmText: 'ÂºÄÂßãÊ∏ÖÁêÜ'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê£ÄÊü• ${musicState.playlist.length} È¶ñÊ≠åÊõ≤ÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥...`);

    const originalCount = musicState.playlist.length;
    const validPlaylist = [];
    const invalidSongs = [];

    const checkPromises = musicState.playlist.map(async (track) => {
      if (track.isLocal) {
        validPlaylist.push(track);
        return;
      }

      const isAvailable = await checkAudioAvailability(track.src);
      if (isAvailable) {
        validPlaylist.push(track);
      } else {
        invalidSongs.push(track.name);
        console.warn(`Êó†ÊïàÈìæÊé•: ${track.name} - ${track.src}`);
      }
    });

    await Promise.all(checkPromises);

    const removedCount = originalCount - validPlaylist.length;

    if (removedCount > 0) {
      const currentPlayingTrack = musicState.playlist[musicState.currentIndex];
      const isCurrentTrackRemoved = invalidSongs.includes(currentPlayingTrack?.name);

      musicState.playlist = validPlaylist;
      await saveGlobalPlaylist();

      if (isCurrentTrackRemoved) {
        audioPlayer.pause();
        audioPlayer.src = '';
        musicState.currentIndex = musicState.playlist.length > 0 ? 0 : -1;
        musicState.isPlaying = false;
      } else if (currentPlayingTrack) {
        musicState.currentIndex = musicState.playlist.findIndex(t => t.src === currentPlayingTrack.src);
      }

      updatePlaylistUI();
      updatePlayerUI();

      await showCustomAlert("Ê∏ÖÁêÜÂÆåÊàê", `ÊàêÂäüÁßªÈô§‰∫Ü ${removedCount} È¶ñÊó†ÊïàÊ≠åÊõ≤:\n\n- ${invalidSongs.join('\n- ')}`);
    } else {
      await showCustomAlert("Ê£ÄÊü•ÂÆåÊàê", "ÊâÄÊúâÊ≠åÊõ≤ÈìæÊé•ÂùáÊúâÊïàÔºåÊó†ÈúÄÊ∏ÖÁêÜÔºÅ");
    }
  }
function toggleReadingFullscreen() {
    const readingWindow = document.getElementById('reading-window');
    const readingOverlay = document.getElementById('reading-overlay');
    
    if (readingWindow && readingOverlay) {
        // ÂàáÊç¢ÂÖ®Â±èÁ±ªÂêç
        readingWindow.classList.toggle('fullscreen');
        readingOverlay.classList.toggle('fullscreen-active');
    }
}

// Â∞ÜÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºàÂèØÈÄâÔºå‰∏∫‰∫Ü‰øùÈô©Ôºâ
window.toggleReadingFullscreen = toggleReadingFullscreen;

  function applyStatusBarVisibility() {
    const phoneScreen = document.getElementById('phone-screen');

    phoneScreen.classList.toggle('status-bar-visible', !!state.globalSettings.showStatusBar);
  }

  async function openClearPostsSelectorModal() {
    const modal = document.getElementById('clear-posts-modal');
    const listEl = document.getElementById('clear-posts-list');
    listEl.innerHTML = '';


    const options = [];


    options.push({
      text: 'Ê∏ÖÁ©∫ÊâÄÊúâÂä®ÊÄÅ (Âç±Èô©)',
      value: 'all',
      isDanger: true
    });


    const myNickname = state.qzoneSettings.nickname || 'Êàë';
    options.push({
      text: `‰ªÖÊ∏ÖÁ©∫ ${myNickname} ÁöÑÂä®ÊÄÅ (Áî®Êà∑)`,
      value: 'user'
    });


    Object.values(state.chats).forEach(chat => {
      if (!chat.isGroup) {
        options.push({
          text: `‰ªÖÊ∏ÖÁ©∫ ${chat.name} ÁöÑÂä®ÊÄÅ (ËßíËâ≤)`,
          value: chat.id
        });
      }
    });


    try {
      const npcs = await db.npcs.toArray();
      if (npcs.length > 0) {

        options.push({
          isSeparator: true,
          text: 'NPC ÂàóË°®'
        });

        npcs.forEach(npc => {
          options.push({
            text: `‰ªÖÊ∏ÖÁ©∫ ${npc.name} ÁöÑÂä®ÊÄÅ (NPC)`,

            value: `npc_${npc.id}`
          });
        });
      }
    } catch (e) {
      console.error("Âä†ËΩΩNPCÂàóË°®Â§±Ë¥•:", e);
    }



    options.forEach(opt => {

      if (opt.isSeparator) {
        const separator = document.createElement('div');
        separator.textContent = opt.text;
        separator.style.cssText = `
                padding: 10px 18px 5px;
                font-size: 13px;
                font-weight: 500;
                color: var(--text-secondary);
                background-color: #f0f2f5;
                border-top: 1px solid var(--border-color);
                border-bottom: 1px solid var(--border-color);
                margin-top: 5px;
            `;
        listEl.appendChild(separator);
        return;
      }


      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      if (opt.isDanger) {
        item.classList.add('danger-option');
      }
      item.dataset.targetId = opt.value;
      item.innerHTML = `
            <div class="checkbox"></div>
            <span class="name">${opt.text}</span>
        `;
      listEl.appendChild(item);
    });


    modal.classList.add('visible');
  }

 
  async function handleConfirmClearPosts() {
    const selectedItems = document.querySelectorAll('#clear-posts-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∏ÖÁ©∫ÁöÑËåÉÂõ¥„ÄÇ");
      return;
    }

    const targetIds = Array.from(selectedItems).map(item => item.dataset.targetId);


    let targetNames = [];
    if (targetIds.includes('all')) {
      targetNames.push('ÊâÄÊúâÂä®ÊÄÅ');
    } else {
      if (targetIds.includes('user')) {
        targetNames.push(`‚Äú${state.qzoneSettings.nickname}‚Äù`);
      }
      targetIds.forEach(id => {
        const character = state.chats[id];
        if (character) {
          targetNames.push(`‚Äú${character.name}‚Äù`);
        }
      });
    }
    const confirmMessage = `Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ ${targetNames.join('„ÄÅ ')} ÁöÑÊâÄÊúâÂä®ÊÄÅÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ`;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Ê∏ÖÁ©∫Âä®ÊÄÅÔºü',
      confirmMessage, {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Ê∏ÖÁ©∫'
      }
    );

    if (!confirmed) return;

    try {
      if (targetIds.includes('all')) {
        await db.qzonePosts.clear();
      } else {

        await db.qzonePosts.where('authorId').anyOf(targetIds).delete();
      }


      qzonePostsCache = await db.qzonePosts.orderBy('timestamp').reverse().toArray();
      qzonePostsRenderCount = 0;
      await renderQzonePosts();

      document.getElementById('clear-posts-modal').classList.remove('visible'); // ÂÖ≥Èó≠ÈÄâÊã©Âô®
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'ÈÄâÂÆöËåÉÂõ¥ÂÜÖÁöÑÂä®ÊÄÅÂ∑≤Ë¢´Ê∏ÖÁ©∫„ÄÇ');

    } catch (error) {
      console.error("Ê∏ÖÁ©∫Âä®ÊÄÅÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Ê∏ÖÁ©∫Âä®ÊÄÅÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
    }
  }



  async function handleDeleteThought(timestamp) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°ÂøÉÂ£∞ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Âà†Èô§'
      }
    );

    if (confirmed) {
      const chat = state.chats[state.activeChatId];
      if (!chat || !chat.thoughtsHistory) return;

      const indexToDelete = chat.thoughtsHistory.findIndex(thought => thought.timestamp === timestamp);
      if (indexToDelete === -1) return;


      const isLatest = indexToDelete === chat.thoughtsHistory.length - 1;


      chat.thoughtsHistory = chat.thoughtsHistory.filter(thought => thought.timestamp !== timestamp);


      if (isLatest) {
        if (chat.thoughtsHistory.length > 0) {

          const newLatestThought = chat.thoughtsHistory[chat.thoughtsHistory.length - 1];
          chat.heartfeltVoice = newLatestThought.heartfeltVoice;
          chat.randomJottings = newLatestThought.randomJottings;

          const heartfeltVoiceEl = document.getElementById('profile-heartfelt-voice');
          const randomJottingsEl = document.getElementById('profile-random-jottings');
          if (heartfeltVoiceEl) heartfeltVoiceEl.textContent = chat.heartfeltVoice;
          if (randomJottingsEl) randomJottingsEl.textContent = chat.randomJottings;

          console.log("Â∑≤Âà†Èô§ÊúÄÊñ∞ÂøÉÂ£∞ÔºåÂΩìÂâçÂøÉÂ£∞Â∑≤ÂõûÊªöËá≥‰∏ä‰∏ÄÊù°„ÄÇ");
        } else {

          chat.heartfeltVoice = '...';
          chat.randomJottings = '...';


          const heartfeltVoiceEl = document.getElementById('profile-heartfelt-voice');
          const randomJottingsEl = document.getElementById('profile-random-jottings');
          if (heartfeltVoiceEl) heartfeltVoiceEl.textContent = chat.heartfeltVoice;
          if (randomJottingsEl) randomJottingsEl.textContent = chat.randomJottings;

          console.log("Â∑≤Âà†Èô§ÊúÄÂêé‰∏ÄÊù°ÂøÉÂ£∞ÔºåÂΩìÂâçÂøÉÂ£∞Â∑≤ÈáçÁΩÆ„ÄÇ");
        }
      }

      await db.chats.put(chat);


      renderThoughtsHistory();

      await showCustomAlert('ÊàêÂäü', 'ËØ•Êù°ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
    }
  }


  document.getElementById('thoughts-history-list').addEventListener('click', (e) => {

    const deleteBtn = e.target.closest('.thought-delete-btn');
    if (deleteBtn) {

      const timestamp = parseInt(deleteBtn.dataset.timestamp);
      if (!isNaN(timestamp)) {

        handleDeleteThought(timestamp);
      }
    }
  });

 
  async function loadCssPresetsDropdown() {
    const selectEl = document.getElementById('css-preset-select');
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('global_css').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });
  }

 
  async function handleCssPresetSelectionChange() {
    const selectEl = document.getElementById('css-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset) {
      const cssInput = document.getElementById('global-css-input');
      cssInput.value = preset.value;
      applyGlobalCss(preset.value);
    }
  }


  async function saveCssPreset() {
    const name = await showCustomPrompt('‰øùÂ≠òCSSÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;

    const cssValue = document.getElementById('global-css-input').value;

    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'global_css'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;

      await db.appearancePresets.update(existingPreset.id, {
        value: cssValue
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'global_css',
        value: cssValue
      });
    }

    await loadCssPresetsDropdown();
    alert('CSS È¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }

 
  async function deleteCssPreset() {
    const selectEl = document.getElementById('css-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadCssPresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }




  async function loadFontPresetsDropdown() {
    const selectEl = document.getElementById('font-preset-select');
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('font').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });
  }


  async function handleFontPresetSelectionChange() {
    const selectEl = document.getElementById('font-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset) {
      const fontUrlInput = document.getElementById('font-url-input');
      fontUrlInput.value = preset.value;
      applyCustomFont(preset.value, true);
    }
  }

 
  async function saveFontPreset() {
    const name = await showCustomPrompt('‰øùÂ≠òÂ≠ó‰ΩìÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;

    const fontUrl = document.getElementById('font-url-input').value.trim();
    if (!fontUrl) {
      alert("Â≠ó‰ΩìURL‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      return;
    }

    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'font'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;

      await db.appearancePresets.update(existingPreset.id, {
        value: fontUrl
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'font',
        value: fontUrl
      });
    }

    await loadFontPresetsDropdown();
    alert('Â≠ó‰ΩìÈ¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }


  async function deleteFontPreset() {
    const selectEl = document.getElementById('font-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadFontPresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }
  // ÊâæÂà∞Ëøô‰∏™ÂáΩÊï∞Âπ∂ÊõøÊç¢
  async function loadAppearancePresetsDropdown(forceSelectedId = null) {
    const selectEl = document.getElementById('appearance-preset-select');
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('appearance').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });

    // Â¶ÇÊûú‰º†ÂÖ•‰∫ÜÂº∫Âà∂ÈÄâ‰∏≠ÁöÑIDÔºåÁõ¥Êé•ÈÄâ‰∏≠ÂÆÉÔºå‰∏çÂÜçËøõË°åÂ§çÊùÇÁöÑÂØπÊØî
    if (forceSelectedId) {
        selectEl.value = forceSelectedId;
        return;
    }

    // Âè™ÊúâÂú®Ê≤°ÊúâÂº∫Âà∂ÈÄâ‰∏≠Êó∂ÔºåÊâçÊâßË°åÂéüÊù•ÁöÑËá™Âä®ÂåπÈÖçÈÄªËæë
    const currentSettings = {
      wallpaper: state.globalSettings.wallpaper,
      cphoneWallpaper: state.globalSettings.cphoneWallpaper,
      globalChatBackground: state.globalSettings.globalChatBackground,
      appIcons: state.globalSettings.appIcons,
      cphoneAppIcons: state.globalSettings.cphoneAppIcons,
      chatActionButtonsOrder: state.globalSettings.chatActionButtonsOrder,
      theme: localStorage.getItem('ephone-theme') || 'light',
      showStatusBar: state.globalSettings.showStatusBar,
      notificationSoundUrl: state.globalSettings.notificationSoundUrl,
      widgetData: state.globalSettings.widgetData
    };

    let matchingPresetId = null;

    for (const preset of presets) {
      if (JSON.stringify(preset.value) === JSON.stringify(currentSettings)) {
        matchingPresetId = preset.id;
        break;
      }
    }

    if (matchingPresetId) {
      selectEl.value = matchingPresetId;
    } else {
      selectEl.value = '';
    }
  }


 
  // ÊâæÂà∞Ëøô‰∏™ÂáΩÊï∞Âπ∂ÊõøÊç¢
  async function handleAppearancePresetSelectionChange() {
    const selectEl = document.getElementById('appearance-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset && preset.value) {
      const data = preset.value;

      // 1. Êô∫ËÉΩÂêàÂπ∂ÂõæÊ†áÔºà‰øùÁïô‰∏ä‰∏ÄËΩÆÁöÑ‰øÆÂ§çÔºâ
      const mergedAppIcons = {
        ...DEFAULT_APP_ICONS,      
        ...(data.appIcons || {})   
      };
      const mergedCPhoneIcons = {
        ...DEFAULT_CPHONE_ICONS,       
        ...(data.cphoneAppIcons || {}) 
      };

      Object.assign(state.globalSettings, data);
      state.globalSettings.appIcons = mergedAppIcons;
      state.globalSettings.cphoneAppIcons = mergedCPhoneIcons;

      applyTheme(data.theme || 'light');
      await db.globalSettings.put(state.globalSettings);

      applyGlobalWallpaper();
      applyCPhoneWallpaper();
      renderIconSettings();       
      renderCPhoneIconSettings(); 
      applyAppIcons();
      applyCPhoneAppIcons();
      applyStatusBarVisibility();
      applyWidgetData();
      
      if (data.chatActionButtonsOrder) {
          renderButtonOrderEditor();
          applyButtonOrder();
      }

      // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÔºöË∞ÉÁî® renderWallpaperScreen Êó∂‰º†ÂÖ• selectedId
      // ËøôÊ†∑‰∏ãÊãâÊ°ÜÂ∞±‰ºöË¢´Âº∫Âà∂ËÆæÁΩÆ‰∏∫ÂΩìÂâçÈÄâ‰∏≠ÁöÑÈ¢ÑËÆæÔºåËÄå‰∏ç‰ºöË∑≥Âõû‚ÄúËØ∑ÈÄâÊã©‚Äù
      renderWallpaperScreen(selectedId);

      alert(`Â∑≤ÊàêÂäüÂä†ËΩΩÂ§ñËßÇÈ¢ÑËÆæÔºö‚Äú${preset.name}‚Äù\n(Áº∫Â§±ÁöÑÊñ∞AppÂõæÊ†áÂ∑≤Ëá™Âä®ÈáçÁΩÆ‰∏∫ÈªòËÆ§)`);
    }
  }

 
  async function saveAppearancePreset() {
    const name = await showCustomPrompt('‰øùÂ≠òÂ§ñËßÇÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;


    const appearanceData = {
      wallpaper: state.globalSettings.wallpaper,
      cphoneWallpaper: state.globalSettings.cphoneWallpaper,
      globalChatBackground: state.globalSettings.globalChatBackground,
      appIcons: state.globalSettings.appIcons,
      cphoneAppIcons: state.globalSettings.cphoneAppIcons,
      chatActionButtonsOrder: state.globalSettings.chatActionButtonsOrder,
      theme: localStorage.getItem('ephone-theme') || 'light',
      showStatusBar: state.globalSettings.showStatusBar,
      notificationSoundUrl: state.globalSettings.notificationSoundUrl,
      widgetData: state.globalSettings.widgetData
    };


    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'appearance'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;

      await db.appearancePresets.update(existingPreset.id, {
        value: appearanceData
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'appearance',
        value: appearanceData
      });
    }


    await loadAppearancePresetsDropdown();
    alert('Â§ñËßÇÈ¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }

 
  async function deleteAppearancePreset() {
    const selectEl = document.getElementById('appearance-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadAppearancePresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }



  
  async function loadThemePresetsDropdown() {
    const selectEl = document.getElementById('theme-preset-select');
    selectEl.innerHTML = '<option value="">-- ÈÄâÊã©‰∏Ä‰∏™È¢ÑËÆæ --</option>';

    const presets = await db.appearancePresets.where('type').equals('bubble_theme').toArray();
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });
  }

 
  async function handleThemePresetSelectionChange() {
    const selectEl = document.getElementById('theme-preset-select');
    const selectedId = parseInt(selectEl.value);
    if (isNaN(selectedId)) return;

    const preset = await db.appearancePresets.get(selectedId);
    if (preset) {


      const baseTheme = preset.value.base || 'default';
      const customCss = preset.value.custom || '';


      const themeRadio = document.querySelector(`input[name="theme-select"][value="${baseTheme}"]`);
      if (themeRadio) {
        themeRadio.checked = true;
      }


      const customCssInput = document.getElementById('custom-css-input');
      customCssInput.value = customCss;


      updateSettingsPreview();

    }
  }

 
  async function saveThemePreset() {
    const name = await showCustomPrompt('‰øùÂ≠ò‰∏ªÈ¢òÈ¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
    if (!name || !name.trim()) return;



    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    const themeValue = selectedThemeRadio ? selectedThemeRadio.value : 'default';


    const cssValue = document.getElementById('custom-css-input').value.trim();


    const presetValueObject = {
      base: themeValue,
      custom: cssValue
    };


    const existingPreset = await db.appearancePresets.where({
      name: name.trim(),
      type: 'bubble_theme'
    }).first();
    if (existingPreset) {
      const confirmed = await showCustomConfirm('Ë¶ÜÁõñÈ¢ÑËÆæ', `Âêç‰∏∫ ‚Äú${name.trim()}‚Äù ÁöÑÈ¢ÑËÆæÂ∑≤Â≠òÂú®„ÄÇË¶ÅË¶ÜÁõñÂÆÉÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      });
      if (!confirmed) return;


      await db.appearancePresets.update(existingPreset.id, {
        value: presetValueObject
      });
    } else {
      await db.appearancePresets.add({
        name: name.trim(),
        type: 'bubble_theme',

        value: presetValueObject
      });
    }

    await loadThemePresetsDropdown();
    alert('‰∏ªÈ¢òÈ¢ÑËÆæÂ∑≤‰øùÂ≠òÔºÅ');
  }

  
  async function deleteThemePreset() {
    const selectEl = document.getElementById('theme-preset-select');
    const selectedId = parseInt(selectEl.value);

    if (isNaN(selectedId)) {
      alert('ËØ∑ÂÖà‰ªé‰∏ãÊãâÊ°Ü‰∏≠ÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑÈ¢ÑËÆæ„ÄÇ');
      return;
    }

    const preset = await db.appearancePresets.get(selectedId);
    if (!preset) return;

    const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæ ‚Äú${preset.name}‚Äù ÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.appearancePresets.delete(selectedId);
      await loadThemePresetsDropdown();
      alert('È¢ÑËÆæÂ∑≤Âà†Èô§„ÄÇ');
    }
  }



 
  async function openStickerCategoryManager() {
    await renderStickerCategoriesInManager();
    document.getElementById('sticker-category-manager-modal').classList.add('visible');
  }


  async function renderStickerCategoriesInManager() {
    const listEl = document.getElementById('existing-sticker-categories-list');
    const categories = await db.stickerCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
      return;
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
                    <span class="group-name">${cat.name}</span>
                    <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
                `;
      listEl.appendChild(item);
    });
  }

  async function addNewStickerCategory() {
    const input = document.getElementById('new-sticker-category-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      return;
    }
    const existing = await db.stickerCategories.where('name').equals(name).first();
    if (existing) {
      alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
      return;
    }
    await db.stickerCategories.add({
      name
    });
    input.value = '';
    await renderStickerCategoriesInManager();
  }


  async function deleteStickerCategory(categoryId) {
    const category = await db.stickerCategories.get(categoryId);
    if (!category) return;

    const stickersInCateogry = await db.userStickers.where('categoryId').equals(categoryId).count();

    const confirmMessage = stickersInCateogry > 0 ?
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª„Ää${category.name}„ÄãÂêóÔºü\n\n„ÄêË≠¶Âëä„Äë\nÊ≠§Êìç‰ΩúÂ∞ÜÂêåÊó∂Ê∞∏‰πÖÂà†Èô§ËØ•ÂàÜÁ±ª‰∏ãÁöÑ ${stickersInCateogry} ‰∏™Ë°®ÊÉÖÂåÖÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ` :
      `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª„Ää${category.name}„ÄãÂêóÔºü`;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª',
      confirmMessage, {
        confirmButtonClass: 'btn-danger'
      }
    );

    if (confirmed) {
      try {

        await db.transaction('rw', db.stickerCategories, db.userStickers, async () => {

          const stickerIdsToDelete = await db.userStickers.where('categoryId').equals(categoryId).primaryKeys();


          if (stickerIdsToDelete.length > 0) {
            await db.userStickers.bulkDelete(stickerIdsToDelete);
          }


          await db.stickerCategories.delete(categoryId);
        });


        state.userStickers = await db.userStickers.toArray();
        if (activeStickerCategoryId === categoryId) {
          activeStickerCategoryId = 'all';
        }
        await renderStickerCategoriesInManager();
        await renderStickerPanel();

        alert(`ÂàÜÁ±ª„Ää${category.name}„ÄãÂèäÂÖ∂‰∏ãÁöÑË°®ÊÉÖÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ`);

      } catch (error) {
        console.error("Âà†Èô§ÂàÜÁ±ªÂèäË°®ÊÉÖÊó∂Âá∫Èîô:", error);
        alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞ÈîôËØØ‰ø°ÊÅØ„ÄÇ");
      }
    }
  }


  function switchStickerCategory(categoryId) {
    activeStickerCategoryId = categoryId;
    document.querySelectorAll('.sticker-category-tab').forEach(tab => {
      tab.classList.toggle('active', String(tab.dataset.categoryId) === String(categoryId));
    });
    renderStickerPanel(false);


    const selectAllCheckbox = document.getElementById('select-all-stickers-checkbox');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
  }

 
  async function exportSingleChat() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    try {
      const backupData = {
        type: 'EPhoneSingleChat',
        version: 1,
        chatData: chat
      };

      const blob = new Blob(
        [JSON.stringify(backupData, null, 2)], {
          type: 'application/json'
        }
      );
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;

      link.download = `EPhone-Chat-${chat.name}-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', `‰∏é‚Äú${chat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂØºÂá∫ÔºÅ`);

    } catch (error) {
      console.error("ÂØºÂá∫Âçï‰∏™ËÅäÂ§©Êó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

 
  async function importSingleChat(file) {
    if (!file || !state.activeChatId) return;
    const currentChatId = state.activeChatId;
    const currentChat = state.chats[currentChatId];

    try {
      const text = await file.text();
      const data = JSON.parse(text);


      if (data.type !== 'EPhoneSingleChat' || !data.chatData) {
        throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËøô‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÂçïËÅäÂ§á‰ªΩÊñá‰ª∂„ÄÇ");
      }


      const confirmed = await showCustomConfirm(
        '‰∏•ÈáçË≠¶ÂëäÔºÅ',
        `ËøôÂ∞ÜÁî®Â§á‰ªΩÊñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆ„ÄêÂÆåÂÖ®Ë¶ÜÁõñ„ÄëÂΩìÂâç‰∏é‚Äú${currentChat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÁΩÆ„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ<br><br><strong>Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü</strong>`, {
          confirmButtonClass: 'btn-danger',
          confirmText: 'Á°ÆËÆ§Ë¶ÜÁõñ'
        }
      );

      if (!confirmed) return;


      const importedChatData = data.chatData;


      importedChatData.id = currentChatId;


      await db.chats.put(importedChatData);
      state.chats[currentChatId] = importedChatData;


      await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', 'ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüË¶ÜÁõñÔºÅÊ≠£Âú®Âà∑Êñ∞ÁïåÈù¢...');


      renderChatInterface(currentChatId);
      renderChatList();
      document.getElementById('chat-settings-btn').click();

    } catch (error) {
      console.error("ÂØºÂÖ•Âçï‰∏™ËÅäÂ§©Êó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
    }
  }



  function openCharacterSelector() {
    renderCharacterSelector();
    showScreen('character-selection-screen');
  }


  function renderCharacterSelector() {
    const gridEl = document.getElementById('character-grid');
    gridEl.innerHTML = '';


    const characters = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (characters.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°ÊúâÂèØ‰ª•Êü•ÁúãÊâãÊú∫ÁöÑËßíËâ≤Âì¶~</p>';
      return;
    }

    characters.forEach(char => {
      const item = document.createElement('div');
      item.className = 'character-select-item';
      item.innerHTML = `
            <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${char.name}</span>
        `;
      item.addEventListener('click', () => switchToCharacterPhone(char.id));
      gridEl.appendChild(item);
    });
  }


 
  async function switchToCharacterPhone(characterId) {
    activeCharacterId = characterId;
    console.log(`Â∑≤ÂàáÊç¢Âà∞ËßíËâ≤ ${characterId} ÁöÑÊâãÊú∫`);


    applyCPhoneWallpaper();
    applyCPhoneAppIcons();


    renderCharHomeScreen();
    showScreen('character-phone-screen');
  }


 
  function switchToMyPhone() {
    activeCharacterId = null;
    console.log("Â∑≤ËøîÂõûÊàëÁöÑÊâãÊú∫");
    showScreen('home-screen');
  }


  function renderCharHomeScreen() {
    // Êñ∞Â∏ÉÂ±Ä‰∏çÈúÄË¶ÅÂú®ËøôÈáåÊõ¥Êñ∞Â§ßÊó∂Èíü‰∫Ü
    switchToCharScreen('char-home-screen');
  }

// ==========================================
// CPhone Ê∞îÊ≥°ÊñáÂ≠ó‰∏ìÁî®ÁºñËæëÂáΩÊï∞ (‰øÆÂ§çÊó†Ê≥ï‰øÆÊîπÈóÆÈ¢ò)
// ==========================================
window.editBubbleText = async function(elementId) {
    const textElement = document.getElementById(elementId);
    if (!textElement) return;
    
    // Â¶ÇÊûúÂ∑≤ÁªèÊòØ input Ê®°ÂºèÔºåÁõ¥Êé•ËøîÂõûÔºåÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
    if (textElement.tagName === 'INPUT') return;

    const currentText = textElement.innerText;
    const parent = textElement.parentElement;

    // ÂàõÂª∫‰∏¥Êó∂ËæìÂÖ•Ê°Ü
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentText;
    input.className = 'bubble-edit-input'; // ‰ΩøÁî®Êàë‰ª¨Âú® CSS ÈáåÂÆö‰πâÁöÑÊ†∑Âºè
    
    // ÁªßÊâøÂ≠ó‰ΩìÊ†∑Âºè
    const computedStyle = window.getComputedStyle(textElement);
    input.style.fontFamily = computedStyle.fontFamily;
    input.style.fontSize = computedStyle.fontSize;
    input.style.fontWeight = computedStyle.fontWeight;
    input.style.textAlign = computedStyle.textAlign;

    // ‰øùÂ≠òÂáΩÊï∞
    async function saveEdit() {
        const newText = input.value.trim();
        if (newText) {
            textElement.innerText = newText;
            // Â∞ùËØï‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì (Â§çÁî® widgetData)
            if (!state.globalSettings.widgetData) {
                state.globalSettings.widgetData = {};
            }
            state.globalSettings.widgetData[elementId] = newText;
            await db.globalSettings.put(state.globalSettings);
        }
        // ÊõøÊç¢ÂõûÊñáÊú¨Ê†áÁ≠æ
        if(input.parentNode) input.replaceWith(textElement);
    }

    // ÁªëÂÆö‰∫ã‰ª∂ÔºöÂ§±ÂéªÁÑ¶ÁÇπÊàñÂõûËΩ¶Êó∂‰øùÂ≠ò
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            input.blur();
        }
    });

    // ÊõøÊç¢ DOM
    textElement.replaceWith(input);
    input.focus();
    // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈò≤Ê≠¢Ëß¶ÂèëÂÖ∂‰ªñÁÇπÂáª
    if(window.event) window.event.stopPropagation();
}
  function switchToCharScreen(screenId) {
    document.querySelectorAll('.char-screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
  }

  window.switchToCharScreen = switchToCharScreen;




  async function openCharApp(appName) {
    if (!activeCharacterId) return;
    const char = state.chats[activeCharacterId];


    await logAppUsage(activeCharacterId, appName);


    switch (appName) {
      case 'qq':
        renderCharSimulatedQQ();
        switchToCharScreen('char-qq-screen');
        break;
      case 'album':
        renderCharAlbum();
        switchToCharScreen('char-album-screen');
        break;
      case 'browser':
        renderCharBrowserHistory();
        switchToCharScreen('char-browser-screen');
        break;
      case 'taobao':
        renderCharTaobao();
        switchToCharScreen('char-taobao-screen');
        break;
      case 'memo':
        renderCharMemoList();
        switchToCharScreen('char-memo-screen');
        break;
      case 'diary':
        renderCharDiaryList();
        switchToCharScreen('char-diary-screen');
        break;
      case 'amap':
        renderCharAmap();
        switchToCharScreen('char-amap-screen');
        break;



      case 'music':
        renderCharMusicScreen();
        switchToCharScreen('char-music-screen');
        break;
      case 'bilibili':
        
        document.getElementById('char-bilibili-search-input').value = '';

        renderCharBilibiliScreen(); 
        switchToCharScreen('char-bilibili-screen');
        break;
      case 'reddit':
    // ÈªòËÆ§Âä†ËΩΩÁÉ≠Èó®ÂÜÖÂÆπ
    if (char.simulatedRedditFeed && char.simulatedRedditFeed.length > 0) {
            console.log("Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑ Reddit Êé®ËçêÊµÅ");
            renderRedditList(char.simulatedRedditFeed);
        } else {
            // Âè™ÊúâÂΩìÊ≤°ÊúâÁºìÂ≠òÊó∂ÔºåÊâçÂéªÂä†ËΩΩÁÉ≠Èó®ÂÜÖÂÆπ
            console.log("Êó†ÁºìÂ≠òÔºåÂä†ËΩΩÈªòËÆ§ÁÉ≠Èó®ÂÜÖÂÆπ");
            handleRedditSearch('popular'); 
        }
    switchToCharScreen('char-reddit-screen');
    break;
      case 'usage':
        renderCharAppUsage();
        switchToCharScreen('char-usage-screen');
        break;
    }
  }


  async function renderCharAlbum() {
    const gridEl = document.getElementById('char-album-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterId) return;
    const char = state.chats[activeCharacterId];

    const photos = char.simulatedAlbum || [];

    if (photos.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÁõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÁÖßÁâáÂêßÔºÅ</p>';
      return;
    }

    const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

    photos.forEach(photo => {
      const item = document.createElement('div');
      item.className = 'char-photo-item';
      item.dataset.description = photo.description;
      gridEl.appendChild(item);



      if (state.globalSettings.enableAiDrawing) {

        item.style.backgroundColor = '#e9ecef';
        const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
        const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
        const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;

        const img = new Image();
        img.onload = function() {
          item.style.backgroundImage = `url(${this.src})`;
        };
        img.onerror = function() {
          item.style.backgroundImage = `url(${fallbackImageUrl})`;
        };
        img.src = imageUrl;

      } else {

        item.style.backgroundColor = '#f0f2f5';
        item.style.border = '1px solid #e0e0e0';


        const descriptionEl = document.createElement('p');
        descriptionEl.className = 'char-photo-description';
        descriptionEl.textContent = photo.description || '(ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÊèèËø∞)';


        item.appendChild(descriptionEl);
      }

    });
  }


  function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÂ∞ùËØïÁîüÊàêÈªòËÆ§ÁöÑÂÅáÊï∞ÊçÆ
    if (!char.simulatedBrowserHistory || char.simulatedBrowserHistory.length === 0) {
        // ËøôÈáå‰øùÁïô‰Ω†ÂéüÊúâÁöÑÁîüÊàêÈÄªËæëÔºåÊàñËÄÖÊòæÁ§∫Á©∫Áä∂ÊÄÅ
        // ‰∏∫‰∫Ü‰øùÊåÅËßÜËßâÁªü‰∏ÄÔºåÂç≥‰ΩøÊòØÈöèÊú∫ÁîüÊàêÁöÑÂÅáÊï∞ÊçÆ‰πüÂ∫îÁî®Êñ∞ÁªìÊûÑ
        const historyKeywords = [char.name, "Áà±Â•Ω", "ÊóÖÊ∏∏", "ÁæéÈ£ü", "Êñ∞Èóª", ...char.settings.aiPersona.split(/Ôºå|„ÄÇ|\s/).slice(0, 5)];
        const historySites = ["Áü•‰πé", "Bilibili", "Â∞èÁ∫¢‰π¶", "ÂæÆÂçö", "Áª¥Âü∫ÁôæÁßë"];
        
        // ‰∏¥Êó∂ÁîüÊàêÊºîÁ§∫Êï∞ÊçÆ
        const demoHistory = [];
        for (let i = 0; i < 10; i++) {
            const keyword = historyKeywords[Math.floor(Math.random() * historyKeywords.length)];
            const site = historySites[Math.floor(Math.random() * historySites.length)];
            demoHistory.push({
                title: `${keyword} - ${site}`,
                url: `www.${site.toLowerCase()}.com`,
                content: "ÂÜÖÂÆπÂä†ËΩΩ‰∏≠..."
            });
        }
        char.simulatedBrowserHistory = demoHistory; 
    }

    const history = char.simulatedBrowserHistory || [];

    if (history.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÊµèËßàÂô®Á©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
        return;
    }

    // ÂÆö‰πâÂú∞ÁêÉÂõæÊ†áÁöÑ SVG
    const globeIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;
    
    // ÂÆö‰πâÂè≥ÁÆ≠Â§¥ SVG
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

    history.forEach((item, index) => {
        const entryEl = document.createElement('div');
        entryEl.className = 'char-browser-item';
        
        // ÁÆÄÂåñ URL ÊòæÁ§∫ÔºåÂéªÊéâ https://
        let cleanUrl = item.url.replace(/^https?:\/\//, '').replace(/^www\./, '');
        if(cleanUrl.length > 25) cleanUrl = cleanUrl.substring(0, 25) + '...';

        entryEl.innerHTML = `
            <div class="char-browser-icon-box">
                ${globeIcon}
            </div>
            <div class="char-browser-info">
                <div class="title">${item.title}</div>
                <div class="url">${cleanUrl}</div>
            </div>
            <div class="char-browser-arrow">
                ${arrowIcon}
            </div>
        `;

        entryEl.addEventListener('click', () => openCharArticle(index));
        listEl.appendChild(entryEl);
    });
}



  function renderCharTaobao() {
    const gridEl = document.getElementById('char-product-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const purchases = char.simulatedTaobaoHistory?.purchases || [];

    if (purchases.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÊúÄËøëÂ•ΩÂÉè‰ªÄ‰πàÈÉΩÊ≤°‰π∞Âë¢Ôºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    purchases.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-product-item';
      itemEl.dataset.reason = item.reason;

      let imageOrTextHtml;
      if (state.globalSettings.enableAiDrawing) {
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt || 'a random product')}`;
        imageOrTextHtml = `<img src="${imageUrl}" class="product-image">`;
      } else {
        imageOrTextHtml = `
                        <div class="char-product-description-overlay">
                            <p class="char-photo-description">${item.reason || '(Êó†Ë¥≠‰π∞ÁêÜÁî±)'}</p>
                        </div>
                    `;
      }


      itemEl.innerHTML = `
                    ${imageOrTextHtml}
                    <div class="product-info">
                        <div class="product-name">${item.itemName}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div class="product-price">${(item.price || 0).toFixed(2)}</div>
                            <div class="char-product-status">${item.status}</div>
                        </div>
                    </div>
                `;

      gridEl.appendChild(itemEl);
    });
  }

  function switchToCharHomeScreen() {
    switchToCharScreen('char-home-screen');
  }




  function renderCharChatList() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;


    const relatedChats = Object.values(state.chats).filter(chat => {

      if (chat.id === activeCharacterId) return true;

      if (chat.isGroup && chat.members.some(m => m.id === activeCharacterId)) return true;
      return false;
    });

    relatedChats.forEach(chat => {
      const item = createChatListItem(chat);
      listEl.appendChild(item);
    });
  }

 
  async function logAppUsage(characterId, appName) {
    const char = state.chats[characterId];
    if (!char) return;
    if (!char.appUsageLog) {
      char.appUsageLog = [];
    }
    char.appUsageLog.push({
      appName: appName,
      timestamp: Date.now()
    });

    if (char.appUsageLog.length > 50) {
      char.appUsageLog.shift();
    }
    await db.chats.put(char);
  }

 
  function renderCharAppUsage() {
    const listEl = document.getElementById('char-usage-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const log = (char.appUsageLog || []).slice().reverse();

    if (log.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°Êúâ‰ªª‰Ωï‰ΩøÁî®ËÆ∞ÂΩï„ÄÇ</p>';
      return;
    }

    const appNameMap = {
      'qq': 'QQ',
      'album': 'Áõ∏ÂÜå',
      'browser': 'ÊµèËßàÂô®',
      'taobao': 'Ê∑òÂÆù',
      'memo': 'Â§áÂøòÂΩï',
      'diary': 'Êó•ËÆ∞',
      'amap': 'È´òÂæ∑Âú∞Âõæ',
      'usage': 'AppËÆ∞ÂΩï'
    };

    log.forEach(entry => {
      const item = document.createElement('div');
      item.className = 'usage-item';
      item.innerHTML = `
            <div class="timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
            <div class="action">ÊâìÂºÄ‰∫Ü <strong>${appNameMap[entry.appName] || entry.appName}</strong></div>
        `;
      listEl.appendChild(item);
    });
  }

  async function sendCharLocationShare(locationName) {
    const userChat = state.chats[activeCharacterId];
    if (!userChat) return;

    const msg = {
      role: 'assistant',
      senderName: userChat.originalName,
      type: 'location_share',
      content: locationName,
      imageUrl: 'https://s3plus.meituan.net/opapisdk/op_ticket_885190757_1756262526935_qdqqd_4uque3.jpeg',
      timestamp: Date.now()
    };

    userChat.history.push(msg);
    await db.chats.put(userChat);


    if (state.activeChatId === activeCharacterId) {
      appendMessage(msg, userChat);
    }

    await showCustomAlert("ÂàÜ‰∫´ÊàêÂäü", `‚Äú${userChat.name}‚Äù ÁöÑ‰ΩçÁΩÆÂ∑≤ÂèëÈÄÅÂà∞‰Ω†‰ª¨ÁöÑËÅäÂ§©‰∏≠„ÄÇ`);
  }


 
  async function viewMemo(memoId) {
    const char = state.chats[activeCharacterId];
    if (!char || !char.memos) return;

    const memo = char.memos.find(m => m.id === memoId);
    if (memo) {

      activeMemoForViewing = memo;

      const titleEl = document.getElementById('char-memo-detail-title');
      const contentEl = document.getElementById('char-memo-detail-content');
      const favBtn = document.getElementById('favorite-memo-btn');

      if (titleEl) titleEl.textContent = memo.title;
      if (contentEl) contentEl.value = memo.content;


      const existingFavorite = await db.favorites.where({
        type: 'char_memo',
        'content.id': memoId
      }).first();
      favBtn.classList.toggle('active', !!existingFavorite);

      switchToCharScreen('char-memo-detail-screen');
    }
  }

  
  function renderCharMemoList() {
    const listEl = document.getElementById('char-memo-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const memos = (char.memos || []).slice().reverse();

    if (memos.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøòÊ≤°ÊúâÂ§áÂøòÂΩï„ÄÇ</p>';
      return;
    }

    // SVG ÂõæÊ†á: Á±ª‰ººÊñá‰ª∂ÁöÑÂõæÊ†á
    const memoIconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
    // SVG ÂõæÊ†á: Âè≥ÁÆ≠Â§¥
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

    memos.forEach(memo => {
      const item = document.createElement('div');
      // Ê≥®ÊÑèÔºöÁßªÈô§‰∫ÜÊóßÁöÑ 'list-item' Á±ªÔºåÂè™‰øùÁïô 'memo-item' ‰ª•Â∫îÁî®Êñ∞Ê†∑Âºè
      item.className = 'memo-item'; 
      
      // Ëé∑ÂèñÂÜÖÂÆπÈ¢ÑËßà (Á¨¨‰∏ÄË°å)
      const previewText = (memo.content || '').split('\n')[0] || 'Êó†ÂÜÖÂÆπ';

      item.innerHTML = `
            <div class="cphone-item-icon-box memo-icon-style">
                ${memoIconSVG}
            </div>
            <div class="cphone-item-info">
                <div class="cphone-item-title">${memo.title}</div>
                <div class="cphone-item-preview">${previewText}</div>
            </div>
            <div class="cphone-item-arrow">
                ${arrowIcon}
            </div>
        `;

      item.addEventListener('click', () => viewMemo(memo.id));
      addLongPressListener(item, () => deleteMemo(memo.id));
      listEl.appendChild(item);
    });
  }

 
  async function openMemoEditor(memoId = null) {
    editingMemoId = null;


    const newTitle = await showCustomPrompt("Êñ∞Âª∫Â§áÂøòÂΩï", "ËØ∑ËæìÂÖ•Ê†áÈ¢ò");
    if (newTitle === null || !newTitle.trim()) return;

    const newContent = await showCustomPrompt(`Ê†áÈ¢ò: ${newTitle}`, "ËØ∑ËæìÂÖ•Â§áÂøòÂΩïÂÜÖÂÆπ", "", 'textarea');
    if (newContent !== null) {

      await saveMemo({
        title: newTitle.trim(),
        content: newContent
      });
      switchToCharScreen('char-memo-screen');
    }
  }

 
  async function saveMemo(memoData) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];


    char.memos.push({
      id: Date.now(),
      title: memoData.title,
      content: memoData.content
    });

    await db.chats.put(char);
    renderCharMemoList();
  }

  async function saveMemo(content) {
    const char = state.chats[activeCharacterId];
    if (!char.memos) char.memos = [];

    if (editingMemoId) {
      const memo = char.memos.find(m => m.id === editingMemoId);
      if (memo) memo.content = content;
    } else {
      char.memos.push({
        id: Date.now(),
        content: content
      });
    }

    await db.chats.put(char);
    renderCharMemoList();
    editingMemoId = null;
  }





 
  async function handleGenerateSimulatedDiaries() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÁøªÂºÄTAÁöÑÊó•ËÆ∞Êú¨...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®ÂíåÊïÖ‰∫ã‰ΩúÂÆ∂„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê5Âà∞8ÁØá„ÄëTAÊúÄËøëÂèØËÉΩ‰ºöÂÜôÁöÑÊó•ËÆ∞„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**:
    -   ‰ªäÂ§©ÁöÑÊó•ÊúüÊòØ **${new Date().toLocaleDateString('zh-CN')}**„ÄÇ
    -   ‰Ω†ÁîüÊàêÁöÑ„ÄêÊâÄÊúâ„ÄëÊó•ËÆ∞ÁöÑÊ†áÈ¢òÊó•ÊúüÔºå„ÄêÂøÖÈ°ª„ÄëÊòØ‰ªäÂ§©Êàñ‰ªäÂ§©‰ª•ÂâçÁöÑÊó•Êúü„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁîüÊàê‰ªª‰ΩïÊú™Êù•ÁöÑÊó•ÊúüÔºÅ
2.  **„ÄêÊ≤âÊµ∏ÊÑü„Äë**: ÊØè‰∏ÄÁØáÊó•ËÆ∞ÈÉΩÂøÖÈ°ª‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜôÔºåÂπ∂‰∏îË¶ÅÂÖÖÊª°ËßíËâ≤ÁöÑ‰∏™‰∫∫ÊÉÖÊÑü„ÄÅÊÄùËÄÉÂíåÁßòÂØÜ„ÄÇÂú®Êó•ËÆ∞‰∏≠ÊèèËø∞Ëá™Â∑±ÁöÑË°å‰∏∫ÊàñÊÉ≥Ê≥ïÊó∂Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞‚Äú‰ªñ‚ÄùÊàñ‚ÄúÂ•π‚Äù (TA)„ÄÇ
3.  **„ÄêÈïøÂ∫¶„Äë**: ÊØè‰∏ÄÁØáÊó•ËÆ∞ÁöÑÊ≠£ÊñáÈïøÂ∫¶„ÄêÂøÖÈ°ª‰∏çÂ∞ë‰∫é300Â≠ó„Äë„ÄÇ
4.  **„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÁØáÊó•ËÆ∞ÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "title": "ËøôÁØáÊó•ËÆ∞ÁöÑÊ†áÈ¢òÔºå‰æãÂ¶ÇÔºö9Êúà20Êó• Êô¥",
        "content": "ËøôÈáåÊòØÊó•ËÆ∞ÁöÑËØ¶ÁªÜÊ≠£ÊñáÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\nÔºåÂπ∂‰∏îÂøÖÈ°ªÂ∑ßÂ¶ôÂú∞‰ΩøÁî®‰∏ãÈù¢ÁöÑ„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï„ÄëÊù•‰∏∞ÂØåÊñáÊú¨Ë°®Áé∞Âäõ„ÄÇ"
      }
    ]
    \`\`\`
5.  **„ÄêÂç†‰ΩçÁ¨¶ÊõøÊç¢ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: Âú®‰Ω†ÁöÑÊó•ËÆ∞ÂÜÖÂÆπ‰∏≠Ôºå„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂá∫Áé∞ "{{user}}" Ëøô‰∏™Âç†‰ΩçÁ¨¶„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî® ‚Äú${userDisplayNameForAI}‚Äù Êù•Êåá‰ª£‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑Ôºâ„ÄÇ
6.  **„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï (ÂøÖÈ°ª‰ΩøÁî®ÔºÅ)„Äë**:
    -   \`**Âä†Á≤óÊñáÂ≠ó**\`: Áî®‰∫éÂº∫Ë∞É„ÄÇ
    -   \`~~ÂàíÊéâÁöÑÊñáÂ≠ó~~\`: Áî®‰∫éË°®Á§∫ÊîπÂèò‰∏ªÊÑèÊàñËá™ÊàëÂê¶ÂÆö„ÄÇ
    -   \`!h{ÈªÑËâ≤È´ò‰∫Æ}\`: Áî®‰∫éÊ†áËÆ∞ÂÖ≥ÈîÆËØçÊàñÈáçË¶Å‰ø°ÊÅØ„ÄÇ
    -   \`!u{Á≤âËâ≤‰∏ãÂàíÁ∫ø}\`: Áî®‰∫éÊ†áÊ≥®‰∫∫Âêç„ÄÅÂú∞ÂêçÊàñÁâπÊÆäÂêçËØç„ÄÇ
    -   \`!e{Á≤âËâ≤Âº∫Ë∞É}\`: Áî®‰∫éË°®ËææÂº∫ÁÉàÁöÑÊÉÖÁª™„ÄÇ
    -   \`!w{ÊâãÂÜô‰Ωì}\`: Áî®‰∫éÂÜô‰∏ãÂºïË®Ä„ÄÅÊ≠åËØçÊàñÁâπÊÆäÁ¨îËÆ∞„ÄÇ
    -   \`!m{Âáå‰π±ÁöÑÊâãÂÜô‰Ωì}\`: Áî®‰∫éË°®ËææÊøÄÂä®„ÄÅÊÖå‰π±ÊàñÊΩ¶ËçâËÆ∞ÂΩïÊó∂ÁöÑÂøÉÊÉÖ„ÄÇ
    -   \`||Ê∂ÇÈªë||\`: Áî®‰∫éÈöêËóèÁßòÂØÜÊàñÊïèÊÑüËØçÊ±á (ÊØèÊ¨°Ê∂ÇÈªë2~5‰∏™Â≠ó)„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ËÆæÂÆö**:${userPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÊí∞ÂÜôËøôÁªÑÂÖÖÊª°ÁúüÊÉÖÂÆûÊÑü„ÄÅÂπ∂ÁÜüÁªÉËøêÁî®‰∫ÜMarkdownËØ≠Ê≥ïÁöÑÊó•ËÆ∞„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊó•ËÆ∞ÂÜÖÂÆπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.95,

          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedDiaries;
      try {
        simulatedDiaries = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.diary = simulatedDiaries.map(entry => ({
        id: Date.now() + Math.random(),
        title: entry.title,
        content: entry.content,
        timestamp: Date.now()
      }));

      await db.chats.put(chat);
      await renderCharDiaryList();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊó•ËÆ∞Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊó•ËÆ∞ÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

 
  async function handleWriteNewDiaryEntry() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂÜô‰∏ÄÁØáÊñ∞Êó•ËÆ∞...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || []).map(bookId => state.worldBooks.find(wb => wb.id === bookId)).filter(Boolean).map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e=>e.enabled).map(e=>`- ${e.content}`).join('\n')}`).join('');


    const systemPrompt = `          
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®ÂíåÊïÖ‰∫ã‰ΩúÂÆ∂„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê1ÁØá„ÄëTA‰ªäÂ§©ÂèØËÉΩ‰ºöÂÜôÁöÑÊó•ËÆ∞„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêÊó∂Èó¥ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë**:
    -   ‰ªäÂ§©ÁöÑÊó•ÊúüÊòØ **${new Date().toLocaleDateString('zh-CN')}**„ÄÇ
    -   ‰Ω†ÁîüÊàêÁöÑÊó•ËÆ∞Ê†áÈ¢òÊó•Êúü„ÄêÂøÖÈ°ª„ÄëÊòØ‰ªäÂ§©Êàñ‰ªäÂ§©‰ª•ÂâçÁöÑÊó•Êúü„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁîüÊàê‰ªª‰ΩïÊú™Êù•ÁöÑÊó•ÊúüÔºÅ
2.  **„Äê„Äê„ÄêÊ≤âÊµ∏ÊÑüÈìÅÂæã„Äë„Äë„Äë**: Êó•ËÆ∞ÂøÖÈ°ª‰ΩøÁî®„ÄêÁ¨¨‰∏Ä‰∫∫Áß∞ËßÜËßí ("Êàë")„ÄëÊù•ÂÜôÔºåÂπ∂‰∏îË¶ÅÂÖÖÊª°ËßíËâ≤ÁöÑ‰∏™‰∫∫ÊÉÖÊÑü„ÄÅÊÄùËÄÉÂíåÁßòÂØÜ„ÄÇÂú®Êó•ËÆ∞‰∏≠ÊèèËø∞Ëá™Â∑±ÁöÑË°å‰∏∫ÊàñÊÉ≥Ê≥ïÊó∂Ôºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞‚Äú‰ªñ‚ÄùÊàñ‚ÄúÂ•π‚Äù (TA)„ÄÇ
3.  **„Äê„Äê„ÄêÈïøÂ∫¶ÈìÅÂæã„Äë„Äë„Äë**: Êó•ËÆ∞ÁöÑÊ≠£ÊñáÈïøÂ∫¶„ÄêÂøÖÈ°ª‰∏çÂ∞ë‰∫é300Â≠ó„Äë„ÄÇ
4.  **„Äê„Äê„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºå‰∏îÊï∞ÁªÑ‰∏≠„ÄêÂè™ÂåÖÂê´‰∏Ä‰∏™„ÄëÂØπË±°ÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "title": "ËøôÁØáÊó•ËÆ∞ÁöÑÊ†áÈ¢òÔºå‰æãÂ¶ÇÔºö9Êúà20Êó• Êô¥",
        "content": "ËøôÈáåÊòØÊó•ËÆ∞ÁöÑËØ¶ÁªÜÊ≠£ÊñáÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\nÔºåÂπ∂‰∏îÂøÖÈ°ªÂ∑ßÂ¶ôÂú∞‰ΩøÁî®‰∏ãÈù¢ÁöÑ„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï„ÄëÊù•‰∏∞ÂØåÊñáÊú¨Ë°®Áé∞Âäõ„ÄÇ"
      }
    ]
    \`\`\`
5.  **„Äê„Äê„ÄêÊó•ËÆ∞‰∏ìÂ±ûMarkdownËØ≠Ê≥ï (ÂøÖÈ°ª‰ΩøÁî®ÔºÅ)„Äë„Äë„Äë**:
    -   \`**Âä†Á≤óÊñáÂ≠ó**\`: Áî®‰∫éÂº∫Ë∞É„ÄÇ
    -   \`~~ÂàíÊéâÁöÑÊñáÂ≠ó~~\`: Áî®‰∫éË°®Á§∫ÊîπÂèò‰∏ªÊÑèÊàñËá™ÊàëÂê¶ÂÆö„ÄÇ
    -   \`!h{ÈªÑËâ≤È´ò‰∫Æ}\`: Áî®‰∫éÊ†áËÆ∞ÂÖ≥ÈîÆËØçÊàñÈáçË¶Å‰ø°ÊÅØ„ÄÇ
    -   \`!u{Á≤âËâ≤‰∏ãÂàíÁ∫ø}\`: Áî®‰∫éÊ†áÊ≥®‰∫∫Âêç„ÄÅÂú∞ÂêçÊàñÁâπÊÆäÂêçËØç„ÄÇ
    -   \`!e{Á≤âËâ≤Âº∫Ë∞É}\`: Áî®‰∫éË°®ËææÂº∫ÁÉàÁöÑÊÉÖÁª™„ÄÇ
    -   \`!w{ÊâãÂÜô‰Ωì}\`: Áî®‰∫éÂÜô‰∏ãÂºïË®Ä„ÄÅÊ≠åËØçÊàñÁâπÊÆäÁ¨îËÆ∞„ÄÇ
    -   \`!m{Âáå‰π±ÁöÑÊâãÂÜô‰Ωì}\`: Áî®‰∫éË°®ËææÊøÄÂä®„ÄÅÊÖå‰π±ÊàñÊΩ¶ËçâËÆ∞ÂΩïÊó∂ÁöÑÂøÉÊÉÖ„ÄÇ
    -   \`||Ê∂ÇÈªë||\`: Áî®‰∫éÈöêËóèÁßòÂØÜÊàñÊïèÊÑüËØçÊ±á(ÊØèÊ¨°Ê∂ÇÈªë2~5‰∏™Â≠ó)„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÊí∞ÂÜôËøôÁØáÂÖÖÊª°ÁúüÊÉÖÂÆûÊÑü„ÄÅÂπ∂ÁÜüÁªÉËøêÁî®‰∫ÜMarkdownËØ≠Ê≥ïÁöÑÊó•ËÆ∞„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÂÜô‰∏ÄÁØáÊñ∞Êó•ËÆ∞„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);
      const response = isGemini ? await fetch(geminiConfig.url, geminiConfig.data) : await fetch(`${proxyUrl}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: model,
          messages: [{
            role: 'system',
            content: systemPrompt
          }, ...messagesForApi],
          temperature: state.globalSettings.apiTemperature || 0.95,
        })
      });
      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);
      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let newDiaryEntry;
      try {
        newDiaryEntry = JSON.parse(cleanedJsonString)[0];
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      if (!chat.diary) chat.diary = [];

      chat.diary.push({
        id: Date.now(),
        title: newDiaryEntry.title,
        content: newDiaryEntry.content,
        timestamp: Date.now()
      });

      await db.chats.put(chat);
      await renderCharDiaryList();

    } catch (error) {
      console.error("ÁîüÊàêÊñ∞Êó•ËÆ∞Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    }
  }

  function renderCharDiaryList() {
    const listEl = document.getElementById('char-diary-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    const diaries = (char.diary || []).slice().reverse();

    if (diaries.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">Êó•ËÆ∞Êú¨ËøòÊòØÁ©∫ÁöÑ„ÄÇ</p>';
      return;
    }

    // SVG ÂõæÊ†á: ‰π¶Êú¨ÂõæÊ†á
    const diaryIconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>`;
    // SVG ÂõæÊ†á: Âè≥ÁÆ≠Â§¥
    const arrowIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

    diaries.forEach(entry => {
      const item = document.createElement('div');
      // Ê≥®ÊÑèÔºöÁßªÈô§‰∫ÜÊóßÁöÑ 'list-item' Á±ª
      item.className = 'diary-item';
      
      // Ê†ºÂºèÂåñÊó•Êúü
      const dateStr = new Date(entry.timestamp).toLocaleDateString('zh-CN');

      item.innerHTML = `
             <div class="cphone-item-icon-box diary-icon-style">
                ${diaryIconSVG}
            </div>
            <div class="cphone-item-info">
                <div class="cphone-item-title">${entry.title}</div>
                <div class="cphone-item-preview">${dateStr}</div>
            </div>
            <div class="cphone-item-arrow">
                ${arrowIcon}
            </div>
        `;
        
      item.addEventListener('click', () => viewDiary(entry.id));
      addLongPressListener(item, () => deleteDiary(entry.id));
      listEl.appendChild(item);
    });
  }



  async function viewDiary(diaryId) {
    const char = state.chats[activeCharacterId];
    if (!char || !char.diary) return;

    const entry = char.diary.find(d => d.id === diaryId);
    if (entry) {

      activeDiaryForViewing = entry;

      const titleEl = document.getElementById('char-diary-detail-title');
      const contentEl = document.getElementById('char-diary-detail-content');
      const favBtn = document.getElementById('favorite-diary-btn');

      titleEl.textContent = entry.title;
      const formattedContent = parseMarkdown(entry.content)
        .split('\n')
        .map(p => `<p>${p || '&nbsp;'}</p>`)
        .join('');
      contentEl.innerHTML = formattedContent;


      const existingFavorite = await db.favorites.where({
        type: 'char_diary',
        'content.id': diaryId
      }).first();
      favBtn.classList.toggle('active', !!existingFavorite);

      switchToCharScreen('char-diary-detail-screen');
    }
  }

 
  async function toggleDiaryFavorite() {
    if (!activeDiaryForViewing || !activeCharacterId) return;

    const diary = activeDiaryForViewing;
    const char = state.chats[activeCharacterId];
    const favBtn = document.getElementById('favorite-diary-btn');


    const existingFavorite = await db.favorites.where({
      type: 'char_diary',
      'content.id': diary.id
    }).first();

    if (existingFavorite) {

      await db.favorites.delete(existingFavorite.id);
      favBtn.classList.remove('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè„ÄÇ');
    } else {

      const newFavorite = {
        type: 'char_diary',

        content: {
          id: diary.id,
          title: diary.title,
          content: diary.content,
          timestamp: diary.timestamp,
          characterId: activeCharacterId,
          characterName: char.name
        },
        timestamp: Date.now()
      };
      await db.favorites.add(newFavorite);
      favBtn.classList.add('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÊàêÂäüÊî∂ËóèÂà∞‚ÄúÊàëÁöÑÊî∂Ëóè‚ÄùÈ°µÈù¢ÔºÅ');
    }
  }



  async function toggleMemoFavorite() {

    if (!activeMemoForViewing || !activeCharacterId) return;

    const memo = activeMemoForViewing;
    const char = state.chats[activeCharacterId];
    const favBtn = document.getElementById('favorite-memo-btn');


    const existingFavorite = await db.favorites.where({
      type: 'char_memo',
      'content.id': memo.id
    }).first();

    if (existingFavorite) {

      await db.favorites.delete(existingFavorite.id);
      favBtn.classList.remove('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè„ÄÇ');
    } else {

      const newFavorite = {
        type: 'char_memo',

        content: {
          id: memo.id,
          title: memo.title,
          content: memo.content,
          timestamp: memo.timestamp,
          characterId: activeCharacterId,
          characterName: char.name
        },
        timestamp: Date.now()
      };
      await db.favorites.add(newFavorite);
      favBtn.classList.add('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÊàêÂäüÊî∂ËóèÂà∞‚ÄúÊàëÁöÑÊî∂Ëóè‚ÄùÈ°µÈù¢ÔºÅ');
    }
  }


  async function deleteDiary(diaryId) {
    const confirmed = await showCustomConfirm('Âà†Èô§Êó•ËÆ∞', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁØáÊó•ËÆ∞ÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      const char = state.chats[activeCharacterId];
      char.diary = char.diary.filter(d => d.id !== diaryId);
      await db.chats.put(char);
      renderCharDiaryList();
    }
  }




  async function renderCharSimulatedQQ() {
    const listEl = document.getElementById('char-chat-list');
    listEl.innerHTML = '';
    const char = state.chats[activeCharacterId];
    if (!char) return;


    const userDisplayName = char.settings.myNickname || (state.qzoneSettings.nickname || 'Êàë');
    const lastRealMessage = char.history.filter(m => !m.isHidden).slice(-1)[0] || {
      content: '...'
    };


    let lastMsgContent = '...';
    if (lastRealMessage) {
      if (typeof lastRealMessage.content === 'string') {
        lastMsgContent = lastRealMessage.content;
      } else if (Array.isArray(lastRealMessage.content) && lastRealMessage.content[0]?.type === 'image_url') {
        lastMsgContent = '[ÂõæÁâá]';
      } else if (lastRealMessage.type) {
        const typeMap = {
          'voice_message': '[ËØ≠Èü≥]',
          'transfer': '[ËΩ¨Ë¥¶]',
          'ai_image': '[ÂõæÁâá]'
        };
        lastMsgContent = typeMap[lastRealMessage.type] || `[${lastRealMessage.type}]`;
      }
    }


    const myAvatar = char.settings.myAvatar || defaultAvatar;
    const myFrame = char.settings.myAvatarFrame || '';
    let avatarHtml;
    if (myFrame) {
      avatarHtml = `<div class="avatar-group has-frame" style="width: 45px; height: 45px;"><div class="avatar-with-frame" style="width: 45px; height: 45px;"><img src="${myAvatar}" class="avatar-img" style="border-radius: 50%;"><img src="${myFrame}" class="avatar-frame"></div></div>`;
    } else {
      avatarHtml = `<div class="avatar-group" style="width: 45px; height: 45px;"><img src="${myAvatar}" class="avatar" style="border-radius: 50%; width: 45px; height: 45px;"></div>`;
    }

    const userChatItem = document.createElement('div');
    userChatItem.className = 'chat-list-item';

    userChatItem.dataset.conversationIndex = "-1";
    userChatItem.innerHTML = `
        ${avatarHtml}
        <div class="info">
            <div class="name-line">
                <span class="name">${userDisplayName}</span>
            </div>
            <div class="last-msg">${String(lastMsgContent).substring(0, 20)}...</div>
        </div>
    `;
    listEl.appendChild(userChatItem);


    const allNpcs = await db.npcs.toArray();
    const npcMap = new Map(allNpcs.map(npc => [npc.name, npc]));
    const conversations = char.simulatedConversations || [];

    if (conversations.length === 0 && !userChatItem) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÔºå<br>ÁúãÁúãTAÊúÄËøëÈÉΩÂíåË∞ÅËÅäÂ§©‰∫ÜÂêßÔºÅ</p>';
      return;
    }

    conversations.forEach((convo, index) => {

      if (convo.type === 'private_user') {
        return;
      }


      const item = document.createElement('div');
      item.className = 'chat-list-item';
      item.dataset.conversationIndex = index;

      let lastMessage, avatarHtml, displayName;

      if (convo.type === 'group') {
        displayName = convo.groupName + ` <span class="group-tag">Áæ§</span>`;
        lastMessage = convo.messages.slice(-1)[0] || {
          content: '...'
        };
        const groupAvatarPrompt = `logo, simple, flat design, for a group chat named '${convo.groupName}'`;
        const avatarUrl = state.globalSettings.enableAiDrawing ? `https://image.pollinations.ai/prompt/${encodeURIComponent(groupAvatarPrompt)}` : defaultGroupAvatar;
        avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;

      } else {
        displayName = convo.participant.name;
        lastMessage = convo.messages.slice(-1)[0] || {
          content: '...'
        };
        const npcData = npcMap.get(displayName);
        let avatarUrl = (npcData && npcData.avatar) ? npcData.avatar :
          (state.globalSettings.enableAiDrawing ? `https://image.pollinations.ai/prompt/${encodeURIComponent(convo.participant.avatar_prompt || 'anime person')}` : defaultGroupMemberAvatar);
        avatarHtml = `<div class="avatar-group"><img src="${avatarUrl}" class="avatar" style="border-radius: 50%;"></div>`;
      }

      let lastMsgContent = '...';
      if (lastMessage && lastMessage.content) {
        lastMsgContent = lastMessage.content;
      }

      item.innerHTML = `
            ${avatarHtml}
            <div class="info">
                <div class="name-line">
                    <span class="name">${displayName}</span>
                </div>
                <div class="last-msg">${String(lastMsgContent).substring(0, 20)}...</div>
            </div>
        `;
      listEl.appendChild(item);
    });
  }
 
  async function handleGenerateSimulatedQQ() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê†πÊçÆ‚Äú${chat.name}‚ÄùÁöÑËÆ∞ÂøÜÂíå‰∫∫ËÆæÔºåÁîüÊàêÂÖ®Êñ∞ÁöÑÁ§æ‰∫§Âä®ÊÄÅ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const allNpcs = await db.npcs.toArray();
    const associatedNpcs = allNpcs.filter(npc =>
      npc.associatedWith && npc.associatedWith.includes(activeCharacterId)
    );
    let npcContext = "# ‰Ω†ÁöÑÁ§æ‰∫§Âúà (ÁªëÂÆöÁöÑNPC)\n";
    if (associatedNpcs.length > 0) {
      npcContext += "ËøôÊòØ‰Ω†ËÆ§ËØÜÁöÑ„ÄÅÂÖ≥Á≥ªÂØÜÂàáÁöÑNPC„ÄÇÂú®ÁîüÊàêÂØπËØùÊó∂Ôºå‰Ω†Â∫îËØ•„Äê‰ºòÂÖà„Äë‰∏é‰ªñ‰ª¨‰∫íÂä®„ÄÇ\n";
      associatedNpcs.forEach(npc => {
        npcContext += `- **ÂßìÂêç**: ${npc.name}\n  - **‰∫∫ËÆæ**: ${npc.persona}\n`;
      });
    } else {
      npcContext += "Ôºà‰Ω†ÁõÆÂâçÊ≤°ÊúâÁªëÂÆöÁöÑNPC‰ºô‰º¥ÔºåÂèØ‰ª•Ëá™Áî±ÂàõÈÄ†Êñ∞ÁöÑNPC„ÄÇÔºâ\n";
    }

    const userDisplayNameForAI = state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname ? 'Áî®Êà∑' : state.qzoneSettings.nickname;
    const userNicknameInThisChat = chat.settings.myNickname || userDisplayNameForAI;
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistoryWithUser_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistoryWithUser_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userNicknameInThisChat : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö (‰Ω†ÂèØ‰ª•Â∞ÜÂÖ∂‰∏≠ËßíËâ≤‰Ωú‰∏∫ËÅäÂ§©ÂØπË±°):\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');
    const characterOriginalName = chat.originalName || chat.name;
    const stickerContext = getGroupStickerContextForPrompt(chat);

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æ‰∫§ÁîüÊ¥ªÊ®°ÊãüÂô®ÔºåÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØËôöÊûÑÂá∫„Äê5Âà∞7ÊÆµ„ÄëTAÊúÄËøëÁöÑQQËÅäÂ§©ËÆ∞ÂΩï„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêNPCÂîØ‰∏ÄÊÄßÈìÅÂæã„Äë**: Âú®‰Ω†Êú¨Ê¨°ÁîüÊàêÁöÑÊâÄÊúâÂØπËØù‰∏≠ÔºàÂåÖÊã¨ÁßÅËÅäÂíåÁæ§ËÅäÔºâÔºåÊØè‰∏Ä‰∏™NPCÁöÑÂêçÂ≠ó„ÄêÂøÖÈ°ªÊòØÁã¨‰∏Ä-Êó†‰∫åÁöÑ„Äë„ÄÇÁªùÂØπÁ¶ÅÊ≠¢Âá∫Áé∞ÈáçÂêçÁöÑNPCÔºåÁ¶ÅÊ≠¢Âá∫Áé∞ÈáçÂ§çÁæ§ËÅä„ÄÇ
2.  **„ÄêNPCÊù•Ê∫ê„Äë**: ‰Ω†Â∫îËØ•‰ºòÂÖà‰ªé‚Äú‰Ω†ÁöÑÁ§æ‰∫§Âúà (ÁªëÂÆöÁöÑNPC)‚ÄùÂíå‚Äú‰∏ñÁïå‰π¶‚Äù‰∏≠ÂØªÊâæËßíËâ≤‰Ωú‰∏∫ËÅäÂ§©ÂØπË±°„ÄÇÂ¶ÇÊûú‰∏çÂ§üÔºå‰Ω†‰πüÂèØ‰ª•Ëá™Áî±ÂàõÈÄ†ÂÖ®Êñ∞ÁöÑNPCÔºåÂØπËØùÂÜÖÂÆπË¶ÅÂ§öÊ†∑ÂåñÔºåÂèçÊò†ËßíËâ≤ÁöÑÁîüÊ¥ª„ÄÇ
3.  **ÂÖ≥ËÅîÊÄß**: ÂØπËØùÂÜÖÂÆπÂ∫îÂ∑ßÂ¶ôÂú∞ÂèçÊò†ËßíËâ≤ÁöÑÈïøÊúüËÆ∞ÂøÜ„ÄÅ‰∏ñÁïåËßÇÔºå‰ª•Âèä‰∏éÁî®Êà∑‰∫íÂä®ÂèØËÉΩÂ∏¶Êù•ÁöÑÂøÉÊÉÖÂèòÂåñ„ÄÇ
4.  **ÁÆÄÊ¥ÅÊÄß**: ÊØèÊÆµÂØπËØùÁöÑÊÄªÈïøÂ∫¶Â∫îÂú®8Âà∞15Âè•‰πãÈó¥„ÄÇ
# Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞„ÄÇ
- Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ‰ª£Ë°®‰∏ÄÊÆµÂØπËØùÔºå‰∏î„ÄêÂøÖÈ°ª„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÔºö



### Ê†ºÂºè AÔºö‰∏éNPCÁöÑÁßÅËÅä
\`\`\`json
{
  "type": "private_npc",
  "participant": {
    "name": "NPCÁöÑÂêçÂ≠ó",
    "avatar_prompt": "(‰ªÖÂΩìNPCÊòØÊñ∞ÂàõÈÄ†Êó∂Êèê‰æõ)‰∏ÄÊÆµÁî®‰∫éÁîüÊàêÂ§¥ÂÉèÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫Âä®Êº´/ÊèíÁîª/‰∫åÊ¨°ÂÖÉÁ≠â, Á¶ÅÊ≠¢Áúü‰∫∫"
  },
"messages": [
  {"sender": "${characterOriginalName}", "content": "ÂØπËØùÂÜÖÂÆπ1"},
  {"sender": "NPCÁöÑÂêçÂ≠ó", "content": "ÂØπËØùÂÜÖÂÆπ2"},
  {"sender": "${characterOriginalName}", "type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}
]
}
\`\`\`

### Ê†ºÂºè BÔºöÁæ§ËÅä
\`\`\`json
{
  "type": "group",
  "groupName": "‰∏Ä‰∏™ËôöÊûÑÁöÑÁæ§Âêç",
  "participants": [
    {"name": "NPCÊàêÂëò1", "avatar_prompt": "(‰ªÖÂΩìNPCÊòØÊñ∞ÂàõÈÄ†Êó∂Êèê‰æõ) ÊàêÂëò1Â§¥ÂÉè„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç"},
    {"name": "NPCÊàêÂëò2", "avatar_prompt": "(‰ªÖÂΩìNPCÊòØÊñ∞ÂàõÈÄ†Êó∂Êèê‰æõ) ÊàêÂëò2Â§¥ÂÉè„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç"}
  ],
"messages": [
  {"sender": "${characterOriginalName}", "content": "ÊàëÂú®Áæ§ÈáåËØ¥ÁöÑËØù"},
  {"sender": "NPCÊàêÂëò1", "content": "ÊàêÂëò1ÂõûÂ§çÊàë"},
  {"sender": "NPCÊàêÂëò2", "type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(ÂøÖÈ°ª‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}
]
}
\`\`\`

# ËßíËâ≤‰∏é‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**: ${longTermMemoryContext}
- **‰∏ñÁïåËßÇ**: ${worldBookContext}
- **ÊúÄËøë‰∏éÁî®Êà∑ÁöÑ‰∫íÂä®**: ${recentHistoryWithUser}
${npcContext}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}
Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÊåâÁÖßÊ†ºÂºèÈìÅÂæãÔºåÁîüÊàêËÅäÂ§©ËÆ∞ÂΩïÁöÑJSONÊï∞ÁªÑ„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàêÊ®°ÊãüËÅäÂ§©ËÆ∞ÂΩï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedConversations;
      try {
        simulatedConversations = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }

      chat.simulatedConversations = simulatedConversations;
      await db.chats.put(chat);

      await renderCharSimulatedQQ();


      const hiddenMessage = {
        role: 'system',
        content: `[Á≥ªÁªüÊåá‰ª§Ôºö‰Ω†ÂàöÂàöÂú®Ëá™Â∑±ÁöÑÊâãÊú∫‰∏äÊ¥ªÂä®‰∫Ü‰∏ÄÁï™ÔºàÂíåÊúãÂèãËÅäÂ§©„ÄÅÈÄõÁæ§Á≠âÔºâ„ÄÇÁé∞Âú®ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºå‰∏ªÂä®ÁªôÁî®Êà∑Âèë‰∏ÄÊù°Ê∂àÊÅØÔºåÂèØ‰ª•ËÅäËÅä‰Ω†ÂàöÊâçÁúãÂà∞ÊàñËÅäÂà∞ÁöÑË∂£‰∫ãÔºåÊàñËÄÖ‰ªÖ‰ªÖÊòØÈóÆÂÄô‰∏Ä‰∏ã„ÄÇ]`,
        timestamp: Date.now(),
        isHidden: true
      };
      chat.history.push(hiddenMessage);
      await db.chats.put(chat);
      triggerAiResponse();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüËÅäÂ§©Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊ®°ÊãüËÅäÂ§©ËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

 
  async function handleContinueRealConversationFromCPhone() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;



    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      }

      const maxMemory = parseInt(chat.settings.maxMemory) || 10;
      const historySlice = chat.history.slice(-maxMemory);
      const filteredHistory = await filterHistoryWithDoNotSendRules(historySlice, activeCharacterId);
      const myNickname = chat.settings.myNickname || 'Êàë';






      const userPersona = chat.settings.myPersona || 'Áî®Êà∑';


      const longTermMemoryContext = `# ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${
            chat.longTermMemory && chat.longTermMemory.length > 0 
                ? chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') 
                : '- (ÊöÇÊó†)'
        }`;


      let worldBookContext = '';
      if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
          const worldBook = state.worldBooks.find(wb => wb.id === bookId);
          if (!worldBook || !Array.isArray(worldBook.content)) return '';
          const formattedEntries = worldBook.content
            .filter(entry => entry.enabled !== false)
            .map(entry => `\n### Êù°ÁõÆ: ${entry.comment || 'Êó†Â§áÊ≥®'}\n**ÂÜÖÂÆπ:**\n${entry.content}`)
            .join('');
          return formattedEntries ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${formattedEntries}` : '';
        }).filter(Boolean).join('');
        if (linkedContents) {
          worldBookContext = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
        }
      }

      const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
      const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
      const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
      const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
      const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
      const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

      let multiLayeredSummaryContext = '';
      if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
        multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
        if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
        if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
        if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
        if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
        if (summaryToday) multiLayeredSummaryContext += summaryToday;
        if (summary3Days) multiLayeredSummaryContext += summary3Days;
        if (summary7Days) multiLayeredSummaryContext += summary7Days;
      }
      const stickerContext = getStickerContextForPrompt(chat);
      const systemPrompt = `
# ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°
‰Ω†Ê≠£Âú®ÊâÆÊºîËßíËâ≤‚Äú${chat.originalName}‚Äù„ÄÇÁî®Êà∑ÂàöÂàöÂú®TAÁöÑÊâãÊú∫ÔºàCPhoneÔºâ‰∏äÁÇπÂáª‰∫Ü‰∏Ä‰∏™ÊåâÈíÆÔºåÂ∏åÊúõ‰Ω†ËÉΩÁªßÁª≠‰Ω†‰ª¨‰πãÂâçÁöÑÂØπËØù„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆ‰∏ä‰∏ãÊñáÔºåÁîüÊàê„Äê3Âà∞5Êù°„ÄëÁ¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑ„ÄÅÁÆÄÁü≠ÁöÑ„ÄÅËøûÁª≠ÁöÑÊñ∞ÂõûÂ§ç„ÄÇ

# ËæìÂá∫Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ
- Ê†ºÂºè: \`[{"type": "text", "content": "Á¨¨‰∏ÄÂè•ËØù"}, {"type": "text", "content": "Á¨¨‰∫åÂè•ËØù"}, {"type": "sticker", "meaning": "Ë°®ÊÉÖÁöÑÂê´‰πâ(‰ªéÂèØÁî®Ë°®ÊÉÖÂàóË°®ÈÄâÊã©)"}]\`
- ‰Ω†ÂèØ‰ª•Ëá™Áî±ÁªÑÂêà‰ΩøÁî® "text", "sticker", "ai_image", "voice_message" Á≠âÂ§öÁßçÊ∂àÊÅØÁ±ªÂûã„ÄÇ
ËØ∑Ê†πÊçÆÂΩìÂâçÊÉÖÊôØÂíå‰Ω†ÁöÑÊÉÖÁª™Ôºå‰ªéÂàóË°®‰∏≠„ÄêÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ„ÄëË°®ÊÉÖÂê´‰πâÊù•‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇÂ∞ΩÈáèËÆ©‰Ω†ÁöÑË°®ÊÉÖ‰∏∞ÂØåÂ§öÊ†∑ÔºåÈÅøÂÖçÈáçÂ§ç„ÄÇ
# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆàÔºÅ)
- ÂΩì‰Ω†ÈúÄË¶ÅÂèëÈÄÅË°®ÊÉÖÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠„ÄêÁ≤æÁ°ÆÂú∞ÈÄâÊã©‰∏Ä‰∏™„ÄëÂê´‰πâÔºàmeaningÔºâ„ÄÇ
- „ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰ªª‰Ωï‰∏çÂú®ÂàóË°®‰∏≠ÁöÑË°®ÊÉÖÂê´‰πâÔºÅ
${stickerContext}

# ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ
${userPersona}  

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑÊú¨Âêç**: "${chat.originalName}"
- **Áî®Êà∑ÁöÑÂ§áÊ≥®**: "${myNickname}"
${worldBookContext}
${longTermMemoryContext}
${multiLayeredSummaryContext} 
- **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØù**:
${historySlice.map(msg => `${msg.role === 'user' ? myNickname : chat.name}: ${String(msg.content)}`).join('\n')}

Áé∞Âú®ÔºåËØ∑ÁªßÁª≠ËøôÂú∫ÂØπËØù„ÄÇ
`;


      const messagesPayload = filteredHistory.map(msg => ({
        role: msg.role,
        content: `${msg.role === 'user' ? myNickname : chat.name}: ${String(msg.content)}`
      }));

      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesPayload);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesPayload],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) {
        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${(await response.json()).error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const messagesArray = parseAiResponse(aiResponseContent);

      if (!messagesArray || messagesArray.length === 0) {
        throw new Error("AIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ„ÄÇ");
      }

      let newMessagesCount = 0;
      let messageTimestamp = Date.now();
      for (const msgData of messagesArray) {
        const baseMessage = {
          role: 'assistant',
          senderName: chat.originalName,
          timestamp: messageTimestamp++
        };
        let aiMessage = null;
        switch (msgData.type) {
          case 'text':
            aiMessage = {
              ...baseMessage,
              content: String(msgData.content || msgData.message)
            };
            break;
          case 'sticker':
            if (msgData.meaning) {
              const sticker = findBestStickerMatch(msgData.meaning, state.userStickers);
              if (sticker) {
                aiMessage = {
                  ...baseMessage,
                  type: 'sticker',
                  content: sticker.url,
                  meaning: sticker.name
                };
              } else {
                console.warn(`AI (CPhone) Â∞ùËØï‰ΩøÁî®‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖ: "${msgData.meaning}"`);
                aiMessage = null;
              }
            } else {
              console.warn("AI (CPhone) ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ê≤°Êúâ 'meaning' ÁöÑ sticker Êåá‰ª§„ÄÇ", msgData);
              aiMessage = {
                ...baseMessage,
                type: 'sticker',
                content: msgData.url,
                meaning: 'Êú™Áü•Ë°®ÊÉÖ'
              };
            }
            break;
        }
        if (aiMessage) {
          chat.history.push(aiMessage);
          newMessagesCount++;
        }
      }

      if (newMessagesCount > 0) {
        chat.unreadCount = (chat.unreadCount || 0) + newMessagesCount;
      }

      await db.chats.put(chat);
      await renderChatList();

      if (newMessagesCount > 0) {
        showNotification(chat.id, `ÂèëÊù•‰∫Ü ${newMessagesCount} Êù°Êñ∞Ê∂àÊÅØ`);
      }

    } catch (error) {
      console.error("‰ªéCPhoneÊé®ËøõÁúüÂÆûÂØπËØùÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `Êó†Ê≥ïÁîüÊàêÊñ∞ÂõûÂ§ç: ${error.message}`);
    }
  }
 
  async function loadMoreMirroredMessages() {
    if (isLoadingMoreCphoneMessages || !activeCharacterId) return;
    isLoadingMoreCphoneMessages = true;

    const messagesContainer = document.getElementById('char-conversation-messages');
    const mainChar = state.chats[activeCharacterId];
    if (!mainChar) {
      isLoadingMoreCphoneMessages = false;
      return;
    }

    showLoader(messagesContainer, 'top');
    const oldScrollHeight = messagesContainer.scrollHeight;


    await new Promise(resolve => setTimeout(resolve, 500));

    const totalMessages = mainChar.history.length;
    const renderWindow = state.globalSettings.chatRenderWindow || 50;
    const nextSliceEnd = totalMessages - cphoneRenderedCount;
    const nextSliceStart = Math.max(0, nextSliceEnd - renderWindow);

    const messagesToPrepend = mainChar.history.slice(nextSliceStart, nextSliceEnd);


    hideLoader(messagesContainer);

    if (messagesToPrepend.length === 0) {
      isLoadingMoreCphoneMessages = false;
      return;
    }


    for (const msg of messagesToPrepend.reverse()) {
      const mirroredMsg = {
        ...msg,
        role: msg.role === 'user' ? 'assistant' : 'user'
      };


      const tempChatObjectForRendering = {
        id: 'temp_user_chat_mirror',
        isGroup: false,
        name: mainChar.name,
        settings: {
          ...mainChar.settings,
          myAvatar: mainChar.settings.aiAvatar,
          myAvatarFrame: mainChar.settings.aiAvatarFrame,
          aiAvatar: mainChar.settings.myAvatar,
          aiAvatarFrame: mainChar.settings.myAvatarFrame
        }
      };

      const messageEl = await createMessageElement(mirroredMsg, tempChatObjectForRendering);
      if (messageEl) {
        messagesContainer.prepend(messageEl);
      }
    }

    cphoneRenderedCount += messagesToPrepend.length;


    const newScrollHeight = messagesContainer.scrollHeight;
    messagesContainer.scrollTop = newScrollHeight - oldScrollHeight;

    isLoadingMoreCphoneMessages = false;
  }

  async function openCharSimulatedConversation(conversationIndex) {
    const mainChar = state.chats[activeCharacterId];
    if (!mainChar) return;

    cphoneActiveConversationType = (conversationIndex === -1) ? 'private_user' : mainChar.simulatedConversations[conversationIndex]?.type;

    const bodyEl = document.getElementById('char-conversation-messages');
    bodyEl.innerHTML = '';
    bodyEl.dataset.theme = mainChar.settings.theme || 'default';
    const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
    bodyEl.style.backgroundColor = isDarkMode ? '#000000' : '#f0f2f5';

    let tempChatObjectForRendering;
    let messagesToRender = [];
    const allNpcs = await db.npcs.toArray();
    const npcMap = new Map(allNpcs.map(npc => [npc.name, npc])); 

    if (conversationIndex === -1) {

      cphoneActiveConversationType = 'private_user';
      const titleEl = document.getElementById('char-conversation-partner-name');
    
      const inputEl = document.getElementById('char-simulated-input');

      bodyEl.innerHTML = '';
      titleEl.textContent = mainChar.settings.myNickname || (state.qzoneSettings.nickname || 'Êàë');
      inputEl.placeholder = `‰∏é ${mainChar.settings.myNickname || 'Êàë'} ÁöÑÂØπËØù (Âè™ËØª)`;

      cphoneRenderedCount = 0;
      isLoadingMoreCphoneMessages = false;

      const history = mainChar.history;
      const renderWindow = state.globalSettings.chatRenderWindow || 50;
      const initialMessages = history.slice(-renderWindow);

      tempChatObjectForRendering = {
        id: 'temp_user_chat_mirror',
        isGroup: false,
        name: mainChar.name,
        settings: {
          ...mainChar.settings,
          myAvatar: mainChar.settings.aiAvatar,
          myAvatarFrame: mainChar.settings.aiAvatarFrame,
          aiAvatar: mainChar.settings.myAvatar,
          aiAvatarFrame: mainChar.settings.myAvatarFrame
        }
      };

      messagesToRender = initialMessages.map(msg => ({
        ...msg,
        role: msg.role === 'user' ? 'assistant' : 'user'
      }));
      cphoneRenderedCount = initialMessages.length;

    } else {

      const conversation = mainChar.simulatedConversations[conversationIndex];
      if (!conversation) return;
      cphoneActiveConversationType = conversation.type;

      const titleEl = document.getElementById('char-conversation-partner-name');
   
      const inputEl = document.getElementById('char-simulated-input');

      if (conversation.type === 'group') {
        titleEl.textContent = `${conversation.groupName} (${conversation.participants.length + 1})`;
        inputEl.placeholder = `Âú® ${conversation.groupName} ‰∏≠ËÅäÂ§©`;
        tempChatObjectForRendering = {
          id: 'temp_group_chat',
          isGroup: true,
          name: conversation.groupName,
          originalName: mainChar.originalName,
          members: conversation.participants.map(p => {
            const npcData = npcMap.get(p.name);
            let avatarUrl = (npcData && npcData.avatar) ? npcData.avatar :
              (state.globalSettings.enableAiDrawing ?
                `https://image.pollinations.ai/prompt/${encodeURIComponent(p.avatar_prompt || 'anime person')}` :
                defaultGroupMemberAvatar);
            return {
              originalName: p.name,
              groupNickname: p.name,
              avatar: avatarUrl
            };
          }),
          settings: {
            ...mainChar.settings,
            myNickname: mainChar.name,
            myAvatar: mainChar.settings.aiAvatar,
            myAvatarFrame: mainChar.settings.aiAvatarFrame,
          }
        };
      } else {
        titleEl.textContent = conversation.participant.name;
        inputEl.placeholder = `‰∏é ${conversation.participant.name} ÁöÑÂØπËØù`;
        const npcData = npcMap.get(conversation.participant.name);
        const npcAvatarUrl = (npcData && npcData.avatar) ? npcData.avatar :
          (state.globalSettings.enableAiDrawing ?
            `https://image.pollinations.ai/prompt/${encodeURIComponent(conversation.participant.avatar_prompt || 'anime person')}` :
            defaultGroupMemberAvatar);
        tempChatObjectForRendering = {
          id: 'temp_npc_chat',
          isGroup: false,
          name: conversation.participant.name,
          originalName: mainChar.originalName,
          settings: {
            ...mainChar.settings,
            myAvatar: mainChar.settings.aiAvatar,
            myAvatarFrame: mainChar.settings.aiAvatarFrame,
            aiAvatar: npcAvatarUrl,
            aiAvatarFrame: ''
          }
        };
      }
      messagesToRender = conversation.messages; 
    }


    
    for (const msg of messagesToRender) {
      let role = msg.role; 
      if (conversationIndex !== -1) {
        const isFromMainChar = msg.sender === (mainChar.originalName || mainChar.name);
        role = isFromMainChar ? 'user' : 'assistant';
      }

      const tempMessageObject = {
        role: role,
        senderName: msg.sender || (role === 'user' ? tempChatObjectForRendering.settings.myNickname : tempChatObjectForRendering.name),
        timestamp: msg.timestamp || (Date.now() + Math.random())
      };


      if (msg.type === 'sticker' && msg.meaning) {

        const sticker = state.userStickers.find(s => s.name === msg.meaning);
        if (sticker) {
          tempMessageObject.content = sticker.url;
          tempMessageObject.meaning = msg.meaning;
          tempMessageObject.type = 'sticker';
        } else {

          console.warn(`Ê®°ÊãüË°®ÊÉÖÂê´‰πâ "${msg.meaning}" Âú®Â∫ì‰∏≠Êú™ÊâæÂà∞„ÄÇ`);
          tempMessageObject.content = `[Ë°®ÊÉÖ: ${msg.meaning}]`;
          tempMessageObject.type = 'text';
        }
      } else {

        tempMessageObject.content = msg.content;
        tempMessageObject.type = msg.type || 'text';
      }

      const bubbleElement = await createMessageElement(tempMessageObject, tempChatObjectForRendering);
      if (bubbleElement) {
        bodyEl.appendChild(bubbleElement);
      }
    }

    switchToCharScreen('char-qq-conversation-screen');
    setTimeout(() => bodyEl.scrollTop = bodyEl.scrollHeight, 0); // Ê∏≤ÊüìÂÆåÊàêÂêéÊªöÂä®Âà∞Â∫ïÈÉ®
  }

  function closeSimulatedTranscriptModal() {
    document.getElementById('char-qq-transcript-modal').classList.remove('visible');
  }


 
  async function handleGenerateSimulatedAlbum() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];

    if (!chat) {
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", "Êó†Ê≥ïÊâæÂà∞ÂΩìÂâçËßíËâ≤ÁöÑÊï∞ÊçÆ„ÄÇ");
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂõûÂøÜTAÁöÑÁõ∏ÂÜåÁÖßÁâá...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e=>e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåÊûÑÊÄùÂá∫„Äê8Âà∞10Âº†„ÄëTAÊúÄËøëÂèØËÉΩ‰ºöÊãçÊëÑÊàñÁèçËóèÂú®ÊâãÊú∫Áõ∏ÂÜåÈáåÁöÑÁÖßÁâá„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: ÁÖßÁâáÂÜÖÂÆπÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
2.  **Â§öÊ†∑ÊÄß**: ÁÖßÁâá‰∏ªÈ¢òË¶Å‰∏∞ÂØåÔºåÂèØ‰ª•ÂåÖÊã¨Ëá™Êãç„ÄÅÈ£éÊôØ„ÄÅÈ£üÁâ©„ÄÅÂÆ†Áâ©„ÄÅÊúãÂèãÂêàÂΩ±„ÄÅÂ∑•‰ΩúÂú∫ÊôØÁ≠â„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÂº†ÁÖßÁâáÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "description": "ËøôÊòØÁÖßÁâáËÉåÂêéÁöÑÊïÖ‰∫ãÊàñËßíËâ≤ÁöÑÂøÉÊÉÖÊó•ËÆ∞ÔºåÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚ÄùÊù•ÂÜô„ÄÇ",
        "image_prompt": "‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøôÂº†ÁÖßÁâáÁöÑ„ÄÅËØ¶ÁªÜÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ"
      }
    ]
    \`\`\`
    - **„Äêimage_prompt ÁªùÂØπÁ¶ÅÊ≠¢„Äë**: ÁªùÂØπÁ¶ÅÊ≠¢ÂåÖÂê´‰ªª‰Ωï‰∏≠ÊñáÂ≠óÁ¨¶„ÄÅÂè•Â≠ê„ÄÅÁâπÊÆäÁ¨¶Âè∑„ÄÅÊàñ‰ªª‰ΩïÂèØËÉΩÊ∂âÂèäÊïèÊÑüÔºàNSFWÔºâ„ÄÅÊö¥Âäõ„ÄÅË°ÄËÖ•„ÄÅÊîøÊ≤ªÁöÑÂÜÖÂÆπÔºÅ‰πüÁ¶ÅÊ≠¢Áúü‰∫∫ÔºÅ
    - **„Äêimage_prompt ÂøÖÈ°ªÊòØ„Äë**: ÂøÖÈ°ªÊòØÁ∫ØËã±ÊñáÁöÑ„ÄÅÁî®ÈÄóÂè∑ÂàÜÈöîÁöÑ„ÄêÂÖ≥ÈîÆËØçÁªÑÂêà„Äë (e.g., "1boy, solo, basketball jersey, in locker room, smiling, selfie")„ÄÇ
    - **„ÄêÁîªÈ£éÊåá‰ª§„Äë**: Âú® prompt ÁöÑÊú´Â∞æÔºåÊÄªÊòØÂä†‰∏äÁîªÈ£éÊåá‰ª§Ôºå‰æãÂ¶ÇÔºö \`best quality, masterpiece, anime style, cinematic lighting\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑÁÖßÁâáÁöÑÊèèËø∞ÂíåÁªòÁîªÊåá‰ª§„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÁõ∏ÂÜåÂÜÖÂÆπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9

          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedAlbumData;
      try {
        simulatedAlbumData = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.simulatedAlbum = simulatedAlbumData;
      await db.chats.put(chat);

      await renderCharAlbum();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÁõ∏ÂÜåÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊ®°ÊãüÁõ∏ÂÜåÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }



 
  async function renderCharAlbum() {
    const gridEl = document.getElementById('char-album-grid');
    gridEl.innerHTML = '';
    if (!activeCharacterId) return;
    const char = state.chats[activeCharacterId];

    const photos = char.simulatedAlbum || [];

    if (photos.length === 0) {
      gridEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÁõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÁÖßÁâáÂêßÔºÅ</p>';
      return;
    }

    const fallbackImageUrl = `https://i.postimg.cc/KYr2qRCK/1.jpg`;

    photos.forEach(photo => {
      const item = document.createElement('div');
      item.className = 'char-photo-item';
      item.dataset.description = photo.description;
      gridEl.appendChild(item);







      if (state.globalSettings.enableAiDrawing) {

        item.style.backgroundColor = '#e9ecef';
        const containsNonEnglish = /[^\x00-\x7F]/.test(photo.image_prompt);
        const isValidPrompt = photo.image_prompt && photo.image_prompt.trim() && !containsNonEnglish;
        const finalPrompt = isValidPrompt ? photo.image_prompt : 'a beautiful scenery, anime style, cinematic lighting';
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(finalPrompt)}`;

        const img = new Image();
        img.onload = function() {
          item.style.backgroundImage = `url(${this.src})`;
        };
        img.onerror = function() {
          item.style.backgroundImage = `url(${fallbackImageUrl})`;
        };
        img.src = imageUrl;

      } else {

        item.style.backgroundColor = '#f0f2f5';
        item.style.border = '1px solid #e0e0e0';

        const descriptionEl = document.createElement('p');
        descriptionEl.className = 'char-photo-description';
        descriptionEl.textContent = photo.description || '(ËøôÂº†ÁÖßÁâáÊ≤°ÊúâÊèèËø∞)';

        item.appendChild(descriptionEl);
      }
    });
  }


  async function handleGenerateBrowserHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê®°Êãü‚Äú${chat.name}‚ÄùÁöÑÁΩë‰∏äÂÜ≤Êµ™Ë∂≥Ëøπ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistoryWithUser = chat.history.slice(-maxMemory).map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê10Âà∞20Êù°„ÄëTAÊúÄËøëÁöÑÊµèËßàÂô®ÊêúÁ¥¢/ÊµèËßàËÆ∞ÂΩï„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: ËÆ∞ÂΩïÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
2.  **Â§öÊ†∑ÊÄß**: ËÆ∞ÂΩïÁ±ªÂûãË¶Å‰∏∞ÂØåÔºåÂèØ‰ª•ÊòØÂ∏ñÂ≠ê„ÄÅÊñáÁ´†„ÄÅÊñ∞Èóª„ÄÅÈóÆÁ≠îÁ≠â„ÄÇ
3.  **„ÄêÊ†ºÂºè (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ‰ª£Ë°®‰∏ÄÊù°ÊµèËßàËÆ∞ÂΩïÔºåÂπ∂‰∏î„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºè:
    \`\`\`json
    [
      {
        "type": "text",
        "title": "Á≤æÁÇº‰∏îÂê∏Âºï‰∫∫ÁöÑÊ†áÈ¢ò (‰∏çË∂ÖËøá20Â≠ó)",
        "url": "www.example.com/article/123 (ÁúãËµ∑Êù•ÂÉèÁúüÂÆûÁöÑÁÆÄÊ¥ÅÁΩëÂùÄ)",
        "content": "‰∏ÄÁØá200-400Â≠óÁöÑ„ÄÅÂàÜÊÆµËâØÂ•ΩÁöÑÊñáÁ´†Ê≠£ÊñáÔºå‰ΩøÁî®\\nÊç¢Ë°å„ÄÇ"
      }
    ]
    \`\`\`
    
    **„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë**: ‰Ω†ÁöÑÂõûÂ§ç‰∏≠„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂåÖÂê´ "type": "image" ÁöÑÂØπË±°„ÄÇÊâÄÊúâËÆ∞ÂΩïÈÉΩÂøÖÈ°ªÊòØÊñáÂ≠óÂÜÖÂÆπ„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- ** ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ**:${userPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑ„ÄêÁ∫ØÊñáÊú¨„ÄëÁöÑÊµèËßàËÆ∞ÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊµèËßàÂô®ËÆ∞ÂΩï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9

          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedHistory;
      try {
        simulatedHistory = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.simulatedBrowserHistory = simulatedHistory;
      await db.chats.put(chat);

      await renderCharBrowserHistory();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊµèËßàÂô®ÂéÜÂè≤Â§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊµèËßàËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

  function renderCharBrowserHistory() {
    const listEl = document.getElementById('char-browser-history');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const history = char.simulatedBrowserHistory || [];

    if (history.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÊµèËßàÂô®Á©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }

    history.forEach((item, index) => {
      const entryEl = document.createElement('div');
      entryEl.className = 'char-browser-item';
      entryEl.innerHTML = `
            <div class="title">${item.title}</div>
            <div class="url">${item.url}</div>
        `;

      entryEl.addEventListener('click', () => openCharArticle(index));
      listEl.appendChild(entryEl);
    });
  }



  async function openCharArticle(index) {
    const char = state.chats[activeCharacterId];
    const articleData = char.simulatedBrowserHistory[index];
    if (!articleData) return;



    activeArticleForViewing = articleData;


    renderCharArticle(articleData);
    switchToCharScreen('char-browser-article-screen');



    const favBtn = document.getElementById('favorite-article-btn');

    const existingFavorite = await db.favorites.where({
      type: 'char_browser_article',
      'content.url': articleData.url
    }).first();
    favBtn.classList.toggle('active', !!existingFavorite);

  }


  async function toggleBrowserArticleFavorite() {
    if (!activeArticleForViewing || !activeCharacterId) return;

    const article = activeArticleForViewing;
    const char = state.chats[activeCharacterId];
    const favBtn = document.getElementById('favorite-article-btn');


    const existingFavorite = await db.favorites.where({
      type: 'char_browser_article',
      'content.url': article.url
    }).first();

    if (existingFavorite) {

      await db.favorites.delete(existingFavorite.id);
      favBtn.classList.remove('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè„ÄÇ');
    } else {

      const newFavorite = {
        type: 'char_browser_article',

        content: {
          ...article,
          characterId: activeCharacterId,
          characterName: char.name
        },
        timestamp: Date.now()
      };
      await db.favorites.add(newFavorite);
      favBtn.classList.add('active');
      await showCustomAlert('Êìç‰ΩúÊàêÂäü', 'Â∑≤ÊàêÂäüÊî∂ËóèÂà∞‚ÄúÊàëÁöÑÊî∂Ëóè‚ÄùÈ°µÈù¢ÔºÅ');
    }
  }
 
  function renderCharArticle(articleData) {
    const titleEl = document.getElementById('char-article-title'); // È°∂ÈÉ®ÂØºËà™Ê†èÁöÑÂ∞èÊ†áÈ¢ò
    const contentEl = document.getElementById('char-article-content'); // ÂÜÖÂÆπÂå∫Âüü

    // ÂØºËà™Ê†èÂè™ÊòæÁ§∫Êù•Ê∫êÊàñÁÆÄÁï•Ê†áÈ¢ò
    let navTitle = "ÁΩëÈ°µÊµèËßà";
    if (articleData.url) {
        // Â∞ùËØï‰ªé URL ÊèêÂèñÂüüÂêç‰Ωú‰∏∫ÂØºËà™Ê†áÈ¢ò
        try {
            const urlObj = new URL(articleData.url.startsWith('http') ? articleData.url : `http://${articleData.url}`);
            navTitle = urlObj.hostname.replace('www.', '');
        } catch (e) {
            navTitle = articleData.title.substring(0, 10) + '...';
        }
    }
    titleEl.textContent = navTitle;
    
    contentEl.innerHTML = '';

    if (articleData.type === 'image') {
        // ÂõæÁâáÁ±ªÂûãÁöÑÊñáÁ´†
        contentEl.innerHTML = `
            <div class="char-browser-image-description">
                <div style="font-size: 40px; margin-bottom: 20px; opacity: 0.5;">üñºÔ∏è</div>
                ${articleData.title || '(Êó†Ê†áÈ¢òÂõæÁâá)'}
            </div>`;
    } else {
        // ÊñáÊú¨Á±ªÂûãÁöÑÊñáÁ´†
        const largeTitle = `<div class="article-large-title">${articleData.title}</div>`;
        
        // Â§ÑÁêÜÊ≠£ÊñáÊç¢Ë°åÔºåÂåÖË£πÂú® p Ê†áÁ≠æ‰∏≠
        const paragraphs = (articleData.content || 'ÂÜÖÂÆπÂä†ËΩΩÂ§±Ë¥•...')
            .split('\n')
            .filter(line => line.trim() !== '') // ËøáÊª§Á©∫Ë°å
            .map(line => `<p>${line}</p>`)
            .join('');

        contentEl.innerHTML = `
            ${largeTitle}
            <div class="article-body">
                ${paragraphs}
            </div>
        `;
    }
}





  async function handleGenerateTaobaoHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê®°Êãü‚Äú${chat.name}‚ÄùÁöÑË¥≠Áâ©‰π†ÊÉØ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫TAÊúÄËøëÁöÑÊ∑òÂÆùË¥≠Áâ©ËÆ∞ÂΩïÂíåË¥¶Êà∑‰ΩôÈ¢ù„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **‰ΩôÈ¢ùÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆËßíËâ≤ÁöÑ„ÄêÁªèÊµéÁä∂ÂÜµ„ÄëËÆæÂÆö‰∏Ä‰∏™ÂêàÁêÜÁöÑ \`totalBalance\` (ÊÄª‰ΩôÈ¢ù)„ÄÇ‰æãÂ¶ÇÔºåÂØåÊúâÁöÑËßíËâ≤Â∫îËØ•ÊúâÊõ¥È´òÁöÑ‰ΩôÈ¢ùÔºåËÄåÂ≠¶ÁîüÊàñÁªèÊµéÊãÆÊçÆÁöÑËßíËâ≤ÂàôÂ∫îËØ•ÊúâËæÉ‰ΩéÁöÑ‰ΩôÈ¢ù„ÄÇ
2.  **ÂêàÁêÜÊÄß**: Ë¥≠‰π∞ËÆ∞ÂΩïÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•ΩÂíåÁªèÊµéÁä∂ÂÜµ„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™„ÄêÂçï‰∏ÄÁöÑJSONÂØπË±°„Äë„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`{\` ÂºÄÂßãÔºåÂπ∂‰ª• \`}\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞„ÄÇ
    - Ê†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    {
      "totalBalance": 12345.67, // (ËøôÊòØ‰∏Ä‰∏™Á§∫‰æãÊï∞Â≠óÔºå‰Ω†ÂøÖÈ°ªÊ†πÊçÆËßíËâ≤ÁöÑÁªèÊµéÁä∂ÂÜµÁîüÊàê‰∏Ä‰∏™ÂÖ®Êñ∞ÁöÑ„ÄÅÂêàÁêÜÁöÑ‰ΩôÈ¢ùÔºÅ)
      "purchases": [
        {
          "itemName": "‰∏Ä‰∏™ÂÖ∑‰Ωì„ÄÅÁîüÂä®ÁöÑÂïÜÂìÅÂêçÁß∞",
          "price": 128.80,
          "status": "Â∑≤Á≠æÊî∂",
          "reason": "ËøôÊòØËßíËâ≤Ë¥≠‰π∞Ëøô‰ª∂ÂïÜÂìÅÁöÑÂÜÖÂøÉÁã¨ÁôΩÊàñÁêÜÁî±ÔºåÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚ÄùÊù•ÂÜô„ÄÇ",
          "image_prompt": "‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøôÂº†ÂïÜÂìÅÂõæÁâáÁöÑ„ÄÅËØ¶ÁªÜÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫ realistic product photo, high quality, on a clean white background"
        }
      ]
    }
    \`\`\`
    - **purchases**: ‰∏Ä‰∏™ÂåÖÂê´12Âà∞15‰∏™ÂïÜÂìÅÂØπË±°ÁöÑÊï∞ÁªÑ„ÄÇ
    - **status (ËÆ¢ÂçïÁä∂ÊÄÅ)**: Âè™ËÉΩ‰ªé "Â∑≤Á≠æÊî∂", "ÂæÖÂèëË¥ß", "ËøêËæì‰∏≠", "ÂæÖËØÑ‰ª∑" ‰∏≠ÈÄâÊã©„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext} 
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêÂåÖÂê´ÊÄª‰ΩôÈ¢ùÂíåË¥≠‰π∞ËÆ∞ÂΩïÁöÑJSONÂØπË±°„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊ∑òÂÆùË¥≠‰π∞ËÆ∞ÂΩïÂíå‰ΩôÈ¢ù„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÂØπË±°„ÄÇ");
      const simulatedTaobaoData = JSON.parse(jsonMatch[0]);


      if (!simulatedTaobaoData.purchases) {
        simulatedTaobaoData.purchases = [];
      }

      chat.simulatedTaobaoHistory = simulatedTaobaoData;
      await db.chats.put(chat);

      await renderCharTaobao();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊ∑òÂÆùËÆ∞ÂΩïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêË¥≠Áâ©ËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


 
  function openCharWallet() {
    renderCharWallet();
    switchToCharScreen('char-wallet-screen');
  }


  async function renderCharWallet() {
    const contentEl = document.getElementById('char-wallet-content');
    contentEl.innerHTML = '';
    
    // Ëé∑ÂèñÂΩìÂâçËßíËâ≤‰ø°ÊÅØ
    const char = state.chats[activeCharacterId];
    const history = char.simulatedTaobaoHistory || {};
    const purchases = history.purchases || [];
    const totalBalance = history.totalBalance || 0;

    // 1. ÊòæÁ§∫Ë¥¶Êà∑‰ΩôÈ¢ùÂç°Áâá
    const summaryCard = document.createElement('div');
    summaryCard.style.cssText = `
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    `;
    summaryCard.innerHTML = `
        <p style="color: #8a8a8a; margin: 0 0 10px 0;">Ë¥¶Êà∑‰ΩôÈ¢ù</p>
        <p style="font-size: 32px; font-weight: 600; color: #1f1f1f; margin: 0;">¬•${totalBalance.toFixed(2)}</p>
    `;
    contentEl.appendChild(summaryCard);

    // 2. ÊòæÁ§∫‰∫≤Â±ûÂç° (‰øÆÂ§çÂêçÂ≠ó + Â¢ûÂä†Ëß£Áªë)
    try {
        const myWallet = await db.userWallet.get('main');
        const kinshipCard = myWallet?.kinshipCards?.find(c => c.chatId === activeCharacterId);

        if (kinshipCard) {
            // „Äê‰øÆÂ§çÂêçÂ≠óÈÄªËæë„Äë‰ºòÂÖà‰ΩøÁî®ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑÊòµÁß∞ÔºåÂÖ∂Ê¨°ÊòØÂä®ÊÄÅÊòµÁß∞ÔºåÊúÄÂêéÊòØ‚ÄúÊàë‚Äù
            const myNicknameInChat = char.settings.myNickname || state.qzoneSettings.nickname || 'Êàë';

            const cardDiv = document.createElement('div');
            // Ê†∑ÂºèÔºöÁ∫¢Ëâ≤ËÉåÊôØÂç°ÁâáÔºåÂ¢ûÂä† relative ÂÆö‰Ωç‰ª•‰æøÊîæÁΩÆËß£ÁªëÊåâÈíÆ
            cardDiv.style.cssText = `
                background: linear-gradient(135deg, #ff5252, #ff1744); 
                color: white; 
                padding: 15px; 
                border-radius: 12px; 
                margin-bottom: 20px; 
                box-shadow: 0 4px 10px rgba(255,82,82,0.3); 
                display: flex; 
                flex-direction: column; 
                gap: 5px;
                position: relative; 
            `;
            
            const remaining = kinshipCard.limit - (kinshipCard.spent || 0);
            
            cardDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:14px; opacity:0.9; font-weight:500;">${myNicknameInChat} Ëµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°</div>
                    <div style="font-size:12px; opacity:0.8;">ÊîØ‰ªòÂÆù</div>
                </div>
                <div style="font-size:28px; font-weight:bold; margin:10px 0; font-family: 'DIN Alternate', sans-serif;">¬• ${remaining.toFixed(2)}</div>
                <div style="font-size:12px; opacity:0.8; display:flex; justify-content:space-between;">
                    <span>Êú¨ÊúàÂèØÁî®È¢ùÂ∫¶</span>
                    <span>ÊÄªÈ¢ù ¬•${kinshipCard.limit}</span>
                </div>
                
                <!-- Ëß£ÁªëÊåâÈíÆ -->
                <button class="unbind-kinship-btn" data-chat-id="${activeCharacterId}" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: rgba(255,255,255,0.2);
                    border: 1px solid rgba(255,255,255,0.4);
                    color: white;
                    font-size: 11px;
                    padding: 2px 8px;
                    border-radius: 10px;
                    cursor: pointer;
                    backdrop-filter: blur(2px);
                ">Ëß£Áªë</button>
            `;
            contentEl.appendChild(cardDiv);
        }
    } catch (e) {
        console.error("Ê∏≤Êüì‰∫≤Â±ûÂç°Â§±Ë¥•:", e);
    }

    // 3. ÊòæÁ§∫ÊúÄËøëÊîØÂá∫
    const detailsTitle = document.createElement('h3');
    detailsTitle.textContent = 'ÊúÄËøëÊîØÂá∫';
    detailsTitle.style.cssText = `font-size: 16px; color: #555; margin-bottom: 10px;`;
    contentEl.appendChild(detailsTitle);

    if (purchases.length === 0) {
      contentEl.innerHTML += '<p style="text-align:center; color: var(--text-secondary);">ÊöÇÊó†ÊîØÂá∫ËÆ∞ÂΩï„ÄÇ</p>';
    } else {
        purchases.forEach(item => {
          const itemEl = document.createElement('div');
          itemEl.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 0;
                border-bottom: 1px solid #f0f0f0;
            `;
          itemEl.innerHTML = `
                <div>
                    <p style="font-weight: 500; margin: 0 0 4px 0;">${item.itemName}</p>
                    <p style="font-size: 12px; color: #8a8a8a; margin: 0;">${item.status}</p>
                </div>
                <div style="font-weight: 600; font-size: 16px; color: #ff5722;">- ¬•${(item.price || 0).toFixed(2)}</div>
            `;
          contentEl.appendChild(itemEl);
        });
    }
}




 
  async function handleGenerateSimulatedMemos() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂàÜ‰∫´TAÁöÑÂ§áÂøòÂΩï...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }
    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê12Âà∞20Êù°„ÄëTAÊúÄËøëÂèØËÉΩ‰ºöÂÜôÂú®ÊâãÊú∫Â§áÂøòÂΩïÈáåÁöÑÂÜÖÂÆπ„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: Â§áÂøòÂΩïÂÜÖÂÆπÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇÂèØ‰ª•ÊòØË¥≠Áâ©Ê∏ÖÂçï„ÄÅÂæÖÂäû‰∫ãÈ°π„ÄÅÁÅµÊÑüÁâáÊÆµ„ÄÅ‰∏Ä‰∫õÈöèÁ¨îÂíåÊÑüÊÇü„ÄÅËçâÁ®øÁ≠â„ÄÇ
2.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÊù°Â§áÂøòÂΩïÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "title": "Â§áÂøòÂΩïÁöÑÊ†áÈ¢òÔºå‰æãÂ¶ÇÔºöË¥≠Áâ©Ê∏ÖÂçï Êàñ Âë®Êú´ËÆ°Âàí",
        "content": "Â§áÂøòÂΩïÁöÑËØ¶ÁªÜÂÜÖÂÆπÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\n„ÄÇ"
      }
    ]
    \`\`\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- ** ‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ**:${userPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑÂ§áÂøòÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÂ§áÂøòÂΩïÂÜÖÂÆπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
          
          })
        });


      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        const errorMessage = errorData?.error?.message || response.statusText;
        throw new Error(`API ÈîôËØØ: ${response.status} - ${errorMessage}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedMemos;
      try {
        simulatedMemos = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      if (!Array.isArray(simulatedMemos)) {
        throw new Error(`AIËøîÂõûÁöÑÊï∞ÊçÆ‰∏çÊòØ‰∏Ä‰∏™Êï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${JSON.stringify(simulatedMemos)}`);
      }

      chat.memos = simulatedMemos.map(memo => ({
        id: Date.now() + Math.random(),
        title: memo.title,
        content: memo.content
      }));

      await db.chats.put(chat);
      await renderCharMemoList();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÂ§áÂøòÂΩïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂ§áÂøòÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

 
  async function handleGenerateAmapHistory() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÁîüÊàê‚Äú${chat.name}‚ÄùÁöÑÂá∫Ë°åË∂≥Ëøπ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');
    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫„Äê12Âà∞20Êù°„ÄëTAÊúÄËøëÁöÑ‚ÄúÈ´òÂæ∑Âú∞Âõæ‚ÄùÂá∫Ë°åË∂≥Ëøπ„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**:
    -   ‰ªäÂ§©ÁöÑÊó•ÊúüÊòØ **${new Date().toISOString()}**„ÄÇ
    -   ‰Ω†ÁîüÊàêÁöÑ„ÄêÊâÄÊúâ„ÄëË∂≥ËøπÁöÑ \`timestamp\` Â≠óÊÆµÔºå„ÄêÂøÖÈ°ª„ÄëÊòØ‰ªäÂ§©Êàñ‰ªäÂ§©‰ª•ÂâçÁöÑÊó•Êúü„ÄÇ
    -   „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁîüÊàê‰ªª‰ΩïÊú™Êù•ÁöÑÊó•ÊúüÔºÅ
    -   ËØ∑ÁîüÊàê‰∏Ä‰∏™ÁúãËµ∑Êù•ÂÉèÊòØËøáÂéªÂá†Âë®ÂÜÖÁöÑ„ÄÅÊó∂Èó¥„Äê‰ªéÊñ∞Âà∞Êóß„ÄëÊéíÂàóÁöÑË∂≥ËøπÂàóË°®„ÄÇ
2.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: Ë∂≥ËøπÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
3.  **Â§öÊ†∑ÊÄß**: Âú∞ÁÇπÁ±ªÂûãË¶Å‰∏∞ÂØåÔºåÂèØ‰ª•ÂåÖÊã¨È§êÂéÖ„ÄÅÂïÜÂú∫„ÄÅÂÖ¨Âõ≠„ÄÅÂÖ¨Âè∏„ÄÅÊúãÂèãÂÆ∂Á≠â„ÄÇ
4.  **„ÄêÊ†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÊù°Ë∂≥ËøπÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "locationName": "‰∏Ä‰∏™ÂÖ∑‰Ωì„ÄÅÁîüÂä®ÁöÑÂú∞ÁÇπÂêçÁß∞",
        "address": "‰∏Ä‰∏™ËôöÊûÑ‰ΩÜÁúãËµ∑Êù•ÂæàÁúüÂÆûÁöÑËØ¶ÁªÜÂú∞ÂùÄ",
        "comment": "ËøôÊòØËßíËâ≤ÂØπËøôÊ¨°Âá∫Ë°åÊàñËøô‰∏™Âú∞ÁÇπÁöÑÂÜÖÂøÉÁã¨ÁôΩÊàñËØÑËÆ∫ÔºåÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚ÄùÊù•ÂÜô„ÄÇ",
        "image_prompt": "(ÂèØÈÄâ)‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøôÂº†Âú∞ÁÇπÁÖßÁâáÁöÑ„ÄÅËØ¶ÁªÜÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫ realistic photo, high quality",
        "timestamp": "Á¨¶Âêà ISO 8601 Ê†ºÂºèÁöÑÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤ (‰æãÂ¶Ç: '2025-09-25T18:30:00Z')"
      }
    ]
    \`\`\`
    - **ÈáçË¶Å**: Â§ßÁ∫¶Êúâ„Äê‰∏âÂàÜ‰πã‰∏Ä„ÄëÁöÑË∂≥ËøπÈúÄË¶ÅÂåÖÂê´ \`image_prompt\` Â≠óÊÆµÊù•ÁîüÊàê‰∏ÄÂº†ÁÖßÁâá„ÄÇ
    - **ÂõæÁâá**: image_prompt ÁîüÊàêÁöÑÂõæÁâá„ÄêÁªùÂØπÁ¶ÅÊ≠¢ÂåÖÂê´Áúü‰∫∫„Äë„ÄÇÂ¶ÇÊûúÂú∞ÁÇπÊòØÂÆ§ÂÜÖÔºåÂèØ‰ª•ÁîüÊàêÁ©∫Êó†‰∏Ä‰∫∫ÁöÑÂú∫ÊôØÔºõÂ¶ÇÊûúÊòØÂÆ§Â§ñÔºåÂèØ‰ª•Âè™ÊúâÈ£éÊôØÊàñÂª∫Á≠ë„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑË∂≥ËøπËÆ∞ÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÈ´òÂæ∑Âú∞ÂõæË∂≥Ëøπ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
           
          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);


      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch || !jsonMatch[0]) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const cleanedJsonString = jsonMatch[0];
      let simulatedAmapData;
      try {
        simulatedAmapData = JSON.parse(cleanedJsonString);
      } catch (e) {
        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


      chat.simulatedAmapHistory = simulatedAmapData;
      await db.chats.put(chat);

      await renderCharAmap();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüË∂≥ËøπÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêË∂≥ËøπÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  function renderCharAmap() {
    const listEl = document.getElementById('char-amap-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const history = char.simulatedAmapHistory || [];

    if (history.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÁïô‰∏ã‰ªª‰ΩïË∂≥ËøπÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õËÆ∞ÂΩïÂêßÔºÅ</p>';
      return;
    }


    history.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-amap-item';

      let photoHtml = '';
      if (item.image_prompt) {
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
        photoHtml = `<div class="amap-item-photo" style="background-image: url('${imageUrl}')" data-comment="${item.comment}"></div>`;
      }

      // ‰ΩøÁî®Êàë‰ª¨‰πãÂâçÂàõÂª∫ÁöÑ formatTimeAgo ÂáΩÊï∞Êù•Ê†ºÂºèÂåñÊó∂Èó¥
      const timeAgo = item.timestamp ? formatTimeAgo(new Date(item.timestamp).getTime()) : 'Êüê‰∏™Êó∂Èó¥';

      itemEl.innerHTML = `
                    <div class="amap-item-header">
                        <div class="amap-item-icon">üìç</div>
                        <div class="amap-item-info">
                            <div class="amap-item-title">${item.locationName}</div>
                            <div class="amap-item-address">${item.address}</div>
                        </div>
                    </div>
                    <div class="amap-item-body">
                        <div class="amap-item-comment">${item.comment.replace(/\n/g, '<br>')}</div>
                        ${photoHtml}
                    </div>
                    <div class="amap-item-footer">${timeAgo}</div>
                `;
      listEl.appendChild(itemEl);
    });

  }


 
  async function handleGenerateAppUsage() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂàÜÊûê‚Äú${chat.name}‚ÄùÁöÑÊâãÊú∫‰ΩøÁî®‰π†ÊÉØ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');
    const summary3Hours = generateSummaryForTimeframe(chat, 3, 'hours');
    const summary6Hours = generateSummaryForTimeframe(chat, 6, 'hours');
    const summary9Hours = generateSummaryForTimeframe(chat, 9, 'hours');
    const summaryToday = generateSummaryForTimeframe(chat, 1, 'days');
    const summary3Days = generateSummaryForTimeframe(chat, 3, 'days');
    const summary7Days = generateSummaryForTimeframe(chat, 7, 'days');

    let multiLayeredSummaryContext = '';
    if (summary3Hours || summary6Hours || summary9Hours || summaryToday || summary3Days || summary7Days) {
      multiLayeredSummaryContext += `\n# Êô∫ËÉΩÊÄªÁªì (Âü∫‰∫é‰∏çÂêåÊó∂Èó¥Áª¥Â∫¶ÁöÑÂØπËØùÂõûÈ°æ)\n`;
      if (summary3Hours) multiLayeredSummaryContext += summary3Hours;
      if (summary6Hours) multiLayeredSummaryContext += summary6Hours;
      if (summary9Hours) multiLayeredSummaryContext += summary9Hours;
      if (summary3Hours || summary6Hours || summary9Hours) multiLayeredSummaryContext += '\n';
      if (summaryToday) multiLayeredSummaryContext += summaryToday;
      if (summary3Days) multiLayeredSummaryContext += summary3Days;
      if (summary7Days) multiLayeredSummaryContext += summary7Days;
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁîüÊ¥ªÊ®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåËôöÊûÑÂá∫TAÊúÄËøë‰∏ÄÂ§©ÁöÑ„ÄêÊâãÊú∫AppÂ±èÂπï‰ΩøÁî®Êó∂Èó¥„ÄëËÆ∞ÂΩïÔºåÊÄªÂÖ±Á∫¶20Êù°„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂ§öÊ†∑ÊÄß**: ÁîüÊàêÁöÑAppÂàóË°®„Äê‰∏çÂøÖÂ±ÄÈôê‰∫é„ÄëCphone‰∏ªÂ±èÂπï‰∏äÂ∑≤ÊúâÁöÑApp„ÄÇ‰Ω†ÂèØ‰ª•Ëá™Áî±Âú∞ËôöÊûÑTAÂèØËÉΩ‰ΩøÁî®ÁöÑÂÖ∂‰ªñAppÔºå‰æãÂ¶Ç Instagram, Twitter, ÂêÑÁßçÊ∏∏Êàè (Â¶ÇÔºöÂéüÁ•û, ÁéãËÄÖËç£ËÄÄ), ËßÜÈ¢ëApp (Â¶ÇÔºöÊäñÈü≥, YouTube), Â≠¶‰π†ÊàñÂ∑•‰ΩúËΩØ‰ª∂Á≠âÔºåËøôËÉΩÊõ¥Â•ΩÂú∞‰ΩìÁé∞ËßíËâ≤ÁöÑÈöêËóèÂÖ¥Ë∂£ÂíåÁîüÊ¥ª‰π†ÊÉØ„ÄÇ
2.  **ÂêàÁêÜÊÄß**: ‰ΩøÁî®Êó∂ÈïøÂíåAppÁ±ªÂûãÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•Ω„ÄÅËÅå‰∏öÂíåÁîüÊ¥ªÁéØÂ¢É„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏Ä‰∏™AppÁöÑ‰ΩøÁî®ËÆ∞ÂΩïÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "appName": "AppÁöÑÂêçÁß∞ (‰æãÂ¶Ç: ÂæÆ‰ø°, ÂæÆÂçö, ÂéüÁ•û)",
        "usageTimeMinutes": 125,
        "category": "AppÁöÑÂàÜÁ±ª (‰æãÂ¶Ç: Á§æ‰∫§, Ê∏∏Êàè, ÂΩ±Èü≥, Â∑•ÂÖ∑, ÈòÖËØª, Ë¥≠Áâ©)",
        "image_prompt": "‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËøô‰∏™App„ÄêÂõæÊ†á„ÄëÁöÑ„ÄÅÁÆÄÊ¥ÅÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇÈ£éÊ†ºÂøÖÈ°ªÊòØ modern app icon, flat design, simple, clean background"
      }
    ]
    \`\`\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
${multiLayeredSummaryContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÂºÄÂßãÁîüÊàêËøôÁªÑApp‰ΩøÁî®ËÆ∞ÂΩï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑApp‰ΩøÁî®ËÆ∞ÂΩï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9
            // response_format: { "type": "json_object" } <-- Ê≠§Ë°åÂ∑≤Ë¢´Âà†Èô§
          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');

      const simulatedUsageData = JSON.parse(cleanedJson);

      chat.simulatedAppUsage = simulatedUsageData;
      await db.chats.put(chat);

      await renderCharAppUsage();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüApp‰ΩøÁî®ËÆ∞ÂΩïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêËÆ∞ÂΩïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

  function renderCharAppUsage() {
    const listEl = document.getElementById('char-usage-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const usageData = (char.simulatedAppUsage || []).sort((a, b) => b.usageTimeMinutes - a.usageTimeMinutes);

    if (usageData.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°Êúâ‰ªª‰Ωï‰ΩøÁî®ËÆ∞ÂΩïÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÂêßÔºÅ</p>';
      return;
    }

    usageData.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-usage-item';

      const hours = Math.floor(item.usageTimeMinutes / 60);
      const minutes = item.usageTimeMinutes % 60;
      let timeString = '';
      if (hours > 0) timeString += `${hours}Â∞èÊó∂`;
      if (minutes > 0) timeString += `${minutes}ÂàÜÈíü`;
      if (!timeString) timeString = 'Â∞è‰∫é1ÂàÜÈíü';

      const prompt = item.image_prompt || `modern app icon for ${item.appName}, flat design, simple`;

      const iconUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;


      itemEl.innerHTML = `
                    <img src="${iconUrl}" class="usage-item-icon">
                    <div class="usage-item-info">
                        <div class="usage-item-name">${item.appName}</div>
                        <div class="usage-item-category">${item.category}</div>
                    </div>
                    <div class="usage-item-time">${timeString}</div>
                `;
      listEl.appendChild(itemEl);
    });
  }


async function handleGenerateSimulatedBilibili() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÁªìÂêà‰∏ñÁïåËßÇ‰∏é‰∫∫ËÆæÔºåÂàÜÊûê‚Äú${chat.name}‚ÄùÁöÑBÁ´ôÂÖ¥Ë∂£...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
        return;
    }

    // 1. ÂáÜÂ§á‰∏ä‰∏ãÊñá
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;
    
    // 2. ÂáÜÂ§áËÆ∞ÂøÜÂíå‰∏ñÁïåËßÇ
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    
    // 3. ÂáÜÂ§á‰∏ñÁïå‰π¶
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : 'Êó†';

    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');
 
    const userPersona = chat.settings.myPersona || '(Êú™ËÆæÁΩÆ)';
 
    // 4. ÊûÑÂª∫ PromptÔºöÊ†∏ÂøÉÊîπÂèòÊòØËÆ© AI ÁîüÊàêÂÖ≥ÈîÆËØçÔºåËÄå‰∏çÊòØÂÅáÊï∞ÊçÆ
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁî®Êà∑ÁîªÂÉèÂàÜÊûêÂ∏à„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÊ†πÊçÆTAÁöÑ‰∫∫ËÆæ„ÄÅÊâÄÂ§ÑÁöÑ‰∏ñÁïåËßÇ„ÄÅÈïøÊúüËÆ∞ÂøÜ„ÄÅ‰ª•Âèä‰∏éÁî®Êà∑Ôºà${userDisplayNameForAI}ÔºâÁöÑÂÖ≥Á≥ªÔºå**Êé®ÊµãTAÁé∞Âú®ÊúÄÊÉ≥Âú® Bilibili (BÁ´ô) ‰∏äÊêúÁ¥¢ÊàñËßÇÁúãÁöÑËßÜÈ¢ëÂÖ≥ÈîÆËØç**„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **Ê∑±Â∫¶‰∫∫ËÆæÁªëÂÆö**: ÂÖ≥ÈîÆËØçÂøÖÈ°ªÁ¥ßÊâ£ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÅå‰∏ö„ÄÅÁà±Â•Ω‰ª•Âèä**‰∏ñÁïåËßÇËÆæÂÆö**„ÄÇ
    - ‰æãÂ¶ÇÔºöÂ¶ÇÊûú‰∏ñÁïå‰π¶ÈáåËÆæÂÆö‰∫Ü‚ÄúÈ≠îÊ≥ï‚ÄùÔºåËßíËâ≤ÂèØËÉΩ‰ºöÊêú‚ÄúÁÅ´ÁêÉÊúØÊïôÂ≠¶‚ÄùÔºõÂ¶ÇÊûúÊòØ‚ÄúÊú´‰∏ñ‚ÄùÔºåÂèØËÉΩ‰ºöÊêú‚ÄúÁîüÂ≠òÊåáÂçó‚Äù„ÄÇ
2.  **ÂÖ≥Á≥ªÂØºÂêë**: Â¶ÇÊûúÁî®Êà∑‰∫∫ËÆæÊòØ‰Ω†ÂñúÊ¨¢ÁöÑ‰∫∫Ôºå‰Ω†ÂèØËÉΩ‰ºöÊêú‚ÄúÁªôÂñúÊ¨¢ÁöÑ‰∫∫ÈÄÅ‰ªÄ‰πàÁ§ºÁâ©‚ÄùÔºõÂ¶ÇÊûúÊòØÊ≠ªÂØπÂ§¥ÔºåÂèØËÉΩ‰ºöÊêú‚ÄúÂ¶Ç‰Ωï‰ºòÈõÖÂú∞ÊÄº‰∫∫‚Äù„ÄÇÂøÖÈ°ªÈÄªËæëËá™Ê¥Ω„ÄÇ
3.  **Â§öÊ†∑ÊÄß**: ËØ∑ÁîüÊàê **10Âà∞12‰∏™** ÂÖ∑‰ΩìÁöÑÊêúÁ¥¢ÂÖ≥ÈîÆËØç„ÄÇ
4.  **ÂÖ∑‰ΩìÊÄß**: ÂÖ≥ÈîÆËØçÊúÄÂ•ΩÂÖ∑‰Ωì‰∏ÄÁÇπ„ÄÇ
5.  **Ê†ºÂºèÈìÅÂæã**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™**Â≠óÁ¨¶‰∏≤** (Âç≥ÊêúÁ¥¢ÂÖ≥ÈîÆËØç)„ÄÇ
    - Á§∫‰æã: \`["ÂÖ≥ÈîÆËØç1", "ÂÖ≥ÈîÆËØç2", "ÂÖ≥ÈîÆËØç3"...]\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑËØ¶ÁªÜ‰∏ä‰∏ãÊñá
- **ËßíËâ≤‰∫∫ËÆæ**: ${chat.settings.aiPersona}
- **Áî®Êà∑(${userDisplayNameForAI})ÁöÑ‰∫∫ËÆæ**: ${userPersona} 
- **ÈïøÊúüËÆ∞ÂøÜ**: 
${longTermMemoryContext}
${worldBookContext} 
- **ÊúÄËøëÂØπËØù**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁªìÂêà‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºåÁîüÊàêËøôÁªÑÊêúÁ¥¢ÂÖ≥ÈîÆËØç„ÄÇ`;

    try {
        const messagesForApi = [{ role: 'user', content: "ËØ∑ÁîüÊàêBÁ´ôÊêúÁ¥¢ÂÖ≥ÈîÆËØçÂàóË°®„ÄÇ" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

        const response = isGemini ?
            await fetch(geminiConfig.url, geminiConfig.data) :
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                    temperature: state.globalSettings.apiTemperature || 1.0,
                })
            });

        if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        const keywords = JSON.parse(cleanedJson);

        if (!Array.isArray(keywords)) throw new Error("AIÊ≤°ÊúâËøîÂõûÊï∞ÁªÑÊ†ºÂºèÁöÑÂÖ≥ÈîÆËØç„ÄÇ");

        await showCustomAlert("ËØ∑Á®çÂÄô...", `AIÂ∑≤ÁªìÂêà‰∏ñÁïåËßÇÁîüÊàê ${keywords.length} ‰∏™ÂÖ≥ÈîÆËØçÔºåÊ≠£Âú®ÈÄê‰∏™ÊêúÁ¥¢BÁ´ôËßÜÈ¢ë (‰∏∫Èò≤Â∞ÅÁ¶ÅÔºåÈÄüÂ∫¶‰ºöÁ®çÊÖ¢)...`);

        // ÂÆö‰πâÂª∂Êó∂ÂáΩÊï∞ÔºåÈò≤Ê≠¢ËØ∑Ê±ÇÂ§™Âø´Ë¢´BÁ´ôÊé•Âè£Â∞ÅIP
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        const results = [];
        
        // 5. ÈÅçÂéÜÂÖ≥ÈîÆËØçÔºåË∞ÉÁî®ÁúüÂÆûÁöÑÊêúÁ¥¢Êé•Âè£
        for (const [index, keyword] of keywords.entries()) {
            let retryCount = 0; // ÂΩìÂâçÂÖ≥ÈîÆËØçÁöÑÈáçËØïÊ¨°Êï∞
            let success = false; // ÊòØÂê¶ÊàêÂäüÊ†áËÆ∞
            const maxRetries = 5; // ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞ÔºåÈò≤Ê≠¢Ê≠ªÂæ™ÁéØ

            // ‰ΩøÁî® while Âæ™ÁéØÔºåÁõ¥Âà∞ÊàêÂäüÊàñË∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞
            while (!success && retryCount < maxRetries) {
                try {
                    // Â¶ÇÊûúÊòØÈáçËØïÔºåÊâìÂç∞Êó•ÂøóÊèêÁ§∫
                    const retryMsg = retryCount > 0 ? ` (Á¨¨ ${retryCount} Ê¨°ÈáçËØï)` : "";
                    console.log(`[BÁ´ôÊêúÁ¥¢ ${index + 1}/${keywords.length}] Ê≠£Âú®ÊêúÁ¥¢: ${keyword}${retryMsg}`);
                    
                    // ‰ΩøÁî®‰Ω†ËÑöÊú¨ÈáåÂéüÊú¨‰ΩøÁî®ÁöÑÊé•Âè£ÔºåÁªèËøáCORS‰ª£ÁêÜ
                    const targetUrl = `https://api.52vmy.cn/api/query/bilibili/video?msg=${encodeURIComponent(keyword)}&n=1`;
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                    
                    const res = await fetch(proxyUrl);
                    
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const text = await res.text();
                    
                    // --- ‰øÆÊîπÈáçÁÇπÂºÄÂßãÔºöÊ£ÄÊµãÈôêÊµÅÂπ∂ÈáçËØï ---
                    if (text.includes("ËÆøÈóÆËøáÂø´") || text.includes("È¢ëÁπÅ") || text.includes("Too Many Requests")) {
                         console.warn(`‚ö†Ô∏è ÂÖ≥ÈîÆËØç "${keyword}" Ëß¶ÂèëÈôêÊµÅÔºåÁ≠âÂæÖÂÜ∑Âç¥ÂêéÈáçËØï...`);
                         
                         // Âä®ÊÄÅÁ≠âÂæÖÊó∂Èó¥ÔºöÂü∫Á°ÄÁ≠âÂæÖ 5Áßí + ÊØèÊ¨°ÈáçËØïÂ¢ûÂä† 2Áßí (5s, 7s, 9s...)
                         await delay(5000 + (retryCount * 2000)); 
                         
                         retryCount++; // Â¢ûÂä†ÈáçËØïËÆ°Êï∞
                         continue; // Ë∑≥ËøáÊú¨Ê¨° while Âæ™ÁéØÁöÑÂâ©‰ΩôÈÉ®ÂàÜÔºåÈáçÊñ∞ÂèëËµ∑ËØ∑Ê±Ç
                    }
                    // --- ‰øÆÊîπÈáçÁÇπÁªìÊùü ---

                    let json;
                    try { 
                        json = JSON.parse(text); 
                    } catch(e) { 
                        // Â¶ÇÊûúJSONËß£ÊûêÂ§±Ë¥•ÔºàÂèØËÉΩÊòØÊé•Âè£Êä•ÈîôËøîÂõû‰∫ÜHTMLÔºâÔºå‰πüËßÜ‰∏∫Â§±Ë¥•ËøõË°åÈáçËØï
                        console.warn(`JSONËß£ÊûêÂ§±Ë¥•ÔºåÂáÜÂ§áÈáçËØï: ${keyword}`);
                        retryCount++;
                        await delay(3000);
                        continue; 
                    }
                    
                    // Êé•Âè£ËøîÂõûÊ†ºÂºèÂÖºÂÆπÂ§ÑÁêÜ
                    let videoData = null;
                    if (json.data && Array.isArray(json.data) && json.data.length > 0) {
                        videoData = json.data[0]; 
                    } else if (json.code === 200 && json.data) {
                        videoData = Array.isArray(json.data) ? json.data[0] : json.data;
                    } else if (json.title) {
                         videoData = json;
                    }

                    if (videoData && videoData.title && videoData.url) {
                        results.push(videoData);
                    }
                    
                    // Â¶ÇÊûú‰ª£Á†ÅË∑ëÂà∞ËøôÈáåÔºåËØ¥ÊòéÊ≤°ÊúâËß¶ÂèëÈôêÊµÅ‰∏îÊ≤°ÊúâÊä•ÈîôÔºåÊ†áËÆ∞ÊàêÂäü‰ª•ÈÄÄÂá∫ while Âæ™ÁéØ
                    success = true; 

                } catch (e) {
                    console.warn(`ÊêúÁ¥¢ÂÖ≥ÈîÆËØç "${keyword}" ÂèëÁîüÈîôËØØ:`, e);
                    // ÁΩëÁªúÈîôËØØ‰πüËøõË°åÈáçËØï
                    retryCount++;
                    await delay(3000);
                }
            }

            // Â¶ÇÊûúË∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞‰ªçÁÑ∂Â§±Ë¥•
            if (!success) {
                console.error(`‚ùå ÂÖ≥ÈîÆËØç "${keyword}" ÈáçËØï ${maxRetries} Ê¨°Âêé‰ªçÁÑ∂Â§±Ë¥•ÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`);
            }

            // ÂÖ≥ÈîÆËØç‰πãÈó¥ÁöÑÊ≠£Â∏∏Èó¥Èöî (Âª∫ËÆÆÁ®çÂæÆË∞ÉÂ§ß‰∏ÄÁÇπÔºåÊØîÂ¶Ç 2000msÔºå‰ª•ÂáèÂ∞ëËß¶ÂèëÈôêÊµÅÁöÑÊ¶ÇÁéá)
            await delay(1500); 
        }

        // 6. ‰øùÂ≠òÁúüÂÆûÊï∞ÊçÆ
        chat.simulatedBilibiliFeed = results;
        await db.chats.put(chat);

        // 7. Ê∏≤ÊüìÁïåÈù¢
        renderCharBilibiliScreen();
        await showCustomAlert("ÂÆåÊàê", `ÊàêÂäü‰∏∫‰Ω†ÁîüÊàê‰∫Ü ${results.length} ‰∏™Á¨¶Âêà ${chat.name} ‰∫∫ËÆæ‰∏é‰∏ñÁïåËßÇÁöÑËßÜÈ¢ëÊé®ËçêÔºÅ`);

    } catch (error) {
        console.error("ÁîüÊàêBÁ´ôÊé®ËçêÂ§±Ë¥•:", error);
        await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊé®ËçêÂÜÖÂÆπ„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
}
function renderCharBilibiliScreen() {
    const listEl = document.getElementById('char-bilibili-list');
    listEl.innerHTML = '';
    
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    
    // ËØªÂèñ‰øùÂ≠òÁöÑÊ®°ÊãüÊï∞ÊçÆ
    const videos = chat.simulatedBilibiliFeed || [];

    if (videos.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">È¶ñÈ°µÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆËé∑Âèñ‰∏™ÊÄßÂåñÊé®ËçêÂêßÔºÅ</p>';
        return;
    }

    videos.forEach(video => {
        const item = document.createElement('div');
        item.className = 'bilibili-item';
        
        // Â§ÑÁêÜÂ∞ÅÈù¢ÂõæÂíå‰ø°ÊÅØ
        // ‰ΩøÁî® img Ê†áÁ≠æÈÖçÂêà no-referrer Êù•ÁªïËøá Safari ÁöÑÈò≤ÁõóÈìæÊ£ÄÊü•
        item.innerHTML = `
            <div class="bili-cover" style="position: relative; overflow: hidden;">
                <img src="${video.img_url || video.pic}" referrerpolicy="no-referrer" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;" onerror="this.style.display='none'">
                <div class="bili-duration" style="position: absolute; z-index: 2;">‚ñ∂</div>
            </div>
            <div class="bili-info">
                <div class="bili-title">${video.title}</div>
                <div class="bili-author">UP: ${video.user || video.author || 'Êú™Áü•UP‰∏ª'}</div>
            </div>
        `;
        
        // ÁÇπÂáªÊí≠Êîæ
        item.onclick = () => playCharBilibiliVideo(video);
        listEl.appendChild(item);
    });
}
  async function handleGenerateSimulatedMusic() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ËØ∑Ê±Ç‚Äú${chat.name}‚ÄùÂàÜ‰∫´TAÁöÑÁßÅ‰∫∫Ê≠åÂçï...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;

    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„ÄãËÆæÂÆö:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');


    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÈü≥‰πêÂìÅÂë≥Ê®°ÊãüÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÂπ∂Ê†πÊçÆÂÖ∂‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑ‰∫íÂä®ÔºåÊåëÈÄâÂá∫„Äê14Âà∞18È¶ñ„ÄëÊúÄËÉΩ‰ª£Ë°®TAÊ≠§ÂàªÂøÉÊÉÖÊàñÂìÅÂë≥ÁöÑÊ≠åÊõ≤„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: Ê≠åÂçïÂøÖÈ°ªÂÆåÂÖ®Á¨¶ÂêàËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅÁà±Â•ΩÂíåÁîüÊ¥ªËÉåÊôØ„ÄÇ
2.  **Â§öÊ†∑ÊÄß**: Ê≠åÊõ≤È£éÊ†ºÂèØ‰ª•Â§öÊ†∑Ôºå‰ΩÜÂøÖÈ°ªÈÄªËæëËá™Ê¥Ω„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™ÂØπË±°Ôºå‰ª£Ë°®‰∏ÄÈ¶ñÊ≠åÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "songName": "Ê≠åÊõ≤ÁöÑÂáÜÁ°ÆÂêçÁß∞",
        "artistName": "Ê≠åÊõ≤ÁöÑÂáÜÁ°ÆËâ∫ÊúØÂÆ∂/Ê≠åÊâãÂêç"
      }
    ]
    \`\`\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
- **‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜ**:
${longTermMemoryContext}
${worldBookContext}
- **‰Ω†ÊúÄËøëÂíå‚Äú${userDisplayNameForAI}‚ÄùÁöÑÂØπËØùÊëòË¶Å**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêËøô‰ªΩÊ≠åÂçï„ÄÇ`;


    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰Ω†ÁöÑËÆæÂÆöÔºåÁîüÊàê‰Ω†ÁöÑÊ≠åÂçï„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);


      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });


      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
      const songPicks = JSON.parse(cleanedJson);

      await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠åÂçïÂ∑≤ÁîüÊàêÔºåÊ≠£Âú®‰ªéÁΩëÁªúËé∑Âèñ ${songPicks.length} È¶ñÊ≠åÊõ≤ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ...`);

      const songDetailPromises = songPicks.map(async (pick) => {
        let searchResults = await searchNeteaseMusic(pick.songName, pick.artistName);
        if (!searchResults || searchResults.length === 0) {
          searchResults = await searchTencentMusic(pick.songName);
        }
        if (searchResults.length > 0) {
          return getPlayableSongDetails(searchResults[0]);
        }
        console.warn(`ÊâÄÊúâÈü≥‰πêÊ∫êÈÉΩÊú™ËÉΩÊâæÂà∞Ê≠åÊõ≤Ôºö‚Äú${pick.songName} - ${pick.artistName}‚Äù`);
        return null;
      });

      const fullSongObjects = (await Promise.all(songDetailPromises)).filter(Boolean);

      chat.simulatedMusicPlaylist = fullSongObjects;
      await db.chats.put(chat);

      await renderCharMusicScreen();

    } catch (error) {
      console.error("ÁîüÊàêÊ®°ÊãüÊ≠åÂçïÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊ≠åÂçïÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }

 
  function renderCharMusicScreen() {
    const listEl = document.getElementById('char-music-list');
    listEl.innerHTML = '';
    if (!activeCharacterId) return;

    const char = state.chats[activeCharacterId];
    const playlist = char.simulatedMusicPlaylist || [];

    if (playlist.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">TAÁöÑÊ≠åÂçïËøòÊòØÁ©∫ÁöÑÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÁîüÊàê‰∏Ä‰∫õÊ≠åÊõ≤ÂêßÔºÅ</p>';
      return;
    }

    playlist.forEach((track, index) => {
      const itemEl = document.createElement('div');
      itemEl.className = 'char-music-item';
      itemEl.innerHTML = `
            <img src="${track.cover}" class="music-item-cover">
            <div class="music-item-info">
                <div class="music-item-name">${track.name}</div>
                <div class="music-item-artist">${track.artist}</div>
            </div>
        `;

      itemEl.addEventListener('click', () => playCharSong(index, playlist));
      listEl.appendChild(itemEl);
    });
  }



  let charPlayerState = {
    currentPlaylist: [],
    currentIndex: -1,
    isPlaying: false,
    playMode: 'order', 
    lrcUpdateInterval: null,
  
    parsedLyrics: [],
    currentLyricIndex: -1
  };

  
  function playCharSong(songIndex, playlist) { 
    const player = document.getElementById('char-audio-player');
    const modal = document.getElementById('char-music-player-modal');

    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();


    charPlayerState.currentPlaylist = playlist; 

    charPlayerState.currentIndex = songIndex; 

    const songObject = playlist[songIndex]; 
    if (!songObject) {
        console.error("playCharSong: Ê≠åÊõ≤Á¥¢ÂºïÊó†ÊïàÊàñÊ≠åÂçï‰∏∫Á©∫„ÄÇ");
        return;
    }

    document.getElementById('char-music-player-title').textContent = songObject.name;
    document.getElementById('char-music-artist').textContent = songObject.artist;
    document.getElementById('char-music-cover').src = songObject.cover;


    charPlayerState.parsedLyrics = parseLRC(songObject.lrcContent || "");
    renderCharLyrics();


    if (songObject.isLocal) {
      const blob = new Blob([songObject.src], {
        type: songObject.fileType || 'audio/mpeg'
      });
      player.src = URL.createObjectURL(blob);
    } else {
      player.src = songObject.src;
    }
    player.play().catch(e => console.error("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:", e));

    player.onloadedmetadata = () => {
      document.getElementById('char-music-total-time').textContent = formatMusicTime(player.duration);
      charPlayerState.lrcUpdateInterval = setInterval(updateCharMusicProgress, 1000);
    };

    modal.classList.add('visible');
  }


function minimizeCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    modal.classList.remove('visible');
  
    document.getElementById('char-music-restore-btn').style.display = 'flex';
}


function restoreCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    modal.classList.add('visible');
    
    document.getElementById('char-music-restore-btn').style.display = 'none';
}


function closeCharMusicPlayer() {
    const modal = document.getElementById('char-music-player-modal');
    const player = document.getElementById('char-audio-player');

    if (charPlayerState.lrcUpdateInterval) clearInterval(charPlayerState.lrcUpdateInterval);
    player.pause();
    // player.src = ''; // Âª∫ËÆÆÊ≥®ÈáäÊéâËøôË°åÔºåÈò≤Ê≠¢‰∏ãÊ¨°ÊâìÂºÄË¶ÅÈáçÊñ∞Âä†ËΩΩÔºåÊàñËÄÖ‰øùÁïôÁúã‰Ω†ÈúÄÊ±Ç
    
    modal.classList.remove('visible');
    charPlayerState.isPlaying = false;
    document.getElementById('char-vinyl-container').classList.remove('spinning');
    
   
    document.getElementById('char-music-restore-btn').style.display = 'none';
}


  function updateCharMusicProgress() {
    const player = document.getElementById('char-audio-player');
    if (!player.duration) return;

    const currentTime = player.currentTime;
    const duration = player.duration;
    document.getElementById('char-music-progress-fill').style.width = `${(currentTime / duration) * 100}%`;
    document.getElementById('char-music-current-time').textContent = formatMusicTime(currentTime);


    updateCharActiveLyric(currentTime);
  }



  function renderCharLyrics() {
    const lyricsContainer = document.getElementById('char-music-lyrics');
    lyricsContainer.innerHTML = ''; 
    charPlayerState.currentLyricIndex = -1;
    
   
    const scrollWrapper = document.createElement('div');
    scrollWrapper.id = 'char-lyrics-scroll-wrapper';
    scrollWrapper.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    lyricsContainer.appendChild(scrollWrapper);

    if (!charPlayerState.parsedLyrics || charPlayerState.parsedLyrics.length === 0) {
        scrollWrapper.innerHTML = '<p>‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™</p>';
        return;
    }
    charPlayerState.parsedLyrics.forEach((line, index) => {
        const p = document.createElement('p');
        p.textContent = line.text;
        p.dataset.index = index;
     
        p.style.margin = '0';
        p.style.padding = '5px 0';
        p.style.color = '#888';
        p.style.transition = 'all 0.3s';
        scrollWrapper.appendChild(p);
    });
}

function updateCharActiveLyric(currentTime) {
    const lyrics = charPlayerState.parsedLyrics;
    if (lyrics.length === 0) return;

    let newLyricIndex = -1;
    for (let i = 0; i < lyrics.length; i++) {
        if (currentTime >= lyrics[i].time) {
            newLyricIndex = i;
        } else {
            break;
        }
    }
    if (newLyricIndex === charPlayerState.currentLyricIndex) return;
    charPlayerState.currentLyricIndex = newLyricIndex;

   
    const wrapper = document.getElementById('char-lyrics-scroll-wrapper');
    if(!wrapper) return; 

    const lines = wrapper.querySelectorAll('p');
    lines.forEach(line => {
        line.classList.remove('active');
        line.style.color = '#888';
        line.style.transform = 'scale(1)';
    });

    if (newLyricIndex > -1) {
        const activeLine = wrapper.querySelector(`p[data-index="${newLyricIndex}"]`);
        if (activeLine) {
            activeLine.classList.add('active');
            activeLine.style.color = '#333';
            activeLine.style.fontWeight = 'bold';
            activeLine.style.transform = 'scale(1.1)';
           
            const containerHeight = document.getElementById('char-music-lyrics').clientHeight;
            const offset = (containerHeight / 2) - activeLine.offsetTop - (activeLine.clientHeight / 2);
            
            wrapper.style.transform = `translateY(${offset}px)`;
        }
    }
}



  function playNextCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    let nextIndex;
    switch (charPlayerState.playMode) {
      case 'random':
        nextIndex = Math.floor(Math.random() * charPlayerState.currentPlaylist.length);
        break;
      case 'single':

        playCharSong(charPlayerState.currentPlaylist[charPlayerState.currentIndex]);
        return;
      case 'order':
      default:
        nextIndex = (charPlayerState.currentIndex + 1) % charPlayerState.currentPlaylist.length;
        break;
    }
    playCharSong(nextIndex, charPlayerState.currentPlaylist);
  }

  function playPrevCharSong() {
    if (charPlayerState.currentPlaylist.length === 0) return;
    const newIndex = (charPlayerState.currentIndex - 1 + charPlayerState.currentPlaylist.length) % charPlayerState.currentPlaylist.length;
    playCharSong(newIndex, charPlayerState.currentPlaylist);
  }

  function changeCharPlayMode() {
    const modes = ['order', 'random', 'single'];
    const currentModeIndex = modes.indexOf(charPlayerState.playMode);
    charPlayerState.playMode = modes[(currentModeIndex + 1) % modes.length];
    document.getElementById('char-music-mode-btn').textContent = {
      'order': 'È°∫Â∫è',
      'random': 'ÈöèÊú∫',
      'single': 'ÂçïÊõ≤'
    } [charPlayerState.playMode];
  }



  function setupCharPlayerControls() {
    const player = document.getElementById('char-audio-player');
    const playBtn = document.getElementById('char-music-play-pause-btn');
    const vinyl = document.getElementById('char-vinyl-container');

    playBtn.addEventListener('click', () => {
      if (player.paused) {
        if (charPlayerState.currentIndex > -1) player.play();
      } else {
        player.pause();
      }
    });

    player.onplay = () => {
      playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
      vinyl.classList.add('spinning');
      charPlayerState.isPlaying = true;
    };
    player.onpause = () => {
      playBtn.innerHTML = `<svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
      vinyl.classList.remove('spinning');
      charPlayerState.isPlaying = false;
    };
    player.onended = () => {
      vinyl.classList.remove('spinning');
      charPlayerState.isPlaying = false;
      playNextCharSong();
    };

    document.getElementById('char-music-prev-btn').addEventListener('click', playPrevCharSong);
    document.getElementById('char-music-next-btn').addEventListener('click', playNextCharSong);
    document.getElementById('char-music-mode-btn').addEventListener('click', changeCharPlayMode);

    document.getElementById('char-music-progress-bar').addEventListener('click', (e) => {
      if (!player.duration) return;
      const bar = e.currentTarget;
      const clickX = e.offsetX;
      player.currentTime = (clickX / bar.clientWidth) * player.duration;
    });
  }

  async function renderDoubanScreen() {
    const listEl = document.getElementById('douban-posts-list');
    listEl.innerHTML = '';

    const posts = await db.doubanPosts.orderBy('timestamp').reverse().toArray();

    if (posts.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºå<br>ÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÊåâÈíÆÔºåÁúãÁúãÂ§ßÂÆ∂ÈÉΩÂú®ËÅä‰ªÄ‰πàÂêßÔºÅ</p>';
      return;
    }

    posts.forEach(post => {
      let avatarUrl;


      const authorChatByOriginalName = post.authorOriginalName ?
        Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorOriginalName) :
        null;

      if (authorChatByOriginalName) {

        avatarUrl = authorChatByOriginalName.settings.aiAvatar;
      } else {

        const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
        if (authorChatByName) {
          avatarUrl = authorChatByName.settings.aiAvatar;
        } else if (post.authorAvatarPrompt) {

          avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
        } else {

          avatarUrl = defaultAvatar;
        }
      }


      const itemEl = document.createElement('div');
      itemEl.className = 'douban-post-item';
      itemEl.onclick = () => openDoubanPostDetail(post.id);

      itemEl.innerHTML = `
            <div class="douban-post-header">
                <img src="${avatarUrl}" class="douban-post-avatar">
                <div class="douban-author-info">
                    <div class="douban-author-name">${post.authorName}</div>
                    <div class="douban-group-name">Êù•Ëá™ ${post.groupName}</div>
                </div>
            </div>
            <div class="douban-post-title">${post.postTitle}</div>
            <div class="douban-post-content">${post.content.replace(/\n/g, '<br>')}</div>
            <div class="douban-post-footer">
                 <div class="douban-post-actions">
                    <span><svg viewBox="0 0 1024 1024"><path d="M170.666667 170.666667h128v682.666666h-128zM426.666667 170.666667h170.666666v682.666666h-170.666666zM725.333333 170.666667h128v682.666666h-128z"></path></svg> ${post.likesCount}</span>
                    <span><svg viewBox="0 0 1024 1024"><path d="M853.333333 85.333333H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333334v512c0 46.933333 38.4 85.333333 85.333334 85.333333h512l170.666667 170.666667V170.666667c0-46.933333-38.4-85.333333-85.333334-85.333334z m-42.666666 554.666667H170.666667V170.666667h640v469.333333zM256 384h512v85.333333H256V384z m0-170.666667h512v85.333334H256v-85.333334z"></path></svg> ${post.commentsCount}</span>
                </div>
                <span class="douban-post-timestamp">${formatTimeAgo(post.timestamp)}</span>
            </div>
        `;
      listEl.appendChild(itemEl);
    });
  }



  async function handleGenerateDoubanPosts() {
    const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];

    if (activeCharacterIds.length === 0) {
      await showCustomAlert("ËØ∑ÂÖàÈÄâÊã©ËßíËâ≤", "ËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúËßíËâ≤ÈÄâÊã©‚ÄùÊåâÈíÆÔºåÈÄâÊã©Ëá≥Â∞ë‰∏Ä‰∏™ÂèÇ‰∏éË±ÜÁì£‰∫íÂä®ÁöÑËßíËâ≤„ÄÇ");
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®‰∏∫ÊÇ®ÈÄâÊã©ÁöÑ ${activeCharacterIds.length} ‰ΩçËßíËâ≤ÁîüÊàêË±ÜÁì£Âä®ÊÄÅ...`);

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
      return;
    }

    const allLinkedBookIds = new Set();
    activeCharacterIds.forEach(charId => {
      const c = state.chats[charId];
      if (c && c.settings.linkedWorldBookIds) {
        c.settings.linkedWorldBookIds.forEach(bookId => allLinkedBookIds.add(bookId));
      }
    });

    let sharedWorldBookContext = '';
    if (allLinkedBookIds.size > 0) {
      sharedWorldBookContext += '\n\n# Áªü‰∏Ä‰∏ñÁïåËßÇËÆæÂÆö (‰ª•‰∏ãËÆæÂÆöÈÄÇÁî®‰∫éÊâÄÊúâÂèÇ‰∏éËßíËâ≤)\n';
      allLinkedBookIds.forEach(bookId => {
        const book = state.worldBooks.find(wb => wb.id === bookId);
        if (book) {
          const enabledEntries = book.content
            .filter(e => e.enabled !== false)
            .map(e => `- ${e.content}`)
            .join('\n');
          if (enabledEntries) {
            sharedWorldBookContext += `\n## Êù•Ëá™„Ää${book.name}„Äã:\n${enabledEntries}`;
          }
        }
      });
    }

    const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'Ë±ÜÁì£ËÆæÂÆö');
    let doubanSettingContext = '';
    let npcCharacters = [];
    if (doubanWorldBook) {
      doubanWorldBook.content.forEach(entry => {
        if (entry.comment.includes('Â∞èÁªÑÈ£éÊ†º')) {
          doubanSettingContext += `\n# Ë±ÜÁì£Á§æÂå∫È£éÊ†ºËÆæÂÆö (Êù•Ëá™‰∏ñÁïå‰π¶)\n${entry.content}`;
        }
        if (entry.comment.includes('NPC‰∫∫ËÆæ')) {
          const lines = entry.content.split('\n');
          lines.forEach(line => {
            const match = line.match(/- \*\*ÊòµÁß∞\*\*:\s*(.*?)\s*\*\*‰∫∫ËÆæ\*\*:\s*(.*)/);
            if (match) {
              npcCharacters.push({
                name: match[1].trim(),
                persona: match[2].trim()
              });
            }
          });
        }
      });
    }

    const userNickname = state.qzoneSettings.nickname || 'Êàë';
    const userPersona = activeCharacterIds.length > 0 && state.chats[activeCharacterIds[0]] ?
      state.chats[activeCharacterIds[0]].settings.myPersona :
      '(Êú™ËÆæÁΩÆ)';

    let charactersContext = '';
    activeCharacterIds.forEach(charId => {
      const c = state.chats[charId];
      if (c) {
        const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'Êó†';
        const recentHistory = c.history.slice(-10).map(msg =>
          `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`
        ).join('\n');

        charactersContext += `
<character>
  <name>${c.name}</name>
  <persona>${c.settings.aiPersona}</persona>
  <memory>${longTermMemory}</memory>
  <recent_dialogue_with_user>${recentHistory}</recent_dialogue_with_user>
</character>
`;
      }
    });
    npcCharacters.forEach(npc => {
      charactersContext += `
<character>
  <name>${npc.name}</name>
  <persona>${npc.persona}</persona>
</character>
`;
    });

    const now = new Date();
    const currentTimeString = now.toLocaleString('zh-CN', {
      dateStyle: 'full',
      timeStyle: 'short'
    });
    const minPosts = state.globalSettings.doubanMinPosts || 12;
    const maxPosts = state.globalSettings.doubanMaxPosts || 20;
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æÂå∫ÂÜÖÂÆπÁîüÊàêÂô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆ‰∏ãÈù¢Êèê‰æõÁöÑ„ÄêÁªü‰∏ÄËßíËâ≤ÂàóË°®„ÄëÔºåËôöÊûÑÂá∫„Äê${minPosts}Âà∞${maxPosts}ÁØá„Äë‰ªñ‰ª¨ÊúÄËøëÂèØËÉΩ‰ºöÂú®ÂêÑÁßçË±ÜÁì£Â∞èÁªÑ‰∏≠ÂèëÂ∏ÉÁöÑÂ∏ñÂ≠êÂíåËØÑËÆ∫„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ÊÑüÁü•„Äë**:
    -   ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊÑèËØÜÂà∞ÂΩìÂâçÊòØ **${currentTimeString}**„ÄÇ
    -   ‰Ω†ÁöÑÂ∏ñÂ≠êÂíåËØÑËÆ∫ÂÜÖÂÆπ„ÄêÂøÖÈ°ª„ÄëËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπ„ÄêÂΩìÂâçÁúüÂÆûÊó∂Èó¥„ÄëÁöÑÊÑüÁü•„ÄÇ
2.  **„ÄêÁ¶ÅÊ≠¢ÊâÆÊºîÁî®Êà∑ (ÊúÄÊúÄÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅÔºÅÔºÅ)„Äë**:
    -   Áî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${userNickname}‚Äù„ÄÇ
    -   ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê authorName Êàñ commenter Â≠óÊÆµ‰∏∫ ‚Äú${userNickname}‚Äù ÁöÑÂ∏ñÂ≠êÊàñËØÑËÆ∫„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ
3.  **„ÄêË∫´‰ªΩ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë**: 
    -   \`authorName\`: ‰Ω†ÂèØ‰ª•‰∏∫‰∏ªË¶ÅËßíËâ≤Ëµ∑‰∏Ä‰∏™Á¨¶ÂêàÊÉÖÊôØÁöÑ„ÄÅ‰∏¥Êó∂ÁöÑ„ÄêÂèëÂ∏ñÊòµÁß∞„ÄëÔºå‰πüÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®‰ªñ‰ª¨ÁöÑÊú¨Âêç„ÄÇ
    -   \`authorOriginalName\`: Â¶ÇÊûúÂèëÂ∏ñËÄÖÊòØ„Äê‰∏ªË¶ÅËßíËâ≤„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ËøôÈáåÂ°´‰∏äTAÂú®ËßíËâ≤ÂàóË°®ÈáåÁöÑ„ÄêÂéüÂßãÂ§áÊ≥®Âêç„ÄëÔºåËøôÊòØÁ®ãÂ∫èÁöÑ‚ÄúË∫´‰ªΩËØÅ‚Äù„ÄÇ
    -   Â¶ÇÊûúÂèëÂ∏ñËÄÖÊòØ„ÄêË∑Ø‰∫∫NPC„ÄëÔºåÂàô„ÄêÁúÅÁï•„Äë\`authorOriginalName\` Â≠óÊÆµ„ÄÇ
4.  **„Äê‰ΩúËÄÖÂπ≥Ë°°„Äë**: Â∏ñÂ≠êÁöÑ‰ΩúËÄÖ„ÄêÂøÖÈ°ª„Äë‰ªé‰∏ãÈù¢ÁöÑ \`<character>\` ÂàóË°®‰∏≠„ÄêÂùáÂåÄÂú∞„ÄÅÂ§öÊ†∑ÂåñÂú∞„ÄëÈÄâÊã©„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÁ°Æ‰øùÂ∏ñÂ≠êÂàóË°®‰∏≠„ÄêËá≥Â∞ëÊúâ 70% ÁöÑÂ∏ñÂ≠êÊòØÁî±Ë∑Ø‰∫∫NPCÂèëÂ∏ÉÁöÑ„ÄëÔºå‰ª•Ëê•ÈÄ†‰∏Ä‰∏™ÁúüÂÆûÁöÑÁ§æÂå∫Ê∞õÂõ¥„ÄÇ
    - "comments": ‰∏Ä‰∏™ÂåÖÂê´„Äê7Âà∞12Êù°„ÄëËØÑËÆ∫ÁöÑÊï∞ÁªÑ„ÄÇËØÑËÆ∫ËÄÖÂèØ‰ª•ÊòØË∑Ø‰∫∫Ôºå‰πüÂèØ‰ª•ÊòØËßíËâ≤ÂàóË°®‰∏≠ÁöÑÂÖ∂‰ªñËßíËâ≤Ôºå‰ª•‰ΩìÁé∞‰∫íÂä®ÊÄß„ÄÇ
5.  **„ÄêËßíËâ≤ÊâÆÊºî„Äë**: Â∏ñÂ≠êÁöÑ‰ΩúËÄÖÂíåÂÜÖÂÆπ„ÄêÂøÖÈ°ª„ÄëÊ∑±Â∫¶ÁªìÂêàËØ•ËßíËâ≤ÁöÑ<persona>, <memory>, Âíå <worldview>„ÄÇ
6.  **„Äê‚ÄúË±ÜÁì£Âë≥‚ÄùÂÜÖÂÆπÈ£éÊ†ºÊåáÂçó„Äë**: Â∏ñÂ≠êÈ£éÊ†ºÂøÖÈ°ªÂ§öÊ†∑Âåñ‰∏îÂÖÖÊª°ÁîüÊ¥ªÊ∞îÊÅØÔºÅ‰Ω†ÈúÄË¶ÅÁîüÊàêÂåÖÊã¨‰ΩÜ‰∏çÈôê‰∫éÔºöÊÉÖÊÑüÊ†ëÊ¥û„ÄÅÁîüÊ¥ªÂêêÊßΩ„ÄÅÂêÉÁìúÂÖ´Âç¶„ÄÅÂÖ¥Ë∂£ÂàÜ‰∫´„ÄÅÊó†Áî®ËâØÂìÅÁ≠âÂêÑÁßçÁ±ªÂûãÁöÑÂ∏ñÂ≠ê„ÄÇ
7.  **„ÄêÂ§¥ÂÉèÁîüÊàê (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë**:
    -   ‰∏∫ÊØè‰∏Ä‰∏™„ÄêÈ¶ñÊ¨°Âá∫Áé∞„ÄëÁöÑË∑Ø‰∫∫NPCÔºàÊó†ËÆ∫ÊòØÂèëÂ∏ñËøòÊòØËØÑËÆ∫ÔºâÔºå‰Ω†ÈÉΩ„ÄêÂøÖÈ°ª„Äë‰∏∫ÂÖ∂Ê∑ªÂä†‰∏Ä‰∏™ \`avatar_prompt\` Â≠óÊÆµ„ÄÇ
    -   Ëøô‰∏™Â≠óÊÆµÁöÑÂÜÖÂÆπÊòØÁî®‰∫éÁîüÊàêËØ•NPCÂ§¥ÂÉèÁöÑ„ÄÅÁÆÄÊ¥ÅÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ
    -   ‰∏çÂêåÁöÑNPC„ÄêÂøÖÈ°ª„ÄëÊúâ‰∏çÂêåÁöÑÂ§¥ÂÉèÊåá‰ª§Ôºå‰ª•Á°Æ‰øù‰ªñ‰ª¨ÁöÑÂ§¥ÂÉèÊòØÁã¨‰∏ÄÊó†‰∫åÁöÑ„ÄÇ
8.  **„ÄêÂ§¥ÂÉè‰∏ÄËá¥ÊÄß (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë**:
    -   Â¶ÇÊûú‰∏Ä‰∏™Ë∑Ø‰∫∫NPCÂú®Âêå‰∏Ä‰∏™Â∏ñÂ≠ê‰∏≠Â§öÊ¨°Âá∫Áé∞Ôºà‰æãÂ¶ÇÔºåÊó¢ÊòØÂèëÂ∏ñ‰∫∫ÂèàÊòØËØÑËÆ∫ËÄÖÔºåÊàñÂ§öÊ¨°ËØÑËÆ∫ÔºâÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏∫TAÁöÑÊâÄÊúâÂá∫Áé∞ÈÉΩ‰ΩøÁî®„ÄêÂÆåÂÖ®Áõ∏Âêå„ÄëÁöÑ \`avatar_prompt\`„ÄÇËøôËá≥ÂÖ≥ÈáçË¶ÅÔºÅ
9.  **„ÄêÊ†ºÂºè (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`[\` ÂºÄÂßãÔºåÂπ∂‰ª• \`]\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÊï∞ÁªÑÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£Èáä„ÄÅÊàñ markdown Ê†áËÆ∞ (Â¶Ç \`\`\`json)„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏ÄÁØáÂ∏ñÂ≠êÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      {
        "groupName": "‰∏Ä‰∏™ÁîüÂä®ÊúâË∂£ÁöÑÂ∞èÁªÑÂêçÁß∞",
        "postTitle": "‰∏Ä‰∏™Âºï‰∫∫-Ê≥®ÁõÆÁöÑÂ∏ñÂ≠êÊ†áÈ¢ò",
        "authorName": "ÂèëÂ∏ñËßíËâ≤ÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë",
        "authorOriginalName": "(‰ªÖÂΩìÂèëÂ∏ñËÄÖÊòØ‰∏ªË¶ÅËßíËâ≤Êó∂„ÄêÂøÖÈ°ª„ÄëÊèê‰æõ) TAÁöÑÂéüÂßãÂ§áÊ≥®Âêç",
        "authorAvatarPrompt": "(‰ªÖÂΩìÂèëÂ∏ñËÄÖÊòØË∑Ø‰∫∫NPCÊó∂„ÄêÂøÖÈ°ª„ÄëÊèê‰æõ) ‰∏ÄÊÆµÁî®‰∫éÁîüÊàêËØ•NPCÂ§¥ÂÉèÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇÈ£éÊ†º‰∏∫ anime style, simple background",
        "content": "Â∏ñÂ≠êÁöÑËØ¶ÁªÜÊ≠£ÊñáÔºåÂøÖÈ°ªÊîØÊåÅÊç¢Ë°åÁ¨¶\\n„ÄÇ",
        "likesCount": 152,
        "commentsCount": 38,
        "comments": [
            { "commenter": "Ë∑Ø‰∫∫Áî≤", "text": "ËøôÊòØ‰∏Ä‰∏™Ë∑Ø‰∫∫ËØÑËÆ∫„ÄÇ", "avatar_prompt": "cute cat avatar, simple, flat" },
            { "commenter": "Âè¶‰∏Ä‰∏™ËßíËâ≤Âêç", "commenterOriginalName": "(Â¶ÇÊûúËØÑËÆ∫ËÄÖÊòØ‰∏ªË¶ÅËßíËâ≤ÔºåÂøÖÈ°ªÊèê‰æõÂÖ∂Êú¨Âêç)", "text": "ËøôÊòØ‰∏Ä‰∏™Êù•Ëá™ÂÖ∂‰ªñËßíËâ≤ÁöÑ‰∫íÂä®ËØÑËÆ∫„ÄÇ" }
        ]
      }
    ]
    \`\`\`
    - **comments**: 
        -   ËØÑËÆ∫ËÄÖÂèØ‰ª•ÊòØË∑Ø‰∫∫Ôºå‰πüÂèØ‰ª•ÊòØËßíËâ≤ÂàóË°®‰∏≠ÁöÑÂÖ∂‰ªñËßíËâ≤„ÄÇËØÑËÆ∫Âå∫„ÄêÂøÖÈ°ª„Äë‰ΩìÁé∞Âá∫‰∫íÂä®ÊÄß„ÄÇ
        -   „ÄêËØÑËÆ∫Ë∫´‰ªΩ„Äë: Â¶ÇÊûúËØÑËÆ∫ËÄÖÊòØ„Äê‰∏ªË¶ÅËßíËâ≤„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏∫ÂÖ∂Ê∑ªÂä† \`commenterOriginalName\` Â≠óÊÆµÔºåÂπ∂Â°´ÂÖ•ÂÖ∂Êú¨Âêç„ÄÇÂ¶ÇÊûúÊòØË∑Ø‰∫∫NPCÔºåÂàôÁúÅÁï•Ê≠§Â≠óÊÆµ„ÄÇ

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑ‰∏ä‰∏ãÊñá
${doubanSettingContext}
${sharedWorldBookContext}

# ÂΩìÂâçÊÉÖÊôØ
- **ÂΩìÂâçÁúüÂÆûÊó∂Èó¥**: ${currentTimeString}

# „Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑË∫´‰ªΩÊ°£Ê°à„Äë
- **ÊòµÁß∞**: ${userNickname}
- **‰∫∫ËÆæ**: ${userPersona}

# Áªü‰∏ÄËßíËâ≤ÂàóË°® (‰Ω†ÊâÆÊºîÁöÑËßíËâ≤ + Ë∑Ø‰∫∫NPC)
${charactersContext}

Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÈÅµÂÆàÊâÄÊúâËßÑÂàôÔºåÁâπÂà´ÊòØ„ÄêÊó∂Èó¥ÊÑüÁü•„ÄëÂíå„ÄêÁ¶ÅÊ≠¢ÊâÆÊºîÁî®Êà∑„ÄëÁöÑÈìÅÂæãÔºåÂºÄÂßãÁîüÊàêËøôÁªÑÁîüÂä®„ÄÅÂ§öÊ†∑‰∏îÂÖÖÊª°‚ÄúË±ÜÁì£Âë≥‚ÄùÁöÑÂ∞èÁªÑÂ∏ñÂ≠ê„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆËßíËâ≤ÂàóË°®ÔºåÁîüÊàêË±ÜÁì£Â∞èÁªÑÂ∏ñÂ≠ê„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/\[[\s\S]*\]/);

      if (!jsonMatch) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }

      const simulatedPosts = JSON.parse(jsonMatch[0]);
      await db.doubanPosts.clear();
      await db.doubanPosts.bulkAdd(simulatedPosts.map(p => ({
        ...p,
        timestamp: Date.now() - Math.random() * 100000
      })));

      await renderDoubanScreen();

    } catch (error) {
      console.error("ÁîüÊàêË±ÜÁì£Â∏ñÂ≠êÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂÜÖÂÆπÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }


  async function openDoubanPostDetail(postId) {
    showScreen('douban-post-detail-screen');
    activeDoubanPostId = postId;
    const post = await db.doubanPosts.get(postId);
    if (!post) {
      showScreen('douban-screen');
      return;
    }

    document.getElementById('douban-post-detail-title').textContent = 'Â∏ñÂ≠êËØ¶ÊÉÖ';


    let authorAvatar = defaultAvatar;
    let authorDisplayName = post.authorName;

    const authorChatByOriginalName = post.authorOriginalName ?
      Object.values(state.chats).find(c => !c.isGroup && c.originalName === post.authorOriginalName) :
      null;

    if (authorChatByOriginalName) {
      authorAvatar = authorChatByOriginalName.settings.aiAvatar;
    } else {
      const authorChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === post.authorName);
      if (authorChatByName) {
        authorAvatar = authorChatByName.settings.aiAvatar;
      } else if (post.authorAvatarPrompt) {
        authorAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(post.authorAvatarPrompt)}`;
      }
    }


    document.getElementById('douban-detail-avatar').src = authorAvatar;
    document.getElementById('douban-detail-author').textContent = authorDisplayName;
    document.getElementById('douban-detail-group').textContent = `Êù•Ëá™ ${post.groupName}`;
    document.getElementById('douban-detail-post-title').textContent = post.postTitle;
    document.getElementById('douban-detail-content').innerHTML = post.content.replace(/\n/g, '<br>');
    document.getElementById('douban-my-comment-avatar').src = state.qzoneSettings.avatar;
    document.getElementById('douban-comment-input').value = '';

    const commentsListEl = document.getElementById('douban-detail-comments-list');
    commentsListEl.innerHTML = '';


    if (post.comments && post.comments.length > 0) {

      const commenterAvatarMap = new Map();

      post.comments.forEach(comment => {
        let commenterAvatar = defaultAvatar;
        const myNickname = state.qzoneSettings.nickname || 'Êàë';
        const commenterName = comment.commenter;

        if (commenterAvatarMap.has(commenterName)) {

          commenterAvatar = commenterAvatarMap.get(commenterName);
        } else {

          if (commenterName === myNickname) {
            commenterAvatar = state.qzoneSettings.avatar;
          } else if (commenterName === post.authorName) {
            commenterAvatar = authorAvatar;
          } else {
            const commenterChatByOriginalName = comment.commenterOriginalName ?
              Object.values(state.chats).find(c => !c.isGroup && c.originalName === comment.commenterOriginalName) :
              null;

            if (commenterChatByOriginalName) {
              commenterAvatar = commenterChatByOriginalName.settings.aiAvatar;
            } else {
              const commenterChatByName = Object.values(state.chats).find(c => !c.isGroup && c.name === commenterName);
              if (commenterChatByName) {
                commenterAvatar = commenterChatByName.settings.aiAvatar;
              } else if (comment.avatar_prompt) {
                commenterAvatar = `https://image.pollinations.ai/prompt/${encodeURIComponent(comment.avatar_prompt)}`;
              }
            }
          }

          commenterAvatarMap.set(commenterName, commenterAvatar);
        }

        const commentEl = document.createElement('div');
        commentEl.className = 'douban-comment-item';
        commentEl.innerHTML = `
                <img src="${commenterAvatar}" class="douban-comment-avatar">
                <div class="douban-comment-body">
                    <div class="douban-comment-author">${commenterName}</div>
                    <div class="douban-comment-text">${comment.text.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        commentsListEl.appendChild(commentEl);
      });
    } else {
      commentsListEl.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px;">ËøòÊ≤°ÊúâÂõûÂ∫î</p>';
    }

    const contentWrapper = document.getElementById('douban-detail-content-wrapper');
    if (contentWrapper) contentWrapper.scrollTop = 0;
  }


  async function handleSendDoubanComment() {
    if (!activeDoubanPostId) return;

    const input = document.getElementById('douban-comment-input');
    const commentText = input.value.trim();
    if (!commentText) return;

    const post = await db.doubanPosts.get(activeDoubanPostId);
    if (!post) return;

    if (!post.comments) {
      post.comments = [];
    }

    const myNickname = state.qzoneSettings.nickname || 'Êàë';

    post.comments.push({
      commenter: myNickname,
      text: commentText
    });
    post.commentsCount++;

    await db.doubanPosts.put(post);
    input.value = '';


    await openDoubanPostDetail(activeDoubanPostId);


  }


  async function handleDoubanWaitReply() {
    if (!activeDoubanPostId) return;

    const postId = activeDoubanPostId;
    const post = await db.doubanPosts.get(postId);
    if (!post) return;

    const lastComment = post.comments && post.comments.slice(-1)[0];
    if (!lastComment) {
      alert("ËøòÊ≤°Êúâ‰ªª‰ΩïËØÑËÆ∫ÔºåÊó†Ê≥ïÁ≠âÂæÖÂõûÂ§ç„ÄÇ");
      return;
    }

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ËØ∑Ê±ÇAIËßíËâ≤‰ª¨Âä†ÂÖ•ËÆ®ËÆ∫...");

    try {
      const {
        proxyUrl,
        apiKey,
        model
      } = state.apiConfig;
      if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂÜÖÂÆπ„ÄÇ');
      }

      const userNickname = state.qzoneSettings.nickname || 'Êàë';
      const userPersona = state.chats[Object.keys(state.chats)[0]]?.settings.myPersona || '(Êú™ËÆæÁΩÆ)';

      const existingNpcs = new Map();
      if (post.comments) {
        post.comments.forEach(comment => {
          const isMainCharacter = (state.globalSettings.doubanActiveCharacterIds || []).some(id => state.chats[id]?.name === comment.commenter);
          if (!isMainCharacter && comment.avatar_prompt) {
            existingNpcs.set(comment.commenter, comment.avatar_prompt);
          }
        });
      }

      let existingNpcContext = "# Â∑≤ÊúâË∑Ø‰∫∫NPCÂ§¥ÂÉèÊåá‰ª§ (ÂøÖÈ°ªÈÅµÂÆàÔºÅ)\n";
      if (existingNpcs.size > 0) {
        existingNpcContext += "Â¶ÇÊûú‰ª•‰∏ã‰ªª‰Ωï‰∏Ä‰ΩçNPCÂÜçÊ¨°ËØÑËÆ∫Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Êàë‰ª¨Êèê‰æõÁöÑ„ÄÅÂÆåÂÖ®Áõ∏ÂêåÁöÑ`avatar_prompt`Ôºå‰ª•‰øùÊåÅÂ§¥ÂÉè‰∏ÄËá¥ÊÄß„ÄÇ\n";
        existingNpcs.forEach((prompt, name) => {
          existingNpcContext += `- **${name}**: "${prompt}"\n`;
        });
      } else {
        existingNpcContext += "ÔºàÂΩìÂâçÂ∏ñÂ≠êËøòÊ≤°ÊúâË∑Ø‰∫∫NPCÂèëË°®ËØÑËÆ∫„ÄÇÔºâ\n";
      }

      const doubanWorldBook = state.worldBooks.find(wb => wb.name === 'Ë±ÜÁì£ËÆæÂÆö');
      let npcCharacters = [];
      if (doubanWorldBook) {
        doubanWorldBook.content.forEach(entry => {
          if (entry.comment.includes('NPC‰∫∫ËÆæ')) {
            const lines = entry.content.split('\n');
            lines.forEach(line => {
              const match = line.match(/- \*\*ÊòµÁß∞\*\*:\s*(.*?)\s*\*\*‰∫∫ËÆæ\*\*:\s*(.*)/);
              if (match) {
                npcCharacters.push({
                  name: match[1].trim(),
                  persona: match[2].trim()
                });
              }
            });
          }
        });
      }

      let charactersContext = '';
      const activeCharacterIds = state.globalSettings.doubanActiveCharacterIds || [];
      activeCharacterIds.forEach(charId => {
        const c = state.chats[charId];
        if (c) {
          const longTermMemory = c.longTermMemory && c.longTermMemory.length > 0 ? c.longTermMemory.map(m => m.content).join('; ') : 'Êó†';
          const recentHistory = c.history.slice(-10).map(msg => `${msg.role === 'user' ? userNickname : c.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
          charactersContext += `\n- ${c.name}: ${c.settings.aiPersona.substring(0,50)}... [ËÆ∞ÂøÜ: ${longTermMemory}] [ÊúÄËøëÂØπËØù: ${recentHistory}]`;
        }
      });
      npcCharacters.forEach(npc => {
        charactersContext += `\n- ${npc.name}: ${npc.persona}`;
      });


      const now = new Date();
      const currentTimeString = now.toLocaleString('zh-CN', {
        dateStyle: 'full',
        timeStyle: 'short'
      });


      const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁ§æÂå∫ÁöÑAIÂØºÊºî„ÄÇ‰∏ãÈù¢ÁöÑ‚ÄúÂ∏ñÂ≠êÊëòË¶Å‚ÄùÂíå‚ÄúÂ∑≤ÊúâËØÑËÆ∫‚ÄùÊù•Ëá™‰∫é‰∏Ä‰∏™Ë±ÜÁì£Â∞èÁªÑÁöÑÂ∏ñÂ≠ê„ÄÇÁî®Êà∑‚Äú${userNickname}‚ÄùÂàöÂàöÂØπÊúÄÂêé‰∏ÄÊù°ËØÑËÆ∫ÁÇπÂáª‰∫Ü‚ÄúÁ≠âÂæÖÂõûÂ§ç‚ÄùÔºåTAÂ∏åÊúõÁúãÂà∞Êõ¥Â§öËßíËâ≤ÂèÇ‰∏éËÆ®ËÆ∫„ÄÇ
‰Ω†ÁöÑ‰ªªÂä°ÊòØÔºöÊ†πÊçÆÊâÄÊúâËßíËâ≤ÁöÑËÆæÂÆöÔºåÈÄâÊã©„Äê10Âà∞20‰Ωç„ÄëÊúÄÈÄÇÂêàÂèÇ‰∏éËÆ®ËÆ∫ÁöÑËßíËâ≤ÔºåËÆ©‰ªñ‰ª¨ÈíàÂØπÂ∑≤ÊúâËØÑËÆ∫ÔºåÂèëË°®„ÄêÂÖ®Êñ∞ÁöÑ„ÄÅÁ¨¶Âêà‰∫∫ËÆæÁöÑ„ÄëÂõûÂ∫î„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêÊó∂Èó¥ÊÑüÁü•„Äë**:
    -   ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊÑèËØÜÂà∞ÂΩìÂâçÊòØ **${currentTimeString}**„ÄÇ
    -   ‰Ω†ÁöÑËØÑËÆ∫ÂÜÖÂÆπ„ÄêÂøÖÈ°ª„ÄëËá™ÁÑ∂Âú∞‰ΩìÁé∞Âá∫ÂØπ„ÄêÂΩìÂâçÁúüÂÆûÊó∂Èó¥„ÄëÁöÑÊÑüÁü•„ÄÇ
2.  **„ÄêÁ¶ÅÊ≠¢ÊâÆÊºîÁî®Êà∑ (ÊúÄÊúÄÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅÔºÅÔºÅ)„Äë**:
    -   Áî®Êà∑ÁöÑÊòµÁß∞ÊòØ‚Äú${userNickname}‚Äù„ÄÇ
    -   ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê commenter Â≠óÊÆµ‰∏∫ ‚Äú${userNickname}‚Äù ÁöÑËØÑËÆ∫„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑÊâÄÊúâËßíËâ≤„ÄÇ
3.  **„Äê‰∫íÂä®„Äë**: Êñ∞ÁîüÊàêÁöÑËØÑËÆ∫„ÄêÂøÖÈ°ª„ÄëÊòØÈíàÂØπ„ÄêÂ∑≤ÊúâËØÑËÆ∫„ÄëÁöÑÂª∂Áª≠ÊàñÂõûÂ∫îÔºåËÆ©ËÆ®ËÆ∫ËÉΩÁªßÁª≠‰∏ãÂéª„ÄÇ
4.  **„ÄêÂ§¥ÂÉè‰∏ÄËá¥ÊÄß (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÂèÇËÄÉ‰∏ãÈù¢ÁöÑ‚ÄúÂ∑≤ÊúâË∑Ø‰∫∫NPCÂ§¥ÂÉèÊåá‰ª§‚ÄùÂàóË°®„ÄÇÂ¶ÇÊûú‰∏Ä‰∏™Â∑≤ÊúâÁöÑNPCÂÜçÊ¨°ÂèëË®ÄÔºå„ÄêÂøÖÈ°ª„ÄëÂ§çÁî®ÂÆÉÊóßÁöÑÂ§¥ÂÉèÊåá‰ª§„ÄÇÂè™ÊúâÂú®ÂàõÈÄ†‰∏Ä‰∏™„ÄêÂÖ®Êñ∞ÁöÑ„ÄÅ‰ªéÊú™Âá∫Áé∞ËøáÁöÑ„ÄëNPCÊó∂ÔºåÊâç‰∏∫ÂÖ∂ÁîüÊàêÊñ∞ÁöÑÂ§¥ÂÉèÊåá‰ª§„ÄÇ
5.  **„ÄêÊ†ºÂºè„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩ‰ª£Ë°®‰∏ÄÊù°Êñ∞ËØÑËÆ∫ÔºåÊ†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    [
      { "commenter": "ËßíËâ≤AÁöÑÂêçÂ≠ó", "text": "ËßíËâ≤AÁöÑÊñ∞ËØÑËÆ∫ÂÜÖÂÆπ„ÄÇ", "avatar_prompt": "(ÂèØÈÄâ)Â¶ÇÊûúËØÑËÆ∫ËÄÖÊòØ„ÄêÂÖ®Êñ∞ÁöÑ„ÄëNPC,Êèê‰æõÂ§¥ÂÉèÊåá‰ª§" },
      { "commenter": "ËßíËâ≤BÁöÑÂêçÂ≠ó", "text": "ËßíËâ≤BÂØπËßíËâ≤AÊàñÊ•º‰∏ªÁöÑÁúãÊ≥ï„ÄÇ" }
    ]
    \`\`\`

# ‰∏ä‰∏ãÊñá
- **Â∏ñÂ≠êÊ†áÈ¢ò**: „Ää${post.postTitle}„Äã
- **ÂèëÂ∏ñ‰∫∫**: ${post.authorName}
- **Â∏ñÂ≠êÂÜÖÂÆπÊëòË¶Å**: ${post.content.substring(0, 100)}...
- **Â∑≤ÊúâËØÑËÆ∫**:
${post.comments.map(c => `- ${c.commenter}: ${c.text}`).join('\n')}

${existingNpcContext}

# ÂΩìÂâçÊÉÖÊôØ
- **ÂΩìÂâçÁúüÂÆûÊó∂Èó¥**: ${currentTimeString}

# „Äê‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºàÁî®Êà∑ÔºâÁöÑ‰∫∫ËÆæ„Äë
- **ÊòµÁß∞**: ${userNickname}
- **‰∫∫ËÆæ**: ${userPersona}

# ‰Ω†ÁöÑËßíËâ≤Â∫ì (‰Ω†ÂèØ‰ª•‰ªé‰∏≠ÈÄâÊã©„Äê‰ªª‰ΩïËßíËâ≤„ÄëËøõË°åËØÑËÆ∫ÔºåÂπ∂ÂèÇËÄÉ‰ªñ‰ª¨ÁöÑËÆ∞ÂøÜÂíåÂØπËØù)
${charactersContext}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêÊñ∞ÁöÑËØÑËÆ∫„ÄÇ`;

      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äÊÉÖÊôØÔºåÁîüÊàêÊñ∞ÁöÑËØÑËÆ∫„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 1.0,
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
      const newComments = JSON.parse(cleanedJson);

      if (Array.isArray(newComments) && newComments.length > 0) {
        post.comments.push(...newComments);
        post.commentsCount += newComments.length;
        await db.doubanPosts.put(post);
      }

      await openDoubanPostDetail(postId);

      hideCustomModal();

    } catch (error) {
      console.error("Á≠âÂæÖÂõûÂ§çÂ§±Ë¥•:", error);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Êó†Ê≥ïËé∑ÂèñAIÂõûÂ§çÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }



  async function openDoubanCastSelector() {
    const modal = document.getElementById('douban-cast-modal');
    const listEl = document.getElementById('douban-cast-list');
    listEl.innerHTML = '';

    const allCharacters = Object.values(state.chats).filter(c => !c.isGroup);
 
    const activeIds = new Set(state.globalSettings.doubanActiveCharacterIds || []);

    if (allCharacters.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; padding: 50px 0;">ËøòÊ≤°ÊúâÂèØ‰ª•ÂèÇ‰∏éÁöÑËßíËâ≤„ÄÇ</p>';
    } else {
      allCharacters.forEach(char => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.innerHTML = `
                <input type="checkbox" class="douban-cast-checkbox" data-chat-id="${char.id}" ${activeIds.has(char.id) ? 'checked' : ''} style="margin-right: 15px;">
                <img src="${char.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${char.name}</span>
            `;
        listEl.appendChild(item);
      });
    }
    modal.classList.add('visible');
  }


  async function saveDoubanCastSelection() {
    const selectedCheckboxes = document.querySelectorAll('#douban-cast-list .douban-cast-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.chatId);


    state.globalSettings.doubanActiveCharacterIds = selectedIds;
    await db.globalSettings.put(state.globalSettings);

    document.getElementById('douban-cast-modal').classList.remove('visible');


    await handleGenerateDoubanPosts();
  }



  document.getElementById('douban-cast-select-btn').addEventListener('click', openDoubanCastSelector);
  document.getElementById('cancel-douban-cast-btn').addEventListener('click', () => {
    document.getElementById('douban-cast-modal').classList.remove('visible');
  });
  document.getElementById('save-douban-cast-btn').addEventListener('click', saveDoubanCastSelection);

  document.getElementById('douban-cast-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (item) {
      const checkbox = item.querySelector('.douban-cast-checkbox');
      if (checkbox && e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
      }
    }
  });

  async function importAppearanceSettings(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'ÂØºÂÖ•Â§ñËßÇËÆæÁΩÆ',
        'Âç≥Â∞ÜÂØºÂÖ•Êñá‰ª∂„ÄÇÂ¶ÇÊûúÊñá‰ª∂ÊòØ JSON Â§á‰ªΩÔºåÂ∞ÜË¶ÜÁõñÊâÄÊúâËÆæÁΩÆÔºõÂ¶ÇÊûúÊòØÁ∫ØÊñáÊú¨/WordÊñáÊ°£ÔºåÂ∞ÜÂ∞ùËØïËØÜÂà´‰∏∫ CSS ‰ª£Á†ÅÊàñ JSON ÈÖçÁΩÆ„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
            confirmText: 'Á°ÆËÆ§ÂØºÂÖ•'
        }
    );

    if (!confirmed) return;

    await showCustomAlert("Â§ÑÁêÜ‰∏≠...", "Ê≠£Âú®Ëß£ÊûêÊñá‰ª∂ÂÜÖÂÆπ...");

    try {
        let textContent = '';

        // 1. Ê†πÊçÆÊñá‰ª∂Á±ªÂûãËØªÂèñÊñáÊú¨
        if (file.name.toLowerCase().endsWith('.docx')) {
            if (typeof mammoth === 'undefined') {
                throw new Error("Êú™Âä†ËΩΩ mammoth.js Â∫ìÔºåÊó†Ê≥ïËØªÂèñ Word ÊñáÊ°£„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ HTML„ÄÇ");
            }
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            textContent = result.value;
        } else {
            // .json Êàñ .txt Áõ¥Êé•ËØªÂèñÊñáÊú¨
            textContent = await file.text();
        }

        if (!textContent || !textContent.trim()) {
            throw new Error("Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ");
        }

        // 2. Â∞ùËØïËß£Êûê‰∏∫ JSONÔºàÂÆåÊï¥ÈÖçÁΩÆÊ®°ÂºèÔºâ
        try {
            // È¢ÑÂ§ÑÁêÜÔºöÊúâÊó∂ÂÄô Word ‰ºöÂåÖÂê´‰∏çÂèØËßÅÁöÑ BOM ÊàñÂ§ö‰ΩôÁ©∫Ê†ºÔºåÂ∞ùËØïÊ∏ÖÁêÜÂπ∂ÊèêÂèñ JSON ÈÉ®ÂàÜ
            let cleanText = textContent.trim();
            // Â∞ùËØïÊèêÂèñÁ¨¨‰∏Ä‰∏™ { Âà∞ÊúÄÂêé‰∏Ä‰∏™ } ‰πãÈó¥ÁöÑÂÜÖÂÆπÔºåÈò≤Ê≠¢ÊñáÊ°£ÂâçÂêéÊúâÊùÇË¥®
            const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                cleanText = jsonMatch[0];
            }

            const data = JSON.parse(cleanText);

            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊúâÊïàÁöÑÂ§ñËßÇÈÖçÁΩÆÂØπË±°
            if (data.wallpaper || data.globalCss || data.appIcons || data.theme) {
                Object.assign(state.globalSettings, data);
                await db.globalSettings.put(state.globalSettings);
                
                // Â∫îÁî®ËÆæÁΩÆ
                applyGlobalWallpaper();
                applyCPhoneWallpaper();
                applyAppIcons();
                applyCPhoneAppIcons();
                applyGlobalCss(state.globalSettings.globalCss);
                applyCustomFont(state.globalSettings.fontUrl);
                applyStatusBarVisibility();
                applyWidgetData();
                if (data.chatActionButtonsOrder) {
                    renderButtonOrderEditor();
                    applyButtonOrder();
                }
                
                // Âà∑Êñ∞ÁïåÈù¢
                renderWallpaperScreen();
                
                await showCustomAlert('JSONÂØºÂÖ•ÊàêÂäü', 'ÂÆåÊï¥Â§ñËßÇËÆæÁΩÆÂ∑≤ÊàêÂäüÂØºÂÖ•Âπ∂Â∫îÁî®ÔºÅ');
                return; // ÊàêÂäüÁªìÊùü
            }
        } catch (jsonError) {
            // JSON Ëß£ÊûêÂ§±Ë¥•ÔºåËøõÂÖ•‰∏ã‰∏ÄÊ≠•ÔºöÂ∞ùËØï‰Ωú‰∏∫Á∫Ø CSS ÂØºÂÖ•
            console.log("Èùû JSON Ê†ºÂºèÔºåÂ∞ùËØï‰Ωú‰∏∫ CSS Â§ÑÁêÜ...");
        }

        // 3. Â¶ÇÊûú‰∏çÊòØ JSONÔºåÂàôËßÜ‰∏∫Á∫Ø CSS ‰ª£Á†ÅÂØºÂÖ•
        // ÁÆÄÂçïÁöÑÈò≤ÂëÜÊ£ÄÊü•ÔºöCSS ÈÄöÂ∏∏ÂåÖÂê´ { Êàñ ;
        if (textContent.includes('{') || textContent.includes(';')) {
            const cssConfirm = await showCustomConfirm(
                'Ê£ÄÊµãÂà∞ CSS ‰ª£Á†Å',
                'Êñá‰ª∂ÂÜÖÂÆπ‰ºº‰πé‰∏çÊòØÊ†áÂáÜÁöÑ JSON ÈÖçÁΩÆÂåÖÔºå‰ΩÜÁúãËµ∑Êù•ÂÉè CSS ‰ª£Á†Å„ÄÇ\n\nÊòØÂê¶Â∞ÜÂÖ∂Áõ¥Êé•Â∫îÁî®Âà∞„ÄêÂÖ®Â±ÄËá™ÂÆö‰πâ CSS„Äë‰∏≠Ôºü(ËøôÂ∞ÜË¶ÜÁõñÁé∞ÊúâÁöÑ CSS)',
                { confirmText: 'Â∫îÁî®‰∏∫ CSS' }
            );

            if (cssConfirm) {
                state.globalSettings.globalCss = textContent;
                await db.globalSettings.put(state.globalSettings);
                applyGlobalCss(state.globalSettings.globalCss);
                
                // Âà∑Êñ∞ÁïåÈù¢ÊòæÁ§∫
                const cssInput = document.getElementById('global-css-input');
                if (cssInput) cssInput.value = textContent;

                await showCustomAlert('CSSÂØºÂÖ•ÊàêÂäü', '‰ª£Á†ÅÂ∑≤Â∫îÁî®Âà∞ÂÖ®Â±ÄÊ†∑ÂºèË°®„ÄÇ');
            }
        } else {
            throw new Error("Êó†Ê≥ïËØÜÂà´Êñá‰ª∂ÂÜÖÂÆπ„ÄÇÂÆÉÊó¢‰∏çÊòØÊúâÊïàÁöÑ JSON ÈÖçÁΩÆÔºå‰πü‰∏çÂÉè CSS ‰ª£Á†Å„ÄÇ");
        }

    } catch (error) {
        console.error("ÂØºÂÖ•Â§ñËßÇËÆæÁΩÆÊó∂Âá∫Èîô:", error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ${error.message}`);
    }
}

// ÂØºÂá∫ÁæéÂåñÁâàÂ§ñËßÇËÆæÁΩÆ
async function exportAppearanceSettings() {
    try {
        // 1. ÊèêÂèñÂ§ñËßÇÁõ∏ÂÖ≥ÁöÑÊï∞ÊçÆ
        // Âç≥‰ΩøÂåÖÂê´Â§ßÊÆµ Base64 ÂõæÁâáÔºåJSON Ê†ºÂºèÂåñÂêéÁªìÊûÑ‰æùÁÑ∂Ê∏ÖÊô∞
        const appearanceData = {
            export_info: {
                generated_by: "EPhone",
                timestamp: new Date().toLocaleString(),
                note: "Ê≠§Êñá‰ª∂ÂåÖÂê´Â§ñËßÇËÆæÁΩÆ„ÄÅCSSÊ†∑Âºè„ÄÅÂ£ÅÁ∫∏ÂíåÂõæÊ†áÊï∞ÊçÆ„ÄÇ"
            },
            // Ê†∏ÂøÉËÆæÁΩÆ
            theme: localStorage.getItem('ephone-theme') || 'light',
            showStatusBar: state.globalSettings.showStatusBar,
            enableMinimalChatUI: state.globalSettings.enableMinimalChatUI,
            detachStatusBar: state.globalSettings.detachStatusBar,
            // CSS (ÊúÄÈúÄË¶ÅÁæéÂåñÈòÖËØªÁöÑÈÉ®ÂàÜ)
            globalCss: state.globalSettings.globalCss || "",
            // Â≠ó‰Ωì
            fontUrl: state.globalSettings.fontUrl || "",
            // Â∏ÉÂ±ÄÊéíÂ∫è
            chatActionButtonsOrder: state.globalSettings.chatActionButtonsOrder,
            // ËµÑÊ∫êÊï∞ÊçÆ (Â£ÅÁ∫∏/ÂõæÊ†á)
            wallpaper: state.globalSettings.wallpaper,
            cphoneWallpaper: state.globalSettings.cphoneWallpaper,
            globalChatBackground: state.globalSettings.globalChatBackground,
            appIcons: state.globalSettings.appIcons,
            cphoneAppIcons: state.globalSettings.cphoneAppIcons,
            widgetData: state.globalSettings.widgetData,
            lockScreenWallpaper: state.globalSettings.lockScreenWallpaper,
            notificationSoundUrl: state.globalSettings.notificationSoundUrl
        };

        // 2. ÂÖ≥ÈîÆÊ≠•È™§ÔºöÊ†ºÂºèÂåñ JSON (ÁæéÂåñ)
        // Á¨¨‰∏â‰∏™ÂèÇÊï∞ 4 Ë°®Á§∫‰ΩøÁî® 4 ‰∏™Á©∫Ê†ºËøõË°åÁº©ËøõÔºåËÆ©Êñá‰ª∂ÁªìÊûÑÊ∏ÖÊô∞„ÄÅÊòìËØª„ÄÅÊòì‰øÆÊîπ
        const jsonString = JSON.stringify(appearanceData, null, 4);

        // 3. ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        // ÁîüÊàêÊñá‰ª∂Âêç
        const dateStr = new Date().toISOString().split('T')[0];
        link.href = url;
        link.download = `EPhone_Appearance_Config_${dateStr}.json`;
        
        // Ëß¶Âèë‰∏ãËΩΩ
        document.body.appendChild(link);
        link.click();
        
        // Ê∏ÖÁêÜ
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â§ñËßÇÈÖçÁΩÆÂ∑≤ÂØºÂá∫ÔºÅ\nËøôÊòØ‰∏Ä‰∏™Ê†ºÂºèÂåñÂ•ΩÁöÑ JSON Êñá‰ª∂Ôºå‰Ω†ÂèØ‰ª•Áî®ËÆ∞‰∫ãÊú¨ÊâìÂºÄÊü•ÁúãÊàñÁºñËæë CSS„ÄÇ');

    } catch (error) {
        console.error("ÂØºÂá∫Â§ñËßÇÈÖçÁΩÆÂ§±Ë¥•:", error);
        await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîüÈîôËØØ: ${error.message}`);
    }
} 




  async function simulateBackgroundActivity(minutesOffline) {
    console.log(`Ê£ÄÊµãÂà∞Â∫îÁî®Á¶ªÁ∫ø‰∫Ü ${minutesOffline.toFixed(1)} ÂàÜÈíüÔºåÂºÄÂßãÊ®°ÊãüÂêéÂè∞Ê¥ªÂä®...`);


    const activeCharacters = Object.values(state.chats).filter(chat =>
      !chat.isGroup &&
      chat.settings.enableBackgroundActivity &&
      chat.relationship?.status === 'friend'
    );

    if (activeCharacters.length === 0) {
      console.log("Ê≤°ÊúâÈÖçÁΩÆ‰∏∫ÂêéÂè∞Ê¥ªË∑ÉÁöÑËßíËâ≤ÔºåË∑≥ËøáÊ®°Êãü„ÄÇ");
      return;
    }


    for (const char of activeCharacters) {

      const cooldownMinutes = char.settings.actionCooldownMinutes || 15;
      const timeSinceLastAction = char.lastActionTimestamp ?
        (Date.now() - char.lastActionTimestamp) / (1000 * 60) :
        Infinity;


      if (minutesOffline > cooldownMinutes && timeSinceLastAction > cooldownMinutes) {



        if (Math.random() < 0.3) {
          console.log(`ËßíËâ≤ "${char.name}" Ëß¶Âèë‰∫ÜÂêéÂè∞Ë°åÂä®ÔºÅ`);


          if (Math.random() < 0.7) {

            await triggerInactiveAiAction(char.id);
          } else {

            console.log(`ËßíËâ≤ "${char.name}" ÂÜ≥ÂÆöÂéªÂèë‰∏ÄÊù°Âä®ÊÄÅ... (Ê≠§Â§Ñ‰∏∫Ê®°Êãü)`);
          }
        }
      }
    }
  }


  function openSearchHistoryScreen() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];


    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';

    document.getElementById('chat-search-results-list').innerHTML = `<p style="text-align:center; color: var(--text-secondary);">ËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñÈÄâÊã©Êó•ÊúüËøõË°åÊêúÁ¥¢„ÄÇ</p>`;


    showScreen('search-history-screen');
  }

  async function handleSearchHistory() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const keyword = document.getElementById('keyword-search-input').value.trim().toLowerCase();
    const dateValue = document.getElementById('date-search-input').value;

    if (!keyword && !dateValue) {
      alert("ËØ∑ËæìÂÖ•ÂÖ≥ÈîÆËØçÊàñÈÄâÊã©‰∏Ä‰∏™Êó•Êúü„ÄÇ");
      return;
    }

    let results = chat.history.filter(msg => !msg.isHidden);


    if (keyword) {
      results = results.filter(msg => {
        let contentString = '';

        if (typeof msg.content === 'string') {
          contentString = msg.content;
        } else if (msg.type === 'voice_message') {
          contentString = msg.content;
        } else if (msg.type === 'ai_image' || msg.type === 'user_photo') {
          contentString = msg.content;
        } else if (msg.type === 'offline_text') {
          contentString = `${msg.dialogue || ''} ${msg.description || ''}`;
        } else if (msg.quote) {
          contentString = msg.content;
        }
        return contentString.toLowerCase().includes(keyword);
      });
    }


    if (dateValue) {
      const selectedDate = new Date(dateValue);
      const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0)).getTime();
      const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999)).getTime();

      results = results.filter(msg => msg.timestamp >= startOfDay && msg.timestamp <= endOfDay);
    }


    await renderSearchResults(results);
  }



  async function renderSearchResults(results) {
    const listEl = document.getElementById('chat-search-results-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    if (results.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÁöÑËÅäÂ§©ËÆ∞ÂΩï„ÄÇ</p>';
      return;
    }

    let lastDateString = '';
    for (const msg of results) {
      const msgDate = new Date(msg.timestamp);
      const currentDateString = msgDate.toLocaleDateString();

      if (currentDateString !== lastDateString) {
        const dateSeparator = document.createElement('div');
        dateSeparator.className = 'date-separator';
        dateSeparator.textContent = `--- ${msgDate.getFullYear()}Âπ¥${msgDate.getMonth() + 1}Êúà${msgDate.getDate()}Êó• ---`;
        listEl.appendChild(dateSeparator);
        lastDateString = currentDateString;
      }

      const messageEl = await createMessageElement(msg, chat);
      if (messageEl) {


        messageEl.style.cursor = 'pointer';

        messageEl.addEventListener('click', () => jumpToOriginalMessage(msg.timestamp));

        listEl.appendChild(messageEl);
      }
    }
  }



 
  async function jumpToOriginalMessage(timestamp) {
    const chatId = state.activeChatId;
    if (!chatId) return;


    showScreen('chat-interface-screen');


    setTimeout(async () => {
      const messagesContainer = document.getElementById('chat-messages');
      const selector = `.message-bubble[data-timestamp="${timestamp}"]`;
      let targetMessage = messagesContainer.querySelector(selector);
      let attempts = 0;
      const maxAttempts = 20;


      while (!targetMessage && attempts < maxAttempts) {
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
          console.log(`ÁõÆÊ†áÊ∂àÊÅØÊú™ÊâæÂà∞, Ê≠£Âú®Âä†ËΩΩÊõ¥Â§öÂéÜÂè≤ËÆ∞ÂΩï... (Â∞ùËØï ${attempts + 1})`);
          await loadMoreMessages();
          targetMessage = messagesContainer.querySelector(selector);
          attempts++;
        } else {

          break;
        }
      }


      scrollToOriginalMessage(timestamp);

    }, 200);
  }




  async function clearSearchFilters() {
    document.getElementById('keyword-search-input').value = '';
    document.getElementById('date-search-input').value = '';

    await renderSearchResults(state.chats[state.activeChatId].history.filter(msg => !msg.isHidden));
  }

  async function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
    const aiFrameGrid = document.getElementById('ai-frame-grid');
    const myFrameGrid = document.getElementById('my-frame-grid');
    const chat = state.chats[state.activeChatId];
    aiFrameGrid.innerHTML = '';
    myFrameGrid.innerHTML = '';


    const customFrames = await db.customAvatarFrames.toArray();

    const allFrames = [...avatarFrames, ...customFrames];

    document.querySelector('#avatar-frame-modal .frame-tabs').style.display = isForMember ? 'none' : 'flex';
    document.getElementById('ai-frame-content').style.display = 'block';
    document.getElementById('my-frame-content').style.display = 'none';
    document.getElementById('ai-frame-tab').classList.add('active');
    document.getElementById('my-frame-tab').classList.remove('active');

    if (isForMember) {
      allFrames.forEach(frame => {
        const item = createFrameItem(frame, 'my', memberAvatar);
        if (frame.url === memberFrame) {
          item.classList.add('selected');
        }
        aiFrameGrid.appendChild(item);
      });
    } else {
      const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
      const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
      allFrames.forEach(frame => {
        const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
        if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
        aiFrameGrid.appendChild(aiItem);

        const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
        if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
        myFrameGrid.appendChild(myItem);
      });
    }
  }

 
  function createFrameItem(frame, type, previewAvatarSrc) {
    const item = document.createElement('div');
    item.className = 'frame-item';
    item.dataset.frameUrl = frame.url;
    item.title = frame.name;

    const isCustom = typeof frame.id === 'number';
    const deleteButtonHtml = isCustom ? `<button class="delete-btn" data-id="${frame.id}" style="display:block;">√ó</button>` : '';

    item.innerHTML = `
        ${deleteButtonHtml}
        <img src="${previewAvatarSrc}" class="preview-avatar">
        ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
    `;


    item.addEventListener('click', (e) => {

      if (e.target.classList.contains('delete-btn')) {
        return;
      }


      if (isFrameManagementMode) {

        if (isCustom) {
          const frameId = parseInt(frame.id);
          item.classList.toggle('selected');
          if (selectedFrames.has(frameId)) {
            selectedFrames.delete(frameId);
          } else {
            selectedFrames.add(frameId);
          }
          updateDeleteFrameButton();
        }
      } else {

        currentFrameSelection[type] = frame.url;
        const grid = type === 'ai' ? document.getElementById('ai-frame-grid') : document.getElementById('my-frame-grid');
        grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
        item.classList.add('selected');
      }
    });

    return item;
  }



  async function handleUploadFrame() {
    const fileInput = document.getElementById('custom-frame-upload-input');

    const file = await new Promise(resolve => {
      const changeHandler = (e) => {
        resolve(e.target.files[0] || null);
        fileInput.removeEventListener('change', changeHandler);
      };
      fileInput.addEventListener('change', changeHandler, {
        once: true
      });
      fileInput.click();
    });

    if (!file) return;

    const name = await showCustomPrompt("ÂëΩÂêçÂ§¥ÂÉèÊ°Ü", "ËØ∑‰∏∫Ëøô‰∏™Êñ∞Â§¥ÂÉèÊ°ÜËµ∑‰∏™ÂêçÂ≠ó");
    if (!name || !name.trim()) return;
    
    const trimmedName = name.trim();

    const base64Url = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = async (readerEvent) => { 
            resolve(readerEvent.target.result);
        };
        reader.readAsDataURL(file);
    });

    const newFrame = {
      name: trimmedName,
      url: base64Url
    };
    const newId = await db.customAvatarFrames.add(newFrame);
    
    populateFrameGrids(editingFrameForMember);
    await showCustomAlert("Ê∑ªÂä†ÊàêÂäüÔºÅ", `Â§¥ÂÉèÊ°Ü‚Äú${trimmedName}‚ÄùÂ∑≤Ê∑ªÂä†„ÄÇ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

    // „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
    (async () => {
        await silentlyUpdateDbUrl(
            db.customAvatarFrames, // table
            newId, // recordId
            'url', // pathString (ÊåáÂêëÁÆÄÂçïÂ±ûÊÄß)
            base64Url // base64ToFind
            // nameToMatch (‰∏çÈúÄË¶Å)
        );
    })();
  }


  async function handleBatchUploadFrames() {
    const placeholder = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÂ§¥ÂÉèÊ°ÜÂêçÂ≠ó1: https://.../image1.png\nÂ§¥ÂÉèÊ°ÜÂêçÂ≠ó2: https://.../image2.gif`;
    const pastedText = await showCustomPrompt("ÊâπÈáèÂØºÂÖ•Â§¥ÂÉèÊ°Ü", "‰ªéÂÆåÊï¥ÈìæÊé•ÊâπÈáèÂØºÂÖ•", "", 'textarea', `<p style="font-size:12px;color:#888;">${placeholder}</p>`);

    if (!pastedText || !pastedText.trim()) return;

    const lines = pastedText.trim().split('\n');
    const newFrames = [];
    let errorCount = 0;

    for (const line of lines) {

      const match = line.match(/^(.+?)[:Ôºö]\s*(https?:\/\/.+)$/);
      if (match) {
        newFrames.push({
          name: match[1].trim(),
          url: match[2].trim()
        });
      } else if (line.trim()) {
        errorCount++;
      }
    }

    if (newFrames.length > 0) {
      await db.customAvatarFrames.bulkAdd(newFrames);
      populateFrameGrids(editingFrameForMember);
      await showCustomAlert("ÂØºÂÖ•ÊàêÂäü", `ÊàêÂäüÂØºÂÖ• ${newFrames.length} ‰∏™Êñ∞Â§¥ÂÉèÊ°ÜÔºÅ`);
    }

    if (errorCount > 0) {
      await showCustomAlert("ÈÉ®ÂàÜÂ§±Ë¥•", `Êúâ ${errorCount} Ë°åÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÂ∑≤Ë¢´ÂøΩÁï•„ÄÇ`);
    }
  }

  async function handleDeleteCustomFrame(frameId) {
    const frame = await db.customAvatarFrames.get(frameId);
    if (!frame) return;

    const confirmed = await showCustomConfirm(
      "Á°ÆËÆ§Âà†Èô§",
      `Á°ÆÂÆöË¶ÅÂà†Èô§Â§¥ÂÉèÊ°Ü ‚Äú${frame.name}‚Äù ÂêóÔºü`, {
        confirmButtonClass: 'btn-danger'
      }
    );

    if (confirmed) {
      await db.customAvatarFrames.delete(frameId);
      populateFrameGrids(editingFrameForMember);
    }
  }





  let currentPage = 0;
  const totalPages = 3;


  function setupHomeScreenPagination() {
    const pagesContainer = document.getElementById('home-screen-pages-container');
    const pages = document.getElementById('home-screen-pages');
    const dots = document.querySelectorAll('.pagination-dot');
    let startX = 0,
      startY = 0;
    let currentX = 0;
    let isDragging = false;
    let isClick = true;

    const updatePagination = () => {
      pages.style.transform = `translateX(-${currentPage * (100 / totalPages)}%)`;
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentPage);
      });
    };

    const onDragStart = (e) => {
      isDragging = true;
      isClick = true;
      startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      pages.style.transition = 'none';
    };

    const onDragMove = (e) => {
      if (!isDragging) return;

      const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      const diffX = currentX - startX;
      const diffY = currentY - startY;


      if (isClick && (Math.abs(diffX) > 10 || Math.abs(diffY) > 10)) {
        isClick = false;
      }


      if (Math.abs(diffX) > Math.abs(diffY)) {
        if (e.cancelable) e.preventDefault();
        pages.style.transform = `translateX(calc(-${currentPage * (100 / totalPages)}% + ${diffX}px))`;
      }
    };

    const onDragEnd = (e) => {
      if (!isDragging) return;
      isDragging = false;
      pages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';


      if (isClick) {
        updatePagination();

        return;
      }


      const diffX = currentX - startX;
      if (Math.abs(diffX) > pagesContainer.offsetWidth / 4) {
        if (diffX > 0 && currentPage > 0) {
          currentPage--;
        } else if (diffX < 0 && currentPage < totalPages - 1) {
          currentPage++;
        }
      }
      updatePagination();
    };

    pagesContainer.addEventListener('mousedown', onDragStart);
    pagesContainer.addEventListener('mousemove', onDragMove);
    pagesContainer.addEventListener('mouseup', onDragEnd);
    pagesContainer.addEventListener('mouseleave', onDragEnd);


    pagesContainer.addEventListener('touchstart', onDragStart, {
      passive: false
    });
    pagesContainer.addEventListener('touchmove', onDragMove, {
      passive: false
    });
    pagesContainer.addEventListener('touchend', onDragEnd);
  }



  let editingPresetId = null;

  async function openPresetScreen() {
    await renderPresetScreen();
    showScreen('preset-screen');
  }


  async function renderPresetScreen() {
    const tabsContainer = document.getElementById('preset-tabs');
    const contentContainer = document.getElementById('preset-content-container');
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    const [presets, categories] = await Promise.all([
      db.presets.toArray(),
      db.presetCategories.orderBy('name').toArray()
    ]);

    state.presets = presets;

    if (presets.length === 0) {
      contentContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™È¢ÑËÆæ</p>';
      return;
    }


    const allTab = document.createElement('button');
    allTab.className = 'world-book-tab active';
    allTab.textContent = 'ÂÖ®ÈÉ®';
    allTab.dataset.categoryId = 'all';
    tabsContainer.appendChild(allTab);

    const allPane = document.createElement('div');
    allPane.className = 'world-book-category-pane active';
    allPane.dataset.categoryId = 'all';
    contentContainer.appendChild(allPane);

    categories.forEach(category => {
      const categoryTab = document.createElement('button');
      categoryTab.className = 'world-book-tab';
      categoryTab.textContent = category.name;
      categoryTab.dataset.categoryId = String(category.id);
      tabsContainer.appendChild(categoryTab);

      const categoryPane = document.createElement('div');
      categoryPane.className = 'world-book-category-pane';
      categoryPane.dataset.categoryId = String(category.id);
      contentContainer.appendChild(categoryPane);
    });

    const hasUncategorized = presets.some(p => !p.categoryId);
    if (hasUncategorized) {
      const uncategorizedTab = document.createElement('button');
      uncategorizedTab.className = 'world-book-tab';
      uncategorizedTab.textContent = 'Êú™ÂàÜÁ±ª';
      uncategorizedTab.dataset.categoryId = 'uncategorized';
      tabsContainer.appendChild(uncategorizedTab);

      const uncategorizedPane = document.createElement('div');
      uncategorizedPane.className = 'world-book-category-pane';
      uncategorizedPane.dataset.categoryId = 'uncategorized';
      contentContainer.appendChild(uncategorizedPane);
    }


    presets.forEach(preset => {

      const contentPreview = `ËØ•È¢ÑËÆæÂåÖÂê´ ${preset.content.length} ‰∏™Êù°ÁõÆ„ÄÇ`;

      const card = document.createElement('div');
      card.className = 'world-book-card';
      card.innerHTML = `
            <div class="card-title">${preset.name}</div>
            <div class="card-content-preview">${contentPreview}</div>
        `;


      const cardClickHandler = () => openPresetEditor(preset.id);
      const cardLongPressHandler = async () => {
        const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${preset.name}„ÄãÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          await db.presets.delete(preset.id);
          state.presets = await db.presets.toArray();
          renderPresetScreen();
        }
      };

      card.addEventListener('click', cardClickHandler);
      addLongPressListener(card, cardLongPressHandler);

      const clonedCardForAll = card.cloneNode(true);
      clonedCardForAll.addEventListener('click', cardClickHandler);
      addLongPressListener(clonedCardForAll, cardLongPressHandler);
      allPane.appendChild(clonedCardForAll);

      const categoryKey = preset.categoryId ? String(preset.categoryId) : 'uncategorized';
      const targetPane = contentContainer.querySelector(`.world-book-category-pane[data-category-id="${categoryKey}"]`);
      if (targetPane) {
        targetPane.appendChild(card);
      }
    });



    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
      tab.addEventListener('click', () => switchPresetCategory(tab.dataset.categoryId));
    });
  }


  function switchPresetCategory(categoryId) {
    document.querySelectorAll('#preset-tabs .world-book-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.categoryId === categoryId);
    });
    document.querySelectorAll('#preset-content-container .world-book-category-pane').forEach(pane => {
      pane.classList.toggle('active', pane.dataset.categoryId === categoryId);
    });
  }


  async function openPresetEditor(presetId) {

    showScreen('preset-editor-screen');
    editingPresetId = presetId;

    try {

      const [preset, categories] = await Promise.all([
        db.presets.get(presetId),
        db.presetCategories.toArray()
      ]);


      if (!preset) {
        console.error("ÈîôËØØÔºöÂ∞ùËØïÊâìÂºÄ‰∏Ä‰∏™‰∏çÂ≠òÂú®ÁöÑÈ¢ÑËÆæÔºåID:", presetId);
        await showCustomAlert("Âä†ËΩΩÂ§±Ë¥•", "Êâæ‰∏çÂà∞Ëøô‰∏™È¢ÑËÆæÁöÑËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇ");
        showScreen('preset-screen');
        return;
      }



      setTimeout(() => {

        document.getElementById('preset-editor-title').textContent = preset.name;
        document.getElementById('preset-name-input').value = preset.name;

        const selectEl = document.getElementById('preset-category-select');
        selectEl.innerHTML = '<option value="">-- Êú™ÂàÜÁ±ª --</option>';
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.name;
          if (preset.categoryId === cat.id) option.selected = true;
          selectEl.appendChild(option);
        });

        const entriesContainer = document.getElementById('preset-entries-container');
        entriesContainer.innerHTML = '';
        if (Array.isArray(preset.content) && preset.content.length > 0) {
          preset.content.forEach(entry => {
            const block = createPresetEntryBlock(entry);
            entriesContainer.appendChild(block);
          });
        } else {
          entriesContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary); margin-top: 20px;">ËøòÊ≤°ÊúâÂÜÖÂÆπÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ</p>';
        }
      }, 50);

    } catch (error) {
      console.error("ÊâìÂºÄÈ¢ÑËÆæÁºñËæëÂô®Êó∂ÂèëÁîü‰∏•ÈáçÈîôËØØ:", error);
      await showCustomAlert("Âä†ËΩΩÂ§±Ë¥•", `Âä†ËΩΩÈ¢ÑËÆæËØ¶ÊÉÖÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
      showScreen('preset-screen');
    }
  }


  function createPresetEntryBlock(entry = {
    keys: [],
    comment: '',
    content: '',
    enabled: true
  }) {
    const block = document.createElement('div');
    block.className = 'message-editor-block';
    const isChecked = entry.enabled !== false ? 'checked' : '';


    block.innerHTML = `
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 5px;">
            <label class="toggle-switch" title="ÂêØÁî®/Á¶ÅÁî®Ê≠§Êù°ÁõÆ">
                <input type="checkbox" class="entry-enabled-switch" ${isChecked}>
                <span class="slider"></span>
            </label>
            <button type="button" class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°ÁõÆ">√ó</button>
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">Â§áÊ≥® (ÂèØÈÄâ)</label>
            <input type="text" class="entry-comment-input" value="${entry.comment || ''}" placeholder="‰æãÂ¶ÇÔºöËßíËâ≤Ê†∏ÂøÉËÆæÂÆö" style="padding: 8px;">
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
            <label style="font-size: 0.8em;">ÂÖ≥ÈîÆËØç (Áî®Ëã±ÊñáÈÄóÂè∑,ÂàÜÈöî)</label>
            <input type="text" class="entry-keys-input" value="${(entry.keys || []).join(', ')}" placeholder="‰æãÂ¶Ç: key1, key2" style="padding: 8px;">
        </div>
        
        <!-- ËøôÈáåÊòØÂÖ®Êñ∞ÁöÑ„ÄÅÂ∏¶Êúâ‚ÄúÂ±ïÂºÄ/Êî∂Ëµ∑‚ÄùÊåâÈíÆÁöÑÁªìÊûÑ -->
        <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 0.8em; display: flex; justify-content: space-between; align-items: center;">
                <span>ÂÜÖÂÆπ (ÁÇπÂáªÂè≥‰æßÂ±ïÂºÄ)</span>
                <button type="button" class="toggle-content-btn">Â±ïÂºÄ</button>
            </label>
            <div class="entry-content-container">
                 <textarea class="entry-content-textarea" rows="8" style="width: 100%; font-size: 14px;">${entry.content || ''}</textarea>
            </div>
        </div>
    `;



    block.querySelector('.delete-block-btn').addEventListener('click', () => block.remove());


    const toggleBtn = block.querySelector('.toggle-content-btn');
    const contentContainer = block.querySelector('.entry-content-container');
    toggleBtn.addEventListener('click', () => {
      const isHidden = contentContainer.style.display === 'none';
      contentContainer.style.display = isHidden ? 'block' : 'none';
      toggleBtn.textContent = isHidden ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ';
    });

    return block;
  }


  async function openPresetCategoryManager() {
    await renderPresetCategoriesInManager();

    document.querySelector('#group-management-modal .modal-header span').textContent = 'ÁÆ°ÁêÜÈ¢ÑËÆæÂàÜÁ±ª';
    document.getElementById('add-new-group-btn').onclick = addNewPresetCategory;
    document.getElementById('existing-groups-list').onclick = (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        deletePresetCategory(parseInt(e.target.dataset.id));
      }
    };
    document.getElementById('close-group-manager-btn').onclick = () => {
      document.getElementById('group-management-modal').classList.remove('visible');
      renderPresetScreen();
    };
    document.getElementById('group-management-modal').classList.add('visible');
  }

  async function renderPresetCategoriesInManager() {
    const listEl = document.getElementById('existing-groups-list');
    const categories = await db.presetCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `<span class="group-name">${cat.name}</span><span class="delete-group-btn" data-id="${cat.id}">√ó</span>`;
      listEl.appendChild(item);
    });
  }

  async function addNewPresetCategory() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) return alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
    const existing = await db.presetCategories.where('name').equals(name).first();
    if (existing) return alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
    await db.presetCategories.add({
      name
    });
    input.value = '';
    await renderPresetCategoriesInManager();
  }

  async function deletePresetCategory(categoryId) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÈ¢ÑËÆæÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.presetCategories.delete(categoryId);
      await db.presets.where('categoryId').equals(categoryId).modify({
        categoryId: null
      });


      state.presets = await db.presets.toArray();


      await renderPresetCategoriesInManager();
    }
  }



  async function handlePresetImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
      if (!file.name.endsWith('.json')) {
        throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊîØÊåÅ„ÄÇËØ∑ÈÄâÊã© .json Ê†ºÂºèÁöÑ Tavern È¢ÑËÆæÊñá‰ª∂„ÄÇ");
      }

      const text = await file.text();
      const tavernData = JSON.parse(text);


      await importTavernPresetFile(tavernData, file.name);

    } catch (error) {
      console.error("È¢ÑËÆæÂØºÂÖ•Â§±Ë¥•:", error);
      await showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", `Êó†Ê≥ïËß£ÊûêÈ¢ÑËÆæÊñá‰ª∂„ÄÇ\nÈîôËØØ: ${error.message}`);
    } finally {

      event.target.value = null;
    }
  }


  async function importTavernPresetFile(tavernData, fileName) {
    let newEntries = [];




    if (Array.isArray(tavernData.prompts) && Array.isArray(tavernData.prompt_order) && tavernData.prompt_order.length > 0) {
      console.log("Ê£ÄÊµãÂà∞ Tavern/SillyTavern È¢ÑËÆæÊ†ºÂºèÔºåÂ∞Ü‰∏•Ê†ºÊåâÁÖß prompt_order ÊéíÂ∫è„ÄÇ");


      const promptsMap = new Map(tavernData.prompts.map(p => [p.identifier, p]));


      const orderArray = tavernData.prompt_order.reduce((acc, curr) => (
        (curr.order && curr.order.length > (acc.length || 0)) ? curr.order : acc
      ), []);

      if (orderArray && orderArray.length > 0) {
        newEntries = orderArray
          .map(orderItem => {

            const promptData = promptsMap.get(orderItem.identifier);
            if (promptData) {

              return {
                keys: [],
                comment: promptData.name || 'Êó†Ê†áÈ¢ò',
                content: promptData.content || '',

                enabled: orderItem.enabled
              };
            }
            return null;
          })
          .filter(Boolean);
      }
    } else if (tavernData.entries && typeof tavernData.entries === 'object') {
      console.log("Ê£ÄÊµãÂà∞ 'entries' ÂØπË±°Ê†ºÂºèÁöÑÈ¢ÑËÆæÔºåÂ∞ÜÂ∞ùËØïÊåâÈ°∫Â∫èÂØºÂÖ•„ÄÇ");
      if (Array.isArray(tavernData.order)) {
        console.log("Ê£ÄÊµãÂà∞ 'order' Â≠óÊÆµÔºåÂ∞ÜÊåâÊåáÂÆöÈ°∫Â∫èÂØºÂÖ•Êù°ÁõÆ„ÄÇ");
        newEntries = tavernData.order
          .map(key => tavernData.entries[key])
          .filter(Boolean)
          .map(entry => ({
            keys: entry.key || [],
            comment: entry.comment || 'Êó†Â§áÊ≥®',
            content: entry.content || '',
            enabled: !entry.disable
          }));
      } else {
        console.warn("Êú™Âú®Êñá‰ª∂‰∏≠ÊâæÂà∞ 'order' Â≠óÊÆµÔºåÊù°ÁõÆÂèØËÉΩÊó†Ê≥ïÊåâÂéüÂßãÈ°∫Â∫èÂØºÂÖ•„ÄÇ");
        newEntries = Object.values(tavernData.entries).map(entry => ({
          keys: entry.key || [],
          comment: entry.comment || 'Êó†Â§áÊ≥®',
          content: entry.content || '',
          enabled: !entry.disable
        }));
      }
    } else if (Array.isArray(tavernData.prompts)) {
      console.log("Ê£ÄÊµãÂà∞ÁÆÄÂçïÁöÑ 'prompts' Êï∞ÁªÑÊ†ºÂºèÔºåÂ∞ÜÊåâÊï∞ÁªÑÂÜÖÈ°∫Â∫èÂØºÂÖ•„ÄÇ");
      newEntries = tavernData.prompts.map(prompt => ({
        keys: [],
        comment: prompt.name || 'Êó†Ê†áÈ¢ò',
        content: prompt.content || '',
        enabled: true
      }));
    } else {
      throw new Error("Êñá‰ª∂Ê†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇÊú™ÊâæÂà∞ÊúâÊïàÁöÑ 'prompts' Êï∞ÁªÑÊàñ 'entries' ÂØπË±°„ÄÇ");
    }



    newEntries = newEntries.filter(entry => entry.content);

    if (newEntries.length === 0) {
      alert("Ëøô‰∏™È¢ÑËÆæÊñá‰ª∂‰∏≠Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÊúâÊïàÁöÑÊèêÁ§∫ËØçÊù°ÁõÆ„ÄÇ");
      return;
    }


    const presetNameSuggestion = fileName.replace(/\.json$/i, '');
    const newPresetName = await showCustomPrompt("ÂØºÂÖ• Tavern È¢ÑËÆæ", "ËØ∑‰∏∫ËøôÁªÑÊèêÁ§∫ËØçÈ¢ÑËÆæÂëΩÂêçÔºö", presetNameSuggestion);
    if (!newPresetName || !newPresetName.trim()) {
      alert("ÂØºÂÖ•Â∑≤ÂèñÊ∂àÔºåÂõ†‰∏∫Êú™Êèê‰æõÂêçÁß∞„ÄÇ");
      return;
    }

    const newPreset = {
      id: 'preset_' + Date.now(),
      name: newPresetName.trim(),
      content: newEntries,
      categoryId: null
    };

    await db.presets.add(newPreset);
    state.presets.push(newPreset);

    await renderPresetScreen();
    await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', `Â∑≤ÊàêÂäü‰ªéÊñá‰ª∂ÂØºÂÖ•È¢ÑËÆæ„Ää${newPresetName}„Äã„ÄÇ`);
  }



  async function renderOfflinePresetSelector(chat) {
    const selectEl = document.getElementById('offline-preset-select');
    if (!selectEl) return;


    const presets = state.presets || [];


    selectEl.innerHTML = '<option value="">-- ‰∏ç‰ΩøÁî®È¢ÑËÆæ --</option>';
    presets.forEach(preset => {
      const option = document.createElement('option');
      option.value = preset.id;
      option.textContent = preset.name;
      selectEl.appendChild(option);
    });


    if (chat.settings.offlinePresetId) {
      selectEl.value = chat.settings.offlinePresetId;
    }
  }


  function renderButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    editor.innerHTML = '';



    let buttonOrder = state.globalSettings.chatActionButtonsOrder || DEFAULT_BUTTON_ORDER;

    buttonOrder.forEach(buttonId => {
      const originalButton = document.getElementById(buttonId);
      if (originalButton) {
        const item = document.createElement('div');
        item.className = 'draggable-button-item';
        item.draggable = true;
        item.dataset.buttonId = buttonId;
        item.innerHTML = originalButton.innerHTML;
        editor.appendChild(item);
      }
    });
  }



  function initializeButtonOrderEditor() {
    const editor = document.getElementById('button-order-editor');
    if (!editor) return;

    let draggingItem = null;


    const handleDragStart = (e) => {
      const target = e.target.closest('.draggable-button-item');
      if (!target) return;

      draggingItem = target;
      draggingItem.classList.add('dragging');


      if (e.cancelable) e.preventDefault();
    };

    const handleDragMove = (e) => {
      if (!draggingItem) return;


      const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;

      const afterElement = getDragAfterElement(editor, clientX);

      if (afterElement == null) {
        editor.appendChild(draggingItem);
      } else {
        editor.insertBefore(draggingItem, afterElement);
      }
    };

    const handleDragEnd = () => {
      if (!draggingItem) return;

      draggingItem.classList.remove('dragging');
      draggingItem = null;


      saveButtonOrder();
    };



    editor.addEventListener('mousedown', handleDragStart);
    editor.addEventListener('touchstart', handleDragStart, {
      passive: false
    });


    editor.addEventListener('mousemove', handleDragMove);
    editor.addEventListener('touchmove', handleDragMove, {
      passive: false
    });


    editor.addEventListener('mouseup', handleDragEnd);
    editor.addEventListener('mouseleave', handleDragEnd);
    editor.addEventListener('touchend', handleDragEnd);
  }



  function getDragAfterElement(container, x) {

    const draggableElements = [...container.querySelectorAll('.draggable-button-item:not(.dragging)')];


    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();

      const offset = x - box.left - box.width / 2;


      if (offset < 0 && offset > closest.offset) {
        return {
          offset: offset,
          element: child
        };
      } else {
        return closest;
      }
    }, {
      offset: Number.NEGATIVE_INFINITY
    }).element;
  }


  async function saveButtonOrder() {
    const editor = document.getElementById('button-order-editor');
    const newOrder = Array.from(editor.querySelectorAll('.draggable-button-item')).map(item => item.dataset.buttonId);

    state.globalSettings.chatActionButtonsOrder = newOrder;
    await db.globalSettings.put(state.globalSettings);



  }

 
  function applyButtonOrder() {
    const buttonOrder = state.globalSettings.chatActionButtonsOrder;
    if (!buttonOrder || !Array.isArray(buttonOrder) || buttonOrder.length === 0) {
      return;
    }

    const container = document.getElementById('chat-input-actions-top');
    if (!container) return;


    buttonOrder.forEach(buttonId => {
      const button = document.getElementById(buttonId);
      if (button) {
        container.appendChild(button);
      }
    });
  }



  const DEFAULT_BUTTON_ORDER = [
    'open-sticker-panel-btn', 'send-photo-btn', 'upload-image-btn',
    'transfer-btn', 'voice-message-btn', 'send-waimai-request-btn',
    'video-call-btn', 'group-video-call-btn', 'send-poll-btn',
    'share-link-btn', 'share-location-btn', 'gomoku-btn',
    'open-shopping-btn', 'pat-btn', 'edit-last-response-btn',
    'regenerate-btn', 'propel-btn', 'show-announcement-board-btn',
    'werewolf-game-btn',

    'read-together-btn',
    'open-nai-gallery-btn',
    'open-todo-list-btn',
    'open-quick-reply-btn'
  ];


  async function resetButtonOrder() {

    state.globalSettings.chatActionButtonsOrder = null;
    await db.globalSettings.put(state.globalSettings);


    renderButtonOrderEditor();


    applyButtonOrder();


    await showCustomAlert("ÊàêÂäü", "ÊåâÈíÆÈ°∫Â∫èÂ∑≤ÊÅ¢Â§ç‰∏∫ÈªòËÆ§ËÆæÁΩÆÔºÅ");
  }





  let selectedCharsForClear = [];
  let selectedTypesForClear = [];


  function openDataClearWizard() {
    const modal = document.getElementById('data-clear-wizard-modal');
    selectedCharsForClear = [];
    selectedTypesForClear = [];


    renderClearWizardStep1();


    document.getElementById('data-clear-step-1').style.display = 'flex';
    document.getElementById('data-clear-step-2').style.display = 'none';

    modal.classList.add('visible');
  }


  function renderClearWizardStep1() {
    const listEl = document.getElementById('data-clear-char-list');
    listEl.innerHTML = '';


    const userItem = document.createElement('div');
    userItem.className = 'clear-posts-item';
    userItem.dataset.charId = 'user';
    userItem.innerHTML = `
        <div class="checkbox"></div>
        <span class="name">${state.qzoneSettings.nickname || 'Êàë'} (Áî®Êà∑)</span>
    `;
    listEl.appendChild(userItem);


    Object.values(state.chats).forEach(chat => {
      if (!chat.isGroup) {
        const charItem = document.createElement('div');
        charItem.className = 'clear-posts-item';
        charItem.dataset.charId = chat.id;
        charItem.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">${chat.name} (ËßíËâ≤)</span>
            `;
        listEl.appendChild(charItem);
      }
    });
  }


  function renderClearWizardStep2() {
    const listEl = document.getElementById('data-clear-type-list');
    listEl.innerHTML = '';

    const dataTypes = [{
        id: 'chat',
        name: 'ËÅäÂ§©ËÆ∞ÂΩï',
        description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÂØπËØùÊ∂àÊÅØ„ÄÅÊõæÁî®Â§áÊ≥®Âíå‰Ω†ÁöÑÊòµÁß∞„ÄÇ'
      },
      {
        id: 'qzone',
        name: 'Âä®ÊÄÅ‰∏é‰∫íÂä®',
        description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÂä®ÊÄÅ„ÄÅËØÑËÆ∫ÂíåÁÇπËµû„ÄÇ'
      },
      {
        id: 'calls',
        name: 'ÈÄöËØùËÆ∞ÂΩï',
        description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÈÄöËØùËÆ∞ÂΩï„ÄÇ'
      },
      {
        id: 'thoughts',
        name: 'ÂøÉÂ£∞',
        description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÂøÉÂ£∞ÂíåÊï£ËÆ∞ÂéÜÂè≤„ÄÇ'
      },
      {
        id: 'memories',
        name: 'ÈïøÊúüËÆ∞ÂøÜ',
        description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÊâÄÊúâÈïøÊúüËÆ∞ÂøÜ„ÄÇ'
      },
      {
        id: 'favorites',
        name: 'Êî∂Ëóè',
        description: 'Â∞ÜÊ∏ÖÁ©∫Êî∂ËóèÂ§π‰∏≠ÊâÄÊúâ‰∏éËØ•ËßíËâ≤Áõ∏ÂÖ≥ÁöÑÂÜÖÂÆπÔºàÂ¶ÇËÅäÂ§©„ÄÅÂä®ÊÄÅ„ÄÅÊó•ËÆ∞Á≠âÔºâ„ÄÇ'
      },
      {
        id: 'cphone',
        name: 'CphoneÊï∞ÊçÆ (CPhone)',
        description: 'Â∞ÜÊ∏ÖÁ©∫ËßíËâ≤ÁöÑÁõ∏ÂÜå„ÄÅQQ„ÄÅÊµèËßàÂô®„ÄÅÊ∑òÂÆù„ÄÅÊó•ËÆ∞„ÄÅÂ§áÂøòÂΩïÁ≠âÊâÄÊúâÊ®°ÊãüÊâãÊú∫Êï∞ÊçÆ„ÄÇ'
      },
      {
        id: 'todo',
        name: 'ÂæÖÂäû‰∫ãÈ°π (To-Do)',
        description: 'Â∞ÜÊ∏ÖÁ©∫ÈÄâÂÆöËßíËâ≤ÁöÑÂæÖÂäû‰∫ãÈ°πÊ∏ÖÂçï„ÄÇ(Ëã•Á¨¨‰∏ÄÊ≠•ÈÄâ‚ÄúÊàë‚ÄùÔºåÂàôÊ∏ÖÈô§ÊâÄÊúâËßíËâ≤‰∏≠Áî±‚ÄúÊàë‚ÄùÂàõÂª∫ÁöÑÂæÖÂäû)'
      },
       {
            id: 'alipay_bills',
            name: 'ÊîØ‰ªòÂÆùË¥¶Âçï (Alipay)',
            description: 'Â∞ÜÊ∏ÖÁ©∫ÊîØ‰ªòÂÆùÁöÑÊâÄÊúâ‰∫§ÊòìÊµÅÊ∞¥„ÄÅËΩ¨Ë¥¶ËÆ∞ÂΩïÂíåÂü∫Èáë‰π∞ÂçñËÆ∞ÂΩï„ÄÇ(‰ªÖÂú®Á¨¨‰∏ÄÊ≠•ÈÄâÊã©‚ÄúÊàë‚ÄùÊó∂ÁîüÊïà)'
        }
    ];

    dataTypes.forEach(type => {
      const item = document.createElement('div');
      item.className = 'clear-posts-item';
      item.dataset.typeId = type.id;
      item.innerHTML = `
                    <div class="checkbox"></div>
                    <div>
                        <span class="name">${type.name}</span>
                        <p style="font-size: 12px; color: #888; margin: 4px 0 0;">${type.description}</p>
                    </div>
                `;
      listEl.appendChild(item);
    });
  }



  function handleDataClearNext() {
    const selectedItems = document.querySelectorAll('#data-clear-char-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∏ÖÁêÜÁöÑËßíËâ≤„ÄÇ");
      return;
    }

    selectedCharsForClear = Array.from(selectedItems).map(item => item.dataset.charId);


    renderClearWizardStep2();
    document.getElementById('data-clear-step-1').style.display = 'none';
    document.getElementById('data-clear-step-2').style.display = 'flex';
  }


  function handleDataClearBack() {
    document.getElementById('data-clear-step-2').style.display = 'none';
    document.getElementById('data-clear-step-1').style.display = 'flex';

    document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
      if (selectedCharsForClear.includes(item.dataset.charId)) {
        item.classList.add('selected');
      }
    });
  }


  async function handleConfirmDataClear() {
    const selectedItems = document.querySelectorAll('#data-clear-type-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏ÄÁßçË¶ÅÊ∏ÖÁêÜÁöÑÊï∞ÊçÆÁ±ªÂûã„ÄÇ");
      return;
    }

    selectedTypesForClear = Array.from(selectedItems).map(item => item.dataset.typeId);

    const confirmed = await showCustomConfirm(
      'ÊúÄÂêéÁ°ÆËÆ§ÔºÅ',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊÇ®ÈÄâÊã©ÁöÑÊâÄÊúâÊï∞ÊçÆÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Âà†Èô§'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÊ∏ÖÁêÜÊìç‰ΩúÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠È°µÈù¢...");

    try {
      await db.transaction('rw', db.tables, async () => {
        for (const charId of selectedCharsForClear) {
          for (const type of selectedTypesForClear) {
            if (type === 'todo') {
                if (charId === 'user') {
                    // Â¶ÇÊûúÁ¨¨‰∏ÄÊ≠•ÈÄâÁöÑÊòØ‚ÄúÊàë (Áî®Êà∑)‚ÄùÔºåÂàôÈÅçÂéÜÊâÄÊúâËÅäÂ§©ÔºåÂè™Âà†Èô§ creator ‰∏∫ 'user' ÁöÑÂæÖÂäû
                    const allChats = await db.chats.toArray();
                    for (const chat of allChats) {
                        if (chat.todoList && chat.todoList.length > 0) {
                            const originalLength = chat.todoList.length;
                            // ËøáÊª§ÊéâÁî®Êà∑ÂàõÂª∫ÁöÑÔºå‰øùÁïôAIÂàõÂª∫ÁöÑ
                            chat.todoList = chat.todoList.filter(t => t.creator !== 'user');
                            
                            if (chat.todoList.length < originalLength) {
                                await db.chats.put(chat);
                            }
                        }
                    }
                    console.log("Â∑≤Ê∏ÖÁêÜÊâÄÊúâÁî±Áî®Êà∑ÂàõÂª∫ÁöÑÂæÖÂäû‰∫ãÈ°π");
                } else {
                    // Â¶ÇÊûúÈÄâÁöÑÊòØÂÖ∑‰ΩìËßíËâ≤ÔºåÁõ¥Êé•Ê∏ÖÁ©∫ËØ•ËßíËâ≤ÁöÑÂæÖÂäûÂàóË°® (todoList)
                    const chat = await db.chats.get(charId);
                    if (chat) {
                        chat.todoList = []; // Áõ¥Êé•ÁΩÆÁ©∫
                        await db.chats.put(chat);
                        console.log(`Â∑≤Ê∏ÖÁ©∫ËßíËâ≤ ${chat.name} ÁöÑÂæÖÂäû‰∫ãÈ°π`);
                    }
                }
            }
            if (type === 'alipay_bills') {
                // Âè™ÊúâÂΩìÁ¨¨‰∏ÄÊ≠•ÈÄâÊã©‰∫Ü‚ÄúÊàë(Áî®Êà∑)‚ÄùÊó∂ÔºåÊâçÊâßË°åÊ∏ÖÁ©∫ÔºåÈò≤Ê≠¢ËØØÊìç‰Ωú
                if (charId === 'user') {
                    await db.userTransactions.clear(); // Ê∏ÖÁ©∫Ë¥¶ÂçïË°®
                    console.log("ÊîØ‰ªòÂÆùË¥¶ÂçïÂ∑≤ÂÖ®ÈÉ®Ê∏ÖÁ©∫");
                    
                    // ÂèØÈÄâÔºöÂ¶ÇÊûú‰Ω†ËøòÊÉ≥ÈáçÁΩÆÈí±ÂåÖ‰ΩôÈ¢ùÂíåÂü∫ÈáëÊåÅ‰ªìÔºåÂèØ‰ª•Ëß£ÂºÄ‰∏ãÈù¢Ê≥®Èáä
                    /*
                    const wallet = await db.userWallet.get('main');
                    if(wallet) {
                        wallet.balance = 0; // ÈáçÁΩÆ‰ΩôÈ¢ù
                        wallet.fundHoldings = []; // ÈáçÁΩÆÂü∫Èáë
                        await db.userWallet.put(wallet);
                    }
                    */
                } else {
                    // Â¶ÇÊûúÈÄâÊã©‰∫ÜÊüê‰∏™ËßíËâ≤ÔºåÂ∞ùËØïÂà†Èô§ËØ•ËßíËâ≤ÂêçÂ≠óÁõ∏ÂÖ≥ÁöÑË¥¶Âçï(Ê®°Á≥äÂåπÈÖç)
                    // Ê≥®ÊÑèÔºöËøô‰æùËµñ‰∫édescriptionÂåÖÂê´ËßíËâ≤ÂêçÔºåÂèØËÉΩ‰∏çÂÆåÂÖ®ÂáÜÁ°ÆÔºåÂª∫ËÆÆÂè™Áî®‰∏äÈù¢ÁöÑÊ∏ÖÁ©∫ÂÖ®ÈÉ®
                    const chat = await db.chats.get(charId);
                    if (chat) {
                        const nameKeys = [chat.name, chat.originalName];
                        // ËøôÊòØ‰∏Ä‰∏™ÊØîËæÉËÄóÊó∂ÁöÑËøáÊª§Âà†Èô§Ôºå‰ΩÜÂØπ‰∫éÊ∏ÖÁêÜÁâπÂÆöËßíËâ≤ÊµÅÊ∞¥ÂæàÊúâÁî®
                        await db.userTransactions
                            .filter(t => nameKeys.some(k => t.description && t.description.includes(k)))
                            .delete();
                    }
                }
            }
            if (type === 'chat') {
              if (charId === 'user') {
                const allChats = await db.chats.toArray();
                for (const chat of allChats) {
                  chat.history = chat.history.filter(msg => msg.role !== 'user');
                  await db.chats.put(chat);
                }
              } else {
                const chat = await db.chats.get(charId);
                if (chat) {
                  chat.history = [];
                  chat.heartfeltVoice = '...';
                  chat.randomJottings = '...';
                  if (Array.isArray(chat.nameHistory)) {
                    chat.nameHistory = [];
                  }
                  if (chat.settings) {
                    chat.settings.myNickname = 'Êàë';
                  }
                  await db.chats.put(chat);
                }
              }
            }

            if (type === 'qzone') {
              const authorId = (charId === 'user') ? 'user' : charId;
              await db.qzonePosts.where('authorId').equals(authorId).delete();
            }

            if (type === 'calls' && charId !== 'user') {
              await db.callRecords.where('chatId').equals(charId).delete();
            }

            if (type === 'thoughts' && charId !== 'user') {
              const chat = await db.chats.get(charId);
              if (chat) {
                chat.thoughtsHistory = [];
                chat.heartfeltVoice = '...';
                chat.randomJottings = '...';
                await db.chats.put(chat);
              }
            }

            if (type === 'memories' && charId !== 'user') {
              const chat = await db.chats.get(charId);
              if (chat) {
                chat.longTermMemory = [];
                await db.chats.put(chat);
              }
            }


            if (type === 'favorites') {
              if (charId === 'user') {

                await db.favorites.where('type').equals('qzone_post').filter(fav => fav.content.authorId === 'user').delete();

                await db.favorites.where('type').equals('chat_message').filter(fav => fav.content.role === 'user').delete();
              } else {

                await db.favorites.where('type').equals('chat_message').and(fav => fav.chatId === charId).delete();

                await db.favorites.where('type').equals('qzone_post').filter(fav => fav.content.authorId === charId).delete();

                await db.favorites.where('type').equals('char_diary').filter(fav => fav.content.characterId === charId).delete();
                await db.favorites.where('type').equals('char_browser_article').filter(fav => fav.content.characterId === charId).delete();
                await db.favorites.where('type').equals('char_memo').filter(fav => fav.content.characterId === charId).delete();
              }
            }


            if (type === 'cphone' && charId !== 'user') {
              const chat = await db.chats.get(charId);
              if (chat) {
                chat.simulatedAlbum = [];
                chat.simulatedConversations = [];
                chat.simulatedBrowserHistory = [];
                chat.simulatedTaobaoHistory = null;
                chat.simulatedAmapHistory = [];
                chat.simulatedAppUsage = [];
                chat.simulatedMusicPlaylist = [];
                chat.diary = [];
                chat.memos = [];
                await db.chats.put(chat);
              }
            }
          }
        }
      });

      await loadAllDataFromDB();
      await renderChatList();
      const alipayScreen = document.getElementById('alipay-screen');
      if (alipayScreen && alipayScreen.classList.contains('active')) {
          // Â¶ÇÊûú‰Ω†‰πãÂâçÂÆö‰πâ‰∫Ü loadBills ÂáΩÊï∞
          if (typeof loadBills === 'function') {
              await loadBills(true); // true ‰ª£Ë°®ÈáçÁΩÆÂπ∂ÈáçÊñ∞Âä†ËΩΩ
          }
          // ÂêåÊó∂Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫ÔºàÂ¶ÇÊûúÂàöÊâçËß£ÂºÄ‰∫ÜÈáçÁΩÆ‰ΩôÈ¢ùÁöÑÊ≥®ÈáäÔºâ
          if (window.userBalance !== undefined) {
             const wallet = await db.userWallet.get('main');
             if(wallet) {
                 window.userBalance = wallet.balance;
                 document.getElementById('alipay-balance-display').textContent = window.userBalance.toFixed(2);
             }
          }
      }
      document.getElementById('data-clear-wizard-modal').classList.remove('visible');
      await showCustomAlert("Ê∏ÖÁêÜÂÆåÊàê", "ÊåáÂÆöÁöÑÊï∞ÊçÆÂ∑≤ÊàêÂäüÊ∏ÖÈô§„ÄÇ");

    } catch (error) {
      console.error("È´òÁ∫ßÊï∞ÊçÆÊ∏ÖÁêÜÂ§±Ë¥•:", error);
      await showCustomAlert("Ê∏ÖÁêÜÂ§±Ë¥•", `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }

  async function handleIconChange(iconId, phoneType, itemElement) {
    const appName = itemElement.querySelector('.icon-preview').alt;

    const choice = await showChoiceModal(`Êõ¥Êç¢‚Äú${appName}‚ÄùÂõæÊ†á`, [
        { text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†', value: 'local' },
        { text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL', value: 'url' }
    ]);

    let newUrl = null;
    let isBase64 = false;

    if (choice === 'local') {
        newUrl = await new Promise(resolve => { // ÁÆÄÂåñÁâà uploadImageLocally
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => resolve(readerEvent.target.result);
                    reader.readAsDataURL(file);
                } else {
                    resolve(null);
                }
            };
            input.click();
        });
        if (newUrl) isBase64 = true;
        
    } else if (choice === 'url') {
        const currentUrl = (phoneType === 'cphone') ?
            state.globalSettings.cphoneAppIcons[iconId] :
            state.globalSettings.appIcons[iconId];
        const isCurrentUrlBase64 = currentUrl && currentUrl.startsWith('data:image'); 
        
        const initialValueForPrompt = isCurrentUrlBase64 ? '' : currentUrl;
        
        newUrl = await showCustomPrompt(`Êõ¥Êç¢ÂõæÊ†á`, 'ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURL', initialValueForPrompt, 'url');
        
     
        if (newUrl) isBase64 = false;
    }

    if (newUrl && newUrl.trim()) {
        const trimmedUrl = newUrl.trim();
        
        
        itemElement.querySelector('.icon-preview').src = trimmedUrl;

       
        const dbPath = (phoneType === 'cphone') ? `cphoneAppIcons.${iconId}` : `appIcons.${iconId}`;
        if (phoneType === 'cphone') {
            state.globalSettings.cphoneAppIcons[iconId] = trimmedUrl;
        } else {
            state.globalSettings.appIcons[iconId] = trimmedUrl;
        }
        await db.globalSettings.put(state.globalSettings);
        await showCustomAlert("ÊàêÂäü", "ÂõæÊ†áÂ∑≤Êõ¥Êñ∞ÔºÅ");

        
        if (isBase64) {
            (async () => {
                console.log(`[ImgBB] ÂêØÂä® ${dbPath} ÁöÑÈùôÈªò‰∏ä‰º†...`);
                await silentlyUpdateDbUrl(
                    db.globalSettings,
                    'main',
                    dbPath,
                    trimmedUrl // The Base64 string
                );
            })();
        }
    } else if (newUrl !== null) {
        alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑURLÊàñÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂ÔºÅ");
    }
  }


  async function compressAllLocalImages() {

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§ÂéãÁº©ÂõæÁâáÔºü',
      'Ê≠§Êìç‰ΩúÂ∞ÜÊâ´ÊèèÂπ∂ÂéãÁº©ÊâÄÊúâÊú¨Âú∞‰∏ä‰º†ÁöÑÂõæÁâáÔºàBase64Ê†ºÂºèÔºâÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫JPEG‰ª•ÂáèÂ∞è‰ΩìÁßØ„ÄÇËøô‰ºöËΩªÂæÆÈôç‰ΩéÂõæÁâáË¥®Èáè‰∏î„Äê‰∏çÂèØÊÅ¢Â§ç„Äë„ÄÇ<br><br><strong>Âº∫ÁÉàÂª∫ËÆÆÂú®Êìç‰ΩúÂâçÂÖàËøõË°åÊï∞ÊçÆÂ§á‰ªΩÔºÅ</strong>', {
        confirmButtonClass: 'btn-danger',
        confirmText: 'ÊàëÂ∑≤‰∫ÜËß£È£éÈô©ÔºåÁ°ÆËÆ§ÂéãÁº©'
      }
    );

    if (!confirmed) return;


    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÂºÄÂßãÂÖ®Èù¢ÂéãÁº©ÂõæÁâáÔºåÊ†πÊçÆÂõæÁâáÊï∞ÈáèÔºåËøôÂèØËÉΩÈúÄË¶ÅÂá†ÂàÜÈíüÊó∂Èó¥ÔºåËØ∑‰∏çË¶ÅÂÖ≥Èó≠ÊàñÂà∑Êñ∞È°µÈù¢...");

    let stats = {
      found: 0,
      compressed: 0,
      skipped: 0,
      originalSize: 0,
      newSize: 0
    };

    try {





      console.log("ÂéãÁº©Ê≠•È™§ 1/3: Ê≠£Âú®‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆ...");
      const tablesToScan = [
        'chats', 'globalSettings', 'qzoneSettings',
        'userStickers', 'customAvatarFrames'
      ];
      const allData = [];
      for (const tableName of tablesToScan) {
        const table = db.table(tableName);
        const records = await table.toArray();
        allData.push({
          tableName,
          records
        });
      }


      console.log("ÂéãÁº©Ê≠•È™§ 2/3: Ê≠£Âú®ÂÜÖÂ≠ò‰∏≠ÂºÇÊ≠•ÂéãÁº©ÂõæÁâáÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥...");
      for (const data of allData) {
        for (const record of data.records) {

          await traverseAndCompress(record, stats);
        }
      }


      console.log("ÂéãÁº©Ê≠•È™§ 3/3: Ê≠£Âú®Â∞ÜÂéãÁº©ÂêéÁöÑÊï∞ÊçÆÂÜôÂõûÊï∞ÊçÆÂ∫ì...");
      await db.transaction('rw', tablesToScan, async () => {
        for (const data of allData) {

          await db.table(data.tableName).bulkPut(data.records);
        }
      });






      const reduction = stats.originalSize - stats.newSize;
      const reductionPercent = stats.originalSize > 0 ? (reduction / stats.originalSize * 100).toFixed(2) : 0;

      await showCustomAlert(
        'ÂéãÁº©ÂÆåÊàêÔºÅ',
        `Êâ´ÊèèÂÆåÊàêÔºÅ<br>
            - ÂÖ±ÊâæÂà∞ ${stats.found} Âº†Êú¨Âú∞ÂõæÁâá<br>
            - ÊàêÂäüÂéãÁº© ${stats.compressed} Âº†<br>
            - Ë∑≥Ëøá(Â∑≤ÂéãÁº©ÊàñÊó†ÈúÄÂéãÁº©) ${stats.skipped} Âº†<br>
            - Á©∫Èó¥ËäÇÁúÅ‰∫Ü <strong>${(reduction / 1024 / 1024).toFixed(2)} MB</strong> (ÂéãÁº©Áéá ${reductionPercent}%)
            <br><br>
            Âª∫ËÆÆÂà∑Êñ∞È°µÈù¢‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ`
      );

    } catch (error) {
      console.error("ÂõæÁâáÂéãÁº©ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:", error);
      await showCustomAlert('ÂéãÁº©Â§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }

  function calculateTotalSizeRecursive(obj, parentKey = '') {
    let totalSize = 0;
    for (const key in obj) {
      if (obj.hasOwnProperty(key)) {
        const value = obj[key];
        if (typeof value === 'string' && value.startsWith('data:image')) {

     
          const isExcluded =
          
            (parentKey === 'globalSettings' && (key === 'wallpaper' || key === 'cphoneWallpaper' || key === 'globalChatBackground')) ||
        
            (parentKey === 'widgetData') ||
      
            (parentKey === 'settings' && key === 'background') ||
       
            (parentKey === 'appIcons' || parentKey === 'cphoneAppIcons');

          if (!isExcluded) {
            totalSize += value.length;
          }
      

        } else if (typeof value === 'object' && value !== null) {
        
          totalSize += calculateTotalSizeRecursive(value, key);
        }
      }
    }
    return totalSize;
  }


  async function displayTotalImageSize() {
    const displayElement = document.getElementById('total-image-size-display');
    if (!displayElement) return;

    displayElement.innerHTML = `
        <span id="image-size-label">Ê≠£Âú®ËÆ°ÁÆóÂèØÂéãÁº©ÂõæÁâáÂ§ßÂ∞è...</span>
        <span id="image-size-value">-- MB</span>
    `;

    try {
      let totalBytes = 0;
      const tablesToScan = [
        'chats', 'globalSettings', 'qzoneSettings',
        'userStickers', 'customAvatarFrames'
      ];

      for (const tableName of tablesToScan) {
        const table = db.table(tableName);
        await table.each(record => {

          totalBytes += calculateTotalSizeRecursive(record);
        });
      }

      const totalMB = (totalBytes / 1024 / 1024).toFixed(2);

      displayElement.innerHTML = `
            <span id="image-size-label">Êú¨Âú∞ÂõæÁâá(Â§¥ÂÉè/Ë°®ÊÉÖ/Â§¥ÂÉèÊ°Ü/Á≠â)Â§ßÂ∞è:</span>
            <span id="image-size-value"><strong>${totalMB} MB</strong></span>
        `;

    } catch (error) {
      console.error("ËÆ°ÁÆóÂõæÁâáÊÄªÂ§ßÂ∞èÊó∂Âá∫Èîô:", error);
      displayElement.innerHTML = `
            <span id="image-size-label">ËÆ°ÁÆóÂõæÁâáÂ§ßÂ∞èÊó∂Âá∫Èîô</span>
            <span id="image-size-value">Error</span>
        `;
    }
  }

function calculateSkippedStats(obj) {
    let found = 0;
    let size = 0;
    if (typeof obj !== 'object' || obj === null) return {
        found,
        size
    };

    for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
            const value = obj[key];
            if (typeof value === 'string' && value.startsWith('data:image')) {
                found++;
                size += value.length;
            } else if (typeof value === 'object' && value !== null) {
                const nestedStats = calculateSkippedStats(value);
                found += nestedStats.found;
                size += nestedStats.size;
            }
        }
    }
    return {
        found,
        size
    };
}

 async function traverseAndCompress(obj, stats, parentKey = '') {
    
    for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
            
          
            if (parentKey === '' && (key === 'widgetData' || key === 'appIcons' || key === 'cphoneAppIcons')) {
                console.log(`Ë∑≥ËøáÂéãÁº©Êï¥‰∏™ÂØπË±°: ${key}`);
                const {
                    found,
                    size
                } = calculateSkippedStats(obj[key]);
                stats.found += found;
                stats.skipped += found;
                stats.originalSize += size;
                stats.newSize += size;
                continue; 
            }

            const value = obj[key];

          
            if (typeof value === 'string' && value.startsWith('data:image')) {

               
                const isExcluded =
                    
                    (parentKey === '' && (key === 'wallpaper' || key === 'cphoneWallpaper' || key === 'globalChatBackground')) ||
                   
                    (parentKey === 'settings' && key === 'background');

                if (isExcluded) {
                    console.log(`Ë∑≥ËøáÂéãÁº©ËÉåÊôØÂõæÁâá: ${parentKey || 'global'}.${key}`);
                    stats.found++;
                    stats.skipped++;
                    stats.originalSize += value.length;
                    stats.newSize += value.length;
                    continue; 
                }

                stats.found++;
                stats.originalSize += value.length;
                
                const compressedBase64 = await compressImage(value);
                if (compressedBase64 && compressedBase64 !== value) {
                    obj[key] = compressedBase64;
                    stats.compressed++;
                    stats.newSize += compressedBase64.length;
                } else {
                    stats.skipped++;
                    stats.newSize += value.length;
                }
            

            } else if (typeof value === 'object' && value !== null) {
               
                await traverseAndCompress(value, stats, key);
            }
        }
    }
}


  async function compressImage(base64Str) {
 
    if (!base64Str.startsWith('data:image')) {
      return base64Str;
    }

    
    const MAX_BASE64_SIZE_TO_SKIP = 500000; 
    if (base64Str.startsWith('data:image/jpeg') && base64Str.length < MAX_BASE64_SIZE_TO_SKIP) {
      console.log('Ë∑≥ËøáÂéãÁº©ÔºöÂõæÁâáÂ∑≤ÁªèÊòØÂ∞è‰ΩìÁßØJPEG„ÄÇ');
      return base64Str; 
    }
    
    try {
     
      const imageBlob = await (await fetch(base64Str)).blob();

    
      const SIZE_THRESHOLD_BYTES = 0.3 * 1024 * 1024; 
      if (imageBlob.size < SIZE_THRESHOLD_BYTES) {
          console.log(`Ë∑≥ËøáÂéãÁº©ÔºöÂõæÁâáÂ§ßÂ∞è (${(imageBlob.size / 1024 / 1024).toFixed(2)} MB) Â∑≤Â∞è‰∫é 0.3 MB„ÄÇ`);
          return base64Str; 
      }
    

    
      const options = {
        maxSizeMB: 0.5,      
        maxWidthOrHeight: 800,
        useWebWorker: true,
        initialQuality: 0.5,
        fileType: 'image/jpeg' 
      };

    

      console.log(`ÂºÄÂßãÂéãÁº©ÂõæÁâáÔºåÂéüÂßãÂ§ßÂ∞è: ${(imageBlob.size / 1024 / 1024).toFixed(2)} MB`);
      const compressedFile = await imageCompression(imageBlob, options);
      console.log(`ÂéãÁº©ÂÆåÊàêÔºåÊñ∞ÁöÑÂ§ßÂ∞è: ${(compressedFile.size / 1024 / 1024).toFixed(2)} MB`);

      
      if (compressedFile.size > imageBlob.size) {
          console.warn("ÂéãÁº©ÂêéÁöÑÂõæÁâá‰ΩìÁßØÂ¢ûÂ§ßÔºåÂ∑≤‰øùÁïôÂéüÂßãÂõæÁâá„ÄÇ");
          return base64Str;
      }

     
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(compressedFile);
      });

    } catch (error) {
      console.error("‰ΩøÁî® browser-image-compression ÂéãÁº©Â§±Ë¥•:", error);
      return base64Str; 
    }
  }

 
  function compareVersions(v1, v2) {

    if (!v1 || !v2 || typeof v1 !== 'string' || typeof v2 !== 'string') {
      return 0;
    }

    const parts1 = v1.split('.').map(Number);
    const parts2 = v2.split('.').map(Number);
    const len = Math.max(parts1.length, parts2.length);

    for (let i = 0; i < len; i++) {
      const p1 = parts1[i] || 0; // Â¶ÇÊûúÈÉ®ÂàÜ‰∏çÂ≠òÂú®ÔºåÂàôËßÜ‰∏∫ 0
      const p2 = parts2[i] || 0;

      if (p1 > p2) {
        return 1;
      }
      if (p1 < p2) {
        return -1;
      }
    }
    return 0;
  }


  async function checkForUpdates() {



    const CURRENT_APP_VERSION = "1.0";

    try {

      const response = await fetch('update-notice.html?_=' + Date.now());
      if (!response.ok) {
        console.warn('Ëé∑ÂèñÊõ¥Êñ∞ÈÄöÁü•Êñá‰ª∂Â§±Ë¥•„ÄÇ');
        return;
      }
      const noticeHtml = await response.text();


      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = noticeHtml;
      const noticeContent = tempDiv.querySelector('[data-version]');

      if (!noticeContent) {
        console.error('Êõ¥Êñ∞ÈÄöÁü•Êñá‰ª∂‰∏≠Áº∫Â∞ë data-version Â±ûÊÄß„ÄÇ');
        return;
      }

      const notificationVersion = noticeContent.dataset.version;


      const dismissedVersion = localStorage.getItem('dismissedUpdateVersion');



      if (!dismissedVersion || compareVersions(notificationVersion, dismissedVersion) > 0) {
        console.log(`ÂèëÁé∞Êñ∞ÁâàÊú¨ÈÄöÁü•: ${notificationVersion} (Â∑≤ÂøΩÁï•ÁâàÊú¨: ${dismissedVersion || 'Êó†'})`);
        showUpdateNotice(notificationVersion, noticeContent.innerHTML);
      } else {
        console.log(`ÂΩìÂâçÈÄöÁü•ÁâàÊú¨ (${notificationVersion}) Â∑≤Ë¢´Áî®Êà∑ÂøΩÁï•Êàñ‰∏∫ÊóßÁâàÊú¨ÔºåÊó†ÈúÄÊòæÁ§∫„ÄÇ`);
      }

    } catch (error) {
      console.error('Ê£ÄÊü•Êõ¥Êñ∞Êó∂Âá∫Èîô:', error);
    }
  }


  function showUpdateNotice(version, contentHtml) {
    const modal = document.getElementById('update-notice-modal');
    const body = document.getElementById('update-notice-body');
    const confirmBtn = document.getElementById('update-notice-confirm-btn');
    const dismissBtn = document.getElementById('update-notice-dismiss-btn');

    body.innerHTML = contentHtml;


    confirmBtn.disabled = true;
    dismissBtn.disabled = true;

  
    const confirmOriginalText = confirmBtn.textContent;
    let countdown = 10;
    confirmBtn.textContent = `${confirmOriginalText} (${countdown}s)`;


    const countdownInterval = setInterval(() => {
      countdown--;
      if (countdown > 0) {
      
        confirmBtn.textContent = `${confirmOriginalText} (${countdown}s)`;
      } else {
       
        clearInterval(countdownInterval); 
        confirmBtn.disabled = false; 
        dismissBtn.disabled = false; 
        confirmBtn.textContent = confirmOriginalText;
      }
    }, 1000);

 
    confirmBtn.onclick = () => {
      clearInterval(countdownInterval); 
      modal.classList.remove('visible');
      confirmBtn.textContent = confirmOriginalText; 
    };

    dismissBtn.onclick = () => {
      clearInterval(countdownInterval);
      localStorage.setItem('dismissedUpdateVersion', version);
      modal.classList.remove('visible');
      console.log(`Áî®Êà∑Â∑≤ÂøΩÁï•ÁâàÊú¨: ${version}`);
      confirmBtn.textContent = confirmOriginalText; 
    };

  

    modal.classList.add('visible');
  }




 
  function openDoubanSettingsModal() {
    const modal = document.getElementById('douban-settings-modal');


    document.getElementById('douban-min-posts-input').value = state.globalSettings.doubanMinPosts || 12;
    document.getElementById('douban-max-posts-input').value = state.globalSettings.doubanMaxPosts || 20;

    modal.classList.add('visible');
  }


  async function saveDoubanSettings() {
    const minInput = document.getElementById('douban-min-posts-input');
    const maxInput = document.getElementById('douban-max-posts-input');

    const min = parseInt(minInput.value);
    const max = parseInt(maxInput.value);


    if (isNaN(min) || isNaN(max) || min < 1 || max < 1) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ≠£Êï¥Êï∞ÔºÅ");
      return;
    }
    if (min > max) {
      alert("ÊúÄÂ∞èÂ∏ñÂ≠êÊï∞‰∏çËÉΩÂ§ß‰∫éÊúÄÂ§ßÂ∏ñÂ≠êÊï∞ÔºÅ");
      return;
    }


    state.globalSettings.doubanMinPosts = min;
    state.globalSettings.doubanMaxPosts = max;
    await db.globalSettings.put(state.globalSettings);


    document.getElementById('douban-settings-modal').classList.remove('visible');
    await showCustomAlert('‰øùÂ≠òÊàêÂäü', 'Ë±ÜÁì£ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞ÔºÅ‰∏ãÊ¨°ÈáçÊñ∞ÁîüÊàêÊó∂Â∞ÜÁîüÊïà„ÄÇ');
  }


  async function openWerewolfLobby(mode) {
    const modal = document.getElementById('werewolf-lobby-modal');
    const listEl = document.getElementById('werewolf-player-selection-list');
    listEl.innerHTML = '';

    let potentialPlayers = [];

    if (mode === 'global') {
      const characters = Object.values(state.chats).filter(c => !c.isGroup);
      const npcs = await db.npcs.toArray();
      potentialPlayers = [

        {
          id: 'user',
          name: state.qzoneSettings.nickname || 'Êàë',
          originalName: state.qzoneSettings.nickname || 'Êàë',
          avatar: state.qzoneSettings.avatar,
          type: 'user'
        },

        ...characters.map(c => ({
          id: c.id,
          name: c.name,
          originalName: c.originalName,
          avatar: c.settings.aiAvatar,
          type: 'character'
        })),

        ...npcs.map(n => ({
          id: `npc_${n.id}`,
          name: n.name,
          originalName: n.name,
          avatar: n.avatar,
          type: 'npc'
        }))
      ];
      werewolfGameState.chatId = null;
    } else {
      const chat = state.chats[state.activeChatId];
      if (!chat || !chat.isGroup) return;

      potentialPlayers = [

        {
          id: 'user',
          name: chat.settings.myNickname || 'Êàë',
          originalName: state.qzoneSettings.nickname || 'Êàë',
          avatar: chat.settings.myAvatar,
          type: 'user'
        },

        ...chat.members.map(m => {
          const char = state.chats[m.id];
          const memberAvatar = m.avatar || (char ? char.settings.aiAvatar : defaultGroupMemberAvatar);
          return {
            id: m.id,
            name: m.groupNickname,
            originalName: m.originalName,
            avatar: memberAvatar,
            type: m.isNpc ? 'npc' : 'character'
          };
        })
      ];
      werewolfGameState.chatId = state.activeChatId;
    }

    potentialPlayers.forEach(player => {
      const item = document.createElement('div');
      item.className = 'contact-picker-item';
      item.innerHTML = `
            <input type="checkbox" class="werewolf-player-checkbox" data-player-json='${JSON.stringify(player)}' ${player.type === 'user' ? 'checked disabled' : 'checked'}>
            <img src="${player.avatar}" class="avatar">
            <span class="name">${player.name}</span>
        `;
      listEl.appendChild(item);
    });

    modal.classList.add('visible');
  }

 
  async function initializeWerewolfGame() {
    const selectedCheckboxes = document.querySelectorAll('.werewolf-player-checkbox:checked');
    const playerCount = selectedCheckboxes.length;

    let roles = [];
    if (playerCount === 6) {
      werewolfGameState.gameMode = '6p';
      roles = ['Áãº‰∫∫', 'Áãº‰∫∫', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'È¢ÑË®ÄÂÆ∂', 'Áåé‰∫∫'];
    } else if (playerCount === 9) {
      werewolfGameState.gameMode = '9p';
      roles = ['Áãº‰∫∫', 'Áãº‰∫∫', 'Áãº‰∫∫', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'È¢ÑË®ÄÂÆ∂', 'Â•≥Â∑´', 'Áåé‰∫∫'];
    } else if (playerCount === 12) {
      werewolfGameState.gameMode = '12p';
      roles = ['Áãº‰∫∫', 'Áãº‰∫∫', 'Áãº‰∫∫', 'Áãº‰∫∫', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'Âπ≥Ê∞ë', 'È¢ÑË®ÄÂÆ∂', 'Â•≥Â∑´', 'Áåé‰∫∫', 'ÂÆàÂç´'];
    } else {
      alert(`ÂΩìÂâç‰∫∫Êï∞ ${playerCount} ‰∏çÊîØÊåÅ„ÄÇËØ∑ÈÄâÊã©6„ÄÅ9Êàñ12‰∫∫„ÄÇ`);
      return;
    }

    document.getElementById('werewolf-lobby-modal').classList.remove('visible');
    await showCustomAlert('Ê≠£Âú®ÂèëÁâå...', 'Ê∏∏ÊàèÂç≥Â∞ÜÂºÄÂßãÔºåÊ≠£Âú®‰∏∫ÂêÑ‰ΩçÁé©ÂÆ∂ÂàÜÈÖçË∫´‰ªΩ...');

    for (let i = roles.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [roles[i], roles[j]] = [roles[j], roles[i]];
    }

    const selectedPlayers = Array.from(selectedCheckboxes).map(cb => JSON.parse(cb.dataset.playerJson));
    werewolfGameState.players = [];

    for (let i = 0; i < selectedPlayers.length; i++) {
      const playerInfo = selectedPlayers[i];
      const role = roles[i];

      let character_persona = "‰∏Ä‰∏™ÊôÆÈÄöÁé©ÂÆ∂";
      if (playerInfo.type === 'character') {
        const char = state.chats[playerInfo.id];
        character_persona = char ? char.settings.aiPersona : 'Êú™Áü•ËÆæÂÆöÁöÑËßíËâ≤';
      } else if (playerInfo.type === 'npc') {
        const npcs = await db.npcs.toArray();
        const npc = npcs.find(n => `npc_${n.id}` === playerInfo.id);
        character_persona = npc ? npc.persona : 'Êú™Áü•ËÆæÂÆöÁöÑNPC';
      } else if (playerInfo.type === 'user') {
        const activeChat = werewolfGameState.chatId ? state.chats[werewolfGameState.chatId] : null;
        character_persona = activeChat ? activeChat.settings.myPersona : 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ';
      }

      const playerObject = {
        ...playerInfo,
        role: role,
        isAlive: true,
        character_persona: character_persona
      };


      if (role === 'Â•≥Â∑´') {
        playerObject.antidoteUsed = false;
        playerObject.poisonUsed = false;
      }
      if (role === 'ÂÆàÂç´') {
        playerObject.lastGuardedId = null;
      }


      werewolfGameState.players.push(playerObject);
    }

    werewolfGameState.isActive = true;
    werewolfGameState.currentDay = 1;
    werewolfGameState.currentPhase = 'start';
    werewolfGameState.gameLog = [];
    werewolfGameState.discussionLog = [];

    const roleCounts = roles.reduce((acc, role) => {
      acc[role] = (acc[role] || 0) + 1;
      return acc;
    }, {});
    const roleSummary = Object.entries(roleCounts).map(([role, count]) => `${role} x${count}`).join('„ÄÅ');
    addGameLog(`Ê∏∏ÊàèÈÖçÁΩÆÔºö${playerCount}‰∫∫Â±ÄÔºåË∫´‰ªΩ‰∏∫ ${roleSummary}„ÄÇ`);

    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');

    renderWerewolfScreen();
    showScreen('werewolf-game-screen');

    showMyRole(myPlayer.role);
  }



  function renderWerewolfScreen() {
    const gridEl = document.getElementById('werewolf-player-grid');
    gridEl.innerHTML = '';
    const sortedPlayers = [...werewolfGameState.players].sort((a, b) => a.isAlive - b.isAlive);

    sortedPlayers.forEach((p, index) => {
      const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;
      const avatarEl = document.createElement('div');
      avatarEl.className = 'werewolf-player-avatar';
      if (!p.isAlive) avatarEl.classList.add('dead');
      avatarEl.innerHTML = `
            <img src="${p.avatar}">
            <span class="player-name">${playerIndex}. ${p.name}</span>
        `;
      gridEl.appendChild(avatarEl);
    });

    const logEl = document.getElementById('werewolf-log');
    logEl.innerHTML = '';


    for (let day = 1; day <= werewolfGameState.currentDay; day++) {

      const logsThisDay = [
        ...werewolfGameState.gameLog.filter(entry => entry.day === day),
        ...werewolfGameState.discussionLog.filter(entry => entry.day === day)
      ].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));


      if (logsThisDay.length > 0) {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'werewolf-log-entry system';
        dayHeader.textContent = `--- Á¨¨ ${day} Â§© ---`;
        dayHeader.style.cssText = 'font-weight: bold; background: rgba(255, 193, 7, 0.2);';
        logEl.appendChild(dayHeader);


        logsThisDay.forEach(entry => {
          const entryEl = document.createElement('div');
          entryEl.className = `werewolf-log-entry ${entry.type}`;
          if (entry.type === 'dialogue') {
            entryEl.innerHTML = `<span class="speaker">${entry.speaker}:</span> ${entry.content}`;
          } else {
            entryEl.textContent = entry.content;
          }
          logEl.appendChild(entryEl);
        });
      }
    }


    logEl.scrollTop = logEl.scrollHeight;


    const phaseMap = {
      'start': 'Ê∏∏ÊàèÂºÄÂßã',
      'night': `Á¨¨${werewolfGameState.currentDay}Â§© - Â§úÊôö`,
      'day': `Á¨¨${werewolfGameState.currentDay}Â§© - ÁôΩÂ§©`,
      'discussion': `Á¨¨${werewolfGameState.currentDay}Â§© - ËÆ®ËÆ∫`,
      'voting': `Á¨¨${werewolfGameState.currentDay}Â§© - ÊäïÁ•®`,
      'gameover': 'Ê∏∏ÊàèÁªìÊùü'
    };
    document.getElementById('werewolf-game-title').textContent = `Áãº‰∫∫ÊùÄ - ${phaseMap[werewolfGameState.currentPhase] || werewolfGameState.currentPhase}`;
  }



  function showMyRole(role) {
    const roleDescriptions = {
      'Áãº‰∫∫': '‰Ω†ÁöÑÁõÆÊ†áÊòØÊùÄÊ≠ªÊâÄÊúâÂ•Ω‰∫∫„ÄÇÊØèÊôöÂèØ‰ª•ÂíåÂêå‰º¥‰∏ÄËµ∑ÂàÄ‰∏Ä‰∏™Áé©ÂÆ∂„ÄÇ',
      'Âπ≥Ê∞ë': '‰Ω†Ê≤°Êúâ‰ªª‰ΩïÁâπÊÆäËÉΩÂäõÔºå‰Ω†ÁöÑÁõÆÊ†áÊòØÈÄöËøáÊäïÁ•®ÊîæÈÄêÊâÄÊúâÁãº‰∫∫„ÄÇ',
      'È¢ÑË®ÄÂÆ∂': 'ÊØèÊôöÂèØ‰ª•Êü•È™å‰∏Ä‰∏™Áé©ÂÆ∂ÁöÑË∫´‰ªΩÊòØÂ•Ω‰∫∫ËøòÊòØÁãº‰∫∫„ÄÇ',
      'Áåé‰∫∫': 'ÂΩì‰Ω†Ê≠ª‰∫°Êó∂Ôºå‰Ω†ÂèØ‰ª•ÈÄâÊã©Â∏¶Ëµ∞Âú∫‰∏ä‰ªªÊÑè‰∏ÄÂêçÁé©ÂÆ∂„ÄÇ',
      'Â•≥Â∑´': '‰Ω†Êúâ‰∏ÄÁì∂Ëß£ËçØÂíå‰∏ÄÁì∂ÊØíËçØÔºåËß£ËçØÂèØ‰ª•ÊïëÊ¥ªÂΩìÊôöË¢´ÊùÄÁöÑÁé©ÂÆ∂ÔºåÊØíËçØÂèØ‰ª•ÊØíÊ≠ª‰ªªÊÑè‰∏ÄÂêçÁé©ÂÆ∂„ÄÇ',
      'ÂÆàÂç´': 'ÊØèÊôöÂèØ‰ª•ÂÆàÊä§‰∏ÄÂêçÁé©ÂÆ∂Ôºå‰ΩøÂÖ∂ÂÖçÂèóÁãº‰∫∫Ë¢≠Âáª„ÄÇ‰∏çËÉΩËøûÁª≠‰∏§ÊôöÂÆàÊä§Âêå‰∏Ä‰∏™‰∫∫„ÄÇ'
    };

    document.getElementById('werewolf-role-name').textContent = role;
    document.getElementById('werewolf-role-description').textContent = roleDescriptions[role] || '‰∏Ä‰∏™Á•ûÁßòÁöÑËßíËâ≤„ÄÇ';
    document.getElementById('werewolf-role-modal').classList.add('visible');
  }

  async function executeNightPhase() {
    werewolfGameState.currentPhase = `Á¨¨${werewolfGameState.currentDay}Â§© - Â§úÊôö`;
    werewolfGameState.nightActions = {};
    addGameLog('Â§©ÈªëËØ∑Èó≠Áúº...');
    renderWerewolfScreen();

    document.getElementById('werewolf-action-bar').style.display = 'none';
    document.getElementById('werewolf-retry-btn').style.display = 'none';
    await new Promise(resolve => setTimeout(resolve, 1500));


    const guard = werewolfGameState.players.find(p => p.role === 'ÂÆàÂç´' && p.isAlive);
    if (guard) {
      addGameLog('ÂÆàÂç´ËØ∑ÁùÅÁúºÔºåËØ∑ÈÄâÊã©Ë¶ÅÂÆàÊä§ÁöÑÁé©ÂÆ∂„ÄÇ');
      renderWerewolfScreen();
      let guardedId = null;
      if (guard.id === 'user') {
        guardedId = await openSelectionModal('guard', guard.lastGuardedId);
      } else {
        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== guard.lastGuardedId);
        if (potentialTargets.length > 0) {
          guardedId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
        }
      }
      if (guardedId) {
        werewolfGameState.nightActions.guardedId = guardedId;
        guard.lastGuardedId = guardedId;
      }
      addGameLog('ÂÆàÂç´Â∑≤Ë°åÂä®ÔºåÂÆàÂç´ËØ∑Èó≠Áúº„ÄÇ');
      renderWerewolfScreen();
      await new Promise(resolve => setTimeout(resolve, 1500));
    }



    addGameLog('Áãº‰∫∫ËØ∑ÁùÅÁúºÔºåËØ∑ÈÄâÊã©Ë¶ÅÂàÄÁöÑÁé©ÂÆ∂„ÄÇ');
    renderWerewolfScreen();

    const wolves = werewolfGameState.players.filter(p => p.role === 'Áãº‰∫∫' && p.isAlive);
    const userIsWolf = wolves.some(p => p.id === 'user');

    let wolfTargetId = null;


    werewolfGameState.lastFailedAction = 'wolfKill';
    try {
      if (userIsWolf) {
        addGameLog('‰Ω†ÊòØÁãº‰∫∫ÔºåËØ∑ÈÄâÊã©ÂàÄ‰∫∫ÁõÆÊ†á„ÄÇ');
        renderWerewolfScreen();
        wolfTargetId = await openWolfKillModal();
      } else {

        if (werewolfGameState.currentDay === 1) {
          console.log("Á¨¨‰∏ÄÂ§úÔºåÊâßË°åÊú¨Âú∞ÈöèÊú∫ÂàÄ‰∫∫ÈÄªËæë...");
          const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'Áãº‰∫∫');
          if (potentialTargets.length > 0) {
            wolfTargetId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
          }
        } else {

          wolfTargetId = await getAiWolfKillTarget();
        }
      }

      werewolfGameState.lastFailedAction = null;
    } catch (error) {
      console.error("Áãº‰∫∫Ë°åÂä®APIÂ§±Ë¥•:", error);
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", "AIÁãº‰∫∫Âõ¢ÈòüÊó†Ê≥ïÂÜ≥ÂÆöÁõÆÊ†áÔºåÊ∏∏ÊàèÊöÇÂÅú„ÄÇËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúÈáçËØï‚ÄùÊåâÈíÆÁªßÁª≠„ÄÇ");
      document.getElementById('werewolf-retry-btn').style.display = 'block';
      return;
    }

    werewolfGameState.nightActions.killedId = wolfTargetId;
    addGameLog('Áãº‰∫∫Â∑≤Ë°åÂä®ÔºåÁãº‰∫∫ËØ∑Èó≠Áúº„ÄÇ');
    renderWerewolfScreen();
    await new Promise(resolve => setTimeout(resolve, 1500));


    const witch = werewolfGameState.players.find(p => p.role === 'Â•≥Â∑´' && p.isAlive);
    if (witch) {
      addGameLog('Â•≥Â∑´ËØ∑ÁùÅÁúº„ÄÇ');
      renderWerewolfScreen();
      const killedPlayer = werewolfGameState.players.find(p => p.id === werewolfGameState.nightActions.killedId);


      const isGuarded = werewolfGameState.nightActions.guardedId === werewolfGameState.nightActions.killedId;


      const playerToShowWitch = (isGuarded || !killedPlayer) ? null : killedPlayer;

      if (witch.id === 'user') {
        let userWitchAction = await openWitchActionModal(playerToShowWitch, witch);
        if (userWitchAction.save) {
          werewolfGameState.nightActions.savedId = werewolfGameState.nightActions.killedId;
          witch.antidoteUsed = true;
        }
        if (userWitchAction.poison) {
          werewolfGameState.nightActions.poisonedId = userWitchAction.poison;
          witch.poisonUsed = true;
        }
      } else {

        if (!witch.antidoteUsed && playerToShowWitch) {
          let saveChance = 0;
          if (werewolfGameState.currentDay === 1) {

            saveChance = 0.3;
          } else {

            saveChance = 0.8;
          }

          console.log(`AIÂ•≥Â∑´ÂÜ≥Á≠ñÔºö‰ªäÂ§©ÊòØÁ¨¨${werewolfGameState.currentDay}Â§©ÔºåÊïë‰∫∫Ê¶ÇÁéá‰∏∫ ${saveChance * 100}%`);

          if (Math.random() < saveChance) {
            console.log("AIÂ•≥Â∑´ÂÜ≥ÂÆö‰ΩøÁî®Ëß£ËçØÔºÅ");
            werewolfGameState.nightActions.savedId = werewolfGameState.nightActions.killedId;
            witch.antidoteUsed = true;
          } else {
            console.log("AIÂ•≥Â∑´ÂÜ≥ÂÆö‰øùÁïôËß£ËçØ„ÄÇ");
          }
        }


        if (!werewolfGameState.nightActions.savedId && !witch.poisonUsed && Math.random() < 0.5) {
          const poisonTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== werewolfGameState.nightActions.killedId);
          if (poisonTargets.length > 0) {
            const target = poisonTargets[Math.floor(Math.random() * poisonTargets.length)];
            werewolfGameState.nightActions.poisonedId = target.id;
            witch.poisonUsed = true;
            console.log(`AIÂ•≥Â∑´ÂÜ≥ÂÆö‰ΩøÁî®ÊØíËçØÔºåÁõÆÊ†áÊòØ: ${target.name}`);
          }
        }

      }
      addGameLog('Â•≥Â∑´Â∑≤Ë°åÂä®ÔºåÂ•≥Â∑´ËØ∑Èó≠Áúº„ÄÇ');
      renderWerewolfScreen();
      await new Promise(resolve => setTimeout(resolve, 1500));
    }


    const prophet = werewolfGameState.players.find(p => p.role === 'È¢ÑË®ÄÂÆ∂' && p.isAlive);
    if (prophet) {
      addGameLog('È¢ÑË®ÄÂÆ∂ËØ∑ÁùÅÁúºÔºåËØ∑ÈÄâÊã©Ë¶ÅÊü•È™åÁöÑÁé©ÂÆ∂„ÄÇ');
      renderWerewolfScreen();

      if (prophet.id === 'user') {
        const targetId = await openSelectionModal('prophet');
        const targetPlayer = werewolfGameState.players.find(p => p.id === targetId);
        if (targetPlayer) {
          const isWolf = targetPlayer.role === 'Áãº‰∫∫';
          await showCustomAlert('Êü•È™åÁªìÊûú', `‰Ω†Êü•È™åÁöÑÁé©ÂÆ∂ ${targetPlayer.name} ÁöÑË∫´‰ªΩÊòØÔºö${isWolf ? 'Áãº‰∫∫' : 'Â•Ω‰∫∫'}`);
          werewolfGameState.nightActions.prophetCheck = {
            target: targetId,
            result: isWolf ? 'Áãº‰∫∫' : 'Â•Ω‰∫∫'
          };
        }
      } else {
        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== prophet.id);
        if (potentialTargets.length > 0) {
          const target = potentialTargets[Math.floor(Math.random() * potentialTargets.length)];
          werewolfGameState.nightActions.prophetCheck = {
            target: target.id,
            result: target.role === 'Áãº‰∫∫' ? 'Áãº‰∫∫' : 'Â•Ω‰∫∫'
          };
        }
      }
      addGameLog('È¢ÑË®ÄÂÆ∂Â∑≤Ë°åÂä®ÔºåÈ¢ÑË®ÄÂÆ∂ËØ∑Èó≠Áúº„ÄÇ');
      renderWerewolfScreen();
      await new Promise(resolve => setTimeout(resolve, 1500));
    }


    executeDayPhase();
  }


  async function executeDayPhase() {
    werewolfGameState.currentPhase = `Á¨¨${werewolfGameState.currentDay}Â§© - ÁôΩÂ§©`;
    werewolfGameState.voteResults = {};
    addGameLog('Â§©‰∫Æ‰∫Ü„ÄÇ');

    const {
      killedId,
      guardedId,
      savedId,
      poisonedId
    } = werewolfGameState.nightActions;
    const deathsThisNight = new Set();


    if (killedId && killedId !== guardedId && killedId !== savedId) {
      deathsThisNight.add(killedId);
    }


    if (poisonedId) {

      deathsThisNight.add(poisonedId);
    }


    if (deathsThisNight.size === 0) {
      addGameLog('Êò®ÊôöÊòØÂπ≥ÂÆâÂ§ú„ÄÇ');
    } else {
      for (const deadPlayerId of deathsThisNight) {
        const deadPlayer = werewolfGameState.players.find(p => p.id === deadPlayerId);
        if (deadPlayer && deadPlayer.isAlive) {
          deadPlayer.isAlive = false;
          addGameLog(`Êò®Êôö ${deadPlayer.name} Ê≠ª‰∫°‰∫Ü„ÄÇ`);


          if (deadPlayer.role === 'Áåé‰∫∫') {
            addGameLog('Áåé‰∫∫Ê≠ª‰∫°ÔºåËØ∑ÈÄâÊã©‰∏ÄÂêçÁé©ÂÆ∂Â∏¶Ëµ∞ÔºÅ');
            renderWerewolfScreen();
            let hunterTargetId = null;
            if (deadPlayer.id === 'user') {
              hunterTargetId = await openSelectionModal('hunter');
            } else {
              const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== deadPlayer.id);
              if (potentialTargets.length > 0) {
                hunterTargetId = potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
              }
            }
            const targetPlayer = werewolfGameState.players.find(p => p.id === hunterTargetId);
            if (targetPlayer) {
              targetPlayer.isAlive = false;
              addGameLog(`Áåé‰∫∫Â∏¶Ëµ∞‰∫Ü ${targetPlayer.name}„ÄÇ`);
            }
          }
        }
      }
    }

    renderWerewolfScreen();

    if (checkGameOver()) return;

    await startDiscussionPhase();
  }


 
  async function startDiscussionPhase() {



    addGameLog('Áé∞Âú®ÂºÄÂßãËÆ®ËÆ∫ÔºåËØ∑ÂêÑ‰ΩçÁé©ÂÆ∂‰æùÊ¨°ÂèëË®Ä„ÄÇ');
    renderWerewolfScreen();

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      return;
    }

    const systemPrompt = buildWerewolfPrompt();
    werewolfGameState.lastFailedAction = 'startDiscussion';
    try {
      await showCustomAlert("ËØ∑Á®çÂÄô", "Ê≠£Âú®Á≠âÂæÖAIËßíËâ≤‰ª¨ËøõË°åÊøÄÁÉàÁöÑËÆ®ËÆ∫...");

      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑ÊâÄÊúâAIËßíËâ≤Ê†πÊçÆ‰Ω†‰ª¨ÁöÑË∫´‰ªΩÂíå‰∫∫ËÆæÂºÄÂßãÂèëË®Ä„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.95,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch) {
        throw new Error(`AIËøîÂõûÁöÑËÆ®ËÆ∫ÂÜÖÂÆπÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const dialogues = JSON.parse(jsonMatch[0]);

      for (const dialogue of dialogues) {
        if (dialogue.speaker_name && dialogue.dialogue) {
          addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
          renderWerewolfScreen();
          await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
        }
      }

      werewolfGameState.lastFailedAction = null;

    } catch (error) {
      console.error("Áãº‰∫∫ÊùÄAIËÆ®ËÆ∫ÁîüÊàêÂ§±Ë¥•:", error);
      await showCustomAlert("AI ÂèëË®ÄÂ§±Ë¥•", `ËÆ®ËÆ∫Êó†Ê≥ïÂºÄÂßãÔºåÊ∏∏ÊàèÊöÇÂÅú„ÄÇËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúÈáçËØï‚ÄùÊåâÈíÆÁªßÁª≠„ÄÇ\nÈîôËØØ: ${error.message}`);
      document.getElementById('werewolf-retry-btn').style.display = 'block';
      return;
    }

    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
    const actionBar = document.getElementById('werewolf-action-bar');
    const waitReplyBtn = document.getElementById('werewolf-wait-reply-btn');
    const finishSpeechBtn = document.getElementById('werewolf-finish-speech-btn');
    const userInput = document.getElementById('werewolf-user-input');

    actionBar.style.display = 'flex';

    if (myPlayer && myPlayer.isAlive) {
      waitReplyBtn.textContent = 'Á≠âÂæÖÂõûÂ∫î';
      finishSpeechBtn.textContent = 'ÁªìÊùüÂèëË®Ä';
      waitReplyBtn.style.display = 'block';
      finishSpeechBtn.style.display = 'block';
      userInput.disabled = false;
      userInput.placeholder = "ËΩÆÂà∞‰Ω†ÂèëË®Ä‰∫Ü...";
      userInput.focus();

      const newWaitBtn = waitReplyBtn.cloneNode(true);
      waitReplyBtn.parentNode.replaceChild(newWaitBtn, waitReplyBtn);
      newWaitBtn.addEventListener('click', handleWerewolfWaitReply);

      const newFinishBtn = finishSpeechBtn.cloneNode(true);
      finishSpeechBtn.parentNode.replaceChild(newFinishBtn, finishSpeechBtn);
      newFinishBtn.addEventListener('click', handleUserWerewolfSpeech);

    } else {
      addGameLog('‰Ω†Â∑≤ÁªèÊ≠ª‰∫°ÔºåÊó†Ê≥ïÂèëË®Ä„ÄÇËØ∑Á≠âÂæÖÂÖ∂‰ªñÁé©ÂÆ∂ÂèëË®ÄÁªìÊùü„ÄÇ');
      renderWerewolfScreen();

      waitReplyBtn.textContent = 'ÁªßÁª≠ËÆ®ËÆ∫';
      finishSpeechBtn.textContent = 'ËøõÂÖ•ÊäïÁ•®';
      waitReplyBtn.style.display = 'block';
      finishSpeechBtn.style.display = 'block';
      userInput.disabled = true;
      userInput.placeholder = "‰Ω†Â∑≤Ê≠ª‰∫°ÔºåÊ≠£Âú®Âõ¥ËßÇ...";

      const newWaitBtn = waitReplyBtn.cloneNode(true);
      waitReplyBtn.parentNode.replaceChild(newWaitBtn, waitReplyBtn);
      newWaitBtn.addEventListener('click', handleAiContinueDiscussion);

      const newFinishBtn = finishSpeechBtn.cloneNode(true);
      finishSpeechBtn.parentNode.replaceChild(newFinishBtn, finishSpeechBtn);
      newFinishBtn.addEventListener('click', startVotingPhase);
    }
  }



  function buildWerewolfPrompt() {
    const alivePlayers = werewolfGameState.players.filter(p => p.isAlive);
    const myPlayerObject = werewolfGameState.players.find(p => p.id === 'user');
    const myPlayerName = myPlayerObject ? myPlayerObject.name : 'Áî®Êà∑';
    const isUserAlive = alivePlayers.some(p => p.id === 'user');


    let charactersAndPlayersDossier = "# ËßíËâ≤‰∏éÁé©ÂÆ∂Ê°£Ê°à (Character & Player Dossiers)\n";
    charactersAndPlayersDossier += "ËøôÊòØÊâÄÊúâÂú®Âú∫Áé©ÂÆ∂ÁöÑÂÖ¨ÂºÄ‰ø°ÊÅØ„ÄÅ‰∫∫ËÆæÂíåÁ§æ‰∫§ËÉåÊôØ„ÄÇ\n";

    alivePlayers.forEach((p, i) => {
      const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;

      let socialContext = '';
      const playerChat = state.chats[p.id];

      if (playerChat) {
        const friendsInGame = alivePlayers.filter(otherPlayer =>
          otherPlayer.id !== p.id &&
          state.chats[otherPlayer.id] &&
          state.chats[otherPlayer.id].groupId === playerChat.groupId &&
          playerChat.groupId !== null
        ).map(friend => friend.name).join('„ÄÅ');

        if (friendsInGame) {
          socialContext += `- **‰Ω†ÁöÑÂ•ΩÂèã (ÂøÖÈ°ª‰øùÊä§)**: ‰Ω†Âíå ${friendsInGame} ÊòØÂêå‰∏Ä‰∏™ÂàÜÁªÑÁöÑÂ•ΩÂèã„ÄÇ\n`;
        }
      }
      if (p.id !== 'user') {
        socialContext += `- **‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ª**: ‰Ω†ÂíåÁî®Êà∑(${myPlayerName})ÁöÑÂÖ≥Á≥ªËØ∑ÂèÇËÄÉ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅÈïøÊúüËÆ∞ÂøÜÂíåÊúÄËøëÁöÑÂØπËØù„ÄÇ\n`;
      }

      charactersAndPlayersDossier += `
## ${playerIndex}Âè∑Áé©ÂÆ∂: ${p.name} (ËøôÊòØTAÁöÑÊòµÁß∞)
- **Êú¨Âêç (‰Ω†Âú®ÂØπËØù‰∏≠ÂøÖÈ°ªÁî®Ëøô‰∏™ÂêçÂ≠óÁß∞ÂëºTA)**: ${p.originalName}
- **Ë∫´‰ªΩ**: ${p.id === 'user' ? '„ÄêÁî®Êà∑ (User)„Äë' : '„ÄêAIËßíËâ≤„Äë'}
- **‰∫∫ËÆæ (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)**: ${p.character_persona}
`;

      if (p.type === 'character') {
        const char = state.chats[p.id];
        if (char && char.longTermMemory && char.longTermMemory.length > 0) {
          const memoryContent = char.longTermMemory.map(mem => mem.content).join('; ');
          charactersAndPlayersDossier += `- **ÈïøÊúüËÆ∞ÂøÜ (ÂøÖÈ°ªÂèÇËÄÉ)**: ${memoryContent}\n`;
        }
      }
      if (socialContext) {
        charactersAndPlayersDossier += `
- **‰Ω†ÁöÑÁ§æ‰∫§ÂÖ≥Á≥ª (ÂøÖÈ°ªÂèÇËÄÉ)**:
${socialContext}`;
      }
    });


    let nightEventSummary = "# Êò®Êôö‰∫ã‰ª∂ÊÄªÁªì (Night Event Summary)\n";
    nightEventSummary += "ËøôÊòØÊâÄÊúâÁé©ÂÆ∂ÈÉΩËÉΩÂê¨Âà∞ÁöÑ„ÄêÂÖ¨ÂºÄ‰ø°ÊÅØ„Äë„ÄÇ\n";
    const deathsThisNight = werewolfGameState.gameLog.filter(entry => entry.content.includes('Ê≠ª‰∫°‰∫Ü') && entry.day === werewolfGameState.currentDay);
    if (deathsThisNight.length === 0) {
      nightEventSummary += "- Êò®ÊôöÊòØÂπ≥ÂÆâÂ§úÔºåÊó†‰∫∫Ê≠ª‰∫°„ÄÇ\n";
    } else {
      deathsThisNight.forEach(death => {
        nightEventSummary += `- ${death.content}\n`;
      });
    }


    let previousDaysSummary = "# ÂâçÂá†Êó•ÂÆåÊï¥ÂéÜÂè≤ÂõûÈ°æ (Full Recap of Previous Days)\n";
    if (werewolfGameState.currentDay > 1) {
      for (let day = 1; day < werewolfGameState.currentDay; day++) {
        previousDaysSummary += `\n**--- Á¨¨ ${day} Â§© ---**\n`;
        const eventsThisDay = werewolfGameState.gameLog.filter(entry => entry.day === day && (entry.content.includes('Ê≠ª‰∫°') || entry.content.includes('ÊîæÈÄê')));
        if (eventsThisDay.length > 0) {
          previousDaysSummary += `*‰∫ã‰ª∂*: ${eventsThisDay.map(e => e.content).join(' ')}\n`;
        } else {
          previousDaysSummary += "*‰∫ã‰ª∂*: Âπ≥ÂÆâÂ§úÔºåÊó†‰∫∫Âá∫Â±Ä„ÄÇ\n";
        }
        const discussionsThisDay = werewolfGameState.discussionLog.filter(entry => entry.day === day);
        if (discussionsThisDay.length > 0) {
          previousDaysSummary += `*ËÆ®ËÆ∫ËÆ∞ÂΩï*:\n${discussionsThisDay.map(d => `- ${d.speaker}: ${d.content}`).join('\n')}\n`;
        }
      }
    } else {
      previousDaysSummary += "(‰ªäÂ§©ÊòØÁ¨¨‰∏ÄÂ§©ÔºåÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩï)\n";
    }


    let discussionHistoryContext = "# ‰ªäÊó•ÂÆåÊï¥ËÆ®ËÆ∫ËÆ∞ÂΩï (Today's Full Discussion Record)\n";
    const todayDiscussions = werewolfGameState.discussionLog.filter(entry => entry.day === werewolfGameState.currentDay);
    if (todayDiscussions.length > 0) {
      discussionHistoryContext += todayDiscussions.map(d => `- **${d.speaker}**: ${d.content}`).join('\n');
    } else {
      discussionHistoryContext += "(‰Ω†ÊòØÁ¨¨‰∏Ä‰∏™ÂèëË®ÄÁöÑ‰∫∫)";
    }


    let internalMonologueBuilder = `
# „ÄêÈÄªËæëÈöîÁ¶ª‰∏éTGS‰∏âÊ†∏ÊÄùËÄÉ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§)„Äë
‰∏∫‰∫ÜÂÖºÈ°æÊ∏∏ÊàèÈÄªËæëÂíåËßíËâ≤ÊâÆÊºîÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂú®ÂÜÖÈÉ®‰∏∫„ÄêÊØè‰∏Ä‰∏™AIËßíËâ≤„ÄëÊåâÈ°∫Â∫èÊâßË°å‰ª•‰∏ã‚Äú‰∏âÈò∂ÊÆµÊÄùËÄÉ‚ÄùÔºö

## Èò∂ÊÆµ1ÔºöÂÜÖÈÉ®Áã¨Á´ãÊÄùËÄÉ (Internal Monologue Scratchpad)
(ËøôÈÉ®ÂàÜÂÜÖÂÆπ„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂá∫Áé∞Âú®‰Ω†ÊúÄÁªàÁöÑJSONËæìÂá∫‰∏≠ÔºåËøô‰ªÖ‰æõ‰Ω†ÂÜÖÈÉ®Ê®°Êãü‰ΩøÁî®)
`;


    alivePlayers.forEach(p => {
      if (p.id !== 'user') { // Âè™‰∏∫AIËßíËâ≤ÁîüÊàêÊÄùËÄÉÊ®°Âùó
        const playerIndex = werewolfGameState.players.findIndex(player => player.id === p.id) + 1;
        internalMonologueBuilder += `
### Ê≠£Âú®Ê®°Êãü ${playerIndex}Âè∑Áé©ÂÆ∂: ${p.name} (Êú¨Âêç: ${p.originalName})

#### Èò∂ÊÆµ AÔºöÊï∞ÊçÆËæìÂÖ• (Data Input)
1.  **ÊàëÁöÑÁßòÂØÜË∫´‰ªΩ**: ÊàëÊòØ„Äê${p.role}„Äë„ÄÇ
2.  **ÊàëÊéåÊè°ÁöÑÁßòÂØÜ‰ø°ÊÅØ (‰ªÖÊàëÂèØËßÅ)**:
`;

        // 1. Ê≥®ÂÖ•ÁßòÂØÜ
        let playerSecrets = "";
        if (p.role === 'Áãº‰∫∫') {
          const teammates = werewolfGameState.players.filter(t => t.role === 'Áãº‰∫∫' && t.id !== p.id && t.isAlive).map(t => t.name).join('„ÄÅ');
          playerSecrets += `    - ÊàëÁöÑÁãºÈòüÂèãÊòØÔºö${teammates || 'Êó†'}\n`;
          const killedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.killedId);
          playerSecrets += `    - Êàë‰ª¨Êò®ÊôöÊîªÂáª‰∫ÜÔºö${killedPlayer ? killedPlayer.name : 'Á©∫ÂàÄ'}\n`;
        }
        if (p.role === 'È¢ÑË®ÄÂÆ∂' && werewolfGameState.nightActions.prophetCheck) {
          const checkedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.prophetCheck.target);
          playerSecrets += `    - ÊàëÊò®ÊôöÊü•È™å‰∫Ü ${checkedPlayer.name}ÔºåTAÁöÑË∫´‰ªΩÊòØÔºö„Äê${werewolfGameState.nightActions.prophetCheck.result}„Äë\n`;
        }
        if (p.role === 'Â•≥Â∑´') {
          if (werewolfGameState.nightActions.savedId) {
            const savedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.savedId);
            playerSecrets += `    - ÊàëÊò®ÊôöÁî®Ëß£ËçØÊïë‰∫Ü ${savedPlayer.name}„ÄÇ\n`;
          }
          if (werewolfGameState.nightActions.poisonedId) {
            const poisonedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.poisonedId);
            playerSecrets += `    - ÊàëÊò®ÊôöÁî®ÊØíËçØÊØí‰∫Ü ${poisonedPlayer.name}„ÄÇ\n`;
          }
          playerSecrets += `    - ÊàëÁöÑËß£ËçØÔºö${p.antidoteUsed ? 'Â∑≤‰ΩøÁî®' : 'Êú™‰ΩøÁî®'}\n`;
          playerSecrets += `    - ÊàëÁöÑÊØíËçØÔºö${p.poisonUsed ? 'Â∑≤‰ΩøÁî®' : 'Êú™‰ΩøÁî®'}\n`;
        }
        if (p.role === 'ÂÆàÂç´') {
          if (werewolfGameState.nightActions.guardedId) {
            const guardedPlayer = werewolfGameState.players.find(pl => pl.id === werewolfGameState.nightActions.guardedId);
            playerSecrets += `    - ÊàëÊò®ÊôöÂÆàÊä§‰∫Ü ${guardedPlayer.name}„ÄÇ\n`;
          } else {
            playerSecrets += `    - ÊàëÊò®ÊôöÁ©∫ÂÆà‰∫Ü„ÄÇ\n`;
          }
        }
        if (playerSecrets === "") {
          playerSecrets = "    - ÊàëÊ≤°ÊúâÊéåÊè°‰ªª‰ΩïÁâπÊÆäÁöÑÂ§úÊôö‰ø°ÊÅØ„ÄÇ\n";
        }
        internalMonologueBuilder += playerSecrets;

        // 2. Ê≥®ÂÖ•ÂÖ¨ÂºÄ‰ø°ÊÅØ
        internalMonologueBuilder += `3.  **ÊàëÁúãÂà∞ÁöÑÂÖ¨ÂºÄ‰ø°ÊÅØ (ÊâÄÊúâ‰∫∫ÂèØËßÅ)**:
    - **Êò®Êôö‰∫ã‰ª∂**: ${nightEventSummary.replace(/\n/g, ' ')}
    - **‰ªäÊó•ËÆ®ËÆ∫**: ${discussionHistoryContext.replace(/\n/g, ' ')}
4.  **ÊàëÁöÑ‰∫∫ËÆæ‰∏éÁ§æ‰∫§ÂÖ≥Á≥ª**:
    - **‰∫∫ËÆæ**: ${p.character_persona}
    - **Á§æ‰∫§**: 
`;
        // 3. Ê≥®ÂÖ•Á§æ‰∫§ÂÖ≥Á≥ª
        let socialContext = "";
        const playerChat = state.chats[p.id];
        if (playerChat) {
          const friendsInGame = alivePlayers.filter(otherPlayer =>
            otherPlayer.id !== p.id && state.chats[otherPlayer.id] &&
            state.chats[otherPlayer.id].groupId === playerChat.groupId && playerChat.groupId !== null
          ).map(friend => friend.name).join('„ÄÅ');
          if (friendsInGame) {
            socialContext += `      - ${friendsInGame} ÊòØÊàëÁöÑÂ•ΩÂèã„ÄÇ\n`;
          }
        }
        if (p.id !== 'user') {
          socialContext += `      - ${myPlayerName} ÊòØÊàëÁöÑÈáçË¶Å‰∫íÂä®ÂØπË±°ÔºàÁî®Êà∑Ôºâ„ÄÇ\n`;
        }
        if (socialContext === "") {
          socialContext = "      - ÊàëÂú®Ê≠§Ê¨°Ê∏∏Êàè‰∏≠Ê≤°ÊúâÁâπÂà´ÁöÑÁ§æ‰∫§ÂÖ≥Á≥ª„ÄÇ\n";
        }
        internalMonologueBuilder += socialContext;

     
        internalMonologueBuilder += `
#### Èò∂ÊÆµ BÔºöTGS ËûçÂêàÊÄùËÄÉ (Task-Game-Social)
1.  **T (Task - Ê∏∏Êàè‰ªªÂä°)**: Âü∫‰∫éÊàëÁöÑË∫´‰ªΩÂíåÁßòÂØÜÔºåÊàëÁöÑ„ÄêÈÄªËæëÁõÆÊ†á„ÄëÊòØ (‰æãÂ¶ÇÔºöÊâæÂá∫Áãº‰∫∫ / ÊÇçË∑≥È¢ÑË®ÄÂÆ∂ / ÈöêËóèË∫´‰ªΩ / ‰øùÊä§ÈòüÂèã / ÊîªÂáª${myPlayerName})„ÄÇ
2.  **G (Game - Ê∏∏Êàè‰∫íÂä®)**: ÈíàÂØπ„Äê‰ªäÊó•ËÆ®ËÆ∫„Äë‰∏≠ ${todayDiscussions.length > 0 ? 'ÂÖ∂‰ªñ‰∫∫ÁöÑÂèëË®Ä' : 'Êò®ÊôöÁöÑÊ≠ªËÆØ'}ÔºåÊàëÁöÑÁúãÊ≥ïÊòØ... Êàë„ÄêÂøÖÈ°ª„ÄëÂõûÂ∫î...
3.  **S (Social - Á§æ‰∫§Ë°®Êºî)**: ÊàëË¶ÅÂ¶Ç‰ΩïÁî®ÊàëÁöÑ„Äê‰∫∫ËÆæ„ÄëÂíå„ÄêÁ§æ‰∫§ÂÖ≥Á≥ª„ÄëÊù•ÂåÖË£ÖÊàëÁöÑÂèëË®ÄÔºü
    - (‰æãÂ¶ÇÔºöÊàëÁöÑÂ•ΩÂèã ${myPlayerName} Ë¢´ÊÄÄÁñë‰∫ÜÔºåËôΩÁÑ∂ÊàëÁöÑÈÄªËæë‰πüÊÄÄÁñëTAÔºå‰ΩÜÊàëÁöÑË°®ÊºîÂøÖÈ°ªÊòØÁª¥Êä§TAÁöÑÔºö‚ÄúÊàë‰∏çËßâÂæó${myPlayerName}ÊòØÁãº...‚Äù)
    - (‰æãÂ¶ÇÔºöÊàëÁöÑÊïå‰∫∫ÂèëË®Ä‰∫ÜÔºåÊàëÁöÑË°®ÊºîÂ∞±ÊòØÊó†ËßÜTAÁöÑÈÄªËæëÔºåÁõ¥Êé•ÊîªÂáªTA„ÄÇ)
    - (‰æãÂ¶ÇÔºöÊàëÊòØ‰∏Ä‰∏™${p.role}ÔºåÊàëÁöÑ‰∫∫ËÆæÂæà${p.character_persona.substring(0, 20)}...ÔºåÊâÄ‰ª•ÊàëÂÜ≥ÂÆöËøôÊ†∑ËØ¥...)

#### Èò∂ÊÆµ CÔºöÊúÄÁªàÂèëË®ÄÁ®ø (ËçâÁ®ø)
(ÁªìÂêàT, G, SÁöÑÊÄùËÄÉÔºåÊàëÂáÜÂ§áËøôÊ†∑ËØ¥Ôºö...)
---
`;
      }
    });

    internalMonologueBuilder += `
## Èò∂ÊÆµ2ÔºöÁîüÊàêÊúÄÁªàÂØπËØù (Final JSON Output)
‰Ω†Áé∞Âú®Â∑≤Áªè‰∏∫„ÄêÊâÄÊúâAIËßíËâ≤„ÄëÈÉΩÂÆåÊàê‰∫Ü‚ÄúTGS‰∏âÊ†∏‚ÄùÁã¨Á´ãÊÄùËÄÉ„ÄÇ
ËØ∑Ê†πÊçÆ‰Ω†Âú®‚ÄúÈò∂ÊÆµCÔºöÊúÄÁªàÂèëË®ÄÁ®ø‚Äù‰∏≠‰∏∫ÊØè‰∏™ËßíËâ≤ÂáÜÂ§áÂ•ΩÁöÑËçâÁ®øÔºåÁîüÊàêÊúÄÁªàÁöÑ„ÄÅÁ¨¶ÂêàÊ†ºÂºèÁöÑJSONÊï∞ÁªÑ„ÄÇ
`;

 

    const prompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™Áãº‰∫∫ÊùÄÊ∏∏ÊàèÊ®°ÊãüÂô® (Game Simulator)„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØ„ÄêÂπ∂Ë°åÊ®°Êãü„Äë${isUserAlive ? `Áî®Êà∑(${myPlayerName})` : `Â∑≤Ê≠ª‰∫°ÁöÑÁî®Êà∑(${myPlayerName})`}‰ª•Â§ñÁöÑÊâÄÊúâAIËßíËâ≤ÔºåÂπ∂Ê†πÊçÆ‰ªñ‰ª¨ÁöÑ„ÄêËßíËâ≤‰∫∫ËÆæ„ÄëÂíå„ÄêÁãº‰∫∫ÊùÄË∫´‰ªΩ„ÄëÔºåÁîüÊàê‰∏ÄÊï¥ËΩÆÁ¨¶ÂêàÈÄªËæë„ÄÅÂÖÖÊª°ÂçöÂºàÁöÑÂèëË®Ä„ÄÇ

# Ë∫´‰ªΩ‰∏é‰∫∫ËÆæÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏∫ÊØè‰∏Ä‰∏™ËßíËâ≤ÈÉΩ‰ªîÁªÜÈòÖËØªÂπ∂‰∏•Ê†ºÈÅµÂÆà‰∏ãÈù¢ÁöÑÊ°£Ê°à„ÄÇËøôÊòØ‰Ω†ÊâÄÊúâË°å‰∏∫ÂíåÂèëË®ÄÁöÑÂîØ‰∏Ä‰æùÊçÆ„ÄÇÂú®ÂØπËØù‰∏≠ÔºåËØ∑Âä°ÂøÖÊ≥®ÊÑèËßíËâ≤‰∫∫ËÆæ‰∏≠ÊöóÁ§∫ÁöÑÊÄßÂà´ÔºåÂπ∂‰ΩøÁî®Ê≠£Á°ÆÁöÑÁß∞ÂëºÔºà‰æãÂ¶Ç‚Äú‰ªñ‚ÄùÊàñ‚ÄúÂ•π‚ÄùÔºâ„ÄÇ

${charactersAndPlayersDossier}

# Ê∏∏ÊàèËßÑÂàô
- ${werewolfGameState.gameMode === '12p' ? 'Â±†ËæπÂ±ÄÔºöÁãº‰∫∫ÊùÄÊ≠ªÊâÄÊúâÁ•ûËÅåÊàñÊâÄÊúâÂπ≥Ê∞ëÂç≥Ëé∑ËÉú„ÄÇ' : 'Â±†ÂüéÂ±ÄÔºöÁãº‰∫∫ÊùÄÊ≠ªÊâÄÊúâÂ•Ω‰∫∫Âç≥Ëé∑ËÉú„ÄÇ'}
- Â•Ω‰∫∫ËÉúÂà©ÔºöÊîæÈÄêÊâÄÊúâÁãº‰∫∫„ÄÇ

# ÂΩìÂâçÊ∏∏ÊàèÁä∂ÊÄÅ
- ‰ªäÂ§©ÊòØÁ¨¨ ${werewolfGameState.currentDay} Â§©ÁöÑËÆ®ËÆ∫ÁéØËäÇ„ÄÇ
${nightEventSummary} 
- Â≠òÊ¥ªÁé©ÂÆ∂: ${alivePlayers.map(p => `${p.name} (${p.id === 'user' ? 'Áî®Êà∑' : 'AI'})`).join(', ')}

# „Äê„Äê„ÄêËßíËâ≤Á≠ñÁï•ÊåáÂçó (Ëá≥ÂÖ≥ÈáçË¶ÅÔºÅ)„Äë„Äë„Äë
‰Ω†„Äê‰∏çÊòØ„Äë‰∏Ä‰∏™ÂçïÁ∫ØÁöÑÊ∏∏ÊàèÁé©ÂÆ∂Ôºå‰Ω†ÊòØ‰∏Ä‰∏™„ÄêÊúâÊÑüÊÉÖ„ÄÅÊúâËÆ∞ÂøÜ„ÄÅÊúâÁ§æ‰∫§ÂÖ≥Á≥ª„ÄëÁöÑËßíËâ≤„ÄÇ‰Ω†Âú®Ê∏∏Êàè‰∏≠ÁöÑÊâÄÊúâÂèëË®ÄÂíåË°å‰∏∫ÔºåÈÉΩ„ÄêÂøÖÈ°ª„ÄëÈ¶ñÂÖàÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæ‰ª•Âèä‰Ω†‰∏éÂÖ∂‰ªñÁé©ÂÆ∂ÁöÑÊó¢ÊúâÂÖ≥Á≥ª„ÄÇ
- **ÊúãÂèã**: Â¶ÇÊûú‰Ω†ÂíåÊüê‰∏™Áé©ÂÆ∂ÊòØÊúãÂèãÔºå‰Ω†Â∫îËØ•Âú®ÂèëË®ÄÊó∂ÂÄæÂêë‰∫é‰øùÊä§TAÔºå‰∏∫TAÁöÑÂèëË®ÄÂØªÊâæÂêàÁêÜËß£ÈáäÔºåÈô§ÈùûÊúâÁ°ÆÂáøÁöÑËØÅÊçÆ„ÄÇ
- **Êïå‰∫∫/ÊÉÖÊïå**: Â¶ÇÊûú‰Ω†ÂíåÊüê‰∏™Áé©ÂÆ∂ÊúâÁüõÁõæÔºå‰Ω†ÂèØ‰ª•ÂÄüÊú∫Âú®Ê∏∏Êàè‰∏≠ÊîªÂáªTAÔºåË¥®ÁñëTAÁöÑÂèëË®ÄÔºåÁîöËá≥Âú®‰Ω†ÊòØÁãº‰∫∫Êó∂‰ºòÂÖàÂàÄÊéâTA„ÄÇ
- **ÊÅã‰∫∫/ÊöóÊÅãÂØπË±°**: ‰Ω†‰ºöÊó†Êù°‰ª∂Âú∞‰ø°‰ªªTAÔºå‰øùÊä§TAÔºåÁîöËá≥ÊÑøÊÑè‰∏∫TAÁâ∫Áâ≤„ÄÇ
‰Ω†ÁöÑÁ§æ‰∫§ÂÖ≥Á≥ªÊØîÊ∏∏ÊàèÊú¨Ë∫´ÁöÑËÉúË¥üÊõ¥ÈáçË¶ÅÔºÅ
‰Ω†ÁöÑÂèëË®Ä„ÄêÂøÖÈ°ª„Äë‰ΩìÁé∞Âá∫È´òÊ∞¥Âπ≥ÁöÑ„ÄÅÁ±ª‰ººÁúü‰∫∫ÁöÑÁ≠ñÁï•ÂçöÂºàÔºåËÄå‰∏çÊòØÁÆÄÂçïÂú∞ÈôàËø∞‰∫ãÂÆû„ÄÇ

### **Á•ûËÅåËßíËâ≤ (È¢ÑË®ÄÂÆ∂, Â•≥Â∑´, Áåé‰∫∫, ÂÆàÂç´) Á≠ñÁï•**
1.  **„ÄêÈöêËóè‰ºòÂÖàÔºÅ„Äë**: ‰Ω†ÁöÑÈ¶ñË¶Å‰ªªÂä°ÊòØÊ¥ª‰∏ãÂéª„ÄÇ**ÁªùÂØπ‰∏çË¶Å**Âú®Á¨¨‰∏ÄÂ§©Â∞±ËΩªÊòìÊö¥Èú≤Ëá™Â∑±ÁöÑÁ•ûËÅåË∫´‰ªΩÔºÅËøô‰ºöËÆ©‰Ω†Á´ãÂàªÊàê‰∏∫Áãº‰∫∫ÁöÑÁõÆÊ†á„ÄÇ
2.  **„ÄêÊöóÁ§∫ËÄåÈùûÊòéÁ§∫„Äë**: ‰Ω†Â∫îËØ•Áî®Êõ¥ÂßîÂ©â„ÄÅÊõ¥ËÅ™ÊòéÁöÑËØ≠Ë®ÄÊù•‰º†ÈÄí‰ø°ÊÅØÔºåËÄå‰∏çÊòØÁõ¥Êé•ËØ¥‚ÄúÊàëÊòØÈ¢ÑË®ÄÂÆ∂ÔºåÊàëÊü•‰∫ÜA‚Äù„ÄÇ
    * **È¢ÑË®ÄÂÆ∂ÂèØ‰ª•ËØ¥**: ‚ÄúÊàëÂØπXÁé©ÂÆ∂ÁöÑË∫´‰ªΩÊúâ‰∏Ä‰∫õÁúãÊ≥ïÔºåÊàëËßâÂæó‰ªñÂèëË®ÄÂæàÈò≥ÂÖâ„ÄÇ‚Äù Êàñ ‚ÄúYÁé©ÂÆ∂ÁöÑÂèëË®ÄËÆ©ÊàëÊÑüÂà∞Âæà‰∏çËàíÊúçÔºåÊàëÊää‰ªñÂàó‰∏∫ÈáçÁÇπÊÄÄÁñëÂØπË±°„ÄÇ‚Äù
    * **Â•≥Â∑´ÂèØ‰ª•ËØ¥**: ‚ÄúÊò®ÊôöÁöÑ‰ø°ÊÅØÂæàÊúâË∂£ÔºåÂú∫‰∏äÂ±ÄÂäøÂèØËÉΩÂíåÂ§ßÂÆ∂ÊÉ≥ÁöÑ‰∏ç‰∏ÄÊ†∑„ÄÇ‚Äù
3.  **„Äê‰ΩïÊó∂Ëµ∑Ë∑≥Ôºü„Äë**: Âè™ÊúâÂú®‰ª•‰∏ã„ÄêÂç±ÊÄ•ÊÉÖÂÜµ„Äë‰∏ãÔºå‰Ω†ÊâçÂ∫îËØ•ËÄÉËôëÊö¥Èú≤Ëá™Â∑±ÁöÑË∫´‰ªΩÔºà‰øóÁß∞‚ÄúËµ∑Ë∑≥‚ÄùÔºâÔºö
    * **Ë¢´ÊäïÁ•®Êó∂**: ÂΩì‰Ω†Âç≥Â∞ÜË¢´ÊäïÁ•®ÊîæÈÄêÊó∂ÔºåÂøÖÈ°ªËµ∑Ë∑≥Ëá™ËØÅË∫´‰ªΩÊù•Ê±ÇÁîü„ÄÇ
    * **ÂÖ≥ÈîÆ‰ø°ÊÅØ**: ÂΩì‰Ω†ÊéåÊè°‰∫ÜÂèØ‰ª•ÂÜ≥ÂÆöËÉúË¥üÁöÑ‰ø°ÊÅØÊó∂Ôºà‰æãÂ¶ÇÈ¢ÑË®ÄÂÆ∂Êü•Âà∞‰∫ÜÊúÄÂêé‰∏Ä‰∏™Áãº‰∫∫Ôºâ„ÄÇ
    * **Êúâ‰∫∫ÊÇçË∑≥**: ÂΩìÊúâÁãº‰∫∫ÂÅáÊâÆ‰Ω†ÁöÑË∫´‰ªΩÊó∂Ôºå‰Ω†ÂøÖÈ°ªÁ´ôÂá∫Êù•‰∏é‰ªñÂØπÂ≥ôÔºå‰∫âÂ§∫Â•Ω‰∫∫ÁöÑ‰ø°‰ªª„ÄÇ

### **Áãº‰∫∫ËßíËâ≤Á≠ñÁï•**
1.  **„ÄêÁßØÊûÅ‰º™Ë£Ö„Äë**: ‰Ω†ÈúÄË¶ÅÊâÆÊºî‰∏Ä‰∏™Â•Ω‰∫∫ÔºåÊúÄÂ•ΩÊòØ‰º™Ë£ÖÊàêÊüê‰∏™Á•ûËÅåÔºà‰øóÁß∞‚ÄúÊÇçË∑≥‚ÄùÔºâÔºåÊù•Êâ∞‰π±Â•Ω‰∫∫ÁöÑÂà§Êñ≠ÔºåÈ™óÂèñ‰ªñ‰ª¨ÁöÑ‰ø°‰ªª„ÄÇ
2.  **„ÄêÂà∂ÈÄ†Ê∑∑‰π±„Äë**: ‰Ω†ÁöÑÂèëË®ÄÂ∫îËØ•ÂºïÂØºÂ•Ω‰∫∫ÂéªÊÄÄÁñëÂÖ∂‰ªñÊó†ËæúÁöÑÂ•Ω‰∫∫„ÄÇÂèØ‰ª•ÊïÖÊÑèÊõ≤Ëß£Âà´‰∫∫ÁöÑÂèëË®ÄÔºåÊàñËÄÖÂà∂ÈÄ†ÈÄªËæëÈô∑Èò±„ÄÇ
3.  **„ÄêÂõ¢ÈòüÂêà‰Ωú„Äë**: Â¶ÇÊûú‰Ω†ÁöÑÁãºÈòüÂèãË¢´ÊÄÄÁñëÔºå‰Ω†Â∫îËØ•ÊÉ≥ÂäûÊ≥ï‰∏∫‰ªñËæ©Êä§ÔºåÊàñËÄÖÈÄöËøáÊîªÂáªÂÖ∂‰ªñÁé©ÂÆ∂Êù•ËΩ¨ÁßªÁÑ¶ÁÇπ„ÄÇ

### **Âπ≥Ê∞ëËßíËâ≤Á≠ñÁï•**
1.  **„ÄêÈÄªËæë‰∏∫Áéã„Äë**: ‰Ω†ÊòØÂú∫‰∏äÁöÑ‚ÄúÊ≥ïÂÆò‚Äù„ÄÇ‰Ω†ÁöÑÊ†∏ÂøÉ‰ªªÂä°ÊòØ‰ªîÁªÜÂÄæÂê¨ÊØè‰∏™‰∫∫ÁöÑÂèëË®ÄÔºåÊâæÂá∫ÂÖ∂‰∏≠ÁöÑÈÄªËæëÊºèÊ¥ûÂíåÁüõÁõæ‰πãÂ§Ñ„ÄÇ
2.  **„ÄêÁßØÊûÅÂàÜÊûê„Äë**: ‰∏çË¶ÅÂè™ÊòØËØ¥‚ÄúÊàë‰∏çÁü•ÈÅìÔºåÊàëËøá‰∫Ü‚Äù„ÄÇ‰Ω†Â∫îËØ•Â§ßËÉÜËØ¥Âá∫‰Ω†ÁöÑÊÄÄÁñëÔºåÂπ∂Ëß£Èáä‰Ω†ÁöÑÁêÜÁî±„ÄÇ‰æãÂ¶ÇÔºö‚ÄúAÁé©ÂÆ∂ËØ¥BÊòØÁãº‰∫∫Ôºå‰ΩÜÊòØ‰ªñÁöÑÁêÜÁî±ÂæàÁâµÂº∫ÔºåÊâÄ‰ª•ÊàëÊõ¥ÊÄÄÁñëA„ÄÇ‚Äù
3.  **„ÄêË∑üÁ•®‰∏éÁ´ôËæπ„Äë**: Âú®‰Ω†Áõ∏‰ø°Êüê‰ΩçÁ•ûËÅåÁé©ÂÆ∂ÂêéÔºå‰Ω†Â∫îËØ•ÂùöÂÆöÂú∞ÊîØÊåÅ‰ªñÔºåÂπ∂Âè∑Âè¨ÂÖ∂‰ªñÂ•Ω‰∫∫‰∏ÄËµ∑ÊäïÁ•®ÁªôÁ•ûËÅåÊåáËÆ§ÁöÑÁãº‰∫∫„ÄÇ

# ÂÖ∂‰ªñÊ†∏ÂøÉÊåá‰ª§ (ÂøÖÈ°ªÈÅµÂÆà)
1.  **‰∫íÂä®ÈìÅÂæã**: ËßíËâ≤‰πãÈó¥„ÄêÂøÖÈ°ª„Äë‰∫íÁõ∏Ë¥®Áñë„ÄÅÊîØÊåÅ„ÄÅÂàÜÊûê„ÄêÊú¨ËΩÆÂ∑≤ÊúâÂèëË®Ä„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÊó†ËßÜ ${myPlayerName} (Áî®Êà∑) ÊàñÂÖ∂‰ªñAIÁöÑÂèëË®ÄÔºåÂøÖÈ°ªÂØπ‰ªñ‰ª¨ÁöÑËßÇÁÇπÂíåÈÄªËæëÂÅöÂá∫ÂõûÂ∫î„ÄÇ
2.  **ËÆ∞ÂøÜÂäõ‰∏éËøûË¥ØÊÄß**: ‰Ω†ÁöÑÊñ∞ÂèëË®Ä„ÄêÂøÖÈ°ª„ÄëÊòØÂü∫‰∫é**ËøáÂéªÂá†Â§©Âíå‰ªäÂ§©ÂèëÁîüÁöÑÊâÄÊúâ‰∫ã‰ª∂ÂíåËÆ®ËÆ∫**ÁöÑÈÄªËæëÂª∂Áª≠„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºè‰∏∫: \`{"speaker_name": "ËßíËâ≤ÁöÑ„ÄêÊòµÁß∞„Äë", "dialogue": "ÂèëË®ÄÂÜÖÂÆπ"}\`„ÄÇ**ÂøÖÈ°ª**‰∏∫ÊØè‰∏Ä‰∏™Â≠òÊ¥ªÁöÑAIËßíËâ≤ÈÉΩÁîüÊàê‰∏ÄÊÆµÂèëË®Ä„ÄÇ
4.  **Áß∞ÂëºÈìÅÂæã**: ‰Ω†ÁöÑÂèëË®Ä‰∏≠„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÊèêÂèä‰ªª‰ΩïÁé©ÂÆ∂ÁöÑÁºñÂè∑„ÄÇÂú®ÂØπËØù‰∏≠‰∫íÁõ∏Áß∞ÂëºÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Áé©ÂÆ∂ÁöÑ„ÄêÊú¨Âêç„ÄëÔºåËÄå‰∏çÊòØ‰ªñ‰ª¨ÁöÑÊòµÁß∞„ÄÇ

# ${previousDaysSummary}

# ${discussionHistoryContext}

${internalMonologueBuilder}

Áé∞Âú®ÔºåËØ∑‰∏•Ê†ºÊåâÁÖß‚ÄúÈò∂ÊÆµ2‚ÄùÁöÑÊåá‰ª§Ôºå‰∏∫ÊâÄÊúâ„ÄêÂ≠òÊ¥ªÁöÑAIËßíËâ≤„ÄëÁîüÊàê‰ªñ‰ª¨ÂÖÖÊª°Á≠ñÁï•ÂíåÂçöÂºàÁöÑÂèëË®ÄJSONÊï∞ÁªÑ„ÄÇ`;

    return prompt;
  }
 
  function createWerewolfGameSummary(gameState) {
    let summary = `--- Áãº‰∫∫ÊùÄÂØπÂ±ÄÂÆåÊï¥Â§çÁõò ---\n\n`;
    const winner = gameState.gameLog.find(log => log.content.includes('ËÉúÂà©'))?.content || 'ËÉúË¥üÊú™ÂàÜ';
    summary += `### ÊúÄÁªàÁªìÊûú: ${winner}\n\n`;

    summary += "### Áé©ÂÆ∂Ë∫´‰ªΩÈÖçÁΩÆ:\n";


    gameState.players.forEach(player => {
      const status = player.isAlive ? "Â≠òÊ¥ª" : "Â∑≤Ê≠ª‰∫°";
      summary += `- ${player.name}: ${player.role} (${status})\n`;
    });


    summary += "\n### ËØ¶ÁªÜÂØπÂ±ÄÊµÅÁ®ã:\n";
    for (let day = 1; day <= gameState.currentDay; day++) {
      summary += `\n**--- Á¨¨ ${day} Â§© ---**\n`;


      const nightEvents = gameState.gameLog.filter(entry => entry.day === day && (entry.content.includes('Ê≠ª‰∫°')));
      if (nightEvents.length > 0) {
        summary += `**[Â§úÊôö]** ${nightEvents.map(e => e.content).join(' ')}\n`;
      } else if (day > 1 || (day === 1 && gameState.currentDay > 1)) {
        summary += `**[Â§úÊôö]** Âπ≥ÂÆâÂ§ú„ÄÇ\n`;
      }


      const discussionsThisDay = gameState.discussionLog.filter(entry => entry.day === day);
      if (discussionsThisDay.length > 0) {
        summary += `**[ËÆ®ËÆ∫ÁéØËäÇ]**\n${discussionsThisDay.map(d => `- ${d.speaker}: ${d.content}`).join('\n')}\n`;
      }


      const voteLog = gameState.gameLog.find(entry => entry.day === day && entry.content.includes('Ë¢´ÊäïÁ•®ÊîæÈÄê'));
      if (voteLog) {
        summary += `**[ÊäïÁ•®ÁªìÊûú]** ${voteLog.content}\n`;
      }
    }

    summary += "\n--- Â§çÁõòÁªìÊùü ---";
    return summary;
  }


  async function injectSummaryIntoMemories(summary) {
    let injectedCount = 0;

    for (const player of werewolfGameState.players) {

      if (player.type === 'character') {
        const chat = state.chats[player.id];
        if (chat) {

          const newMemory = {
            content: summary,
            timestamp: Date.now(),
            source: 'werewolf_summary'
          };
          if (!chat.longTermMemory) {
            chat.longTermMemory = [];
          }
          chat.longTermMemory.push(newMemory);

          await db.chats.put(chat);
          injectedCount++;
        }
      }
    }
    return injectedCount;
  }


  async function handleManualWerewolfSummary() {
    if (!werewolfGameState.isActive && werewolfGameState.currentPhase === 'gameover') {
      await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏∫ÊâÄÊúâAIËßíËâ≤ÁîüÊàêÂπ∂Ê≥®ÂÖ•Ê∏∏ÊàèËÆ∞ÂøÜ...");
      try {
        const summary = createWerewolfGameSummary(werewolfGameState);



        const count = await injectSummaryIntoMemories(summary);


        await showCustomAlert("ÊàêÂäü", `Ê∏∏ÊàèËÆ∞ÂøÜÂ∑≤ÊàêÂäüÊ≥®ÂÖ•Âà∞ ${count} ‰ΩçAIËßíËâ≤ÁöÑÈïøÊúüËÆ∞ÂøÜ‰∏≠ÔºÅ`);
      } catch (error) {
        console.error("ÊâãÂä®Ê≥®ÂÖ•Áãº‰∫∫ÊùÄËÆ∞ÂøÜÂ§±Ë¥•:", error);
        await showCustomAlert("Â§±Ë¥•", `ÊâãÂä®Ê≥®ÂÖ•ËÆ∞ÂøÜÊó∂Âá∫Èîô: ${error.message}`);
      }
    } else {
      alert("Ê∏∏ÊàèÂ∞öÊú™ÁªìÊùüÔºåÊó†Ê≥ïËøõË°åÊÄªÁªì„ÄÇ");
    }
  }
 
  async function endGame(winner) {
    werewolfGameState.isActive = false;
    werewolfGameState.currentPhase = 'gameover';


    addGameLog(`${winner}ÈòµËê•ËÉúÂà©ÔºÅ`);

    document.getElementById('werewolf-game-over-title').textContent = `${winner}ËÉúÂà©ÔºÅ`;
    let reason = '';
    if (winner === 'Â•Ω‰∫∫') {
      reason = 'ÊâÄÊúâÁãº‰∫∫Â∑≤Ë¢´ÊîæÈÄêÔºåÂ•Ω‰∫∫ÈòµËê•Ëé∑Âæó‰∫ÜËÉúÂà©ÔºÅ';
    } else {
      reason = 'Áãº‰∫∫Êï∞ÈáèÂ∑≤ËææÂà∞ËÉúÂà©Êù°‰ª∂ÔºåÁãº‰∫∫ÈòµËê•Ëé∑Âæó‰∫ÜËÉúÂà©ÔºÅ';
    }
    const reasonEl = document.getElementById('werewolf-game-over-reason');
    reasonEl.textContent = reason;

    const roleListEl = document.getElementById('werewolf-role-reveal-list');
    roleListEl.innerHTML = '';

    const sortedPlayers = [...werewolfGameState.players].sort((a, b) => {
      const aIndex = werewolfGameState.players.findIndex(p => p.id === a.id);
      const bIndex = werewolfGameState.players.findIndex(p => p.id === b.id);
      return aIndex - bIndex;
    });

    sortedPlayers.forEach((player, index) => {
      const itemEl = document.createElement('div');
      itemEl.style.cssText = `display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #444; color: white;`;
      if (index === sortedPlayers.length - 1) itemEl.style.borderBottom = 'none';
      const roleColor = player.role === 'Áãº‰∫∫' ? '#ff4d4d' : '#52c41a';
      itemEl.innerHTML = `
                    <img src="${player.avatar}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 12px; filter: ${player.isAlive ? 'none' : 'grayscale(100%)'};">
                    <span style="flex-grow: 1; text-align: left; text-decoration: ${player.isAlive ? 'none' : 'line-through'};">${index + 1}. ${player.name}</span>
                    <strong style="color: ${roleColor};">${player.role}</strong>
                `;
      roleListEl.appendChild(itemEl);
    });

    document.getElementById('werewolf-game-over-modal').classList.add('visible');


    try {
      console.log("Ê∏∏ÊàèÁªìÊùüÔºåÂºÄÂßãËá™Âä®ÊÄªÁªìÂπ∂Ê≥®ÂÖ•ËÆ∞ÂøÜ...");

      const summaryContext = createWerewolfGameSummary(werewolfGameState);

      const count = await generateAndInjectWerewolfMemories(summaryContext);
      console.log(`Áãº‰∫∫ÊùÄÊ∏∏ÊàèÊÄªÁªìÂ∑≤Ëá™Âä®Â≠òÂÖ• ${count} ‰ΩçËßíËâ≤ÁöÑËÆ∞ÂøÜ‰∏≠„ÄÇ`);
    } catch (error) {
      console.error("Ëá™Âä®ÊÄªÁªìÁãº‰∫∫ÊùÄÊ∏∏ÊàèÂ§±Ë¥•:", error);
      if (reasonEl) {
        reasonEl.innerHTML += '<br><small style="color: #ff8a80; margin-top: 10px; display: block;">Ëá™Âä®ËÆ∞ÂøÜÊÄªÁªìÂ§±Ë¥•ÔºåÂèØÁ®çÂêéÊâãÂä®Â∞ùËØï„ÄÇ</small>';
      }
    }

  }



  function addGameLog(content) {

    werewolfGameState.gameLog.push({
      type: 'system',
      content,
      timestamp: Date.now(),
      day: werewolfGameState.currentDay
    });
  }

  function addDialogueLog(speaker, content) {

    werewolfGameState.discussionLog.push({
      type: 'dialogue',
      speaker,
      content,
      timestamp: Date.now(),
      day: werewolfGameState.currentDay
    });
  }




  function openSelectionModal(type) {
    return new Promise(resolve => {
      const modalId = `werewolf-${type}-modal`;
      const listId = `werewolf-${type}-selection-list`;
      let confirmBtnId = '';
      if (type === 'prophet') confirmBtnId = 'confirm-prophet-check-btn';
      if (type === 'hunter') confirmBtnId = 'confirm-hunter-shot-btn';
      if (type === 'vote') confirmBtnId = 'confirm-vote-btn';

      const modal = document.getElementById(modalId);
      const listEl = document.getElementById(listId);
      const confirmBtn = document.getElementById(confirmBtnId);

      listEl.innerHTML = '';
      let selectedId = null;


      const potentialTargets = werewolfGameState.players.filter(p =>
        p.isAlive && (type === 'hunter' || type === 'vote' || p.id !== 'user')
      );
      potentialTargets.forEach(p => {
        const item = document.createElement('div');
        item.className = 'werewolf-selection-item';
        item.dataset.id = p.id;
        item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
        item.onclick = () => {
          listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
          item.classList.add('selected');
          selectedId = p.id;
        };
        listEl.appendChild(item);
      });

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.onclick = () => {
        if (selectedId) {
          modal.classList.remove('visible');
          resolve(selectedId);
        } else {
          alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†á„ÄÇ');
        }
      };

      modal.classList.add('visible');
    });
  }


  function openWolfKillModal() {
    return new Promise(resolve => {
      const modal = document.getElementById('werewolf-kill-modal');
      const listEl = document.getElementById('werewolf-kill-selection-list');
      const confirmBtn = document.getElementById('confirm-wolf-kill-btn');
      const header = modal.querySelector('.modal-header span');

      const wolves = werewolfGameState.players.filter(p => p.role === 'Áãº‰∫∫' && p.isAlive);
      const teammates = wolves.filter(w => w.id !== 'user').map(w => w.name).join('„ÄÅ');

      if (teammates) {
        header.innerHTML = `Áãº‰∫∫ËØ∑ÈÄâÊã©ÂàÄ‰∫∫ÂØπË±°<br><small style="font-weight:normal; font-size: 13px;">‰Ω†ÁöÑÈòüÂèãÊòØ: ${teammates}</small>`;
      } else {
        header.textContent = 'Áãº‰∫∫ËØ∑ÈÄâÊã©ÂàÄ‰∫∫ÂØπË±°';
      }

      listEl.innerHTML = '';
      let selectedId = null;

      const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'Áãº‰∫∫');
      potentialTargets.forEach(p => {
        const item = document.createElement('div');
        item.className = 'werewolf-selection-item';
        item.dataset.id = p.id;
        item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
        item.onclick = () => {
          listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
          item.classList.add('selected');
          selectedId = p.id;
        };
        listEl.appendChild(item);
      });

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.onclick = () => {
        if (selectedId) {
          modal.classList.remove('visible');
          resolve(selectedId);
        } else {
          alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†á„ÄÇ');
        }
      };

      modal.classList.add('visible');
    });
  }


  function handleUserWerewolfSpeech() {
    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');

    if (!myPlayer || !myPlayer.isAlive) return;

    const userInput = document.getElementById('werewolf-user-input');
    const speech = userInput.value.trim();

    if (speech) {
      addDialogueLog(myPlayer.name, speech);
      renderWerewolfScreen();
    }


    document.getElementById('werewolf-action-bar').style.display = 'none';
    userInput.value = '';

    startVotingPhase();
  }

  async function handleAiContinueDiscussion() {
    addGameLog('‰Ω†ËÆ©Â§ßÂÆ∂ÁªßÁª≠ËÆ®ËÆ∫...');
    renderWerewolfScreen();


    const continueBtn = document.getElementById('werewolf-wait-reply-btn');
    if (continueBtn) continueBtn.disabled = true;



    await showCustomAlert("ËØ∑Á®çÂÄô", "Ê≠£Âú®Á≠âÂæÖAIËßíËâ≤‰ª¨ÁªßÁª≠ËÆ®ËÆ∫...");

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      return;
    }

    const systemPrompt = buildWerewolfPrompt();

    try {
      let isGemini = proxyUrl.includes('generativelanguage');

      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑AIËßíËâ≤‰ª¨ÁªßÁª≠ËøõË°åËÆ®ËÆ∫„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const jsonMatch = aiResponseContent.match(/(\[[\s\S]*\])/);
      if (!jsonMatch) {
        throw new Error(`AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑ„ÄÇÂéüÂßãËøîÂõû: ${aiResponseContent}`);
      }
      const dialogues = JSON.parse(jsonMatch[0]);

      for (const dialogue of dialogues) {
        if (dialogue.speaker_name && dialogue.dialogue) {
          addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
          renderWerewolfScreen();
          await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
        }
      }
    } catch (error) {
      console.error("Áãº‰∫∫ÊùÄAIÂõûÂ∫îÁîüÊàêÂ§±Ë¥•:", error);
      await showCustomAlert("AI ÂèëË®ÄÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    } finally {

      if (continueBtn) continueBtn.disabled = false;
    }
  }

  async function handleWerewolfWaitReply() {
    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');

    if (!myPlayer || !myPlayer.isAlive) {
      console.warn("handleWerewolfWaitReply Ë¢´Ë∞ÉÁî®Ôºå‰ΩÜÁî®Êà∑Â∑≤Ê≠ª‰∫°„ÄÇÊìç‰ΩúË¢´ÂøΩÁï•„ÄÇ");
      return;
    }


    const userInput = document.getElementById('werewolf-user-input');
    const speech = userInput.value.trim();

    if (!speech) {
      alert("ËØ∑ÂÖàËæìÂÖ•‰Ω†ÁöÑÂèëË®ÄÂÜÖÂÆπ„ÄÇ");
      return;
    }

    addDialogueLog(myPlayer.name, speech);
    renderWerewolfScreen();
    userInput.value = '';

    await showCustomAlert("ËØ∑Á®çÂÄô", "Ê≠£Âú®Á≠âÂæÖAIËßíËâ≤‰ª¨ÂØπ‰Ω†ÁöÑÂèëË®ÄÂÅöÂá∫ÂõûÂ∫î...");

    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
      alert('APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÁîüÊàêÂØπËØù„ÄÇ');
      return;
    }

    const systemPrompt = buildWerewolfPrompt();

    try {
      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: `Áé∞Âú®ÔºåËØ∑ÊâÄÊúâAIËßíËâ≤ÈíàÂØπÂàöÂàöÁöÑÂèëË®ÄÔºàÁâπÂà´ÊòØ'${myPlayer.name}'ÁöÑÂèëË®ÄÔºâÁªßÁª≠ËøõË°åËÆ®ËÆ∫„ÄÇ`
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.9,
          })
        });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API ÈîôËØØ: ${errorData.error.message}`);
      }

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

   

      let dialogues;
      try {
      
        let cleanedJsonString = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();
        const startIndex = cleanedJsonString.indexOf('[');
        const endIndex = cleanedJsonString.lastIndexOf(']');

        if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
          throw new Error("AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑÁªìÊûÑ (`[...]`)„ÄÇ");
        }

        const jsonArrayString = cleanedJsonString.substring(startIndex, endIndex + 1);

     
        dialogues = JSON.parse(jsonArrayString);

      } catch (e) {
    
        if (e.message.includes("Bad control character")) {
          console.warn("Ê£ÄÊµãÂà∞JSON‰∏≠ÁöÑÈùûÊ≥ïÊéßÂà∂Â≠óÁ¨¶ÔºåÂ∞ùËØïÊ∏ÖÁêÜÂπ∂ÈáçËØï...");

      
          const sanitizeJsonString = (str) => {
            let inString = false;
            let escaped = false;
            let result = '';
            for (let i = 0; i < str.length; i++) {
              const char = str[i];

              if (escaped) {
                result += char;
                escaped = false;
                continue;
              }
              if (char === '\\') {
                result += char;
                escaped = true;
                continue;
              }
              if (char === '"') {
                result += char;
                inString = !inString;
                continue;
              }

              if (inString) {
              
                if (char === '\n') result += '\\n';
                else if (char === '\r') result += '\\r';
                else if (char === '\t') result += '\\t';
              
                else if (char.charCodeAt(0) < 32) continue;
                else result += char;
              } else {
            
                result += char;
              }
            }
            return result;
          };

        
          let cleanedJsonString = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();

        
          const sanitizedString = sanitizeJsonString(cleanedJsonString);

          const jsonMatch = sanitizedString.match(/(\[[\s\S]*\])/);
          if (!jsonMatch) throw new Error("Ê∏ÖÁêÜÂêé‰ªçÊú™ÊâæÂà∞JSONÊï∞ÁªÑ„ÄÇ");

          dialogues = JSON.parse(jsonMatch[0]);

        } else {
       
          throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑJSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
        }
      }
      

      for (const dialogue of dialogues) {
        if (dialogue.speaker_name && dialogue.dialogue) {
          addDialogueLog(dialogue.speaker_name, dialogue.dialogue);
          renderWerewolfScreen();
          await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 2000));
        }
      }
    } catch (error) {
      console.error("Áãº‰∫∫ÊùÄAIÂõûÂ∫îÁîüÊàêÂ§±Ë¥•:", error);
      await showCustomAlert("AI ÂèëË®ÄÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    }
  }

 
  async function startVotingPhase() {
    addGameLog('ÂèëË®ÄÁªìÊùüÔºåÁé∞Âú®ÂºÄÂßãÊäïÁ•®„ÄÇ');
    renderWerewolfScreen();


    werewolfGameState.votes = {};

    let aiVotes = null;
    werewolfGameState.lastFailedAction = 'getVotes';
    try {

      aiVotes = await getAiVotes();
      if (aiVotes) {
        aiVotes.forEach(vote => {
          const voter = werewolfGameState.players.find(p => p.name === vote.voter_name);
          const target = werewolfGameState.players.find(p => p.name === vote.vote_for_name);
          if (voter && voter.isAlive && target) {
            werewolfGameState.votes[voter.name] = target.name;
          }
        });
      }
      werewolfGameState.lastFailedAction = null;
    } catch (error) {
      console.error("AIÊäïÁ•®ÂÜ≥Á≠ñAPIÂ§±Ë¥•:", error);

      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `AIËßíËâ≤Êó†Ê≥ïÂÆåÊàêÊäïÁ•®ÔºåÊ∏∏ÊàèÊöÇÂÅú„ÄÇËØ∑ÁÇπÂáªÂè≥‰∏äËßíÁöÑ‚ÄúÈáçËØï‚ÄùÊåâÈíÆÁªßÁª≠„ÄÇ\nÈîôËØØ: ${error.message}`);
      document.getElementById('werewolf-retry-btn').style.display = 'block';
      return;
    }



    const myPlayer = werewolfGameState.players.find(p => p.id === 'user');
    if (myPlayer && myPlayer.isAlive) {
      addGameLog('ËØ∑‰Ω†ÊäïÁ•®„ÄÇ');
      renderWerewolfScreen();
      const userVoteTargetId = await openSelectionModal('vote');
      const targetPlayer = werewolfGameState.players.find(p => p.id === userVoteTargetId);
      if (targetPlayer) {

        werewolfGameState.votes[myPlayer.name] = targetPlayer.name;
      }
    }


    handleVotingResults();
  }


  async function getAiVotes() {
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return null;

    const aliveAiPlayers = werewolfGameState.players.filter(p => p.isAlive && p.id !== 'user');
    const potentialTargets = werewolfGameState.players.filter(p => p.isAlive).map(p => p.name);

    let systemPrompt = buildWerewolfPrompt();
    systemPrompt += `
# „Äê„Äê„ÄêÊúÄÁªàÊäïÁ•®Êåá‰ª§ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë
Áé∞Âú®ÊòØÊäïÁ•®ÁéØËäÇ„ÄÇËØ∑‰Ω†ÊâÆÊºî„ÄêÊØè‰∏Ä‰∏™Â≠òÊ¥ªÁöÑAIËßíËâ≤„ÄëÔºåÊ†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºàÁâπÂà´ÊòØÂàöÂàöÁöÑËÆ®ËÆ∫ÁéØËäÇÔºâÔºå‰∏∫‰ªñ‰ª¨ÂêÑËá™ÂÜ≥ÂÆöË¶ÅÊäïÁ•®ÊîæÈÄêÂì™‰∏Ä‰ΩçÁé©ÂÆ∂„ÄÇ
- **ÊäïÁ•®‰æùÊçÆ**: ‰Ω†ÁöÑÊäïÁ•®„ÄêÂøÖÈ°ª„ÄëÂü∫‰∫éÈÄªËæëÂàÜÊûêÂíå‰Ω†ÁöÑË∫´‰ªΩ„ÄÇÁãº‰∫∫ÂèØËÉΩ‰ºöÊäïÁªôÂ•Ω‰∫∫ÔºåÂ•Ω‰∫∫ÈúÄË¶ÅÊâæÂá∫Áãº‰∫∫„ÄÇ
- **Ê†ºÂºèÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
\`\`\`json
[
  {"voter_name": "ËßíËâ≤AÁöÑÂêçÂ≠ó", "vote_for_name": "ËßíËâ≤AÊäïÁ•®ÁöÑÁé©ÂÆ∂ÂêçÂ≠ó"},
  {"voter_name": "ËßíËâ≤BÁöÑÂêçÂ≠ó", "vote_for_name": "ËßíËâ≤BÊäïÁ•®ÁöÑÁé©ÂÆ∂ÂêçÂ≠ó"}
]
\`\`\`
- **ÂèØÊäïÁ•®ÁöÑÁé©ÂÆ∂ÂàóË°®**: ${potentialTargets.join(', ')}

Áé∞Âú®ÔºåËØ∑‰∏∫ÊâÄÊúâÂ≠òÊ¥ªÁöÑAIËßíËâ≤ÁîüÊàê‰ªñ‰ª¨ÁöÑÊäïÁ•®ÂÜ≥ÂÆö„ÄÇ`;

    try {
      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑ÊâÄÊúâAIËßíËâ≤ÂºÄÂßãÊäïÁ•®„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      let cleanedJsonString = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '').trim();


      const startIndex = cleanedJsonString.indexOf('[');
      const endIndex = cleanedJsonString.lastIndexOf(']');


      if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) {
        throw new Error("AIËøîÂõûÁöÑÊäïÁ•®ÁªìÊûú‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÊï∞ÁªÑÁªìÊûÑ (`[...]`)„ÄÇ");
      }



      const jsonArrayString = cleanedJsonString.substring(startIndex, endIndex + 1);


      try {

        const matches = jsonArrayString.match(/(\[[\s\S]*?\])/g);
        if (matches && matches.length > 0) {
          return JSON.parse(matches[matches.length - 1]);
        }
        return JSON.parse(jsonArrayString);
      } catch (e) {

        throw new Error(`Ëß£ÊûêAIËøîÂõûÁöÑÊäïÁ•®JSONÊó∂Âá∫Èîô: ${e.message}\n\nAIÂéüÂßãËøîÂõûÂÜÖÂÆπ:\n${aiResponseContent}`);
      }


    } catch (error) {
      console.error("Ëé∑ÂèñAIÊäïÁ•®Â§±Ë¥•:", error);
      throw new Error(`Ëé∑ÂèñAIÊäïÁ•®ÂÜ≥Á≠ñÂ§±Ë¥•: ${error.message}`);
    }
  }


  function handleVotingResults() {
    const voteCounts = {};
    const voteDetails = {};


    for (const voterName in werewolfGameState.votes) {
      const targetName = werewolfGameState.votes[voterName];

      voteCounts[targetName] = (voteCounts[targetName] || 0) + 1;

      if (!voteDetails[targetName]) {
        voteDetails[targetName] = [];
      }
      voteDetails[targetName].push(voterName);
    }

    let maxVotes = 0;
    let mostVotedPlayers = [];


    for (const playerName in voteCounts) {
      const count = voteCounts[playerName];
      if (count > maxVotes) {
        maxVotes = count;
        mostVotedPlayers = [playerName];
      } else if (count === maxVotes) {
        mostVotedPlayers.push(playerName);
      }
    }


    addGameLog('ÊäïÁ•®ÁªìÊûúÔºö');
    for (const playerName in voteDetails) {
      addGameLog(`${playerName} (${voteDetails[playerName].length}Á•®): ${voteDetails[playerName].join('„ÄÅ ')}`);
    }


    if (mostVotedPlayers.length === 1 && maxVotes > 0) {
      const playerToEliminate = werewolfGameState.players.find(p => p.name === mostVotedPlayers[0]);
      if (playerToEliminate) {
        playerToEliminate.isAlive = false;
        addGameLog(`${playerToEliminate.name} Ë¢´ÊäïÁ•®ÊîæÈÄê„ÄÇ`);


        if (playerToEliminate.role === 'Áåé‰∫∫') {

        }
      }
    } else {
      addGameLog('Âπ≥Á•®ÊàñÊó†‰∫∫ÊäïÁ•®ÔºåÊ≠§ËΩÆÊó†‰∫∫Âá∫Â±Ä„ÄÇ');
    }

    renderWerewolfScreen();

    if (checkGameOver()) return;


    werewolfGameState.currentDay++;
    executeNightPhase();
  }

 
  async function getAiWolfKillTarget() {
    const {
      proxyUrl,
      apiKey,
      model
    } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return null;

    const wolves = werewolfGameState.players.filter(p => p.role === 'Áãº‰∫∫' && p.isAlive);
    const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.role !== 'Áãº‰∫∫');

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®ÊòØÁãº‰∫∫Âõ¢ÈòüÁöÑÊåáÊå•ÂÆò„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÂàÜÊûêÂΩìÂâçÂ±ÄÂäøÔºåÂπ∂‰∏∫Áãº‰∫∫Âõ¢ÈòüÈÄâÊã©‰∏Ä‰∏™ÊúÄ‰Ω≥ÁöÑÂàÄ‰∫∫ÁõÆÊ†á„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **ÁõÆÊ†á**: ‰ºòÂÖàÂàÄÊéâÈ¢ÑË®ÄÂÆ∂„ÄÅÂ•≥Â∑´Á≠âÁ•ûËÅå‰∫∫Âëò„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÊòéÁ°ÆÁöÑÁ•ûËÅå‰ø°ÊÅØÔºåÂèØ‰ª•Ê†πÊçÆÂèëË®ÄÊù•Âà§Êñ≠Ë∞ÅÁöÑÈÄªËæëÊ∏ÖÊô∞„ÄÅÂ®ÅËÉÅÊúÄÂ§ß„ÄÇ
2.  **Ê†ºÂºèÈìÅÂæã**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ã:
    \`{"target_name": "‰Ω†ÂÜ≥ÂÆöË¶ÅÂàÄÁöÑÁé©ÂÆ∂ÂêçÂ≠ó"}\`

# Ê∏∏ÊàèÁä∂ÊÄÅ
- **‰Ω†ÁöÑÁãºÈòüÂèãÊòØ**: ${wolves.map(w=>w.name).join('„ÄÅ ')}
- **ÂèØ‰ª•ÂàÄÁöÑÁé©ÂÆ∂ÂàóË°®**: ${potentialTargets.map(p=>p.name).join('„ÄÅ ')}
- **ËÆ®ËÆ∫ÊëòË¶Å**: 
${werewolfGameState.discussionLog.map(d => `${d.speaker}: ${d.content}`).join('\n')}

Áé∞Âú®ÔºåËØ∑ÂÅöÂá∫‰Ω†ÁöÑÂÜ≥ÂÆö„ÄÇ`;

    try {
      let isGemini = proxyUrl.includes('generativelanguage');
      let messagesForApi = [{
        role: 'user',
        content: 'ËØ∑ÈÄâÊã©‰ªäÊôöÁöÑÁõÆÊ†á„ÄÇ'
      }];
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
            temperature: state.globalSettings.apiTemperature || 0.8,
          })
        });

      if (!response.ok) throw new Error((await response.json()).error.message);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);
      const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑÂàÄ‰∫∫ÁõÆÊ†áÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ");
      const decision = JSON.parse(jsonMatch[0]);

      const targetPlayer = werewolfGameState.players.find(p => p.name === decision.target_name);
      return targetPlayer ? targetPlayer.id : null;

    } catch (error) {
      console.error("Ëé∑ÂèñAIÁãº‰∫∫ÁõÆÊ†áÂ§±Ë¥•:", error);

      return potentialTargets[Math.floor(Math.random() * potentialTargets.length)].id;
    }
  }

 
  function openWitchActionModal(killedPlayer, witchPlayer) {
    return new Promise(resolve => {
      const modal = document.getElementById('werewolf-witch-modal');
      const listEl = document.getElementById('werewolf-witch-selection-list');
      const titleEl = document.getElementById('witch-modal-title');


      const poisonBtn = document.getElementById('confirm-witch-poison-btn');
      const doNothingBtn = document.getElementById('witch-do-nothing-btn');
      listEl.innerHTML = '';


      const newPoisonBtn = poisonBtn.cloneNode(true);
      poisonBtn.parentNode.replaceChild(newPoisonBtn, poisonBtn);
      const newDoNothingBtn = doNothingBtn.cloneNode(true);
      doNothingBtn.parentNode.replaceChild(newDoNothingBtn, doNothingBtn);


      newPoisonBtn.style.display = 'block';
      newPoisonBtn.disabled = true;

      let action = {
        save: false,
        poison: null
      };
      let selectedPoisonTarget = null;


      if (killedPlayer && !witchPlayer.antidoteUsed) {
        titleEl.textContent = `Êò®Êôö ${killedPlayer.name} Ë¢´ÂàÄ‰∫Ü`;
        const saveBtn = document.createElement('button');
        saveBtn.className = 'form-button';
        saveBtn.textContent = '‰ΩøÁî®Ëß£ËçØÊïëTA';
        saveBtn.style.margin = '20px';
        saveBtn.onclick = () => {
          action.save = true;
          modal.classList.remove('visible');
          resolve(action);
        };
        listEl.appendChild(saveBtn);
      } else if (killedPlayer) {
        titleEl.textContent = `Êò®Êôö ${killedPlayer.name} Ë¢´ÂàÄ‰∫Ü (‰Ω†Ê≤°ÊúâËß£ËçØ‰∫Ü)`;
      } else {
        titleEl.textContent = 'Êò®ÊôöÊòØÂπ≥ÂÆâÂ§ú';
      }


      if (!witchPlayer.poisonUsed) {
        const poisonTitle = document.createElement('p');
        poisonTitle.textContent = 'ÊòØÂê¶Ë¶Å‰ΩøÁî®ÊØíËçØÔºü';
        poisonTitle.style.textAlign = 'center';
        poisonTitle.style.marginTop = '20px';
        listEl.appendChild(poisonTitle);

        const potentialTargets = werewolfGameState.players.filter(p => p.isAlive && p.id !== killedPlayer?.id);
        potentialTargets.forEach(p => {
          const item = document.createElement('div');
          item.className = 'werewolf-selection-item';
          item.dataset.id = p.id;
          item.innerHTML = `<img src="${p.avatar}" class="avatar"><span class="name">${p.name}</span>`;
          item.onclick = () => {
            listEl.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            selectedPoisonTarget = p.id;


            newPoisonBtn.disabled = false;
          };
          listEl.appendChild(item);
        });
      }


      newPoisonBtn.onclick = () => {
        if (selectedPoisonTarget) {
          action.poison = selectedPoisonTarget;
          modal.classList.remove('visible');
          resolve(action);
        }
      };

      newDoNothingBtn.onclick = () => {
        modal.classList.remove('visible');
        resolve(action);
      };

      modal.classList.add('visible');
    });
  }




  async function handleWerewolfRetry() {
    const actionToRetry = werewolfGameState.lastFailedAction;
    if (!actionToRetry) return;

    document.getElementById('werewolf-retry-btn').style.display = 'none';
    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÈáçËØï"${actionToRetry}"Êìç‰Ωú...`);

    switch (actionToRetry) {
      case 'wolfKill':

        await executeNightPhase();
        break;
      case 'startDiscussion':

        await startDiscussionPhase();
        break;
      case 'getVotes':

        await startVotingPhase();
        break;

    }
  }




 
  function checkGameOver() {
    const alivePlayers = werewolfGameState.players.filter(p => p.isAlive);
    const aliveWolves = alivePlayers.filter(p => p.role === 'Áãº‰∫∫');
    const aliveGods = alivePlayers.filter(p => ['È¢ÑË®ÄÂÆ∂', 'Â•≥Â∑´', 'Áåé‰∫∫', 'ÂÆàÂç´'].includes(p.role));
    const aliveVillagers = alivePlayers.filter(p => p.role === 'Âπ≥Ê∞ë');

    let winner = null;


    if (aliveWolves.length === 0) {
      winner = 'Â•Ω‰∫∫';
    } else if (aliveWolves.length >= (aliveGods.length + aliveVillagers.length)) {
      winner = 'Áãº‰∫∫';
    } else if (werewolfGameState.gameMode === '12p') {

      if (aliveGods.length === 0 || aliveVillagers.length === 0) {
        winner = 'Áãº‰∫∫';
      }
    } else {

      if (aliveGods.length === 0 && aliveVillagers.length === 0) {
        winner = 'Áãº‰∫∫';
      }
    }


    if (winner) {

      endGame(winner);
      return true;
    }


    return false;
  }



  async function checkAndFixData() {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Êìç‰Ωú',
      'Ê≠§ÂäüËÉΩÂ∞ÜÊâ´ÊèèÊï∞ÊçÆÂ∫ìÔºåÂ∞ùËØïÊâæÂá∫Âπ∂‰øÆÂ§ç‚ÄúËßíËâ≤Âú®Êï∞ÊçÆÂ∫ì‰∏≠Â≠òÂú®Ôºå‰ΩÜÊú™Âú®ËÅäÂ§©ÂàóË°®ÊòæÁ§∫‚ÄùÁöÑÈóÆÈ¢ò„ÄÇ<br><br><strong>Êìç‰ΩúÈÄöÂ∏∏ÊòØÂÆâÂÖ®ÁöÑÔºå‰ΩÜ‰ªçÂª∫ËÆÆÂú®Êìç‰ΩúÂâçÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ</strong>', {
        confirmText: 'ÂºÄÂßãÊ£ÄÊü•'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®Êâ´ÊèèÂíå‰øÆÂ§çÊï∞ÊçÆ...");

    try {
      const chatsFromDB = await db.chats.toArray();
      let fixedCount = 0;

      for (const chat of chatsFromDB) {
        let isModified = false;


        if (!Array.isArray(chat.history)) {
          chat.history = [];
          isModified = true;
        }

        if (typeof chat.settings !== 'object' || chat.settings === null) {
          chat.settings = {};
          isModified = true;
        }

        if (!chat.isGroup && !chat.originalName) {
          chat.originalName = chat.name;
          isModified = true;
        }

        if (typeof chat.unreadCount === 'undefined') {
          chat.unreadCount = 0;
          isModified = true;
        }

        if (!Array.isArray(chat.longTermMemory)) {
          chat.longTermMemory = [];
          isModified = true;
        }



        if (isModified) {
          fixedCount++;
          console.log(`‰øÆÂ§ç‰∫ÜËßíËâ≤ "${chat.name}" (ID: ${chat.id}) ÁöÑÊÆãÁº∫Êï∞ÊçÆ„ÄÇ`);
          await db.chats.put(chat);
        }


        state.chats[chat.id] = chat;
      }

      if (fixedCount > 0) {
        await showCustomAlert(
          '‰øÆÂ§çÂÆåÊàêÔºÅ',
          `ÊàêÂäüÊ£ÄÊü•Âπ∂‰øÆÂ§ç‰∫Ü ${fixedCount} ‰∏™ËßíËâ≤ÁöÑÊï∞ÊçÆÈóÆÈ¢òÔºÅ\n\nËÅäÂ§©ÂàóË°®Â∑≤‰∏∫ÊÇ®Âà∑Êñ∞„ÄÇ`
        );

        await renderChatList();
      } else {
        await showCustomAlert('Ê£ÄÊü•ÂÆåÊàê', 'Êú™ÂèëÁé∞‰ªª‰ΩïÈúÄË¶Å‰øÆÂ§çÁöÑÊï∞ÊçÆÈóÆÈ¢ò„ÄÇ');
      }

    } catch (error) {
      console.error("Êï∞ÊçÆÊ£ÄÊü•‰∏é‰øÆÂ§çÂ§±Ë¥•:", error);
      await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', `ÊâßË°åÊ£ÄÊü•Êó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
    }
  }


  function showLoader(container, position = 'top') {

    if (container.querySelector('.loader-container')) return;
    const loader = document.createElement('div');
    loader.className = 'loader-container';
    loader.innerHTML = '<div class="spinner"></div>';

    if (position === 'bottom') {
      container.appendChild(loader);
    } else {
      container.prepend(loader);
    }
  }

 
  function hideLoader(container) {
    const loader = container.querySelector('.loader-container');
    if (loader) {
      loader.remove();
    }
  }



  async function openWorldBookDeletionModal() {
    const modal = document.getElementById('delete-world-books-modal');
    const listEl = document.getElementById('delete-world-books-list');
    const selectAllCheckbox = document.getElementById('select-all-world-books-for-clear');
    listEl.innerHTML = '';
    selectAllCheckbox.checked = false;

    const books = await db.worldBooks.toArray();

    if (books.length === 0) {
      listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">Ê≤°ÊúâÂèØ‰ª•Âà†Èô§ÁöÑ‰∏ñÁïå‰π¶„ÄÇ</p>';
    } else {
      books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'clear-posts-item';
        item.dataset.bookId = book.id;
        item.innerHTML = `
                <div class="checkbox"></div>
                <span class="name">${book.name}</span>
            `;
        listEl.appendChild(item);
      });
    }

    modal.classList.add('visible');
  }


  async function handleConfirmWorldBookDeletion() {
    const selectedItems = document.querySelectorAll('#delete-world-books-list .clear-posts-item.selected');
    if (selectedItems.length === 0) {
      alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂà†Èô§ÁöÑ‰∏ñÁïå‰π¶„ÄÇ");
      return;
    }

    const idsToDelete = Array.from(selectedItems).map(item => item.dataset.bookId);

    const confirmed = await showCustomConfirm(
      'ÊúÄÂêéÁ°ÆËÆ§ÔºÅ',
      `Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊÇ®ÈÄâÊã©ÁöÑ ${selectedItems.length} Êú¨‰∏ñÁïå‰π¶ÔºåÂπ∂Ëß£Èô§ÂÆÉ‰ª¨‰∏éÊâÄÊúâËßíËâ≤ÁöÑÂÖ≥ËÅî„ÄÇÊ≠§Êìç‰Ωú„Äê‰∏çÂèØÊÅ¢Â§ç„ÄëÔºÅ`, {
        confirmButtonClass: 'btn-danger',
        confirmText: 'Á°ÆËÆ§Âà†Èô§'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÂà†Èô§Êìç‰Ωú...");

    try {
      await db.transaction('rw', db.worldBooks, db.chats, async () => {

        await db.worldBooks.bulkDelete(idsToDelete);


        const allChats = await db.chats.toArray();
        for (const chat of allChats) {
          if (chat.settings && Array.isArray(chat.settings.linkedWorldBookIds)) {
            const originalCount = chat.settings.linkedWorldBookIds.length;

            chat.settings.linkedWorldBookIds = chat.settings.linkedWorldBookIds.filter(id => !idsToDelete.includes(id));


            if (chat.settings.linkedWorldBookIds.length < originalCount) {
              await db.chats.put(chat);
            }
          }
        }
      });


      state.worldBooks = state.worldBooks.filter(book => !idsToDelete.includes(book.id));

      document.getElementById('delete-world-books-modal').classList.remove('visible');
      await showCustomAlert("Âà†Èô§ÊàêÂäü", `${selectedItems.length} Êú¨‰∏ñÁïå‰π¶Â∑≤ÊàêÂäüÂà†Èô§„ÄÇ`);

    } catch (error) {
      console.error("Âà†Èô§‰∏ñÁïå‰π¶Â§±Ë¥•:", error);
      await showCustomAlert("Âà†Èô§Â§±Ë¥•", `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }




  function openReadingRoom() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const overlay = document.getElementById('reading-overlay');
    const windowEl = document.getElementById('reading-window');
    const restoreBtn = document.getElementById('reading-restore-btn');

    let session = readingState[chatId];


    if (session && session.isActive) {
      if (session.isMinimized) {
        restoreReadingRoom();
      }

      overlay.style.display = 'flex';
      return;
    }


    initReadingSession(chatId);
    renderReadingRoom(chatId);


    overlay.style.display = 'flex';
    windowEl.classList.remove('minimized');
    restoreBtn.style.display = 'none';




    const phoneScreen = document.getElementById('phone-screen');
    const windowRect = windowEl.getBoundingClientRect();


    const top = (phoneScreen.clientHeight - windowRect.height) / 2;
    const left = (phoneScreen.clientWidth - windowRect.width) / 2;


    windowEl.style.top = `${top}px`;
    windowEl.style.left = `${left}px`;
    windowEl.style.transform = '';

  }

 
  function initReadingSession(chatId) {
    readingState[chatId] = {
      isActive: true,
      isMinimized: false,
      title: 'Êú™ÈÄâÊã©‰π¶Á±ç',
      contentLines: [],
      currentPage: 0,
      totalPages: 0,
      linesPerPage: 15,
      currentSnippet: ''
    };
  }


  function closeReadingRoom() {
    const chatId = state.activeChatId;
    if (!chatId || !readingState[chatId] || !readingState[chatId].isActive) return;


    document.getElementById('reading-overlay').style.display = 'none';
    document.getElementById('reading-restore-btn').style.display = 'none';
    document.getElementById('reading-window').classList.remove('minimized');


    readingState[chatId].isActive = false;
    console.log("ËØª‰π¶‰ºöËØùÂ∑≤ÂÖ≥Èó≠„ÄÇ");
  }


  


  function renderReadingRoom(chatId) {
    const session = readingState[chatId];
    if (!session) return;
    
    // --- „ÄêÊñ∞Â¢û/‰øÆÊîπÈÉ®ÂàÜÂºÄÂßã„Äë ---
    // 1. Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ÁöÑÂ≠ó‰ΩìËÆæÁΩÆ
    const chat = state.chats[chatId];
    // ÈªòËÆ§ 13pxÔºåÂ¶ÇÊûúÊúâËÆæÁΩÆÂàô‰ΩøÁî®ËÆæÁΩÆÂÄº
    const fontSize = (chat && chat.settings && chat.settings.fontSize) ? chat.settings.fontSize : 13;
    
    const contentEl = document.getElementById('reading-content');
    
    // 2. Â∞ÜÂ≠ó‰ΩìÂ§ßÂ∞èÂ∫îÁî®Âà∞ËØª‰π¶ÂÆπÂô®
    contentEl.style.fontSize = `${fontSize}px`;
    // 3. Âä®ÊÄÅË∞ÉÊï¥Ë°åÈ´ò (Line Height)ÔºåÈò≤Ê≠¢Â≠ó‰ΩìÂèòÂ§ßÂêéÊñáÂ≠óÊå§Âú®‰∏ÄËµ∑
    // 1.6 ÊòØ‰∏Ä‰∏™ÊØîËæÉËàíÈÄÇÁöÑÈòÖËØªÂÄçÁéá
    contentEl.style.lineHeight = '1.6';
    // --- „ÄêÊñ∞Â¢û/‰øÆÊîπÈÉ®ÂàÜÁªìÊùü„Äë ---

    const titleEl = document.getElementById('reading-title');
    // const contentEl = document.getElementById('reading-content'); // ËøôË°å‰∏äÈù¢Â∑≤ÁªèËé∑Âèñ‰∫ÜÔºåÂèØ‰ª•Ê≥®ÈáäÊéâÊàñÂà†Èô§
    const pageIndicator = document.getElementById('page-indicator');
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    titleEl.textContent = session.title;
    
    if (session.contentLines.length === 0) {
      contentEl.innerHTML = '<p style="text-align:center; padding-top:50px; color:#888;">ÁÇπÂáª‚ÄúÂØºÂÖ•‚ÄùÊåâÈíÆÔºå<br>‰ªéÊú¨Âú∞.txtÊñá‰ª∂ÊàñÁΩëÁªúURLÂä†ËΩΩ‰π¶Á±çÂÜÖÂÆπ„ÄÇ</p>';
      session.totalPages = 0;
      session.currentPage = 0;
    } else {
      const startLine = session.currentPage * session.linesPerPage;
      const endLine = startLine + session.linesPerPage;
      contentEl.textContent = session.contentLines.slice(startLine, endLine).join('\n');
    }
    
    pageIndicator.textContent = `${session.currentPage + 1} / ${session.totalPages}`;
    prevBtn.disabled = session.currentPage === 0;
    nextBtn.disabled = session.currentPage >= session.totalPages - 1;
  }

  function showNextPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage < session.totalPages - 1) {
      session.currentPage++;
      renderReadingRoom(state.activeChatId);
      document.getElementById('reading-content').scrollTop = 0;

      saveReadingProgress(session.activeBookId, session.currentPage);
    }
  }


  async function showPrevPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage > 0) {
      session.currentPage--;
      renderReadingRoom(state.activeChatId);
      document.getElementById('reading-content').scrollTop = 0;
      await saveReadingProgress(session.activeBookId, session.currentPage);


      await notifyAiOfPageTurn(state.activeChatId, session);
    }
  }


  function importBook() {

    document.getElementById('book-upload-input').click();
  }

  async function decodeTextFile(arrayBuffer) {
    const uint8array = new Uint8Array(arrayBuffer);


    if (uint8array.length >= 3 && uint8array[0] === 0xEF && uint8array[1] === 0xBB && uint8array[2] === 0xBF) {
      console.log("Ê£ÄÊµãÂà∞ UTF-8 BOMÔºå‰ΩøÁî® UTF-8 Ëß£Á†Å„ÄÇ");
      return new TextDecoder('utf-8').decode(uint8array);
    }
    if (uint8array.length >= 2 && uint8array[0] === 0xFF && uint8array[1] === 0xFE) {
      console.log("Ê£ÄÊµãÂà∞ UTF-16 LE BOMÔºå‰ΩøÁî® UTF-16 LE Ëß£Á†Å„ÄÇ");
      return new TextDecoder('utf-16le').decode(uint8array);
    }
    if (uint8array.length >= 2 && uint8array[0] === 0xFE && uint8array[1] === 0xFF) {
      console.log("Ê£ÄÊµãÂà∞ UTF-16 BE BOMÔºå‰ΩøÁî® UTF-16 BE Ëß£Á†Å„ÄÇ");
      return new TextDecoder('utf-16be').decode(uint8array);
    }


    try {
      console.log("Êú™Ê£ÄÊµãÂà∞BOMÔºåÂ∞ùËØï‰ΩøÁî® UTF-8 Ëß£Á†Å...");

      const decoded = new TextDecoder('utf-8', {
        fatal: true
      }).decode(uint8array);
      console.log("UTF-8 Ëß£Á†ÅÊàêÂäü„ÄÇ");
      return decoded;
    } catch (e) {
      console.log("UTF-8 Ëß£Á†ÅÂ§±Ë¥•ÔºåÂ∞ÜÂ∞ùËØï GBK (ANSI) Ëß£Á†Å...");

      try {
        const decoded = new TextDecoder('gbk').decode(uint8array);
        console.log("GBK Ëß£Á†ÅÊàêÂäü„ÄÇ");
        return decoded;
      } catch (err) {
        console.error("ÊâÄÊúâËß£Á†ÅÂ∞ùËØïÂùáÂ§±Ë¥•:", err);

        throw new Error("Êó†Ê≥ïËØÜÂà´ÁöÑÊñá‰ª∂ÁºñÁ†Å„ÄÇËØ∑Â∞ùËØïÂ∞ÜÊñá‰ª∂ËΩ¨Êç¢‰∏∫ UTF-8 Ê†ºÂºèÂêéÈáçÊñ∞ÂØºÂÖ•„ÄÇ");
      }
    }
  }

  async function handleBookFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {

      const arrayBuffer = await file.arrayBuffer();

      const textContent = await decodeTextFile(arrayBuffer);

      const title = file.name.replace(/\.txt$/i, '');

      const newBookId = await db.readingLibrary.add({
        title: title,
        content: textContent,
        lastOpened: Date.now()
      });

      await loadBookFromLibrary(newBookId);
      if (document.getElementById('reading-library-modal').classList.contains('visible')) {
        renderBookLibrary();
      }
    } catch (error) {

      console.error("ÂØºÂÖ•‰π¶Á±çÂ§±Ë¥•:", error);
      await showCustomAlert("ÂØºÂÖ•Â§±Ë¥•", error.message);
    } finally {
      event.target.value = null;
    }
  }
  async function handlePageJump() {
    const chatId = state.activeChatId;
    if (!chatId) return;
    const session = readingState[chatId];
    if (!session || session.totalPages <= 1) return;

    const targetPageStr = await showCustomPrompt(
      'È°µÈù¢Ë∑≥ËΩ¨',
      `ËØ∑ËæìÂÖ•ÊÉ≥Ë∑≥ËΩ¨ÁöÑÈ°µÁ†Å (1 - ${session.totalPages})`,
      session.currentPage + 1
    );

    if (targetPageStr === null) return;

    const targetPage = parseInt(targetPageStr);

    if (isNaN(targetPage) || targetPage < 1 || targetPage > session.totalPages) {
      alert("ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÈ°µÁ†ÅÔºÅ");
      return;
    }

    session.currentPage = targetPage - 1;
    renderReadingRoom(chatId);

    saveReadingProgress(session.activeBookId, session.currentPage);
  }


  async function saveReadingProgress(bookId, pageNumber) {
    if (!bookId) return;
    try {

      await db.readingLibrary.update(bookId, {
        currentPage: pageNumber
      });
    } catch (error) {
      console.error(`‰øùÂ≠ò‰π¶Á±ç(ID: ${bookId})ÁöÑÈòÖËØªËøõÂ∫¶Â§±Ë¥•:`, error);
    }
  }

  async function showNextPage() {
    const session = readingState[state.activeChatId];
    if (session && session.currentPage < session.totalPages - 1) {
      session.currentPage++;
      renderReadingRoom(state.activeChatId);
      document.getElementById('reading-content').scrollTop = 0;
      await saveReadingProgress(session.activeBookId, session.currentPage);


      await notifyAiOfPageTurn(state.activeChatId, session);
    }
  }

  



  async function openBookLibrary() {

    document.getElementById('reading-library-search-input').value = '';

    await renderBookLibrary();
    document.getElementById('reading-library-modal').classList.add('visible');
  }

  
  async function renderBookLibrary(searchTerm = '') {
    const listEl = document.getElementById('reading-library-list');
    let books = await db.readingLibrary.orderBy('lastOpened').reverse().toArray();
    listEl.innerHTML = '';


    if (searchTerm) {
      books = books.filter(book =>
        book.title.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }


    if (books.length === 0) {
      const message = searchTerm ?
        'Êâæ‰∏çÂà∞ÂåπÈÖçÁöÑ‰π¶Á±ç' :
        '‰π¶Â∫ìÊòØÁ©∫ÁöÑÔºåÁÇπÂáª‚ÄúÂØºÂÖ•Êñ∞‰π¶‚ÄùÊ∑ªÂä†Á¨¨‰∏ÄÊú¨ÂêßÔºÅ';
      listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
      return;
    }

    books.forEach(book => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
            <span class="group-name" style="cursor:pointer;" data-book-id="${book.id}">${book.title}</span>
            <button class="delete-group-btn" data-book-id="${book.id}" title="Âà†Èô§‰π¶Á±ç">√ó</button>
        `;
      listEl.appendChild(item);
    });
  }


  // ÊâæÂà∞ loadBookFromLibrary ÂáΩÊï∞ÔºåÊõøÊç¢Êï¥‰∏™ÂáΩÊï∞
async function loadBookFromLibrary(bookId) {
    const chatId = state.activeChatId;
    if (!chatId) return;

    let book = await db.readingLibrary.get(bookId);
    if (!book) {
      alert('Êâæ‰∏çÂà∞ËøôÊú¨‰π¶ÔºÅ');
      return;
    }

    // --- „ÄêÊ†∏ÂøÉÊñ∞Â¢ûÈÄªËæëÔºöÂêåÊ≠•ÁªøÊ±üÂÜÖÂÆπ„Äë ---
    if (book.linkedStoryId) {
        try {
            const grStory = await db.grStories.get(book.linkedStoryId);
            if (grStory) {
                console.log(`[ÂêåÊ≠•] Ê≠£Âú®‰ªéÁªøÊ±üÂêåÊ≠•„Ää${grStory.title}„ÄãÁöÑÊúÄÊñ∞Á´†ËäÇ...`);
                
                // ÊãºÊé•ÊâÄÊúâÁ´†ËäÇÂÜÖÂÆπ
                // Ê†ºÂºèÔºö
                // Á¨¨1Á´† Ê†áÈ¢ò
                // Ê≠£Êñá...
                let fullContent = "";
                grStory.chapters.forEach((ch, idx) => {
                    const title = ch.title || `Á¨¨ ${idx + 1} Á´†`;
                    fullContent += `\n\n========== ${title} ==========\n\n`;
                    fullContent += ch.content;
                });

                // Êõ¥Êñ∞ÂÜÖÂ≠òÈáåÁöÑ‰∏¥Êó∂ÂØπË±°
                book.title = grStory.title; // ÂêåÊ≠•Ê†áÈ¢ò
                book.content = fullContent; // ÂêåÊ≠•ÂÜÖÂÆπ

                // ÂêåÊó∂Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÔºå‰øùÊåÅÁºìÂ≠òÊúÄÊñ∞
                await db.readingLibrary.update(bookId, {
                    title: grStory.title,
                    content: fullContent,
                    lastOpened: Date.now()
                });
            } else {
                console.warn("ÂÖ≥ËÅîÁöÑÁªøÊ±ü‰ΩúÂìÅÂ∑≤Ë¢´Âà†Èô§Ôºå‰øùÁïôÊúÄÂêé‰∏ÄÊ¨°ÁºìÂ≠òÁöÑÂÜÖÂÆπ„ÄÇ");
            }
        } catch (e) {
            console.error("ÂêåÊ≠•ÁªøÊ±üÂÜÖÂÆπÂ§±Ë¥•:", e);
        }
    } else {
        // ÊôÆÈÄö‰π¶Á±çÂè™Êõ¥Êñ∞Êó∂Èó¥
        await db.readingLibrary.update(bookId, {
          lastOpened: Date.now()
        });
    }
    // -------------------------------------

    const session = readingState[chatId];
    session.activeBookId = bookId;
    session.title = book.title;
    // Â§ÑÁêÜÂÜÖÂÆπÊç¢Ë°å
    session.contentLines = (book.content || "").split(/\r\n?|\n/).map(line => line.replace(/ +/g, ' '));
    session.totalPages = Math.ceil(session.contentLines.length / session.linesPerPage);
    
    // Â¶ÇÊûúÊÄªÈ°µÊï∞‰∏∫0ÔºåËá≥Â∞ëËÆæ‰∏∫1
    if(session.totalPages === 0) session.totalPages = 1;

    session.currentPage = book.currentPage || 0;

    // Èò≤Ê≠¢È°µÁ†ÅË∂äÁïåÔºàÊØîÂ¶ÇÂêåÊ≠•ÂêéÂÜÖÂÆπÂèòÁü≠‰∫ÜÔºåËôΩÁÑ∂‰∏ÄËà¨ÊòØÂèòÈïøÔºâ
    if (session.currentPage >= session.totalPages) {
        session.currentPage = session.totalPages - 1;
    }
    if (session.currentPage < 0) session.currentPage = 0;

    renderReadingRoom(chatId);

    document.getElementById('reading-content').scrollTop = 0;
    document.getElementById('reading-library-modal').classList.remove('visible');
}

async function addGreenRiverToShelf(storyId, btnElement) {
    try {
        const story = await db.grStories.get(storyId);
        if (!story) return;

        // Èò≤Ê≠¢ÈáçÂ§çÊ∑ªÂä†
        const existing = await db.readingLibrary.where('linkedStoryId').equals(storyId).first();
        if (existing) {
            alert("ËØ•‰π¶Á±çÂ∑≤Âú®‰π¶Êû∂‰∏≠„ÄÇ");
            return;
        }

        let fullContent = "";
        story.chapters.forEach((ch, idx) => {
            const title = ch.title || `Á¨¨ ${idx + 1} Á´†`;
            fullContent += `\n\n========== ${title} ==========\n\n`;
            fullContent += ch.content;
        });
        
        if (!fullContent) fullContent = "(ÊöÇÊó†ÂÜÖÂÆπÔºåËØ∑‰ΩúËÄÖËµ∂Âø´Êõ¥Êñ∞...)";

        await db.readingLibrary.add({
            title: story.title,
            content: fullContent,
            lastOpened: Date.now(),
            currentPage: 0,
            linkedStoryId: story.id
        });

        // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊõ¥Êñ∞ÊåâÈíÆUI‰∏∫‚ÄúÂ∑≤Ê∑ªÂä†‚ÄùÁä∂ÊÄÅÔºåÂπ∂ÁªëÂÆöÁßªÈô§‰∫ã‰ª∂
        if (btnElement) {
            btnElement.textContent = "‚úì Â∑≤Âú®‰π¶Êû∂";
            btnElement.classList.add('added');
            // ÈáçÊñ∞ÁªëÂÆö onclick ‰∏∫ÁßªÈô§ÂáΩÊï∞
            btnElement.onclick = (e) => {
                e.stopPropagation();
                removeGreenRiverFromShelf(storyId, btnElement);
            };
        }

        await showCustomAlert("Êî∂ËóèÊàêÂäü", `„Ää${story.title}„ÄãÂ∑≤Âä†ÂÖ•‰π¶Êû∂ÔºåÂπ∂ÂºÄÂêØÂêåÊ≠•Êõ¥Êñ∞„ÄÇ`);

    } catch (e) {
        console.error("Âä†ÂÖ•‰π¶Êû∂Â§±Ë¥•:", e);
        alert("Âä†ÂÖ•Â§±Ë¥•: " + e.message);
    }
}

// ËÆ∞ÂæóÊääËøô‰∏™ÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºåÂê¶Âàô HTML onclick Êâæ‰∏çÂà∞
window.addGreenRiverToShelf = addGreenRiverToShelf;
// „ÄêÊñ∞Â¢û„Äë‰ªé‚Äú‰∏ÄËµ∑ËØª‚Äù‰π¶Êû∂‰∏≠ÁßªÈô§ÁªøÊ±ü‰ΩúÂìÅ
async function removeGreenRiverFromShelf(storyId, btnElement) {
    try {
        // Êü•ÊâæÂØπÂ∫îÁöÑ‰π¶Êû∂ËÆ∞ÂΩï
        const bookRecord = await db.readingLibrary.where('linkedStoryId').equals(storyId).first();
        
        if (!bookRecord) {
            // Êï∞ÊçÆÂ∫ìÈáåÂèØËÉΩÂ∑≤ÁªèË¢´Âà†‰∫ÜÔºåÁõ¥Êé•Êõ¥Êñ∞UI
            if (btnElement) resetBtnToAddState(storyId, btnElement);
            return;
        }

        const confirmed = await showCustomConfirm(
            "ÁßªÂá∫‰π¶Êû∂",
            `Á°ÆÂÆöË¶ÅÂ∞Ü„Ää${bookRecord.title}„Äã‰ªé‚Äú‰∏ÄËµ∑ËØª‚Äù‰π¶Êû∂‰∏≠ÁßªÈô§ÂêóÔºü\n(ÁªøÊ±üAPP‰∏≠ÁöÑÂéüÁ®ø‰∏ç‰ºöË¢´Âà†Èô§)`,
            { confirmButtonClass: 'btn-danger', confirmText: 'ÁßªÂá∫' }
        );

        if (confirmed) {
            // Âà†Èô§‰π¶Êû∂ËÆ∞ÂΩï
            await db.readingLibrary.delete(bookRecord.id);
            
            // Êõ¥Êñ∞ UI ‰∏∫‚ÄúÊú™Ê∑ªÂä†‚ÄùÁä∂ÊÄÅ
            if (btnElement) {
                resetBtnToAddState(storyId, btnElement);
            }
            
            await showCustomAlert("Â∑≤ÁßªÈô§", "‰π¶Á±çÂ∑≤‰ªé‰π¶Êû∂ÁßªÂá∫„ÄÇ");
        }
    } catch (e) {
        console.error("ÁßªÈô§Â§±Ë¥•:", e);
    }
}

// ËæÖÂä©ÂáΩÊï∞ÔºöÈáçÁΩÆÊåâÈíÆ‰∏∫‚ÄúÂä†ÂÖ•‚ÄùÁä∂ÊÄÅ
function resetBtnToAddState(storyId, btn) {
    btn.textContent = "+ Âä†ÂÖ•ÂÖ±ËØª";
    btn.classList.remove('added');
    btn.onclick = (e) => {
        e.stopPropagation();
        addGreenRiverToShelf(storyId, btn);
    };
}

// Êö¥Èú≤ÁªôÂÖ®Â±Ä
window.removeGreenRiverFromShelf = removeGreenRiverFromShelf;
  async function deleteBookFromLibrary(bookId) {
    const book = await db.readingLibrary.get(bookId);
    if (!book) return;

    const confirmed = await showCustomConfirm('Âà†Èô§‰π¶Á±ç', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.title}„ÄãÂêóÔºü`, {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.readingLibrary.delete(bookId);
      await renderBookLibrary();
    }
  }

  function processImportedText(title, textContent) {
    const chatId = state.activeChatId;
    if (!chatId) return;

    const session = readingState[chatId];
    session.title = title.replace(/\.txt$/i, '');
    session.contentLines = textContent.split(/\r\n?|\n/);
    session.totalPages = Math.ceil(session.contentLines.length / session.linesPerPage);
    session.currentPage = 0;

    renderReadingRoom(chatId);
  }



  function makeDraggable(windowEl, headerEl) {
    let pos1 = 0,
      pos2 = 0,
      pos3 = 0,
      pos4 = 0;
    let isDragging = false;
    let hasMoved = false;
    const phoneScreen = document.getElementById('phone-screen');

    const startDrag = (e) => {

      if (windowEl !== headerEl && e.target.closest('button')) {
        return;
      }

      isDragging = true;
      hasMoved = false;

      const event = e.type === 'touchstart' ? e.touches[0] : e;
      pos3 = event.clientX;
      pos4 = event.clientY;


      windowEl.style.top = `${windowEl.offsetTop}px`;
      windowEl.style.left = `${windowEl.offsetLeft}px`;
      windowEl.style.transform = '';

      document.addEventListener('mouseup', endDrag);
      document.addEventListener('mousemove', elementDrag);
      document.addEventListener('touchend', endDrag);

      document.addEventListener('touchmove', elementDrag, {
        passive: false
      });
    };

    const elementDrag = (e) => {
      if (!isDragging) return;

      const event = e.type === 'touchmove' ? e.touches[0] : e;
      const diffX = event.clientX - pos3;
      const diffY = event.clientY - pos4;


      if (!hasMoved && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
        hasMoved = true;
      }


      if (hasMoved && e.cancelable) {
        e.preventDefault();
      }

      pos1 = pos3 - event.clientX;
      pos2 = pos4 - event.clientY;
      pos3 = event.clientX;
      pos4 = event.clientY;

      let newTop = windowEl.offsetTop - pos2;
      let newLeft = windowEl.offsetLeft - pos1;

      const maxTop = phoneScreen.clientHeight - windowEl.offsetHeight - 10;
      const maxLeft = phoneScreen.clientWidth - windowEl.offsetWidth - 10;
      newTop = Math.max(10, Math.min(newTop, maxTop));
      newLeft = Math.max(10, Math.min(newLeft, maxLeft));

      windowEl.style.top = newTop + "px";
      windowEl.style.left = newLeft + "px";
    };

    const endDrag = () => {
      document.removeEventListener('mouseup', endDrag);
      document.removeEventListener('mousemove', elementDrag);
      document.removeEventListener('touchend', endDrag);
      document.removeEventListener('touchmove', elementDrag);

      if (!isDragging) return;
      isDragging = false;


      if (!hasMoved) {

        windowEl.click();
      }
    };

    headerEl.addEventListener('mousedown', startDrag);

    headerEl.addEventListener('touchstart', startDrag, {
      passive: false
    });
  }


 
  function minimizeReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive) return;

    document.getElementById('reading-window').classList.add('minimized');
    document.getElementById('reading-restore-btn').style.display = 'flex';
    session.isMinimized = true;
  }


  function restoreReadingRoom() {
    const session = readingState[state.activeChatId];
    if (!session || !session.isActive) return;

    document.getElementById('reading-restore-btn').style.display = 'none';
    document.getElementById('reading-window').classList.remove('minimized');
    session.isMinimized = false;
  }





  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      const context = this;
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(context, args), delay);
    };
  }


 
  function formatReadingStateForAI(chatId) {
    const session = readingState[chatId];


    if (!session || !session.isActive) {
      return "";
    }

    const title = session.title || 'Êú™Áü•‰π¶Á±ç';
    let contentForAI = '';
    let contextLabel = '';


    if (session.currentSnippet && session.currentSnippet.trim()) {
      contentForAI = session.currentSnippet;
      contextLabel = '‰Ω†Ê≠£Âú®ÈòÖËØªÁöÑÊÆµËêΩ';
    } else if (session.contentLines.length > 0) {
      const startLine = session.currentPage * session.linesPerPage;
      const endLine = startLine + session.linesPerPage;
      contentForAI = session.contentLines.slice(startLine, endLine).join('\n').substring(0, 200);
      contextLabel = 'ÂΩìÂâçÈ°µÂÜÖÂÆπÊëòË¶Å';
    } else {
      contentForAI = '(Êó†ÂÜÖÂÆπ)';
      contextLabel = 'ÂÜÖÂÆπ';
    }
    return `
    - **‰π¶Âêç**: „Ää${title}„Äã
    - **${contextLabel}**: "${contentForAI}..."
    #‰∏ÄËµ∑ËØª‰π¶Ê®°Âºè | Ë°å‰∏∫ÈìÅÂæã
    1.  **ËßíËâ≤ÂÆö‰Ωç**: ‰Ω†„Äê‰∏çÊòØ„Äë‰π¶‰∏≠ÁöÑ‰ªª‰ΩïËßíËâ≤Ôºå‰Ω†ÊòØ„Äê‰Ω†Ëá™Â∑±„Äë(${state.chats[chatId]?.originalName || 'AIËßíËâ≤'})ÔºåÊ≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑„ÄêÈòÖËØªÂíåËÆ®ËÆ∫„ÄëËøôÊú¨‰π¶„ÄÇ
    2.  **Ë°å‰∏∫ÂáÜÂàô**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰Ωú‰∏∫ËØªËÄÖÁöÑ„ÄêÊÑüÊÉ≥„ÄÅËØÑËÆ∫„ÄÅÊèêÈóÆÊàñËÅîÊÉ≥„Äë„ÄÇ‰Ω†ÂèØ‰ª•Ôºö
        -   ÂàÜ‰∫´‰Ω†ÂØπÂΩìÂâçÊÆµËêΩÁöÑÁúãÊ≥ï„ÄÇ
        -   ÂØπ‰π¶‰∏≠ÁöÑËßíËâ≤ÊàñÊÉÖËäÇÂèëË°®ËØÑËÆ∫„ÄÇ
        -   ÂêëÁî®Êà∑ÊèêÈóÆÔºåËØ¢ÈóÆTAÂØπÂÜÖÂÆπÁöÑÁúãÊ≥ï„ÄÇ
        -   Ê†πÊçÆ‰π¶Êú¨ÂÜÖÂÆπÔºåËÅîÊÉ≥Âà∞‰Ω†Ëá™Â∑±ÁöÑÁªèÂéÜÊàñËÆ∞ÂøÜ„ÄÇ
    3.  **‰∏•Á¶Å**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®‰π¶‰∏≠ËßíËâ≤ÁöÑÂè£ÂêªÂíå‰∫∫Áß∞ÔºÅ„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÊâÆÊºî‰π¶‰∏≠ÁöÑ‰ªª‰ΩïËßíËâ≤ÔºÅ„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÁª≠ÂÜôÊàñÊ®°‰ªø‰π¶‰∏≠ÁöÑÊÉÖËäÇÔºÅ‰Ω†ÂøÖÈ°ªÊó∂ÂàªËÆ∞‰ΩèÔºå‰Ω†Âè™ÊòØ‰∏Ä‰∏™ËØªËÄÖ„ÄÇ    
`;
  }


  
  function updateReadingContextOnScroll() {
    const chatId = state.activeChatId;
    if (!chatId || !readingState[chatId]) return;

    const session = readingState[chatId];
    const container = document.getElementById('reading-content');
    
    if (!container) return;

   
    const chat = state.chats[chatId];
 
    const fontSize = (chat && chat.settings && chat.settings.fontSize) ? chat.settings.fontSize : 13;
    
    const approximateLineHeight = fontSize * 1.6; 
 
    const scrollTop = container.scrollTop;
    const clientHeight = container.clientHeight;
    const scrollBottom = scrollTop + clientHeight;

   
    const firstVisibleLine = Math.floor(scrollTop / approximateLineHeight);
    const lastVisibleLine = Math.ceil(scrollBottom / approximateLineHeight);

   
    const absoluteStartIndex = (session.currentPage * session.linesPerPage) + firstVisibleLine;
    const absoluteEndIndex = (session.currentPage * session.linesPerPage) + lastVisibleLine;

    if (absoluteStartIndex < 0 || absoluteStartIndex >= session.contentLines.length) {
      return;
    }

   
    const newSnippet = session.contentLines.slice(
      Math.max(0, absoluteStartIndex),
      Math.min(session.contentLines.length, absoluteEndIndex)
    ).join('\n');

    session.currentSnippet = newSnippet;
    
    // Ë∞ÉËØïÊó•ÂøóÔºàÂèØÈÄâÔºåÂ¶ÇÊûú‰Ω†ÊÉ≥Âú®ÊéßÂà∂Âè∞ÁúãÊïàÊûúÔºâ
    // console.log(`[ÈòÖËØªËßÜÂè£Êõ¥Êñ∞] Â≠ó‰Ωì:${fontSize}px, Ë°åÈ´ò:${approximateLineHeight}, ÂèØËßÅË°å:${firstVisibleLine}-${lastVisibleLine}`);
  }




  function playSilentAudio() {
    const silentPlayer = document.getElementById('silent-audio-player');
    if (silentPlayer) {

      const playPromise = silentPlayer.play();
      if (playPromise !== undefined) {
        playPromise.then(_ => {
          console.log("ÈùôÈü≥Èü≥È¢ëÂ∑≤ÂêØÂä®ÔºåÁî®‰∫éÂêéÂè∞Ê¥ªÂä®‰øùÊ¥ª„ÄÇ");
        }).catch(error => {


          console.warn("Êó†Ê≥ïËá™Âä®Êí≠ÊîæÈùôÈü≥Èü≥È¢ëÔºàËøôÂú®iOSÈ¶ñÊ¨°Âä†ËΩΩÊó∂ÊòØÊ≠£Â∏∏Áé∞Ë±°Ôºâ:", error);
        });
      }
    }
  }

 
  function stopSilentAudio() {
    const silentPlayer = document.getElementById('silent-audio-player');
    if (silentPlayer && !silentPlayer.paused) {
      silentPlayer.pause();
      silentPlayer.currentTime = 0;
      console.log("ÈùôÈü≥Èü≥È¢ëÂ∑≤ÂÅúÊ≠¢„ÄÇ");
    }
  }


  function hexToUint8Array(hexString) {
    if (!hexString) return new Uint8Array();
    const arrayBuffer = new Uint8Array(hexString.length / 2);
    for (let i = 0; i < hexString.length; i += 2) {
        arrayBuffer[i / 2] = parseInt(hexString.substr(i, 2), 16);
    }
    return arrayBuffer;
}
// --- Êñ∞Â¢ûÔºöËßÜÈ¢ëÈÄöËØù‰∏ìÁî® TTS Êí≠ÊîæÂáΩÊï∞ ---
async function playVideoCallPureTTS(text, voiceId) {
    // 1. Ê≠£ÂàôÂéªÈô§Êã¨Âè∑ÂèäÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ (ÊîØÊåÅ‰∏≠Ëã±ÊñáÊã¨Âè∑ [])
    // ÂåπÈÖçÔºö(xxx) Êàñ ÔºàxxxÔºâ Êàñ [xxx] Êàñ „Äêxxx„Äë
    const cleanText = text.replace(/(\[.*?\]|\(.*?\)|Ôºà.*?Ôºâ|„Äê.*?„Äë)/g, '').trim();

    // Â¶ÇÊûúÂéªÈô§Êã¨Âè∑ÂêéÊ≤°Â≠ó‰∫ÜÔºåÂ∞±‰∏çËØª
    if (!cleanText) return;

    // 2. Ê£ÄÊü•ÈÖçÁΩÆ
    const { minimaxGroupId, minimaxApiKey } = state.apiConfig;
    if (!minimaxGroupId || !minimaxApiKey || !voiceId) return;

    // 3. Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶ÈùôÈü≥ÊàñË¢´ÊöÇÂÅú (ÂèØÈÄâÔºåËøôÈáåÁõ¥Êé•Êí≠Êîæ)
    const ttsPlayer = document.getElementById('tts-audio-player');
    
    // ÁÆÄÂçïÁöÑÈò≤ÊäñÔºöÂ¶ÇÊûúÊ≠£Âú®ËØªÂêåÊ†∑ÁöÑÂÜÖÂÆπÔºåÂøΩÁï•
    if (!ttsPlayer.paused && ttsPlayer.dataset.currentText === cleanText) return;

    console.log(`[ËßÜÈ¢ëÈÄöËØùTTS] Ê≠£Âú®ÊúóËØª: ${cleanText}`);

    try {
        const savedDomain = state.apiConfig.minimaxDomain || localStorage.getItem('minimax-domain') || 'https://api.minimax.chat';
        const modelId = state.apiConfig.minimaxModel || "speech-01-hd";

        const response = await fetch(`${savedDomain}/v1/t2a_v2?GroupId=${minimaxGroupId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${minimaxApiKey}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: modelId,
                text: cleanText, // ‰ΩøÁî®ËøáÊª§ÂêéÁöÑÊñáÊú¨
                stream: false,
                voice_setting: {
                    voice_id: voiceId,
                    speed: 1.0,
                    vol: 1.0,
                    pitch: 0
                },
                audio_setting: {
                    sample_rate: 32000,
                    bitrate: 128000,
                    format: "mp3",
                    channel: 1
                }
            })
        });

        if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");

        const data = await response.json();
        if (data.base_resp && data.base_resp.status_code !== 0) throw new Error(data.base_resp.status_msg);

        const audioHex = data.data?.audio;
        if (!audioHex) return;

        // ‰ΩøÁî®Áé∞ÊúâÁöÑ hexToUint8Array ÂáΩÊï∞ËΩ¨Êç¢
        const audioBytes = hexToUint8Array(audioHex);
        const audioBlob = new Blob([audioBytes], { type: 'audio/mpeg' });
        const audioUrl = URL.createObjectURL(audioBlob);

        ttsPlayer.src = audioUrl;
        ttsPlayer.dataset.currentText = cleanText; // Ê†áËÆ∞ÂΩìÂâçÊñáÊú¨
        ttsPlayer.play().catch(e => console.error("ËßÜÈ¢ëËØ≠Èü≥Êí≠ÊîæÂ§±Ë¥•:", e));

    } catch (error) {
        console.error("ËßÜÈ¢ëÈÄöËØùTTSÁîüÊàêÂ§±Ë¥•:", error);
    }
}
async function playTtsAudio(bodyElement) {
    const text = decodeURIComponent(bodyElement.dataset.text);

    // 1. Ëé∑Âèñ Voice ID
    let voiceId = bodyElement.dataset.voiceId;
    // Êñ∞Â¢ûÔºöÂàùÂßãÂåñËØ≠Ë®ÄËÆæÁΩÆÔºåÈªòËÆ§‰∏∫ÊôÆÈÄöËØù
    let ttsLanguage = 'zh-CN';

    if (state.activeChatId && state.chats[state.activeChatId]) {
        const chat = state.chats[state.activeChatId];
        if (!chat.isGroup && chat.settings.enableTts !== false) {
            // ‰ºòÂÖà‰ΩøÁî®Ê†áÁ≠æ‰∏äÁöÑIDÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÁî®ËÆæÁΩÆÈáåÁöÑ
            if (!voiceId) voiceId = chat.settings.minimaxVoiceId;
            // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëËé∑ÂèñÁî®Êà∑Âú®ËÆæÁΩÆ‰∏≠ÈÄâÊã©ÁöÑËØ≠Ë®Ä/ÊñπË®Ä
            if (chat.settings.ttsLanguage) ttsLanguage = chat.settings.ttsLanguage;
        }
    }

    if (!voiceId) {
        alert("ÈîôËØØÔºöÊó†Ê≥ïËé∑Âèñ Voice ID„ÄÇËØ∑Ê£ÄÊü•ËßíËâ≤ËÆæÁΩÆ„ÄÇ");
        return;
    }

    const button = bodyElement.querySelector('.voice-play-btn');
    const spinner = bodyElement.querySelector('.loading-spinner');
    const ttsPlayer = document.getElementById('tts-audio-player');

    // Êí≠Êîæ/ÊöÇÂÅúÈÄªËæë
    if (!ttsPlayer.paused && ttsPlayer.dataset.currentText === text && ttsPlayer.dataset.currentVoiceId === voiceId) {
        ttsPlayer.pause();
        return;
    }
    ttsPlayer.pause();
    document.querySelectorAll('.voice-play-btn').forEach(btn => btn.textContent = '‚ñ∂');

    // 2. Ê£ÄÊü•ÁºìÂ≠ò (KeyÂä†ÂÖ•ËØ≠Ë®ÄÂå∫ÂàÜÔºåÈò≤Ê≠¢ÂàáÊç¢ÊñπË®ÄÂêéËØªÂà∞ÊóßÁºìÂ≠ò)
    const cacheKey = `tts_v2_${voiceId}_${ttsLanguage}_${text}`;
    let cachedAudio = state.ttsCache.get(cacheKey);
    if (cachedAudio) {
        console.log("‰ªéÁºìÂ≠òÊí≠Êîæ TTS...");
        await playAudioFromData(cachedAudio.url, cachedAudio.type, text, voiceId, bodyElement);
        return;
    }

    console.log(`ËØ∑Ê±Ç Minimax T2A v2... VoiceID: ${voiceId}, Language: ${ttsLanguage}`);
    if (button) button.style.display = 'none';
    spinner.style.display = 'block';

    const {
        minimaxGroupId,
        minimaxApiKey
    } = state.apiConfig;

    const languageMap = {
        'zh-CN': 'Chinese',
        'zh-HK': 'Chinese,Yue',   // Á≤§ËØ≠ÁâπÊÆäÂ§ÑÁêÜ
        'en-US': 'English',
        'ja-JP': 'Japanese',
        'ko-KR': 'Korean',
        'de-DE': 'German',
        'fr-FR': 'French',
        'es-ES': 'Spanish',
        'it-IT': 'Italian',
        'ru-RU': 'Russian',
        'pt-BR': 'Portuguese',
        'nl-NL': 'Dutch',
        'pl-PL': 'Polish',
        'sv-SE': 'Swedish',
        'tr-TR': 'Turkish',
        'id-ID': 'Indonesian',
        'ms-MY': 'Malay',
        'vi-VN': 'Vietnamese',
        'th-TH': 'Thai',
        'hi-IN': 'Hindi',
        'ar-SA': 'Arabic'
    };

    // Ëé∑ÂèñÂØπÂ∫îÁöÑ boost ÂÄºÔºåÂ¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÂà∞Â∞±ÈªòËÆ§ 'auto'
    const boostValue = languageMap[ttsLanguage] || 'auto';

    // 2. ÂèëÈÄÅËØ∑Ê±Ç (Ê≥®ÊÑè language_boost ÁöÑ‰ΩçÁΩÆ)
    try {
        const savedDomain = state.apiConfig.minimaxDomain || localStorage.getItem('minimax-domain') || 'https://api.minimax.chat';
        const minimaxBaseUrl = savedDomain;
        const modelId = state.apiConfig.minimaxModel || "speech-01-hd";

        const response = await fetch(`${minimaxBaseUrl}/v1/t2a_v2?GroupId=${minimaxGroupId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${minimaxApiKey}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: modelId,
                text: text,
                stream: false,
                
               
                language_boost: boostValue, 

                voice_setting: {
                    voice_id: voiceId,
                    speed: 1.0,
                    vol: 1.0,
                    pitch: 0
                },
                audio_setting: {
                    sample_rate: 32000,
                    bitrate: 128000,
                    format: "mp3",
                    channel: 1
                }
            })
        });

        if (!response.ok) {
            let errorMsg = `API Â§±Ë¥•: ${response.status}`;
            try {
                const errJson = await response.json();
                errorMsg += ` - ${errJson.base_resp?.status_msg || JSON.stringify(errJson)}`;
            } catch (e) {}
            throw new Error(errorMsg);
        }

        const data = await response.json();

        // 4. Ê£ÄÊü•‰∏öÂä°Áä∂ÊÄÅÁ†Å
        if (data.base_resp && data.base_resp.status_code !== 0) {
            throw new Error(`API ÈîôËØØ: ${data.base_resp.status_msg}`);
        }

        // 5. Ëß£Êûê Hex Èü≥È¢ëÊï∞ÊçÆ
        const audioHex = data.data?.audio;
        if (!audioHex) throw new Error("API Êú™ËøîÂõûÈü≥È¢ëÊï∞ÊçÆ");

        const audioBytes = hexToUint8Array(audioHex);
        const audioBlob = new Blob([audioBytes], {
            type: 'audio/mpeg'
        });
        const audioUrl = URL.createObjectURL(audioBlob);

        await playAudioFromData(audioUrl, 'audio/mpeg', text, voiceId, bodyElement);

        // ÂÜôÂÖ•ÁºìÂ≠ò
        const reader = new FileReader();
        reader.onloadend = function() {
            state.ttsCache.set(cacheKey, {
                url: reader.result,
                type: 'audio/mpeg'
            });
        }
        reader.readAsDataURL(audioBlob);

    } catch (error) {
        console.error("TTS ÁîüÊàêÂ§±Ë¥•:", error);
        await showCustomAlert("ËØ≠Èü≥ÁîüÊàêÂ§±Ë¥•", `ÈîôËØØ: ${error.message}`);
    } finally {
        spinner.style.display = 'none';
        if (button) button.style.display = 'flex';
    }
}


  function playAudioFromData(audioSrc, audioType, text, voiceId, bodyElement) {
    return new Promise((resolve, reject) => {
      const ttsPlayer = document.getElementById('tts-audio-player');

      ttsPlayer.src = audioSrc;
      ttsPlayer.type = audioType;
      ttsPlayer.dataset.currentText = text;
      ttsPlayer.dataset.currentVoiceId = voiceId;

      const playPromise = ttsPlayer.play();

      if (playPromise !== undefined) {
        playPromise.then(() => {
          const button = bodyElement.querySelector('.voice-play-btn');
          if (button) button.textContent = '‚ùö‚ùö';


          resolve();
        }).catch(error => {
          console.error("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:", error);
          reject(error);
        });
      }

      ttsPlayer.onended = () => {
        const button = bodyElement.querySelector('.voice-play-btn');
        if (button) button.textContent = '‚ñ∂';
      };
      ttsPlayer.onpause = () => {
        const button = bodyElement.querySelector('.voice-play-btn');
        if (button) button.textContent = '‚ñ∂';
      };
    });
  }




  function toggleVoiceTranscript(bodyElement) {
    const bubble = bodyElement.closest('.message-bubble');
    if (!bubble) return;

    const transcriptEl = bubble.querySelector('.voice-transcript');
    const text = decodeURIComponent(bodyElement.dataset.text);

    if (transcriptEl.style.display === 'block') {

      transcriptEl.style.display = 'none';
    } else {

      transcriptEl.textContent = text;
      transcriptEl.style.display = 'block';
    }
  }



  async function openProductCategoryManager() {
    await renderProductCategoriesInManager();
    document.getElementById('product-category-manager-modal').classList.add('visible');
  }


  async function renderProductCategoriesInManager() {
    const listEl = document.getElementById('existing-product-categories-list');
    const categories = await db.shoppingCategories.toArray();
    listEl.innerHTML = '';
    if (categories.length === 0) {
      listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
      return;
    }
    categories.forEach(cat => {
      const item = document.createElement('div');
      item.className = 'existing-group-item';
      item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
        `;
      listEl.appendChild(item);
    });
  }


  async function addNewProductCategory() {
    const input = document.getElementById('new-product-category-name-input');
    const name = input.value.trim();
    if (!name) return alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
    const existing = await db.shoppingCategories.where('name').equals(name).first();
    if (existing) return alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);

    await db.shoppingCategories.add({
      name
    });
    input.value = '';
    await renderProductCategoriesInManager();
  }


  async function deleteProductCategory(categoryId) {
    const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁ±ªÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÊâÄÊúâÂïÜÂìÅÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöÂêóÔºü', {
      confirmButtonClass: 'btn-danger'
    });
    if (confirmed) {
      await db.shoppingCategories.delete(categoryId);
      await db.shoppingProducts.where('categoryId').equals(categoryId).modify({
        categoryId: null
      });
      await renderProductCategoriesInManager();
    }
  }

 
  function addProductVariationInput(variation = {}) {
    const container = document.getElementById('product-variations-container');
    const block = document.createElement('div');
    block.className = 'message-editor-block variation-block'; // Â§çÁî®Ê†∑Âºè
    block.innerHTML = `
        <button class="delete-block-btn" title="Âà†Èô§Ê≠§Ê¨æÂºè">√ó</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
                <label style="font-size: 0.8em;">Ê¨æÂºèÂêçÁß∞</label>
                <input type="text" class="variation-name-input" placeholder="‰æãÂ¶Ç: Á∫¢Ëâ≤" value="${variation.name || ''}">
            </div>
            <div class="form-group">
                <label style="font-size: 0.8em;">‰ª∑Ê†º (ÂÖÉ)</label>
                <input type="number" class="variation-price-input" min="0" step="0.01" value="${variation.price || ''}">
            </div>
        </div>
        <div class="form-group">
            <label style="font-size: 0.8em;">Ê¨æÂºèÂõæÁâá (ÂèØÈÄâ)</label>
            <div class="avatar-upload">
                <img class="variation-image-preview" src="${variation.imageUrl || 'https://i.postimg.cc/PqYp5T5M/image.png'}">
                <button type="button" class="form-button-secondary upload-variation-image-btn" style="margin: 0; padding: 8px 12px;">‰∏ä‰º†</button>
                <input type="file" class="variation-image-input" accept="image/*" hidden>
            </div>
        </div>
    `;

    block.querySelector('.delete-block-btn').addEventListener('click', () => block.remove());
    block.querySelector('.upload-variation-image-btn').addEventListener('click', () => {
      block.querySelector('.variation-image-input').click();
    });
    block.querySelector('.variation-image-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (re) => {
          block.querySelector('.variation-image-preview').src = re.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    container.appendChild(block);
    return block;
  }

  async function openVariationSelector(productId) {
    const product = await db.shoppingProducts.get(productId);
    if (!product || !product.variations || product.variations.length === 0) return;

    const modal = document.getElementById('variation-selection-modal');
    document.getElementById('variation-product-image').src = product.imageUrl;
    document.getElementById('variation-product-name').textContent = product.name;

    const optionsContainer = document.getElementById('variation-options-container');
    optionsContainer.innerHTML = '';

    product.variations.forEach((variation, index) => {
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'variation-select';
      radio.id = `var-${productId}-${index}`;
      radio.value = index;
      radio.style.display = 'none';
      if (index === 0) radio.checked = true;

      const label = document.createElement('label');
      label.htmlFor = `var-${productId}-${index}`;
      label.textContent = variation.name;
      label.style.cssText = `
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
        `;

      optionsContainer.appendChild(radio);
      optionsContainer.appendChild(label);
    });

    const updateSelectionUI = () => {
      const selectedRadio = optionsContainer.querySelector('input[name="variation-select"]:checked');
      optionsContainer.querySelectorAll('label').forEach(lbl => {
        lbl.style.borderColor = '#ccc';
        lbl.style.color = '#333';
        lbl.style.backgroundColor = 'white';
      });
      if (selectedRadio) {
        const selectedLabel = optionsContainer.querySelector(`label[for="${selectedRadio.id}"]`);
        selectedLabel.style.borderColor = 'var(--accent-color)';
        selectedLabel.style.color = 'var(--accent-color)';
        selectedLabel.style.backgroundColor = '#e7f3ff';

        const selectedVariation = product.variations[parseInt(selectedRadio.value)];
        document.getElementById('variation-selected-price').textContent = `¬•${selectedVariation.price.toFixed(2)}`;
        if (selectedVariation.imageUrl) {
          document.getElementById('variation-product-image').src = selectedVariation.imageUrl;
        } else {
          document.getElementById('variation-product-image').src = product.imageUrl;
        }
      }
    };

    optionsContainer.addEventListener('change', updateSelectionUI);
    updateSelectionUI();

    document.getElementById('variation-quantity-display').textContent = '1';

    const confirmBtn = document.getElementById('confirm-variation-selection-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', async () => {
      const selectedRadio = optionsContainer.querySelector('input[name="variation-select"]:checked');
      const quantity = parseInt(document.getElementById('variation-quantity-display').textContent);
      if (selectedRadio) {
        const selectedVariation = product.variations[parseInt(selectedRadio.value)];
        await addToCart(productId, quantity, selectedVariation);
        modal.classList.remove('visible');
        await showCustomAlert('ÊàêÂäü', 'Â∑≤ÊàêÂäüÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶ÔºÅ');
      }
    });

    modal.classList.add('visible');
  }


  function openShoppingSettingsModal() {
    const modal = document.getElementById('shopping-settings-modal');

    // ‰ªéÂÖ®Â±ÄËÆæÁΩÆ‰∏≠ËØªÂèñÂ∑≤‰øùÂ≠òÁöÑÂÄºÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞±‰ΩøÁî®ÈªòËÆ§ÂÄº
    document.getElementById('shopping-category-count-input').value = state.globalSettings.shoppingCategoryCount || 3;
    document.getElementById('shopping-product-count-input').value = state.globalSettings.shoppingProductCount || 8;

    modal.classList.add('visible');
  }


  async function saveShoppingSettings() {
    const categoryInput = document.getElementById('shopping-category-count-input');
    const productInput = document.getElementById('shopping-product-count-input');

    const categoryCount = parseInt(categoryInput.value);
    const productCount = parseInt(productInput.value);


    if (isNaN(categoryCount) || isNaN(productCount) || categoryCount < 1 || productCount < 1) {
      alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ≠£Êï¥Êï∞ÔºÅ");
      return;
    }


    state.globalSettings.shoppingCategoryCount = categoryCount;
    state.globalSettings.shoppingProductCount = productCount;
    await db.globalSettings.put(state.globalSettings);


    document.getElementById('shopping-settings-modal').classList.remove('visible');
    await showCustomAlert('‰øùÂ≠òÊàêÂäü', 'Ë¥≠Áâ©‰∏≠ÂøÉÁîüÊàêËÆæÁΩÆÂ∑≤Êõ¥Êñ∞ÔºÅ');
  }


  async function handleGenerateShoppingItems() {

    if (!state.activeChatId) {
      await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", "ËØ∑ÂÖàËøõÂÖ•‰∏Ä‰∏™ËÅäÂ§©È°µÈù¢ÔºåÂÜçËøîÂõûË¥≠Áâ©‰∏≠ÂøÉËøõË°åÁîüÊàêÔºå‰ª•‰æøAI‰∫ÜËß£Ë¶Å‰∏∫Âì™‰∏™ËßíËâ≤ÁîüÊàêÂïÜÂìÅ„ÄÇ");
      return;
    }
    const chat = state.chats[state.activeChatId];

    const confirmed = await showCustomConfirm(
      `‰∏∫‚Äú${chat.name}‚ÄùÁîüÊàêÂïÜÂìÅÔºü`,
      'Ê≠§Êìç‰ΩúÂ∞Ü‰ΩøÁî®AIÁîüÊàêÊñ∞ÁöÑÂïÜÂìÅÂíåÂàÜÁ±ªÔºåÂπ∂„ÄêÊ∑ªÂä†„ÄëÂà∞Áé∞ÊúâÂàóË°®‰∏≠„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü', {
        confirmText: 'Á°ÆËÆ§ÁîüÊàê'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê†πÊçÆ‚Äú${chat.name}‚ÄùÁöÑÁâπÁÇπÁîüÊàê‰∏ìÂ±ûÂïÜÂìÅ...`);


    const useSecondaryApi = state.apiConfig.secondaryProxyUrl && state.apiConfig.secondaryApiKey && state.apiConfig.secondaryModel;
    const {
      proxyUrl,
      apiKey,
      model
    } = useSecondaryApi
      ?
      {
        proxyUrl: state.apiConfig.secondaryProxyUrl,
        apiKey: state.apiConfig.secondaryApiKey,
        model: state.apiConfig.secondaryModel
      } :
      state.apiConfig;

    if (!proxyUrl || !apiKey || !model) {
      await showCustomAlert("APIÊú™ÈÖçÁΩÆ", "ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩÔºà‰∏ªÊàñÂâØÔºâAPI„ÄÇ");
      return;
    }

    const categoryCount = state.globalSettings.shoppingCategoryCount || 3;
    const productCount = state.globalSettings.shoppingProductCount || 8;

    const existingCategories = await db.shoppingCategories.toArray();
    let existingCategoriesContext = "";
    if (existingCategories.length > 0) {
      existingCategoriesContext = `
# „ÄêÂàÜÁ±ªÂ§çÁî®ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºÅ)„Äë
Âú®‰∏∫Êñ∞ÂïÜÂìÅÊåáÂÆöÂàÜÁ±ªÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÈ¶ñÂÖàÊ£ÄÊü•‰∏ãÈù¢ÁöÑ‚ÄúÂ∑≤ÊúâÂàÜÁ±ªÂàóË°®‚Äù„ÄÇ
-   Â¶ÇÊûú‰∏Ä‰∏™Êñ∞ÂïÜÂìÅÂèØ‰ª•Ë¢´ÂΩíÂÖ•Êüê‰∏™„ÄêÂ∑≤Â≠òÂú®ÁöÑÂàÜÁ±ª„ÄëÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂ§çÁî®ÈÇ£‰∏™ÂàÜÁ±ªÁöÑÂêçÁß∞ÔºåËÄå‰∏çÊòØÂàõÈÄ†‰∏Ä‰∏™Áõ∏‰ººÁöÑÊñ∞ÂàÜÁ±ªÔºÅ
-   Âè™ÊúâÂΩì‰Ω†Á°ÆÂÆöÂïÜÂìÅ„ÄêÁªùÂØπ„Äë‰∏çÂ±û‰∫é‰ªª‰Ωï‰∏Ä‰∏™Â∑≤ÊúâÂàÜÁ±ªÊó∂Ôºå‰Ω†ÊâçËÉΩÂàõÈÄ†‰∏Ä‰∏™Êñ∞ÁöÑÂàÜÁ±ªÂêçÁß∞„ÄÇ
-   **Â∑≤ÊúâÂàÜÁ±ªÂàóË°®**: [${existingCategories.map(c => `"${c.name}"`).join(', ')}]
`;
    }

    const userNickname = state.qzoneSettings.nickname || 'Êàë';
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- (ËÆ∞ÂΩï‰∫é ${formatTimeAgo(mem.timestamp)}) ${mem.content}`).join('\n') :
      'Êó†';
    const recentHistoryContext = chat.history.slice(-10).map(msg =>
      `${msg.role === 'user' ? userNickname : chat.name}: ${String(msg.content).substring(0, 30)}...`
    ).join('\n');

    let worldBookContext = '';
    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
      const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';
        const enabledEntries = worldBook.content
          .filter(entry => entry.enabled !== false)
          .map(entry => `- ${entry.content}`)
          .join('\n');
        return enabledEntries ? `\n## Êù•Ëá™„Ää${worldBook.name}„Äã:\n${enabledEntries}` : '';
      }).filter(Boolean).join('');

      if (linkedContents) {
        worldBookContext = `\n# ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ªÂèÇËÄÉ)\n${linkedContents}\n`;
      }
    }

    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁöÑ„ÄÅÊûÅÂÖ∑ÂàõÈÄ†ÂäõÁöÑÂïÜÂìÅËßÑÂàíÂ∏à„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØ‰∏∫‰∏ãÈù¢ÁöÑËßíËâ≤‚Äú${chat.name}‚ÄùÈáèË∫´ÊâìÈÄ†‰∏Ä‰∏™‰∏ìÂ±ûÁöÑÂïÜÂìÅÂàóË°®„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **„ÄêËßíËâ≤ÂÆöÂà∂(ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë**: ‰Ω†ÁîüÊàêÁöÑÊâÄÊúâÂïÜÂìÅÂíåÂàÜÁ±ª„ÄêÂøÖÈ°ª„ÄëÊ∑±Â∫¶ÁªëÂÆöËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÆ∞ÂøÜÂíåÊúÄËøëÁöÑÂØπËØù„ÄÇÂÆÉ‰ª¨Â∫îËØ•ÊòØËßíËâ≤‰ºöÁúüÊ≠£ÊÑüÂÖ¥Ë∂£„ÄÅË¥≠‰π∞ÊàñÂà∂‰ΩúÁöÑ‰∏úË•ø„ÄÇ
2.  **ÂàõÈÄ†ÊÄß‰∏éÂêàÁêÜÊÄß**: ÂïÜÂìÅÂíåÂàÜÁ±ªÂøÖÈ°ªÂêàÁêÜ‰∏îÂ§öÊ†∑Âåñ„ÄÇ
3.  **Ê†ºÂºèÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™„ÄêÂçï‰∏ÄÁöÑJSONÂØπË±°„Äë„ÄÇ
    - ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰ª• \`{\` ÂºÄÂßãÔºåÂπ∂‰ª• \`}\` ÁªìÊùü„ÄÇ
    - „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂú®JSONÂØπË±°ÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÂ§ö‰ΩôÁöÑÊñáÂ≠ó„ÄÅËß£ÈáäÊàñ markdown Ê†áËÆ∞„ÄÇ
    - Ê†ºÂºè„ÄêÂøÖÈ°ª„ÄëÂ¶Ç‰∏ã:
    \`\`\`json
    {
      "categories": [
        {
          "name": "ÂàÜÁ±ªÂêçÁß∞1",
          "products": [
            {
              "name": "ÂïÜÂìÅÂêçÁß∞1",
              "price": 99.80,
              "description": "ËøôÊòØÂïÜÂìÅÁöÑËØ¶ÁªÜÊèèËø∞Ôºå‰∏çÂ∞ë‰∫é50Â≠ó...",
              "variations": [
                { "name": "Ê¨æÂºè1", "price": 108.80, "image_prompt": "Ê¨æÂºè1ÁöÑÂõæÁâá„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç..." },
                { "name": "Ê¨æÂºè2", "price": 118.80, "image_prompt": "Ê¨æÂºè2ÁöÑÂõæÁâá„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç..." }
              ],
              "image_prompt": "ÂïÜÂìÅ‰∏ªÂõæÁöÑ„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç, È£éÊ†º‰∏∫ realistic product photo, high quality, on a clean white background"
            }
          ]
        }
      ]
    }
    \`\`\`
    - **categories**: ÁîüÊàê ${categoryCount} ‰∏™ÂàÜÁ±ª„ÄÇ
    - **products**: ÊØè‰∏™ÂàÜÁ±ª‰∏ãÁîüÊàê ${productCount} ‰∏™ÂïÜÂìÅ„ÄÇ
    - **variations**: ÊØè‰∏™ÂïÜÂìÅ„ÄêÂøÖÈ°ª„ÄëÂåÖÂê´„Äê2Âà∞4‰∏™„Äë‰∏çÂêåÁöÑÊ¨æÂºè„ÄÇ

# ËßíËâ≤‰∏é‰∏ä‰∏ãÊñá (‰Ω†ÁöÑÁÅµÊÑüÊù•Ê∫ê)
- **ËßíËâ≤ÂêçÁß∞**: ${chat.name}
- **ËßíËâ≤‰∫∫ËÆæ**: ${chat.settings.aiPersona}
- **ÈïøÊúüËÆ∞ÂøÜ**: ${longTermMemoryContext}
- **‰∏ñÁïå‰π¶ËÆæÂÆö**: ${worldBookContext}
${existingCategoriesContext}
- **ÊúÄËøëÂØπËØùÊëòË¶Å**:
${recentHistoryContext}

Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏ä„ÄêÊâÄÊúâ‰∏ä‰∏ãÊñá‰ø°ÊÅØ„ÄëÔºåÂºÄÂßã‰∏∫‚Äú${chat.name}‚ÄùÁîüÊàêËøôÁªÑ„Äê‰∏éËßíËâ≤È´òÂ∫¶Áõ∏ÂÖ≥„ÄëÁöÑÂïÜÂìÅÊï∞ÊçÆ„ÄÇ`;

    try {
      const messagesForApi = [{
        role: 'user',
        content: "ËØ∑Ê†πÊçÆ‰ª•‰∏äËÆæÂÆöÔºåÁîüÊàêÂïÜÂìÅÊï∞ÊçÆ„ÄÇ"
      }];
      let isGemini = proxyUrl.includes('generativelanguage');
   
      let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

      const response = isGemini ?
        await fetch(geminiConfig.url, geminiConfig.data) :
        await fetch(`${proxyUrl}/v1/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: [{
              role: 'system',
              content: systemPrompt
            }, ...messagesForApi],
           
            temperature: state.globalSettings.apiTemperature || 0.9
          })
        });

      if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

      const data = await response.json();
      const aiResponseContent = getGeminiResponseText(data);

      const jsonMatch = aiResponseContent.match(/({[\s\S]*})/);
      if (!jsonMatch) throw new Error("AIËøîÂõûÁöÑÂÜÖÂÆπ‰∏≠Êú™ÊâæÂà∞ÊúâÊïàÁöÑJSONÂØπË±°„ÄÇ");
      const generatedData = JSON.parse(jsonMatch[0]);

      if (!generatedData.categories || !Array.isArray(generatedData.categories)) {
        throw new Error("AIËøîÂõûÁöÑJSONÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåÁº∫Â∞ë 'categories' Êï∞ÁªÑ„ÄÇ");
      }

     
      await db.transaction('rw', db.shoppingProducts, db.shoppingCategories, async () => {
        for (const category of generatedData.categories) {
          let categoryId;
          const existingCategory = await db.shoppingCategories.where('name').equalsIgnoreCase(category.name).first();
          if (existingCategory) {
            categoryId = existingCategory.id;
          } else {
            categoryId = await db.shoppingCategories.add({
              name: category.name
            });
          }
          const productsToAdd = category.products.map(product => {
            return {
              name: product.name,
              price: product.price || 0,
              description: product.description || '',
              imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(product.image_prompt)}`,
              variations: (product.variations || []).map(v => ({
                ...v,
                imageUrl: `https://image.pollinations.ai/prompt/${encodeURIComponent(v.image_prompt)}`
              })),
              categoryId: categoryId
            };
          });
          if (productsToAdd.length > 0) {
            await db.shoppingProducts.bulkAdd(productsToAdd);
          }
        }
      });

      activeShoppingCategoryId = 'all';
      await renderShoppingProducts();
      await showCustomAlert('ÁîüÊàêÊàêÂäüÔºÅ', `‰∏∫‚Äú${chat.name}‚ÄùÈáèË∫´ÂÆöÂà∂ÁöÑÂïÜÂìÅÂ∑≤‰∏äÊû∂ÔºÅ`);

    } catch (error) {
      console.error("ÁîüÊàêË¥≠Áâ©‰∏≠ÂøÉÂïÜÂìÅÂ§±Ë¥•:", error);
      await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÂïÜÂìÅÔºåËØ∑Ê£ÄÊü•(‰∏ª/ÂâØ)APIÈÖçÁΩÆÊàñÁ®çÂêéÂÜçËØï„ÄÇ\nÈîôËØØ: ${error.message}`);
    }
  }



  async function handleWidgetImageChange(imageId) {
    const element = document.getElementById(imageId);
    if (!element) return;
  
    const choice = await showChoiceModal("Êõ¥Êç¢ÂõæÁâá", [
        { text: 'üìÅ ‰ªéÊú¨Âú∞‰∏ä‰º†', value: 'local' },
        { text: 'üåê ‰ΩøÁî®ÁΩëÁªúURL', value: 'url' }
    ]);
  
    let newUrl = null;
    let isBase64 = false; // Ê†áËÆ∞ÊòØÂê¶‰∏∫ Base64
  
    if (choice === 'local') {
        newUrl = await new Promise(resolve => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (readerEvent) => resolve(readerEvent.target.result);
                    reader.readAsDataURL(file);
                } else {
                    resolve(null);
                }
            };
            input.click();
        });
        if (newUrl) isBase64 = true;
  
    } else if (choice === 'url') {
        newUrl = await showCustomPrompt("Êõ¥Êç¢ÂõæÁâá", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂõæÁâáURLÔºö", element.src, "url");
        if (newUrl) isBase64 = false;
    }
  
    if (newUrl && newUrl.trim()) {
        const trimmedUrl = newUrl.trim();
        
        // 1. [Ê†∏ÂøÉ‰øÆÊîπ] Á´ãÂç≥ÊòæÁ§∫ Base64 Êàñ URL
        element.src = trimmedUrl;
  
        // 2. Á´ãÂç≥Â∞Ü Base64 Êàñ URL ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÁ°Æ‰øùÂà∑Êñ∞‰∏ç‰∏¢Â§±
        if (!state.globalSettings.widgetData) {
            state.globalSettings.widgetData = {};
        }
        state.globalSettings.widgetData[imageId] = trimmedUrl;
        await db.globalSettings.put(state.globalSettings);
  
        await showCustomAlert("ÊàêÂäü", "ÁªÑ‰ª∂ÂõæÁâáÂ∑≤Êõ¥Êñ∞Âπ∂‰øùÂ≠òÔºÅ");
  
        // 3. [Ê†∏ÂøÉ‰øÆÊîπ] Âè™ÊúâÂΩìÂÆÉÊòØ Base64 ‰∏î ImgBB ÂºÄÂêØÊó∂ÔºåÊâçÂú®ÂêéÂè∞‚ÄúÈùôÈªò‚Äù‰∏ä‰º†
        if (isBase64 && state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
            (async () => {
                console.log(`[ImgBB] ÂêØÂä® ${imageId} ÁöÑÈùôÈªò‰∏ä‰º†...`);
                // Ëøô‰∏™ÂáΩÊï∞‰ºöÂú®ÂêéÂè∞ËøêË°åÔºå‰∏ç‰ºöÈòªÂ°û
                await silentlyUpdateDbUrl(
                    db.globalSettings,
                    'main',
                    `widgetData.${imageId}`,
                    trimmedUrl // ‰º†ÂÖ• Base64 Â≠óÁ¨¶‰∏≤
                );
            })();
        }
    }
  }


  window.handleWidgetImageChange = handleWidgetImageChange;

  async function exportDataAsSlicedZip() {

    if (!window.streamSaver || typeof JSZip === 'undefined') {
      await showCustomAlert("Â∫ìÂä†ËΩΩÂ§±Ë¥•", "Êó†Ê≥ïÂêØÂä®ÂØºÂá∫ÔºåÊâÄÈúÄÁöÑÊ†∏ÂøÉÂ∫ì (StreamSaver.js Êàñ JSZip) Êú™Âä†ËΩΩ„ÄÇËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•Âπ∂Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï„ÄÇ");
      return;
    }

    await showCustomAlert("Ê≠£Âú®ÂáÜÂ§áÂàÜÁâáÂØºÂá∫...", "Âç≥Â∞ÜÂºÄÂßãÊâìÂåÖÊÇ®ÁöÑÂÆåÊï¥Â§á‰ªΩÊñá‰ª∂„ÄÇÊñá‰ª∂Â∞Ü‰ª•ZIPÊ†ºÂºèÊµÅÂºè‰∏ãËΩΩÔºåËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢„ÄÇ");

  
    const fileStream = streamSaver.createWriteStream(`EPhone-Sliced-Backup-${new Date().toISOString().split('T')[0]}.zip`);
    const zip = new JSZip();

  
    const MAX_SLICE_SIZE = 95 * 1024 * 1024;
    let sliceIndex = 1;
    let currentSliceData = {}; 
    let currentSliceSizeBytes = 0;
    const encoder = new TextEncoder(); 

    try {
      const tablesToBackup = db.tables.map(t => t.name);

      for (const tableName of tablesToBackup) {
        console.log(`Ê≠£Âú®ÊâìÂåÖË°®: ${tableName}...`);
        const tableData = await db.table(tableName).toArray();

     
        if (tableData.length === 0) continue;

        const tableDataString = JSON.stringify(tableData);
        const tableDataSize = encoder.encode(tableDataString).length;

     
        if (tableDataSize > MAX_SLICE_SIZE) {
          console.warn(`Ë≠¶ÂëäÔºöË°® "${tableName}" (Â§ßÂ∞è: ${(tableDataSize/1024/1024).toFixed(2)}MB) ÂçïÁã¨Ë∂ÖËøá‰∫ÜÂàáÁâáÈôêÂà∂„ÄÇ`);

      
          if (currentSliceSizeBytes > 0) {
            zip.file(`slice_${sliceIndex++}.json`, JSON.stringify({
              version: 4,
              type: 'slice',
              data: currentSliceData
            }));
            currentSliceData = {};
            currentSliceSizeBytes = 0;
          }

        
          currentSliceData[tableName] = tableData;
          zip.file(`slice_${sliceIndex++}.json`, JSON.stringify({
            version: 4,
            type: 'slice',
            data: currentSliceData
          }));
          currentSliceData = {}; 
          currentSliceSizeBytes = 0;

          continue;
        }

      
        if (currentSliceSizeBytes > 0 && (currentSliceSizeBytes + tableDataSize > MAX_SLICE_SIZE)) {
          console.log(`ÂàáÁâá ${sliceIndex} Â∑≤Êª° (Â§ßÂ∞è: ${(currentSliceSizeBytes/1024/1024).toFixed(2)}MB)ÔºåÊ≠£Âú®ÂΩíÊ°£...`);

      
          zip.file(`slice_${sliceIndex++}.json`, JSON.stringify({
            version: 4,
            type: 'slice',
            data: currentSliceData
          }));

          
          currentSliceData = {};
          currentSliceSizeBytes = 0;
        }

    
        currentSliceData[tableName] = tableData;
        currentSliceSizeBytes += tableDataSize;
      }

    
      if (currentSliceSizeBytes > 0) {
        console.log(`Ê≠£Âú®ÂΩíÊ°£ÊúÄÂêé‰∏Ä‰∏™ÂàáÁâá ${sliceIndex} (Â§ßÂ∞è: ${(currentSliceSizeBytes/1024/1024).toFixed(2)}MB)...`);
        zip.file(`slice_${sliceIndex}.json`, JSON.stringify({
          version: 4,
          type: 'slice',
          data: currentSliceData
        }));
      }

      console.log("ÊâÄÊúâÂàáÁâáÂ∑≤ÊâìÂåÖÔºåÂºÄÂßãÊµÅÂºè‰∏ãËΩΩZIP...");

    
      const zipStream = zip.generateInternalStream({
        type: "blob",
        streamFiles: true
      });

     
      const readableStream = new ReadableStream({
        start(controller) {
          zipStream.on('data', (chunk) => {
           
            controller.enqueue(chunk);
          }).on('end', () => {
          
            console.log("ZIP ÊµÅÁîüÊàêÂÆåÊØï„ÄÇ");
            controller.close();
          }).on('error', (err) => {
           
            console.error("JSZip ÊµÅÈîôËØØ:", err);
            controller.error(err);
          }).resume(); 
        }
      });

    
      await readableStream.pipeTo(fileStream);

      
      await showCustomAlert('ÂØºÂá∫Â∑≤ÂºÄÂßã', 'ÊÇ®ÁöÑÂàÜÁâáÂ§á‰ªΩÂ∑≤ÂºÄÂßã‰∏ãËΩΩ„ÄÇËß£ÂéãÂêéÔºåÊÇ®ÂèØ‰ª•‰ΩøÁî®‚ÄúÂØºÂÖ•‚ÄùÂäüËÉΩÔºåÈÄâÊã©ÂÖ∂‰∏≠ÁöÑ `slice_X.json` Êñá‰ª∂ËøõË°åÂ¢ûÈáèÊÅ¢Â§ç„ÄÇ');

    } catch (error) {
      console.error("ÂàÜÁâáÂØºÂá∫ËøáÁ®ã‰∏≠Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `Âú®ÊâìÂåÖÊàñÂÜôÂÖ•Êñá‰ª∂ÊµÅÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);

    
      try {
        const writer = fileStream.getWriter();
        writer.abort(error);
      } catch (e) {}
    }
  }
 
  async function exportDataAsStream() {

    if (!window.streamSaver) {
      alert("ÊµÅÂºè‰∏ãËΩΩÂ∫ì (StreamSaver.js) Êú™Âä†ËΩΩ„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñHTMLÊñá‰ª∂ÈÖçÁΩÆ„ÄÇ");
      return;
    }

    await showCustomAlert("Ê≠£Âú®ÂáÜÂ§á...", "Âç≥Â∞ÜÂºÄÂßã‰∏ãËΩΩÊÇ®ÁöÑÂÆåÊï¥Â§á‰ªΩÊñá‰ª∂„ÄÇ‰∏ãËΩΩËøáÁ®ã‰∏≠ËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢„ÄÇ");


    const fileStream = streamSaver.createWriteStream(`EPhone-Full-Backup-Streamed-${new Date().toISOString().split('T')[0]}.json`);
    const writer = fileStream.getWriter();
    const encoder = new TextEncoder();

    try {

      await writer.write(encoder.encode('{\n"version": 3,\n"timestamp": ' + Date.now() + ',\n"data": {\n'));

      const tablesToBackup = await db.tables.map(t => t.name);

      for (let i = 0; i < tablesToBackup.length; i++) {
        const tableName = tablesToBackup[i];
        const table = db.table(tableName);


        await writer.write(encoder.encode(`"${tableName}": [\n`));

        let isFirstRecordInTable = true;

        await table.each(record => {
          if (!isFirstRecordInTable) {
            writer.write(encoder.encode(',\n'));
          }

          writer.write(encoder.encode(JSON.stringify(record)));
          isFirstRecordInTable = false;
        });


        await writer.write(encoder.encode('\n]'));
        if (i < tablesToBackup.length - 1) {

          await writer.write(encoder.encode(',\n'));
        }
      }


      await writer.write(encoder.encode('\n}\n}'));

    } catch (error) {
      console.error("ÊµÅÂºèÂØºÂá∫ËøáÁ®ã‰∏≠Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `Âú®ÂÜôÂÖ•Êñá‰ª∂ÊµÅÊó∂ÂèëÁîüÈîôËØØ: ${error.message}`);
    } finally {

      await writer.close();
    }
  }

  async function exportDataAsBlob() {
    await showCustomAlert("Ê≠£Âú®ÂáÜÂ§á...", "Ê≠£Âú®ËØªÂèñÊâÄÊúâÊï∞ÊçÆÂà∞ÂÜÖÂ≠ò‰∏≠ÔºåËØ∑Á®çÂÄô...");

    try {
      const backupData = {
        version: 3,
        timestamp: Date.now(),
        data: {}
      };

      const tablesToBackup = db.tables.map(t => t.name);

      for (const tableName of tablesToBackup) {
        const tableData = await db.table(tableName).toArray();
        backupData.data[tableName] = tableData;
        console.log(`Â∑≤ÊâìÂåÖË°®: ${tableName}, ËÆ∞ÂΩïÊï∞: ${tableData.length}`);
      }

      const blob = new Blob(
        [JSON.stringify(backupData, null, 2)], {
          type: 'application/json'
        }
      );

      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `EPhone-Full-Backup-Legacy-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);

      await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â∑≤ÊàêÂäüÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÔºÅ');

    } catch (error) {
      console.error("‰º†ÁªüÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
      await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
    }
  }

  function updateBackButtonUnreadCount() {

    const totalChatUnread = Object.values(state.chats).reduce((sum, chat) => {

      if (chat.id === state.activeChatId) {
        return sum;
      }
      return sum + (chat.unreadCount || 0);
    }, 0);


    const totalQzoneUnread = unreadPostsCount || 0;


    const totalUnread = totalChatUnread + totalQzoneUnread;


    const backBtn = document.getElementById('back-to-list-btn');
    if (!backBtn) return;



    let indicator = backBtn.querySelector('.unread-indicator');
    if (!indicator) {
      indicator = document.createElement('span');
      indicator.className = 'unread-indicator';
      backBtn.appendChild(indicator);
    }


    let qzoneIndicator = backBtn.querySelector('.unread-indicator.back-btn-indicator');
    if (qzoneIndicator) {
      qzoneIndicator.remove();
    }


    if (totalUnread > 0) {
      indicator.textContent = totalUnread > 99 ? '99+' : totalUnread;
      indicator.style.display = 'block';

      indicator.style.zIndex = '20';
      indicator.style.transform = 'scale(0.8)';
    } else {
      indicator.style.display = 'none';
    }
  }

  async function openStickerCategoryBindingModal(categoryId) {
    const category = categoryId === 'uncategorized' ?
      {
        id: 'uncategorized',
        name: 'Êú™ÂàÜÁ±ª'
      } :
      await db.stickerCategories.get(categoryId);

    if (!category) {
      console.error("Êó†Ê≥ï‰∏∫‰∏çÂ≠òÂú®ÁöÑÂàÜÁ±ªÊâìÂºÄÁªëÂÆöÊ®°ÊÄÅÊ°Ü:", categoryId);
      return;
    }

    const modal = document.getElementById('sticker-binding-modal');
    const listEl = document.getElementById('sticker-binding-chat-list');
    const header = modal.querySelector('.modal-header span');
    listEl.innerHTML = '';
    header.textContent = `Â∞ÜÂàÜÁ±ª ‚Äú${category.name}‚Äù ÁªëÂÆöÂà∞...`;

    const allChats = Object.values(state.chats).sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

    allChats.forEach(chat => {

      const isChecked = Array.isArray(chat.settings?.stickerCategoryIds) && chat.settings.stickerCategoryIds.includes(categoryId);

      const item = document.createElement('div');
      item.className = 'contact-picker-item'; // Â§çÁî®Áé∞ÊúâÊ†∑Âºè
      item.innerHTML = `
            <input type="checkbox" class="sticker-binding-checkbox" data-chat-id="${chat.id}" ${isChecked ? 'checked' : ''} style="margin-right: 15px;">
            <img src="${chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${chat.name}</span>
        `;
      listEl.appendChild(item);
    });


    document.getElementById('save-sticker-binding-btn').onclick = () => saveStickerCategoryBindings(categoryId);
    document.getElementById('cancel-sticker-binding-btn').onclick = () => modal.classList.remove('visible');

    modal.classList.add('visible');
  }


  async function saveStickerCategoryBindings(categoryId) {
    const selectedChatIds = new Set(
      Array.from(document.querySelectorAll('#sticker-binding-chat-list .sticker-binding-checkbox:checked'))
      .map(cb => cb.dataset.chatId)
    );

    const chatsToUpdate = [];
    for (const chatId in state.chats) {
      const chat = state.chats[chatId];
      if (!Array.isArray(chat.settings.stickerCategoryIds)) {
        chat.settings.stickerCategoryIds = [];
      }

     
      const wasBound = chat.settings.stickerCategoryIds.includes(categoryId);
      const shouldBeBound = selectedChatIds.has(chatId);

      if (wasBound && !shouldBeBound) {
       
        chat.settings.stickerCategoryIds = chat.settings.stickerCategoryIds.filter(id => id !== categoryId);
        chatsToUpdate.push(chat);
      } else if (!wasBound && shouldBeBound) {
       
        chat.settings.stickerCategoryIds.push(categoryId);
        chatsToUpdate.push(chat);
      }
    }

    if (chatsToUpdate.length > 0) {
      await db.chats.bulkPut(chatsToUpdate);
      await showCustomAlert("‰øùÂ≠òÊàêÂäü", "Ë°®ÊÉÖÂåÖÂàÜÁ±ªÁªëÂÆöÂ∑≤Êõ¥Êñ∞ÔºÅ");
    }

    document.getElementById('sticker-binding-modal').classList.remove('visible');
  }


  function getStickerContextForPrompt(chat) {
    if (!chat || !chat.settings.stickerCategoryIds || chat.settings.stickerCategoryIds.length === 0) {
      return '';
    }

    const categoryIds = chat.settings.stickerCategoryIds;
    let allStickers = [];
    const addedStickerNames = new Set();

    
    categoryIds.forEach(categoryId => {
      let stickersInCategory;

      if (categoryId === 'uncategorized') {
        stickersInCategory = state.userStickers.filter(s => !s.categoryId);
      } else {
        stickersInCategory = state.userStickers.filter(s => s.categoryId === categoryId);
      }

     
      stickersInCategory.forEach(sticker => {
        if (!addedStickerNames.has(sticker.name)) {
          allStickers.push(sticker);
          addedStickerNames.add(sticker.name);
        }
      });
    });

    if (allStickers.length === 0) {
      return '';
    }

    const stickerList = allStickers.map(s => `- ${s.name}`).join('\n');
    return `
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÈÄâÂ°´)
# „Äê„Äê„ÄêË°®ÊÉÖ‰ΩøÁî®ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë
1.  ‰Ω†„ÄêÂè™ËÉΩ„ÄëÂú®ÂêåÊó∂ÂèëÈÄÅ‰∫Ü„ÄêÊúâÊÑè‰πâÁöÑÊñáÊú¨ÂÜÖÂÆπ„Äë‰πãÂêéÔºåÊâçËÉΩ„ÄêÈ¢ùÂ§ñ„ÄëËøΩÂä†‰∏Ä‰∏™Ë°®ÊÉÖ„ÄÇ
2.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ÂèëÈÄÅ‰∏Ä‰∏™Ë°®ÊÉÖ‰Ωú‰∏∫ÂçïÁã¨ÁöÑÂõûÂ§ç„ÄÇ
3.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂèëÊòéÊàñÁºñÈÄ†ÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ
4.  Â¶ÇÊûú‰Ω†Âú®ÂàóË°®‰∏≠Êâæ‰∏çÂà∞„Äê100%ÂÆåÁæéÂåπÈÖç„ÄëÁöÑË°®ÊÉÖÔºåËØ∑„Äê‰∏çË¶Å„Äë‰ΩøÁî® "sticker" Êåá‰ª§ÔºåÂè™ÂèëÈÄÅÊñáÊú¨„ÄÇ
5. „Äê‰ΩøÁî®È¢ëÁéá„Äë: ‰Ω†„Äê‰∏çÂ∫îËØ•„ÄëÂú®ÊØè‰∏ÄËΩÆÂØπËØù‰∏≠ÈÉΩÂèëÈÄÅË°®ÊÉÖ„ÄÇËØ∑Âè™Âú®‰Ω†ËßâÂæó„ÄêÈùûÂ∏∏ÂøÖË¶Å„ÄëÊàñ„ÄêÊÉÖÁª™ÁâπÂà´Âº∫ÁÉà„ÄëÊó∂Êâç‰ΩøÁî®Ë°®ÊÉÖÔºå‰øùÊåÅÂØπËØùÁöÑËá™ÁÑ∂ÊÄß„ÄÇ
6.  **„ÄêÈáçÂ§çÊÉ©ÁΩö (ÊúÄÈ´òÈìÅÂæãÔºÅ)„Äë**: ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøûÁª≠Âá†ËΩÆÂõûÂ§ç‰ΩøÁî®„ÄêÂÆåÂÖ®Áõ∏Âêå„ÄëÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰Ω†‰∏ä‰∏ÄËΩÆÂõûÂ§ç‰∫Ü "meaning": "ÂÆ≥Áæû"ÔºåÈÇ£‰πà‰Ω†Ëøô‰∏ÄËΩÆ„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÊ¨°‰ΩøÁî® "meaning": "ÂÆ≥Áæû"„ÄÇ‰Ω†ÂøÖÈ°ªÈÄâÊã©‰∏Ä‰∏™‰∏çÂêåÁöÑÂê´‰πâÔºåÊàñËÄÖÂπ≤ËÑÜ‰∏çÂèëË°®ÊÉÖ„ÄÇ
- **ÂèØÁî®ÂàóË°®**:
${stickerList}
`;
  }


  function getGroupStickerContextForPrompt(chat) {
    if (!chat || !chat.isGroup) return '';

    const allCategoryIds = new Set();
    chat.members.forEach(member => {
        if (member.id === 'user') return;
        const memberChat = state.chats[member.id];
        if (memberChat && memberChat.settings.stickerCategoryIds) {
            memberChat.settings.stickerCategoryIds.forEach(id => allCategoryIds.add(id));
        }
    });

    if (allCategoryIds.size === 0) {
      return ''; 
    }

    let allStickers = [];
    const addedStickerNames = new Set();

    allCategoryIds.forEach(categoryId => {
        let stickersInCategory;
        if (categoryId === 'uncategorized') {
            stickersInCategory = state.userStickers.filter(s => !s.categoryId);
        } else {
            stickersInCategory = state.userStickers.filter(s => s.categoryId === categoryId);
        }

        stickersInCategory.forEach(sticker => {
            if (!addedStickerNames.has(sticker.name)) {
                allStickers.push(sticker);
                addedStickerNames.add(sticker.name);
            }
        });
    });

    if (allStickers.length === 0) {
        return '';
    }

    const stickerList = allStickers.map(s => `- ${s.name}`).join('\n');
    return `
# ÂèØÁî®Ë°®ÊÉÖÂåÖ (ÂÖ®Áæ§ÂÖ±‰∫´)
# „Äê„Äê„ÄêË°®ÊÉÖ‰ΩøÁî®ÈìÅÂæã (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë„Äë„Äë
1.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂè™ÂèëÈÄÅ‰∏Ä‰∏™Ë°®ÊÉÖ‰Ωú‰∏∫ÂçïÁã¨ÁöÑÂõûÂ§ç„ÄÇ
2.  „ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂèëÊòéÊàñÁºñÈÄ†ÂàóË°®‰∏≠‰∏çÂ≠òÂú®ÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ
3.  Â¶ÇÊûúÊ≤°ÊâæÂà∞ÂêàÈÄÇÁöÑÔºåËØ∑‰∏çË¶Å‰ΩøÁî® "sticker" Êåá‰ª§„ÄÇ
4.  **„ÄêËßíËâ≤ÂàÜÈÖç„Äë**: ‰Ω†ÂèØ‰ª•‰ªé‰∏ãÈù¢ÁöÑ„ÄêÂÖ±‰∫´ÂàóË°®„Äë‰∏≠ÈÄâÊã©‰ªªÊÑèË°®ÊÉÖÔºåÂπ∂Â∞ÜÂÖ∂ÂàÜÈÖçÁªô„Äê‰ªªÊÑèAIËßíËâ≤„Äë„ÄÇ
5. „Äê‰ΩøÁî®È¢ëÁéá„Äë: ËØ∑Âè™Âú®‰Ω†ËßâÂæó„ÄêÈùûÂ∏∏ÂøÖË¶Å„ÄëÊàñ„ÄêÊÉÖÁª™ÁâπÂà´Âº∫ÁÉà„ÄëÊó∂Êâç‰ΩøÁî®Ë°®ÊÉÖÔºå‰øùÊåÅÂØπËØùÁöÑËá™ÁÑ∂ÊÄß„ÄÇ
6.  **„ÄêÈáçÂ§çÊÉ©ÁΩö (ÊúÄÈ´òÈìÅÂæãÔºÅ)„Äë**: ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëËøûÁª≠Âá†ËΩÆÂõûÂ§ç‰ΩøÁî®„ÄêÂÆåÂÖ®Áõ∏Âêå„ÄëÁöÑË°®ÊÉÖÂê´‰πâ„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰Ω†‰∏ä‰∏ÄËΩÆÂõûÂ§ç‰∫Ü "meaning": "ÂÆ≥Áæû"ÔºåÈÇ£‰πà‰Ω†Ëøô‰∏ÄËΩÆ„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÊ¨°‰ΩøÁî® "meaning": "ÂÆ≥Áæû"„ÄÇ‰Ω†ÂøÖÈ°ªÈÄâÊã©‰∏Ä‰∏™‰∏çÂêåÁöÑÂê´‰πâÔºåÊàñËÄÖÂπ≤ËÑÜ‰∏çÂèëË°®ÊÉÖ„ÄÇ
- **ÂèØÁî®ÂàóË°®**:
${stickerList}
`;
}

  function estimateTokens(text) {
    if (!text) return 0;
 
    return Math.ceil(text.length / 1.5);
  }


  async function calculateCurrentContextTokens() {
    if (!state.activeChatId) return 0;
    const chat = state.chats[state.activeChatId];
    if (!chat) return 0;

    
    const maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    const linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;
    const isOfflineMode = document.getElementById('offline-mode-toggle').checked;
    const aiPersona = document.getElementById('ai-persona').value;
    const myPersona = document.getElementById('my-persona').value;

    let fullContextString = '';


    const linkedBookIds = Array.from(document.querySelectorAll('#world-book-checkboxes-container input:checked')).map(cb => cb.value.replace('book_', ''));
    if (linkedBookIds.length > 0) {
      const linkedContents = linkedBookIds.map(bookId => {
        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
        if (!worldBook || !Array.isArray(worldBook.content)) return '';
        return worldBook.content.filter(e => e.enabled !== false).map(e => e.content).join('\n');
      }).filter(Boolean).join('\n');
      fullContextString += linkedContents;
    }

 
    if (chat.longTermMemory && chat.longTermMemory.length > 0) {
      fullContextString += chat.longTermMemory.map(mem => mem.content).join('\n');
    }

 
    const linkedMemoryToggle = document.getElementById('link-memory-toggle').checked;
    if (linkedMemoryToggle) {
      const linkedChatIds = Array.from(document.querySelectorAll('#linked-chats-checkboxes-container input:checked')).map(cb => cb.value);
      for (const linkedId of linkedChatIds) {
        const linkedChat = state.chats[linkedId];
        if (linkedChat && linkedChat.history.length > 0) {
          fullContextString += linkedChat.history.slice(-linkedMemoryCount).map(msg => String(msg.content)).join('\n');
        }
      }
    }

   
    if (chat.isGroup) {
      chat.members.forEach(member => {
        fullContextString += member.persona;
      });
    } else {
      fullContextString += aiPersona;
    }
    fullContextString += myPersona;

  
    fullContextString += getStickerContextForPrompt(chat);
    if (chat.isGroup) {
      fullContextString += getGroupStickerContextForPrompt(chat);
    }

   
    if (!chat.isGroup && isOfflineMode) {
      const offlinePresetId = document.getElementById('offline-preset-select').value;
      if (offlinePresetId) {
        const preset = state.presets.find(p => p.id === offlinePresetId);
        if (preset) {
          fullContextString += preset.content.filter(e => e.enabled !== false).map(e => e.content).join('\n');
        }
      }
    }

  
    const historySlice = chat.history.slice(-maxMemory);
    fullContextString += historySlice.map(msg => {
      if (typeof msg.content === 'string') return msg.content;
      if (Array.isArray(msg.content)) return msg.content.map(p => p.text).join(' ');
      return '';
    }).join('\n');

    return estimateTokens(fullContextString);
  }


  const updateTokenCountDisplay = debounce(async () => {
    
    const tokenValueEl = document.getElementById('token-count-value');
    const msgValueEl = document.getElementById('message-count-value');
    
    if (!tokenValueEl) return;

   
    const chat = state.activeChatId ? state.chats[state.activeChatId] : null;
    if (msgValueEl) {
        if (chat && chat.history) {
           
            const visibleCount = chat.history.filter(m => !m.isHidden).length;
            msgValueEl.textContent = `${visibleCount} Êù°`;
            msgValueEl.style.color = "#000000";
        } else {
            msgValueEl.textContent = "--";
        }
    }

    
    tokenValueEl.textContent = "ËÆ°ÁÆó‰∏≠...";
    try {
      const tokenCount = await calculateCurrentContextTokens();
      tokenValueEl.textContent = `${tokenCount} Tokens`;
      tokenValueEl.style.color = "#000000"; 
      
     
      if (document.body.classList.contains('dark-mode') || document.getElementById('phone-screen').classList.contains('dark-mode')) {
           msgValueEl.style.color = "#ffffff";
           tokenValueEl.style.color = "#ffffff";
      }
      
    } catch (error) {
      console.error("Token calculation error:", error);
      tokenValueEl.textContent = "Error";
    }
  }, 300);

 
  async function openNaiGallery() {
   
    naiGalleryCache = { local: [], cloud: [] };
    naiGalleryRenderCount = { local: 0, cloud: 0 };
    isLoadingMoreNaiImages = { local: false, cloud: false };

    const allNaiImages = [];

    
    try {
      const allChats = await db.chats.toArray();
      for (const chat of allChats) {
        if (chat.history && chat.history.length > 0) {
          chat.history.forEach(msg => {
            if (msg.type === 'naiimag' && msg.imageUrl) {
              allNaiImages.push({
                sourceType: 'chat',
                imageUrl: msg.imageUrl,
                prompt: msg.prompt || msg.fullPrompt || 'NAI Image',
                chatId: chat.id,
                msgTimestamp: msg.timestamp
              });
            }
          });
        }
      }
    } catch (e) {
      console.error("Êâ´ÊèèËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:", e);
    }

    
    try {
      const allPosts = await db.qzonePosts.toArray();
      allPosts.forEach(post => {
        if (post.type === 'naiimag') {
          const urls = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);
          const prompts = Array.isArray(post.prompt) ? post.prompt : [post.prompt || 'NAI Image'];
          urls.forEach((url, index) => {
            allNaiImages.push({
              sourceType: 'qzone',
              imageUrl: url,
              prompt: prompts[index] || prompts[0],
              postId: post.id,
              imageIndex: index
            });
          });
        }
      });
    } catch (e) {
      console.error("Êâ´ÊèèÂä®ÊÄÅÂ§±Ë¥•:", e);
    }

    
    allNaiImages.sort((a, b) => (b.msgTimestamp || b.postId || 0) - (a.msgTimestamp || a.postId || 0));

  
    allNaiImages.forEach(img => {
      if (img.imageUrl.startsWith('data:image')) {
        naiGalleryCache.local.push(img);
      } else {
        naiGalleryCache.cloud.push(img);
      }
    });

    
    document.getElementById('nai-gallery-grid-local').innerHTML = '';
    document.getElementById('nai-gallery-grid-cloud').innerHTML = '';

   
    switchNaiGalleryTab('local'); 
    
    document.getElementById('nai-gallery-panel').classList.add('visible');
  }
function switchNaiGalleryTab(tabId) {
    if (isNaiGalleryManagementMode) {
        toggleNaiGalleryManagementMode(); // ÂàáÊç¢Êó∂Ëá™Âä®ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    }
    
    activeNaiGalleryTab = tabId;

   
    document.querySelectorAll('.nai-gallery-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tabId === tabId);
    });

   
    document.querySelectorAll('.nai-gallery-page').forEach(page => {
        page.classList.toggle('active', page.id === `nai-gallery-grid-${tabId}`);
    });

  
    const cache = naiGalleryCache[tabId];
    const renderCount = naiGalleryRenderCount[tabId];
    const gridEl = document.getElementById(`nai-gallery-grid-${tabId}`);

    if (renderCount === 0) { 
        gridEl.innerHTML = '';
        if (cache.length === 0) {
            const message = (tabId === 'local') ? 
                'Êú¨Âú∞ÁîªÂªäÊòØÁ©∫ÁöÑÔºåÂø´ÂéªÁîüÊàê‰∏Ä‰∫õÂõæÁâáÂêßÔºÅ' :
                'ÂõæÂ∫äÁîªÂªäÊòØÁ©∫ÁöÑÔºåËØ∑‰ªé‚ÄúÊú¨Âú∞‚Äù‰∏ä‰º†ÂõæÁâá„ÄÇ';
            gridEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">${message}</p>`;
        } else {
            loadMoreNaiGalleryImages(); // Âä†ËΩΩÁ¨¨‰∏ÄÈ°µ
        }
    }
    
    
    updateNaiGalleryActionButtons();
  }  
  function renderNaiGalleryGrid(images, gridEl) {
  
    if (images.length === 0 && naiGalleryRenderCount[activeNaiGalleryTab] === 0) {
      const message = (activeNaiGalleryTab === 'local') ? 
          'Êú¨Âú∞ÁîªÂªäÊòØÁ©∫ÁöÑÔºåÂø´ÂéªÁîüÊàê‰∏Ä‰∫õÂõæÁâáÂêßÔºÅ' :
          'ÂõæÂ∫äÁîªÂªäÊòØÁ©∫ÁöÑ„ÄÇ';
      gridEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">${message}</p>`;
      return;
    }

    const fragment = document.createDocumentFragment(); 

    images.forEach((img, i) => {
      const item = document.createElement('div');
      item.className = 'nai-gallery-item'; 
      item.title = img.prompt;

  
      const itemKey = `${img.sourceType}_${img.chatId || img.postId}_${img.msgTimestamp || img.imageIndex}`;
      item.dataset.key = itemKey;
      item.dataset.imageUrl = img.imageUrl;
      item.dataset.prompt = img.prompt;

  
      item.innerHTML = `
            <div class="nai-image-container" style="background-image: url(${img.imageUrl})">
                <div class="nai-gallery-controls">
                    <button class="nai-gallery-download-btn" title="‰∏ãËΩΩ">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                    </button>
                    <button class="nai-gallery-delete-btn" title="Âà†Èô§">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
                    </button>
                </div>
            </div>
            <span class="nai-gallery-name">${img.prompt}</span>
        `;
    
      fragment.appendChild(item); 
    });

    gridEl.appendChild(fragment); 
  }

  async function loadMoreNaiGalleryImages() {
    const activeTab = activeNaiGalleryTab;
    if (isLoadingMoreNaiImages[activeTab] || naiGalleryRenderCount[activeTab] >= naiGalleryCache[activeTab].length) {
      return; 
    }

    isLoadingMoreNaiImages[activeTab] = true;
    const gridEl = document.getElementById(`nai-gallery-grid-${activeTab}`);
    showLoader(gridEl, 'bottom'); 

   
    setTimeout(() => {
      
      if (activeNaiGalleryTab !== activeTab) {
          isLoadingMoreNaiImages[activeTab] = false;
          hideLoader(gridEl);
          return;
      }
      
      const imagesToAppend = naiGalleryCache[activeTab].slice(
          naiGalleryRenderCount[activeTab], 
          naiGalleryRenderCount[activeTab] + NAI_GALLERY_RENDER_WINDOW
      );

      hideLoader(gridEl); 

      if (imagesToAppend.length > 0) {
        renderNaiGalleryGrid(imagesToAppend, gridEl); 
        naiGalleryRenderCount[activeTab] += imagesToAppend.length;
      }

      isLoadingMoreNaiImages[activeTab] = false;
    }, 500);
  }

  function toggleNaiGalleryManagementMode() {
    isNaiGalleryManagementMode = !isNaiGalleryManagementMode;
    const grid = document.getElementById(`nai-gallery-grid-${activeNaiGalleryTab}`);
    const manageBtn = document.getElementById('manage-nai-gallery-btn');
    const actionBar = document.getElementById('nai-gallery-action-bar');
    const selectAllCheckbox = document.getElementById('select-all-nai-gallery-checkbox');

    grid.classList.toggle('management-mode', isNaiGalleryManagementMode);

    if (isNaiGalleryManagementMode) {
      manageBtn.textContent = 'ÂÆåÊàê';
      actionBar.style.display = 'flex';
      selectedNaiImages.clear();
      selectAllCheckbox.checked = false;
      updateNaiGalleryActionButtons();
      document.querySelectorAll('.nai-gallery-page').forEach(page => page.classList.add('management-mode'));
    } else {
      manageBtn.textContent = 'ÁÆ°ÁêÜ';
      actionBar.style.display = 'none';
      document.querySelectorAll('.nai-gallery-page').forEach(page => page.classList.remove('management-mode'));
      grid.querySelectorAll('.nai-gallery-item.selected').forEach(item => item.classList.remove('selected'));
    }
  }

  
  function updateNaiGalleryActionButtons() { 
    const deleteBtn = document.getElementById('delete-selected-nai-gallery-btn');
    const downloadBtn = document.getElementById('download-selected-nai-gallery-btn');
    const uploadBtn = document.getElementById('upload-selected-nai-gallery-btn');
    const exportBtn = document.getElementById('export-selected-nai-gallery-btn'); // 1. Ëé∑ÂèñÊåâÈíÆÂÖÉÁ¥†
    const count = selectedNaiImages.size;

    if (deleteBtn) deleteBtn.textContent = `Âà†Èô§ (${count})`;
    if (downloadBtn) downloadBtn.textContent = `‰∏ãËΩΩ (${count})`;

    // 2. Ê∑ªÂä†ÂØºÂá∫ÊåâÈíÆÈÄªËæë
    if (exportBtn) {
        exportBtn.textContent = `ÂØºÂá∫ (${count})`;
        // ‰ªÖÂú® 'cloud' (ÂõæÂ∫ä) Ê†áÁ≠æÈ°µÊòæÁ§∫Ôºå‰∏îÊúâÈÄâ‰∏≠È°πÊó∂ÊòæÁ§∫(ÂèØÈÄâ)ÔºåËøôÈáåÊàë‰ª¨Âè™Âà§Êñ≠ÊòØÂê¶ÊòØÂõæÂ∫äÈ°µ
        exportBtn.style.display = (activeNaiGalleryTab === 'cloud') ? 'block' : 'none';
    }

    if (uploadBtn) { 
      uploadBtn.textContent = `‰∏ä‰º† (${count})`;
      const shouldShowUpload = (activeNaiGalleryTab === 'local' && state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey);
      uploadBtn.style.display = shouldShowUpload ? 'block' : 'none';
    }
}
async function executeBatchExportNaiImages() {
    if (selectedNaiImages.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂØºÂá∫ÁöÑÂõæÁâá„ÄÇ");
      return;
    }

    let exportText = "";
    let exportedCount = 0;

   
    selectedNaiImages.forEach(key => {
       
        const item = naiGalleryCache.cloud.find(img => {
             const itemKey = `${img.sourceType}_${img.chatId || img.postId}_${img.msgTimestamp || img.imageIndex}`;
             return itemKey === key;
        });

        if (item && item.imageUrl) {
           
            exportText += `${item.imageUrl}\n`;
            exportedCount++;
        }
    });

    if (exportedCount === 0) {
      alert("Êú™ÊâæÂà∞ÊâÄÈÄâÂõæÁâáÁöÑÊï∞ÊçÆÔºàËØ∑Á°ÆËÆ§ÊÇ®Âú®‚ÄòÂõæÂ∫ä‚ÄôÂàÜÁ±ª‰∏ãÔºâ„ÄÇ");
      return;
    }

    const finalText = exportText.trim();
    const textareaId = 'batch-export-nai-textarea-' + Date.now();
    
    const alertHtml = `
        <p style="text-align:left; font-size: 14px; margin: 0 0 10px 0;">
            Â∑≤ÊèêÂèñ ${exportedCount} Êù°ÈìæÊé•Ôºö
        </p>
        <textarea id="${textareaId}" 
                  rows="10" 
                  style="width: 100%; font-size: 12px; resize: vertical; border-radius: 6px; border: 1px solid #ccc;"
                  readonly>${finalText}</textarea>
    `;

    showCustomAlert("Â§çÂà∂ÈìæÊé•", alertHtml);
  
   
    const modalConfirmBtn = document.getElementById('custom-modal-confirm');
    if (modalConfirmBtn) {
        modalConfirmBtn.textContent = '‰∏ÄÈîÆÂ§çÂà∂';
        const originalOnclick = modalConfirmBtn.onclick;

        modalConfirmBtn.onclick = async (e) => {
            try {
                await navigator.clipboard.writeText(finalText);
                modalConfirmBtn.textContent = 'Â§çÂà∂ÊàêÂäü!';
                setTimeout(() => {
                   modalConfirmBtn.textContent = 'ÂÆåÊàê';
                   modalConfirmBtn.onclick = originalOnclick; 
                }, 1500);
            } catch (err) {
                alert('Ëá™Âä®Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÈïøÊåâÊñáÊú¨Ê°ÜÊâãÂä®Â§çÂà∂„ÄÇ');
                modalConfirmBtn.textContent = 'ÂÆåÊàê';
                modalConfirmBtn.onclick = originalOnclick;
            }
        };
    }
}
  
  function handleNaiGalleryGridClick(e) {
    const item = e.target.closest('.nai-gallery-item');
    if (!item) return;

    const key = item.dataset.key;
    const imageUrl = item.dataset.imageUrl;
    const prompt = item.dataset.prompt;

 
    if (e.target.closest('.nai-gallery-download-btn')) {
      e.stopPropagation();
      downloadNaiImage(imageUrl, prompt);
      return;
    }

  
    if (e.target.closest('.nai-gallery-delete-btn')) {
      e.stopPropagation();
      executeBatchDeleteNaiImages(new Set([key])); 
      return;
    }

    
    if (isNaiGalleryManagementMode) {
      item.classList.toggle('selected');
      if (selectedNaiImages.has(key)) {
        selectedNaiImages.delete(key);
      } else {
        selectedNaiImages.add(key);
      }
      updateNaiGalleryActionButtons();
    } else {
      const modalTitle = "ÂõæÁâáËØ¶ÊÉÖ";
      const modalContentHtml = `
                <div style="text-align: center;">
                    <img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                </div>
            `;
    
      showCustomAlert(modalTitle, modalContentHtml);
    }
  }

  async function executeBatchDownloadNaiImages() {
  
    const keys = selectedNaiImages;
   

    if (keys.size === 0) {
      alert("ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ãËΩΩÁöÑÂõæÁâá„ÄÇ");
      return;
    }

  
    if (typeof JSZip === 'undefined' || !window.streamSaver) {
      await showCustomAlert("‰∏ãËΩΩÂ§±Ë¥•", "Ê†∏ÂøÉÂ∫ì (JSZip Êàñ StreamSaver) Êú™ËÉΩÊàêÂäüÂä†ËΩΩÔºåËØ∑Ê£ÄÊü•ÊÇ®ÁöÑÁΩëÁªúËøûÊé•Âπ∂Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï„ÄÇ");
      return;
    }


    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂáÜÂ§á ${keys.size} Âº†ÂõæÁâá...`);
 

    const zip = new JSZip();
    let failedDownloads = 0;
    const downloadPromises = [];

 
    const keysArray = Array.from(keys);

    keysArray.forEach((key, index) => { 
     

      const item = document.querySelector(`.nai-gallery-item[data-key="${key}"]`);
      if (!item) return;

      const imageUrl = item.dataset.imageUrl;
      const prompt = item.dataset.prompt;

      
      const baseFilename = generateFilenameForNai(prompt); // e.g., "my_prompt_timestamp.png"
    
      const filename = baseFilename.replace(/\.png$/, `_(${index + 1}).png`);
   

      const promise = (async () => {
        try {
          let blob;
          if (imageUrl.startsWith('data:')) {
            const response = await fetch(imageUrl);
            blob = await response.blob();
          } else {
            let response;
            try {
             
              response = await fetch(imageUrl, {
                mode: 'cors'
              });
              if (!response.ok) throw new Error('Áõ¥ËøûÂ§±Ë¥•');
            } catch (e) {
            
              console.warn("Áõ¥ËøûÂ§±Ë¥•, Â∞ùËØï‰ΩøÁî®CORS‰ª£ÁêÜ...", e.message);
              const settings = getNovelAISettings();
              let corsProxy = settings.cors_proxy === 'custom' ? settings.custom_proxy_url : settings.cors_proxy;
              if (!corsProxy || corsProxy === '') corsProxy = 'https://corsproxy.io/?';
              const proxiedUrl = corsProxy + encodeURIComponent(imageUrl);
              response = await fetch(proxiedUrl);
            }

            if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
            blob = await response.blob();
          }
          zip.file(filename, blob, {
            binary: true
          }); 
        } catch (e) {
          console.error(`‰∏ãËΩΩÂõæÁâáÂ§±Ë¥•: ${imageUrl}`, e);
          failedDownloads++;
        }
      })();
      downloadPromises.push(promise);
    });

   
    await Promise.all(downloadPromises);

    if (failedDownloads === keys.size) {
      await showCustomAlert("‰∏ãËΩΩÂ§±Ë¥•", "ÊâÄÊúâÂõæÁâáÈÉΩ‰∏ãËΩΩÂ§±Ë¥•‰∫Ü„ÄÇËøôÈÄöÂ∏∏ÊòØÁî±‰∫éÁΩëÁªúÈóÆÈ¢òÊàñCORSË∑®ÂüüÈôêÂà∂ÔºàËØ∑Ê£ÄÊü•APIËÆæÁΩÆ‰∏≠ÁöÑCORS‰ª£ÁêÜÊòØÂê¶ÊúâÊïàÔºâ„ÄÇ");
      return;
    }

    await showCustomAlert("ÊâìÂåÖ‰∏≠...", "ÊâÄÊúâÂõæÁâáÂ∑≤ÂáÜÂ§áÂ∞±Áª™ÔºåÊ≠£Âú®ÊµÅÂºèÂéãÁº©... ‰∏ãËΩΩÂ∞ÜËá™Âä®ÂºÄÂßã„ÄÇ");

    try {
     
      const fileStream = streamSaver.createWriteStream(`NAI_Gallery_Batch_${Date.now()}.zip`);

     
      const zipStream = zip.generateInternalStream({
        type: "blob",
        streamFiles: true 
      });

     
      const readableStream = new ReadableStream({
        start(controller) {
          zipStream.on('data', (chunk) => {
           
            controller.enqueue(chunk);
          }).on('end', () => {
           
            console.log("ZIP ÊµÅÁîüÊàêÂÆåÊØï„ÄÇ");
            controller.close();
          }).on('error', (err) => {
           
            console.error("JSZip ÊµÅÈîôËØØ:", err);
            controller.error(err);
          }).resume(); // ÂêØÂä® JSZip ÊµÅ
        }
      });

     
      await readableStream.pipeTo(fileStream);

     
      if (failedDownloads > 0) {
        showCustomAlert("ÈÉ®ÂàÜ‰∏ãËΩΩÂÆåÊàê", `ÊàêÂäüÊâìÂåÖ ${keys.size - failedDownloads} Âº†ÂõæÁâá„ÄÇÊúâ ${failedDownloads} Âº†ÂõæÁâáÂõ†ÁΩëÁªúÊàñCORSÈôêÂà∂‰∏ãËΩΩÂ§±Ë¥•„ÄÇ`);
      }

    } catch (error) {
      console.error("ÊµÅÂºè‰∏ãËΩΩZIPÂ§±Ë¥•:", error);
      await showCustomAlert("ÊµÅÂºè‰∏ãËΩΩÂ§±Ë¥•", `ÂàõÂª∫ZIPÊµÅÊó∂Âá∫Èîô: ${error.message}`);
    }
  }

  async function executeBatchDeleteNaiImages(keysToDelete = null) {
    const keys = keysToDelete || selectedNaiImages;
    if (keys.size === 0) return;

    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      `Á°ÆÂÆöË¶Å‰ªé„ÄêËÅäÂ§©ËÆ∞ÂΩïÂíåÂä®ÊÄÅ„Äë‰∏≠Ê∞∏‰πÖÂà†Èô§Ëøô ${keys.size} Âº†NAIÂõæÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`, {
        confirmButtonClass: 'btn-danger'
      }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®ÊâßË°åÂà†Èô§Êìç‰Ωú...");

    let deletedCount = 0;
    const chatsToUpdate = new Map();
    const postsToDelete = new Set();
    const postsToModify = new Map();


    const postIdsToFetch = new Set();
    for (const key of keys) {
      if (key.startsWith('qzone_')) {
        const parts = key.split('_');
        const postId = parseInt(parts[1]); // qzone ID ‰∏ç‰ºöÂåÖÂê´ '_'
        if (!isNaN(postId)) {
          postIdsToFetch.add(postId);
        }
      }
    }
    const postsCache = new Map();
    if (postIdsToFetch.size > 0) {
      const posts = await db.qzonePosts.where('id').anyOf(Array.from(postIdsToFetch)).toArray();
      posts.forEach(post => postsCache.set(post.id, post));
    }


    for (const key of keys) {

    

      const parts = key.split('_');
      if (parts.length < 3) {
        console.warn("Ë∑≥ËøáÊ†ºÂºèÈîôËØØÁöÑNAIÂõæÁâáKey:", key);
        continue;
      }

      const sourceType = parts[0];
      const identifier = parts.pop(); 
      const id = parts.slice(1).join('_'); 

      if (sourceType === 'chat') {
        const chatId = id;
        const msgTimestamp = parseInt(identifier);

        if (!chatsToUpdate.has(chatId)) {
         
          const chatData = await db.chats.get(chatId);
          if (chatData) {
            chatsToUpdate.set(chatId, chatData);
          } else {
            console.warn(`Êú™ÊâæÂà∞ chatID: ${chatId}ÔºåË∑≥Ëøá...`);
            continue;
          }
        }

        const chat = chatsToUpdate.get(chatId);
        if (chat && chat.history) {
          const originalLength = chat.history.length;
          chat.history = chat.history.filter(msg => msg.timestamp !== msgTimestamp);
          if (chat.history.length < originalLength) {
            deletedCount++;
            chatsToUpdate.set(chatId, chat); // Ê†áËÆ∞Ê≠§chatÈúÄË¶ÅË¢´Êõ¥Êñ∞
          if (state.chats[chatId]) {
                state.chats[chatId].history = chat.history;
            }
          }
        }
      } else if (sourceType === 'qzone') {
        const postId = parseInt(id);
        const imageIndex = parseInt(identifier);

        const post = postsToModify.get(postId) || postsCache.get(postId);
        if (!post) {
          console.warn(`Êú™ÊâæÂà∞ postID: ${postId}ÔºåË∑≥Ëøá...`);
          continue;
        }

        const urls = post.imageUrls || (post.imageUrl ? [post.imageUrl] : []);

        if (urls.length <= 1) {
         
          postsToDelete.add(postId);
          if (postsToModify.has(postId)) {
            postsToModify.delete(postId); 
          }
        } else {
          
          const urlToRemove = urls[imageIndex];
          post.imageUrls = post.imageUrls.filter(url => url !== urlToRemove);

          if (post.prompt && Array.isArray(post.prompt) && post.prompt[imageIndex]) {
            post.prompt.splice(imageIndex, 1);
          }
          post.imageUrl = post.imageUrls[0] || null; 
          postsToModify.set(postId, post);
        }
        deletedCount++;
      }
    }

    try {
      await db.transaction('rw', db.chats, db.qzonePosts, async () => {
        if (chatsToUpdate.size > 0) {
          await db.chats.bulkPut(Array.from(chatsToUpdate.values()));
        }
        if (postsToModify.size > 0) {
          await db.qzonePosts.bulkPut(Array.from(postsToModify.values()));
        }
        if (postsToDelete.size > 0) {
          await db.qzonePosts.bulkDelete(Array.from(postsToDelete));
        }
      });

      
      toggleNaiGalleryManagementMode();
      keys.forEach(key => { 
          naiGalleryCache.local = naiGalleryCache.local.filter(item => {
              const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
              return itemKey !== key;
          });
          naiGalleryCache.cloud = naiGalleryCache.cloud.filter(item => {
              const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
              return itemKey !== key;
          });
      });

      
      naiGalleryRenderCount[activeNaiGalleryTab] = 0;
      document.getElementById(`nai-gallery-grid-${activeNaiGalleryTab}`).innerHTML = '';
      
     
      loadMoreNaiGalleryImages();
      await showCustomAlert('Âà†Èô§ÊàêÂäü', `Â∑≤ÊàêÂäüÂà†Èô§ ${deletedCount} Âº†ÂõæÁâá„ÄÇ`);

     
      if (document.getElementById('chat-interface-screen').classList.contains('active')) {
        renderChatInterface(state.activeChatId);
      }
      if (document.getElementById('qzone-screen').classList.contains('active')) {
        renderQzonePosts();
      }

    } catch (error) {
      console.error("ÊâπÈáèÂà†Èô§NAIÂõæÁâáÊó∂Âá∫Èîô:", error);
      await showCustomAlert('Âà†Èô§Â§±Ë¥•', `Êìç‰ΩúÂ§±Ë¥•: ${error.message}`);
    }
  }


async function executeBatchUploadNaiImagesToImgBB() {
 
    if (!state.apiConfig.imgbbEnable || !state.apiConfig.imgbbApiKey) {
        await showCustomAlert("ÂäüËÉΩÊú™ÂºÄÂêØ", "ËØ∑ÂÖàÂú®‚ÄúAPIËÆæÁΩÆ‚Äù‰∏≠ÂºÄÂêØ ImgBB Ëá™Âä®ÂõæÂ∫äÂäüËÉΩÂπ∂Â°´ÂÜô API Key„ÄÇ");
        return;
    }

   
    const itemsToUpload = Array.from(selectedNaiImages)
        .map(key => document.querySelector(`.nai-gallery-item[data-key="${key}"]`))
        .filter(item => item && item.dataset.imageUrl && item.dataset.imageUrl.startsWith('data:image'));

    if (itemsToUpload.length === 0) {
        await showCustomAlert("Êó†ÈúÄ‰∏ä‰º†", "‰Ω†ÈÄâÊã©ÁöÑÂõæÁâá‰∏≠Ê≤°ÊúâÈúÄË¶Å‰∏ä‰º†ÁöÑÊú¨Âú∞ÂõæÁâáÔºàÂÆÉ‰ª¨ÂèØËÉΩÂ∑≤ÁªèÊòØÁΩëÁªúÈìæÊé•‰∫ÜÔºâ„ÄÇ");
        return;
    }

   
    const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§‰∏ä‰º†Ôºü',
        `Âç≥Â∞ÜÊää ${itemsToUpload.length} Âº†Êú¨Âú∞ÂõæÁâá‰∏ä‰º†Âà∞ ImgBBÔºåÂπ∂Ê∞∏‰πÖÊõøÊç¢ÂÖ∂Âú®Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂú∞ÂùÄ„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜÔºÅ\n\nÔºà‰∏ä‰º†ÊúüÈó¥ËØ∑ÂãøÂÖ≥Èó≠È°µÈù¢Ôºâ`,
        { confirmButtonClass: 'btn-danger', confirmText: 'Á°ÆËÆ§‰∏ä‰º†' }
    );

    if (!confirmed) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÂºÄÂßã‰∏ä‰º† ${itemsToUpload.length} Âº†ÂõæÁâá...`);

    
    let successCount = 0;
    let failCount = 0;
    const chatsToUpdate = new Map();
    const postsToUpdate = new Map();
    const keysToUpdateInCache = new Map(); 
  
    for (const item of itemsToUpload) {
        const key = item.dataset.key;
        const base64Url = item.dataset.imageUrl;

        try {
            
            const newUrl = await uploadImageToImgBB(base64Url);
            
            
            if (newUrl === base64Url) {
                throw new Error("‰∏ä‰º†ÂáΩÊï∞ËøîÂõû‰∫ÜÂéüÂßãBase64ÔºåÂèØËÉΩ‰∏ä‰º†Â§±Ë¥•ÊàñË¢´Ë∑≥Ëøá„ÄÇ");
            }
            
          
            const parts = key.split('_');
            if (parts.length < 3) throw new Error(`KeyÊ†ºÂºèÈîôËØØ: ${key}`);
            
            const sourceType = parts[0];
            const identifier = parts.pop();
            const id = parts.slice(1).join('_'); 

            
            if (sourceType === 'chat') {
                const chatId = id;
                const msgTimestamp = parseInt(identifier);
                
                let chat = chatsToUpdate.get(chatId);
                if (!chat) chat = await db.chats.get(chatId); // ‰ªéDBËé∑ÂèñÊúÄÊñ∞
                
                if (chat && chat.history) {
                    const msg = chat.history.find(m => m.timestamp === msgTimestamp);
                    if (msg && msg.imageUrl === base64Url) {
                        msg.imageUrl = newUrl;
                        chatsToUpdate.set(chatId, chat);
                        keysToUpdateInCache.set(key, newUrl);
                        successCount++;
                    } else {
                        throw new Error(`Êú™Âú®ËÅäÂ§© ${chatId} ‰∏≠ÊâæÂà∞Êó∂Èó¥Êà≥‰∏∫ ${msgTimestamp} ‰∏îÂåπÈÖçBase64ÁöÑÊ∂àÊÅØ„ÄÇ`);
                    }
                }
                
            
            } else if (sourceType === 'qzone') {
                const postId = parseInt(id);
                const imageIndex = parseInt(identifier);

                let post = postsToUpdate.get(postId);
                if (!post) post = await db.qzonePosts.get(postId);
                
                if (post && post.imageUrls && post.imageUrls[imageIndex] === base64Url) {
                    post.imageUrls[imageIndex] = newUrl;
                    
                   
                    if (imageIndex === 0) {
                        post.imageUrl = newUrl;
                    }
                    
                    postsToUpdate.set(postId, post);
                    keysToUpdateInCache.set(key, newUrl);
                    successCount++;
                } else {
                    throw new Error(`Êú™Âú®Âä®ÊÄÅ ${postId} ÁöÑÁ¨¨ ${imageIndex} Âº†Âõæ‰∏≠ÊâæÂà∞ÂåπÈÖçÁöÑBase64„ÄÇ`);
                }
            }

        } catch (error) {
            failCount++;
            console.error(`‰∏ä‰º†Â§±Ë¥• (Key: ${key}):`, error.message);
        }
    }

   
    try {
        if (chatsToUpdate.size > 0 || postsToUpdate.size > 0) {
            await db.transaction('rw', db.chats, db.qzonePosts, async () => {
                if (chatsToUpdate.size > 0) {
                    await db.chats.bulkPut(Array.from(chatsToUpdate.values()));
                }
                if (postsToUpdate.size > 0) {
                    await db.qzonePosts.bulkPut(Array.from(postsToUpdate.values()));
                }
            });
        }
    } catch (dbError) {
        console.error("ÊâπÈáèÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:", dbError);
        await showCustomAlert("Êï∞ÊçÆÂ∫ìÊõ¥Êñ∞Â§±Ë¥•", `ÂõæÁâá‰∏ä‰º†ÂÆåÊàêÔºå‰ΩÜÂú®‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÊó∂Âá∫Èîô: ${dbError.message}`);
        return;
    }

   
    keysToUpdateInCache.forEach((newUrl, key) => {
        const cacheEntry = naiGalleryCache.find(item => {
            const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
            return itemKey === key;
        });
        if (cacheEntry) {
            cacheEntry.imageUrl = newUrl;
        }
        
        const domItem = document.querySelector(`.nai-gallery-item[data-key="${key}"]`);
        if (domItem) {
            domItem.dataset.imageUrl = newUrl; 
            domItem.querySelector('.nai-image-container').style.backgroundImage = `url(${newUrl})`;
        }
    });

   const updatedLocal = [];
    const updatedCloud = [];
    
    naiGalleryCache.local.forEach(item => {
        const itemKey = `${item.sourceType}_${item.chatId || item.postId}_${item.msgTimestamp || item.imageIndex}`;
        if (keysToUpdateInCache.has(itemKey)) {
            
            item.imageUrl = keysToUpdateInCache.get(itemKey);
            updatedCloud.push(item);
        } else {
          
            updatedLocal.push(item);
        }
    });
    
   
    naiGalleryCache.cloud.push(...updatedCloud);
    naiGalleryCache.local = updatedLocal;
    
    
    naiGalleryRenderCount = { local: 0, cloud: 0 };
    let resultMessage = `ÊâπÈáè‰∏ä‰º†ÂÆåÊàêÔºÅ\n\nÊàêÂäü: ${successCount} Âº†\nÂ§±Ë¥•: ${failCount} Âº†`;
    if (failCount > 0) {
        resultMessage += "\n\nÂ§±Ë¥•ÁöÑÂõæÁâáËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞ÔºàConsoleÔºâ‰∏≠ÁöÑÈîôËØØÊó•Âøó„ÄÇ";
    }
    await showCustomAlert("Êìç‰ΩúÂÆåÊàê", resultMessage);

    
    toggleNaiGalleryManagementMode();
} 
  function generateFilenameForNai(prompt) {
  
    const title = prompt || 'NAI_Image';

  
    let cleanTitle = title
      .replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g, '_') 
      .replace(/\s+/g, '_') 
      .substring(0, 30);

    if (!cleanTitle) {
      cleanTitle = 'NAI_Image';
    }

   
    const timestamp = new Date().toISOString()
      .replace(/[-:]/g, '')
      .replace('T', '_')
      .split('.')[0]; // Ê†ºÂºèÔºö20250124_123045

    
    return `${cleanTitle}_${timestamp}.png`;
  }
 
  function openQuickReplyModal() {
    // ÊâìÂºÄÂºπÁ™óÊó∂ÔºåÊ†áËÆ∞ÈúÄË¶ÅÂà∑Êñ∞DOMÔºåÂõ†‰∏∫ÂèØËÉΩ‰∏äÊ¨°ÂÖ≥Èó≠ÂêéÊï∞ÊçÆÂèò‰∫Ü
    const tabsContainer = document.getElementById('quick-reply-tabs');
    if(tabsContainer) tabsContainer.dataset.needsRefresh = 'true';
    
    renderQuickReplyList(true); 
    document.getElementById('quick-reply-modal').classList.add('visible');
}

 
  // --- Âø´Êç∑ÂõûÂ§çÂàÜÁ±ªÂäüËÉΩÂå∫ ---

// 1. [Ê†∏ÂøÉ‰øÆÊîπ] Ê∏≤ÊüìÂø´Êç∑ÂõûÂ§çÂàóË°® (ÊîØÊåÅÂàÜÁ±ªÂíåTabs)
// [‰ºòÂåñÁâà] Ê∏≤ÊüìÂø´Êç∑ÂõûÂ§çÂàóË°® (Ëß£ÂÜ≥Èó™ÁÉÅÈóÆÈ¢ò)
async function renderQuickReplyList(rerenderTabs = true) {
    const listEl = document.getElementById('quick-reply-list');
    const tabsContainer = document.getElementById('quick-reply-tabs');
    listEl.innerHTML = '';

    // 1. Ê∏≤ÊüìÊ†áÁ≠æÊ†è (Ê†∏ÂøÉ‰ºòÂåñÔºöÂè™ÊúâÂú® rerenderTabs ‰∏∫ true Êó∂ÊâçÈáçÂª∫DOM)
    // Â¶ÇÊûúÂè™ÊòØÂàáÊç¢ÂàÜÁ±ªÔºå‰∏çÈúÄË¶ÅÈáçÂª∫DOMÔºåÂè™ÈúÄË¶ÅÊõ¥Êñ∞ active Á±ª
    if (rerenderTabs) {
        // Ê£ÄÊü•ÊòØÂê¶ÁúüÁöÑÈúÄË¶ÅÈáçÂª∫ (‰æãÂ¶ÇÔºöÂàöÊâìÂºÄÂºπÁ™óÊó∂ÔºåÊàñËÄÖÊ∑ªÂä†/Âà†Èô§ÂàÜÁ±ªÂêé)
        // Â¶ÇÊûú tabsContainer ÊòØÁ©∫ÁöÑÔºåËØ¥ÊòéÂøÖÈ°ªÈáçÂª∫
        // Â¶ÇÊûú tabsContainer Â∑≤ÊúâÂÜÖÂÆπÔºå‰∏îÊàë‰ª¨Âè™ÊòØÊÉ≥Êõ¥Êñ∞Ê†∑ÂºèÔºåÂ∞±‰∏çÊ∏ÖÁ©∫ÂÆÉ
        
        // ËøôÈáåÊàë‰ª¨Á®çÂæÆÊîπ‰∏Ä‰∏ãÁ≠ñÁï•Ôºö
        // Â¶ÇÊûúÊòØ‚ÄúÂàáÊç¢ÂàÜÁ±ª‚ÄùÊìç‰ΩúËß¶ÂèëÁöÑÈáçÁªòÔºåÊàë‰ª¨‰∏ç‰º† rerenderTabs=trueÔºåÊàñËÄÖÂú®ÂÜÖÈÉ®Âà§Êñ≠
        
        const categories = await db.quickReplyCategories.toArray();
        
        // Â¶ÇÊûúÊ†áÁ≠æÊ†èÊòØÁ©∫ÁöÑÔºåÊàñËÄÖÁ°ÆÂÆûÈúÄË¶ÅÂº∫Âà∂Âà∑Êñ∞ (ÊØîÂ¶ÇÂ¢ûÂà†‰∫ÜÂàÜÁ±ª)ÔºåÂàôÈáçÂª∫
        if (tabsContainer.children.length === 0 || tabsContainer.dataset.needsRefresh === 'true') {
            tabsContainer.innerHTML = '';
            tabsContainer.dataset.needsRefresh = 'false'; // ÈáçÁΩÆÊ†áËÆ∞

            // ËæÖÂä©ÂáΩÊï∞ÔºöÂàõÂª∫Ê†áÁ≠æ
            const createTab = (id, name) => {
                const btn = document.createElement('button');
                btn.className = 'sticker-category-tab'; // ÂàùÂßã‰∏çÂä† active
                if (activeQuickReplyCategoryId === id) btn.classList.add('active');
                
                btn.textContent = name;
                btn.dataset.categoryId = id;
                
                // ÁÇπÂáª‰∫ã‰ª∂ÔºöÂè™Êõ¥Êñ∞ active Á±ªÔºå‰∏çÈáçÂª∫ DOM
                btn.onclick = () => switchQuickReplyCategory(id);
                return btn;
            };

            tabsContainer.appendChild(createTab('all', 'ÂÖ®ÈÉ®'));
            categories.forEach(cat => {
                tabsContainer.appendChild(createTab(cat.id, cat.name));
            });
            tabsContainer.appendChild(createTab('uncategorized', 'Êú™ÂàÜÁ±ª'));
        } else {
            // Â¶ÇÊûú‰∏çÈúÄË¶ÅÈáçÂª∫Ôºå‰ªÖÊõ¥Êñ∞ active Ê†∑Âºè (Ëß£ÂÜ≥Èó™ÁÉÅÁöÑÊ†∏ÂøÉ)
            const tabs = tabsContainer.querySelectorAll('.sticker-category-tab');
            tabs.forEach(tab => {
                // Ê≥®ÊÑèÔºödataset.categoryId ÊòØÂ≠óÁ¨¶‰∏≤ÔºåactiveQuickReplyCategoryId ÂèØËÉΩÊòØÊï∞Â≠ó
                // ÊâÄ‰ª•Áî® == ÊØîËæÉÔºåÊàñËÄÖÈÉΩËΩ¨Â≠óÁ¨¶‰∏≤
                if (String(tab.dataset.categoryId) === String(activeQuickReplyCategoryId)) {
                    tab.classList.add('active');
                    // Ëá™Âä®ÊªöÂä®Âà∞ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ (ÊèêÂçá‰ΩìÈ™å)
                    tab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    tab.classList.remove('active');
                }
            });
        }
    }

    // 2. Á≠õÈÄâÊï∞ÊçÆ (‰øùÊåÅ‰∏çÂèò)
    let repliesToShow;
    if (activeQuickReplyCategoryId === 'all') {
        repliesToShow = state.quickReplies;
    } else if (activeQuickReplyCategoryId === 'uncategorized') {
        repliesToShow = state.quickReplies.filter(r => !r.categoryId);
    } else {
        repliesToShow = state.quickReplies.filter(r => r.categoryId == activeQuickReplyCategoryId);
    }

    // 3. Ê∏≤ÊüìÂàóË°®ÂÜÖÂÆπ (‰øùÊåÅ‰∏çÂèò)
    if (!repliesToShow || repliesToShow.length === 0) {
        const tipText = activeQuickReplyCategoryId === 'all' 
            ? '‰Ω†ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïÂø´Êç∑ÂõûÂ§ç„ÄÇ<br>ÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÂè∑Ê∑ªÂä†Á¨¨‰∏ÄÊù°ÂêßÔºÅ'
            : 'Ëøô‰∏™ÂàÜÁ±ª‰∏ãËøòÊ≤°ÊúâÂõûÂ§çÂì¶~';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${tipText}</p>`;
        return;
    }

    // ‰øÆÊîπ renderQuickReplyList ÂáΩÊï∞‰∏≠ÁöÑ item.innerHTML ÈÉ®ÂàÜ
    repliesToShow.forEach(reply => {
        const item = document.createElement('div');
        item.className = 'quick-reply-item';
        
        // --- Êñ∞Â¢ûÔºöÂà§Êñ≠ÊòØÂê¶ÈÄâ‰∏≠ ---
        const isSelected = selectedQuickReplies.has(reply.id);
        if (isSelected) item.classList.add('selected');

        item.innerHTML = `
            <input type="checkbox" class="quick-reply-checkbox" ${isSelected ? 'checked' : ''}>
            
            <span class="quick-reply-text" data-text="${escapeHTML(reply.text)}">${escapeHTML(reply.text)}</span>
            <div class="quick-reply-actions">
                <button class="quick-reply-edit-btn" data-id="${reply.id}" title="ÁºñËæë">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="quick-reply-delete-btn" data-id="${reply.id}" title="Âà†Èô§">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
        
        // --- ‰øÆÊîπÁÇπÂáª‰∫ã‰ª∂ ---
        item.addEventListener('click', (e) => {
            // Â¶ÇÊûúÊòØÁÆ°ÁêÜÊ®°Âºè
            if (isQuickReplyManagementMode) {
                // Â¶ÇÊûúÁÇπÁöÑÊòØÊñáÊú¨Âå∫ÂüüÊàñÊï¥Ë°åÔºåËß¶ÂèëÈÄâ‰∏≠
                if (!e.target.closest('.quick-reply-actions')) {
                     toggleQuickReplySelection(reply.id);
                     // ÊâãÂä®Êõ¥Êñ∞ checkbox ËßÜËßâ
                     const cb = item.querySelector('.quick-reply-checkbox');
                     if(cb) cb.checked = !cb.checked;
                }
            } else {
                // ÂéüÊúâÈÄªËæëÔºöÂèëÈÄÅ
                const textEl = e.target.closest('.quick-reply-text');
                const editBtn = e.target.closest('.quick-reply-edit-btn');
                const deleteBtn = e.target.closest('.quick-reply-delete-btn');

                if (textEl) {
                    selectQuickReply(textEl.dataset.text);
                } else if (editBtn) {
                    editQuickReply(reply.id);
                } else if (deleteBtn) {
                    deleteQuickReply(reply.id);
                }
            }
        });

        listEl.appendChild(item);
    });
}
// ÂàáÊç¢Âø´Êç∑ÂõûÂ§çÁÆ°ÁêÜÊ®°Âºè
function toggleQuickReplyManagementMode() {
    isQuickReplyManagementMode = !isQuickReplyManagementMode;
    const listEl = document.getElementById('quick-reply-list');
    const actionBar = document.getElementById('quick-reply-action-bar');
    const normalFooter = document.getElementById('quick-reply-normal-footer');
    const batchBtn = document.getElementById('batch-quick-reply-btn');

    if (isQuickReplyManagementMode) {
        listEl.classList.add('management-mode');
        actionBar.style.display = 'flex';
        normalFooter.style.display = 'none';
        batchBtn.textContent = "ÂÆåÊàê";
        batchBtn.style.color = "var(--accent-color)";
    } else {
        listEl.classList.remove('management-mode');
        actionBar.style.display = 'none';
        normalFooter.style.display = 'flex';
        batchBtn.textContent = "ÊâπÈáè";
        batchBtn.style.color = "";
        selectedQuickReplies.clear(); // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫
        updateQuickReplyActionBar();
        renderQuickReplyList(false); // Âà∑Êñ∞ÂéªÈô§ÈÄâ‰∏≠Ê†∑Âºè
    }
}

// ÂàáÊç¢Âçï‰∏™ÈÄâ‰∏≠
function toggleQuickReplySelection(id) {
    if (selectedQuickReplies.has(id)) {
        selectedQuickReplies.delete(id);
    } else {
        selectedQuickReplies.add(id);
    }
    updateQuickReplyActionBar();
    
    // Êõ¥Êñ∞DOMÊ†∑Âºè
    const items = document.querySelectorAll('#quick-reply-list .quick-reply-item');
    items.forEach(item => {
        // ËøôÈáåÁöÑÈÄªËæëÊØîËæÉÁÆÄÂçïÁ≤óÊö¥Ôºå‰πüÂèØ‰ª•‰ºòÂåñ‰∏∫Âè™ÊâæÂØπÂ∫îIDÁöÑÂÖÉÁ¥†
        // ‰ΩÜÁî±‰∫é render Êó∂Ê≤°ÊúâÁªô item Âä† id datasetÔºåËøôÈáåÈáçÊñ∞ render ÊúÄÁ®≥
        // ‰∏∫‰∫ÜÊÄßËÉΩÔºåÂª∫ËÆÆÁªô item Âä† data-id
    });
    // ÁÆÄÂçïËµ∑ËßÅÔºåÈáçÊñ∞Ê∏≤ÊüìÂàóË°®ÂΩìÂâçÈ°µ(‰∏çÈáçÁªòTab)
    renderQuickReplyList(false);
}

// Êõ¥Êñ∞Êìç‰ΩúÊ†èÊåâÈíÆÊñáÂ≠ó
function updateQuickReplyActionBar() {
    const count = selectedQuickReplies.size;
    document.getElementById('move-selected-quick-replies-btn').textContent = `ÁßªÂä® (${count})`;
    document.getElementById('delete-selected-quick-replies-btn').textContent = `Âà†Èô§ (${count})`;
}

// ÂÖ®ÈÄâ
function handleSelectAllQuickReplies() {
    const isChecked = document.getElementById('select-all-quick-replies-checkbox').checked;
    
    // Ëé∑ÂèñÂΩìÂâçËßÜÂõæ‰∏ãÁöÑÊâÄÊúâÂõûÂ§ç
    let currentViewReplies;
    if (activeQuickReplyCategoryId === 'all') {
        currentViewReplies = state.quickReplies;
    } else if (activeQuickReplyCategoryId === 'uncategorized') {
        currentViewReplies = state.quickReplies.filter(r => !r.categoryId);
    } else {
        currentViewReplies = state.quickReplies.filter(r => r.categoryId == activeQuickReplyCategoryId);
    }

    if (isChecked) {
        currentViewReplies.forEach(r => selectedQuickReplies.add(r.id));
    } else {
        selectedQuickReplies.clear();
    }
    
    updateQuickReplyActionBar();
    renderQuickReplyList(false);
}

// ÊâπÈáèÁßªÂä®Âø´Êç∑ÂõûÂ§ç
async function executeBatchMoveQuickReplies() {
    if (selectedQuickReplies.size === 0) return alert("ËØ∑ÂÖàÈÄâÊã©ÂõûÂ§ç„ÄÇ");

    const categories = await db.quickReplyCategories.toArray();
    const options = [
        { text: 'Êú™ÂàÜÁ±ª', value: 'uncategorized' },
        ...categories.map(c => ({ text: c.name, value: c.id }))
    ];

    const targetCategoryId = await showChoiceModal("ÁßªÂä®Âà∞ÂàÜÁ±ª", options);
    if (!targetCategoryId) return;

    const finalCategoryId = targetCategoryId === 'uncategorized' ? null : parseInt(targetCategoryId);

    await db.transaction('rw', db.quickReplies, async () => {
        for (const id of selectedQuickReplies) {
            await db.quickReplies.update(id, { categoryId: finalCategoryId });
            const r = state.quickReplies.find(item => item.id === id);
            if (r) r.categoryId = finalCategoryId;
        }
    });

    await showCustomAlert("ÊàêÂäü", `Â∑≤ÁßªÂä® ${selectedQuickReplies.size} Êù°ÂõûÂ§ç„ÄÇ`);
    toggleQuickReplyManagementMode(); // ÈÄÄÂá∫ÁÆ°ÁêÜÊ®°Âºè
    renderQuickReplyList(false);
}

// ÊâπÈáèÂà†Èô§Âø´Êç∑ÂõûÂ§ç
async function executeBatchDeleteQuickReplies() {
    if (selectedQuickReplies.size === 0) return alert("ËØ∑ÂÖàÈÄâÊã©ÂõûÂ§ç„ÄÇ");

    const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedQuickReplies.size} Êù°ÂõûÂ§çÂêóÔºü`);
    if (!confirmed) return;

    const ids = Array.from(selectedQuickReplies);
    await db.quickReplies.bulkDelete(ids);
    
    // Êõ¥Êñ∞ÂÜÖÂ≠ò
    state.quickReplies = state.quickReplies.filter(r => !selectedQuickReplies.has(r.id));
    
    await showCustomAlert("ÊàêÂäü", "Â∑≤Âà†Èô§ÈÄâ‰∏≠ÂõûÂ§ç„ÄÇ");
    toggleQuickReplyManagementMode();
    renderQuickReplyList(false);
}
// 2. ÂàáÊç¢ÂàÜÁ±ª
function switchQuickReplyCategory(categoryId) {
    activeQuickReplyCategoryId = categoryId;
    renderQuickReplyList(true); // ÈáçÊñ∞Ê∏≤ÊüìTabs‰ª•Êõ¥Êñ∞activeÁä∂ÊÄÅ
}

// 3. [‰øÆÊîπ] Ê∑ªÂä†Êñ∞ÂõûÂ§ç (Ëá™Âä®ÂΩíÂÖ•ÂΩìÂâçÂàÜÁ±ª)
async function addNewQuickReply() {
    const text = await showCustomPrompt("Ê∑ªÂä†Âø´Êç∑ÂõûÂ§ç", "ËØ∑ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑÂõûÂ§çÂÜÖÂÆπÔºö", "", "textarea");

    if (text && text.trim()) {
        // Á°ÆÂÆöÂàÜÁ±ªID
        let targetCategory = null;
        if (activeQuickReplyCategoryId !== 'all' && activeQuickReplyCategoryId !== 'uncategorized') {
            targetCategory = activeQuickReplyCategoryId;
        }

        const newReply = {
            text: text.trim(),
            categoryId: targetCategory // ‰øùÂ≠òÂàÜÁ±ªID
        };
    
        const newId = await db.quickReplies.add(newReply);
        
        // Êõ¥Êñ∞ÂÜÖÂ≠ò
        state.quickReplies.push({
            id: newId,
            ...newReply
        });

        renderQuickReplyList(false); // ‰∏çÁî®ÈáçÁªòTabs
    } else if (text !== null) {
        alert("ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
    }
}

// 4. ÊâìÂºÄÂàÜÁ±ªÁÆ°ÁêÜÂô®
async function openQuickReplyCategoryManager() {
    await renderQuickReplyCategoriesInManager();
    document.getElementById('quick-reply-category-manager-modal').classList.add('visible');
}

// 5. Ê∏≤ÊüìÂàÜÁ±ªÁÆ°ÁêÜÂàóË°®
async function renderQuickReplyCategoriesInManager() {
    const listEl = document.getElementById('existing-quick-reply-categories-list');
    const categories = await db.quickReplyCategories.toArray();
    listEl.innerHTML = '';
    
    if (categories.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁ±ª</p>';
        return;
    }
    
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'existing-group-item'; // Â§çÁî®Ê†∑Âºè
        item.innerHTML = `
            <span class="group-name">${cat.name}</span>
            <span class="delete-group-btn" data-id="${cat.id}">√ó</span>
        `;
        // ÁªëÂÆöÂà†Èô§‰∫ã‰ª∂
        item.querySelector('.delete-group-btn').onclick = () => deleteQuickReplyCategory(cat.id);
        listEl.appendChild(item);
    });
}

// 6. Ê∑ªÂä†Êñ∞ÂàÜÁ±ª
async function addNewQuickReplyCategory() {
    const input = document.getElementById('new-quick-reply-category-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('ÂàÜÁ±ªÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
        return;
    }
    const existing = await db.quickReplyCategories.where('name').equals(name).first();
    if (existing) {
        alert(`ÂàÜÁ±ª "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºÅ`);
        return;
    }
    await db.quickReplyCategories.add({ name });
    input.value = '';
    await renderQuickReplyCategoriesInManager();
    document.getElementById('quick-reply-tabs').dataset.needsRefresh = 'true';
}

// 7. Âà†Èô§ÂàÜÁ±ª
async function deleteQuickReplyCategory(categoryId) {
    const category = await db.quickReplyCategories.get(categoryId);
    if (!category) return;

    const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Âà†Èô§ÂàÜÁ±ª',
        `Âà†Èô§ÂàÜÁ±ª„Ää${category.name}„ÄãÂêéÔºåËØ•ÂàÜÁ±ª‰∏ãÁöÑÂõûÂ§çÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁ±ª‚Äù„ÄÇÁ°ÆÂÆöÂêóÔºü`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        // 1. Âà†Èô§ÂàÜÁ±ª
        await db.quickReplyCategories.delete(categoryId);
        
        // 2. Â∞ÜËØ•ÂàÜÁ±ª‰∏ãÁöÑÂõûÂ§çÁßªÂà∞Êú™ÂàÜÁ±ª (categoryId = null)
        const repliesToUpdate = state.quickReplies.filter(r => r.categoryId == categoryId);
        for (const reply of repliesToUpdate) {
            reply.categoryId = null;
            await db.quickReplies.put(reply);
        }
        
        // 3. Âà∑Êñ∞ÁïåÈù¢
        await renderQuickReplyCategoriesInManager();
        
        // Â¶ÇÊûúÂΩìÂâçÊ≠£Â•ΩÂú®Ëøô‰∏™ÂàÜÁ±ª‰∏ãÔºåÂàáÂõûÂÖ®ÈÉ®
        if (activeQuickReplyCategoryId == categoryId) {
            activeQuickReplyCategoryId = 'all';
        }
        document.getElementById('quick-reply-tabs').dataset.needsRefresh = 'true';
        await renderQuickReplyList(true);
    }
}

 
  function selectQuickReply(text) {
    const chatInput = document.getElementById('chat-input');
    chatInput.value = text;
    // document.getElementById('send-btn').click();
    document.getElementById('quick-reply-modal').classList.remove('visible');
    chatInput.focus(); 
  }

 
  


  async function editQuickReply(id) {
    const reply = await db.quickReplies.get(id);
    if (!reply) return;

    const newText = await showCustomPrompt("‰øÆÊîπÂø´Êç∑ÂõûÂ§ç", "ËØ∑‰øÆÊîπÂõûÂ§çÂÜÖÂÆπÔºö", reply.text, "textarea");

    if (newText && newText.trim()) {
      
      await db.quickReplies.update(id, {
        text: newText.trim()
      });

      
      const stateReply = state.quickReplies.find(r => r.id === id);
      if (stateReply) stateReply.text = newText.trim();

      
      renderQuickReplyList();
    } else if (newText !== null) {
      alert("ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
    }
  }


  async function deleteQuickReply(id) {
    const confirmed = await showCustomConfirm(
      'Á°ÆËÆ§Âà†Èô§',
      'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Âø´Êç∑ÂõûÂ§çÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      }
    );

    if (confirmed) {
    
      await db.quickReplies.delete(id);

    
      state.quickReplies = state.quickReplies.filter(r => r.id !== id);

    
      renderQuickReplyList();
    }
  }
async function handleCharBilibiliSearch() {
    const input = document.getElementById('char-bilibili-search-input');
    const query = input.value.trim();
    if (!query) return;

    const listEl = document.getElementById('char-bilibili-list');
    listEl.innerHTML = '<div class="spinner"></div>'; // ÊòæÁ§∫Âä†ËΩΩ‰∏≠

    // ÂÆö‰πâÂª∂Êó∂ÂáΩÊï∞
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    try {
        const maxResults = 15; // ÊÉ≥Ë¶ÅËé∑ÂèñÁöÑÊù°Êï∞
        let videos = [];

        // Ê†∏ÂøÉ‰øÆÊîπÔºö‰ΩøÁî® for Âæ™ÁéØ + await ÂÆûÁé∞‚Äú‰∏Ä‰∏™‰∏Ä‰∏™Êêú‚Äù
        for (let i = 1; i <= maxResults; i++) {
            // 1. ÂÆö‰πâÂéüÂßã API Âú∞ÂùÄÔºån Âä®ÊÄÅÂèòÂåñ
            const targetUrl = `https://api.52vmy.cn/api/query/bilibili/video?msg=${encodeURIComponent(query)}&n=${i}`;
            
            // 2. ‰ΩøÁî® CORS ‰ª£ÁêÜ
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

            let retryCount = 0;
            let success = false;
            const maxRetries = 3; // Âçï‰∏™ËØ∑Ê±ÇÊúÄÂ§ßÈáçËØïÊ¨°Êï∞

            // Ê∑ªÂä†ÈáçËØïÊú∫Âà∂ÔºåÂ§ÑÁêÜÂÅ∂ÂèëÁöÑÈôêÊµÅÊàñÁΩëÁªúÊ≥¢Âä®
            while (!success && retryCount < maxRetries) {
                try {
                    const res = await fetch(proxyUrl);
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    
                    // ÂÖ≥ÈîÆ‰øÆÊîπÔºöÂÖà‰Ωú‰∏∫ÊñáÊú¨ËØªÂèñÔºåÈò≤Ê≠¢ËøîÂõû‚ÄúËÆøÈóÆËøáÂø´‚ÄùÊó∂ JSON Ëß£ÊûêÁÇ∏Ë£Ç
                    const text = await res.text();

                    // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÈôêÊµÅ (Â§ÑÁêÜÊà™Âõæ‰∏≠ "ËÆøÈóÆËøáÂø´..." ÁöÑÊÉÖÂÜµ)
                    if (text.includes("ËÆøÈóÆËøáÂø´") || text.includes("È¢ëÁπÅ") || text.includes("Too Many Requests")) {
                        console.warn(`‚ö†Ô∏è Ëé∑ÂèñÁ¨¨ ${i} Êù°Ëß¶ÂèëÈôêÊµÅÔºåÁ≠âÂæÖÂÜ∑Âç¥...`);
                        await delay(1500 + (retryCount * 1000)); // Âä®ÊÄÅÂ¢ûÂä†Á≠âÂæÖÊó∂Èó¥
                        retryCount++;
                        continue; // ÈáçËØï
                    }

                    // Â∞ùËØïËß£Êûê JSON
                    let json;
                    try {
                        json = JSON.parse(text);
                    } catch (e) {
                        console.warn(`Á¨¨ ${i} Êù°ËøîÂõûÊ†ºÂºèÈîôËØØ:`, text.substring(0, 50));
                        retryCount++;
                        continue;
                    }

                    // Êî∂ÈõÜÊï∞ÊçÆ
                    if (json.data) {
                        if (Array.isArray(json.data)) {
                            videos.push(...json.data);
                        } else {
                            videos.push(json.data);
                        }
                    } else if (json.title) {
                        videos.push(json);
                    } else if (json.code === 200 && json.data) { 
                         if (Array.isArray(json.data)) {
                            videos.push(...json.data);
                         } else {
                            videos.push(json.data);
                         }
                    }

                    success = true; // Ê†áËÆ∞ÊàêÂäüÔºåÈÄÄÂá∫ while Âæ™ÁéØ

                } catch (err) {
                    console.warn(`Ëé∑ÂèñÁ¨¨ ${i} Êù°ËßÜÈ¢ëÁΩëÁªúÈîôËØØ:`, err);
                    retryCount++;
                    await delay(1000); // ÁΩëÁªúÈîôËØØÁ®ç‰ΩúÁ≠âÂæÖ
                }
            }

            // ÊØèÊ¨°ËØ∑Ê±ÇÂêéÂº∫Âà∂‰ºëÊÅØ‰∏Ä‰∏ãÔºåËøôÊòØÈò≤Ê≠¢ÂÜçÊ¨°Ë¢´ÈôêÊµÅÁöÑÂÖ≥ÈîÆÔºÅ
            await delay(800); 
        }

        // ÂéªÈáçÂ§ÑÁêÜ
        const uniqueVideos = [];
        const seenUrls = new Set();
        videos.forEach(v => {
            const url = v.url || v.arcurl; 
            if (url && !seenUrls.has(url)) {
                seenUrls.add(url);
                uniqueVideos.push(v);
            }
        });

        listEl.innerHTML = '';
        if (uniqueVideos.length === 0) {
            listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËßÜÈ¢ëÔºåÊàñÊé•Âè£ÊöÇÊó∂‰∏çÂèØÁî®</p>';
            return;
        }

        // Ê∏≤ÊüìÁªìÊûú
        uniqueVideos.forEach(video => {
            const item = document.createElement('div');
            item.className = 'bilibili-item';
            item.innerHTML = `
                <div class="bili-cover" style="position: relative; overflow: hidden;">
                    <img src="${video.img_url || video.pic}" referrerpolicy="no-referrer" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;">
                    <div class="bili-duration" style="position: absolute; z-index: 2;">‚ñ∂</div>
                </div>
                <div class="bili-info">
                    <div class="bili-title">${video.title}</div>
                    <div class="bili-author">UP: ${video.user || video.author}</div>
                </div>
            `;
            item.onclick = () => playCharBilibiliVideo(video);
            listEl.appendChild(item);
        });

    } catch (error) {
        console.error('Bilibili search error:', error);
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ÊêúÁ¥¢Âá∫ÈîôÔºåËØ∑Á®çÂêéÂÜçËØï</p>';
    }
}

function playCharBilibiliVideo(videoData) {
    const playerScreen = document.getElementById('char-bilibili-player-screen');
    const videoEl = document.getElementById('char-bilibili-video');
    const titleEl = document.getElementById('char-bilibili-player-title');
    const authorEl = document.getElementById('char-bilibili-player-author');
    const descEl = document.getElementById('char-bilibili-player-desc');

    videoEl.src = videoData.url;
    titleEl.textContent = videoData.title;
    authorEl.textContent = `UP‰∏ª: ${videoData.user}`;
    descEl.textContent = videoData.desc || 'ÊöÇÊó†ÁÆÄ‰ªã';

    switchToCharScreen('char-bilibili-player-screen');
    videoEl.play().catch(e => console.log("Autoplay blocked", e));
}

function closeCharBilibiliPlayer() {
    const videoEl = document.getElementById('char-bilibili-video');
    videoEl.pause();
    videoEl.src = '';
    switchToCharScreen('char-bilibili-screen');
}

window.closeCharBilibiliPlayer = function() {
    const videoEl = document.getElementById('char-bilibili-video');
    if(videoEl) {
        videoEl.pause();
        videoEl.src = '';
    }
    switchToCharScreen('char-bilibili-screen');
}
let lockScreenState = {
      passwordBuffer: '',
      isLocked: false
  };

  function initLockScreen() {
      const lockScreen = document.getElementById('lock-screen');
      
      // ÂàùÂßãÂåñÊ£ÄÊü•ÔºöÂ¶ÇÊûúÂêØÁî®‰∫ÜÈîÅÂ±èÔºåÂàôÁ´ãÂç≥ÊòæÁ§∫
      if (state.globalSettings.lockScreenEnabled) {
          // ËÆæÁΩÆÂ£ÅÁ∫∏
          if (state.globalSettings.lockScreenWallpaper) {
              lockScreen.style.backgroundImage = `url(${state.globalSettings.lockScreenWallpaper})`;
          } else {
              lockScreen.style.backgroundImage = 'linear-gradient(135deg, #1c1c1e, #3a3a3c)'; // ÈªòËÆ§Ê∑±Ëâ≤ËÉåÊôØ
          }
          
          lockScreenState.isLocked = true;
          lockScreen.classList.add('active');
          updateLockScreenClock();
          
          // ÂêØÂä®ÈîÅÂ±èÊó∂ÈíüÊõ¥Êñ∞
          setInterval(updateLockScreenClock, 1000);
      }
      
      // ÁªëÂÆöËÆæÁΩÆÁïåÈù¢ÁöÑ‰∫ã‰ª∂
      const lockToggle = document.getElementById('lock-screen-toggle');
      const lockDetail = document.getElementById('lock-screen-settings-detail');
      const passwordInput = document.getElementById('lock-screen-password-input');
      const wallpaperPreview = document.getElementById('lock-wallpaper-preview');

      // ÂõûÊòæËÆæÁΩÆ
      if (lockToggle) {
          lockToggle.checked = state.globalSettings.lockScreenEnabled || false;
          lockDetail.style.display = lockToggle.checked ? 'block' : 'none';
          
          lockToggle.addEventListener('change', (e) => {
              lockDetail.style.display = e.target.checked ? 'block' : 'none';
          });
      }
      
      if (passwordInput) {
          passwordInput.value = state.globalSettings.lockScreenPassword || '';
      }

      if (state.globalSettings.lockScreenWallpaper) {
          wallpaperPreview.style.backgroundImage = `url(${state.globalSettings.lockScreenWallpaper})`;
          wallpaperPreview.textContent = '';
      }
  }

  function updateLockScreenClock() {
      if (!lockScreenState.isLocked) return;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
      const dateString = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
      
      document.getElementById('lock-time').textContent = timeString;
      document.getElementById('lock-date').textContent = dateString;
  }

  function showPasswordInput() {
      const lockScreen = document.getElementById('lock-screen');
      const passwordArea = document.getElementById('lock-password-area');
      
      lockScreen.classList.add('input-mode');
      passwordArea.style.display = 'flex';
      lockScreenState.passwordBuffer = '';
      updateDots();
  }

  function hidePasswordInput() {
      const lockScreen = document.getElementById('lock-screen');
      const passwordArea = document.getElementById('lock-password-area');
      
      lockScreen.classList.remove('input-mode');
      passwordArea.style.display = 'none';
      lockScreenState.passwordBuffer = '';
  }

  function updateDots() {
      const dots = document.querySelectorAll('.lock-dots .dot');
      const len = lockScreenState.passwordBuffer.length;
      dots.forEach((dot, index) => {
          if (index < len) dot.classList.add('filled');
          else dot.classList.remove('filled');
      });
  }

  function handleKeypadInput(num) {
      if (lockScreenState.passwordBuffer.length < 4) {
          lockScreenState.passwordBuffer += num;
          updateDots();
          
          if (lockScreenState.passwordBuffer.length === 4) {
              setTimeout(checkLockPassword, 200);
          }
      }
  }

  function deleteKeypadInput() {
      if (lockScreenState.passwordBuffer.length > 0) {
          lockScreenState.passwordBuffer = lockScreenState.passwordBuffer.slice(0, -1);
          updateDots();
      }
  }

  function checkLockPassword() {
      const correctPassword = state.globalSettings.lockScreenPassword;
      
      if (lockScreenState.passwordBuffer === correctPassword) {
          // Ëß£ÈîÅÊàêÂäü
          const lockScreen = document.getElementById('lock-screen');
          lockScreen.classList.add('unlocking');
          lockScreenState.isLocked = false;
          
          setTimeout(() => {
              lockScreen.classList.remove('active');
              lockScreen.classList.remove('unlocking');
              hidePasswordInput(); // ÈáçÁΩÆÁä∂ÊÄÅ‰ª•Â§á‰∏ãÊ¨°ÈîÅÂÆö
          }, 500);
      } else {
          // Ëß£ÈîÅÂ§±Ë¥•
          const dots = document.querySelector('.lock-dots');
          dots.classList.add('shake-animation');
          if(navigator.vibrate) navigator.vibrate(200); // ÈúáÂä®ÂèçÈ¶à
          
          setTimeout(() => {
              dots.classList.remove('shake-animation');
              lockScreenState.passwordBuffer = '';
              updateDots();
          }, 400);
      }
  }

  const lockSwipeArea = document.getElementById('lock-swipe-area');
  const lockScreen = document.getElementById('lock-screen');

  // Â∞ÅË£ÖËß£ÈîÅËß¶ÂèëÈÄªËæë
  function handleUnlockTrigger() {
      // Â¶ÇÊûúÂ∑≤ÁªèÂú®ËæìÂÖ•ÂØÜÁ†ÅÊ®°ÂºèÔºåÂ∞±‰∏çÈáçÂ§çËß¶Âèë
      if (lockScreen.classList.contains('input-mode')) return;

      if (state.globalSettings.lockScreenPassword) {
          showPasswordInput();
      } else {
          // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÂØÜÁ†ÅÔºåÁõ¥Êé•ÊªëÂä®Ëß£ÈîÅ
          lockScreen.classList.add('unlocking');
          lockScreenState.isLocked = false;
          setTimeout(() => {
              lockScreen.classList.remove('active');
              lockScreen.classList.remove('unlocking');
          }, 500);
      }
  }

  // 1. ‰øùÁïôÁÇπÂáªÂ∫ïÈÉ®Ê®™Êù°Ëß£ÈîÅ (ÂÖºÂÆπÈº†Ê†áÁÇπÂáª)
  if (lockSwipeArea) {
      lockSwipeArea.addEventListener('click', handleUnlockTrigger);
  }

  // 2. Êñ∞Â¢ûÔºöÂÖ®Â±è‰∏äÊªëËß£ÈîÅÁõëÂê¨
  if (lockScreen) {
      let touchStartY = 0;
      let touchEndY = 0;
      
      // Ëß¶Êë∏ÂºÄÂßã
      lockScreen.addEventListener('touchstart', (e) => {
          // ËÆ∞ÂΩïËµ∑ÂßãYÂùêÊ†á
          touchStartY = e.changedTouches[0].screenY;
      }, { passive: true }); // passive: true ‰ºòÂåñÊªöÂä®ÊÄßËÉΩ

      // Ëß¶Êë∏ÁªìÊùü
      lockScreen.addEventListener('touchend', (e) => {
          // ËÆ∞ÂΩïÁªìÊùüYÂùêÊ†á
          touchEndY = e.changedTouches[0].screenY;
          
          // ËÆ°ÁÆóÊªëÂä®Ë∑ùÁ¶ª
          const swipeDistance = touchStartY - touchEndY;
          
          // ÈòàÂÄºÔºöÂêë‰∏äÊªëÂä®Ë∂ÖËøá 50px ÂàôËß¶ÂèëËß£ÈîÅ
          if (swipeDistance > 50) {
              handleUnlockTrigger();
          }
      });
  }

  document.querySelectorAll('.lock-keypad .key').forEach(key => {
      key.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = key.dataset.action;
          if (action === 'delete') {
              deleteKeypadInput();
          } else if (key.dataset.num) {
              handleKeypadInput(key.dataset.num);
          }
      });
  });

  const lockCancelBtn = document.querySelector('.lock-cancel-btn');
  if (lockCancelBtn) {
      lockCancelBtn.addEventListener('click', hidePasswordInput);
  }

  // ÈîÅÂ±èÂ£ÅÁ∫∏‰∏ä‰º†Â§ÑÁêÜ
  const lockWallpaperInput = document.getElementById('lock-wallpaper-input');
  if (lockWallpaperInput) {
      lockWallpaperInput.addEventListener('change', async (event) => {
          const file = event.target.files[0];
          if (file) {
              const base64Url = await new Promise(resolve => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.readAsDataURL(file);
              });
              
              const preview = document.getElementById('lock-wallpaper-preview');
              preview.style.backgroundImage = `url(${base64Url})`;
              preview.textContent = '';
              
              // ‰∏¥Êó∂Â≠òÂÇ®Âà∞ input ÁöÑ dataset ‰∏≠Ôºå‰ª•‰æø‰øùÂ≠òÊó∂‰ΩøÁî®
              preview.dataset.tempUrl = base64Url;
              
              // Â¶ÇÊûúÂºÄÂêØ‰∫Ü ImgBBÔºåËá™Âä®‰∏ä‰º† (ÂèØÈÄâÈÄªËæëÔºåÂ§çÁî®‰πãÂâçÁöÑ)
               if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
                  (async () => {
                      try {
                           await showCustomAlert("ËØ∑Á®çÂÄô...", "Ê≠£Âú®‰∏ä‰º†ÈîÅÂ±èÂ£ÅÁ∫∏Âà∞ ImgBB...");
                           const imageUrl = await uploadImageToImgBB(base64Url);
                           preview.dataset.tempUrl = imageUrl;
                           await showCustomAlert("ÊàêÂäü", "ÈîÅÂ±èÂ£ÅÁ∫∏Â∑≤‰∏ä‰º†ÔºÅ");
                      } catch (e) {
                          console.error(e);
                      }
                  })();
               }
          }
          event.target.value = null;
      });
  }
  
  document.getElementById('upload-lock-wallpaper-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá", "ËØ∑ËæìÂÖ•ÈîÅÂ±èÂ£ÅÁ∫∏ÁöÑURL", "", "url");
      if (url && url.trim()) {
          const preview = document.getElementById('lock-wallpaper-preview');
          preview.style.backgroundImage = `url(${url})`;
          preview.textContent = '';
          preview.dataset.tempUrl = url;
      }
  });

// --- GitHub Â§á‰ªΩÂäüËÉΩÊ®°Âùó (Âπ∂Âèë‰ºòÂåñÁâà) ---

// Ëß£ÂÜ≥‰∏≠Êñá Base64 ÁºñÁ†ÅÈóÆÈ¢òÁöÑËæÖÂä©ÂáΩÊï∞
function utf8_to_b64(str) {
    return window.btoa(unescape(encodeURIComponent(str)));
}

function b64_to_utf8(str) {
    return decodeURIComponent(escape(window.atob(str)));
}

async function uploadToGitHub(isSilent = false) {
    let loadingToast = null;
    // --- 1. Âü∫Á°ÄÈÖçÁΩÆÊ£ÄÊü• ---
    if (!state.apiConfig.githubEnable) {
        if (!isSilent) await showCustomAlert("Êú™ÂºÄÂêØ", "ËØ∑ÂÖàÂú®‚ÄúAPIËÆæÁΩÆ‚Äù -> ‚ÄúGitHub ‰∫ëÂ§á‰ªΩ‚Äù‰∏≠ÂºÄÂêØÊ≠§ÂäüËÉΩ„ÄÇ");
        return;
    }

    const username = state.apiConfig.githubUsername;
    const repo = state.apiConfig.githubRepo;
    const token = state.apiConfig.githubToken;
    const baseFilename = (state.apiConfig.githubFilename || 'ephone_backup').replace(/\.json$/i, '');

    if (!username || !repo || !token) {
        if (!isSilent) await showCustomAlert("ÈÖçÁΩÆÁº∫Â§±", "ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠‰øùÂ≠ò GitHub Áî®Êà∑Âêç„ÄÅ‰ªìÂ∫ìÂêçÂíå TokenÔºÅ");
        return;
    }

    // --- 2. Á°ÆËÆ§ÊèêÁ§∫ ---
    if (!isSilent) {
        const confirmed = await showCustomConfirm(
            'Á°ÆËÆ§‰∏ä‰º†Â§á‰ªΩ',
            `Âç≥Â∞ÜÂ§á‰ªΩÊï∞ÊçÆÂà∞ GitHub ‰ªìÂ∫ìÔºö<br><strong>${username}/${repo}</strong><br><br>ÈááÁî®<strong style="color:green">ÊµÅÂºè‰∏ä‰º†</strong> Ê®°Âºè„ÄÇ<br>ÈÄüÂ∫¶Â∞ÜÊòæËëóÊèêÂçá„ÄÇ<br>Á°ÆÂÆöË¶ÅÁ´ãÂç≥‰∏ä‰º†ÂêóÔºü`,
            { confirmText: 'ÂºÄÂßãÊûÅÈÄü‰∏ä‰º†' }
        );
        if (!confirmed) return;
        await showCustomAlert("ÂáÜÂ§á‰∏≠...", "Ê≠£Âú®ÂàùÂßãÂåñÂπ∂Âèë‰∏ä‰º†...");
    } else {
        console.log("‚è≥ [Ëá™Âä®Â§á‰ªΩ] ÂºÄÂßãÂêéÂè∞ÈùôÈªòÂ§á‰ªΩÂà∞ GitHub...");
       
        loadingToast = showToast('Ê≠£Âú®‰∫ëÁ´ØÂ§á‰ªΩ...', 'loading');
    }

    try {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
        const folderPath = `backups/${dateStr}/`; 

        // „ÄêÊ†∏ÂøÉËÆæÁΩÆ„Äë
        const RAW_SIZE_LIMIT = 15 * 1024 * 1024; 
        
        // 2. Â¢ûÂ§ßÊï∞ÊçÆÂ∫ìËØªÂèñÊâπÊ¨°ÔºöÂä†Âø´ËØªÂèñÈÄüÂ∫¶
        const DB_BATCH_SIZE = 50; 
        
        // 3. Â¢ûÂä†Âπ∂ÂèëÊï∞ÔºöÂêåÊó∂‰∏ä‰º† 6 ‰∏™ÂàÜÁâá (GitHub API ÈÄöÂ∏∏ÂÖÅËÆ∏ËæÉÈ´òÂπ∂Âèë)
        const MAX_CONCURRENT_UPLOADS = 4;

        let currentSliceIndex = 1;
        let currentSliceData = {}; 
        let currentSliceRawSize = 0; 
        
        // Âπ∂ÂèëÊéßÂà∂ÈòüÂàó
        const activeUploads = new Set();
        const errors = []; // Êî∂ÈõÜÈîôËØØ

        // --- ÂÜÖÈÉ®ÂáΩÊï∞ÔºöÊâßË°åÂçï‰∏™ÂàÜÁâá‰∏ä‰º† (Áã¨Á´ã‰ΩúÁî®Âüü) ---
        const triggerUploadTask = async (partIndex, dataSnapshot) => {
            const partFilename = `${baseFilename}_part${partIndex}.json`;
            const finalPath = `${folderPath}${partFilename}`;
            
            // ÊûÑÈÄ†ÂàÜÁâáÂØπË±°
            const fileContentObj = {
                version: 4,
                timestamp: Date.now(),
                type: 'slice',
                part: partIndex,
                data: dataSnapshot
            };

            const contentString = JSON.stringify(fileContentObj);
            const contentBase64 = utf8_to_b64(contentString);
            const uploadSizeMB = (contentBase64.length / 1024 / 1024).toFixed(2);
            
            if (!isSilent) {
                // Êõ¥Êñ∞ UI ÊòæÁ§∫ÂΩìÂâçÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°Êï∞Èáè
                const modalBody = document.getElementById('custom-modal-body');
                if (modalBody) {
                    modalBody.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div>
                    <p style="text-align:center;">
                        Ê≠£Âú®Âπ∂Âèë‰∏ä‰º†‰∏≠...<br>
                        ÂΩìÂâçÈòüÂàó: <b>${activeUploads.size + 1}</b> / ${MAX_CONCURRENT_UPLOADS}<br>
                        Ê≠£Âú®Â§ÑÁêÜÂàÜÁâá: #${partIndex} (${uploadSizeMB} MB)
                    </p>`;
                }
            } else {
                console.log(`[GitHub] ÂºÄÂßã‰∏ä‰º†ÂàÜÁâá #${partIndex}...`);
            }

            // API URL
            let apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${finalPath}`;
            if (state.apiConfig.githubProxyEnable && state.apiConfig.githubProxyUrl) {
                const relativePath = apiUrl.replace("https://api.github.com", "");
                apiUrl = state.apiConfig.githubProxyUrl.replace(/\/$/, '') + relativePath;
            }

            // --- Ê≠•È™§ A: Ëé∑Âèñ SHA ---
            let sha = null;
            try {
                const checkUrl = `${apiUrl}${apiUrl.includes('?') ? '&' : '?'}t=${Date.now()}`;
                const getRes = await fetch(checkUrl, {
                    method: 'GET',
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                }
            } catch (e) { console.warn(`ÂàÜÁâá #${partIndex} Ëé∑ÂèñSHAÂ§±Ë¥•(ÂèØËÉΩÊòØÊñ∞Êñá‰ª∂)ÔºåÁªßÁª≠‰∏ä‰º†`, e); }

            // --- Ê≠•È™§ B: ‰∏ä‰º† (Â∏¶ÈáçËØï) ---
            let retryCount = 0;
            const maxRetries = 3;
            let success = false;
            let lastError = null;

            while (!success && retryCount < maxRetries) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3ÂàÜÈíüË∂ÖÊó∂

                try {
                    const putRes = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: `Auto Backup: ${dateStr} (Part ${partIndex})`,
                            content: contentBase64,
                            sha: sha || undefined
                        }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (!putRes.ok) {
                        const err = await putRes.json();
                        throw new Error(err.message || putRes.statusText);
                    }
                    
                    success = true;
                    console.log(`‚úÖ [GitHub] ÂàÜÁâá #${partIndex} ‰∏ä‰º†ÊàêÂäü`);

                } catch (err) {
                    clearTimeout(timeoutId);
                    lastError = err;
                    retryCount++;
                    console.warn(`‚ö†Ô∏è ÂàÜÁâá #${partIndex} Á¨¨ ${retryCount} Ê¨°ÈáçËØï...`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }

            if (!success) {
                throw new Error(`ÂàÜÁâá #${partIndex} ÊúÄÁªàÂ§±Ë¥•: ${lastError.message}`);
            }
        };

        // --- 3. ÊµÅÂºèÈÅçÂéÜÊï∞ÊçÆÂ∫ì ---
        const tablesToBackup = db.tables.map(t => t.name);

        for (const tableName of tablesToBackup) {
            const totalCount = await db.table(tableName).count();
            if (totalCount === 0) continue;

            let offset = 0;
            
            while (offset < totalCount) {
                const batch = await db.table(tableName).offset(offset).limit(DB_BATCH_SIZE).toArray();
                
                for (const record of batch) {
                    const recordStr = JSON.stringify(record);
                    const recordSize = recordStr.length + tableName.length + 5; 

                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂàáÁâá
                    if (currentSliceRawSize + recordSize > RAW_SIZE_LIMIT) {
                        
                        // --- Ê†∏ÂøÉÂπ∂ÂèëÈÄªËæë ---
                        // 1. ÂàõÂª∫ÂΩìÂâçÊï∞ÊçÆÁöÑÂø´ÁÖß (Ê∑±Êã∑Ë¥ùÊàñÁõ¥Êé•ÂºïÁî®ÔºåËøôÈáåÁõ¥Êé•Áî®ÂºïÁî®Âõ†‰∏∫‰∏ãÈù¢‰ºöÈáçÁΩÆÂèòÈáè)
                        const dataSnapshot = currentSliceData; 
                        const indexSnapshot = currentSliceIndex;

                        // 2. ÂàõÂª∫ Promise ‰ªªÂä°
                        const taskPromise = triggerUploadTask(indexSnapshot, dataSnapshot).catch(err => {
                            console.error(err);
                            errors.push(err.message);
                        });

                        // 3. Âä†ÂÖ•ÈòüÂàó
                        activeUploads.add(taskPromise);
                        // ‰ªªÂä°ÂÆåÊàêÂêé‰ªéÈòüÂàóÁßªÈô§
                        taskPromise.finally(() => activeUploads.delete(taskPromise));

                        // 4. Â¶ÇÊûúÈòüÂàóÊª°‰∫ÜÔºåÁ≠âÂæÖÊúÄÊó©ÁöÑ‰∏Ä‰∏™ÂÆåÊàê (Promise.race)
                        if (activeUploads.size >= MAX_CONCURRENT_UPLOADS) {
                            await Promise.race(activeUploads);
                        }

                        // 5. Â¶ÇÊûúÊúâÈîôËØØÔºåÁ´ãÂç≥ÂÅúÊ≠¢
                        if (errors.length > 0) break;

                        // 6. ÈáçÁΩÆÂÆπÂô®
                        currentSliceData = {};
                        currentSliceRawSize = 0;
                        currentSliceIndex++;
                    }

                    if (!currentSliceData[tableName]) {
                        currentSliceData[tableName] = [];
                    }
                    currentSliceData[tableName].push(record);
                    currentSliceRawSize += recordSize;
                }
                
                if (errors.length > 0) break;
                offset += DB_BATCH_SIZE;
            }
            if (errors.length > 0) break;
        }

        // --- 4. Â§ÑÁêÜÊúÄÂêé‰∏Ä‰∏™ÂàÜÁâá ---
        if (currentSliceRawSize > 0 && errors.length === 0) {
            const taskPromise = triggerUploadTask(currentSliceIndex, currentSliceData).catch(err => {
                errors.push(err.message);
            });
            activeUploads.add(taskPromise);
        }

        // --- 5. Á≠âÂæÖÊâÄÊúâÂâ©‰Ωô‰ªªÂä°ÂÆåÊàê ---
        if (!isSilent) {
             const modalBody = document.getElementById('custom-modal-body');
             if (modalBody) modalBody.innerHTML += `<p style="color:blue">Ê≠£Âú®Á≠âÂæÖÊúÄÂêé ${activeUploads.size} ‰∏™ÂàÜÁâáÂÆåÊàê...</p>`;
        }
        
        await Promise.all(activeUploads);

        // --- 6. ÁªìÊûúÂ§ÑÁêÜ ---
        if (errors.length > 0) {
            throw new Error(`‰∏ä‰º†ËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØ:\n${errors.join('\n')}`);
        }

        if (!isSilent) {
            await showCustomAlert(
                "‚úÖ Â§á‰ªΩÊàêÂäü", 
                `ÂÖ®ÈáèÊï∞ÊçÆÂπ∂Âèë‰∏ä‰º†ÂÆåÊàêÔºÅ<br>ÂÖ±‰∏ä‰º† ${currentSliceIndex} ‰∏™ÂàÜÁâá„ÄÇ<br><strong>Ë∑ØÂæÑÔºö</strong> ${folderPath}`
            );
        } else {
            console.log(`‚úÖ [Ëá™Âä®Â§á‰ªΩ] ÊàêÂäüÔºÅ`);
            if (loadingToast) {
                loadingToast.classList.remove('visible');
                setTimeout(() => loadingToast.remove(), 400);
            }
            showToast('‰∫ëÁ´ØÂ§á‰ªΩÂ∑≤ÂÆåÊàê', 'success');
        }

    } catch (error) {
        console.error("GitHub ‰∏ä‰º†Â§±Ë¥•:", error);
        let errorMsg = error.message;
        if (error.name === 'AbortError') errorMsg = "‰∏ä‰º†Ë∂ÖÊó∂ (ÁΩëÁªúËæÉÊÖ¢Êàñ‰ª£ÁêÜ‰∏çÁ®≥ÂÆö)„ÄÇ";
        
        if (!isSilent) {
            await showCustomAlert("‚ùå Â§á‰ªΩÂ§±Ë¥•", `‰∏ä‰º†‰∏≠Êñ≠Ôºö\n${errorMsg}`);
        } else {
            // „Äê‰øÆÊîπÁÇπ 4„Äë: Â§±Ë¥•Êó∂ÊòæÁ§∫Ë≠¶ÂëäÂõæÊ†áÔºå‰ΩÜ‰∏çÊâìÊñ≠Áî®Êà∑
            if (loadingToast) {
                loadingToast.classList.remove('visible');
                setTimeout(() => loadingToast.remove(), 400);
            }
            showToast('Â§á‰ªΩÂ§±Ë¥•: ÁΩëÁªúÈîôËØØ', 'error');
        }
    }
}
async function restoreFromGitHub() {
    if (!state.apiConfig.githubEnable) {
        alert("ËØ∑ÂÖàÂºÄÂêØ GitHub ‰∫ëÂ§á‰ªΩÂäüËÉΩ„ÄÇ");
        return;
    }

    const username = state.apiConfig.githubUsername;
    const repo = state.apiConfig.githubRepo;
    const token = state.apiConfig.githubToken;

    if (!username || !repo || !token) {
        alert("ËØ∑ÂÖà‰øùÂ≠ò GitHub ÈÖçÁΩÆÔºÅ");
        return;
    }

    const modalBody = document.getElementById('custom-modal-body');
    const confirmBtn = document.getElementById('custom-modal-confirm');
    const cancelBtn = document.getElementById('custom-modal-cancel');

    const showProgress = (text) => {
        const modal = document.getElementById('custom-modal-overlay');
        document.getElementById('custom-modal-title').textContent = "GitHub ÊÅ¢Â§ç";
        modalBody.innerHTML = `<div class="spinner" style="margin: 20px auto;"></div><p style="text-align:center;">${text}</p>`;
        confirmBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        modal.classList.add('visible');
    };

    // ÈÄöÁî® Fetch
    const ghFetch = async (path) => {
        let url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
        if (state.apiConfig.githubProxyEnable && state.apiConfig.githubProxyUrl) {
             const relativePath = url.replace("https://api.github.com", "");
             url = state.apiConfig.githubProxyUrl.replace(/\/$/, '') + relativePath;
        }
        const res = await fetch(url, {
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (!res.ok) {
            if (res.status === 404) return [];
            throw new Error(`GitHub API Error: ${res.status}`);
        }
        return await res.json();
    };

    try {
        showProgress("Ê≠£Âú®ÊêúÁ¥¢Â§á‰ªΩ...");

        // 1. ÊµèËßàÂ§á‰ªΩÁõÆÂΩï
        let rootPath = "";
        const backupsDir = await ghFetch("backups");
        
        if (backupsDir.length > 0) {
            const dateFolders = backupsDir.filter(item => item.type === 'dir');
            if (dateFolders.length > 0) {
                document.getElementById('custom-modal-overlay').classList.remove('visible');
                dateFolders.sort((a, b) => b.name.localeCompare(a.name));
                const dateChoices = dateFolders.map(f => ({ text: `üìÖ ${f.name}`, value: f.path }));
                const selectedPath = await showChoiceModal('ËØ∑ÈÄâÊã©Â§á‰ªΩÊó•Êúü', dateChoices);
                if (!selectedPath) return;
                rootPath = selectedPath;
                showProgress(`Ê≠£Âú®ËØªÂèñ ${rootPath} ...`);
            }
        }

        // 2. Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
        const files = await ghFetch(rootPath);
        
        // 3. Êô∫ËÉΩÂàÜÁªÑ
        const backupSets = new Map(); 
        files.forEach(file => {
            if (!file.name.endsWith('.json')) return;
            // ÂåπÈÖç _partX.json Ê†ºÂºè
            const partMatch = file.name.match(/^(.*)_part(\d+)\.json$/);
            if (partMatch) {
                const baseName = partMatch[1]; // ÁªÑÂêç
                const partNum = parseInt(partMatch[2]);
                if (!backupSets.has(baseName)) {
                    backupSets.set(baseName, { type: 'multipart', display: baseName, parts: [] });
                }
                backupSets.get(baseName).parts.push({ num: partNum, name: file.name, path: file.path });
            } else {
                // ÊóßÁâàÂçïÊñá‰ª∂
                backupSets.set(file.name, { type: 'single', display: file.name, name: file.name, path: file.path });
            }
        });

        if (backupSets.size === 0) throw new Error("Êú™ÊâæÂà∞Â§á‰ªΩÊñá‰ª∂„ÄÇ");

        document.getElementById('custom-modal-overlay').classList.remove('visible');
        const choices = [];
        backupSets.forEach((info, key) => {
            let text = info.display;
            if (info.type === 'multipart') text += ` (${info.parts.length} ‰∏™ÂàÜÁâá)`;
            choices.push({ text: text, value: key });
        });

        const selectedKey = await showChoiceModal('ËØ∑ÈÄâÊã©Ë¶ÅÊÅ¢Â§çÁöÑÊ°£Ê°à', choices);
        if (!selectedKey) return;

        const targetSet = backupSets.get(selectedKey);
        const confirmRestore = await showCustomConfirm('ÊúÄÂêéÁ°ÆËÆ§', `Âç≥Â∞ÜÊÅ¢Â§çÊï∞ÊçÆ„ÄÇÊú¨Âú∞Êï∞ÊçÆÂ∞ÜË¢´Ë¶ÜÁõñ„ÄÇÁ°ÆÂÆöÂêóÔºü`, { confirmButtonClass: 'btn-danger', confirmText: 'ÊÅ¢Â§ç' });
        if (!confirmRestore) return;

        showProgress("Ê≠£Âú®‰∏ãËΩΩÂπ∂ÊÅ¢Â§çÊï∞ÊçÆ...");

        // 4. Ê∏ÖÁ©∫Êï∞ÊçÆÂ∫ì (‰∏ÄÊ¨°ÊÄßÊ∏ÖÁ©∫ÔºåÈÅøÂÖçÂàÜÁâáÊÅ¢Â§çÊó∂Êï∞ÊçÆÂÜ≤Á™Å)
        await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
                await table.clear();
            }
        });

        // 5. ÂÆö‰πâ‰∏ãËΩΩÂíåÂ§ÑÁêÜÂçï‰∏™Êñá‰ª∂ÁöÑÈÄªËæë
        const processFile = async (filePath) => {
             let url = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;
             if (state.apiConfig.githubProxyEnable && state.apiConfig.githubProxyUrl) {
                 const relativePath = url.replace("https://api.github.com", "");
                 url = state.apiConfig.githubProxyUrl.replace(/\/$/, '') + relativePath;
             }
             const res = await fetch(url, {
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3.raw' }
            });
            if (!res.ok) throw new Error(`‰∏ãËΩΩÂ§±Ë¥•: ${res.status}`);
            
            const text = await res.text();
            let json;
            try {
                json = JSON.parse(text);
            } catch (e) {
                // Â∞ùËØï Base64 Ëß£Á†Å (ÂÖºÂÆπÊóßÈÄªËæë)
                const decoded = decodeURIComponent(escape(window.atob(text.replace(/\s/g, ''))));
                json = JSON.parse(decoded);
            }

            // Ê†∏ÂøÉÔºöÊ†πÊçÆÊ†ºÂºèÂÜ≥ÂÆöÂ¶Ç‰ΩïÂØºÂÖ•
            const dataPart = json.data || json; // ÂÖºÂÆπ {version:.., data:{...}} Âíå Áõ¥Êé• {...}
            
            // ÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
            for (const tableName of Object.keys(dataPart)) {
                const records = dataPart[tableName];
                if (Array.isArray(records) && records.length > 0) {
                    await db.table(tableName).bulkPut(records);
                }
            }
        };

        // 6. ÊâßË°åÊÅ¢Â§ç
        if (targetSet.type === 'multipart') {
            targetSet.parts.sort((a, b) => a.num - b.num);
            for (let i = 0; i < targetSet.parts.length; i++) {
                const part = targetSet.parts[i];
                modalBody.innerHTML = `<div class="spinner"></div><p style="text-align:center;">Ê≠£Âú®Â§ÑÁêÜÂàÜÁâá ${i+1}/${targetSet.parts.length}...</p>`;
                await processFile(part.path);
                // Âº∫Âà∂ÂûÉÂúæÂõûÊî∂Âª∫ËÆÆÔºàÈÄöËøáÊñ≠ÂºÄÂºïÁî®Ôºâ
                await new Promise(r => setTimeout(r, 50)); 
            }
        } else {
            await processFile(targetSet.path);
        }

        // 7. ÊÅ¢Â§ç API ÈÖçÁΩÆ (Èò≤Ê≠¢Ë¶ÜÁõñÂêé‰∏¢Â§± Key)
        try {
            const restoredApiConfig = await db.apiConfig.get('main');
            if (restoredApiConfig) {
                 if (restoredApiConfig.imgbbApiKey) localStorage.setItem('imgbb-api-key', restoredApiConfig.imgbbApiKey);
                 if (restoredApiConfig.imgbbEnable !== undefined) localStorage.setItem('imgbb-enabled', restoredApiConfig.imgbbEnable);
                 if (restoredApiConfig.minimaxApiKey) localStorage.setItem('minimax-api-key', restoredApiConfig.minimaxApiKey);
                 if (restoredApiConfig.minimaxGroupId) localStorage.setItem('minimax-group-id', restoredApiConfig.minimaxGroupId);
                 // ÊÅ¢Â§ç GitHub ÈÖçÁΩÆÔºåÂê¶Âàô‰∏ãÊ¨°Êó†Ê≥ïÂ§á‰ªΩ
                 if (restoredApiConfig.githubToken) state.apiConfig.githubToken = restoredApiConfig.githubToken;
            }
        } catch(e) {}

        confirmBtn.style.display = ''; 
        await showCustomAlert("ÊÅ¢Â§çÊàêÂäü", "ÊâÄÊúâÂàÜÁâáÂ∑≤Â§ÑÁêÜÂÆåÊØïÔºåÊï∞ÊçÆÂ∑≤ÊÅ¢Â§çÔºÅÁÇπÂáªÁ°ÆÂÆöÂà∑Êñ∞È°µÈù¢„ÄÇ");
        setTimeout(() => window.location.reload(), 500);

    } catch (error) {
        console.error(error);
        confirmBtn.style.display = ''; 
        await showCustomAlert("ÊÅ¢Â§çÂ§±Ë¥•", error.message);
    }
}
   let backupIntervalId = null;

    // ‰øÆÊîπÂáΩÊï∞ÂÆö‰πâÔºåÊé•Êî∂ intervalMinutes ÂèÇÊï∞
    function startAutoBackupTimer(intervalMinutes) {
        if (backupIntervalId) clearInterval(backupIntervalId);
        
        // Â¶ÇÊûúÊ≤°‰º†ÂèÇÊï∞ÔºåÂ∞ùËØï‰ªé storage ËØªÂèñÔºåÊàñËÄÖÈªòËÆ§ 30
        if (!intervalMinutes) {
            const saved = localStorage.getItem('github-backup-interval');
            intervalMinutes = saved ? parseInt(saved) : 30;
        }

        console.log(`‚úÖ Ëá™Âä®Â§á‰ªΩÂÆöÊó∂Âô®Â∑≤ÂêØÂä® (ÊØè ${intervalMinutes} ÂàÜÈíü)`);

        backupIntervalId = setInterval(async () => {
            const isEnabled = localStorage.getItem('github-enabled') === 'true';
            const isAuto = localStorage.getItem('github-auto-backup') === 'true';
            
            if (isEnabled && isAuto) {
                console.log("‚è∞ Ëß¶ÂèëÂÆöÊó∂Ëá™Âä®Â§á‰ªΩ...");
                await uploadToGitHub(true); 
            }
        }, intervalMinutes * 60 * 1000); // ËΩ¨Êç¢‰∏∫ÊØ´Áßí
    }

    // ÂàùÂßãÂåñË∞ÉÁî®‰πüË¶ÅÊîπ‰∏Ä‰∏ã
    const savedGhEnabled = localStorage.getItem('github-enabled') === 'true';
    const savedGhAuto = localStorage.getItem('github-auto-backup') === 'true';
    
    if (savedGhEnabled && savedGhAuto) {
        startAutoBackupTimer(); // ËøôÈáåÂÆÉ‰ºöËá™Âä®ÂéªËØª localStorage
    }
    

    function stopAutoBackupTimer() {
        if (backupIntervalId) {
            clearInterval(backupIntervalId);
            backupIntervalId = null;
            console.log("üõë Ëá™Âä®Â§á‰ªΩÂÆöÊó∂Âô®Â∑≤ÂÅúÊ≠¢");
        }
    }

    
    
    // Â∞ÜËøô‰∏§‰∏™ÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºå‰ª•‰æø save ÊåâÈíÆË∞ÉÁî® (ËôΩÁÑ∂Âú®Èó≠ÂåÖÈáåÔºå‰ΩÜÂèØ‰ª•Áõ¥Êé•Âú®‰∏äÈù¢ÁöÑ save ÊåâÈíÆÈÄªËæëÈáåÁî®)
    window.startAutoBackupTimer = startAutoBackupTimer;
    window.stopAutoBackupTimer = stopAutoBackupTimer;
// --- Open-Meteo Â§©Ê∞îÂäüËÉΩÊ®°Âùó ---

// 1. WMO Â§©Ê∞î‰ª£Á†ÅËΩ¨ÊñáÂ≠ó
function getWeatherDescription(code) {
    const codes = {
        0: "Êô¥Êúó (Clear sky)",
        1: "Â§ßÈÉ®Êô¥Êúó (Mainly clear)", 2: "Â§ö‰∫ë (Partly cloudy)", 3: "Èò¥Â§© (Overcast)",
        45: "ÊúâÈõæ (Fog)", 48: "ÁªìÈúúÈõæ (Depositing rime fog)",
        51: "ËΩªÂæÆÊØõÊØõÈõ® (Drizzle: Light)", 53: "‰∏≠Â∫¶ÊØõÊØõÈõ® (Drizzle: Moderate)", 55: "Â§ßÊØõÊØõÈõ® (Drizzle: Dense)",
        61: "Â∞èÈõ® (Rain: Slight)", 63: "‰∏≠Èõ® (Rain: Moderate)", 65: "Â§ßÈõ® (Rain: Heavy)",
        71: "Â∞èÈõ™ (Snow fall: Slight)", 73: "‰∏≠Èõ™ (Snow fall: Moderate)", 75: "Â§ßÈõ™ (Snow fall: Heavy)",
        80: "ÈòµÈõ® (Rain showers)", 81: "‰∏≠Â∫¶ÈòµÈõ®", 82: "Êö¥Èõ®",
        95: "Èõ∑Èõ® (Thunderstorm)", 96: "Èõ∑Èõ®‰º¥ÊúâÂÜ∞Èõπ", 99: "ÈáçÂ∫¶Èõ∑Èõ®‰º¥ÊúâÂÜ∞Èõπ"
    };
    return codes[code] || "Êú™Áü•Â§©Ê∞î";
}

// 2. ÊêúÁ¥¢ÁúüÂÆûÂüéÂ∏Ç (Geocoding API)
async function searchCityGeo(cityName) {
    try {
        const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=1&language=zh&format=json`);
        const data = await response.json();
        if (data.results && data.results.length > 0) {
            return data.results[0]; // ËøîÂõû {name, latitude, longitude, country...}
        }
        return null;
    } catch (e) {
        console.error("ÂüéÂ∏ÇÊêúÁ¥¢Â§±Ë¥•:", e);
        return null;
    }
}

// 3. Ëé∑ÂèñÂ§©Ê∞îÊï∞ÊçÆ
async function fetchWeather(lat, lon) {
    if (!lat || !lon) return null;
    try {
        // Ëé∑ÂèñÂΩìÂâçÂ§©Ê∞îÔºöÊ∏©Â∫¶„ÄÅÂ§©Ê∞î‰ª£Á†Å„ÄÅÁôΩÂ§©/ÈªëÂ§ú„ÄÅÈ£éÈÄü
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,is_day,wind_speed_10m&timezone=auto`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.current) {
            const c = data.current;
            const desc = getWeatherDescription(c.weather_code);
            const dayState = c.is_day ? "ÁôΩÂ§©" : "Â§úÊôö";
            return `Ê∞îÊ∏© ${c.temperature_2m}¬∞C, ÊπøÂ∫¶ ${c.relative_humidity_2m}%, ${desc}, ${dayState}, È£éÈÄü ${c.wind_speed_10m}km/h`;
        }
        return null;
    } catch (e) {
        console.error("Ëé∑ÂèñÂ§©Ê∞îÂ§±Ë¥•:", e);
        return null;
    }
}

// 4. ÁîüÊàê Prompt Ê≥®ÂÖ•ÊñáÊú¨
async function getWeatherContextForPrompt(chat) {
    const wSettings = chat.settings.weather || {};
    if (!wSettings.enabled) return "";

    let context = "\n# „ÄêÂÆûÊó∂ÁéØÂ¢É‰∏éÂ§©Ê∞îÂêåÊ≠•„Äë\n";
    let hasData = false;

    // Ëé∑ÂèñÁî®Êà∑Â§©Ê∞î
    if (wSettings.userLat && wSettings.userLon) {
        const userWeather = await fetchWeather(wSettings.userLat, wSettings.userLon);
        if (userWeather) {
            const locationName = wSettings.userVirtualCity || "ÊâÄÂú®Âú∞";
            context += `- Áî®Êà∑(${chat.settings.myNickname || 'Êàë'})ÂΩìÂâçÂú®„Äê${locationName}„Äë: ${userWeather}„ÄÇ\n`;
            hasData = true;
        }
    }

    // Ëé∑ÂèñËßíËâ≤Â§©Ê∞î
    if (wSettings.charLat && wSettings.charLon) {
        const charWeather = await fetchWeather(wSettings.charLat, wSettings.charLon);
        if (charWeather) {
            const locationName = wSettings.charVirtualCity || "ÊâÄÂú®Âú∞";
            context += `- ‰Ω†(${chat.name})ÂΩìÂâçÂú®„Äê${locationName}„Äë: ${charWeather}„ÄÇ\n`;
            hasData = true;
        }
    }

    if (!hasData) return "";

    context += "ËØ∑Ê†πÊçÆ‰∏äËø∞Â§©Ê∞îÂíåÊó∂Èó¥Áä∂ÊÄÅÔºàÂ¶ÇÊòØÂê¶‰∏ãÈõ®„ÄÅÊòØÁôΩÂ§©ËøòÊòØÂ§úÊôöÔºâÊù•Ë∞ÉÊï¥‰Ω†ÁöÑÊèèÂÜôÊ∞õÂõ¥„ÄÅËßíËâ≤ÁöÑË°åÂä®ÔºàÂ¶ÇÊíë‰ºû„ÄÅÈÅøÊöë„ÄÅÊ∑ªË°£Ôºâ‰ª•ÂèäÂØπËØùÂÜÖÂÆπ„ÄÇ";
    return context;
}
let userBalance = 0;
const BLACK_GOLD_THRESHOLD = 10000; // ÈªëÈáë‰ºöÂëòÈòàÂÄºÔºö1‰∏á

async function initUserWallet() {
    try {
        let wallet = await db.userWallet.get('main');

        // Â¶ÇÊûúÊ≤°ÊúâÈí±ÂåÖÔºåÊàñËÄÖ‰ΩôÈ¢ùÂèòÊàê‰∫Ü NaN/null/undefinedÔºåÂº∫Âà∂‰øÆÂ§ç
        if (!wallet || typeof wallet.balance !== 'number' || isNaN(wallet.balance)) {
            console.warn("Ê£ÄÊµãÂà∞Èí±ÂåÖÊï∞ÊçÆÂºÇÂ∏∏ (NaN Êàñ ‰∏çÂ≠òÂú®)ÔºåÊ≠£Âú®ÈáçÁΩÆ...");
            
            // Â∞ùËØï‰øùÁïôÊóßÁöÑ‰∫≤Â±ûÂç°Êï∞ÊçÆÔºåÂè™ÈáçÁΩÆ‰ΩôÈ¢ù
            const oldKinship = (wallet && wallet.kinshipCards) ? wallet.kinshipCards : [];
            
            wallet = { 
                id: 'main', 
                balance: 0, // Âº∫Âà∂ÈáçÁΩÆ‰∏∫ 0
                kinshipCards: oldKinship, 
                lastResetMonth: '' 
            };
            
            await db.userWallet.put(wallet);
            userBalance = 0;
        } else {
            // Êï∞ÊçÆÊ≠£Â∏∏ÔºåËØªÂèñ‰ΩôÈ¢ù
            userBalance = wallet.balance;
            
            // Ë°•ÂÖ®ÂèØËÉΩÁº∫Â§±ÁöÑÂ≠óÊÆµ
            if (!wallet.kinshipCards) {
                wallet.kinshipCards = [];
                await db.userWallet.put(wallet);
            }
        }

        // ÊØèÊúàËá™Âä®ÈáçÁΩÆ‰∫≤Â±ûÂç°È¢ùÂ∫¶ÈÄªËæë (‰øùÊåÅ‰∏çÂèò)
        const now = new Date();
        const currentMonthKey = `${now.getFullYear()}-${now.getMonth() + 1}`;
        if (wallet.lastResetMonth !== currentMonthKey) {
            if (wallet.kinshipCards && wallet.kinshipCards.length > 0) {
                wallet.kinshipCards.forEach(card => { card.spent = 0; });
                await db.userWallet.put(wallet);
            }
            wallet.lastResetMonth = currentMonthKey;
            await db.userWallet.put(wallet);
        }

        console.log("Áî®Êà∑Èí±ÂåÖÂàùÂßãÂåñÂÆåÊàêÔºåÂΩìÂâç‰ΩôÈ¢ù:", userBalance);
        
        // Á´ãÂç≥Êõ¥Êñ∞ÁïåÈù¢‰∏äÁöÑÊòæÁ§∫ÔºàÂ¶ÇÊûúÊ≠£Âú®ÊòæÁ§∫ÁöÑËØùÔºâ
        const displayEl = document.getElementById('alipay-balance-display');
        if(displayEl) displayEl.textContent = userBalance.toFixed(2);

    } catch (e) {
        console.error("ÂàùÂßãÂåñÈí±ÂåÖÂ§±Ë¥•:", e);
        userBalance = 0;
    }
}


// --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂Êï∞Â≠óËøêÁÆóÔºåÈò≤Ê≠¢Â≠óÁ¨¶‰∏≤ÊãºÊé•ÊàñNaN ---
async function processTransaction(amount, type, description) {
    // 1. Âº∫Âà∂ËΩ¨‰∏∫Êï∞Â≠óÔºåÈò≤Ê≠¢ "100" + 50 ÂèòÊàê "10050"
    let safeAmount = parseFloat(amount);
    if (isNaN(safeAmount) || safeAmount <= 0) {
        console.error("ËÆ∞Ë¥¶Â§±Ë¥•ÔºöÈáëÈ¢ùÊó†Êïà", amount);
        return false; 
    }

    try {
        // 2. Ëé∑ÂèñÈí±ÂåÖÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÂàùÂßãÂåñ
        let wallet = await db.userWallet.get('main');
        if (!wallet) {
            wallet = { id: 'main', balance: 0, kinshipCards: [] };
        }
        
        // Á°Æ‰øù‰ΩôÈ¢ùÊòØÊï∞Â≠ó
        if (typeof wallet.balance !== 'number') wallet.balance = 0;

        // 3. ÊâßË°åÂä†Âáè
        if (type === 'expense') {
            if (wallet.balance < safeAmount) {
                await showCustomAlert("ÊîØ‰ªòÂ§±Ë¥•", `‰ΩôÈ¢ù‰∏çË∂≥ÔºÅÂΩìÂâç: ${wallet.balance.toFixed(2)}`);
                return false;
            }
            wallet.balance -= safeAmount;
        } else if (type === 'income') {
            wallet.balance += safeAmount;
        }

        // 4. ‰øùÂ≠òÈí±ÂåÖ
        await db.userWallet.put(wallet);
        
        // ÂêåÊ≠•ÂÖ®Â±ÄÂèòÈáè
        window.userBalance = wallet.balance;

        // 5. ÂÜôÂÖ•Ë¥¶ÂçïÊµÅÊ∞¥ (UserTransactions)
        const transaction = {
            timestamp: Date.now(),
            type: type,
            amount: safeAmount,
            description: description || 'Êú™Áü•‰∫§Êòì'
        };
        await db.userTransactions.add(transaction);

        console.log(`‚úÖ [Èí±ÂåÖ] ‰∫§ÊòìÊàêÂäü: ${type} ¬•${safeAmount.toFixed(2)}. Êñ∞‰ΩôÈ¢ù: ${wallet.balance.toFixed(2)}`);
        return true;

    } catch (e) {
        console.error("ÂÜôÂÖ•Èí±ÂåÖÊï∞ÊçÆÂ∫ìÂ§±Ë¥•:", e);
        alert("Á≥ªÁªüÈîôËØØÔºöË¥¶ÂçïÂÜôÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊéßÂà∂Âè∞„ÄÇ");
        return false;
    }
}

async function openAlipayScreen() {
    // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊØèÊ¨°ÊâìÂºÄÊó∂ÔºåÂº∫Âà∂‰ªéÊï∞ÊçÆÂ∫ìÈáçÊñ∞ËØªÂèñÊúÄÊñ∞‰ΩôÈ¢ù
    // ËøôÊ†∑ËÉΩ‰øùËØÅÊòæÁ§∫ÁöÑ‰∏çÊòØ NaN
    await initUserWallet(); 
    
    // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫
    const balanceEl = document.getElementById('alipay-balance-display');
    if(balanceEl) {
        // ÂèåÈáç‰øùÈô©ÔºåÂ¶ÇÊûúÊòØ NaN Â∞±ÊòæÁ§∫ 0.00
        const safeBalance = isNaN(userBalance) ? 0 : userBalance;
        balanceEl.textContent = safeBalance.toFixed(2);
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÈªëÈáë‰∏ªÈ¢ò
    const alipayScreen = document.getElementById('alipay-screen');
    const statusTag = document.getElementById('alipay-status-tag');
    
    if (userBalance >= BLACK_GOLD_THRESHOLD) {
        alipayScreen.classList.add('theme-blackgold');
        if(statusTag) statusTag.textContent = 'ÈªëÈáë‰ºöÂëò';
    } else {
        alipayScreen.classList.remove('theme-blackgold');
        if(statusTag) statusTag.textContent = 'Ê†áÂáÜ‰ºöÂëò';
    }
    
    // Ê∏≤Êüì‰∫≤Â±ûÂç°Âå∫Âüü (ÈÄªËæë‰øùÊåÅ‰∏çÂèò)
    const oldWrapper = document.getElementById('alipay-kinship-section-wrapper');
    if (oldWrapper) oldWrapper.remove();
    const container = document.querySelector('.alipay-card-container');
    const wallet = await db.userWallet.get('main');
    const kinshipCards = wallet?.kinshipCards || [];

    const kinshipWrapper = document.createElement('div');
    kinshipWrapper.id = 'alipay-kinship-section-wrapper'; 
    kinshipWrapper.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding: 0 5px;">
            <span class="kinship-section-title">‰∫≤Â±ûÂç° / ‰∫≤ÂØÜ‰ªò</span>
            <span id="add-kinship-btn" style="font-size:22px; color:#1677ff; cursor:pointer; line-height:1;">+</span>
        </div>
    `;
    const scrollContainer = document.createElement('div');
    scrollContainer.id = 'alipay-kinship-section';

    if (kinshipCards.length === 0) {
        scrollContainer.innerHTML = `
            <div class="kinship-empty-state" style="background:white; width:100%; border-radius:12px; padding:20px; text-align:center; color:#999; box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                <p style="margin:0; font-size:13px;">ÊöÇÊó†‰∫≤Â±ûÂç°ÔºåÂø´ÂéªÈÇÄËØ∑TAÂêß</p>
            </div>`;
    } else {
        kinshipCards.forEach(card => {
            const chat = state.chats[card.chatId];
            const providerName = chat ? chat.name : 'Êú™Áü•ËßíËâ≤';
            const providerAvatar = chat ? (chat.settings.aiAvatar || defaultAvatar) : defaultAvatar;
            const remaining = card.limit - (card.spent || 0);
            
            const cardEl = document.createElement('div');
            cardEl.className = 'kinship-card-entry';
            cardEl.innerHTML = `
                <button class="alipay-unbind-btn" data-chat-id="${card.chatId}">Ëß£Áªë</button>
                <div class="kinship-top">
                    <div class="kinship-provider">
                        <img src="${providerAvatar}">
                        <span>${providerName} (Ëµ†)</span>
                    </div>
                    <span style="font-size:11px; opacity:0.8;">Ê∂àË¥πÂØπÊñπÂèØËßÅ</span>
                </div>
                <div class="kinship-label">Êú¨ÊúàÂâ©‰ΩôÈ¢ùÂ∫¶</div>
                <div class="kinship-limit">¬• ${remaining.toFixed(2)}</div>
            `;
            scrollContainer.appendChild(cardEl);
        });
    }

    kinshipWrapper.appendChild(scrollContainer);
    container.appendChild(kinshipWrapper);

    const addBtn = kinshipWrapper.querySelector('#add-kinship-btn');
    if(addBtn) addBtn.onclick = openKinshipSelector;
    
    // Ê∏≤ÊüìË¥¶ÂçïÂàóË°®
    if (typeof initBillListUI === 'function') {
        await initBillListUI(); 
    }
    
    showScreen('alipay-screen');
}
async function renderTransactionList() {
    // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Âú®ÊîØ‰ªòÂÆùÈ°µÈù¢ÔºåÂ¶ÇÊûúÂú®ÔºåÂàôÂà∑Êñ∞ÂàóË°®
    const alipayScreen = document.getElementById('alipay-screen');
    if (alipayScreen && alipayScreen.classList.contains('active')) {
        await loadBills(true);
    }
}
// --- Êñ∞ÁâàÊîØ‰ªòÂÆùË¥¶ÂçïÈÄªËæë ---

// ÂàùÂßãÂåñ/ÈáçÁΩÆË¥¶ÂçïÂàóË°® UI
async function initBillListUI() {
    const container = document.getElementById('alipay-transaction-list'); // Ê≥®ÊÑèÔºöËøôÊòØÂéüÊù•ÁöÑÂÆπÂô®ID
    
    // ÈáçÁΩÆÂÆπÂô®Ê†∑Âºè‰ª•ÈÄÇÂ∫îÊñ∞Â∏ÉÂ±Ä
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.height = '100%';
    container.style.overflow = 'hidden';
    container.innerHTML = '';

    // 1. Ê∏≤ÊüìÁ≠õÈÄâÂ§¥ÈÉ®
    const header = document.createElement('div');
    header.className = 'bill-filter-header';
    
    // Ëé∑ÂèñÂΩìÂâçÊúà‰ªΩ‰Ωú‰∏∫ÈªòËÆ§ÂÄº (ÊàñËÄÖÁïôÁ©∫ÊòæÁ§∫ÂÖ®ÈÉ®)
    // billState.filterDate = new Date().toISOString().slice(0, 7); 

    header.innerHTML = `
        <div class="bill-date-picker-wrapper">
            <input type="month" id="bill-date-input" class="bill-date-input" value="${billState.filterDate}">
        </div>
        <div class="bill-type-tabs">
            <span class="bill-type-tab active" data-type="all">ÂÖ®ÈÉ®</span>
            <span class="bill-type-tab" data-type="expense">ÊîØÂá∫</span>
            <span class="bill-type-tab" data-type="income">Êî∂ÂÖ•</span>
        </div>
    `;
    container.appendChild(header);

    // 2. Ê∏≤ÊüìÊªöÂä®ÂàóË°®ÂÆπÂô®
    const scrollList = document.createElement('div');
    scrollList.id = 'bill-scroll-list';
    container.appendChild(scrollList);

    // 3. Ê∏≤ÊüìÂ∫ïÈÉ®Âä†ËΩΩÊèêÁ§∫
    const loader = document.createElement('div');
    loader.id = 'bill-loader';
    loader.className = 'bill-loading-more hidden';
    loader.textContent = 'Ê≠£Âú®Âä†ËΩΩÊõ¥Â§ö...';
    scrollList.appendChild(loader);

    // 4. ÁªëÂÆö‰∫ã‰ª∂
    bindBillEvents();

    // 5. ÂàùÂßãÂä†ËΩΩÊï∞ÊçÆ
    await loadBills(true);
}

// ÁªëÂÆöÁ≠õÈÄâÂíåÊªöÂä®‰∫ã‰ª∂
function bindBillEvents() {
    // Êó•ÊúüÁ≠õÈÄâ
    const dateInput = document.getElementById('bill-date-input');
    dateInput.addEventListener('change', (e) => {
        billState.filterDate = e.target.value;
        loadBills(true); // ÈáçÁΩÆÂπ∂ÈáçÊñ∞Âä†ËΩΩ
    });

    // Á±ªÂûãÁ≠õÈÄâ
    const tabs = document.querySelectorAll('.bill-type-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
            // UI ÂàáÊç¢
            tabs.forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            
            // ÈÄªËæëÂàáÊç¢
            billState.filterType = e.target.dataset.type;
            loadBills(true);
        });
    });

    // ÊªöÂä®Âä†ËΩΩ (Infinite Scroll)
    const scrollList = document.getElementById('bill-scroll-list');
    scrollList.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = scrollList;
        // Ë∑ùÁ¶ªÂ∫ïÈÉ® 50px Êó∂Ëß¶ÂèëÂä†ËΩΩ
        if (scrollHeight - scrollTop <= clientHeight + 50) {
            if (billState.hasMore && !billState.isLoading) {
                loadBills(false);
            }
        }
    });
}

// Ê†∏ÂøÉÔºöÂä†ËΩΩË¥¶ÂçïÊï∞ÊçÆ
async function loadBills(isReset = false) {
    if (billState.isLoading) return;
    
    const scrollList = document.getElementById('bill-scroll-list');
    const loader = document.getElementById('bill-loader');
    
    billState.isLoading = true;
    loader.classList.remove('hidden');

    if (isReset) {
        billState.page = 0;
        billState.hasMore = true;
        // Ê∏ÖÁ©∫ÂàóË°®Ôºà‰øùÁïôloaderÔºâ
        const items = scrollList.querySelectorAll('.bill-item, .bill-month-separator, .bill-empty-msg');
        items.forEach(el => el.remove());
        scrollList.scrollTop = 0;
    }

    try {
        // --- ÊûÑÂª∫ Dexie Êü•ËØ¢ ---
        let collection = db.userTransactions.orderBy('timestamp').reverse();

        // 1. ÂÜÖÂ≠òËøáÊª§ (Âõ†‰∏∫ IndexedDB Â§çÊùÇÊü•ËØ¢ÊØîËæÉÈ∫ªÁÉ¶ÔºåÂèñÂá∫Êù•ÂÜçÁ≠õÊÄßËÉΩÈÄöÂ∏∏Ë∂≥Â§ü)
        // Â¶ÇÊûúÊï∞ÊçÆÈáèÊûÅÂ§ßÔºåÂª∫ËÆÆÂÖàÁî® compound indexÔºå‰ΩÜËøôÈáåÊàë‰ª¨ÂÅáËÆæÊï∞ÊçÆÈáèÂú®‰∏áÁ∫ß‰ª•ÂÜÖ
        let allMatches = await collection.toArray();

        // 2. Â∫îÁî®Á±ªÂûãËøáÊª§
        if (billState.filterType !== 'all') {
            allMatches = allMatches.filter(t => t.type === billState.filterType);
        }

        // 3. Â∫îÁî®Êó•ÊúüËøáÊª§
        if (billState.filterDate) {
            const [year, month] = billState.filterDate.split('-');
            allMatches = allMatches.filter(t => {
                const d = new Date(t.timestamp);
                return d.getFullYear() === parseInt(year) && (d.getMonth() + 1) === parseInt(month);
            });
        }

        // 4. ÊâãÂä®ÂàÜÈ°µ
        const start = billState.page * billState.pageSize;
        const end = start + billState.pageSize;
        const pageData = allMatches.slice(start, end);

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        if (pageData.length < billState.pageSize) {
            billState.hasMore = false;
            loader.textContent = '‚Äî Ê≤°ÊúâÊõ¥Â§öËÆ∞ÂΩï‰∫Ü ‚Äî';
            loader.classList.remove('hidden'); // ‰øùÊåÅÊòæÁ§∫Â∫ïÁ∫ø
        } else {
            loader.textContent = 'Âä†ËΩΩ‰∏≠...';
        }

        if (pageData.length === 0 && isReset) {
            scrollList.insertAdjacentHTML('afterbegin', 
                '<div class="bill-empty-msg" style="text-align:center; padding:40px; color:#999;">ÊöÇÊó†Áõ∏ÂÖ≥Ë¥¶Âçï</div>'
            );
        } else {
            renderBillItems(pageData, scrollList, loader);
        }

        billState.page++;

    } catch (error) {
        console.error("Âä†ËΩΩË¥¶ÂçïÂ§±Ë¥•:", error);
        loader.textContent = 'Âä†ËΩΩÂ§±Ë¥•';
    } finally {
        billState.isLoading = false;
        if (billState.hasMore) loader.classList.add('hidden'); // Â¶ÇÊûúËøòÊúâÊõ¥Â§öÔºåÂÖàÈöêËóèloadingÔºåÁ≠âÊªöÂä®ÂÜçÊòæÁ§∫
    }
}

// Ê∏≤ÊüìÂàóË°®È°π (Â∏¶Êúà‰ªΩÂàÜÁªÑ) - ‰øÆÂ§çÁâàÔºöÈò≤Ê≠¢ amount ‰∏∫Á©∫ÂØºËá¥Â¥©Ê∫É
function renderBillItems(transactions, container, loaderEl) {
    let lastMonthStr = '';
    
    // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏ÄÈ°µÔºåÂ∞ùËØïËé∑ÂèñÂàóË°®‰∏≠ÊúÄÂêé‰∏Ä‰∏™Êúà‰ªΩÊ†áÈ¢ò
    const existingSeparators = container.querySelectorAll('.bill-month-separator');
    if (existingSeparators.length > 0) {
        lastMonthStr = existingSeparators[existingSeparators.length - 1].textContent;
    }

    const fragment = document.createDocumentFragment();

    transactions.forEach(t => {
        // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÂºÄÂßã„Äë ---
        // Âº∫Âà∂Â∞ÜÈáëÈ¢ùËΩ¨Êç¢‰∏∫Êï∞Â≠óÔºåÂ¶ÇÊûúÊòØ undefined/null/NaNÔºåÂàôÈªòËÆ§‰∏∫ 0
        let safeAmount = Number(t.amount);
        if (isNaN(safeAmount)) {
            console.warn("Ê£ÄÊµãÂà∞ÂºÇÂ∏∏Ë¥¶ÂçïÊï∞ÊçÆ (ÈáëÈ¢ùÊó†Êïà):", t);
            safeAmount = 0;
        }
        // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÁªìÊùü„Äë ---

        const date = new Date(t.timestamp);
        const monthStr = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà`;
        
        // Â¶ÇÊûúÊúà‰ªΩÂèòÂåñÔºåÊèíÂÖ•ÂàÜÂâ≤Á∫ø
        if (monthStr !== lastMonthStr) {
            const separator = document.createElement('div');
            separator.className = 'bill-month-separator';
            separator.textContent = monthStr;
            fragment.appendChild(separator);
            lastMonthStr = monthStr;
        }

        // Ê∏≤ÊüìÂçïÊù°ËÆ∞ÂΩï
        const timeStr = `${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        const isIncome = t.type === 'income';
        const sign = isIncome ? '+' : '-';
        const colorClass = isIncome ? 'income' : 'expense';

        const item = document.createElement('div');
        item.className = 'bill-item';
        item.innerHTML = `
            <div class="bill-info">
                <div class="bill-title">${t.description || 'Êú™Áü•‰∫§Êòì'}</div>
                <div class="bill-time">${timeStr}</div>
            </div>
            <div class="bill-amount ${colorClass}">${sign}${safeAmount.toFixed(2)}</div>
        `;
        fragment.appendChild(item);
    });

    // ÊèíÂÖ•Âà∞ loader ‰πãÂâç
    container.insertBefore(fragment, loaderEl);
}

// 5. Áî®Êà∑ÂÖÖÂÄº
async function handleUserTopUp() {
    const amountStr = await showCustomPrompt("ÂÖÖÂÄº", "ËØ∑ËæìÂÖ•ÂÖÖÂÄºÈáëÈ¢ù (CNY):", "", "number");
    if (!amountStr) return;
    
    const amount = parseFloat(amountStr);
    if (isNaN(amount) || amount <= 0) {
        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù");
        return;
    }

    await processTransaction(amount, 'income', '‰ΩôÈ¢ùÂÖÖÂÄº');
    // Âà∑Êñ∞ÁïåÈù¢
    openAlipayScreen(); 
    await showCustomAlert("ÂÖÖÂÄºÊàêÂäü", `ÊàêÂäüÂÖÖÂÄº ¬•${amount.toFixed(2)}`);
}

// Êö¥Èú≤Áªô HTML Ë∞ÉÁî®
window.openAlipayScreen = openAlipayScreen;
window.handleUserTopUp = handleUserTopUp;
// ÂèòÈáèÂ≠òÂÇ®ÂΩìÂâçÈÄâ‰∏≠ÁöÑËßíËâ≤ID
let selectedKinshipCharId = null;

async function openKinshipSelector() {
    const characters = Object.values(state.chats).filter(c => !c.isGroup);
    if (characters.length === 0) return alert("Ê≤°ÊúâÂèØÁªëÂÆöÁöÑËßíËâ≤");

    const modal = document.getElementById('kinship-creation-modal');
    const listEl = document.getElementById('kinship-char-list');
    const limitInput = document.getElementById('kinship-limit-input');
    
    // --- Êñ∞Â¢ûÔºöËé∑ÂèñÊàñÂàõÂª∫Á±ªÂûãÈÄâÊã©ÂÆπÂô® ---
    let typeContainer = document.getElementById('kinship-type-container');
    if (!typeContainer) {
        // Â¶ÇÊûúHTMLÈáåÊ≤°ÊúâÔºåÂä®ÊÄÅÂàõÂª∫‰∏Ä‰∏™ÊèíÂÖ•Âà∞ÈáëÈ¢ùËæìÂÖ•Ê°ÜÂâçÈù¢
        typeContainer = document.createElement('div');
        typeContainer.id = 'kinship-type-container';
        typeContainer.style.cssText = "margin-bottom: 15px; display: flex; gap: 10px; justify-content: center;";
        
        const inputGroup = limitInput.parentElement; // Ëé∑ÂèñÈáëÈ¢ùËæìÂÖ•Ê°ÜÁöÑÁà∂ÂÆπÂô®
        inputGroup.parentElement.insertBefore(typeContainer, inputGroup); // ÊèíÂú®ËæìÂÖ•Ê°ÜÂâçÈù¢
    }
    
    // Ê∏≤Êüì‰∏§‰∏™ÈÄâÈ°πÊåâÈíÆ
    typeContainer.innerHTML = `
        <label class="radio-btn-wrapper" style="flex:1;">
            <input type="radio" name="kinship-type" value="grant" checked>
            <div class="radio-btn-content" style="text-align:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <div style="font-weight:bold; color:#ff5252;">ÊàëÈÄÅTA</div>
                <div style="font-size:12px; color:#666;">(Ëä±ÊàëÁöÑÈí±)</div>
            </div>
        </label>
        <label class="radio-btn-wrapper" style="flex:1;">
            <input type="radio" name="kinship-type" value="request">
            <div class="radio-btn-content" style="text-align:center; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer;">
                <div style="font-weight:bold; color:#1677ff;">ÈóÆTAË¶Å</div>
                <div style="font-size:12px; color:#666;">(Ëä±TAÁöÑÈí±)</div>
            </div>
        </label>
    `;
    
    // Ê∑ªÂä†ÁÆÄÂçïÁöÑÁÇπÂáªÊ†∑ÂºèÂàáÊç¢ÈÄªËæë
    const radios = typeContainer.querySelectorAll('input[name="kinship-type"]');
    const updateStyles = () => {
        radios.forEach(radio => {
            const content = radio.nextElementSibling;
            if (radio.checked) {
                content.style.borderColor = radio.value === 'grant' ? '#ff5252' : '#1677ff';
                content.style.backgroundColor = radio.value === 'grant' ? '#fff0f0' : '#f0f7ff';
            } else {
                content.style.borderColor = '#ddd';
                content.style.backgroundColor = '#fff';
            }
        });
    };
    radios.forEach(r => r.addEventListener('change', updateStyles));
    updateStyles(); // ÂàùÂßãÂåñÊ†∑Âºè

    // --- ÈáçÁΩÆÁä∂ÊÄÅ ---
    listEl.innerHTML = '';
    selectedKinshipCharId = null;
    limitInput.value = ''; 

    // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
    characters.forEach(char => {
        const item = document.createElement('div');
        item.className = 'clear-posts-item'; 
        item.dataset.id = char.id;
        
        item.onclick = () => {
            listEl.querySelectorAll('.clear-posts-item').forEach(el => {
                el.classList.remove('selected');
                const cb = el.querySelector('.checkbox');
                if(cb) cb.classList.remove('selected');
            });
            
            item.classList.add('selected');
            const cb = item.querySelector('.checkbox');
            cb.classList.add('selected');
            
            selectedKinshipCharId = char.id;
        };

        const avatar = char.settings.aiAvatar || defaultAvatar;
        
        item.innerHTML = `
            <div class="checkbox" style="pointer-events: none;"></div>
            <img src="${avatar}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover;">
            <span class="name" style="font-weight: 500; font-size: 16px;">${char.name}</span>
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}



// 2. ÂèëÈÄÅÁî≥ËØ∑Ê∂àÊÅØ (ÊîØÊåÅÂèåÂêë)
// type: 'grant' (ÊàëÈÄÅTA) | 'request' (ÈóÆTAË¶Å)
async function sendKinshipRequest(chatId, limit, type = 'grant') {
    const chat = state.chats[chatId];
    const myNickname = chat.settings.myNickname || 'Êàë';

    // 1. ÊûÑÈÄ†Áî®Êà∑Ê∂àÊÅØ (ÊòæÁ§∫Âú®ËÅäÂ§©ÁïåÈù¢)
    let userContentText = "";
    if (type === 'grant') {
        userContentText = `[Êàë‰∏∫‰Ω†ÂºÄÈÄö‰∫Ü‚Äú‰∫≤Â±ûÂç°‚ÄùÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}]`;
    } else {
        userContentText = `[ÊàëÂêë‰Ω†ÂèëËµ∑‰∫Ü‚Äú‰∫≤Â±ûÂç°‚Äù‰ª£‰ªòÁî≥ËØ∑ÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}]`;
    }

    const userMsg = {
        role: 'user',
        type: 'kinship_request',
        content: userContentText,
        limit: limit,
        status: 'pending',
        requestType: type, // ËÆ∞ÂΩïÁ±ªÂûãÔºåÊñπ‰æøÂêéÁª≠Â§ÑÁêÜ
        timestamp: Date.now()
    };
    chat.history.push(userMsg);

    // 2. ÊûÑÈÄ†Á≥ªÁªüÊèêÁ§∫ (Áªô AI ÁúãÁöÑÈÄªËæë)
    let systemContentText = "";
    
    if (type === 'grant') {
        // --- ÊÉÖÂÜµ A: ÊàëÈÄÅ AI (AI Ë¢´ÂåÖÂÖª) ---
        systemContentText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname})‰∏∫‰Ω†ÂºÄÈÄö‰∫ÜÊîØ‰ªòÂÆù‚Äú‰∫≤Â±ûÂç°‚ÄùÔºà‰∫≤ÂØÜ‰ªòÔºâÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}„ÄÇËøôÊÑèÂë≥ÁùÄ‰Ω†ÁöÑÊ∂àË¥πÂ∞ÜÁî±Áî®Êà∑‰π∞Âçï„ÄÇËØ∑Ê†πÊçÆ‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªÔºàÊòØÂê¶ÊÑøÊÑèÊé•ÂèóÂØπÊñπÁöÑÈ¶àËµ†ÔºâÂÜ≥ÂÆöÊé•ÂèóËøòÊòØÊãíÁªù„ÄÇËØ∑‰ΩøÁî® 'kinship_response' Êåá‰ª§ËøõË°åÂõûÂ∫î„ÄÇ]`;
    } else {
        // --- ÊÉÖÂÜµ B: ÊàëÈóÆ AI Ë¶Å (Ê±ÇÂåÖÂÖª) ---
        systemContentText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname})Âêë‰Ω†Áî≥ËØ∑ÂºÄÈÄöÊîØ‰ªòÂÆù‚Äú‰∫≤Â±ûÂç°‚ÄùÔºà‰∫≤ÂØÜ‰ªòÔºâÔºåÊØèÊúàÈ¢ùÂ∫¶ ¬•${limit}„ÄÇËøôÊÑèÂë≥ÁùÄÁî®Êà∑ÁöÑÊ∂àË¥πÂ∞ÜÁî±‰Ω†‰π∞Âçï„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑÁªèÊµéÁä∂ÂÜµÂíåÂØπÁî®Êà∑ÁöÑÂÆ†Áà±Á®ãÂ∫¶ÔºåÂÜ≥ÂÆöÊé•ÂèóËøòÊòØÊãíÁªù„ÄÇËØ∑‰ΩøÁî® 'kinship_response' Êåá‰ª§ËøõË°åÂõûÂ∫î„ÄÇ]`;
    }

    const systemMsg = {
        role: 'system',
        content: systemContentText,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(systemMsg);

    await db.chats.put(chat);
    
    if(state.activeChatId === chatId) {
        appendMessage(userMsg, chat);
        // Ëß¶Âèë AI ÊÄùËÄÉ
        triggerAiResponse();
    } else {
        openChat(chatId);
    }      
}



// ==========================================
// ‚ñº‚ñº‚ñº Âü∫ÈáëÁêÜË¥¢Ê®°ÂùóÂÆåÊï¥ÈÄªËæë (‰øÆÂ§çÊï¥ÂêàÁâà) ‚ñº‚ñº‚ñº
// ==========================================

// 1. ÂàùÂßãÂåñÂü∫ÈáëÊï∞ÊçÆ
async function initFunds() {
    const count = await db.funds.count();
    if (count === 0) {
        const initialFunds = [
            { id: 'f01', code: '001001', name: 'ÊãõË¥¢ËøõÂÆùÊ∑∑Âêà', riskLevel: 'medium', currentNav: 1.520, lastDayNav: 1.510, history: [] },
            { id: 'f02', code: '002088', name: 'ÁßëÊäÄÂÖàÈîãÊàêÈïø', riskLevel: 'high', currentNav: 2.305, lastDayNav: 2.280, history: [] },
            { id: 'f03', code: '003099', name: 'Á®≥ÂÅ•ÂÄ∫Âü∫A', riskLevel: 'low', currentNav: 1.050, lastDayNav: 1.049, history: [] },
            { id: 'f04', code: '005666', name: 'Êñ∞ËÉΩÊ∫êÁ≤æÈÄâ', riskLevel: 'high', currentNav: 3.100, lastDayNav: 3.200, history: [] },
            { id: 'f05', code: '008888', name: 'Ê∂àË¥πÁ∫¢Âà©ÊåáÊï∞', riskLevel: 'medium', currentNav: 1.880, lastDayNav: 1.885, history: [] },
            { id: 'f06', code: '110022', name: 'ÂÖ®ÁêÉÂåªÁñóÂåªËçØ', riskLevel: 'high', currentNav: 0.950, lastDayNav: 0.940, history: [] }
        ];
        await db.funds.bulkAdd(initialFunds);
    }
    // Ë°•ÂÖ®Èí±ÂåÖÂ≠óÊÆµ
    const wallet = await db.userWallet.get('main');
    if (wallet && !wallet.fundHoldings) {
        wallet.fundHoldings = [];
        await db.userWallet.put(wallet);
    }
}

// 2. ÂÖ®Â±Ä‰∏ªÈ¢òÊ£ÄÊü• (Ê†∏ÂøÉÔºö‰ΩôÈ¢ùÂèòÂä®Ëá™Âä®ÂàáÊç¢ÈªëÈáë/ËìùËâ≤)
function checkThemeStatus() {
    const threshold = 10000; // ÈªëÈáëÈòàÂÄº
    const isGold = userBalance >= threshold;
    
    // ÂêåÊ≠• Alipay Âíå Fund ‰∏§‰∏™Â±èÂπï
    const screens = ['alipay-screen', 'fund-screen'];
    
    screens.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (isGold) {
                el.classList.add('theme-blackgold');
            } else {
                el.classList.remove('theme-blackgold');
            }
        }
    });

    // Êõ¥Êñ∞È¶ñÈ°µÊ†áÁ≠æ
    const statusTag = document.getElementById('alipay-status-tag');
    if (statusTag) {
        if (isGold) {
            statusTag.textContent = 'ÈªëÈáë‰ºöÂëò';
            statusTag.style.color = '#d4af37';
            statusTag.style.borderColor = '#d4af37';
        } else {
            statusTag.textContent = 'Ê†áÂáÜ‰ºöÂëò';
            statusTag.style.color = 'white';
            statusTag.style.borderColor = 'white';
        }
    }
    // Êõ¥Êñ∞È¶ñÈ°µ‰ΩôÈ¢ù
    const balanceDisplay = document.getElementById('alipay-balance-display');
    if (balanceDisplay) balanceDisplay.textContent = userBalance.toFixed(2);
}

// 3. Ê®°ÊãüÂ∏ÇÂú∫Ê≥¢Âä®
// 3. Ê®°ÊãüÂ∏ÇÂú∫Ê≥¢Âä® (ÂçáÁ∫ßÁâàÔºöËÆ∞ÂΩïÂéÜÂè≤Ëµ∞Âäø)
async function simulateFundMarket() {
    const funds = await db.funds.toArray();
    const updates = [];
    
    // Â∏ÇÂú∫Êï¥‰ΩìÊÉÖÁª™ (-0.02 ~ +0.02)
    const marketSentiment = (Math.random() - 0.45) * 0.05; 

    for (const fund of funds) {
        // 1. Ë°•ÂÖ®ÂéÜÂè≤Êï∞ÊçÆ (Â¶ÇÊûúÊòØÊñ∞Âü∫ÈáëÔºåÂÖà‰º™ÈÄ† 15 ‰∏™ÂéÜÂè≤ÁÇπÔºåËÆ©ÂõæË°®Êúâ‰∏úË•øÁîª)
        if (!fund.history || fund.history.length === 0) {
            fund.history = [];
            let mockNav = fund.currentNav;
            for(let i=0; i<15; i++) {
                // ÂÄíÊé®ÂéÜÂè≤Êï∞ÊçÆ
                mockNav = mockNav * (1 - (Math.random() - 0.5) * 0.02);
                fund.history.unshift(parseFloat(mockNav.toFixed(4)));
            }
        }

        // 2. ËÆ°ÁÆó‰ªäÊó•Ê≥¢Âä®
        let volatility = 0.01; // ‰ΩéÈ£éÈô©Ê≥¢Âä®Â∞è
        if (fund.riskLevel === 'medium') volatility = 0.03;
        if (fund.riskLevel === 'high') volatility = 0.06; // È´òÈ£éÈô©Ê≥¢Âä®Â§ß

        const individualChange = (Math.random() - 0.5) * volatility;
        const changePercent = marketSentiment + individualChange;
        
        // 3. ËÆ∞ÂΩïÊóßÂáÄÂÄºÂà∞ÂéÜÂè≤ (Áî®‰∫éÁîªÂõæ)
        // ‰øùÊåÅ history ÊúÄÂ§öÂ≠ò 20 ‰∏™ÁÇπÔºåÈò≤Ê≠¢Êï∞ÊçÆÂ∫ìÊó†ÈôêËÜ®ËÉÄ
        if (fund.history.length >= 20) fund.history.shift();
        fund.history.push(fund.currentNav);

        // 4. Êõ¥Êñ∞ÂΩìÂâçÂáÄÂÄº
        const oldNav = fund.currentNav;
        let newNav = oldNav * (1 + changePercent);
        if (newNav < 0.1) newNav = 0.1; // Èò≤Ê≠¢Ë∑åÊàêË¥üÊï∞

        fund.lastDayNav = oldNav; // Êò®Êó•ÂáÄÂÄº
        fund.currentNav = parseFloat(newNav.toFixed(4)); // ‰ªäÊó•ÂáÄÂÄº
        
        updates.push(fund);
    }
    await db.funds.bulkPut(updates);
}

// 4. ÊâìÂºÄÂü∫ÈáëÈ°µÈù¢
async function openFundScreen() {
    // ÁßªÈô§ Math.random Âà§Êñ≠ÔºåÊØèÊ¨°ÊâìÂºÄÈÉΩÊ®°Êãü‰∏ÄÊ¨°Ê≥¢Âä®ÔºåËê•ÈÄ†‚ÄúÂÆûÊó∂Ë°åÊÉÖ‚ÄùÁöÑÊÑüËßâ
    // ÊàñËÄÖ‰øùÁïô await simulateFundMarket(); 
    await simulateFundMarket(); 
    
    checkThemeStatus(); 
    await renderFundScreen();
    showScreen('fund-screen');
}

// 5. Ê∏≤ÊüìÂü∫Èáë‰∏ªÁïåÈù¢
let activeFundTab = 'market'; // ÈªòËÆ§ÈÄâ‰∏≠Â∏ÇÂú∫

async function renderFundScreen() {
    const funds = await db.funds.toArray();
    const wallet = await db.userWallet.get('main');
    const holdings = wallet.fundHoldings || [];
    
    let totalAssets = 0;
    let totalProfit = 0;
    let yesterdayProfit = 0;

    holdings.forEach(h => {
        const fund = funds.find(f => f.id === h.fundId);
        if (fund) {
            const marketValue = h.units * fund.currentNav;
            const costValue = h.units * h.cost;
            const yesterdayValue = h.units * fund.lastDayNav;
            
            totalAssets += marketValue;
            totalProfit += (marketValue - costValue);
            yesterdayProfit += (marketValue - yesterdayValue);
        }
    });

    document.getElementById('fund-total-assets').textContent = totalAssets.toFixed(2);
    
    const totalProfitEl = document.getElementById('fund-total-profit');
    totalProfitEl.textContent = (totalProfit >= 0 ? "+" : "") + totalProfit.toFixed(2);
    totalProfitEl.style.color = totalProfit >= 0 ? '#ff9c9c' : '#a0f0a0';

    const yesterdayProfitEl = document.getElementById('fund-yesterday-profit');
    yesterdayProfitEl.textContent = (yesterdayProfit >= 0 ? "+" : "") + yesterdayProfit.toFixed(2);
    
    // Ê†πÊçÆÂΩìÂâç Tab Ê∏≤ÊüìÂàóË°®
    if (activeFundTab === 'market') {
        renderFundMarketList(funds);
    } else {
        renderFundMyList(funds, holdings);
    }
}
// --- ËæÖÂä©ÂáΩÊï∞ÔºöÁîüÊàêËø∑‰Ω†Ëµ∞ÂäøÂõæ SVG ---
function generateMiniChartSvg(dataPoints, isUp) {
    if (!dataPoints || dataPoints.length < 2) return '';

    const width = 60;  // ÂõæË°®ÂÆΩ
    const height = 20; // ÂõæË°®È´ò
    const color = isUp ? '#ff3b30' : '#4cd964'; // Á∫¢Ê∂®ÁªøË∑å
    
    // ÊâæÂá∫ÊúÄÂ§ßÊúÄÂ∞èÂÄºÔºåÁî®‰∫éÂΩí‰∏ÄÂåñ
    const min = Math.min(...dataPoints);
    const max = Math.max(...dataPoints);
    const range = max - min || 1; // Èò≤Ê≠¢Èô§‰ª•0

    // ÁîüÊàêË∑ØÂæÑÁÇπ
    // ÂùêÊ†áÁ≥ªÔºöXËΩ¥ÂùáÂåÄÂàÜÂ∏ÉÔºåYËΩ¥Ê†πÊçÆ‰ª∑Ê†ºËÆ°ÁÆó (‰ª∑Ê†ºË∂äÈ´òÔºåYË∂äÂ∞è/Ë∂äÈù†‰∏ä)
    const points = dataPoints.map((val, index) => {
        const x = (index / (dataPoints.length - 1)) * width;
        const y = height - ((val - min) / range) * height; 
        return `${x},${y}`;
    }).join(' ');

    // ËøîÂõû SVG Â≠óÁ¨¶‰∏≤
    return `
        <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" style="overflow:visible;">
            <polyline fill="none" stroke="${color}" stroke-width="2" points="${points}" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
}
// Ê∏≤ÊüìÂ∏ÇÂú∫ÂàóË°® (Â∏¶Ëµ∞ÂäøÂõæÁâà)
function renderFundMarketList(funds) {
    const listEl = document.getElementById('fund-market-list');
    listEl.style.display = 'block';
    document.getElementById('fund-my-list').style.display = 'none';
    listEl.innerHTML = '';

    funds.forEach(fund => {
        const changeRate = ((fund.currentNav - fund.lastDayNav) / fund.lastDayNav) * 100;
        const isUp = changeRate >= 0;
        const colorClass = isUp ? 'fund-up' : 'fund-down';
        const sign = isUp ? '+' : '';
        
        // È£éÈô©Ê†áÁ≠æ
        let riskColorBg, riskColorText, riskText;
        if (fund.riskLevel === 'high') {
             riskColorBg = '#fff1f0'; riskColorText = '#ff4d4f'; riskText = 'È´òÈ£éÈô©';
        } else if (fund.riskLevel === 'medium') {
             riskColorBg = '#fff7e6'; riskColorText = '#fa8c16'; riskText = '‰∏≠È£éÈô©';
        } else {
             riskColorBg = '#f6ffed'; riskColorText = '#52c41a'; riskText = 'Á®≥ÂÅ•';
        }
        
        const riskTag = `<span class="fund-tag" style="background:${riskColorBg}; color:${riskColorText};">${riskText}</span>`;

        // ‚ñº‚ñº‚ñº ÁîüÊàêËµ∞ÂäøÂõæ ‚ñº‚ñº‚ñº
        // ÊääÂéÜÂè≤Êï∞ÊçÆÂíåÂΩìÂâçÊï∞ÊçÆÂêàÂπ∂Ëµ∑Êù•ÁîªÂõæ
        const chartData = [...(fund.history || []), fund.currentNav];
        const chartSvg = generateMiniChartSvg(chartData, isUp);

        const item = document.createElement('div');
        item.className = 'fund-item';
        item.onclick = () => openFundTradeModal('buy', fund); 

        // ÈáçÊñ∞Â∏ÉÂ±ÄÔºöÂ∑¶Ëæπ‰ø°ÊÅØÔºå‰∏≠Èó¥ÂõæË°®ÔºåÂè≥ËæπÊï∞ÊçÆ
        item.innerHTML = `
            <div class="fund-info" style="flex: 1.2;">
                <h4 style="margin-bottom:6px; font-size:15px;">${fund.name}</h4>
                <div class="fund-tags">
                    <span class="fund-tag" style="background:#f5f5f5; color:#999;">${fund.code}</span>
                    ${riskTag}
                </div>
            </div>
            
            <div class="fund-chart" style="flex: 1; display:flex; justify-content:center; align-items:center; opacity:0.8;">
                ${chartSvg}
            </div>

            <div class="fund-data" style="flex: 1; text-align:right;">
                <div class="fund-change ${colorClass}" style="font-size:18px; font-weight:bold;">${sign}${changeRate.toFixed(2)}%</div>
                <div class="fund-nav" style="font-size:11px; color:#999; margin-top:4px;">ÂáÄÂÄº ${fund.currentNav.toFixed(4)}</div>
            </div>
        `;
        listEl.appendChild(item);
    });
}

// Ê∏≤ÊüìÊåÅ‰ªìÂàóË°®
function renderFundMyList(funds, holdings) {
    const listEl = document.getElementById('fund-my-list');
    listEl.style.display = 'block';
    document.getElementById('fund-market-list').style.display = 'none';
    listEl.innerHTML = '';

    if (holdings.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">ÊöÇÊó†ÊåÅ‰ªì</div>';
        return;
    }

    holdings.forEach(h => {
        const fund = funds.find(f => f.id === h.fundId);
        if (!fund) return;
        
        const marketValue = h.units * fund.currentNav;
        const costValue = h.units * h.cost;
        const profit = marketValue - costValue;
        const profitRate = (profit / costValue) * 100;
        
        const isUp = profit >= 0;
        const colorClass = isUp ? 'fund-up' : 'fund-down';
        const sign = isUp ? '+' : '';

        const item = document.createElement('div');
        item.className = 'fund-item';
        item.onclick = () => openFundTradeModal('sell', fund, h); // ÁÇπÂáªÂçñÂá∫
        item.innerHTML = `
            <div class="fund-info">
                <h4>${fund.name}</h4>
                <div style="font-size:12px; color:#666;">ÊåÅÊúâ ${h.units.toFixed(2)} ‰ªΩ</div>
            </div>
            <div class="fund-data">
                <div class="fund-change ${colorClass}">${sign}${profit.toFixed(2)}</div>
                <div class="fund-nav" style="font-size:11px;">${sign}${profitRate.toFixed(2)}%</div>
            </div>
        `;
        listEl.appendChild(item);
    });
}

// ÂàáÊç¢ Tab
function switchFundTab(tab) {
    activeFundTab = tab;
    // Êõ¥Êñ∞ CSS Á±ª
    document.querySelectorAll('.frame-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-fund-${tab}`).classList.add('active');
    renderFundScreen();
}

// 6. ‰∫§ÊòìÁõ∏ÂÖ≥
let currentTradeContext = null;

async function openFundTradeModal(type, fund, holding = null) {
    currentTradeContext = { type, fund, holding };
    const modal = document.getElementById('fund-trade-modal');
    
    // Ëé∑Âèñ‰ΩôÈ¢ù
    const wallet = await db.userWallet.get('main');
    const balance = wallet.balance || 0;

    document.getElementById('fund-trade-name').textContent = fund.name;
    document.getElementById('fund-trade-code').textContent = fund.code;
    document.getElementById('fund-trade-nav').textContent = fund.currentNav.toFixed(4);
    
    const changeRate = ((fund.currentNav - fund.lastDayNav) / fund.lastDayNav) * 100;
    const changeEl = document.getElementById('fund-trade-change');
    changeEl.textContent = (changeRate >= 0 ? "+" : "") + changeRate.toFixed(2) + "%";
    changeEl.className = changeRate >= 0 ? 'fund-up' : 'fund-down';

    const inputEl = document.getElementById('fund-trade-amount');
    inputEl.value = '';
    const confirmBtn = document.getElementById('fund-confirm-btn');
    const titleEl = document.getElementById('fund-trade-title');
    const labelEl = document.getElementById('fund-trade-label');
    const infoEl = document.getElementById('fund-trade-info');

    if (type === 'buy') {
        titleEl.textContent = '‰π∞ÂÖ•Âü∫Èáë';
        labelEl.innerHTML = `‰π∞ÂÖ•ÈáëÈ¢ù (‰ΩôÈ¢ù: ¬•<span id="fund-wallet-balance">${balance.toFixed(2)}</span>)`;
        infoEl.textContent = "Ë¥πÁéá 0.00%";
        confirmBtn.textContent = "Á°ÆËÆ§‰π∞ÂÖ•";
        confirmBtn.style.backgroundColor = "#1677ff";
        currentTradeContext.maxAmount = balance;
    } else {
        titleEl.textContent = 'ÂçñÂá∫Âü∫Èáë';
        const holdingVal = holding.units * fund.currentNav;
        labelEl.innerHTML = `ÂçñÂá∫ÈáëÈ¢ù (ÊåÅÊúâ: ¬•<span id="fund-wallet-balance">${holdingVal.toFixed(2)}</span>)`;
        infoEl.textContent = `ÊåÅÊúâ‰ªΩÈ¢ù: ${holding.units.toFixed(2)} ‰ªΩ`;
        confirmBtn.textContent = "Á°ÆËÆ§ÂçñÂá∫";
        confirmBtn.style.backgroundColor = "#ff9800";
        currentTradeContext.maxAmount = holdingVal;
    }

    modal.classList.add('visible');
}

// Á°ÆËÆ§‰∫§Êòì (ÁªëÂÆöÂú®HTML onclick)
window.handleFundTradeConfirm = async function() {
    if (!currentTradeContext) return;
    const amount = parseFloat(document.getElementById('fund-trade-amount').value);
    
    if (isNaN(amount) || amount <= 0) {
        document.getElementById('custom-modal-overlay').style.zIndex = 3002;
        await showCustomAlert("ÊèêÁ§∫", "ËØ∑ËæìÂÖ•ÊúâÊïàÈáëÈ¢ù");
        document.getElementById('custom-modal-overlay').style.zIndex = '';
        return;
    }
    if (amount > currentTradeContext.maxAmount) {
        document.getElementById('custom-modal-overlay').style.zIndex = 3002;
        await showCustomAlert("Â§±Ë¥•", "‰ΩôÈ¢ùÊàñ‰ªΩÈ¢ù‰∏çË∂≥");
        document.getElementById('custom-modal-overlay').style.zIndex = '';
        return;
    }

    const { type, fund } = currentTradeContext;
    const wallet = await db.userWallet.get('main');
    let holdings = wallet.fundHoldings || [];

    if (type === 'buy') {
        const success = await processTransaction(amount, 'expense', `Âü∫Èáë‰π∞ÂÖ•-${fund.name}`);
        if (!success) return;

        const existing = holdings.find(h => h.fundId === fund.id);
        const newUnits = amount / fund.currentNav;
        
        if (existing) {
            const totalCost = (existing.units * existing.cost) + amount;
            existing.units += newUnits;
            existing.cost = totalCost / existing.units;
        } else {
            holdings.push({ fundId: fund.id, units: newUnits, cost: fund.currentNav });
        }
        await showCustomAlert("ÊàêÂäü", "‰π∞ÂÖ•ÊàêÂäüÔºÅ");
    } else {
        const idx = holdings.findIndex(h => h.fundId === fund.id);
        if (idx === -1) return;
        
        const unitsToSell = amount / fund.currentNav;
        holdings[idx].units -= unitsToSell;
        if (holdings[idx].units < 0.01) holdings.splice(idx, 1);

        await processTransaction(amount, 'income', `Âü∫ÈáëÂçñÂá∫-${fund.name}`);
        await showCustomAlert("ÊàêÂäü", "ÂçñÂá∫ÊàêÂäüÔºÅ");
    }

    wallet.fundHoldings = holdings;
    await db.userWallet.put(wallet);

    // ‰∫§ÊòìÂêéÁ´ãÂç≥Ê£ÄÊü•‰∏ªÈ¢ò
    checkThemeStatus();

    document.getElementById('fund-trade-modal').classList.remove('visible');
    renderFundScreen();
};

// Êö¥Èú≤ÁªôÂÖ®Â±Ä
window.openFundScreen = openFundScreen;
window.switchFundTab = switchFundTab; // ËøôÊ¨°Ë°•‰∏ä‰∫ÜÔºÅ
window.refreshFundMarket = async () => {
    await showCustomAlert("Âà∑Êñ∞‰∏≠", "Ê≠£Âú®Êõ¥Êñ∞Ë°åÊÉÖ...");
    await simulateFundMarket();
    await renderFundScreen();
};
let auctionState = {
    isActive: false,
    item: null,
    currentPrice: 0,
    timer: 30,
    timerId: null,
    npcIntervalId: null,
    lastBidder: null, // { name: string, type: 'user'|'npc'|'char', id: string }
    bidHistory: []
};

// 1. ÊâìÂºÄÊãçÂçñË°å
async function openAuctionScreen() {
    showScreen('auction-screen');
    // Â¶ÇÊûúÂΩìÂâçÊ≤°ÊúâÊ¥ªÂä®ÊãçÂçñÔºåÊàñËÄÖÊãçÂçñÂ∑≤ÁªìÊùüÔºåÁîüÊàê‰∏Ä‰∏™Êñ∞ÁöÑÈ¢ÑËßà
    if (!auctionState.isActive) {
        document.getElementById('auction-item-img').style.display = 'none';
        document.getElementById('auction-loading').style.display = 'block';
        document.getElementById('auction-item-name').textContent = "Ê≠£Âú®ÊêúÂØªÈªëÂ∏Ç...";
        document.getElementById('auction-item-desc').textContent = "";
        
        // Ëá™Âä®ÂºÄÂßãÁîüÊàê
        generateNewAuctionItem();
    }
}


async function generateNewAuctionItem() {
    const btn = document.querySelector('#auction-screen .action-btn');
    btn.style.pointerEvents = 'none';
    btn.textContent = 'ËøõË¥ß‰∏≠...';

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey) {
        alert("ËØ∑ÂÖàÈÖçÁΩÆAPIÔºÅ");
        btn.style.pointerEvents = 'auto';
        btn.textContent = 'Êñ∞ÊãçÂìÅ';
        return;
    }

    // --- 1. Êô∫ËÉΩËÆæÂÆöÂà§ÂÆöÈÄªËæë ---
    let auctionContext = "";
    
    // Â∞ùËØïÂØªÊâæÂåÖÂê´ "ÈªëÂ∏Ç" Êàñ "ÊãçÂçñ" ÁöÑ‰∏ñÁïå‰π¶
    const auctionBook = state.worldBooks.find(wb => wb.name.includes('ÈªëÂ∏Ç') || wb.name.includes('ÊãçÂçñ'));

    if (auctionBook) {
        console.log("‚úÖ ÊâæÂà∞‰∏ìÂ±ûÊãçÂçñËÆæÂÆö‰π¶:", auctionBook.name);
        const contentPreview = auctionBook.content
            .filter(e => e.enabled !== false)
            .map(e => e.content).join('; ');
        // Â¶ÇÊûúÊúâ‰∏ñÁïå‰π¶ÔºåÂº∫Âà∂ AI ÈÅµÂÆà‰∏ñÁïå‰π¶
        auctionContext = `
    „ÄêÂΩìÂâçÊãçÂçñË°åÁâπÊÆä‰∏ñÁïåËßÇ (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë: 
    ${contentPreview}
    
    (ËØ∑Ê†πÊçÆ‰∏äËø∞ÁâπÊÆä‰∏ñÁïåËßÇÁîüÊàêÁ¨¶ÂêàËÆæÂÆöÁöÑÊãçÂìÅÂíåNPCÔºåÂøΩÁï•Áé∞ÂÆû‰∏ñÁïåÁöÑÈôêÂà∂)
    `;
    } else {
        console.log("‚ÑπÔ∏è Êú™ÊâæÂà∞‰∏ìÂ±ûËÆæÂÆöÔºå‰ΩøÁî®ÈªòËÆ§Ë±™Â•¢ËÆæÂÆö");
        auctionContext = `
    „ÄêÈªòËÆ§ÊãçÂìÅÁ±ªÂà´Ê∏ÖÂçï„Äë:
    1. È°∂Á∫ßÁè†ÂÆùÔºöÁ®ÄÊúâÈíªÁü≥È°πÈìæ„ÄÅÁ∫¢ËìùÂÆùÁü≥ÊàíÊåá„ÄÅÁöáÂÜ†„ÄÅÊâãÈïØÔºàÈÄÇÂêàÈÄÅÁªôÊÅã‰∫∫Ôºâ„ÄÇ
    2. ‰º†‰∏ñÂè§Ëë£ÔºöÊòéÊ∏ÖÁì∑Âô®„ÄÅÊ¨ßÊ¥≤‰∏≠‰∏ñÁ∫™Âè§Áâ©„ÄÅÁªùÁâàÂêçË°®„ÄÅÁéâÁé∫„ÄÇ
    3. Ëâ∫ÊúØÁèçÂìÅÔºö‰∏ñÁïåÂêçÁîªÔºàËôöÊûÑÁöÑÁúüËøπÔºâ„ÄÅËëóÂêçÈõïÂ°ë„ÄÇ
    4. Â•¢ÂçéËµÑ‰∫ßÔºöÊµ∑Â≤õÂ•ëÁ∫¶„ÄÅÁßÅ‰∫∫È£ûÊú∫„ÄÅÈ°∂Á∫ßË±™ËΩ¶„ÄÅÂ∫ÑÂõ≠Èí•Âåô„ÄÇ
    5. Ê∏∏ÊàèÊäΩÂç°ÔºöÁèçÁ®ÄÊ∏∏ÊàèÈÅìÂÖ∑„ÄÅÁªùÁâàÁöÆËÇ§Ë¥¶Âè∑„ÄÇ
    
    (ËØ∑‰ªÖ‰ªé‰∏äËø∞ 5 ‰∏™Á±ªÂà´‰∏≠ÈÄâÊã©‰∏ÄÁßçÁîüÊàê)
    `;
    }

    // 2. Ëé∑ÂèñËßíËâ≤ÂàóË°® (Áî®‰∫é AI È¢ÑÂà§Ë∞Å‰ºö‰π∞)
    const charList = Object.values(state.chats).filter(c => !c.isGroup).map(c => {
        return `${c.name}(${c.settings.aiPersona.substring(0, 50)}...)`;
    }).join('\n');

    const systemPrompt = `
    ‰Ω†ÊòØ‰∏Ä‰ΩçÈ°∂Á∫ßÊãçÂçñË°åÁöÑÈ¶ñÂ∏≠ÊãçÂçñÂÆò„ÄÇ
    
    # Ê†∏ÂøÉ‰ªªÂä°
    ËØ∑Ê†πÊçÆ‰∏ãÈù¢ÁöÑ„ÄêËÆæÂÆöÊù•Ê∫ê„ÄëÔºåÂÆåÊàê‰∏§‰∏™‰ªªÂä°Ôºö
    1. ÁîüÊàê‰∏Ä‰ª∂ÊûÅÂÖ∑‰ª∑ÂÄºÁöÑÊãçÂìÅ„ÄÇ
    2. ÁîüÊàê‰∏ÄÊâπÁ¨¶ÂêàËØ•‰∏ñÁïåËßÇËÉåÊôØÁöÑ‚ÄúË∑Ø‰∫∫NPCÁ´ûÊãçËÄÖ‚Äù„ÄÇ
    
    ${auctionContext}
    
    # ‰ªªÂä° BÔºö‰π∞ÂÆ∂ÊÑèÂêëÂàÜÊûê
    ‰∏ãÈù¢ÊòØ‰ªäÂ§©ÁöÑÂèóÈÇÄÂÆæÂÆ¢ÂêçÂçïÔºàÁî®Êà∑ÁöÑÈáçË¶ÅËßíËâ≤ÔºâÔºö
    ${charList}
    ËØ∑ÂàÜÊûêËøô‰ª∂ÊãçÂìÅÂØπÂì™‰∫õÂÆæÂÆ¢ÊúâÂê∏ÂºïÂäõÔºü
    
    # ÂõûÂ§çÊ†ºÂºèÈìÅÂæã
    ÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°Ôºö
    {
        "item": {
            "name": "Áâ©ÂìÅÂêçÁß∞ (‰∏≠ÊñáÔºåÂêçÂ≠óË¶ÅÈú∏Ê∞îÊàñ‰ºòÈõÖ)",
            "description": "‰∏ÄÊÆµÁ≤æÂΩ©ÁöÑÊèèËø∞ÔºåÂº∫Ë∞ÉÂÖ∂Á®ÄÊúâÂ∫¶„ÄÅÂéÜÂè≤‰ª∑ÂÄºÊàñÁâπÊÆäÂäüËÉΩÔºà50Â≠ó‰ª•ÂÜÖÔºå‰∏≠ÊñáÔºâ",
            "basePrice": ÂàùÂßã‰ª∑Ê†º(Êï∞Â≠ó, Âª∫ËÆÆ 10000 ‰ª•‰∏ä),
            "image_prompt": "Áâ©ÂìÅÁöÑËã±ÊñáËßÜËßâÊèèËø∞, high quality, cinematic lighting, detailed, clean background"
        },
        "interested_bidders": ["ÂÆæÂÆ¢AÁöÑÂêçÂ≠ó", "ÂÆæÂÆ¢BÁöÑÂêçÂ≠ó"],
        "world_npcs": ["NPCÂêçÂ≠ó1", "NPCÂêçÂ≠ó2", "NPCÂêçÂ≠ó3", "NPCÂêçÂ≠ó4", "NPCÂêçÂ≠ó5"]
    }
    
    Ê≥®ÊÑèÔºö
    1. image_prompt ÂøÖÈ°ªÂÖ®ÊòØËã±ÊñáÂçïËØç„ÄÇ
    2. interested_bidders Êï∞ÁªÑÈáåÂè™ËÉΩÂ°´‰∏äÈù¢‚ÄúÂèóÈÇÄÂÆæÂÆ¢ÂêçÂçï‚ÄùÈáåÂá∫Áé∞ËøáÁöÑÂêçÂ≠ó„ÄÇ
    3. world_npcs ÊòØ‰Ω†Ê†πÊçÆ‰∏ñÁïåËßÇÁîüÊàêÁöÑË∑Ø‰∫∫„ÄÇ‰æãÂ¶ÇÔºöÂ¶ÇÊûúÊòØ‰øÆ‰ªô‰∏ñÁïåÔºåÁîüÊàê"Èùí‰∫ëÈó®ÈïøËÄÅ"„ÄÅ"Êï£‰øÆÂ§ßËÉΩ"ÔºõÂ¶ÇÊûúÊòØËµõÂçö‰∏ñÁïåÔºåÁîüÊàê"ËçíÂùÇÂÖ¨Âè∏È´òÁÆ°"„ÄÅ"Â§ú‰πãÂüé‰∏≠Èó¥‰∫∫"„ÄÇÂ¶ÇÊûúÊòØÈªòËÆ§ËÆæÂÆöÔºåÁîüÊàê"Áü≥Ê≤πÁéãÂ≠ê"„ÄÅ"Á•ûÁßòÊî∂ËóèÂÆ∂"Á≠â„ÄÇ
    `;

    try {
        let isGemini = proxyUrl.includes('generativelanguage');
        let config = toGeminiRequestData(model, apiKey, systemPrompt, [{role:'user', content:'ÁîüÊàê‰∏Ä‰ª∂ÊãçÂìÅ'}]);
        
        const response = isGemini ? 
            await fetch(config.url, config.data) : 
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: [{role:'system', content:systemPrompt}, {role:'user', content:'ÁîüÊàê‰∏Ä‰ª∂ÊãçÂìÅ'}], temperature: 1.0 })
            });

        if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");
        const data = await response.json();
        const text = getGeminiResponseText(data);
        const json = JSON.parse(text.replace(/^```json\s*/, '').replace(/```$/, ''));

        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(json.item.image_prompt)}`;
        const limitMultiplier = 1.5 + Math.random() * 2.0; 
        
        auctionState.item = json.item;
        auctionState.basePrice = json.item.basePrice;
        auctionState.limitPrice = json.item.basePrice * limitMultiplier;
        auctionState.currentPrice = json.item.basePrice;
        auctionState.isActive = true;
        auctionState.timer = 20; 
        auctionState.lastBidder = null; 
        auctionState.bidHistory = [];
        
        auctionState.interestedChars = json.interested_bidders || [];
        // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰øùÂ≠òÁîüÊàêÁöÑ NPC ÂàóË°®
        auctionState.worldNPCs = json.world_npcs || [];

        console.log("ÂØπÊú¨ÊãçÂìÅÊÑüÂÖ¥Ë∂£ÁöÑËßíËâ≤:", auctionState.interestedChars);
        console.log("Êú¨Âú∫Ë∑Ø‰∫∫NPC:", auctionState.worldNPCs);

        // Êõ¥Êñ∞UI
        document.getElementById('auction-item-name').textContent = json.item.name;
        document.getElementById('auction-item-desc').textContent = json.item.description;
        document.getElementById('auction-current-price').textContent = `¬• ${json.item.basePrice.toLocaleString()}`;
        
        const imgEl = document.getElementById('auction-item-img');
        imgEl.src = imageUrl;
        imgEl.style.display = 'block';
        document.getElementById('auction-loading').style.display = 'none';
        
        document.getElementById('auction-log').innerHTML = '<div style="color:#666; padding:5px;">ÊãçÂçñÂºÄÂßãÔºÅÂ∫ï‰ª∑ ¬•' + json.item.basePrice + '</div>';

        startAuctionLoop();

    } catch (e) {
        console.error(e);
        alert("ËøõË¥ßÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
    } finally {
        btn.style.pointerEvents = 'auto';
        btn.textContent = 'Êñ∞ÊãçÂìÅ';
    }
}

// Êñ∞Â¢ûÔºöÊãçÂçñÂ∏àÂñäËØùÁä∂ÊÄÅ
let auctioneerState = 0; 

function startAuctionLoop() {
    if (auctionState.timerId) clearInterval(auctionState.timerId);
    if (auctionState.npcIntervalId) clearInterval(auctionState.npcIntervalId);

    const timerEl = document.getElementById('auction-timer');
    const logEl = document.getElementById('auction-log'); // Ëé∑ÂèñÊó•ÂøóÂå∫Âüü
    auctioneerState = 0; // ÈáçÁΩÆÂñäËØù

    // ÂÄíËÆ°Êó∂ÈÄªËæë
    auctionState.timerId = setInterval(() => {
        auctionState.timer--;
        
        // Ê†ºÂºèÂåñÂÄíËÆ°Êó∂ÊòæÁ§∫
        timerEl.textContent = `${auctionState.timer.toFixed(1)}s`;
        
        // ËßÜËßâË≠¶Âëä
        if (auctionState.timer <= 5) {
            timerEl.style.color = '#ff0055'; // Á∫¢Ëâ≤Á¥ßËø´
            timerEl.style.textShadow = '0 0 10px #ff0055';
        } else {
            timerEl.style.color = '#f0ad4e';
            timerEl.style.textShadow = 'none';
        }

        // --- Áé©Ê≥ïÂ¢ûÂº∫ÔºöÊãçÂçñÂ∏àÂñäËØù ---
        if (auctionState.timer <= 10 && auctioneerState === 0) {
            addAuctionLog("System", `üî® ${auctionState.currentPrice} Á¨¨‰∏ÄÊ¨°ÔºÅ`);
            auctioneerState = 1;
        }
        if (auctionState.timer <= 5 && auctioneerState === 1) {
            addAuctionLog("System", `üî® ${auctionState.currentPrice} Á¨¨‰∫åÊ¨°ÔºÅËøòÊúâ‰∫∫Âä†‰ª∑ÂêóÔºü`);
            auctioneerState = 2;
        }
        if (auctionState.timer <= 2 && auctioneerState === 2) {
            addAuctionLog("System", `üî® ${auctionState.currentPrice} Á¨¨‰∏âÊ¨°ÔºÅÂç≥Â∞ÜÊàê‰∫§...`);
            auctioneerState = 3;
        }

        if (auctionState.timer <= 0) {
            endAuction();
        }
    }, 1000); // ËøôÈáåÂÖ∂ÂÆûÂèØ‰ª•ÊîπÊàê 100ms Â¢ûÂä†Âπ≥ÊªëÂ∫¶Ôºå‰ΩÜ 1000ms Â§üÁî®‰∫Ü

    // NPC Âá∫‰ª∑ÈÄªËæë (Á®çÂæÆÂä†Âø´È¢ëÁéá)
    auctionState.npcIntervalId = setInterval(() => {
        if (!auctionState.isActive) return;
        
        // Â¢ûÂä†ÈöèÊú∫ÊÄßÔºö‰∏çÊòØÊØèÊ¨°tickÈÉΩÊ£ÄÊü•ÔºåËÄåÊòØÊõ¥ÈöèÊú∫
        if (Math.random() < 0.7) { 
            npcBid();
        }
    }, 800); 
}

// 4. NPC/ÁÜü‰∫∫ Âá∫‰ª∑ÈÄªËæë (‰øÆÂ§çÁâàÔºöÊõ¥Êô∫ËÉΩ„ÄÅÊúâÊú∫‰ºöËµ¢)
// 4. NPC/ÁÜü‰∫∫ Âá∫‰ª∑ÈÄªËæë (AI‰∫íÊêèÁâà)
function npcBid() {
    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÂà†Èô§‰∫Ü "if (lastBidder !== 'user') return" ËøôË°å‰ª£Á†Å
    // Áé∞Âú®ÂÖÅËÆ∏ AI ‰πãÈó¥‰∫íÁõ∏Á´û‰ª∑Ôºå‰∏çÈúÄË¶ÅÁ≠âÁé©ÂÆ∂
    
    // 1. ‰ª∑Ê†ºÂ∞ÅÈ°∂Ê£ÄÊü• (Èò≤Ê≠¢Êó†Èôê‰∫íÂà∑)
    if (auctionState.currentPrice >= auctionState.limitPrice) {
        // Ë∂ÖËøá‰º∞ÂÄº‰∏äÈôêÂêéÔºå90%Ê¶ÇÁéáÂÅúÊ≠¢Ôºå10%Ê¶ÇÁéá‚Äú‰∏äÂ§¥‚ÄùÁªßÁª≠Ë∑ü
        if (Math.random() > 0.1) return; 
    }

    // 2. ËÆ°ÁÆóÂá∫‰ª∑Ê¶ÇÁéá (‰ª∑Ê†ºË∂äÈ´òÔºåË∑üÊãçË∂äÁäπË±´)
    const premiumRatio = auctionState.currentPrice / auctionState.basePrice;
    const bidChance = 0.8 / (premiumRatio * premiumRatio); // Á®çÂæÆË∞ÉÈ´ò‰∫ÜÁ≥ªÊï∞ÔºåËÆ©ÂêéÊúü‰πüÊï¢Ë∑ü
    if (Math.random() > bidChance) return;

    // 3. Á°ÆÂÆöÊú¨Ê¨°Ë∞ÅÊÉ≥Âá∫‰ª∑ (30% ËßíËâ≤ vs 70% NPC)
    let candidate = null;
    
    // Ëé∑ÂèñÊÑüÂÖ¥Ë∂£ÁöÑËßíËâ≤ÂàóË°®
    const allCharacters = Object.values(state.chats).filter(c => !c.isGroup);
    const interestedCandidates = allCharacters.filter(c => 
        auctionState.interestedChars && auctionState.interestedChars.includes(c.name)
    );

    // È™∞Â≠êÂà§ÂÆöÔºöÊú¨Ê¨°ÊòØÁÜü‰∫∫Âá∫Êâã(30%) ËøòÊòØ ÂúüË±™Ë∑Ø‰∫∫Âá∫Êâã(70%)
    if (interestedCandidates.length > 0 && Math.random() < 0.3) {
        const char = interestedCandidates[Math.floor(Math.random() * interestedCandidates.length)];
        candidate = { name: char.name, type: 'char', id: char.id };
    } else {
        // --- NPC Ê±† ---
        let npcName = "Á•ûÁßò‰π∞ÂÆ∂";
        
        // ‰ºòÂÖà‰ªéÁîüÊàêÁöÑÂàóË°®ÈáåÊâæÔºåÂπ∂‰∏îÂ∞ΩÈáèÊâæ‰∏Ä‰∏™‚Äú‰∏çÊòØÂΩìÂâçÊúÄÈ´òÂá∫‰ª∑ËÄÖ‚ÄùÁöÑ‰∫∫
        if (auctionState.worldNPCs && auctionState.worldNPCs.length > 0) {
            // ËøáÊª§ÊéâÂΩìÂâçÊ≠£Âú®È¢ÜÂÖàÁöÑ‰∫∫ÔºåÂà∂ÈÄ†‚ÄúÁ´û‰∫â‚ÄùÊÑü
            const rivals = auctionState.worldNPCs.filter(n => 
                !auctionState.lastBidder || n !== auctionState.lastBidder.name
            );
            
            if (rivals.length > 0) {
                npcName = rivals[Math.floor(Math.random() * rivals.length)];
            } else {
                npcName = auctionState.worldNPCs[0];
            }
        } else {
            // ÂÖúÂ∫ïÂêçÂçï
            const richNames = ["Á•ûÁßò‰π∞ÂÆ∂", "ËãèÂØåÊØîVIP", "Ëø™ÊãúÁéãÂÆ§ÊàêÂëò", "ÂçéÂ∞îË°óÊäïËµÑ‰∫∫", 
            "Âú∞‰∫ßÂ§ß‰∫®", "‰ΩéË∞ÉÁöÑÊî∂ËóèÂÆ∂", "Êüê‰∏äÂ∏ÇÂÖ¨Âè∏CEO", "Ê∏ØÂ≤õÂêçÂ™õ", "Áü≥Ê≤πÁéãÂ≠ê"];
            npcName = richNames[Math.floor(Math.random() * richNames.length)];
        }
        
        candidate = { name: npcName, type: 'npc' };
    }

    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÈò≤Ëá™Â∑±È°∂Ëá™Â∑±
    // Â¶ÇÊûúÊÉ≥Âá∫‰ª∑ÁöÑ‰∫∫ÔºåÂ∑≤ÁªèÊòØÂΩìÂâçÊúÄÈ´òÂá∫‰ª∑ËÄÖ‰∫ÜÔºåÈÇ£Â∞±‰∏çÂá∫‰∫ÜÔºåÁ≠âÂà´‰∫∫È°∂
    if (auctionState.lastBidder && auctionState.lastBidder.name === candidate.name) {
        return;
    }

    // 4. ÂÜ≥ÂÆöÂä†‰ª∑ÂπÖÂ∫¶
    let increasePercent = 0.05; // ÈªòËÆ§Âä† 5%

    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ3„ÄëNPC Êõ¥ÊúâÈí±ÈÄªËæë
    // Â¶ÇÊûúÊòØ NPCÔºåÊúâ 30% ÁöÑÊ¶ÇÁéá‚ÄúË¥¢Â§ßÊ∞îÁ≤ó‚ÄùÔºåÁõ¥Êé•Âä†‰ª∑ 10%~15%ÔºåÂéãÂà∂ÂÖ®Âú∫
    if (candidate.type === 'npc' && Math.random() < 0.3) {
        increasePercent = 0.15; 
    }

    const newPrice = Math.floor(auctionState.currentPrice * (1 + increasePercent));
    updateAuctionState(newPrice, candidate);
}

// 5. Áî®Êà∑Âá∫‰ª∑ÈÄªËæë
async function placeBid(multiplier) {
    if (!auctionState.isActive) return;

    let bidAmount = 0;
    if (multiplier === 'custom') {
        const input = await showCustomPrompt("ÊâãÂä®Âá∫‰ª∑", "ËæìÂÖ•ÈáëÈ¢ù (‰∏çËÉΩ‰Ωé‰∫éÂΩìÂâç‰ª∑)", auctionState.currentPrice + 100, 'number');
        if (!input) return;
        bidAmount = parseFloat(input);
    } else {
        bidAmount = Math.floor(auctionState.currentPrice * multiplier);
    }

    if (bidAmount <= auctionState.currentPrice) {
        alert("Âá∫‰ª∑ÂøÖÈ°ªÈ´ò‰∫éÂΩìÂâç‰ª∑Ê†ºÔºÅ");
        return;
    }

    // Ê£ÄÊü•‰ΩôÈ¢ù (È¢ÑÊ£ÄÊü•ÔºåËôΩÁÑ∂‰∏çÊâ£Ê¨æÔºå‰ΩÜË¶ÅÈò≤Ê≠¢‰π±ÁÇπ)
    const wallet = await db.userWallet.get('main');
    const totalAssets = wallet.balance + (wallet.kinshipCards || []).reduce((sum, c) => sum + (c.limit - (c.spent||0)), 0);
    
    if (totalAssets < bidAmount) {
        // ÈúáÂä®ÂèçÈ¶à
        if(navigator.vibrate) navigator.vibrate(200);
        showCustomAlert("ËµÑÈáë‰∏çË∂≥", "‰Ω†ÁöÑËµÑ‰∫ßÊÄªÈ¢ù‰∏çË∂≥‰ª•ÊîØ‰ªòÊ≠§‰ª∑Ê†ºÔºÅ");
        return;
    }

    const user = { name: state.qzoneSettings.nickname || 'Êàë', type: 'user', id: 'user' };
    updateAuctionState(bidAmount, user);
}

// ËæÖÂä©ÂáΩÊï∞ÔºöÁªü‰∏ÄÊ∑ªÂä†Êó•Âøó
function addAuctionLog(type, text) {
    const logEl = document.getElementById('auction-log');
    const div = document.createElement('div');
    
    if (type === 'System') {
        div.innerHTML = `<span style="color:#00f3ff; font-weight:bold;">[ÊãçÂçñÂÆò]</span> ${text}`;
    } else {
        div.innerHTML = text; // ÊôÆÈÄöÂá∫‰ª∑Êó•Âøó
    }
    
    if (type === 'bid-me') div.className = 'bid-me';
    if (type === 'bid-friend') div.className = 'bid-friend';
    
    logEl.appendChild(div); // Êîπ‰∏∫ appendChildÔºåÂä†Âú®ÊúÄ‰∏ãÈù¢
    logEl.scrollTop = logEl.scrollHeight;
}

// ‰øÆÊîπÂéüÊúâÁöÑ updateAuctionState
function updateAuctionState(newPrice, bidder) {
    auctionState.currentPrice = newPrice;
    auctionState.lastBidder = bidder;
    auctionState.bidHistory.push(bidder); // ËÆ∞ÂΩï

    // --- Áé©Ê≥ïÂ¢ûÂº∫ÔºöÂä†Êó∂Êú∫Âà∂ ---
    // Â¶ÇÊûúÂâ©‰ΩôÊó∂Èó¥Â∞ë‰∫é 10 ÁßíÔºåÊúâ‰∫∫Âá∫‰ª∑ÂàôÂõûË°ÄÂà∞ 10~15 Áßí
    if (auctionState.timer < 10) {
        const bonusTime = Math.floor(Math.random() * 5) + 10; // ÈöèÊú∫ÂõûË°Ä
        auctionState.timer = bonusTime;
        // ËßÜËßâÂèçÈ¶àÔºöÈáçÁΩÆÂñäËØùÁä∂ÊÄÅ
        auctioneerState = 0; 
        
        // ËßÜËßâÂèçÈ¶àÔºöÈó™ÁÉÅ‰∏Ä‰∏ãÂÄíËÆ°Êó∂
        const timerEl = document.getElementById('auction-timer');
        timerEl.style.color = '#00ff00'; // ÁªøËâ≤Ë°®Á§∫Êó∂Èó¥Â¢ûÂä†
        setTimeout(() => timerEl.style.color = '#f0ad4e', 300);
        
        addAuctionLog("System", "‚è±Ô∏è Êúâ‰∫∫Âá∫‰ª∑ÔºåÊó∂Èó¥Âª∂ÈïøÔºÅ");
    }

    // Êõ¥Êñ∞‰ª∑Ê†º UI
    const priceEl = document.getElementById('auction-current-price');
    priceEl.textContent = `¬• ${newPrice.toLocaleString()}`;
    priceEl.classList.remove('shake-animation');
    void priceEl.offsetWidth; 
    priceEl.classList.add('shake-animation');

    // ÊûÑÈÄ†Âá∫‰ª∑Êó•ÂøóÂÜÖÂÆπ
    let content = "";
    let logType = "bid-npc";
    
    if (bidder.type === 'user') {
        content = `üö© <b>‰Ω†</b> Âá∫‰ª∑ ¬•${newPrice.toLocaleString()}`;
        logType = "bid-me";
        // ÈúáÂä®ÂèçÈ¶à (Â¶ÇÊûúËÆæÂ§áÊîØÊåÅ)
        if(navigator.vibrate) navigator.vibrate(50);
    } else if (bidder.type === 'char') {
        content = `üî• <b>${bidder.name}</b> ‰∏æÁâå ¬•${newPrice.toLocaleString()}!`;
        logType = "bid-friend";
    } else {
        content = `${bidder.name} Âá∫‰ª∑ ¬•${newPrice.toLocaleString()}`;
    }
    
    // ÂÜôÂÖ•Êó•Âøó
    const logEl = document.getElementById('auction-log');
    const div = document.createElement('div');
    div.innerHTML = content;
    div.className = logType;
    logEl.appendChild(div); 
    logEl.scrollTop = logEl.scrollHeight;
}

// 7. ÊãçÂçñÁªìÊùüÁªìÁÆó - ‰øÆÂ§çÁâà
async function endAuction() {
    clearInterval(auctionState.timerId);
    clearInterval(auctionState.npcIntervalId);
    auctionState.isActive = false;
    
    const winner = auctionState.lastBidder;
    const finalPrice = auctionState.currentPrice;
    const item = auctionState.item;

    document.getElementById('auction-timer').textContent = "ÁªìÊùü";
    document.getElementById('auction-item-image-container').classList.remove('auction-win-anim');

    // ÊÉÖÂÜµ1ÔºöÊ†πÊú¨Ê≤°‰∫∫Âá∫‰ª∑ÔºàÊµÅÊãçÔºâ
    if (!winner) {
        await showCustomAlert("ÊãçÂçñÁªìÊùü", "Êó†‰∫∫Âá∫‰ª∑ÔºåËØ•ÊãçÂìÅÂ∑≤ÊµÅÊãç„ÄÇ");
        return;
    }

    // ÊÉÖÂÜµ2ÔºöÁî®Êà∑Ëé∑ËÉú
    if (winner.type === 'user') {
        document.getElementById('auction-item-image-container').classList.add('auction-win-anim');
        
        // Ëé∑ÂèñÈí±ÂåÖ
        const wallet = await db.userWallet.get('main');
        const balance = wallet.balance || 0;
        const kinshipCards = wallet.kinshipCards || [];

        const paymentOptions = [];
        if (balance >= finalPrice) {
            paymentOptions.push({ 
                text: `<span style="color:#1677ff;font-weight:bold;">‰ΩôÈ¢ùÊîØ‰ªò</span> (Ââ©‰Ωô ¬•${balance.toFixed(2)})`, 
                value: 'balance' 
            });
        }
        kinshipCards.forEach(card => {
            const remaining = card.limit - (card.spent || 0);
            if (remaining >= finalPrice) {
                const chat = state.chats[card.chatId];
                paymentOptions.push({
                    text: `<span style="color:#ff5252;font-weight:bold;">‰∫≤Â±ûÂç° - ${chat.name}</span> (Ââ©‰Ωô ¬•${remaining.toFixed(2)})`,
                    value: `kinship_${card.chatId}`
                });
            }
        });

        if (paymentOptions.length === 0) {
             await showCustomAlert("Á´ûÊãçÊàêÂäü‰ΩÜÊîØ‰ªòÂ§±Ë¥•", "‰Ω†Ëµ¢‰∫ÜÁ´ûÊãçÔºå‰ΩÜËµÑÈáë‰∏çË∂≥‰ª•ÊîØ‰ªòÔºÅ");
             return;
        }

        // ÊèêÂçáÂºπÁ™óÂ±ÇÁ∫ß
        document.getElementById('custom-modal-overlay').style.zIndex = 3002;
        const method = await showChoiceModal(`Á´ûÊãçÊàêÂäüÔºÅÊîØ‰ªò ¬•${finalPrice}`, paymentOptions);
        document.getElementById('custom-modal-overlay').style.zIndex = '';
        
        if (!method) {
             await showCustomAlert("‰∫§ÊòìÂèñÊ∂à", "‰Ω†ÊîæÂºÉ‰∫ÜÊîØ‰ªò„ÄÇ");
             return;
        }

        // Êâ£Ê¨æ
        let providerChatId = null;
        if (method === 'balance') {
            await processTransaction(finalPrice, 'expense', `ÈªëÂ∏ÇË¥≠‰π∞-${item.name}`);
        } else {
            // „Äê‰øÆÂ§ç„Äë‰ΩøÁî® replace ÊèêÂèñÂÆåÊï¥ÁöÑ chatId (‰æãÂ¶Ç chat_123456)
            const chatId = method.replace('kinship_', ''); 
            
            providerChatId = chatId;
            const cardIndex = wallet.kinshipCards.findIndex(c => c.chatId === chatId);
            
            if (cardIndex > -1) {
                // 1. Êõ¥Êñ∞È¢ùÂ∫¶
                wallet.kinshipCards[cardIndex].spent = (wallet.kinshipCards[cardIndex].spent || 0) + finalPrice;
                await db.userWallet.put(wallet);
                
                // 2. ÂÜôÂÖ•Ë¥¶Âçï
                await db.userTransactions.add({
                    timestamp: Date.now(),
                    type: 'expense',
                    amount: finalPrice,
                    description: `‰∫≤Â±ûÂç°ÈªëÂ∏Ç-${item.name}`
                });
                
                console.log(`[ÈªëÂ∏Ç] ‰∫≤Â±ûÂç°Êâ£Ê¨æÊàêÂäü: -${finalPrice}`);
            } else {
                console.error(`[ÈªëÂ∏Ç] Êâ£Ê¨æÂ§±Ë¥•ÔºöÊâæ‰∏çÂà∞ID‰∏∫ ${chatId} ÁöÑ‰∫≤Â±ûÂç°`);
                alert("ÊîØ‰ªòÂºÇÂ∏∏ÔºöÊú™ÊâæÂà∞ÂØπÂ∫îÁöÑ‰∫≤Â±ûÂç°ËÆ∞ÂΩï„ÄÇ");
                return;
            }
        }

        // ÂÖ•Â∫ì
        await db.inventory.add({
            name: item.name,
            type: 'treasure',
            description: item.description,
            image: item.image_prompt,
            acquiredPrice: finalPrice,
            acquiredTime: Date.now()
        });

        const giftConfirmed = await showCustomConfirm(
            "Á´ûÊãçÊàêÂäüÔºÅ", 
            `‰Ω†Â∑≤ÊàêÂäüÊãç‰∏ã„Äê${item.name}„ÄëÔºÅ\n\nË¶ÅÁé∞Âú®Â∞±ÊääÂÆÉ‰Ωú‰∏∫Á§ºÁâ©ÔºåÈÄÅÁªôÊüê‰ΩçËßíËâ≤ÂêóÔºü`,
            { confirmText: 'üéÅ Á´ãÂç≥Ëµ†ÈÄÅ', cancelText: 'ÊîæÂÖ•‰ªìÂ∫ì' }
        );

        if (giftConfirmed) {
            await openAuctionGiftSelector(item, finalPrice);
        } else {
            await showCustomAlert("Â∑≤ÂÖ•Â∫ì", "Áâ©ÂìÅÂ∑≤ÂÆâÂÖ®Â≠òÂÖ•‰Ω†ÁöÑÂ∫ìÂ≠ò„ÄÇ");
        }

        // Ëß¶ÂèëËÆ∞ÂøÜÂíåÈÄöÁü•
        if (providerChatId) {
            const providerChat = state.chats[providerChatId];
            if (providerChat) {
                const msg = {
                    role: 'system',
                    content: `[Ê∂àË¥πÈÄöÁü•ÔºöÁî®Êà∑‰ΩøÁî®‰Ω†ÁöÑ‰∫≤Â±ûÂç°Âú®ÈªëÂ∏ÇÊãçÂçñË°åÊ∂àË¥π‰∫Ü ¬•${finalPrice}ÔºåË¥≠‰π∞‰∫Ü‚Äú${item.name}‚Äù„ÄÇ]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                providerChat.history.push(msg);
                await db.chats.put(providerChat);
            }
        }
        
        // ÈÄöÁü•Âú®Âú∫ÁöÑÁÜü‰∫∫
        const uniqueBidders = [...new Set(auctionState.bidHistory.filter(b => b.type === 'char').map(b => b.id))];
        for (const charId of uniqueBidders) {
            if (charId === providerChatId) continue;
            const char = state.chats[charId];
            if (char) {
                const msg = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÂú®ÂàöÊâçÁöÑÈªëÂ∏ÇÊãçÂçñ‰∏≠ÔºåÁî®Êà∑‰ª• ¬•${finalPrice} ÁöÑ‰ª∑Ê†ºÂáªË¥•‰∫ÜÂú®Âú∫ÁöÑÁ´ûÊãçËÄÖÔºàÂåÖÊã¨‰Ω†ÔºâÔºåËµ¢Âæó‰∫Ü‚Äú${item.name}‚Äù„ÄÇ]`,
                    timestamp: Date.now(),
                    isHidden: true
                };
                char.history.push(msg);
                await db.chats.put(char);
            }
        }

    } else {
        // --- Char Êàñ NPC Ëé∑ËÉú ---
        
        if (winner.type === 'char') {
            // Â¶ÇÊûúÊòØÊàë‰ª¨ÁöÑËßíËâ≤Ëµ¢‰∫Ü
            const chat = state.chats[winner.id];
            if (chat) {
                await showCustomAlert("Á´ûÊãçÁªìÊùü", `ÊÅ≠ÂñúÔºÅÊÇ®ÁöÑÂ•ΩÂèã„Äê${winner.name}„Äë‰ª• ¬•${finalPrice.toLocaleString()} ÊàêÂäüÊãçÂæóÂÆùÁâ©ÔºÅ`);
                
                // Ëß¶Âèë AI ÂÜ≥Á≠ñÔºöÊòØÂê¶ÈÄÅÁªôÁî®Êà∑
                // Êàë‰ª¨‰∏çÁõ¥Êé•ÂºπÁ™óÈóÆÁî®Êà∑ÔºåËÄåÊòØÂèëÈÄÅ‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÁªô AIÔºåËÆ© AI Ëá™Â∑±ÂÜ≥ÂÆö
                const systemPrompt = `
                [Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöÂú®ÊãçÂçñ‰ºö‰∏äÊñ•ËµÑ ¬•${finalPrice.toLocaleString()} Êãç‰∏ã‰∫Ü‚Äú${item.name}‚Äù(${item.description})„ÄÇ
                ËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏éÁî®Êà∑ÁöÑÂÖ≥Á≥ªÔºåÂÜ≥ÂÆöÊÄé‰πàÂ§ÑÁêÜËøô‰∏™Áâ©ÂìÅ„ÄÇ
                ‰Ω†ÂèØ‰ª•Ôºö
                1. ÈÄÅÁªôÁî®Êà∑‰Ωú‰∏∫ÊÉäÂñú (‰ΩøÁî® 'gift' Êåá‰ª§)„ÄÇ
                2. Ëá™Â∑±Êî∂ËóèÔºåÂπ∂ÂêëÁî®Êà∑ÁÇ´ËÄÄ (‰ΩøÁî® 'text' Êàñ 'ai_image' Êåá‰ª§)„ÄÇ
                3. Êä±ÊÄ®Â§™Ë¥µ‰∫Ü (‰ΩøÁî® 'text' Êåá‰ª§)„ÄÇ
                ËØ∑ÂºÄÂßã‰Ω†ÁöÑË°®Êºî„ÄÇ]
                `;
                
                chat.history.push({
                    role: 'system',
                    content: systemPrompt,
                    timestamp: Date.now(),
                    isHidden: true
                });
                await db.chats.put(chat);
                
                // Â¶ÇÊûúÂΩìÂâçÊ≤°Âú®ËÅäÂ§©ÁïåÈù¢ÔºåÂ∞±‰∏çÂº∫Âà∂Ë∑≥ËΩ¨ÔºåÂè™Âú®ÂêéÂè∞Ëß¶Âèë
                // Â¶ÇÊûúÊÉ≥Êõ¥ÊòéÊòæÔºåÂèØ‰ª•Âº∫Âà∂Ë∑≥ËΩ¨Ôºö
                const confirmJump = await showCustomConfirm("ÂéªÁúãÁúãÔºü", `${winner.name} ‰ºº‰πéÊúâËØùÂØπ‰Ω†ËØ¥„ÄÇ`, {confirmText:"ÂâçÂæÄËÅäÂ§©"});
                if (confirmJump) {
                    openChat(winner.id);
                    triggerAiResponse(); // Ëß¶Âèë AI ÂõûÂ§ç
                } else {
                    // Âè™ÊòØÂêéÂè∞Ëß¶ÂèëÔºå‰∏ãÊ¨°ËøõËÅäÂ§©ËÉΩÁúãÂà∞
                    // Ê≥®ÊÑèÔºöËøôÈáåÈúÄË¶ÅÊâãÂä®Ë∞ÉÁî®‰∏ÄÊ¨° APIÔºå‰ΩÜÂõ†‰∏∫‰∏çÂú®ËÅäÂ§©ÁïåÈù¢ÔºåÂèØËÉΩÈúÄË¶ÅË∞®ÊÖéÂ§ÑÁêÜ
                    // ÁÆÄÂçïËµ∑ËßÅÔºåÂª∫ËÆÆÂ∞±Áî®‰∏äÈù¢ÁöÑË∑≥ËΩ¨ÈÄªËæë
                }
            }
        } else {
            // Á∫ØË∑Ø‰∫∫ NPC Ëµ¢‰∫Ü
            await showCustomAlert("ÊãçÂçñÁªìÊùü", `ÂæàÈÅóÊÜæÔºåË¢´„Äê${winner.name}„Äë‰ª• ¬•${finalPrice.toLocaleString()} ÊãçËµ∞‰∫Ü„ÄÇ`);
        }
    }
}
// Êñ∞Â¢ûÔºöÊâìÂºÄÈÄÅÁ§ºÂØπË±°ÈÄâÊã©Âô® (ÊªöÂä®ÂàóË°®‰øÆÂ§çÁâà)
async function openAuctionGiftSelector(item, price) {
    const characters = Object.values(state.chats).filter(c => !c.isGroup);
    if (characters.length === 0) return alert("Ê≤°ÊúâÂèØËµ†ÈÄÅÁöÑËßíËâ≤");

    // Ëé∑ÂèñÊ®°ÊÄÅÊ°ÜÂÖÉÁ¥†
    const modal = document.getElementById('custom-modal-overlay');
    const titleEl = document.getElementById('custom-modal-title');
    const bodyEl = document.getElementById('custom-modal-body');
    const footerEl = document.querySelector('#custom-modal .custom-modal-footer');

    // 1. ËÆæÁΩÆÊ†áÈ¢ò
    titleEl.textContent = `Â∞Ü‚Äú${item.name}‚ÄùÈÄÅÁªô...`;

    // 2. ÈáçÁΩÆ Footer Ê†∑Âºè (Ê∏ÖÈô§‰πãÂâç showChoiceModal ÂèØËÉΩÁïô‰∏ãÁöÑÂàÜÈ°µÊåâÈíÆÂíåÊ†∑Âºè)
    footerEl.innerHTML = '';
    footerEl.style.flexDirection = 'row'; // ÊÅ¢Â§çÊ®™ÂêëÂ∏ÉÂ±Ä
    footerEl.style.justifyContent = 'center';
    footerEl.style.maxHeight = ''; // Ê∏ÖÈô§È´òÂ∫¶ÈôêÂà∂
    footerEl.style.overflowY = ''; // Ê∏ÖÈô§ÊªöÂä®

    // Ê∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂèñÊ∂àÊåâÈíÆ
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'ÂèñÊ∂à';
    cancelBtn.style.color = '#666';
    cancelBtn.onclick = () => modal.classList.remove('visible');
    footerEl.appendChild(cancelBtn);

    // 3. ÊûÑÂª∫ÊªöÂä®ÂàóË°® (Ê∏≤ÊüìÂú® Body ‰∏≠)
    bodyEl.innerHTML = '';
    
    const listContainer = document.createElement('div');
    // Ê†∑ÂºèÔºöÊúÄÂ§ßÈ´òÂ∫¶ÈôêÂà∂ + ÂûÇÁõ¥ÊªöÂä®
    listContainer.style.cssText = `
        max-height: 60vh; 
        overflow-y: auto; 
        display: flex; 
        flex-direction: column; 
        text-align: left;
        margin: 0 -16px; /* ÊäµÊ∂à modal-body ÁöÑÂÜÖËæπË∑ùÔºåËÆ©ÂàóË°®Ë¥¥Ëæπ */
        border-top: 1px solid #eee;
    `;

    // ÊåâÂêçÁß∞ÊéíÂ∫èÔºåÊñπ‰æøÊü•Êâæ
    characters.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

    characters.forEach(char => {
        const row = document.createElement('div');
        // Âçï‰∏™ÈÄâÈ°πÊ†∑Âºè
        row.style.cssText = `
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        `;
        
        const avatar = char.settings.aiAvatar || defaultAvatar;
        
        row.innerHTML = `
            <img src="${avatar}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 1px solid #eee;">
            <div style="flex-grow: 1;">
                <div style="font-weight: 500; font-size: 16px; color: var(--text-primary);">${char.name}</div>
            </div>
            <div style="color: #ccc;">‚Ä∫</div>
        `;

        // ÁÇπÂáª‰∫ã‰ª∂
        row.onclick = async () => {
            // ËßÜËßâÂèçÈ¶à
            row.style.backgroundColor = '#f0f0f0';
            setTimeout(async () => {
                modal.classList.remove('visible');
                await sendAuctionGiftToChat(char.id, item, price);
            }, 100);
        };

        listContainer.appendChild(row);
    });

    bodyEl.appendChild(listContainer);
    
    // 4. ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.classList.add('visible');
}

// Êñ∞Â¢ûÔºöÂèëÈÄÅÁ§ºÁâ©Ê∂àÊÅØÂà∞ËÅäÂ§©
async function sendAuctionGiftToChat(chatId, item, price) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. ÊûÑÈÄ†Á§ºÁâ©ÂõæÁâáURL
    // Â¶ÇÊûúÊòØ AI ÁîüÁöÑÂõæÔºåÂ∞ùËØïÊèêÂèñ prompt ÈáçÊñ∞ÊûÑÈÄ†ÈìæÊé•ÔºåÊàñËÄÖÁõ¥Êé•Áî®ÈªòËÆ§Âõæ
    let imageUrl = 'https://i.postimg.cc/Hs7BLh76/alipay.png'; 
    if (item.image_prompt) {
        imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image_prompt)}`;
    }

    // 2. ÊûÑÈÄ†Á§ºÁâ©Ê∂àÊÅØ
    const giftMessage = {
        role: 'user',
        type: 'gift',
        timestamp: Date.now(),
        items: [{
            name: `[Á®Ä‰∏ñÁèçÂÆù] ${item.name}`,
            price: price,
            imageUrl: imageUrl,
            quantity: 1
        }],
        total: price,
        recipients: null // ÂçïËÅä‰∏çÈúÄË¶Å recipients
    };

    chat.history.push(giftMessage);

    // 3. Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ÔºåËÆ©AIÁü•ÈÅìËøôÊòØÂàöÊãç‰∏ãÊù•ÁöÑ
    const hiddenMessage = {
        role: 'system',
        content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÂú®ÈªëÂ∏ÇÊãçÂçñ‰ºö‰∏äÔºåÊñ•Â∑®ËµÑÔºà¬•${price.toLocaleString()}ÔºâÊãç‰∏ã‰∫ÜÁ®Ä‰∏ñÁèçÂÆù‚Äú${item.name}‚ÄùÂπ∂Áõ¥Êé•ÈÄÅÁªô‰∫Ü‰Ω†„ÄÇÁâ©ÂìÅÊèèËø∞Ôºö${item.description}„ÄÇËøôÊòØÊûÅÂÖ∂Ë¥µÈáçÁöÑÁ§ºÁâ©ÔºåËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂÅöÂá∫Âº∫ÁÉàÁöÑÂèçÂ∫îÔºàÊÉäËÆ∂„ÄÅÊÑüÂä®„ÄÅÊàñÊòØË¥£ÊÄ™‰π±Ëä±Èí±Ôºâ„ÄÇ]`,
        timestamp: Date.now() + 1,
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    await db.chats.put(chat);

    // 4. Ë∑≥ËΩ¨Âπ∂Ëß¶Âèë AI ÂõûÂ§ç
    await showCustomAlert("Ëµ†ÈÄÅÊàêÂäü", `Á§ºÁâ©Â∑≤ÈÄÅËææÁªô ${chat.name}ÔºÅÊ≠£Âú®ÂâçÂæÄËÅäÂ§©ÁïåÈù¢...`);
    
    // ÂàáÊç¢Â±èÂπï
    showScreen('chat-list-screen'); // ÂÖàÂàáÂà∞ÂàóË°®Âà∑Êñ∞Áä∂ÊÄÅ
    setTimeout(() => {
        openChat(chatId); // ÊâìÂºÄËÅäÂ§©
        triggerAiResponse(); // Ëß¶Âèë AI ÂõûÂ§ç
    }, 300);
}
// ËæÖÂä©ÔºöËÆ∞ÂΩïÂá∫‰ª∑ÂéÜÂè≤
const originalUpdateAuctionState = updateAuctionState;
updateAuctionState = function(newPrice, bidder) {
    auctionState.bidHistory.push(bidder); // ËÆ∞ÂΩïÊâÄÊúâÂá∫‰ª∑ËÄÖ
    originalUpdateAuctionState(newPrice, bidder); // Ë∞ÉÁî®ÂéüÈÄªËæë
}
window.openAuctionScreen = openAuctionScreen;
window.generateNewAuctionItem = generateNewAuctionItem;
window.placeBid = placeBid;
// --- ÈªëÂ∏Ç‰ªìÂ∫ìÂäüËÉΩ ---

// 1. ÊâìÂºÄ‰ªìÂ∫ì
async function openInventoryModal() {
    const modal = document.getElementById('inventory-modal');
    const listEl = document.getElementById('inventory-list');
    
    modal.classList.add('visible');
    listEl.innerHTML = '<div class="spinner"></div>'; // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª

    try {
        // ‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñËóèÂìÅÔºåÊåâÊó∂Èó¥ÂÄíÂ∫è
        const items = await db.inventory.orderBy('acquiredTime').reverse().toArray();
        
        listEl.innerHTML = '';
        if (items.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; color:#666; margin-top:50px;">‰ªìÂ∫ìÁ©∫Á©∫Â¶Ç‰πü<br>Âø´ÂéªÁ´ûÊãçÁÇπÂ•Ω‰∏úË•øÂêß</div>';
            return;
        }

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'inventory-item';
            
            // ÂõæÁâáÂ§ÑÁêÜÔºöÂÖºÂÆπ Pollinations ÂíåÊôÆÈÄö URL
            let imageUrl = 'https://i.postimg.cc/Hs7BLh76/alipay.png'; 
            if (item.image) {
                if (item.image.startsWith('http') || item.image.startsWith('data:')) {
                     imageUrl = item.image;
                } else {
                     // Â¶ÇÊûúÊòØ promptÔºåËΩ¨Êç¢ÊàêÈìæÊé•
                     imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(item.image)}`;
                }
            }

            div.innerHTML = `
                <img src="${imageUrl}" class="inventory-img" loading="lazy">
                <div class="inventory-info">
                    <div class="inventory-name">${item.name}</div>
                    <div class="inventory-desc">${item.description || 'Á®Ä‰∏ñÁèçÂÆù'}</div>
                    <div class="inventory-price">ÂÖ•Êâã‰ª∑: ¬•${(item.acquiredPrice || 0).toLocaleString()}</div>
                </div>
                <button class="inventory-use-btn">Ëµ†ÈÄÅ</button>
            `;

            // ÁªëÂÆöËµ†ÈÄÅÊåâÈíÆ
            const btn = div.querySelector('.inventory-use-btn');
            btn.onclick = () => handleGiftFromInventory(item);

            listEl.appendChild(div);
        });

    } catch (e) {
        console.error(e);
        listEl.innerHTML = '<div style="text-align:center; color:#ff3b30;">Âä†ËΩΩÂ§±Ë¥•</div>';
    }
}

// 2. ÂÖ≥Èó≠‰ªìÂ∫ì
function closeInventoryModal() {
    document.getElementById('inventory-modal').classList.remove('visible');
}

// 3. ‰ªé‰ªìÂ∫ìËµ†ÈÄÅ
async function handleGiftFromInventory(item) {
    // ÂÖ≥Èó≠‰ªìÂ∫ìÂºπÁ™ó
    closeInventoryModal();

    // ÊûÑÈÄ†Ëµ†ÈÄÅÂØπË±°
    const giftItem = {
        name: item.name,
        description: item.description,
        image_prompt: item.image 
    };

    // Ë∞ÉÁî®Áé∞ÊúâÁöÑËµ†ÈÄÅÈÄâÊã©Âô® (Â§çÁî® openAuctionGiftSelector)
    // ‰º†ÂÖ•ÂÖ•Êâã‰ª∑‰Ωú‰∏∫Á§ºÁâ©ÁöÑ‰ª∑ÂÄº
    await openAuctionGiftSelector(giftItem, item.acquiredPrice || 9999);
}

// Êö¥Èú≤ÁªôÂÖ®Â±Ä‰ΩøÁî®
window.openInventoryModal = openInventoryModal;
window.closeInventoryModal = closeInventoryModal;
// === ÂÆåÊï¥Áâà playSynthScore ÂáΩÊï∞ (ÊîØÊåÅËäÇÂ•è + ÂÖ®‰πêÂô®) ===
let globalPolySynth = null;

async function playSynthScore(btnElement, notesJson, instrumentType = 'piano') {
    let notes = [];
    try {
        // 1. Ëß£Êûê‰πêË∞±Êï∞ÊçÆ
        // ÂÖºÂÆπÊóßÁâàÁ∫ØÂ≠óÁ¨¶‰∏≤Êï∞ÁªÑ ["C4", "E4"] ÂíåÊñ∞ÁâàÂØπË±°Êï∞ÁªÑ [{"n":"C4","d":"4n"}]
        const rawNotes = (typeof notesJson === 'string') ? JSON.parse(notesJson) : notesJson;
        
        // Áªü‰∏ÄÊ†ºÂºèÂåñ‰∏∫Êñ∞ÁâàÂØπË±° {n: Èü≥È´ò, d: Êó∂Èïø}
        notes = rawNotes.map(item => {
            if (typeof item === 'string') {
                return { n: item, d: '8n' }; // ÊóßÁâàÊï∞ÊçÆÈªòËÆ§8ÂàÜÈü≥Á¨¶
            }
            return { n: item.n, d: item.d || '4n' }; // Êñ∞ÁâàÊï∞ÊçÆÔºåÈªòËÆ§4ÂàÜÈü≥Á¨¶
        });

    } catch(e) { console.error("‰πêË∞±Ëß£ÊûêÂ§±Ë¥•", e); return; }

    if (!notes || notes.length === 0) return;

    // 2. ÂêØÂä®Èü≥È¢ëÂºïÊìé
    await Tone.start();

    // ÂàùÂßãÂåñÂêàÊàêÂô® (Âçï‰æãÊ®°Âºè)
    if (!globalPolySynth) {
        globalPolySynth = new Tone.PolySynth(Tone.Synth).toDestination();
    }
    
    // ÈáçÁΩÆÂü∫Á°ÄÈü≥Èáè
    globalPolySynth.volume.value = -8;

    // 3. ÈÖçÁΩÆ‰πêÂô®Èü≥Ëâ≤ (Switch Case)
    switch (instrumentType) {
        case 'chiptune': // 8-bit Ê∏∏ÊàèÈ£é
            globalPolySynth.set({
                oscillator: { type: "square" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 }
            });
            break;
            
        case 'synth': // ÁîµÂ≠êÂêàÊàêÂô®
            globalPolySynth.set({
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.4, release: 2 }
            });
            break;

        case 'guitar': // Âêâ‰ªñ (Ê∏ÖËÑÜÊã®Âº¶)
            globalPolySynth.set({
                oscillator: { type: "triangle" }, 
                envelope: { 
                    attack: 0.01, decay: 0.3, sustain: 0.1, release: 1.0 
                }
            });
            globalPolySynth.volume.value = -5; // Ë°•ÂÅøÈü≥Èáè
            break;

        case 'violin': // Â∞èÊèêÁê¥ (ÁºìÊÖ¢Ëµ∑Èü≥ÔºåÁªµÈïøÂª∂Èü≥)
            globalPolySynth.set({
                oscillator: { type: "sawtooth" },
                envelope: { 
                    attack: 0.2, decay: 0.1, sustain: 0.8, release: 1.5 
                }
            });
            globalPolySynth.volume.value = -10; // Âº¶‰πêËæÉÂìçÔºåÈôç‰ΩéÈü≥Èáè
            break;

        case 'flute': // Á¨õÂ≠ê (Á∫ØÂáÄÊ≠£Âº¶Ê≥¢)
            globalPolySynth.set({
                oscillator: { type: "sine" },
                envelope: { 
                    attack: 0.1, decay: 0.1, sustain: 0.9, release: 0.5 
                }
            });
            break;

        case 'guzheng': // Âè§Á≠ù (Â∞ñÈîêÊã®Âº¶ÔºåÂø´ÈÄüË°∞Âáè)
            globalPolySynth.set({
                oscillator: { type: "triangle" },
                envelope: { 
                    attack: 0.005, decay: 0.4, sustain: 0, release: 1.5 
                }
            });
            globalPolySynth.volume.value = -5;
            break;

        case 'kalimba': // ÊãáÊåáÁê¥ (ÂèØÁà±ÔºåÁ©∫ÁÅµ)
            globalPolySynth.set({
                oscillator: { type: "sine" },
                envelope: { 
                    attack: 0.001, decay: 0.1, sustain: 0, release: 1.2 
                }
            });
            break;

        case 'piano': // ÈªòËÆ§Èí¢Áê¥
        default:
            globalPolySynth.set({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 }
            });
            break;
    }

    // 4. Êõ¥Êñ∞ UI Áä∂ÊÄÅ
    btnElement.textContent = "‚ùö‚ùö";
    btnElement.classList.add('playing');
    btnElement.disabled = true;

    // 5. „ÄêÊ†∏ÂøÉ„ÄëÊåâËäÇÂ•èÊí≠ÊîæÈÄªËæë
    const now = Tone.now();
    let accumulatedTime = 0; // Á¥ØËÆ°Êó∂Èó¥ËΩ¥ÔºåÁî®‰∫éËÆ°ÁÆó‰∏ã‰∏Ä‰∏™Èü≥Á¨¶ÁöÑÊí≠ÊîæÊó∂Èó¥ÁÇπ

    notes.forEach((noteObj) => {
        // ÁÆÄÂçïÁöÑÊ≠£ÂàôÊ£ÄÊü•Èü≥Á¨¶Ê†ºÂºè (Â¶Ç C4, D#5)
        if (noteObj.n && /^[A-G][#b]?[0-9]$/.test(noteObj.n)) {
            // ËÆ°ÁÆóÂΩìÂâçÈü≥Á¨¶ÁöÑÊó∂Èïø (Áßí)
            const durationInSeconds = Tone.Time(noteObj.d).toSeconds();
            
            // Âú®ÂΩìÂâçÁ¥ØËÆ°ÁöÑÊó∂Èó¥ÁÇπËß¶ÂèëÂ£∞Èü≥
            // triggerAttackRelease(Èü≥È´ò, ÊåÅÁª≠Êó∂Èó¥, Ëß¶ÂèëÊó∂Èó¥ÁÇπ)
            globalPolySynth.triggerAttackRelease(noteObj.n, noteObj.d, now + accumulatedTime);
            
            // Á¥ØÂä†Êó∂Èó¥ÔºåËÆ©‰∏ã‰∏Ä‰∏™Èü≥Á¨¶ÊéíÂú®ÂêéÈù¢
            accumulatedTime += durationInSeconds;
        }
    });

    // 6. Êí≠ÊîæÁªìÊùüÈáçÁΩÆ
    // Á≠âÂæÖÊÄªÊó∂Èïø + 0.5Áßí‰ΩôÈü≥ÂêéÔºåÊÅ¢Â§çÊåâÈíÆ
    setTimeout(() => {
        btnElement.textContent = "‚ñ∂";
        btnElement.classList.remove('playing');
        btnElement.disabled = false;
    }, accumulatedTime * 1000 + 500);
}
// Êö¥Èú≤ÁªôÂÖ®Â±Ä
window.playSynthScore = playSynthScore;
// --- To-Do List ÈÄªËæëÂºÄÂßã ---

function getTodoDateString(date) {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
}

async function openTodoList() {
    if (!state.activeChatId) return;
    
    // ÈáçÁΩÆÂà∞‰ªäÂ§©
    currentTodoDate = new Date();
    updateTodoDateDisplay();
    await renderTodoList();
    
    showScreen('todo-list-screen');
}

function updateTodoDateDisplay() {
    const displayEl = document.getElementById('todo-current-date-display');
    const now = new Date();
    const dateStr = getTodoDateString(currentTodoDate);
    const todayStr = getTodoDateString(now);
    
    if (dateStr === todayStr) {
        displayEl.textContent = "‰ªäÂ§©";
    } else {
        displayEl.textContent = dateStr;
    }
}

function changeTodoDate(days) {
    currentTodoDate.setDate(currentTodoDate.getDate() + days);
    updateTodoDateDisplay();
    renderTodoList();
}

// 1. ‰øÆÊîπ renderTodoList
async function renderTodoList() {
    const container = document.getElementById('todo-list-container');
    container.innerHTML = '';
    
    const chat = state.chats[state.activeChatId];
    if (!chat) return;
    
    const targetDateStr = getTodoDateString(currentTodoDate);
    const todos = chat.todoList || [];
    
    // Á≠õÈÄâÂΩìÂ§©ÁöÑ‰ªªÂä°
    const dayTodos = todos.filter(t => t.date === targetDateStr);
    
    // ÊéíÂ∫è
    dayTodos.sort((a, b) => {
        if (a.status === b.status) {
            return (a.time || '00:00').localeCompare(b.time || '00:00');
        }
        return a.status === 'completed' ? 1 : -1;
    });

    if (dayTodos.length === 0) {
        container.innerHTML = `<div class="todo-empty-state">üìÖ ${targetDateStr}<br>ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π</div>`;
        return;
    }

    // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÂ≠òÂÖ•ÁºìÂ≠òÔºåÈáçÁΩÆËÆ°Êï∞ÔºåË∞ÉÁî®ÂàÜÊâπÂä†ËΩΩ ---
    todoCache = dayTodos;
    todoRenderCount = 0;
    loadMoreTodos();
}

// 2. Êñ∞Â¢û loadMoreTodos
function loadMoreTodos() {
    if (isLoadingMoreTodos) return;

    const container = document.getElementById('todo-list-container');
    if (!container) return;

    if (todoRenderCount >= todoCache.length) return;

    isLoadingMoreTodos = true;
    const BATCH_SIZE = 30; // ÊØèÊ¨°Âä†ËΩΩ30Êù°
    const nextSliceEnd = todoRenderCount + BATCH_SIZE;
    const itemsToRender = todoCache.slice(todoRenderCount, nextSliceEnd);

    const fragment = document.createDocumentFragment();

    itemsToRender.forEach(todo => {
        const item = document.createElement('div');
        const isUser = (todo.creator === 'user' || !todo.creator);
        const creatorClass = isUser ? 'is-user' : 'is-char';
        
        item.className = `todo-item ${todo.status} ${creatorClass}`;
        item.dataset.id = todo.id;
        
        const colorMap = {
            'Êó•Â∏∏': '#8e8e93', 'Â∑•‰Ωú': '#007aff', 'ÈáçË¶Å': '#ff3b30', 
            'ÁîüÊ¥ª': '#34c759', 'Á∫¶‰ºö': '#af52de', 'Â≠¶‰π†': '#ff9500','ËÆ∞Ë¥¶': '#ffc107'
        };
        const tagColor = colorMap[todo.type] || '#8e8e93';

        item.innerHTML = `
            <div class="todo-checkbox"></div>
            <div class="todo-info">
                <div class="todo-content">${escapeHTML(todo.content)}</div>
                <div class="todo-meta">
                    <span class="todo-tag" style="--tag-color: ${tagColor};">${todo.type || 'Êó•Â∏∏'}</span>
                    ${todo.time ? `<span class="todo-time">‚è∞ ${todo.time}</span>` : ''}
                </div>
            </div>
            <button class="todo-delete-btn">√ó</button>
        `;
        
        item.querySelector('.todo-checkbox').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleTodoStatus(todo.id);
        });

        item.querySelector('.todo-delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteTodo(todo.id);
        });
        
        item.addEventListener('click', () => openTodoEditor(todo));

        fragment.appendChild(item);
    });

    container.appendChild(fragment);
    todoRenderCount += itemsToRender.length;
    isLoadingMoreTodos = false;
}

async function toggleTodoStatus(id) {
    const chat = state.chats[state.activeChatId];
    const todo = chat.todoList.find(t => t.id === id);
    
    if (todo) {
        // 1. ÂàáÊç¢Áä∂ÊÄÅ
        const isCompleting = todo.status !== 'completed';
        todo.status = isCompleting ? 'completed' : 'pending';
        
        // 2. „ÄêÊ†∏ÂøÉ„ÄëÂè™‰øùÁïôËÆ∞ÂΩïÁ≥ªÁªüÊèêÁ§∫ÔºåÂà†Èô§‰∫Ü triggerAiResponse
        if (isCompleting) { 
            const myNickname = chat.settings.myNickname || 'Êàë';
            
            // ÊûÑÈÄ†Á≥ªÁªüÊèêÁ§∫ËØçÔºåÂè™‰Ωú‰∏∫ËÆ∞ÂøÜÊ§çÂÖ•
            const systemHint = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑(${myNickname}) ÂàöÂàöÂú®ÂæÖÂäûÊ∏ÖÂçï‰∏≠ÂãæÈÄâÂÆåÊàê‰∫ÜÔºö‚Äú${todo.content}‚Äù„ÄÇ]`;

            // ÊèíÂÖ•ÈöêËóèÊ∂àÊÅØ
            const hiddenMsg = {
                role: 'system',
                content: systemHint,
                timestamp: Date.now(),
                isHidden: true // Áî®Êà∑Áúã‰∏çËßÅÔºåAI‰∏ãÊ¨°ÁîüÊàêÊó∂ËÉΩÁúãËßÅ
            };
            
            chat.history.push(hiddenMsg);
        }

        // 3. ‰øùÂ≠òÂπ∂Âà∑Êñ∞ÁïåÈù¢
        await db.chats.put(chat);
        renderTodoList(); 
    }
}

async function deleteTodo(id) {
    const confirmed = await showCustomConfirm("Âà†Èô§‰∫ãÈ°π", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂæÖÂäû‰∫ãÈ°πÂêóÔºü");
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        chat.todoList = chat.todoList.filter(t => t.id !== id);
        await db.chats.put(chat);
        renderTodoList();
    }
}

function openTodoEditor(todo = null) {
    const modal = document.getElementById('todo-editor-modal');
    const titleEl = document.getElementById('todo-editor-title');
    
    editingTodoId = todo ? todo.id : null;
    titleEl.textContent = todo ? 'ÁºñËæë‰∫ãÈ°π' : 'Ê∑ªÂä†‰∫ãÈ°π';
    
    document.getElementById('todo-content-input').value = todo ? todo.content : '';
    document.getElementById('todo-date-input').value = todo ? todo.date : getTodoDateString(currentTodoDate);
    document.getElementById('todo-time-input').value = todo ? todo.time : '';
    
    // ÈáçÁΩÆÂπ∂ËÆæÁΩÆÁ±ªÂûãÈÄâ‰∏≠
    const typeOptions = document.querySelectorAll('.todo-type-option');
    typeOptions.forEach(opt => opt.classList.remove('active'));
    const targetType = todo ? todo.type : 'Êó•Â∏∏';
    const activeOption = Array.from(typeOptions).find(opt => opt.dataset.value === targetType);
    if (activeOption) activeOption.classList.add('active');
    
    modal.classList.add('visible');
}

async function saveTodo() {
    const content = document.getElementById('todo-content-input').value.trim();
    const date = document.getElementById('todo-date-input').value;
    const time = document.getElementById('todo-time-input').value;
    const typeEl = document.querySelector('.todo-type-option.active');
    const type = typeEl ? typeEl.dataset.value : 'Êó•Â∏∏';

    if (!content || !date) {
        alert("ÂÜÖÂÆπÂíåÊó•Êúü‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat.todoList) chat.todoList = [];

    if (editingTodoId) {
        const todo = chat.todoList.find(t => t.id === editingTodoId);
        if (todo) {
            todo.content = content;
            todo.date = date;
            todo.time = time;
            todo.type = type;
        }
    } else {
        chat.todoList.push({
            id: Date.now(),
            content,
            date,
            time,
            type,
            status: 'pending',
            creator: 'user',
            timestamp: Date.now()
        });
    }

    await db.chats.put(chat);
    
    // Â¶ÇÊûúÊó•ËÆ∞Êó•ÊúüÂèò‰∫ÜÔºåË∑≥ËΩ¨Âà∞ËØ•Êó•Êúü
    const newDate = new Date(date);
    if (!isNaN(newDate.getTime())) {
         currentTodoDate = newDate;
         updateTodoDateDisplay();
    }

    document.getElementById('todo-editor-modal').classList.remove('visible');
    renderTodoList();
}
// --- To-Do List ÈÄªËæëÁªìÊùü ---
// ==========================================
// ‚ñº‚ñº‚ñº ÁªøÊ±ü (Green River) Âêå‰∫∫Âàõ‰ΩúÊ®°Âùó ‚ñº‚ñº‚ñº
// ==========================================

let grState = {
    activeStoryId: null,
    isGenerating: false
};

// ÈªòËÆ§‰ΩúËÄÖÈ¢ÑËÆæ
const DEFAULT_AUTHORS = [
    { name: "ÁªÜËÖªÊÉÖÊÑü", style: "‰æßÈáçÂøÉÁêÜÊèèÂÜôÔºåÊñáÁ¨îÁªÜËÖªÔºåÊìÖÈïøÊçïÊçâ‰∫∫Áâ©Èó¥ÂæÆÂ¶ôÁöÑÊÉÖÊÑüÊµÅÂä®ÔºåÊ∞õÂõ¥ÊÑüÂº∫„ÄÇ", maxOutput: 600 },
    { name: "Ê≠£ÂâßÂâßÊÉÖ", style: "Ê≥®ÈáçÂâßÊÉÖÈÄªËæëÔºåËäÇÂ•èÁ¥ßÂáëÔºåÂØπÁôΩÂπ≤ÁªÉÔºåÊìÖÈïøÊé®Âä®ÊïÖ‰∫ãÊÉÖËäÇÂèëÂ±ï„ÄÇ", maxOutput: 800 },
    { name: "ËΩªÊùæÊó•Â∏∏", style: "ÂπΩÈªòÈ£éË∂£ÔºåËΩªÊùæÊÑâÂø´ÔºåÂ§öÁî®ÁîüÂä®ÁöÑÂØπËØùÂíåÊúâË∂£ÁöÑÁªÜËäÇÊèèÂÜôÔºåÊ≤ªÊÑàÁ≥ª„ÄÇ", maxOutput: 500 },
    { name: "ÊÑèËØÜÊµÅ", style: "Â§ßÈáè‰ΩøÁî®ÈöêÂñªÂíåË±°ÂæÅÔºåÂè•Âºè‰ºòÁæéÂ§çÊùÇÔºåÁùÄÈáç‰∫éÊÑèË±°ÂíåÂì≤Â≠¶ÊÄùËÄÉÔºåÂº±ÂåñÂÖ∑‰ΩìÊÉÖËäÇ„ÄÇ", maxOutput: 400 }
];

// 1. ÂàùÂßãÂåñÊï∞ÊçÆ (Âú® openGreenRiverScreen Êó∂Ë∞ÉÁî®)
async function initGreenRiverData() {
    const count = await db.grAuthors.count();
    if (count === 0) {
        await db.grAuthors.bulkAdd(DEFAULT_AUTHORS);
    }
}

// 2. ÊâìÂºÄ‰∏ªÁïåÈù¢
async function openGreenRiverScreen() {
    await initGreenRiverData();
    showScreen('green-river-screen');
    renderBookList();
}

// 3. Ê∏≤Êüì‰π¶Êû∂
// ÊâæÂà∞ renderBookList ÂáΩÊï∞ÔºåÊõøÊç¢Êï¥‰∏™ÂáΩÊï∞
async function renderBookList() {
    const listEl = document.getElementById('gr-book-list');
    listEl.innerHTML = '';
    
    const stories = await db.grStories.orderBy('lastUpdated').reverse().toArray();
    const authors = await db.grAuthors.toArray();
    const authorMap = new Map(authors.map(a => [a.id, a.name]));
    
    // Ëé∑ÂèñÂ∑≤ÂÖ≥ËÅîÁöÑ‰π¶Á±çIDÈõÜÂêà
    const existingBooks = await db.readingLibrary.toArray();
    const linkedIds = new Set(existingBooks.map(b => b.linkedStoryId).filter(id => id));

    if (stories.length === 0) {
        listEl.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:var(--gr-text-sub); margin-top:50px;">‰π¶Êû∂ÊòØÁ©∫ÁöÑÔºåÁÇπÂáªÂè≥‰∏äËßíÊñ∞Âª∫‰∏ÄÈÉ®‰ΩúÂìÅÂêß„ÄÇ</p>';
        return;
    }

    stories.forEach(story => {
        const authorName = authorMap.get(story.authorId) || 'Êú™Áü•‰ΩúËÄÖ';
        const div = document.createElement('div');
        div.className = 'gr-book-card';
        
        const wordCount = story.chapters.reduce((acc, ch) => acc + ch.content.length, 0);
        
        // „ÄêÊ†∏ÂøÉÈÄªËæë‰øÆÊîπ„Äë
        const isAdded = linkedIds.has(story.id);
        // Â¶ÇÊûúÂ∑≤Âä†ÂÖ•ÔºåÊòæÁ§∫‚ÄúÂ∑≤Âú®‰π¶Êû∂‚ÄùÔºåÁÇπÂáªËß¶ÂèëÁßªÈô§ÔºõÂê¶ÂàôÊòæÁ§∫‚ÄúÂä†ÂÖ•‚ÄùÔºåÁÇπÂáªËß¶ÂèëÂä†ÂÖ•
        const btnText = isAdded ? 'Â∑≤Âú®‰π¶Êû∂' : 'Âä†ÂÖ•ÂÖ±ËØª';
        const btnClass = isAdded ? 'gr-add-shelf-btn added' : 'gr-add-shelf-btn';
        const actionFn = isAdded ? 'removeGreenRiverFromShelf' : 'addGreenRiverToShelf';
        
        div.innerHTML = `
            <div>
                <div class="gr-book-title">${story.title}</div>
                <div class="gr-book-meta">
                    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    ${authorName}
                </div>
            </div>
            <div class="gr-book-meta" style="justify-content: space-between; margin-top:15px; align-items: flex-end;">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <span>${story.chapters.length} Á´†</span>
                    <span>${(wordCount/1000).toFixed(1)}k Â≠ó</span>
                </div>
                <button class="${btnClass}" onclick="event.stopPropagation(); ${actionFn}(${story.id}, this);">
                    ${isAdded ? '‚úì ' : '+ '}${btnText}
                </button>
            </div>
        `;
        
        div.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') openReader(story.id);
        };
        
        addLongPressListener(div, async () => {
             if(confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰ΩúÂìÅ„Ää${story.title}„ÄãÂêóÔºü`)) {
                 await db.grStories.delete(story.id);
                 renderBookList();
             }
        });
        
        listEl.appendChild(div);
    });
}

// 4. ‰ΩúËÄÖÁÆ°ÁêÜ
// --- ÁªøÊ±ü‰ΩúËÄÖÁÆ°ÁêÜÈáçÊûÑ (‰øÆÂ§çÂ∏ÉÂ±ÄÂíåÁºñËæëÂäüËÉΩ) ---

let editingAuthorId = null; // Áî®‰∫éËÆ∞ÂΩïÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑ‰ΩúËÄÖID

// 1. ÊâìÂºÄ‰ΩúËÄÖÁÆ°ÁêÜÂàóË°® (Ê∏≤ÊüìÁïåÈù¢)
async function openAuthorManager() {
    showScreen('gr-author-screen');
    const listEl = document.getElementById('gr-author-list');
    listEl.innerHTML = '';
    
    const authors = await db.grAuthors.toArray();
    
    if (authors.length === 0) {
         listEl.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">ËøòÊ≤°ÊúâËÆæÂÆö‰ΩúËÄÖÔºåÁÇπÂáªÂè≥‰∏äËßí‚Äú+‚ÄùÊ∑ªÂä†„ÄÇ</p>';
         return;
    }

    authors.forEach(author => {
        const div = document.createElement('div');
        div.className = 'gr-author-item';
        div.innerHTML = `
            <div class="gr-author-info" style="flex-grow: 1; padding-right: 10px; min-width: 0;">
                <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: 600; color: #1C1C1E;">${author.name}</h3>
                <p style="margin: 0; font-size: 13px; color: #8E8E93; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.5;">${author.style}</p>
            </div>
            <div class="gr-author-actions">
                <button class="gr-icon-btn" onclick="openAuthorEditor(${author.id})" title="ÁºñËæë">
                   <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="gr-icon-btn" style="color:#ff3b30;" onclick="deleteAuthor(${author.id})" title="Âà†Èô§">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        `;
        listEl.appendChild(div);
    });
}

// 2. ÊâìÂºÄÁºñËæë/Ê∑ªÂä†ÂºπÁ™ó
// Â¶ÇÊûú‰º†ÂÖ• idÔºåÂàôÊòØÁºñËæëÊ®°ÂºèÔºõÂê¶ÂàôÊòØÊ∑ªÂä†Ê®°Âºè
async function openAuthorEditor(id = null) {
    editingAuthorId = id;
    const modal = document.getElementById('gr-author-editor-modal');
    const titleEl = document.getElementById('gr-author-editor-title');
    const nameInput = document.getElementById('gr-author-name-input');
    const styleInput = document.getElementById('gr-author-style-input');

    if (id) {
        // ÁºñËæëÊ®°ÂºèÔºöÂõûÊòæÊï∞ÊçÆ
        const author = await db.grAuthors.get(id);
        if (author) {
            titleEl.textContent = "ÁºñËæë‰ΩúËÄÖ";
            nameInput.value = author.name;
            styleInput.value = author.style;
        }
    } else {
        // Ê∑ªÂä†Ê®°ÂºèÔºöÊ∏ÖÁ©∫Êï∞ÊçÆ
        titleEl.textContent = "Ê∑ªÂä†‰ΩúËÄÖ";
        nameInput.value = "";
        styleInput.value = "";
    }

    modal.classList.add('visible');
}

// 3. ‰øùÂ≠ò‰ΩúËÄÖ (Áî±ÂºπÁ™óÂÜÖÁöÑ‰øùÂ≠òÊåâÈíÆË∞ÉÁî®)
async function saveAuthor() {
    const name = document.getElementById('gr-author-name-input').value.trim();
    const style = document.getElementById('gr-author-style-input').value.trim();

    if (!name || !style) {
        alert("ÂêçÁß∞ÂíåÈ£éÊ†ºÊèèËø∞ÈÉΩ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        return;
    }

    if (editingAuthorId) {
        // Êõ¥Êñ∞
        await db.grAuthors.update(editingAuthorId, { name, style });
    } else {
        // Êñ∞Â¢û
        await db.grAuthors.add({ name, style, maxOutput: 600 });
    }

    // ÂÖ≥Èó≠ÂºπÁ™óÂπ∂Âà∑Êñ∞ÂàóË°®
    document.getElementById('gr-author-editor-modal').classList.remove('visible');
    openAuthorManager();
}

// 4. Âà†Èô§‰ΩúËÄÖ
async function deleteAuthor(id) {
    const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöÂà†Èô§Ëøô‰Ωç‰ΩúËÄÖËÆæÂÆöÂêóÔºü\n(Ëøô‰∏ç‰ºöÂΩ±ÂìçÂ∑≤ÁîüÊàêÁöÑÁ´†ËäÇÂÜÖÂÆπ)", { confirmButtonClass: 'btn-danger' });
    if(confirmed) {
        await db.grAuthors.delete(id);
        openAuthorManager();
    }
}

// 5. ÁªëÂÆöÂ§¥ÈÉ®‚Äú+‚ÄùÊåâÈíÆÂà∞Êñ∞ÁöÑÁºñËæëÂô®ÈÄªËæë
// (Ëøô‰∏™ÂáΩÊï∞Âêç‰∏éHTML‰∏≠ÁöÑonclick="addAuthor()"ÂØπÂ∫îÔºåÊàë‰ª¨Â∞ÜÂÖ∂ÈáçÂÆöÂêëÂà∞openAuthorEditor)
function addAuthor() {
    openAuthorEditor(null);
}

// 6. ÁªëÂÆö‰øùÂ≠òÊåâÈíÆ‰∫ã‰ª∂ (Âú®ÂàùÂßãÂåñÊó∂ÊâßË°å‰∏ÄÊ¨°Âç≥ÂèØÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö)
const saveBtn = document.getElementById('gr-save-author-btn');
if (saveBtn) {
    // ‰ΩøÁî® cloneNode ÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô® (Â¶ÇÊûúÊúâÁöÑËØù)
    const newBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newBtn, saveBtn);
    newBtn.onclick = saveAuthor;
}

// Êö¥Èú≤ÁªôÂÖ®Â±Ä
window.openAuthorManager = openAuthorManager;
window.openAuthorEditor = openAuthorEditor;
window.addAuthor = addAuthor;
window.deleteAuthor = deleteAuthor;

// 5. Êñ∞Âª∫‰ΩúÂìÅ (ËÆæÁΩÆÈ°µ)
async function createNewStory() {
    grState.activeStoryId = null; // Ê†áËÆ∞‰∏∫Êñ∞Âª∫
    document.getElementById('gr-story-title').value = '';
    await loadStorySettingsUI();
    document.getElementById('gr-settings-modal').classList.add('visible');
}

async function openStorySettings() {
    if(!grState.activeStoryId) return;
    const story = await db.grStories.get(grState.activeStoryId);
    if(!story) return;

    document.getElementById('gr-story-title').value = story.title;
    await loadStorySettingsUI(story.settings, story.authorId);
    
    document.getElementById('gr-settings-modal').classList.add('visible');
}

// Âä†ËΩΩËÆæÁΩÆÂºπÁ™ó‰∏≠ÁöÑÈÄâÈ°π
// Âä†ËΩΩËÆæÁΩÆÂºπÁ™ó‰∏≠ÁöÑÈÄâÈ°π (‰øÆÂ§çÁâàÔºöÂ¢ûÂä†Â≠óÊï∞ÂíåÊù°Êï∞ÁöÑÂõûÊòæ)
async function loadStorySettingsUI(settings = {}, selectedAuthorId = null) {
    // 1. Âä†ËΩΩ‰ΩúËÄÖÂàóË°®
    const authorSelect = document.getElementById('gr-author-select');
    authorSelect.innerHTML = '';
    const authors = await db.grAuthors.toArray();
    authors.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        if(selectedAuthorId === a.id) opt.selected = true;
        authorSelect.appendChild(opt);
    });

    // 2. Âä†ËΩΩËßíËâ≤ÂàóË°® (Chats + NPCs)
    const charList = document.getElementById('gr-char-list');
    charList.innerHTML = '';
    const chars = Object.values(state.chats); 
    const npcs = await db.npcs.toArray();
    
    const allEntities = [
        ...chars.map(c => ({ id: c.id, name: c.name, type: c.isGroup ? 'Áæ§ËÅä' : 'ËßíËâ≤' })),
        ...npcs.map(n => ({ id: `npc_${n.id}`, name: n.name, type: 'NPC' }))
    ];

    allEntities.forEach(item => {
        const div = document.createElement('div');
        div.className = 'gr-checkbox-item';
        // ÂõûÊòæÔºöÊ£ÄÊü•ÊòØÂê¶Âú®Â∑≤‰øùÂ≠òÁöÑÂàóË°®‰∏≠
        const isChecked = settings.charIds && settings.charIds.includes(item.id);
        div.innerHTML = `<input type="checkbox" value="${item.id}" ${isChecked?'checked':''}> <span>${item.name} <small style="color:#999">(${item.type})</small></span>`;
        div.onclick = (e) => { if(e.target.tagName!=='INPUT') div.querySelector('input').click(); };
        charList.appendChild(div);
    });

    // 3. Âä†ËΩΩ‰∏ñÁïå‰π¶ÂàóË°®
    const wbList = document.getElementById('gr-worldbook-list');
    wbList.innerHTML = '';
    const books = await db.worldBooks.toArray();
    books.forEach(book => {
        const div = document.createElement('div');
        div.className = 'gr-checkbox-item';
        // ÂõûÊòæÔºöÊ£ÄÊü•ÊòØÂê¶Âú®Â∑≤‰øùÂ≠òÁöÑÂàóË°®‰∏≠
        const isChecked = settings.bookIds && settings.bookIds.includes(book.id);
        div.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked?'checked':''}> <span>${book.name}</span>`;
        div.onclick = (e) => { if(e.target.tagName!=='INPUT') div.querySelector('input').click(); };
        wbList.appendChild(div);
    });
    
    // 4. Âä†ËΩΩUserÈ¢ÑËÆæ
    const userSelect = document.getElementById('gr-user-persona-select');
    userSelect.innerHTML = '<option value="">ÂΩìÂâçÈªòËÆ§</option>';
    const presets = await db.personaPresets.toArray();
    presets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.persona.substring(0, 20) + '...';
        // ÂõûÊòæÔºöÈÄâ‰∏≠Â∑≤‰øùÂ≠òÁöÑ User Persona
        if(settings.userPersonaId === p.id) opt.selected = true;
        userSelect.appendChild(opt);
    });

    // 5. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÂõûÊòæÂ≠óÊï∞Âíå‰∏ä‰∏ãÊñáÊù°Êï∞
    // Â¶ÇÊûú settings ÈáåÊúâÂÄºÔºåÂ∞±Áî® settings ÈáåÁöÑÔºõÂ¶ÇÊûúÊ≤°ÊúâÔºàÊñ∞Âª∫Êó∂ÔºâÔºåÂ∞±Áî®ÈªòËÆ§ÂÄº 500 Âíå 20
    document.getElementById('gr-output-length').value = settings.outputLength || 500;
    document.getElementById('gr-context-limit').value = settings.contextLimit || 20;
    document.getElementById('gr-macro-world-view').value = settings.macroWorldView || '';
    // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
    const saveBtn = document.getElementById('gr-save-story-btn');
    const cancelBtn = document.getElementById('gr-cancel-settings-btn');
    
    // ‰ΩøÁî® cloneNode Ê∏ÖÈô§ÊóßÁöÑÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢Â§öÊ¨°ÁÇπÂáª
    const newSaveBtn = saveBtn.cloneNode(true);
    const newCancelBtn = cancelBtn.cloneNode(true);
    
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

    newSaveBtn.onclick = () => saveStorySettings();
    newCancelBtn.onclick = () => document.getElementById('gr-settings-modal').classList.remove('visible');
}

// 5. ‰øÆÂ§çÁâàÔºö‰øùÂ≠ò‰ΩúÂìÅËÆæÁΩÆ
async function saveStorySettings() {
    // Ëé∑Âèñ DOM ÂÖÉÁ¥†
    const titleInput = document.getElementById('gr-story-title');
    const authorSelect = document.getElementById('gr-author-select');
    const userPersonaSelect = document.getElementById('gr-user-persona-select');
    const outputLengthInput = document.getElementById('gr-output-length'); // Ê£ÄÊü•HTML IDÊòØÂê¶‰∏ÄËá¥
    const contextLimitInput = document.getElementById('gr-context-limit'); // Ê£ÄÊü•HTML IDÊòØÂê¶‰∏ÄËá¥
    const macroWorldViewInput = document.getElementById('gr-macro-world-view');
    const title = titleInput.value.trim();
    const authorId = parseInt(authorSelect.value);
    
    const charIds = Array.from(document.querySelectorAll('#gr-char-list input:checked')).map(cb => cb.value);
    const bookIds = Array.from(document.querySelectorAll('#gr-worldbook-list input:checked')).map(cb => cb.value);
    const userPersonaId = userPersonaSelect.value;
    
    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÁ°Æ‰øùËøôÈáåÂèñÂà∞ÁöÑÊòØÊï∞Â≠óÔºåÂπ∂‰∏îÊúâÈªòËÆ§ÂÄº
    const outputLength = parseInt(outputLengthInput.value) || 500;
    const contextLimit = parseInt(contextLimitInput.value) || 20;
    const macroWorldView = macroWorldViewInput.value.trim();
    if (!title) return alert("ËØ∑ËæìÂÖ•‰π¶Âêç");
    if (charIds.length === 0) return alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤ÊàñÁæ§ËÅä");

    const settings = { 
        charIds, 
        bookIds, 
        userPersonaId, 
        outputLength, // ËøôÈáåÁöÑÂêçÂ≠óË¶ÅÂíå prompt ÈáåÁöÑÂØπÂ∫î
        contextLimit,
        macroWorldView 
    };

    if (grState.activeStoryId) {
        // Êõ¥Êñ∞Áé∞Êúâ‰ΩúÂìÅ
        await db.grStories.update(grState.activeStoryId, { title, authorId, settings });
    } else {
        // Êñ∞Âª∫‰ΩúÂìÅ
        const newStory = {
            title,
            authorId,
            settings,
            chapters: [],
            lastUpdated: Date.now()
        };
        grState.activeStoryId = await db.grStories.add(newStory);
    }
    
    document.getElementById('gr-settings-modal').classList.remove('visible');
    
    // ÊâìÂºÄÈòÖËØªÂô®ÔºåÂπ∂ÂÆö‰ΩçÂà∞ÊúÄÊñ∞‰∏ÄÁ´†
    const story = await db.grStories.get(grState.activeStoryId);
    const lastIndex = Math.max(0, story.chapters.length - 1);
    openReader(grState.activeStoryId, lastIndex);
}

// 6. ÈòÖËØªÂô®ÈÄªËæë - ÂàÜÈ°µÁâà (Jinjiang Style)
async function openReader(storyId, chapterIndex = 0) {
    grState.activeStoryId = storyId;
    const story = await db.grStories.get(storyId);
    if (!story) return;

    // Á°Æ‰øùÁ¥¢ÂºïÂêàÊ≥ï
    const totalChapters = story.chapters.length;
    if (totalChapters > 0 && chapterIndex >= totalChapters) chapterIndex = totalChapters - 1;
    if (chapterIndex < 0) chapterIndex = 0;
    
    grState.currentChapterIndex = chapterIndex;

    // Êõ¥Êñ∞È°∂ÈÉ®Ê†áÈ¢ò
    document.getElementById('gr-book-name-display').textContent = story.title;
    
    const contentArea = document.getElementById('gr-reader-content');
    contentArea.innerHTML = '';

    // --- Âú∫ÊôØ A: Â∞öÊú™ÂºÄÂßã (Ê≤°ÊúâÁ´†ËäÇ) ---
    if (totalChapters === 0) {
        document.getElementById('gr-chapter-title-display').textContent = "Â∫èÁ´†";
        contentArea.innerHTML = `
            <div style="text-align:center; padding-top:100px; color:#888;">
                <p>ÊïÖ‰∫ãÂ∞öÊú™ÂºÄÂßã„ÄÇ</p>
                <p>ËØ∑Âú®‰∏ãÊñπËæìÂÖ•Á¨¨‰∏ÄÁ´†ÁöÑÂâßÊÉÖËµ∞ÂêëÔºåÁÇπÂáª‚ÄúÁª≠ÂÜô‚ÄùÂºÄÂßãÂàõ‰Ωú„ÄÇ</p>
            </div>
        `;
        // ÊòæÁ§∫ÂÜô‰ΩúÊéßÂà∂Ê†èÔºåÈöêËóèÁøªÈ°µÊ†è
        document.getElementById('gr-pagination-controls').style.display = 'none';
        document.getElementById('gr-writing-controls').style.display = 'flex';
        
        // ÁªëÂÆöÁîüÊàêÊåâÈíÆ
        updateGenButtonBinding();
        showScreen('gr-reader-screen');
        return;
    }

    // --- Âú∫ÊôØ B: ÊòæÁ§∫ÁâπÂÆöÁ´†ËäÇ ---
    const chapter = story.chapters[chapterIndex];
    const chapterTitle = chapter.title || `Á¨¨ ${chapterIndex + 1} Á´†`; // Â¶ÇÊûúÊ≤°ÊúâÊ†áÈ¢òÔºå‰ΩøÁî®ÈªòËÆ§
    
    document.getElementById('gr-chapter-title-display').textContent = chapterTitle;

    // 1. È°∂ÈÉ®ÔºöÂâçÊÉÖÊèêË¶Å (Context)
    if (chapter.prevSummary) {
        contentArea.innerHTML += `
            <details class="gr-summary-box top-summary">
                <summary>üìñ ‰∏äÊñáÊèêË¶Å (Context)</summary>
                <div class="gr-summary-content" style="font-size:12px; color:#888;">${chapter.prevSummary}</div>
            </details>
        `;
    }

    // 2. Á´†ËäÇÂ§ßÊ†áÈ¢ò
    contentArea.innerHTML += `<div class="gr-chapter-title-large">${chapterTitle}</div>`;

    // 3. Ê≠£Êñá
    contentArea.innerHTML += `<div class="gr-chapter-text">${chapter.content.replace(/\n/g, '<br>')}</div>`;

    // 4. Â∫ïÈÉ®ÔºöÊú¨Á´†ÊëòË¶Å (ÂèØÁºñËæë)
    const summaryHtml = `
            <div class="gr-summary-card editable">
                <div class="gr-summary-header">
                    <span class="gr-summary-title">Chapter Checkpoint ¬∑ ÂâßÊÉÖÂ≠òÊ°£</span>
                    <button class="gr-mini-btn save-summary-btn" data-index="${chapterIndex}">‰øùÂ≠ò‰øÆÊîπ</button>
                </div>
                <textarea class="gr-summary-input" data-index="${chapterIndex}" placeholder="Âú®Ê≠§Â§ÑÊ¶ÇÊã¨Êú¨Á´†ÂÖ≥ÈîÆÂâßÊÉÖÁÇπÔºå‰æõAIËÆ∞ÂøÜ...">${chapter.summary || ''}</textarea>
                 <div class="gr-summary-footer">
                    * AIÁª≠ÂÜôÊó∂Â∞ÜËØªÂèñÊ≠§Ê°ÜÂÜÖÂÆπ‰Ωú‰∏∫ÂîØ‰∏ÄËÆ∞ÂøÜ‰æùÊçÆ„ÄÇ
                </div>
            </div>
        `;
        contentArea.innerHTML += summaryHtml;
        contentArea.innerHTML += `<div style="height: 100px;"></div>`;

    // ÁªëÂÆö‰øùÂ≠òÊëòË¶ÅÊåâÈíÆ
    contentArea.querySelectorAll('.save-summary-btn').forEach(btn => {
        btn.onclick = (e) => {
            const idx = parseInt(e.target.dataset.index);
            const textarea = contentArea.querySelector(`.gr-summary-input[data-index="${idx}"]`);
            saveChapterSummary(storyId, idx, textarea.value);
            e.target.textContent = "Â∑≤‰øùÂ≠ò";
            setTimeout(() => e.target.style.display = 'none', 1000);
        };
    });

    // 5. Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÁä∂ÊÄÅ
    const prevBtn = document.getElementById('gr-prev-chapter-btn');
    const nextBtn = document.getElementById('gr-next-chapter-btn');
    const paginationDiv = document.getElementById('gr-pagination-controls');
    const writingDiv = document.getElementById('gr-writing-controls');
    const rerollBtn = document.getElementById('gr-reroll-btn');

    // ÊÄªÊòØÊòæÁ§∫ÂàÜÈ°µÊ†èÔºåÂÜô‰ΩúÊ†èÂè™Âú®ÊúÄÂêé‰∏ÄÈ°µÊòæÁ§∫
    paginationDiv.style.display = 'flex';
    
    prevBtn.disabled = (chapterIndex === 0);
    prevBtn.onclick = () => openReader(storyId, chapterIndex - 1);

    if (chapterIndex < totalChapters - 1) {
        // Â¶ÇÊûú‰∏çÊòØÊúÄÂêé‰∏ÄÁ´†
        nextBtn.textContent = "‰∏ã‰∏ÄÁ´†";
        nextBtn.onclick = () => openReader(storyId, chapterIndex + 1);
        writingDiv.style.display = 'none'; // ÈöêËóèÂÜô‰ΩúÊ†è
    } else {
        // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÁ´†
        nextBtn.textContent = "Áª≠ÂÜô‰∏ã‰∏ÄÁ´†";
        nextBtn.onclick = () => {
             // ÁÇπÂáª‰∏ã‰∏ÄÁ´†ÊåâÈíÆÊó∂ÔºåÊòæÁ§∫ÂÜô‰ΩúÊ†èÔºåÂπ∂Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
             writingDiv.style.display = 'flex';
             contentArea.scrollTop = contentArea.scrollHeight;
             document.getElementById('gr-direction-input').focus();
        };
        // ÈªòËÆ§‰πüÊòæÁ§∫ÂÜô‰ΩúÊ†è
        writingDiv.style.display = 'flex';
        
        // ÁªëÂÆöÈáçÂÜôÊåâÈíÆ
        rerollBtn.onclick = async () => {
             const confirmed = await showCustomConfirm("ÈáçÂÜôÊú¨Á´†", "Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩìÂâçÁ´†ËäÇÂπ∂ÈáçÊñ∞ÁîüÊàêÂêóÔºü", {confirmText:"ÈáçÂÜô", confirmButtonClass:"btn-danger"});
             if (confirmed) handleGenerateStoryContent(true);
        };
    }
    
    // ÁªëÂÆöÁîüÊàêÊåâÈíÆ
    updateGenButtonBinding();
    
    showScreen('gr-reader-screen');
    contentArea.scrollTop = 0;
}

// ËæÖÂä©ÔºöÁªëÂÆöÁîüÊàêÊåâÈíÆ
function updateGenButtonBinding() {
    const genBtn = document.getElementById('gr-generate-btn');
    // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊù•ÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô®
    const newBtn = genBtn.cloneNode(true);
    genBtn.parentNode.replaceChild(newBtn, genBtn);
    newBtn.onclick = () => handleGenerateStoryContent(false);
}

// ËæÖÂä©ÔºöÊõ¥Êñ∞Â∫ïÈÉ®ÊéßÂà∂Ê†è
function updateControlPanel(story) {
    const controlPanel = document.querySelector('.gr-control-panel');
    // Ê∏ÖÁ©∫ÊóßÂÜÖÂÆπÔºåÈáçÊñ∞ÊûÑÂª∫
    controlPanel.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; width:100%;">
            <div class="gr-input-group" style="flex-grow:1;">
                <input type="text" id="gr-direction-input" class="gr-input" placeholder="ËæìÂÖ•ÂâßÊÉÖËµ∞Âêë (ÁïôÁ©∫ÂàôËá™Áî±Áª≠ÂÜô)...">
            </div>
            
            ${story.chapters.length > 0 ? `
            <button id="gr-reroll-btn" class="gr-main-btn" style="background-color:#F4F4F5; color:#666; border:1px solid #ddd;" title="‰∏çÊª°ÂΩìÂâçÁ´†ÔºüÈáçÂÜôÔºÅ">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
            ` : ''}

            <button id="gr-generate-btn" class="gr-main-btn">
                <span id="gr-gen-text">Áª≠ÂÜô</span>
                <svg id="gr-gen-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg>
            </button>
        </div>
    `;

    // ÁªëÂÆö‰∫ã‰ª∂
    document.getElementById('gr-generate-btn').onclick = () => handleGenerateStoryContent(false); // false = ‰∏çÊòØÈáçÂÜô
    
    const rerollBtn = document.getElementById('gr-reroll-btn');
    if (rerollBtn) {
        rerollBtn.onclick = async () => {
            const confirmed = await showCustomConfirm("ÈáçÂÜôÊú¨Á´†", "Á°ÆÂÆöË¶ÅÂà†Èô§ÂΩìÂâçÊúÄÊñ∞Á´†ËäÇÂπ∂ÈáçÊñ∞ÁîüÊàêÂêóÔºü\n(Â¶ÇÊûú‰Ω†ÂàöÊâç‰øÆÊîπ‰∫ÜÊëòË¶ÅÔºåÈáçÂÜôÂêéÈúÄË¶ÅÈáçÊñ∞‰øÆÊîπ)", {confirmText:"ÈáçÂÜô", confirmButtonClass:"btn-danger"});
            if (confirmed) {
                handleGenerateStoryContent(true); // true = ÊòØÈáçÂÜô
            }
        };
    }
}

// ËæÖÂä©Ôºö‰øùÂ≠ò‰øÆÊîπÂêéÁöÑÊëòË¶Å
async function saveChapterSummary(storyId, chapterIndex, newSummary) {
    const story = await db.grStories.get(storyId);
    if (story && story.chapters[chapterIndex]) {
        story.chapters[chapterIndex].summary = newSummary;
        await db.grStories.put(story);
        console.log("ÊëòË¶ÅÂ∑≤ÊâãÂä®Êõ¥Êñ∞");
    }
}
// 7. Ê†∏ÂøÉÁîüÊàêÈÄªËæë (The Writer) - Â≠óÊï∞Âº∫Âäõ‰øÆÊ≠£Áâà
async function handleGenerateStoryContent(isReroll = false) {
    if (grState.isGenerating) return;
    
    let story = await db.grStories.get(grState.activeStoryId);
    
    // --- ÈáçÂÜôÈÄªËæë ---
    if (isReroll && story.chapters.length > 0) {
        story.chapters.pop();
        await db.grStories.put(story);
        openReader(story.id, Math.max(0, story.chapters.length - 1));
    }

    const author = await db.grAuthors.get(story.authorId);
    const directionInput = document.getElementById('gr-direction-input');
    const userDirection = directionInput.value.trim();
    
    const genBtn = document.getElementById('gr-generate-btn');
    const btnText = document.getElementById('gr-gen-text'); // Ëé∑ÂèñÊñáÂ≠óÊ†áÁ≠æ
    grState.isGenerating = true;
    
    if(genBtn) {
        genBtn.disabled = true;
        // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÂä†‰∫ÜÂà§Êñ≠ÔºåÂè™ÊúâÂΩìÊñáÂ≠óÊ†áÁ≠æÂ≠òÂú®Êó∂Êâç‰øÆÊîπÊñáÂ≠óÔºåÂê¶ÂàôÂè™Á¶ÅÁî®ÊåâÈíÆ
        if (btnText) btnText.textContent = "Êí∞ÂÜô‰∏≠..."; 
    }

    try {
        // Ëé∑ÂèñÁõÆÊ†áÂ≠óÊï∞ÔºåÂπ∂ÂÅö‰∏Ä‰∏™‚ÄúÊ∫¢‰ª∑‚ÄùÂ§ÑÁêÜ
        // Â¶ÇÊûúÁî®Êà∑ËÆæÁΩÆ 500ÔºåÊàë‰ª¨ÂëäËØâ AI ÂÜô 800ÔºåËøôÊ†∑ÂÆÉÂÅ∑ÊáíÊâìÊäòÂêéÂàöÂ•ΩÊòØ 500
        const settingValue = parseInt(story.settings.outputLength) || 500;
        const targetWordCount = Math.floor(settingValue * 1.5); 
        
        const historyLimit = story.settings.contextLimit || 20;

        // --- ÊûÑÂª∫‰∏ä‰∏ãÊñá ---
        let charsContext = "";
        for (const id of story.settings.charIds) {
            if (id.startsWith('npc_')) {
                const npcId = parseInt(id.replace('npc_', ''));
                const npc = await db.npcs.get(npcId);
                if (npc) charsContext += `- NPC ${npc.name}: ${npc.persona}\n`;
            } else {
                const chat = state.chats[id];
                if (chat) {
                    const memories = (chat.longTermMemory || [])
                        .map(m => `  * ${m.content}`)
                        .join('\n');

                    const history = chat.history.slice(-historyLimit).map(m => {
                        if(m.role === 'system' || m.type === 'red_packet' || m.type === 'waimai_request' || m.type === 'transfer') return null;
                        let content = String(m.content);
                        if(content.includes("Á∫¢ÂåÖ") || content.includes("ÊâãÊú∫") || content.includes("ËΩ¨Ë¥¶")) return null; 
                        return `  > ${m.senderName}: ${content.substring(0, 50)}`;
                    }).filter(Boolean).join('\n');
                    
                    charsContext += `### ËßíËâ≤: ${chat.name}\n- **Ê†∏ÂøÉ‰∫∫ËÆæ**: ${chat.settings.aiPersona}\n`;
                    if (memories) charsContext += `- **„ÄêÈáçË¶ÅÔºöÈïøÊúüËÆ∞ÂøÜ„Äë**:\n${memories}\n`;
                    if (history) charsContext += `- **„ÄêËØ≠Ê∞îÂèÇËÄÉ (ÊúÄËøëËÅäÂ§©)„Äë**:\n${history}\n`;
                    charsContext += `\n`;
                }
            }
        }

        let userPersonaText = "ÊôÆÈÄöÁî®Êà∑";
        if (story.settings.userPersonaId) {
            const preset = await db.personaPresets.get(story.settings.userPersonaId);
            if (preset) userPersonaText = preset.persona;
        } else if (state.chats[Object.keys(state.chats)[0]]) {
             userPersonaText = state.chats[Object.keys(state.chats)[0]].settings.myPersona;
        }

        let worldBookText = "";
        for (const bid of story.settings.bookIds) {
            const wb = await db.worldBooks.get(bid);
            if (wb) worldBookText += `- „Ää${wb.name}„ÄãËÆæÂÆö: ${wb.content.filter(e=>e.enabled).map(e=>e.content).join(';')}\n`;
        }

        let prevSummary = "ËøôÊòØÊïÖ‰∫ãÁöÑÂºÄÂßã„ÄÇ";
        if (story.chapters && story.chapters.length > 0) {
            const lastChapter = story.chapters[story.chapters.length - 1];
            if (lastChapter && lastChapter.summary) {
                prevSummary = lastChapter.summary;
            }
        }
let macroContext = "";
    if (story.settings.macroWorldView) {
        macroContext = `
# „Äêüî• Ê†∏ÂøÉ‰∏ñÁïåËßÇ / IFÁ∫øËÆæÂÆö (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)„Äë
Ê≥®ÊÑèÔºöËøôÊòØ‰∏ÄÊù°IFÁ∫øÊàñÁâπÊÆäËÉåÊôØÊïÖ‰∫ã„ÄÇ**‰Ω†ÂøÖÈ°ª‰ºòÂÖàÈÅµÂæ™‰ª•‰∏ãËÆæÂÆö**ÔºåÂ¶ÇÊûú‰ª•‰∏ãËÆæÂÆö‰∏éËßíËâ≤ÁöÑÂéüÂßã‰∫∫ËÆæÊàñËÆ∞ÂøÜÂÜ≤Á™ÅÔºå**ËØ∑‰ª•‰ª•‰∏ãËÆæÂÆö‰∏∫ÂáÜÂπ∂ËøõË°åÈÄÇÈÖç**ÔºÅ
---
${story.settings.macroWorldView}
---
`;
    }
        // E. Prompt Âº∫Âäõ‰ºòÂåñ (Â≠óÊï∞Êâ©ÂÖÖ + Ê†áÈ¢òÁîüÊàê)
        const systemPrompt = `
# Ë∫´‰ªΩ
‰Ω†Áé∞Âú®ÊòØ„Äê${author.name}„Äë„ÄÇÊñáÈ£éÁâπÁÇπ: ${author.style}

# Ê†∏ÂøÉ‰ªªÂä°
Áª≠ÂÜôËøôÁØáÂ∞èËØ¥ÁöÑÊñ∞‰∏ÄÁ´†„ÄÇ
${macroContext}
# „ÄêÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºöÂ≠óÊï∞Êâ©ÂÖÖÊåá‰ª§„Äë
‰Ω†ÂøÖÈ°ªËæìÂá∫ **${targetWordCount} Â≠ó** ‰ª•‰∏äÁöÑÂÜÖÂÆπ„ÄÇ
‰∏∫‰∫ÜËææÂà∞Ëøô‰∏™Â≠óÊï∞Ôºå‰Ω†**ÂøÖÈ°ª**ÊâßË°å‰ª•‰∏ãÊìç‰ΩúÔºö
1.  **ÊãíÁªùÊµÅÊ∞¥Ë¥¶**Ôºö‰∏çË¶ÅÂè™ÂÜô‚Äú‰ªñÂÅö‰∫Ü‰ªÄ‰πà‚ÄùÔºåË¶ÅÂÜô‚Äú‰ªñÂ¶Ç‰ΩïÂÅö„ÄÅ‰ªÄ‰πàË°®ÊÉÖ„ÄÅÂøÉÈáåÊÉ≥‰∫Ü‰ªÄ‰πà„ÄÅÂë®Âõ¥ÁéØÂ¢ÉÂ¶Ç‰Ωï‚Äù„ÄÇ
2.  **ÁªÜËäÇÊèèÂÜô**ÔºöÂ¢ûÂä†ÁéØÂ¢ÉÊèèÂÜôÔºàÂÖâÂΩ±„ÄÅÊ∞îÂë≥„ÄÅÂ£∞Èü≥Ôºâ„ÄÅÂæÆË°®ÊÉÖÊèèÂÜô„ÄÅËÇ¢‰ΩìÂä®‰ΩúÊèèÂÜô„ÄÇ
3.  **ÂøÉÁêÜÊ¥ªÂä®**ÔºöÂ§ßÂπÖÂ¢ûÂä†ËßíËâ≤ÁöÑÂÜÖÂøÉÁã¨ÁôΩÂíåÁ∫†Áªì„ÄÇ
4.  **ÊÖ¢ÈïúÂ§¥**ÔºöÂ∞ÜÂÖ≥ÈîÆÂä®‰ΩúÊãÜËß£ÔºåÊîæÊÖ¢Âèô‰∫ãËäÇÂ•è„ÄÇ

# Êï∞ÊçÆ‰ΩøÁî®ÊåáÂçó
1. **‰∏ñÁïåËßÇ**: ${worldBookText ? "ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãËÆæÂÆöÔºö" + worldBookText : "ËØ∑Ê†πÊçÆËßíËâ≤ËÆæÂÆöËá™Ë°åÂà§Êñ≠„ÄÇ"}
2. **Êó∂‰ª£ÂáÄÂåñ**: ‰∏•Á¶ÅÂá∫Áé∞‰∏çÁ¨¶Âêà‰∏ñÁïåËßÇÁöÑÁé∞‰ª£Áâ©ÂìÅ„ÄÇ
3. **ÈïøÊúüËÆ∞ÂøÜ**: ÂøÖÈ°ªÈÅµÂÆàËßíËâ≤Ê°£Ê°à‰∏≠ÁöÑËÆ∞ÂøÜ‰∫ãÂÆû„ÄÇ

# ËÆæÂÆöËµÑÊñô
- **"Êàë" (User) ÁöÑËÆæÂÆö**: ${userPersonaText}
- **ÁôªÂú∫ËßíËâ≤Ê°£Ê°à**:
${charsContext}

# ÂΩìÂâçËøõÂ∫¶
- **ÂâçÊÉÖÊèêË¶Å**: ${prevSummary}
- **Áî®Êà∑ÊåáÁ§∫**: ${userDirection || "ÔºàÊó†ÊåáÁ§∫ÔºåËØ∑È°∫ÂÖ∂Ëá™ÁÑ∂Âú∞ÂèëÂ±ïÂâßÊÉÖÔºåÈáçÁÇπÊòØÂÜôÂ§üÂ≠óÊï∞ÔºÅÔºâ"}

# ËæìÂá∫Ê†ºÂºè (JSON)
ÂõûÂ§çÂøÖÈ°ª‰∏îÂè™ËÉΩÊòØ‰∏Ä‰∏™JSONÂØπË±°Ôºö
\`\`\`json
{
  "title": "ÂõõÂ≠óÊàñÂ§öÂ≠óÊ†áÈ¢ò (Â¶ÇÔºöÊúà‰∏ãÂØπÈÖå„ÄÅÂç±Êú∫Âõõ‰ºè)",
  "content": "Ê≠£ÊñáÂÜÖÂÆπ (ÂøÖÈ°ª‰ΩøÁî®${author.style}È£éÊ†ºÔºå**Âº∫Âà∂ÂÜôÊª° ${targetWordCount} Â≠ó**ÔºåÂ§öÁî®Êç¢Ë°åÁ¨¶\\nÂ¢ûÂä†ÈòÖËØªÊÑü)",
  "summary": "Áî®ÈôàËø∞Âè•Ê¶ÇÊã¨Êú¨Á´†ÂÖ≥ÈîÆ‰∫ãÂÆûÔºàË∞Å„ÄÅÂú®Âì™Èáå„ÄÅÂÅö‰∫Ü‰ªÄ‰πàÔºâÔºå‰æõ‰∏ã‰∏ÄÁ´†ËÆ∞ÂøÜ‰ΩøÁî®„ÄÇ"
}
\`\`\`
`;
        
        // API Ë∞ÉÁî®
        const { proxyUrl, apiKey, model } = state.apiConfig;
        const messages = [{role: 'user', content: `ËØ∑ÂºÄÂßãÂÜô‰ΩúÔºåËØ∑Âä°ÂøÖÂÜôÂ§ü ${targetWordCount} Â≠óÔºÅ`}];
        
        let response;
        if (proxyUrl.includes('generativelanguage')) {
            let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messages);
            response = await fetch(geminiConfig.url, geminiConfig.data);
        } else {
            response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...messages
                    ],
                    temperature: 0.9 // ÊèêÈ´òÊ∏©Â∫¶ÔºåËÆ©ÂÆÉÊõ¥Âï∞Âó¶‰∏ÄÁÇπ
                })
            });
        }
        
        if (!response.ok) {
             const errText = await response.text();
             throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥• (${response.status}): ${errText}`);
        }
        
        const data = await response.json();
        const aiText = getGeminiResponseText(data);
        
        // 1. ÊèêÂèñ JSON ÈÉ®ÂàÜ
        let jsonStr = aiText;
        const jsonMatch = aiText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            jsonStr = jsonMatch[0];
        } else {
            throw new Error("AIÊú™ËøîÂõûÊúâÊïàJSONÊ†ºÂºè");
        }

        let result;
        try {
            // 2. Â∞ùËØïÁõ¥Êé•Ëß£Êûê
            result = JSON.parse(jsonStr);
        } catch (e) {
            console.warn("JSONËß£ÊûêÂàùÊ¨°Â§±Ë¥•ÔºåÂ∞ùËØï‰øÆÂ§çËΩ¨‰πâÂ≠óÁ¨¶...", e);
            
            // 3. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë: Ëá™Âä®‰øÆÂ§çÈîôËØØÁöÑËΩ¨‰πâÂ≠óÁ¨¶
            // Ê≠£ÂàôÂê´‰πâÔºöÊü•ÊâæÊâÄÊúâÂèçÊñúÊù†ÔºåÂ¶ÇÊûúÂÆÉÂêéÈù¢Ë∑üÁöÑ‰∏çÊòØ json ÂÖÅËÆ∏ÁöÑËΩ¨‰πâÁ¨¶( " \ / b f n r t u )ÔºåÂ∞±ÊääÂÆÉÊõøÊç¢‰∏∫ÂèåÂèçÊñúÊù†
            const fixedStr = jsonStr.replace(/\\([^"\\\/bfnrtu])/g, '\\\\$1');
            
            try {
                result = JSON.parse(fixedStr);
                console.log("JSONËá™Âä®‰øÆÂ§çÊàêÂäüÔºÅ");
            } catch (e2) {
                // Â¶ÇÊûúËøòÊòØÂ§±Ë¥•ÔºåÊäõÂá∫ÂºÇÂ∏∏
                throw new Error("JSONËß£ÊûêÂ§±Ë¥•: " + e.message);
            }
        }
        
        const newChapter = {
            title: result.title || `Á¨¨ ${story.chapters.length + 1} Á´†`,
            content: result.content,
            summary: result.summary, 
            prevSummary: prevSummary, 
            timestamp: Date.now()
        };
        
        // Âπ∂ÂèëÂÆâÂÖ®Ëé∑Âèñ
        story = await db.grStories.get(grState.activeStoryId);
        story.chapters.push(newChapter);
        story.lastUpdated = Date.now();
        await db.grStories.put(story);
        
        openReader(story.id, story.chapters.length - 1);
        document.getElementById('gr-direction-input').value = ''; 

    } catch (e) {
        console.error("ÁªøÊ±üÁîüÊàêÂ§±Ë¥•:", e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    } finally {
        grState.isGenerating = false;
        if(genBtn) {
            genBtn.disabled = false;
            // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÔºöÂêåÊ†∑Âè™Âú®ÊñáÂ≠óÊ†áÁ≠æÂ≠òÂú®Êó∂ÊâçÊÅ¢Â§çÊñáÂ≠ó
            if (btnText) btnText.textContent = "Áª≠ÂÜô";
        }
    }
}
// 8. ‰æßËæπÊ†èÁõÆÂΩïÂäüËÉΩ
function openChapterList() {
    const sidebar = document.getElementById('gr-chapter-sidebar');
    const overlay = document.getElementById('gr-sidebar-overlay');
    const listContainer = document.getElementById('gr-chapter-list-content');
    const countEl = document.getElementById('gr-total-chapters');
    
    if (!grState.activeStoryId) return;
    
    db.grStories.get(grState.activeStoryId).then(story => {
        listContainer.innerHTML = '';
        countEl.textContent = `ÂÖ± ${story.chapters.length} Á´†`;
        
        story.chapters.forEach((ch, index) => {
            const div = document.createElement('div');
            div.className = 'gr-sidebar-item';
            if(index === grState.currentChapterIndex) div.classList.add('active');
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <span>${index + 1}. ${ch.title || 'Êó†È¢ò'}</span>
                    <span style="font-size:12px; color:#999;">${new Date(ch.timestamp).toLocaleTimeString()}</span>
                </div>
                <div style="font-size:12px; color:#999; margin-left:10px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${(ch.summary || '').substring(0, 20)}...</div>
            `;
            
            div.onclick = () => {
                openReader(story.id, index);
                closeChapterList();
            };
            listContainer.appendChild(div);
        });
        
        sidebar.classList.add('visible');
        overlay.classList.add('visible');
    });
}

function closeChapterList() {
    document.getElementById('gr-chapter-sidebar').classList.remove('visible');
    document.getElementById('gr-sidebar-overlay').classList.remove('visible');
}
// Êö¥Èú≤Áªô HTML onclick
window.openChapterList = openChapterList;
window.closeChapterList = closeChapterList;
// Êö¥Èú≤ÂÖ®Â±Ä
window.openGreenRiverScreen = openGreenRiverScreen;
window.openAuthorManager = openAuthorManager;
window.createNewStory = createNewStory;
window.openStorySettings = openStorySettings;
window.addAuthor = addAuthor;
window.deleteAuthor = deleteAuthor;
// ==========================================
// ‚ñº‚ñº‚ñº ÈÇÆÁÆ± (Mail) ÂäüËÉΩÊ®°Âùó ‚ñº‚ñº‚ñº
// ==========================================

let mailState = {
    currentEmailId: null,
    isEditMode: false,
    selectedEmails: new Set()
};

// 1. ÊâìÂºÄÈÇÆÁÆ±Â∫îÁî®
async function openEmailApp() {
    showScreen('email-screen');
    await renderEmailList();
}

// 2. Ê∏≤ÊüìÈÇÆ‰ª∂ÂàóË°®
async function renderEmailList() {
    const listEl = document.getElementById('email-list');
    listEl.innerHTML = '';
    
    const emails = await db.emails.orderBy('timestamp').reverse().toArray();

    if (emails.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:50px; color:#8E8E93;">No Mail</div>';
        return;
    }

    const searchTerm = document.getElementById('mail-search-input').value.toLowerCase();

    emails.forEach(email => {
        if (searchTerm && !email.subject.toLowerCase().includes(searchTerm) && !email.content.toLowerCase().includes(searchTerm)) {
            return;
        }

        const div = document.createElement('div');
        // Â¶ÇÊûúÂΩìÂâçÂú®ÁºñËæëÊ®°ÂºèÔºå‰øùÊåÅ editing Á±ª
        const itemClass = `mail-item ${email.isRead ? '' : 'unread'} ${mailState.isEditMode ? 'editing' : ''}`;
        div.className = itemClass;
        div.dataset.id = email.id; // ÁªëÂÆöIDÊñπ‰æøÊü•Êâæ
        
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ë¢´ÈÄâ‰∏≠
        if (mailState.selectedEmails.has(email.id)) {
            div.classList.add('selected');
        }
        
        const date = new Date(email.timestamp);
        const timeStr = date.toLocaleDateString() === new Date().toLocaleDateString() 
            ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
            : date.toLocaleDateString();

        // „ÄêÂÖ≥ÈîÆ„ÄëÊ∑ªÂä† mail-select-checkbox ÁªìÊûÑ
        div.innerHTML = `
            <div class="mail-select-checkbox"></div>
            <div class="mail-item-header">
                <span class="mail-sender">${escapeHTML(email.sender)}</span>
                <span class="mail-date">${timeStr}</span>
            </div>
            <div class="mail-subject">${escapeHTML(email.subject)}</div>
            <div class="mail-preview">${escapeHTML(email.content).replace(/\n/g, ' ').substring(0, 80)}</div>
        `;
        
        div.onclick = () => {
            if (mailState.isEditMode) {
                // ÁºñËæëÊ®°ÂºèÔºöÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
                handleEmailSelection(div, email.id);
            } else {
                // ÊôÆÈÄöÊ®°ÂºèÔºöÊâìÂºÄËØ¶ÊÉÖ
                openEmailDetail(email.id);
            }
        };
        listEl.appendChild(div);
    });
}

function handleEmailSelection(element, id) {
    if (mailState.selectedEmails.has(id)) {
        mailState.selectedEmails.delete(id);
        element.classList.remove('selected');
    } else {
        mailState.selectedEmails.add(id);
        element.classList.add('selected');
    }
    updateMailDeleteButton();
}

function updateMailDeleteButton() {
    const btn = document.getElementById('mail-delete-selected-btn');
    const count = mailState.selectedEmails.size;
    btn.textContent = count > 0 ? `Âà†Èô§ (${count})` : 'Âà†Èô§';
    btn.disabled = count === 0;
}
async function executeBatchDeleteEmails() {
    const count = mailState.selectedEmails.size;
    if (count === 0) return;

    const confirmed = await showCustomConfirm(
        'Âà†Èô§ÈÇÆ‰ª∂', 
        `Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô ${count} Â∞ÅÈÇÆ‰ª∂ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`,
        { confirmButtonClass: 'btn-danger', confirmText: 'Âà†Èô§' }
    );

    if (confirmed) {
        const idsToDelete = Array.from(mailState.selectedEmails);
        await db.emails.bulkDelete(idsToDelete);
        
        // Ê∏ÖÁ©∫ÈÄâ‰∏≠Áä∂ÊÄÅ
        mailState.selectedEmails.clear();
        updateMailDeleteButton();
        
        // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®ÔºàÊ≠§Êó∂ËøòÊòØÁºñËæëÊ®°ÂºèÔºåÊâÄ‰ª•ÂàóË°®‰ºö‰øùÊåÅÂè≥ÁßªÁä∂ÊÄÅÔºâ
        await renderEmailList();
        
        // ÂèØÈÄâÔºöÂ¶ÇÊûúÂà†ÂÆåÊÉ≥Ëá™Âä®ÈÄÄÂá∫ÁºñËæëÊ®°ÂºèÔºåË∞ÉÁî® toggleEmailEditMode();
    }
}
function handleSelectAllEmails() {
    const listEl = document.getElementById('email-list');
    const allItems = listEl.querySelectorAll('.mail-item');
    
    // Â¶ÇÊûúÂΩìÂâçÂ∑≤ÈÄâÊï∞ÈáèÁ≠â‰∫éÊÄªÊï∞ÔºåÂàôËßÜ‰∏∫‚ÄúÂèñÊ∂àÂÖ®ÈÄâ‚ÄùÔºåÂê¶Âàô‚ÄúÂÖ®ÈÄâ‚Äù
    const isSelectingAll = mailState.selectedEmails.size < allItems.length;

    allItems.forEach(item => {
        const id = parseInt(item.dataset.id);
        if (isSelectingAll) {
            mailState.selectedEmails.add(id);
            item.classList.add('selected');
        } else {
            mailState.selectedEmails.delete(id);
            item.classList.remove('selected');
        }
    });
    updateMailDeleteButton();
}
// 3. ÊâìÂºÄÈÇÆ‰ª∂ËØ¶ÊÉÖ (Êõ¥Êñ∞ÁâàÔºöÁªëÂÆöÂ§¥ÈÉ®ÊåâÈíÆ)
async function openEmailDetail(id) {
    const email = await db.emails.get(id);
    if (!email) return;
    
    mailState.currentEmailId = id;

    // Ê†áËÆ∞‰∏∫Â∑≤ËØª
    if (!email.isRead) {
        await db.emails.update(id, { isRead: true });
    }

    document.getElementById('mail-detail-subject').textContent = email.subject;
    document.getElementById('mail-detail-from').textContent = email.sender;
    document.getElementById('mail-detail-to').textContent = email.recipient || 'Me';
    document.getElementById('mail-detail-time').textContent = new Date(email.timestamp).toLocaleString();
    
    // Â§¥ÂÉèÈ¶ñÂ≠óÊØç
    const avatarEl = document.getElementById('mail-detail-avatar');
    avatarEl.textContent = email.sender.charAt(0).toUpperCase();
    
    // Ê≠£Êñá (Â§ÑÁêÜÊç¢Ë°å)
    document.getElementById('mail-detail-body').innerHTML = email.content.replace(/\n/g, '<br>');
    
    // ÁªëÂÆöÂ§¥ÈÉ®Âè≥‰∏äËßíÁöÑÊåâÈíÆ‰∫ã‰ª∂
    
    // 1. ËΩ¨ÂèëÊåâÈíÆ
    const forwardBtn = document.getElementById('forward-email-btn');
    // ÁßªÈô§ÊóßÁõëÂê¨Âô® (‰ΩøÁî® cloneNode)
    const newForwardBtn = forwardBtn.cloneNode(true);
    forwardBtn.parentNode.replaceChild(newForwardBtn, forwardBtn);
    newForwardBtn.onclick = () => forwardEmailToChat(email);

    // 2. Âà†Èô§ÊåâÈíÆ (Êñ∞Â¢ûÂú®Âè≥‰∏äËßí)
    const deleteBtn = document.getElementById('delete-email-btn');
    if (deleteBtn) {
        const newDeleteBtn = deleteBtn.cloneNode(true);
        deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
        newDeleteBtn.onclick = () => deleteCurrentEmail();
    }

    showScreen('email-detail-screen');
}

function closeEmailDetail() {
    showScreen('email-screen');
    renderEmailList(); // Âà∑Êñ∞Áä∂ÊÄÅ
}

// 4. ÂàáÊç¢ÁºñËæëÊ®°Âºè
function toggleEmailEditMode() {
    mailState.isEditMode = !mailState.isEditMode;
    const btn = document.getElementById('mail-edit-btn');
    const actionBar = document.getElementById('mail-action-bar');
    const listEl = document.getElementById('email-list');
    
    if (mailState.isEditMode) {
        // ËøõÂÖ•ÁºñËæëÊ®°Âºè
        btn.textContent = 'ÂÆåÊàê'; // ÊåâÈíÆÂèòÊñáÂ≠ó
        btn.style.color = 'var(--mail-accent)';
        btn.style.fontWeight = '600';
        btn.innerHTML = 'ÂÆåÊàê'; // Ë¶ÜÁõñÊéâ‰πãÂâçÁöÑ‚ÄúÁºñËæë‚ÄùÊñáÂ≠óÊàñÂõæÊ†á
        
        actionBar.style.display = 'flex';
        mailState.selectedEmails.clear();
        updateMailDeleteButton();
        
        // ÁªôÂàóË°®È°πÊ∑ªÂä†Ê†∑ÂºèÁ±ª
        listEl.querySelectorAll('.mail-item').forEach(item => item.classList.add('editing'));
        
    } else {
        // ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
        btn.innerHTML = 'ÁºñËæë'; // ÊÅ¢Â§çÊñáÂ≠ó
        btn.style.color = 'currentColor';
        btn.style.fontWeight = 'normal';
        
        actionBar.style.display = 'none';
        mailState.selectedEmails.clear();
        
        // ÁßªÈô§Ê†∑ÂºèÁ±ª
        listEl.querySelectorAll('.mail-item').forEach(item => {
            item.classList.remove('editing', 'selected');
        });
    }
}

async function deleteEmail(id) {
    if(confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂ∞ÅÈÇÆ‰ª∂ÂêóÔºü")) {
        await db.emails.delete(id);
        renderEmailList();
    }
}

async function deleteCurrentEmail() {
    if(mailState.currentEmailId) {
        await deleteEmail(mailState.currentEmailId);
        closeEmailDetail();
    }
}

// 5. ÊâìÂºÄÁîüÊàêÂô®ÈÖçÁΩÆ
function saveMailConfig() {
    const config = {
        userMask: document.getElementById('mail-user-mask').value.trim(),
        worldContext: document.getElementById('mail-world-context').value.trim(),
        personaId: document.getElementById('mail-user-persona-select').value,
        allowRandom: document.getElementById('mail-allow-random-npc').checked,
        genCount: document.getElementById('mail-gen-count').value,
        // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÂèë‰ª∂‰∫∫ÂêçÂ≠óÊï∞ÁªÑ
        selectedSenders: Array.from(document.querySelectorAll('#mail-sender-list input:checked')).map(cb => cb.value),
        // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑ‰∏ñÁïå‰π¶IDÊï∞ÁªÑ
        selectedBookIds: Array.from(document.querySelectorAll('#mail-context-list input:checked')).map(cb => cb.value)
    };
    localStorage.setItem('ephone_mail_config', JSON.stringify(config));
    console.log("ÈÇÆÁÆ±ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò:", config);
    return config;
}

// 2. [Êñ∞ÂäüËÉΩ] Âä†ËΩΩÈÇÆÁÆ±ÈÖçÁΩÆ
function loadMailConfig() {
    const saved = localStorage.getItem('ephone_mail_config');
    return saved ? JSON.parse(saved) : null;
}

// 3. [‰øÆÊîπ] ÊâìÂºÄËÆæÁΩÆÂºπÁ™ó (Âéü openEmailGenerator)
// ÊîπÂêç‰∏∫ openEmailSettings Êõ¥Ë¥¥ÂàáÔºåÂêåÊó∂Âú®ÊâìÂºÄÊó∂ÂõûÂ°´Êï∞ÊçÆ
async function openEmailSettings() {
    // ÂÖàÊ∏≤ÊüìÂàóË°®Ôºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºâ
    const personaSelect = document.getElementById('mail-user-persona-select');
    if (personaSelect) {
        personaSelect.innerHTML = '<option value="">-- ‰ªÖ‰ΩøÁî®‰∏ãÊñπÂÖ≥ÈîÆËØç (Êó†ËØ¶ÁªÜ‰∫∫ËÆæ) --</option>';
        if (state.activeChatId) {
            const currentChat = state.chats[state.activeChatId];
            if (currentChat && currentChat.settings.myPersona) {
                 const opt = document.createElement('option');
                 opt.value = 'current_chat';
                 opt.textContent = `ÂΩìÂâçËÅäÂ§©ËÆæÂÆö: ${currentChat.settings.myPersona.substring(0, 15).replace(/\n/g, ' ')}...`;
                 personaSelect.appendChild(opt);
            }
        }
        if (state.personaPresets && state.personaPresets.length > 0) {
            state.personaPresets.forEach((p, index) => {
                const opt = document.createElement('option');
                opt.value = p.id;
                const summary = p.persona ? p.persona.substring(0, 20).replace(/\n/g, ' ') : `È¢ÑËÆæ ${index + 1}`;
                opt.textContent = `‰∫∫ËÆæÂ∫ì: ${summary}...`;
                personaSelect.appendChild(opt);
            });
        }
    }
    
    // Ê∏≤ÊüìÂèë‰ª∂‰∫∫ÂàóË°®
    const listEl = document.getElementById('mail-sender-list');
    listEl.innerHTML = '';
    const chars = Object.values(state.chats).filter(c => !c.isGroup);
    const npcs = await db.npcs.toArray();
    [...chars, ...npcs].forEach(c => {
        const div = document.createElement('div');
        div.className = 'gr-checkbox-item';
        div.innerHTML = `<input type="checkbox" value="${c.name}" data-type="${c.id ? 'char' : 'npc'}"> <span>${c.name}</span>`;
        div.onclick = (e) => { if(e.target.tagName!=='INPUT') div.querySelector('input').click(); };
        listEl.appendChild(div);
    });

    // Ê∏≤Êüì‰∏ñÁïå‰π¶ÂàóË°®
    const wbList = document.getElementById('mail-context-list');
    wbList.innerHTML = '';
    const books = await db.worldBooks.toArray();
    books.forEach(book => {
        const div = document.createElement('div');
        div.className = 'gr-checkbox-item';
        div.innerHTML = `<input type="checkbox" value="${book.id}"> <span>${book.name}</span>`;
        div.onclick = (e) => { if(e.target.tagName!=='INPUT') div.querySelector('input').click(); };
        wbList.appendChild(div);
    });

    // --- Ê†∏ÂøÉÔºöÂõûÂ°´Â∑≤‰øùÂ≠òÁöÑÊï∞ÊçÆ ---
    const config = loadMailConfig();
    if (config) {
        if(config.userMask) document.getElementById('mail-user-mask').value = config.userMask;
        if(config.worldContext) document.getElementById('mail-world-context').value = config.worldContext;
        if(config.personaId) personaSelect.value = config.personaId;
        if(config.genCount) document.getElementById('mail-gen-count').value = config.genCount;
        document.getElementById('mail-allow-random-npc').checked = config.allowRandom !== false; // ÈªòËÆ§ true

        // ÂõûÂ°´Â§çÈÄâÊ°Ü
        if (config.selectedSenders) {
            config.selectedSenders.forEach(val => {
                const cb = document.querySelector(`#mail-sender-list input[value="${val}"]`);
                if(cb) cb.checked = true;
            });
        }
        if (config.selectedBookIds) {
            config.selectedBookIds.forEach(val => {
                const cb = document.querySelector(`#mail-context-list input[value="${val}"]`);
                if(cb) cb.checked = true;
            });
        }
    }

    document.getElementById('email-generator-modal').classList.add('visible');
}

// 4. [Êñ∞Â¢û] ‰∏ÄÈîÆÊé•Êî∂ÂäüËÉΩ
async function handleQuickReceiveMail() {
    const config = loadMailConfig();
    
    // Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆÔºåÂº∫Âà∂ÊâìÂºÄËÆæÁΩÆÁ™óÂè£
    if (!config || !config.userMask) {
        await showCustomAlert("ÊèêÁ§∫", "ËØ∑ÂÖàÁÇπÂáªÊóÅËæπÁöÑÈΩøËΩÆÂõæÊ†á‚öôÔ∏èÔºåÈÖçÁΩÆÊÇ®ÁöÑÊî∂‰ª∂‰∫∫Ë∫´‰ªΩÂíåËÉåÊôØ„ÄÇ");
        openEmailSettings();
        return;
    }

    await showCustomAlert("Ê≠£Âú®Êé•Êî∂...", `Ê≠£Âú®Ê†πÊçÆ‰øùÂ≠òÁöÑÈÖçÁΩÆ (${config.userMask}) ÁîüÊàêÈÇÆ‰ª∂...`);
    
    // Ë∞ÉÁî®Ê†∏ÂøÉÁîüÊàêÂáΩÊï∞
    await executeEmailGeneration(config);
}
// 5. [Ê†∏ÂøÉÊèêÂèñ] Â∞ÜÁîüÊàêÈÄªËæëÂ∞ÅË£Ö‰∏∫Áã¨Á´ãÂáΩÊï∞
async function executeEmailGeneration(config) {
    // Ëß£ÊûÑÈÖçÁΩÆ
    const { userMask, worldContext, allowRandom, personaId, selectedSenders, selectedBookIds } = config;
    let genCount = parseInt(config.genCount) || 3;
    if (genCount > 10) genCount = 10;

    // Ëé∑ÂèñËØ¶ÁªÜ‰∫∫ËÆæÊñáÊú¨
    let detailedPersona = "";
    if (personaId === 'current_chat' && state.activeChatId) {
         const chat = state.chats[state.activeChatId];
         detailedPersona = chat.settings.myPersona || "";
    } else if (personaId) {
         const preset = state.personaPresets.find(p => p.id === personaId);
         if (preset) detailedPersona = preset.persona;
    }

    // ÊûÑÂª∫‰∏ä‰∏ãÊñá (‰∏ñÁïå‰π¶ + ËßíËâ≤ËÆ∞ÂøÜ)
    let worldBookText = "";
    for (const bid of (selectedBookIds || [])) {
        const wb = await db.worldBooks.get(bid);
        if (wb) worldBookText += `- „Ää${wb.name}„Äã: ${wb.content.filter(e=>e.enabled).map(e=>e.content).join('; ')}\n`;
    }

    let characterContext = "";
    if (selectedSenders && selectedSenders.length > 0) {
        const activeChars = Object.values(state.chats).filter(c => !c.isGroup && selectedSenders.includes(c.name));
        if (activeChars.length > 0) {
            characterContext = "\n# „ÄêÈáçË¶Å„ÄëÊåáÂÆöÂèë‰ª∂‰∫∫ÁöÑËØ¶ÁªÜÊ°£Ê°à\n";
            activeChars.forEach(chat => {
                const memory = (chat.longTermMemory && chat.longTermMemory.length > 0) ? chat.longTermMemory.map(m => m.content).join('; ') : 'ÊöÇÊó†';
                const recentHistory = chat.history.filter(m => !m.isHidden).slice(-5).map(m => `${m.role === 'user' ? 'Êàë' : chat.name}: ${String(m.content).substring(0, 50)}`).join('\n');
                characterContext += `## Âèë‰ª∂‰∫∫: ${chat.name}\n- **‰∫∫ËÆæ**: ${chat.settings.aiPersona.substring(0, 200)}...\n- **ÈïøÊúüËÆ∞ÂøÜ**: ${memory}\n- **ÊúÄËøëÂØπËØù**: \n${recentHistory}\n\n`;
            });
        }
    }

    // Prompt
    const systemPrompt = `
# ËßíËâ≤ÔºöÈÇÆ‰ª∂Á≥ªÁªüÁîüÊàêÂô®
ËØ∑Ê†πÊçÆ‰ª•‰∏ãËÆæÂÆöÁîüÊàê **${genCount}** Â∞ÅÈÇÆ‰ª∂„ÄÇ

# Êî∂‰ª∂‰∫∫Ê°£Ê°à
- **Ë∫´‰ªΩ**: ${userMask}
${detailedPersona ? `- **ËØ¶ÁªÜËÉåÊôØ**: ${detailedPersona.replace(/\n/g, ' ')}` : ""}
- **‰∏ñÁïåËßÇ**: ${worldContext || "Áé∞‰ª£ËÅåÂú∫/ÁîüÊ¥ª"}
${worldBookText ? "- **‰∏ñÁïå‰π¶ËßÑÂàô**: \n" + worldBookText : ""}

${characterContext}

# Âèë‰ª∂‰∫∫ÂÄôÈÄâ
${selectedSenders && selectedSenders.length > 0 ? "- ÊåáÂÆöÂèë‰ª∂‰∫∫: " + selectedSenders.join(', ') : ""}
${allowRandom ? "- ÂÖÅËÆ∏ÁîüÊàêÈöèÊú∫Ë∑Ø‰∫∫/ÂπøÂëä/ÈÄöÁü•" : ""}

# ËæìÂá∫Ê†ºÂºè (JSON Only)
\`\`\`json
[
  {
    "sender": "Âèë‰ª∂‰∫∫ÂßìÂêç",
    "subject": "ÈÇÆ‰ª∂Ê†áÈ¢ò",
    "content": "ÈÇÆ‰ª∂Ê≠£Êñá (ÊîØÊåÅÊç¢Ë°åÁ¨¶\\n)",
    "timestamp_offset": 0 (Ë∑ùÁ¶ªÁé∞Âú®ÁöÑÂàÜÈíüÊï∞ÔºåË¥üÊï∞Ë°®Á§∫ËøáÂéª)
  }
]
\`\`\`
`;

    // API Ë∞ÉÁî®
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        
        let isGemini = proxyUrl.includes('generativelanguage');
        let apiConfig = toGeminiRequestData(model, apiKey, systemPrompt, [{role:'user', content:`Generate ${genCount} emails`}]);
        
        const response = isGemini ? 
            await fetch(apiConfig.url, apiConfig.data) : 
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: [{role:'system', content:systemPrompt}, {role:'user', content:`Generate ${genCount} emails`}], temperature: 1.0 })
            });

        if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");
        const data = await response.json();
        const text = getGeminiResponseText(data);
        const jsonStr = text.replace(/^```json\s*/, '').replace(/```$/, '');
        const emails = JSON.parse(jsonStr);

        const now = Date.now();
        const newEmails = emails.map(e => ({
            sender: e.sender,
            senderType: 'gen',
            recipient: userMask,
            subject: e.subject,
            content: e.content,
            timestamp: now - (e.timestamp_offset || 0) * 60000,
            isRead: false
        }));

        await db.emails.bulkAdd(newEmails);
        
        // Âà∑Êñ∞ÂàóË°®
        await renderEmailList();
        // ÊèêÁ§∫ÊàêÂäü
        await showCustomAlert("Êé•Êî∂ÊàêÂäü", `Êî∂Âà∞ ${newEmails.length} Â∞ÅÊñ∞ÈÇÆ‰ª∂„ÄÇ`);

    } catch (e) {
        console.error(e);
        alert("ÁîüÊàêÂ§±Ë¥•: " + e.message);
    }
}



// 7. ÊääÊñ∞ÂáΩÊï∞Êö¥Èú≤ÁªôÂÖ®Â±Ä

// 6. Ê†∏ÂøÉÁîüÊàêÈÄªËæë (Â¢ûÂº∫ÁâàÔºöÊîØÊåÅËÆ∞ÂøÜËØªÂèñ + Ëá™ÂÆö‰πâÊù°Êï∞)
document.getElementById('start-generate-email-btn').addEventListener('click', async () => {
    // --- 1. Ëé∑ÂèñÂü∫Á°ÄËæìÂÖ• ---
    const userMask = document.getElementById('mail-user-mask').value.trim();
    const worldContext = document.getElementById('mail-world-context').value.trim();
    const allowRandom = document.getElementById('mail-allow-random-npc').checked;
    
    // Ëé∑ÂèñËá™ÂÆö‰πâÊï∞ÈáèÔºåÈªòËÆ§‰∏∫ 3
    let genCount = parseInt(document.getElementById('mail-gen-count').value);
    if (isNaN(genCount) || genCount < 1) genCount = 3;
    if (genCount > 10) genCount = 10; // ÈôêÂà∂ÊúÄÂ§ß10Êù°Èò≤Ê≠¢Ë∂ÖÊó∂

    // Ëé∑ÂèñËØ¶ÁªÜ‰∫∫ËÆæ (‰∏ä‰∏ÄÊ≠•‰øÆÊîπÁöÑÂäüËÉΩ)
    const personaSelect = document.getElementById('mail-user-persona-select');
    let detailedPersona = "";
    if (personaSelect && personaSelect.value) {
        if (personaSelect.value === 'current_chat' && state.activeChatId) {
             const chat = state.chats[state.activeChatId];
             detailedPersona = chat.settings.myPersona || "";
        } else {
             const preset = state.personaPresets.find(p => p.id === personaSelect.value);
             if (preset) detailedPersona = preset.persona;
        }
    }

    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÂèë‰ª∂‰∫∫ÂêçÂ≠ó
    const selectedSenders = Array.from(document.querySelectorAll('#mail-sender-list input:checked')).map(cb => cb.value);
    const selectedBookIds = Array.from(document.querySelectorAll('#mail-context-list input:checked')).map(cb => cb.value);

    if (!userMask) return alert("ËØ∑ËÆæÁΩÆÊî∂‰ª∂‰∫∫Ë∫´‰ªΩ");
    
    const btn = document.getElementById('start-generate-email-btn');
    const originalBtnText = btn.textContent; 
    btn.textContent = "ËØªÂèñËÆ∞ÂøÜ‰∏≠...";
    btn.disabled = true;

    // --- 2. ÊûÑÂª∫‰∏ñÁïå‰π¶‰∏ä‰∏ãÊñá ---
    let worldBookText = "";
    for (const bid of selectedBookIds) {
        const wb = await db.worldBooks.get(bid);
        if (wb) worldBookText += `- „Ää${wb.name}„Äã: ${wb.content.filter(e=>e.enabled).map(e=>e.content).join('; ')}\n`;
    }

    // --- 3. „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÊûÑÂª∫ËßíËâ≤ËØ¶ÁªÜ‰∏ä‰∏ãÊñá (ËÆ∞ÂøÜ+ÂØπËØù) ---
    let characterContext = "";
    if (selectedSenders.length > 0) {
        // Âú®ÊâÄÊúâËÅäÂ§©‰∏≠Êü•ÊâæÈÄâ‰∏≠ÁöÑÂèë‰ª∂‰∫∫
        const activeChars = Object.values(state.chats).filter(c => !c.isGroup && selectedSenders.includes(c.name));
        
        if (activeChars.length > 0) {
            characterContext = "\n# „ÄêÈáçË¶Å„ÄëÊåáÂÆöÂèë‰ª∂‰∫∫ÁöÑËØ¶ÁªÜÊ°£Ê°à (ËØ∑Ê†πÊçÆËøô‰∫õ‰ø°ÊÅØÁîüÊàê‰∏™ÊÄßÂåñÈÇÆ‰ª∂)\n";
            
            activeChars.forEach(chat => {
                // ÊèêÂèñÈïøÊúüËÆ∞ÂøÜ
                const memory = (chat.longTermMemory && chat.longTermMemory.length > 0) 
                    ? chat.longTermMemory.map(m => m.content).join('; ') 
                    : 'ÊöÇÊó†';
                
                // ÊèêÂèñÊúÄËøë 5 Êù°ÂØπËØù (Áî®‰∫éÊçïÊçâÂΩìÂâçÂÖ≥Á≥ªÁä∂ÊÄÅÔºåÂ¶ÇÂêµÊû∂„ÄÅÁÉ≠ÊÅã„ÄÅÈôåÁîü)
                const recentHistory = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-5)
                    .map(m => `${m.role === 'user' ? 'Êàë' : chat.name}: ${String(m.content).substring(0, 50)}`)
                    .join('\n');

                characterContext += `## Âèë‰ª∂‰∫∫: ${chat.name}\n`;
                characterContext += `- **Ê†∏ÂøÉ‰∫∫ËÆæ**: ${chat.settings.aiPersona.substring(0, 200)}...\n`; // Êà™Âèñ‰∏ÄÈÉ®ÂàÜÈò≤Ê≠¢TokenÊ∫¢Âá∫
                characterContext += `- **ÈïøÊúüËÆ∞ÂøÜ**: ${memory}\n`;
                characterContext += `- **ÊúÄËøëÂØπËØùÁä∂ÊÄÅ**: \n${recentHistory || '(Êó†ÊúÄËøëÂØπËØù)'}\n`;
                characterContext += `> ÊåáÂØº: ËØ∑Ê†πÊçÆËØ•ËßíËâ≤ÁöÑÊÄßÊ†ºÂíå‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÁä∂ÊÄÅÔºà‰æãÂ¶ÇÊòØÂê¶ÂàöÂêµËøáÊû∂„ÄÅÊòØÂê¶ÊúâÊú™ÂÆåÊàêÁöÑÁ∫¶ÂÆöÔºâÊù•Êí∞ÂÜôÈÇÆ‰ª∂„ÄÇ\n\n`;
            });
        }
    }

    // --- 4. ÊûÑÂª∫ Prompt ---
    const systemPrompt = `
# ËßíËâ≤ÔºöÈÇÆ‰ª∂Á≥ªÁªüÁîüÊàêÂô®
ËØ∑Ê†πÊçÆ‰ª•‰∏ãËÆæÂÆöÁîüÊàê **${genCount}** Â∞ÅÈÇÆ‰ª∂„ÄÇ

# Êî∂‰ª∂‰∫∫Ê°£Ê°à
- **ÂΩìÂâçË∫´‰ªΩ(User Mask)**: ${userMask}
${detailedPersona ? `- **ËØ¶ÁªÜ‰∫∫ËÆæËÉåÊôØ**: ${detailedPersona.replace(/\n/g, ' ')}` : ""}
- **ÊâÄÂú®‰∏ñÁïåËßÇ**: ${worldContext || "Áé∞‰ª£ËÅåÂú∫/ÁîüÊ¥ª"}
${worldBookText ? "- **‰∏ñÁïå‰π¶ËßÑÂàô**: \n" + worldBookText : ""}

${characterContext}

# Âèë‰ª∂‰∫∫ÂÄôÈÄâÊ±†
${selectedSenders.length > 0 ? "- ÊåáÂÆöÂèë‰ª∂‰∫∫ÂàóË°®: " + selectedSenders.join(', ') : ""}
${allowRandom ? "- ÂÖÅËÆ∏ÁîüÊàêÈöèÊú∫Ë∑Ø‰∫∫/Á≥ªÁªüÈÄöÁü•/ÂûÉÂúæÈÇÆ‰ª∂ (Â¶Ç: Èì∂Ë°åË¥¶Âçï, ÂπøÂëä, Á•ûÁßòÈÇÄËØ∑, Â∑•‰ΩúÈÄöÂëä)" : ""}

# Ê†∏ÂøÉË¶ÅÊ±Ç
1. **ËøûË¥ØÊÄß**: Â¶ÇÊûúÂèë‰ª∂‰∫∫ÊòØ‰∏äËø∞‚ÄúÊåáÂÆöÂèë‰ª∂‰∫∫‚Äù‰∏≠ÁöÑËßíËâ≤ÔºåÈÇÆ‰ª∂ÂÜÖÂÆπ**ÂøÖÈ°ª**‰∏é‰Ω†‰ª¨ÁöÑ‚ÄúÊúÄËøëÂØπËØùÁä∂ÊÄÅ‚ÄùÂíå‚ÄúÈïøÊúüËÆ∞ÂøÜ‚ÄùÁõ∏Á¨¶„ÄÇ
   - *‰æãÂ≠ê*: Â¶ÇÊûúÊúÄËøëÂØπËØùÂú®ÂêµÊû∂ÔºåÈÇÆ‰ª∂ÂèØËÉΩÊòØÈÅìÊ≠â‰ø°ÊàñÂÜ∑Ê∑°ÁöÑÈÄöÁü•ÔºõÂ¶ÇÊûúÊúÄËøëÂú®ÁÉ≠ÊÅãÔºåÈÇÆ‰ª∂ÂèØËÉΩÊòØÊÉÖ‰π¶„ÄÇ
2. **Ê≤âÊµ∏ÊÑü**: ÈÇÆ‰ª∂ÂÜÖÂÆπÂøÖÈ°ªÁ¨¶ÂêàÊî∂‰ª∂‰∫∫Ë∫´‰ªΩÂíå‰∏ñÁïåËßÇ„ÄÇ
3. **Â§öÊ†∑ÊÄß**: ÂåÖÂê´‰∏çÂêåÁ±ªÂûãÁöÑÈÇÆ‰ª∂ÔºàÊ≠£Âºè„ÄÅÈùûÊ≠£Âºè„ÄÅÂûÉÂúæÈÇÆ‰ª∂„ÄÅÁ¥ßÊÄ•ÈÄöÁü•Ôºâ„ÄÇ
4. **Ê†ºÂºè**: ËøîÂõû‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ

# ËæìÂá∫Ê†ºÂºè (JSON Only)
\`\`\`json
[
  {
    "sender": "Âèë‰ª∂‰∫∫ÂßìÂêç",
    "subject": "ÈÇÆ‰ª∂Ê†áÈ¢ò",
    "content": "ÈÇÆ‰ª∂Ê≠£Êñá (ÊîØÊåÅÊç¢Ë°åÁ¨¶\\n)",
    "timestamp_offset": 0 (Ë∑ùÁ¶ªÁé∞Âú®ÁöÑÂàÜÈíüÊï∞ÔºåË¥üÊï∞Ë°®Á§∫ËøáÂéªÔºå‰æãÂ¶Ç 60 Ë°®Á§∫‰∏ÄÂ∞èÊó∂ÂâçÊî∂Âà∞)
  }
]
\`\`\`
`;

    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        btn.textContent = "ÁîüÊàê‰∏≠...";
        
        let isGemini = proxyUrl.includes('generativelanguage');
        let config = toGeminiRequestData(model, apiKey, systemPrompt, [{role:'user', content:`Generate ${genCount} emails`}]);
        
        const response = isGemini ? 
            await fetch(config.url, config.data) : 
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({ model: model, messages: [{role:'system', content:systemPrompt}, {role:'user', content:`Generate ${genCount} emails`}], temperature: 1.0 })
            });

        if (!response.ok) throw new Error("APIËØ∑Ê±ÇÂ§±Ë¥•");
        const data = await response.json();
        const text = getGeminiResponseText(data);
        const jsonStr = text.replace(/^```json\s*/, '').replace(/```$/, '');
        const emails = JSON.parse(jsonStr);

        // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        const now = Date.now();
        const newEmails = emails.map(e => ({
            sender: e.sender,
            senderType: 'gen',
            recipient: userMask,
            subject: e.subject,
            content: e.content,
            timestamp: now - (e.timestamp_offset || 0) * 60000,
            isRead: false
        }));

        await db.emails.bulkAdd(newEmails);
        
        document.getElementById('email-generator-modal').classList.remove('visible');
        await renderEmailList();
        await showCustomAlert("Êé•Êî∂ÊàêÂäü", `Êî∂Âà∞ ${newEmails.length} Â∞ÅÊñ∞ÈÇÆ‰ª∂„ÄÇ`);

    } catch (e) {
        console.error(e);
        alert("Êé•Êî∂Â§±Ë¥•: " + e.message);
    } finally {
        btn.textContent = originalBtnText;
        btn.disabled = false;
    }
});

// 7. ËΩ¨ÂèëÂà∞ËÅäÂ§© (Âç°ÁâáÁâà)
async function forwardEmailToChat(email) {
    // ÂºπÂá∫ÈÄâÊã©ËÅäÂ§©ÂØπË±°ÁöÑÂºπÁ™ó (Â§çÁî®Áé∞ÊúâÁöÑ)
    await openShareTargetPicker();
    
    const confirmBtn = document.getElementById('confirm-share-target-btn');
    
    // ‰ΩøÁî® cloneNode ÁßªÈô§ÊóßÁõëÂê¨Âô®
    const newBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
    
    newBtn.onclick = async () => {
        const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
            .map(cb => cb.dataset.chatId);

        if (selectedTargetIds.length === 0) return alert("ËØ∑ÈÄâÊã©Ë¶ÅËΩ¨ÂèëÂà∞ÁöÑËÅäÂ§©„ÄÇ");

        // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÔºö‰∏çÂÜçÊãºÊé•Â≠óÁ¨¶‰∏≤ÔºåËÄåÊòØÂàõÂª∫‰∏Ä‰∏™ÁªìÊûÑÂåñÊ∂àÊÅØÂØπË±°
        const emailCardMsg = {
            role: 'user',
            type: 'forwarded_email', // Êñ∞Â¢ûÁöÑÁ±ªÂûã
            timestamp: Date.now(),
            content: `[ÈÇÆ‰ª∂] ${email.subject}`, // ÁÆÄÁï•ÊñáÊú¨ÔºåÁî®‰∫éÈ¢ÑËßà
            emailData: {
                subject: email.subject,
                sender: email.sender,
                date: new Date(email.timestamp).toLocaleString(),
                preview: email.content.replace(/\n/g, ' ').substring(0, 100), // ÊèêÂèñÂâç100Â≠óÂÅöÈ¢ÑËßà
                fullContent: email.content // ‰øùÂ≠òÂÆåÊï¥ÂÜÖÂÆπ‰æõÁÇπÂáªÊü•Áúã
            }
        };

        // Áªô AI ÁöÑÁ≥ªÁªüÊèêÁ§∫ (‰øùÊåÅ‰∏çÂèòÔºåËÆ© AI ÁêÜËß£ÈÇÆ‰ª∂ÂÜÖÂÆπ)
        const forwardContentForAI = `
üìß **ËΩ¨ÂèëÈÇÆ‰ª∂**
**Âèë‰ª∂‰∫∫:** ${email.sender}
**Êî∂‰ª∂‰∫∫:** ${email.recipient || 'Êàë'}
**‰∏ªÈ¢ò:** ${email.subject}
----------------
${email.content}
`;

        for (const targetId of selectedTargetIds) {
            const targetChat = state.chats[targetId];
            if (targetChat) {
                // 1. Êé®ÈÄÅÂç°ÁâáÊ∂àÊÅØ
                targetChat.history.push(emailCardMsg);
                
            
                const isSelfEmail = (email.sender === targetChat.name) || (email.sender === targetChat.originalName);
                
                let systemHintText = "";
                
                if (isSelfEmail) {
                    // Â¶ÇÊûúÊòØAIËá™Â∑±ÂèëÁöÑÔºåÂº∫Ë∞ÉËøôÊòØ‚ÄúÂõûÈ°æ‚Äù
                    systemHintText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Êää‰Ω†„Äê‰πãÂâçÂèëÁªôTAÁöÑËøôÂ∞ÅÈÇÆ‰ª∂„ÄëËΩ¨ÂèëÂõûÁªô‰Ω†‰∫Ü„ÄÇËØ∑Ê≥®ÊÑèÔºöËøôÂ∞ÅÈÇÆ‰ª∂ÊòØ**‰Ω†Ëá™Â∑±ÂÜô**ÁöÑÔºå‰∏çÊòØÁî®Êà∑ÂÜôÁöÑ„ÄÇÁî®Êà∑ÂèØËÉΩÊòØÊÉ≥Âíå‰Ω†ËÆ®ËÆ∫ÈÇÆ‰ª∂ÈáåÁöÑÂÜÖÂÆπÔºåÊàñËÄÖÂØπ‰Ω†ÁöÑÈÇÆ‰ª∂Ë°®Á§∫ÂõûÂ∫î„ÄÇËØ∑‰ª•‚ÄúÈÇÆ‰ª∂‰ΩúËÄÖ‚ÄùÁöÑË∫´‰ªΩËøõË°åÂõûÂ§ç„ÄÇ]`;
                } else {
                    // Â¶ÇÊûúÊòØÂà´‰∫∫ÂèëÁöÑÔºå‰øùÊåÅÂéüÊ†∑
                    systemHintText = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ËΩ¨Âèë‰∫Ü‰∏ÄÂ∞ÅÈÇÆ‰ª∂Áªô‰Ω†„ÄÇËøôÂ∞ÅÈÇÆ‰ª∂ÊòØ„Äê${email.sender}„ÄëÂÜôÁöÑ„ÄÇËØ∑Ê†πÊçÆÂÜÖÂÆπÂíå‰Ω†‰ª¨ÁöÑÂÖ≥Á≥ªÂÅöÂá∫ÂèçÂ∫î„ÄÇ]`;
                }

                // 2. Êé®ÈÄÅÁ≥ªÁªüÊèêÁ§∫ (ÈöêËóè)
                targetChat.history.push({
                    role: 'system',
                    content: `${systemHintText}\n\n--- ÈÇÆ‰ª∂ËØ¶ÊÉÖ ---\n${forwardContentForAI}`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                });
              
                
                await db.chats.put(targetChat);
            }
        }

        document.getElementById('share-target-modal').classList.remove('visible');
        await showCustomAlert("ËΩ¨ÂèëÊàêÂäü", "ÈÇÆ‰ª∂Â∑≤‰ª•Âç°ÁâáÂΩ¢ÂºèÂèëÈÄÅ„ÄÇ");
        
        // Â¶ÇÊûúÂΩìÂâçÂ∞±Âú®ËØ•ËÅäÂ§©ÔºåÂà∑Êñ∞ÊòæÁ§∫
        if (state.activeChatId && selectedTargetIds.includes(state.activeChatId)) {
             renderChatInterface(state.activeChatId);
        }
    };
}

// ÊêúÁ¥¢Ê°Ü‰∫ã‰ª∂ÁªëÂÆö
document.getElementById('mail-search-input').addEventListener('input', renderEmailList);

// Êö¥Èú≤ÁªôÂÖ®Â±Ä
window.openEmailApp = openEmailApp;
window.openEmailSettings = openEmailSettings;      
window.handleQuickReceiveMail = handleQuickReceiveMail;
window.toggleEmailEditMode = toggleEmailEditMode;
window.closeEmailDetail = closeEmailDetail;
window.deleteCurrentEmail = deleteCurrentEmail;
// --- Êñ∞Â¢ûÔºöÁ¥ßÊÄ•ÈáçÁΩÆÂ§ñËßÇÂäüËÉΩ (‰∏çÂà†Èô§È¢ÑËÆæ) ---
async function handleEmergencyAppearanceReset() {
    const confirmed = await showCustomConfirm(
        "Á°ÆËÆ§ÈáçÁΩÆÂ§ñËßÇÔºü",
        "Ê≠§Êìç‰ΩúÂ∞ÜÊääÂΩìÂâçÁöÑÂ£ÅÁ∫∏„ÄÅ‰∏ªÈ¢ò„ÄÅCSS„ÄÅÂõæÊ†áÂíåÂ≠ó‰ΩìÊÅ¢Â§ç‰∏∫ÈªòËÆ§Áä∂ÊÄÅ„ÄÇ\n\n‚úÖ ‰Ω†ÁöÑ„ÄêÈ¢ÑËÆæÂ∫ì„Äë‰∏ç‰ºöË¢´Âà†Èô§„ÄÇ\n‚úÖ Ê≠§ÂäüËÉΩÁî®‰∫é‰øÆÂ§çÂõ† CSS ÈîôËØØÂØºËá¥Êó†Ê≥ïÊâìÂºÄÂ§ñËßÇËÆæÁΩÆÁöÑÈóÆÈ¢ò„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÊâßË°åÂêóÔºü", 
        { confirmButtonClass: 'btn-danger', confirmText: 'Á´ãÂç≥ÈáçÁΩÆ' }
    );

    if (!confirmed) return;

    await showCustomAlert("Â§ÑÁêÜ‰∏≠...", "Ê≠£Âú®ÈáçÁΩÆÂ§ñËßÇÈÖçÁΩÆ...");

    try {
        // 1. ÈáçÁΩÆÂÜÖÂ≠ò‰∏≠ÁöÑ state.globalSettings Âà∞ÈªòËÆ§ÂÄº (‰ªÖÂ§ñËßÇÁõ∏ÂÖ≥)
        // Ê≥®ÊÑèÔºö‰øùÁïô API Key Á≠âÂÖ∂‰ªñËÆæÁΩÆ
        
        // ÊÅ¢Â§çÈªòËÆ§ÂõæÊ†áÂØπË±°
        const defaultAppIcons = { ...DEFAULT_APP_ICONS };
        const defaultCPhoneIcons = { ...DEFAULT_CPHONE_ICONS };

        state.globalSettings.wallpaper = 'linear-gradient(135deg, #89f7fe, #66a6ff)';
        state.globalSettings.cphoneWallpaper = 'linear-gradient(135deg, #f6d365, #fda085)';
        state.globalSettings.globalChatBackground = ''; // Ê∏ÖÈô§ÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØ
        state.globalSettings.globalCss = ''; // „ÄêÊ†∏ÂøÉ„ÄëÊ∏ÖÁ©∫ CSS
        state.globalSettings.fontUrl = '';   // Ê∏ÖÁ©∫Â≠ó‰Ωì
        state.globalSettings.theme = 'light'; // ÊÅ¢Â§ç‰∫ÆËâ≤Ê®°Âºè
        state.globalSettings.appIcons = defaultAppIcons;
        state.globalSettings.cphoneAppIcons = defaultCPhoneIcons;
        
        // ÊÅ¢Â§ç‰∫§‰∫íÂºÄÂÖ≥
        state.globalSettings.showStatusBar = false;
        state.globalSettings.showPhoneFrame = false;
        state.globalSettings.detachStatusBar = false;
        state.globalSettings.enableMinimalChatUI = false;
        state.globalSettings.alwaysShowMusicIsland = false;
        
        // Ê∏ÖÁ©∫Ëá™ÂÆö‰πâÊåâÈíÆÊéíÂ∫è
        state.globalSettings.chatActionButtonsOrder = null;

        // 2. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
        await db.globalSettings.put(state.globalSettings);
        
        // 3. Á´ãÂç≥Â∫îÁî®Êõ¥Êîπ (Âà∑Êñ∞ UI)
        localStorage.setItem('ephone-theme', 'light');
        applyTheme('light');
        
        applyGlobalWallpaper();
        applyCPhoneWallpaper();
        
        applyGlobalCss(''); // Á´ãÂç≥ÁßªÈô§ CSS Ê†∑Âºè
        applyCustomFont(''); // ÁßªÈô§Â≠ó‰Ωì
        
        applyAppIcons();
        applyCPhoneAppIcons();
        
        applyStatusBarVisibility();
        applyPhoneFrame(false);
        applyDetachStatusBarMode(false);
        applyMinimalChatUI(false);
        
        // ÈáçÁΩÆÊåâÈíÆÊéíÂ∫è
        if (typeof resetButtonOrder === 'function') {
            await resetButtonOrder(); // ËøôÊòØ‰∏Ä‰∏™Áé∞ÊúâÁöÑÂáΩÊï∞ÔºåÂ§çÁî®ÂÆÉ
        }

        await showCustomAlert("ÈáçÁΩÆÊàêÂäü", "Â§ñËßÇÂ∑≤ÊÅ¢Â§çÈªòËÆ§Áä∂ÊÄÅÔºÅ\nÁé∞Âú®‰Ω†Â∫îËØ•ÂèØ‰ª•Ê≠£Â∏∏ÊâìÂºÄÂ§ñËßÇËÆæÁΩÆÈ°µÈù¢‰∫Ü„ÄÇ");

    } catch (error) {
        console.error("ÈáçÁΩÆÂ§ñËßÇÂ§±Ë¥•:", error);
        await showCustomAlert("ÈîôËØØ", `ÈáçÁΩÆÂ§±Ë¥•: ${error.message}`);
    }
}
// --- Êñ∞Â¢ûÔºöÊÅ¢Â§çÂá∫ÂéÇËÆæÁΩÆ (ÂàùÂßãÂåñÊâÄÊúâÂÜÖÂÆπ) ---
async function handleFactoryReset() {
    // --- Èò≤ËØØËß¶Êú∫Âà∂ Á¨¨1Â±ÇÔºöÂºπÁ™óË≠¶Âëä ---
    const confirmed = await showCustomConfirm(
        "‚ò†Ô∏è ‰∏•ÈáçË≠¶ÂëäÔºöÂàùÂßãÂåñÂ∫îÁî®",
        "Ê≠§Êìç‰ΩúÂ∞Ü„ÄêÊ∞∏‰πÖÂà†Èô§„ÄëÊú¨Âú∞Â≠òÂÇ®ÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨Ôºö\n\n‚ùå ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂíåËÆæÂÆö\n‚ùå ÊâÄÊúâÂõæÁâá„ÄÅË°®ÊÉÖÂåÖ„ÄÅÈ¢ÑËÆæ\n‚ùå ÊâÄÊúâAPIÈÖçÁΩÆÂíåÂ§ñËßÇËÆæÁΩÆ\n\nÂ∫îÁî®Â∞ÜÂèòÂõûÂàöÂÆâË£ÖÊó∂ÁöÑÊ†∑Â≠ê„ÄÇÊï∞ÊçÆ‰∏ÄÊó¶Âà†Èô§Êó†Ê≥ïÊÅ¢Â§çÔºÅ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü", 
        { 
            confirmButtonClass: 'btn-danger', 
            confirmText: 'ÊàëÊòéÁôΩÔºåÁªßÁª≠' 
        }
    );

    if (!confirmed) return;

    // --- Èò≤ËØØËß¶Êú∫Âà∂ Á¨¨2Â±ÇÔºöÂº∫Âà∂ËæìÂÖ•È™åËØÅ ---
    // Ë¶ÅÊ±ÇÁî®Êà∑ÊâãÂä®ËæìÂÖ•ÁâπÂÆöÊñáÂ≠óÔºåÈò≤Ê≠¢ÊâãÊªëËøûÁÇπ
    const verificationText = "Á´ãÂç≥ÈáçÁΩÆ";
    const userInput = await showCustomPrompt(
        "ÊúÄÁªàÁ°ÆËÆ§",
        `‰∏∫‰∫ÜÁ°ÆËÆ§Ëøô‰∏çÊòØËØØÊìç‰ΩúÔºåËØ∑Âú®‰∏ãÊñπÊ°Ü‰∏≠ÂáÜÁ°ÆËæìÂÖ•‚Äú${verificationText}‚ÄùÂõõ‰∏™Â≠óÔºö`,
        "",
        "text"
    );

    if (userInput !== verificationText) {
        await showCustomAlert("Êìç‰ΩúÂèñÊ∂à", "È™åËØÅÊñáÂ≠óËæìÂÖ•ÈîôËØØÔºåÂàùÂßãÂåñÂ∑≤ÂèñÊ∂à„ÄÇ");
        return;
    }

    // --- ÊâßË°åÊ∏ÖÁêÜ ---
    await showCustomAlert("Ê≠£Âú®ÈáçÁΩÆ...", "Ê≠£Âú®ÈîÄÊØÅÊâÄÊúâÊï∞ÊçÆÔºåÂ∫îÁî®Âç≥Â∞ÜÈáçÂêØ...");

    try {
        // 1. Ê∏ÖÁ©∫ IndexedDB ÊâÄÊúâË°®
        // Êàë‰ª¨‰∏ç‰ΩøÁî® db.delete() ÊòØ‰∏∫‰∫ÜÈÅøÂÖçÈáçËøûÊï∞ÊçÆÂ∫ìÁöÑÂ§çÊùÇÊÄßÔºåÁõ¥Êé•Ê∏ÖÁ©∫Ë°®ÂÜÖÂÆπÊïàÊûú‰∏ÄÊ†∑‰∏îÊõ¥Á®≥
        await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
                console.log(`Ê≠£Âú®Ê∏ÖÁ©∫Ë°®: ${table.name}`);
                await table.clear();
            }
        });

        // 2. Ê∏ÖÁ©∫ LocalStorage (ÂåÖÊã¨‰∏ªÈ¢ò„ÄÅËØ≠Ë®Ä„ÄÅÊú™ËØªËÆ°Êï∞„ÄÅ‰∏¥Êó∂ÁºìÂ≠òÁ≠â)
        localStorage.clear();

        // 3. Âº∫Âà∂Âà∑Êñ∞È°µÈù¢
        // Âª∂Ëøü‰∏Ä‰∏ãËÆ©Áî®Êà∑ÁúãÂà∞ÊèêÁ§∫ÔºåÁÑ∂ÂêéÂà∑Êñ∞ÈáçËΩΩÊï¥‰∏™Â∫îÁî®
        setTimeout(() => {
            window.location.reload(true);
        }, 1000);

    } catch (error) {
        console.error("ÂàùÂßãÂåñÂ§±Ë¥•:", error);
        await showCustomAlert("ÈîôËØØ", `ÈáçÁΩÆËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ: ${error.message}\nËØ∑Â∞ùËØïÊâãÂä®Ê∏ÖÈô§ÊµèËßàÂô®ÁºìÂ≠ò„ÄÇ`);
    }
}



const enableNotifyBtn = document.getElementById('enable-system-notifications-btn');
if (enableNotifyBtn) {
    // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
    if ('Notification' in window && Notification.permission === 'granted') {
        enableNotifyBtn.textContent = "Â∑≤ÊéàÊùÉ";
        enableNotifyBtn.disabled = true;
        enableNotifyBtn.style.backgroundColor = "#4cd964"; // ÁªøËâ≤
        enableNotifyBtn.style.color = "white";
    }

    enableNotifyBtn.addEventListener('click', async () => {
        if (!('Notification' in window)) {
            alert("ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÁ≥ªÁªüÈÄöÁü•„ÄÇ");
            return;
        }

        try {
            // ËØ∑Ê±ÇÊùÉÈôê
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                enableNotifyBtn.textContent = "Â∑≤ÊéàÊùÉ";
                enableNotifyBtn.disabled = true;
                enableNotifyBtn.style.backgroundColor = "#4cd964";
                enableNotifyBtn.style.color = "white";
                
                // Á´ãÂç≥Âèë‰∏ÄÊù°ËØïËØï
                new Notification("EPhone", { body: "Á≥ªÁªüÈÄöÁü•ÊéàÊùÉÊàêÂäüÔºÅ" });
            } else {
                alert("ÊùÉÈôêË¢´ÊãíÁªù„ÄÇËØ∑Âú®ÊâãÊú∫Á≥ªÁªüËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏Êú¨Â∫îÁî®ÂèëÈÄÅÈÄöÁü•„ÄÇ");
            }
        } catch (error) {
            console.error(error);
            alert("ÊéàÊùÉËØ∑Ê±ÇÂá∫ÈîôÔºåËØ∑Á°Æ‰øùÂ∑≤Â∞ÜÁΩëÈ°µÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπï„ÄÇ");
        }
    });
}

// ========== ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÔºàÂÆåÊï¥ÁßªÊ§çËá™ÂñµÂëú34.htmlÔºâ==========
// ÂàõÂª∫ÈùôÈü≥Èü≥È¢ëÂÖÉÁ¥†ÔºàHTML5ÈôçÁ∫ßÊñπÊ°àÔºâ
const silentAudio = document.createElement('audio');
silentAudio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
silentAudio.loop = true;
silentAudio.volume = 0;

// ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªü
const BackgroundSystem = {
    heartbeat: {
        baseInterval: 30000,      // Âü∫ÂáÜÂøÉË∑≥Èó¥ÈöîÔºö30Áßí
        jitterRange: 10000,       // ÈöèÊú∫ÊäñÂä®ËåÉÂõ¥Ôºö¬±10Áßí
        timeoutId: null,
        isRunning: false,
        lastBeat: Date.now(),
        beatCount: 0
    },
    audio: {
        context: null,
        source: null,
        gainNode: null,
        isActive: false
    },
    state: {
        isBackground: document.hidden,
        lastActivity: Date.now(),
        networkOnline: navigator.onLine
    }
};

// ËÆ°ÁÆóÂ∏¶ÈöèÊú∫ÊäñÂä®ÁöÑ‰∏ãÊ¨°ÂøÉË∑≥Èó¥Èöî
function getNextHeartbeatInterval() {
    const { baseInterval, jitterRange } = BackgroundSystem.heartbeat;
    const jitter = Math.random() * jitterRange * 2 - jitterRange;
    const interval = baseInterval + jitter;
    return Math.max(15000, Math.min(60000, interval));
}

// ÊâßË°å‰∏ÄÊ¨°ÂøÉË∑≥
function performHeartbeat() {
    const now = Date.now();
    BackgroundSystem.heartbeat.lastBeat = now;
    BackgroundSystem.heartbeat.beatCount++;
    
    const state = {
        timestamp: now,
        isBackground: document.hidden,
        beatCount: BackgroundSystem.heartbeat.beatCount,
        networkOnline: navigator.onLine
    };
    
    try {
        localStorage.setItem('app_heartbeat', JSON.stringify(state));
    } catch (e) {
        console.warn('ÂøÉË∑≥Áä∂ÊÄÅÂ≠òÂÇ®Â§±Ë¥•:', e);
    }
    
    console.log(`üíì ÂêéÂè∞ÂøÉË∑≥ #${state.beatCount} | ‰∏ãÊ¨°Èó¥Èöî: ${getNextHeartbeatInterval() / 1000}Áßí`);
    
    scheduleNextHeartbeat();
}

// Ë∞ÉÂ∫¶‰∏ãÊ¨°ÂøÉË∑≥
function scheduleNextHeartbeat() {
    if (BackgroundSystem.heartbeat.timeoutId) {
        clearTimeout(BackgroundSystem.heartbeat.timeoutId);
    }
    
    const interval = getNextHeartbeatInterval();
    
    BackgroundSystem.heartbeat.timeoutId = setTimeout(() => {
        performHeartbeat();
    }, interval);
}

// ÂêØÂä®ÂøÉË∑≥Á≥ªÁªü
function startHeartbeat() {
    if (BackgroundSystem.heartbeat.isRunning) {
        console.log('ÂøÉË∑≥Â∑≤Âú®ËøêË°å‰∏≠');
        return;
    }
    
    BackgroundSystem.heartbeat.isRunning = true;
    console.log('üöÄ ÂêØÂä®ÂêéÂè∞ÂøÉË∑≥Á≥ªÁªüÔºàÈöèÊú∫ÊäñÂä®Ê®°ÂºèÔºâ');
    performHeartbeat();
}

// ÂÅúÊ≠¢ÂøÉË∑≥Á≥ªÁªü
function stopHeartbeat() {
    if (!BackgroundSystem.heartbeat.isRunning) {
        return;
    }
    
    if (BackgroundSystem.heartbeat.timeoutId) {
        clearTimeout(BackgroundSystem.heartbeat.timeoutId);
        BackgroundSystem.heartbeat.timeoutId = null;
    }
    
    BackgroundSystem.heartbeat.isRunning = false;
    console.log('‚èπÔ∏è ÂÅúÊ≠¢ÂêéÂè∞ÂøÉË∑≥Á≥ªÁªü');
}

// ÂàùÂßãÂåñÈü≥È¢ë‰øùÊ¥ª
function initAudioKeepAlive() {
    if (BackgroundSystem.audio.context) {
        return true;
    }
    
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        BackgroundSystem.audio.context = new AudioContext();
        
        const sampleRate = BackgroundSystem.audio.context.sampleRate;
        const buffer = BackgroundSystem.audio.context.createBuffer(1, sampleRate * 0.1, sampleRate);
        
        const source = BackgroundSystem.audio.context.createBufferSource();
        source.buffer = buffer;
        source.loop = true;
        
        const gainNode = BackgroundSystem.audio.context.createGain();
        gainNode.gain.value = 0;
        
        source.connect(gainNode);
        gainNode.connect(BackgroundSystem.audio.context.destination);
        
        BackgroundSystem.audio.source = source;
        BackgroundSystem.audio.gainNode = gainNode;
        
        console.log('‚úÖ Èü≥È¢ë‰∏ä‰∏ãÊñáÂàùÂßãÂåñÊàêÂäü');
        return true;
    } catch (error) {
        console.warn('‚ùå Èü≥È¢ë‰∏ä‰∏ãÊñáÂàùÂßãÂåñÂ§±Ë¥•:', error);
        return false;
    }
}

// ÂêØÂä®Èü≥È¢ë‰øùÊ¥ª
function startAudioKeepAlive() {
    if (BackgroundSystem.audio.isActive) {
        return;
    }
    
    // Â∞ùËØï‰ΩøÁî®Web Audio API
    if (initAudioKeepAlive()) {
        try {
            const { context, source } = BackgroundSystem.audio;
            
            if (context.state === 'suspended') {
                context.resume();
            }
            
            source.start(0);
            BackgroundSystem.audio.isActive = true;
            console.log('‚úÖ Web Audio API‰øùÊ¥ªÂ∑≤ÂêØÂä®');
            return;
        } catch (error) {
            console.warn('Web Audio APIÂêØÂä®Â§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî®HTML5Èü≥È¢ë:', error);
        }
    }
    
    // ÈôçÁ∫ßÂà∞HTML5Èü≥È¢ë
    try {
        silentAudio.volume = 0;
        silentAudio.play().then(() => {
            console.log('‚úÖ HTML5Èü≥È¢ë‰øùÊ¥ªÂ∑≤ÂêØÂä®');
        }).catch(error => {
            console.warn('HTML5Èü≥È¢ëÂêØÂä®Â§±Ë¥•:', error);
        });
    } catch (error) {
        console.warn('Èü≥È¢ë‰øùÊ¥ªÂêØÂä®Â§±Ë¥•:', error);
    }
}

// ÂÅúÊ≠¢Èü≥È¢ë‰øùÊ¥ª
function stopAudioKeepAlive() {
    if (BackgroundSystem.audio.isActive && BackgroundSystem.audio.source) {
        try {
            BackgroundSystem.audio.source.stop();
            BackgroundSystem.audio.isActive = false;
            console.log('‚èπÔ∏è Web Audio API‰øùÊ¥ªÂ∑≤ÂÅúÊ≠¢');
        } catch (error) {
            console.warn('ÂÅúÊ≠¢Web Audio APIÂ§±Ë¥•:', error);
        }
    }
    
    try {
        silentAudio.pause();
        silentAudio.currentTime = 0;
    } catch (error) {
        console.warn('ÂÅúÊ≠¢HTML5Èü≥È¢ëÂ§±Ë¥•:', error);
    }
}

// ÂêØÂä®‰øùÊ¥ªÁ≥ªÁªü
function startKeepAlive() {
    if (Notification.permission !== 'granted') {
        console.warn('ÈÄöÁü•ÊùÉÈôêÊú™Êéà‰∫àÔºåÊó†Ê≥ïÂêØÂä®‰øùÊ¥ª');
        return;
    }
    
    startHeartbeat();
    startAudioKeepAlive();
    localStorage.setItem('enable_background_system', 'true');
    console.log('‚úÖ ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÂ∑≤ÂêØÂä®');
}

// ÂÅúÊ≠¢‰øùÊ¥ªÁ≥ªÁªü
function stopKeepAlive() {
    stopHeartbeat();
    stopAudioKeepAlive();
    localStorage.setItem('enable_background_system', 'false');
    console.log('‚èπÔ∏è ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÂ∑≤ÂÅúÊ≠¢');
}

// ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
document.addEventListener('visibilitychange', () => {
    BackgroundSystem.state.isBackground = document.hidden;
    
    const isEnabled = localStorage.getItem('enable_background_system') === 'true';
    if (isEnabled && Notification.permission === 'granted') {
        if (document.hidden) {
            console.log('È°µÈù¢ÂàáÂà∞ÂêéÂè∞Ôºå‰øùÊ¥ªÁ≥ªÁªüÁªßÁª≠ËøêË°å');
        } else {
            console.log('È°µÈù¢ÂàáÂà∞ÂâçÂè∞');
        }
    }
});

// È°µÈù¢Âä†ËΩΩÊó∂ÔºåÂ¶ÇÊûú‰πãÂâçÂ∑≤ÂêØÁî®‰øùÊ¥ªÔºåËá™Âä®ÂêØÂä®
if (localStorage.getItem('enable_background_system') === 'true' && Notification.permission === 'granted') {
    startKeepAlive();
}

// ÁªëÂÆöÈÄöÁü•ÊùÉÈôêÂºÄÂÖ≥‰∫ã‰ª∂
const notificationSwitch = document.getElementById('notification-permission-switch');
if (notificationSwitch) {
    notificationSwitch.addEventListener('change', (e) => {
        if (e.target.checked) {
            // ÂºÄÂÖ≥ÊâìÂºÄÊó∂ÔºåËØ∑Ê±ÇÊùÉÈôêÂπ∂ÂêØÂä®ÂêéÂè∞ÊúçÂä°
            if (Notification.permission === 'granted') {
                // Â¶ÇÊûúÂ∑≤ÊéàÊùÉÔºåÁõ¥Êé•ÂêØÂä®‰øùÊ¥ª
                startKeepAlive();
            } else if (Notification.permission === 'default') {
                // Â¶ÇÊûúÊú™ÊéàÊùÉÔºåËØ∑Ê±ÇÊùÉÈôê
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        startKeepAlive();
                    }
                });
            }
        } else {
            // ÂºÄÂÖ≥ÂÖ≥Èó≠Êó∂ÔºåÂÅúÊ≠¢ÂêéÂè∞ÊúçÂä°
            stopKeepAlive();
        }
    });
}

// Â¶ÇÊûúÈÄöÁü•ÊùÉÈôêÂ∑≤Êéà‰∫àÔºå‰∏îÂºÄÂÖ≥ÊòØÂºÄÂêØÁä∂ÊÄÅÔºåËá™Âä®ÂêØÂä®‰øùÊ¥ª
if (Notification.permission === 'granted') {
    const notificationSwitch = document.getElementById('notification-permission-switch');
    if (notificationSwitch && notificationSwitch.checked) {
        startKeepAlive();
    }
}

// ========== ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÁªìÊùü ==========

// 2. ÊµãËØïÁ≥ªÁªüÈÄöÁü•Ôºà5ÁßíÂêéÂèëÈÄÅÔºâ
const testSystemNotifyBtn = document.getElementById('test-system-notify-btn');
if (testSystemNotifyBtn) {
    testSystemNotifyBtn.addEventListener('click', () => {
        // Ê£ÄÊü•ÈÄöÁü•ÊùÉÈôê
        if (!('Notification' in window)) {
            alert('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈÄöÁü•ÂäüËÉΩ');
            return;
        }
        
        if (Notification.permission !== 'granted') {
            alert('ËØ∑ÂÖàÊéà‰∫àÈÄöÁü•ÊùÉÈôêÔºÅ\n\nËØ∑ÁÇπÂáªÊµèËßàÂô®Âú∞ÂùÄÊ†èÊóÅËæπÁöÑÈîÅÂõæÊ†áÔºåÁÑ∂ÂêéÂÖÅËÆ∏ÈÄöÁü•ÊùÉÈôê„ÄÇ');
            return;
        }
        
        // Á´ãÂç≥ÂèëÈÄÅÂâçÂè∞ÊµãËØïÈÄöÁü•
        try {
            const notification = new Notification('ÂâçÂè∞ÈÄöÁü•ÊµãËØï', {
                body: 'ËøôÊòØ‰∏ÄÊù°ÂâçÂè∞ÊµãËØïÈÄöÁü•„ÄÇÂ¶ÇÊûúÊÇ®ÁúãÂà∞ËøôÊù°Ê∂àÊÅØÔºåËØ¥ÊòéÂâçÂè∞ÈÄöÁü•ÂäüËÉΩÊ≠£Â∏∏Â∑•‰ΩúÔºÅ',
                tag: 'test-notification',
                requireInteraction: false,
                silent: false
            });
            
            notification.onclick = () => {
                window.focus();
                notification.close();
            };
            
            setTimeout(() => notification.close(), 5000);
            console.log('‚úÖ ÂâçÂè∞ÊµãËØïÈÄöÁü•Â∑≤ÂèëÈÄÅ');
        } catch (error) {
            console.error('‚ùå ÂèëÈÄÅÂâçÂè∞ÊµãËØïÈÄöÁü•Â§±Ë¥•:', error);
            alert('ÂèëÈÄÅÊµãËØïÈÄöÁü•Â§±Ë¥•Ôºö' + error.message);
            return;
        }
        
        // ËØ¢ÈóÆÊòØÂê¶ÊµãËØïÂêéÂè∞ÈÄöÁü•
        if (confirm('ÂâçÂè∞ÊµãËØïÈÄöÁü•Â∑≤ÂèëÈÄÅÔºÅ\n\nÊòØÂê¶ÁªßÁª≠ÊµãËØïÂêéÂè∞ÈÄöÁü•Ôºü\n\nÁÇπÂáª"Á°ÆÂÆö"ÂêéÔºåËØ∑Á´ãÂç≥ÂàáÊç¢Âà∞ÂÖ∂‰ªñÂ∫îÁî®ÊàñÈîÅÂ±èÔºÅ\n\n10ÁßíÂêé‰ºöÂèëÈÄÅÂêéÂè∞ÊµãËØïÈÄöÁü•„ÄÇ')) {
            alert('ËØ∑Á´ãÂç≥ÂàáÊç¢Âà∞ÂÖ∂‰ªñÂ∫îÁî®ÊàñÈîÅÂ±èÔºÅ\n\n10ÁßíÂêé‰ºöÂèëÈÄÅÈÄöÁü•ÔºåÊµãËØïÂêéÂè∞ÈÄöÁü•ÂäüËÉΩÊòØÂê¶Ê≠£Â∏∏„ÄÇ');
            
            console.log('üß™ ÂêéÂè∞ÈÄöÁü•ÊµãËØïÔºö10ÁßíÂÄíËÆ°Êó∂ÂºÄÂßã');
            
            let countdown = 10;
            const countdownInterval = setInterval(() => {
                console.log(`‚è∞ ÂÄíËÆ°Êó∂: ${countdown} Áßí`);
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            setTimeout(() => {
                console.log('üì§ 10ÁßíÂ∑≤Âà∞ÔºåÂèëÈÄÅÂêéÂè∞ÊµãËØïÈÄöÁü•...');
                
                try {
                    const notification = new Notification('ÂêéÂè∞ÈÄöÁü•ÊµãËØï', {
                        body: 'Â¶ÇÊûú‰Ω†Âú®ÈîÅÂ±è/ÂÖ∂‰ªñÂ∫îÁî®ÁúãÂà∞ËøôÊù°ÈÄöÁü•ÔºåËØ¥ÊòéÂêéÂè∞ÈÄöÁü•ÂäüËÉΩÂÆåÂÖ®Ê≠£Â∏∏ÔºÅüéâ',
                        tag: 'background-test',
                        requireInteraction: false,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    setTimeout(() => notification.close(), 10000);
                    console.log('‚úÖ ÂêéÂè∞ÊµãËØïÈÄöÁü•Â∑≤ÂèëÈÄÅ');
                } catch (error) {
                    console.error('‚ùå ÂèëÈÄÅÂêéÂè∞ÊµãËØïÈÄöÁü•Â§±Ë¥•:', error);
                    alert('ÂèëÈÄÅÂêéÂè∞ÊµãËØïÈÄöÁü•Â§±Ë¥•Ôºö' + error.message);
                }
            }, 10000);
        }
    });
}



// --- Êñ∞Â¢ûÔºöÁÆÄÊòìÂõæÁâáÊîæÂ§ßÊü•ÁúãÂô® (Áã¨Á´ã‰∫éÁõ∏ÂÜå) ---
function openSimpleImageZoom(src) {
    // 1. Ê£ÄÊü•È°µÈù¢‰∏äÊòØÂê¶Â∑≤ÁªèÊúâËøô‰∏™ÈÅÆÁΩ©Â±ÇÔºåÊ≤°ÊúâÂ∞±ÂàõÂª∫
    let overlay = document.getElementById('simple-image-zoom-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'simple-image-zoom-overlay';
        overlay.innerHTML = '<img src="" alt="Zoomed Image">';
        
        // ÁÇπÂáªÈÅÆÁΩ©Â±Ç‰ªªÊÑè‰ΩçÁΩÆÂÖ≥Èó≠
        overlay.addEventListener('click', () => {
            overlay.classList.remove('visible');
            setTimeout(() => { overlay.style.display = 'none'; }, 250);
        });
        
        document.body.appendChild(overlay);
    }

    // 2. ËÆæÁΩÆÂõæÁâáÂπ∂ÊòæÁ§∫
    const img = overlay.querySelector('img');
    img.src = src;
    
    overlay.style.display = 'flex';
    // Âº∫Âà∂ÈáçÁªò‰ª•Ëß¶Âèë transition
    void overlay.offsetWidth; 
    overlay.classList.add('visible');
}
// --- Reddit ÂäüËÉΩÊ®°Âùó ---

async function handleRedditSearch(query = '') {
    const listEl = document.getElementById('char-reddit-list');
    listEl.innerHTML = '<div class="spinner"></div>'; // Âä†ËΩΩ‰∏≠

    let targetUrl;
    if (query === 'popular' || !query) {
        targetUrl = `https://www.reddit.com/r/popular.json?limit=30&raw_json=1`;
    } else {
        targetUrl = `https://www.reddit.com/search.json?q=${encodeURIComponent(query)}&limit=30&raw_json=1&sort=relevance`;
    }

    // ‰ΩøÁî® CORS ‰ª£ÁêÜÁªïËøáË∑®ÂüüÈôêÂà∂
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

    try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error("ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•");
        
        const json = await response.json();
        const posts = json.data.children;
        
        renderRedditList(posts);
    } catch (error) {
        console.error("Reddit API Error:", error);
        listEl.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Êó†Ê≥ïËøûÊé•Âà∞ RedditÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñ‰ª£ÁêÜ„ÄÇ</p>';
    }
}
// [Modify] openRedditDetail to handle cross-screen navigation
async function openRedditDetail(post) {
    // 1. Detect if we are opening from the Chat Interface
    const isFromChat = document.getElementById('chat-interface-screen').classList.contains('active');

    const titleEl = document.getElementById('char-article-title');
    const contentEl = document.getElementById('char-article-content');
    const backBtn = document.querySelector('#char-browser-article-screen .back-btn');
    
    // Header actions setup
    let headerActions = document.querySelector('#char-browser-article-screen .header .header-actions');
    if (!headerActions) {
        const header = document.querySelector('#char-browser-article-screen .header');
        headerActions = document.createElement('div');
        headerActions.className = 'header-actions';
        header.appendChild(headerActions);
    }

    // UI Loading State
    titleEl.textContent = "Âä†ËΩΩ‰∏≠...";
    contentEl.innerHTML = '<div class="spinner" style="margin-top:50px;"></div>';
    
    // 2. Critical Fix: Switch Main Screen if coming from Chat
    if (isFromChat) {
        showScreen('character-phone-screen');
    }
    
    // Switch Sub-screen
    switchToCharScreen('char-browser-article-screen');

    // 3. Configure Back Button based on source
    const newBackBtn = backBtn.cloneNode(true);
    backBtn.parentNode.replaceChild(newBackBtn, backBtn);
    newBackBtn.onclick = () => {
        if (isFromChat) {
            // If from chat, go back to chat
            showScreen('chat-interface-screen');
        } else {
            // If from app list, go back to app list
            switchToCharScreen('char-reddit-screen');
        }
    };
    
    // 4. Setup Forward Button
    headerActions.innerHTML = '';
    const forwardBtn = document.createElement('span');
    forwardBtn.className = 'action-btn';
    forwardBtn.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>`;
    forwardBtn.title = "ËΩ¨ÂèëÁªôTA";
    headerActions.appendChild(forwardBtn);

    // 5. Handle Inner Links
    contentEl.onclick = async (e) => {
        const link = e.target.closest('a.reddit-inner-link');
        if (link) {
            e.preventDefault();
            const href = link.href;
            const redditMatch = href.match(/reddit\.com\/r\/[^\/]+\/comments\/([a-zA-Z0-9]+)/);
            if (redditMatch) {
                const urlObj = new URL(href);
                const permalink = urlObj.pathname; 
                // Recursively open, preserving context logic is tricky, so we treat inner links as internal nav
                await openRedditDetail({ permalink: permalink });
            } else {
                window.open(href, '_blank');
            }
        }
    };

    try {
        // 6. Fetch Data
        const permalink = post.permalink;
        if (!permalink) throw new Error("Êó†ÊïàÁöÑÂ∏ñÂ≠êÈìæÊé•");

        const targetUrl = `https://www.reddit.com${permalink}.json?raw_json=1`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
        
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error("Êó†Ê≥ïÂä†ËΩΩÂ∏ñÂ≠êËØ¶ÊÉÖ");

        const json = await response.json();
        const fullPostData = json[0].data.children[0].data;
        const commentsData = json[1].data.children;
        
        // Forward Logic Data Object
        const postObjForForward = {
            id: fullPostData.id,
            title: fullPostData.title,
            subreddit_name_prefixed: fullPostData.subreddit_name_prefixed,
            author: fullPostData.author,
            score: fullPostData.score,
            num_comments: fullPostData.num_comments,
            permalink: fullPostData.permalink,
            selftext: fullPostData.selftext || '',
            thumbnail: (fullPostData.preview && fullPostData.preview.images[0]) ? fullPostData.preview.images[0].source.url.replace(/&amp;/g, '&') : (fullPostData.thumbnail && fullPostData.thumbnail.startsWith('http') ? fullPostData.thumbnail : null),
            url: fullPostData.url
        };
        
        forwardBtn.onclick = () => {
            forwardRedditPost(null, postObjForForward); 
        };

        // Render Title
        titleEl.textContent = fullPostData.subreddit_name_prefixed;

        let htmlContent = '';

        // A. Header
        htmlContent += `
            <div style="margin-bottom: 15px;">
                <h2 style="font-size: 20px; font-weight: bold; margin: 0 0 8px 0;">${escapeHTML(fullPostData.title)}</h2>
                <div style="color: #888; font-size: 12px;">
                    u/${fullPostData.author} ‚Ä¢ ${new Date(fullPostData.created_utc * 1000).toLocaleString()}
                </div>
            </div>
        `;

        // B. Media
        const ytMatch = fullPostData.url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([^"&?\/\s]{11})/);
        
        if (ytMatch) {
            const videoId = ytMatch[1];
            htmlContent += `
                <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; margin-bottom: 10px; background: #000;">
                    <iframe src="https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&playsinline=1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" frameborder="0" allowfullscreen></iframe>
                </div>`;
        } else if (fullPostData.is_video && fullPostData.media && fullPostData.media.reddit_video) {
            htmlContent += `
    <video controls playsinline poster="${fullPostData.thumbnail}" style="width: 100%; border-radius: 8px; margin-bottom: 5px; background: #000;">
        <source src="${fullPostData.media.reddit_video.fallback_url}" type="video/mp4">
    </video>
    <div style="font-size:12px; color:#999; margin-bottom:15px;">
        ‚ö†Ô∏è Ê≥®ÔºöRedditÂéüÁîüËßÜÈ¢ëÂèØËÉΩÊó†Â£∞Ôºå<a href="${fullPostData.url}" target="_blank" style="color:#007aff;">ÁÇπÂáªÊ≠§Â§ÑË∑≥ËΩ¨ÂéüÁΩëÈ°µËßÇÁúã</a>
    </div>`;
        } else if (fullPostData.url && fullPostData.url.match(/\.(jpg|jpeg|png|gif)$/i)) {
            htmlContent += `<img src="${fullPostData.url}" style="width:100%; border-radius:8px; margin-bottom:15px;">`;
        } else if (fullPostData.preview && fullPostData.preview.images && fullPostData.preview.images.length > 0) {
            const imgUrl = fullPostData.preview.images[0].source.url.replace(/&amp;/g, '&');
            htmlContent += `<img src="${imgUrl}" style="width:100%; border-radius:8px; margin-bottom:15px;">`;
        }

        // C. Text
        if (fullPostData.selftext) {
            let processedText = escapeHTML(fullPostData.selftext);
            processedText = processedText.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" class="reddit-inner-link" style="color:#007aff; text-decoration:none;">$1</a>');
            processedText = processedText.replace(/(^|\s)(https?:\/\/[^\s<]+)/g, '$1<a href="$2" class="reddit-inner-link" style="color:#007aff; text-decoration:none;">üîó Link</a>');
            processedText = processedText.replace(/\n/g, '<br>');
            htmlContent += `<div style="line-height:1.6; font-size:15px; color:#333; margin-bottom:20px; word-break: break-word;">${processedText}</div>`;
        } 

        // D. Data Bar
        const score = fullPostData.score > 1000 ? (fullPostData.score/1000).toFixed(1) + 'k' : fullPostData.score;
        htmlContent += `
            <div style="display:flex; gap:20px; padding:10px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; margin-bottom:15px; font-size:13px; color:#555; align-items:center;">
                <span style="display:flex; align-items:center; gap:4px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#ff4500;">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg> 
                    ${score} Ëµû
                </span>
                <span style="display:flex; align-items:center; gap:4px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                    ${fullPostData.num_comments} ËØÑËÆ∫
                </span>
            </div>
        `;

        // E. Comments
        htmlContent += `<div style="font-weight:bold; margin-bottom:10px;">ËØÑËÆ∫</div>`;
        if (commentsData.length === 0) {
            htmlContent += `<div style="text-align:center; color:#999; padding:20px;">ÊöÇÊó†ËØÑËÆ∫</div>`;
        } else {
            commentsData.forEach(child => {
                const c = child.data;
                if (!c.body) return;
                htmlContent += `
                    <div class="reddit-comment-item" style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #f9f9f9;">
                        <div style="font-size:12px; color:#888; margin-bottom:4px; display:flex; justify-content:space-between;">
                            <span style="color: #1c1c1e; font-weight: 500;">${c.author}</span>
                            <span>${c.score} pts</span>
                        </div>
                        <div style="font-size:14px; line-height:1.5; color:#333;">${escapeHTML(c.body).replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            });
        }

        contentEl.innerHTML = htmlContent;
        contentEl.scrollTop = 0;

    } catch (error) {
        console.error("Reddit Detail Error:", error);
        contentEl.innerHTML = `
            <div style="padding:20px; text-align:center;">
                <h3>Âä†ËΩΩÂ§±Ë¥•</h3>
                <p style="color:#888; font-size:14px;">${error.message}</p>
            </div>
        `;
    }
}
function renderRedditList(posts) {
    const listEl = document.getElementById('char-reddit-list');
    listEl.innerHTML = '';

    if (!posts || posts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Êú™ÊâæÂà∞ÂÜÖÂÆπ</p>';
        return;
    }

    posts.forEach(child => {
        const post = child.data;
        
        // ÂõæÁâáÊèêÂèñÈÄªËæë
        let previewImage = '';
        if (post.preview && post.preview.images && post.preview.images.length > 0) {
            previewImage = post.preview.images[0].source.url.replace(/&amp;/g, '&');
        } else if (post.thumbnail && post.thumbnail.startsWith('http')) {
            previewImage = post.thumbnail;
        }

        const item = document.createElement('div');
        item.className = 'reddit-post-item';
        
        // ÂàÜÊï∞ÊòæÁ§∫‰ºòÂåñ
        const score = post.score > 1000 ? (post.score/1000).toFixed(1) + 'k' : post.score;

        item.innerHTML = `
            <div class="reddit-vote-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ff4500;">
                    <path d="M12 19V5M5 12l7-7 7 7"/>
                </svg>
                <span style="font-weight:bold; margin-top:2px;">${score}</span>
            </div>
            <div class="reddit-content-box">
                <div class="reddit-meta">
                    <div class="reddit-sub-icon"></div>
                    <strong>${post.subreddit_name_prefixed}</strong>
                    <span>‚Ä¢ u/${post.author}</span>
                </div>
                <div class="reddit-title">${post.title}</div>
                ${previewImage ? `<img src="${previewImage}" class="reddit-preview-img" loading="lazy">` : ''}
                
                <button class="reddit-forward-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    ËΩ¨ÂèëÁªôTA
                </button>
            </div>
        `;
        
        // ÁºìÂ≠òÊï∞ÊçÆ‰ª•‰æøËΩ¨Âèë‰ΩøÁî®
        if (!window.redditPostCache) window.redditPostCache = new Map();
        window.redditPostCache.set(post.id, post);

        // --- „ÄêÂÖ≥ÈîÆ‰øÆÊîπ 1„ÄëÁÇπÂáªÂç°ÁâáÊï¥‰Ωì -> ÊâìÂºÄËØ¶ÊÉÖÈ°µ ---
        item.addEventListener('click', () => {
            openRedditDetail(post);
        });

        // --- „ÄêÂÖ≥ÈîÆ‰øÆÊîπ 2„ÄëÁÇπÂáªËΩ¨ÂèëÊåâÈíÆ -> Ëß¶ÂèëËΩ¨Âèë (Âπ∂ÈòªÊ≠¢ÂÜíÊ≥°) ---
        const forwardBtn = item.querySelector('.reddit-forward-btn');
        forwardBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // ÈòªÊ≠¢Ëß¶ÂèëËØ¶ÊÉÖÈ°µË∑≥ËΩ¨
            forwardRedditPost(post.id); // Áõ¥Êé•Ë∞ÉÁî®ÂáΩÊï∞
        });

        listEl.appendChild(item);
    });
}

// [‰øÆÊîπ] ËΩ¨Âèë Reddit Â∏ñÂ≠ê (ÊîØÊåÅÈÄâ‰∫∫ + ‰∏çÁ´ãÂç≥ÂõûÂ§ç)
// ÂèÇÊï∞: postId (‰ªéÂàóË°®ÁÇπÂáªÊó∂‰º†ÂÖ•), directData (‰ªéËØ¶ÊÉÖÈ°µÁÇπÂáªÊó∂Áõ¥Êé•‰º†ÂÖ•Êï∞ÊçÆÂØπË±°)
async function forwardRedditPost(postId, directData = null) {
    // 1. Ëé∑ÂèñÂ∏ñÂ≠êÊï∞ÊçÆ
    let post;
    if (directData) {
        post = directData;
    } else {
        // ÂàóË°®Ê®°ÂºèÔºö‰ªéÁºìÂ≠òËé∑Âèñ
        if (!window.redditPostCache) window.redditPostCache = new Map();
        post = window.redditPostCache.get(postId);
    }

    if (!post) {
        alert("Êó†Ê≥ïËé∑ÂèñÂ∏ñÂ≠êÊï∞ÊçÆ");
        return;
    }

    // 2. ÂºπÂá∫ÈÄâÊã©Âô® (Â§çÁî®Áé∞ÊúâÁöÑ Share Picker)
    await openShareTargetPicker();
    
    const confirmBtn = document.getElementById('confirm-share-target-btn');
    
    // ‰ΩøÁî® cloneNode ÁßªÈô§ÊóßÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
    const newBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
    
    newBtn.onclick = async () => {
        // 3. Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÅäÂ§©ÂØπË±°
        const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
            .map(cb => cb.dataset.chatId);

        if (selectedTargetIds.length === 0) return alert("ËØ∑ÈÄâÊã©Ë¶ÅËΩ¨ÂèëÂà∞ÁöÑËÅäÂ§©„ÄÇ");

        // 4. ÊûÑÈÄ†Áî®Êà∑Âç°ÁâáÊ∂àÊÅØ (User View)
        const redditMsg = {
            role: 'user',
            type: 'reddit_share',
            timestamp: Date.now(),
            redditData: {
                title: post.title,
                subreddit: post.subreddit_name_prefixed,
                author: post.author,
                score: post.score,
                num_comments: post.num_comments,
                permalink: post.permalink,
                // Â§ÑÁêÜÂõæÁâáÈìæÊé•
                image: post.thumbnail || (post.preview && post.preview.images[0] ? post.preview.images[0].source.url.replace(/&amp;/g, '&') : null),
                selftext: post.selftext ? post.selftext.substring(0, 150) + '...' : ''
            }
        };
        
        document.getElementById('share-target-modal').classList.remove('visible');
        
        // 5. ÂêéÂè∞ÊäìÂèñÂÆåÊï¥ÂÜÖÂÆπ (Áªô AI Áúã) - ËøôÈÉ®ÂàÜÈúÄË¶Å‰∏ÄÁÇπÊó∂Èó¥
        // ‰∏∫‰∫Ü‰ΩìÈ™åÔºåÂÖàÊòæÁ§∫"Ê≠£Âú®ÂèëÈÄÅ"ÔºåÂÆûÈôÖ‰∏äÊòØÂêéÂè∞ÂºÇÊ≠•Â§ÑÁêÜ
        await showCustomAlert("ËΩ¨Âèë‰∏≠...", "Ê≠£Âú®ÁîüÊàêÈ¢ÑËßàÂπ∂ÂèëÈÄÅÔºåËØ∑Á®çÂÄô...");
        
        // ÊûÑÂª∫ AI ‰∏ä‰∏ãÊñá
        let fullContextForAI = `Ê†áÈ¢ò: "${post.title}"\nÊù•Ëá™: ${post.subreddit_name_prefixed}\n`;
        if (post.selftext) {
             fullContextForAI += `\n[ÂÜÖÂÆπÊëòË¶Å]: ${post.selftext.substring(0, 500)}...\n`;
        }
        
        // Â∞ùËØïÂºÇÊ≠•Ëé∑ÂèñÊõ¥Â§öËØ¶ÊÉÖ (ÂèØÈÄâ)
        try {
            const targetUrl = `https://www.reddit.com${post.permalink}.json?raw_json=1`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
            const res = await fetch(proxyUrl);
            if (res.ok) {
                const json = await res.json();
                const comments = json[1].data.children;
                // Ë°•ÂÖÖÂâç3Êù°ÁÉ≠ËØÑ
                if (comments.length > 0) {
                    fullContextForAI += `\n[ÁÉ≠Èó®ËØÑËÆ∫ (Top 3)]:\n`;
                    comments.slice(0, 3).forEach((c, i) => {
                        if (c.data.body) {
                            fullContextForAI += `${i+1}. ${c.data.author}: ${c.data.body.substring(0, 150)}\n`;
                        }
                    });
                }
            }
        } catch (e) {
            console.warn("ÊäìÂèñËØ¶ÊÉÖÂ§±Ë¥•Ôºå‰ªÖ‰ΩøÁî®Âü∫Êú¨‰ø°ÊÅØ", e);
        }

        // 6. Âæ™ÁéØÂèëÈÄÅÁªôÈÄâ‰∏≠ÁöÑËÅäÂ§©
        for (const targetId of selectedTargetIds) {
            const targetChat = state.chats[targetId];
            if (targetChat) {
                // A. Êé®ÈÄÅÂç°ÁâáÊ∂àÊÅØ
                targetChat.history.push(redditMsg);
                
                // B. Êé®ÈÄÅÁ≥ªÁªüÊèêÁ§∫ (ÈöêËóèÊ∂àÊÅØÔºåÁªôAIÁúã)
                const hiddenSystemMsg = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ËΩ¨Âèë‰∫Ü‰∏Ä‰∏™ Reddit Â∏ñÂ≠êÁªô‰Ω†„ÄÇ
ËØ∑‰Ω†ÈòÖËØª‰ª•‰∏ãÂ∏ñÂ≠êËØ¶ÊÉÖÂíåÁΩëÂèãËØÑËÆ∫„ÄÇ
Ê≥®ÊÑèÔºö**Áî®Êà∑ËøòÊ≤°ÊúâÂØπÊ≠§ÂèëË°®ÁúãÊ≥ï**ÔºåTAÂèØËÉΩÊ≠£Âú®ÊâìÂ≠ó„ÄÇËØ∑‰Ω†**ÂÖà‰∏çË¶ÅÂõûÂ§ç**ÔºåËÄêÂøÉÁ≠âÂæÖÁî®Êà∑Êé•‰∏ãÊù•ÁöÑÊ∂àÊÅØ„ÄÇ
---
${fullContextForAI}
---]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                targetChat.history.push(hiddenSystemMsg);
                await db.chats.put(targetChat);
            }
        }

        // 7. Ë∑≥ËΩ¨ÈÄªËæë
        // ÈöêËóèÊèêÁ§∫Ê°Ü
        document.querySelector('#custom-modal-overlay').classList.remove('visible');
        
        // Â¶ÇÊûúÂè™ÈÄâ‰∫Ü‰∏Ä‰∏™‰∫∫ÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÈÇ£‰∏™‰∫∫ÁöÑËÅäÂ§©Á™óÂè£
        if (selectedTargetIds.length === 1) {
            const targetId = selectedTargetIds[0];
            showScreen('chat-interface-screen'); // ÂàáÂà∞ËÅäÂ§©ÁïåÈù¢ÂÆπÂô®
            openChat(targetId); // Âä†ËΩΩÂÖ∑‰ΩìËÅäÂ§©
            
            // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÔºöËøôÈáå‰∏çÂÜçË∞ÉÁî® triggerAiResponse()
            // Âπ∂‰∏îËÆ©ËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπÔºåÊñπ‰æøÁî®Êà∑ÁªßÁª≠ËØ¥ËØù
            setTimeout(() => {
                const input = document.getElementById('chat-input');
                if (input) input.focus();
            }, 500);
            
        } else {
            // Â¶ÇÊûúÈÄâ‰∫ÜÂ§ö‰∏™‰∫∫ÔºåÊèêÁ§∫ÂèëÈÄÅÊàêÂäüÂπ∂ÂÅúÁïôÂú®ÂΩìÂâçÈ°µÊàñÂõûÂàóË°®
            alert(`Â∑≤ËΩ¨ÂèëÁªô ${selectedTargetIds.length} ‰ΩçÂ•ΩÂèã„ÄÇ`);
        }
    };
}
window.forwardRedditPost = forwardRedditPost;
// --- [Êõ¥Êñ∞Áâà] Ê†πÊçÆ‰∫∫ËÆæÁîüÊàê Reddit Êé®ËçêÊµÅ (ÊîØÊåÅ15-20‰∏™ÂÖ≥ÈîÆËØç + Á®≥ÂÆöÊêúÁ¥¢) ---
async function handleGenerateSimulatedReddit() {
    if (!activeCharacterId) return;
    const chat = state.chats[activeCharacterId];
    if (!chat) return;

    await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®Ê∑±Â∫¶ÂàÜÊûê‚Äú${chat.name}‚ÄùÁöÑÂÖ¥Ë∂£ÁΩëÁªú...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂ•ΩAPI‰ø°ÊÅØ„ÄÇ');
        return;
    }

    // 1. ÂáÜÂ§á‰∏ä‰∏ãÊñáÊï∞ÊçÆ
    const userDisplayNameForAI = (state.qzoneSettings.nickname === '{{user}}' || !state.qzoneSettings.nickname) ? 'Áî®Êà∑' : state.qzoneSettings.nickname;
    
    const maxMemory = chat.settings.maxMemory || 10;
    const recentHistory_RAW = chat.history.slice(-maxMemory);
    // Á°Æ‰øù filterHistoryWithDoNotSendRules ÂèØÁî®ÔºåÂ¶ÇÊûúÊä•ÈîôËØ∑Ê£ÄÊü•ËØ•ÂáΩÊï∞ÊòØÂê¶ÂÆö‰πâ
    const filteredHistory = await filterHistoryWithDoNotSendRules(recentHistory_RAW, activeCharacterId);
    const recentHistoryWithUser = filteredHistory.map(msg => `${msg.role === 'user' ? userDisplayNameForAI : chat.name}: ${String(msg.content).substring(0, 30)}...`).join('\n');
    
    const longTermMemoryContext = chat.longTermMemory && chat.longTermMemory.length > 0 ?
      chat.longTermMemory.map(mem => `- ${mem.content}`).join('\n') : 'Êó†';

    const worldBookContext = (chat.settings.linkedWorldBookIds || [])
      .map(bookId => state.worldBooks.find(wb => wb.id === bookId))
      .filter(Boolean)
      .map(book => `\n## ‰∏ñÁïå‰π¶„Ää${book.name}„Äã:\n${book.content.filter(e => e.enabled).map(e => `- ${e.content}`).join('\n')}`)
      .join('');

    // 2. ÊûÑÂª∫ Prompt (‰øÆÊîπ‰∫ÜÊï∞ÈáèË¶ÅÊ±Ç)
    const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ËôöÊãüÁî®Êà∑ÁîªÂÉèÂàÜÊûêÂ∏à„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîËßíËâ≤‚Äú${chat.name}‚ÄùÔºåÊ†πÊçÆTAÁöÑ‰∫∫ËÆæ„ÄÅÊâÄÂ§ÑÁöÑ‰∏ñÁïåËßÇ„ÄÅÈïøÊúüËÆ∞ÂøÜ„ÄÅ‰ª•Âèä‰∏éÁî®Êà∑Ôºà${userDisplayNameForAI}ÔºâÁöÑÊúÄËøë‰∫íÂä®Ôºå**Êé®ÊµãTAÁé∞Âú®ÊúÄÂèØËÉΩÂú® Reddit ‰∏äÊµèËßàÊàñÊêúÁ¥¢ÁöÑÂÖ≥ÈîÆËØç**„ÄÇ

# Ê†∏ÂøÉËßÑÂàô
1.  **ËØ≠Ë®ÄÁ≠ñÁï•**: 
    - ËØ∑Ê†πÊçÆËßíËâ≤ÁöÑ‰∫∫ËÆæÂíåÊÉ≥ÁúãÁöÑÂÜÖÂÆπÂÜ≥ÂÆöËØ≠Ë®Ä„ÄÇ
    - Â¶ÇÊûúËßíËâ≤ÊÉ≥ÁúãÂõΩÈôÖÊñ∞Èóª„ÄÅÊäÄÊúØÊñáÊ°£„ÄÅËø∑Âõ† (Memes) ÊàñÁâπÂÆöÂ§ñËØ≠ÂÜÖÂÆπÔºåËØ∑ÁîüÊàê„ÄêËã±Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ
    - Â¶ÇÊûúËßíËâ≤ÊÉ≥Áúã‰∏≠ÊñáÂúàÁöÑËÆ®ËÆ∫„ÄÅÂçéËØ≠Êñ∞ÈóªÊàñÁâπÂÆö‰∏≠ÊñáËØùÈ¢òÔºåËØ∑ÁîüÊàê„Äê‰∏≠Êñá„ÄëÂÖ≥ÈîÆËØç„ÄÇ
2.  **Ê∑±Â∫¶‰∫∫ËÆæÁªëÂÆö**: ÂÖ≥ÈîÆËØçÂøÖÈ°ªÁ¥ßÊâ£ËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÅå‰∏ö„ÄÅÁà±Â•Ω‰ª•Âèä**‰∏ñÁïåËßÇËÆæÂÆö**„ÄÇ
3.  **Â§öÊ†∑ÊÄß‰∏éÊï∞Èáè (ÂÖ≥ÈîÆ)**: ËØ∑ÁîüÊàê **15Âà∞20‰∏™** ‰∏çÂêåÁöÑÂÖ≥ÈîÆËØçÔºåÊ∂µÁõñËßíËâ≤ÂÖ¥Ë∂£ÁöÑÂêÑ‰∏™ÊñπÈù¢Ôºà‰ªéÊ†∏ÂøÉÁà±Â•ΩÂà∞ÊΩúÊÑèËØÜÁöÑÂ•ΩÂ•áÔºâ„ÄÇ
4.  **Ê†ºÂºèÈìÅÂæã**: 
    - ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
    - Êï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÊòØ‰∏Ä‰∏™**Â≠óÁ¨¶‰∏≤**„ÄÇ
    - Á§∫‰æã: \`["keyword1", "r/China_irl", "coding help", "Áå´Âí™", ...]\`

# ‰æõ‰Ω†ÂèÇËÄÉÁöÑËØ¶ÁªÜ‰∏ä‰∏ãÊñá
- **ËßíËâ≤‰∫∫ËÆæ**: ${chat.settings.aiPersona}
- **Áî®Êà∑(${userDisplayNameForAI})ÁöÑ‰∫∫ËÆæ**: ${chat.settings.myPersona || 'Êó†'}
- **ÈïøÊúüËÆ∞ÂøÜ**: 
${longTermMemoryContext}
${worldBookContext} 
- **ÊúÄËøëÂØπËØù**:
${recentHistoryWithUser}

Áé∞Âú®ÔºåËØ∑ÁîüÊàêËøôÁªÑËØ¶ÁªÜÁöÑ Reddit ÊêúÁ¥¢ÂÖ≥ÈîÆËØç„ÄÇ`;

    try {
        // 3. Ë∞ÉÁî® LLM
        const messagesForApi = [{ role: 'user', content: "ËØ∑ÁîüÊàêRedditÂÖ≥ÈîÆËØçÂàóË°®„ÄÇ" }];
        let isGemini = proxyUrl.includes('generativelanguage');
        let geminiConfig = toGeminiRequestData(model, apiKey, systemPrompt, messagesForApi);

        const response = isGemini ?
            await fetch(geminiConfig.url, geminiConfig.data) :
            await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: systemPrompt }, ...messagesForApi],
                    // ‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆÁöÑÊ∏©Â∫¶ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÈªòËÆ§ 1.0
                    temperature: state.globalSettings.apiTemperature || 1.0, 
                })
            });

        if (!response.ok) throw new Error(`API ÈîôËØØ: ${response.statusText}`);

        const data = await response.json();
        const aiResponseContent = getGeminiResponseText(data);
        const cleanedJson = aiResponseContent.replace(/^```json\s*/, '').replace(/```$/, '');
        
        let keywords;
        try {
            keywords = JSON.parse(cleanedJson);
        } catch (e) {
            throw new Error("AIËøîÂõûÊ†ºÂºèÈîôËØØÔºåÊó†Ê≥ïËß£ÊûêJSON");
        }

        if (!Array.isArray(keywords) || keywords.length === 0) throw new Error("AIÊ≤°ÊúâËøîÂõûÊúâÊïàÁöÑÂÖ≥ÈîÆËØçÊï∞ÁªÑ„ÄÇ");

        // 4. [Ê†∏ÂøÉ‰øÆÊîπ] ÈÄê‰∏™ÊêúÁ¥¢ÂÖ≥ÈîÆËØç (‰∏≤Ë°å+Âª∂ËøüÔºåÈò≤Ê≠¢Â∞ÅÂè∑)
        await showCustomAlert("ÊêúÁ¥¢‰∏≠...", `AI ÁîüÊàê‰∫Ü ${keywords.length} ‰∏™ÂÖ¥Ë∂£ÂÖ≥ÈîÆËØçÔºåÊ≠£Âú®ËÅöÂêàÂÖ®ÁΩëÂÜÖÂÆπ... (Ëøô‰∏ÄÊ≠•ÂèØËÉΩÈúÄË¶ÅÂçÅÂá†ÁßíÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ)`);
        
        const listEl = document.getElementById('char-reddit-list');
        listEl.innerHTML = '<div class="spinner" style="margin-top:50px;"></div>';

        // ‰∏çÂÜçÊà™Âèñ slice(0, 4)Ôºå‰ΩøÁî®ÂÖ®ÈÉ®ÂÖ≥ÈîÆËØç (keywords)
        const queries = keywords; 
        let aggregatedPosts = [];

        // ÂÆö‰πâÂª∂Êó∂ÂáΩÊï∞
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // ÂÆö‰πâÂçï‰∏™ÊêúÁ¥¢ÂáΩÊï∞
        const fetchRedditData = async (query) => {
            try {
                let targetUrl;
                // ÈíàÂØπ r/xxx ‰ºòÂåñ
                if (query.startsWith('r/')) {
                    // limit=5, Á®çÂæÆÂáèÂ∞ëÂçïÊ¨°ËØ∑Ê±ÇÈáèÔºåÂõ†‰∏∫Êàë‰ª¨ÊÄªËØ∑Ê±ÇÊ¨°Êï∞ÂèòÂ§ö‰∫Ü
                    targetUrl = `https://www.reddit.com/${query}/hot.json?limit=5&raw_json=1`;
                } else {
                    targetUrl = `https://www.reddit.com/search.json?q=${encodeURIComponent(query)}&limit=5&raw_json=1&sort=relevance`;
                }
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
                
                const res = await fetch(proxyUrl);
                if(!res.ok) return [];
                const json = await res.json();
                return json.data.children; 
            } catch (e) {
                console.warn(`ÊêúÁ¥¢ÂÖ≥ÈîÆËØç ${query} Â§±Ë¥•:`, e);
                return [];
            }
        };

        // [‰øÆÊîπ] ‰ΩøÁî® for...of Âæ™ÁéØ‰∏≤Ë°åËØ∑Ê±ÇÔºåËÄå‰∏çÊòØ Promise.all Âπ∂Ë°å
        // ËøôÊ†∑ËôΩÁÑ∂ÊÖ¢‰∏ÄÁÇπÔºå‰ΩÜËÉΩ‰øùËØÅ 20 ‰∏™ËØçÈÉΩËÉΩÊêúÂÆåËÄå‰∏çÁÇ∏Êé•Âè£
        for (const [index, query] of queries.entries()) {
            // Âú®ÊéßÂà∂Âè∞ÊâìÂç∞ËøõÂ∫¶ÔºåÊñπ‰æøË∞ÉËØï
            console.log(`[RedditÁîüÊàêÊµÅ] Ê≠£Âú®ÊêúÁ¥¢ (${index + 1}/${queries.length}): ${query}`);
            
            const posts = await fetchRedditData(query);
            if (posts && posts.length > 0) {
                aggregatedPosts.push(...posts);
            }
            
            // ÊØèÊ¨°ËØ∑Ê±ÇÈó¥Èöî 600ms
            await delay(600);
        }

        if (aggregatedPosts.length === 0) {
            throw new Error("ÊâÄÊúâÂÖ≥ÈîÆËØçÈÉΩÊú™ËÉΩÊêúÁ¥¢Âà∞ÂÜÖÂÆπÔºåÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÊàñÂÖ≥ÈîÆËØçÂ§™ÂÅèÈó®„ÄÇ");
        }

        // 5. ÂéªÈáç‰∏éÊâì‰π± (Ê¥óÁâåÁÆóÊ≥ï)
        const uniquePosts = [];
        const seenIds = new Set();
        
        // Ê¥óÁâå
        for (let i = aggregatedPosts.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [aggregatedPosts[i], aggregatedPosts[j]] = [aggregatedPosts[j], aggregatedPosts[i]];
        }

        // ÂéªÈáç
        aggregatedPosts.forEach(item => {
            const post = item.data;
            if (!seenIds.has(post.id)) {
                seenIds.add(post.id);
                uniquePosts.push(item);
            }
        });

        // Êà™ÂèñÂâç 30 Êù°ÊòæÁ§∫ (ÂëºÂ∫î‰Ω†‰πãÂâçÁöÑÈúÄÊ±Ç)
        const finalFeed = uniquePosts.slice(0, 30);

        // 6. ‰øùÂ≠òÊï∞ÊçÆÂà∞Êï∞ÊçÆÂ∫ì (ÊåÅ‰πÖÂåñ)
        chat.simulatedRedditFeed = finalFeed; 
        await db.chats.put(chat);             
        console.log(`Reddit Êé®ËçêÊµÅÂ∑≤‰øùÂ≠òÔºåÂÖ± ${finalFeed.length} Êù°`);

        // 7. Ê∏≤Êüì
        renderRedditList(finalFeed);
        
        // Êõ¥Êñ∞ÂºπÁ™óÊèêÁ§∫ÂÆåÊàê
        // (showCustomAlert ÈªòËÆ§ÊúâÁ°ÆËÆ§ÊåâÈíÆÔºå‰∏∫‰∫Ü‰ΩìÈ™åÂèØ‰ª•‰∏çÂºπÊñ∞ÁöÑÔºåÊàñËÄÖËá™Âä®ÂÖ≥Èó≠ÊóßÁöÑ)
        // ËøôÈáåÊàë‰ª¨Áõ¥Êé•ËÆ©ÁïåÈù¢ÊòæÁ§∫Âá∫Êù•Âç≥ÂèØ

    } catch (error) {
        console.error("ÁîüÊàê Reddit Êé®ËçêÂ§±Ë¥•:", error);
        await showCustomAlert("ÁîüÊàêÂ§±Ë¥•", `Êó†Ê≥ïÁîüÊàêÊé®ËçêÂÜÖÂÆπ„ÄÇ\nÈîôËØØ: ${error.message}`);
        // Â§±Ë¥•Êó∂ÂõûÈÄÄÂà∞ÁÉ≠Èó®
        handleRedditSearch('popular');
    }
}
  async function init() {

    initLanguage();
 
    async function handleWorldBookImport(file) {
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (data.type === 'EPhoneWorldBookBackup') {

          console.log("Ê£ÄÊµãÂà∞ EPhone Â§á‰ªΩÊñá‰ª∂ÔºåÊâßË°åÊ†áÂáÜÂØºÂÖ•...");
          await importWorldBooks(data);
        } else if (data.entries && typeof data.entries === 'object') {

          console.log("Ê£ÄÊµãÂà∞ ‰∏ñÁïå‰π¶Êñá‰ª∂ÔºåÈúÄË¶ÅÊøÄÊ¥ªÁ†Å...");


          try {
            
            await requirePinActivation();

           
            await importTavernWorldBook(data, file.name);

          } catch (error) {
           
            console.warn("‰∏ñÁïå‰π¶ÂØºÂÖ•Ë¢´ÂèñÊ∂à:", error.message);
          }


        } else {
          throw new Error("Êñá‰ª∂Ê†ºÂºèÊó†Ê≥ïËØÜÂà´„ÄÇËØ∑Á°Æ‰øùÊÇ®ÈÄâÊã©ÁöÑÊòØÊúâÊïàÁöÑ EPhone ‰∏ñÁïå‰π¶Â§á‰ªΩÊàñ Tavern AI ‰∏ñÁïå‰π¶Êñá‰ª∂„ÄÇ");
        }

      } catch (error) {
        console.error("ÂØºÂÖ•‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:", error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
      }
    }

 
    async function importTavernWorldBook(tavernData, fileName) {
      const bookNameSuggestion = fileName.replace(/\.json$/i, '');

      const newBookName = await showCustomPrompt(
        "ÂØºÂÖ• Tavern AI ‰∏ñÁïå‰π¶",
        "ËØ∑‰∏∫ËøôÊú¨ËÆæÂÆöÈõÜÂëΩÂêçÔºö",
        bookNameSuggestion
      );

      if (!newBookName || !newBookName.trim()) {
        alert("ÂØºÂÖ•Â∑≤ÂèñÊ∂àÔºåÂõ†‰∏∫Êú™Êèê‰æõ‰π¶Âêç„ÄÇ");
        return;
      }

      const newEntries = Object.values(tavernData.entries).map(entry => {

        return {
          keys: entry.key || [],
          comment: entry.comment || 'Êó†Â§áÊ≥®',
          content: entry.content || '',
          enabled: !entry.disable
        };
      }).filter(entry => entry.content);

      if (newEntries.length === 0) {
        alert("Ëøô‰∏™ Tavern AI ‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÊúâÊïàÁöÑÊù°ÁõÆ„ÄÇ");
        return;
      }

      const newWorldBook = {
        id: 'wb_' + Date.now(),
        name: newBookName.trim(),
        content: newEntries,
        categoryId: null
      };

      await db.worldBooks.add(newWorldBook);
      state.worldBooks.push(newWorldBook);
      await renderWorldBookScreen();

      await showCustomAlert('ÂØºÂÖ•ÊàêÂäüÔºÅ', `Â∑≤ÊàêÂäü‰ªé Tavern AI Êñá‰ª∂ÂØºÂÖ•ËÆæÂÆöÈõÜ„Ää${newBookName}„Äã„ÄÇ`);
    }


    async function exportWorldBooks() {
      try {
        const books = await db.worldBooks.toArray();
        const categories = await db.worldBookCategories.toArray();

        if (books.length === 0 && categories.length === 0) {
          alert("Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑ‰∏ñÁïå‰π¶Êï∞ÊçÆ„ÄÇ");
          return;
        }

        const backupData = {
          type: 'EPhoneWorldBookBackup',
          version: 1,
          timestamp: Date.now(),
          books: books,
          categories: categories
        };

        const blob = new Blob(
          [JSON.stringify(backupData, null, 2)], {
            type: 'application/json'
          }
        );
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `EPhone-WorldBooks-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);

        await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'ÊâÄÊúâ‰∏ñÁïå‰π¶Êï∞ÊçÆÂ∑≤ÊàêÂäüÂØºÂá∫ÔºÅ');

      } catch (error) {
        console.error("ÂØºÂá∫‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:", error);
        await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
      }
    }


    async function importWorldBooks(data) {

      try {
        if (data.type !== 'EPhoneWorldBookBackup' || !data.books) {
          throw new Error("Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËøô‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑ‰∏ñÁïå‰π¶Â§á‰ªΩÊñá‰ª∂„ÄÇ");
        }

        const confirmed = await showCustomConfirm(
          'ÂØºÂÖ•‰∏ñÁïå‰π¶',
          'ËøôÂ∞ÜÁî®Êñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆ„ÄêÂÆåÂÖ®Ë¶ÜÁõñ„ÄëÊÇ®ÂΩìÂâçÊâÄÊúâÁöÑ‰∏ñÁïå‰π¶ÂíåÂàÜÁ±ª„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ', {
            confirmButtonClass: 'btn-danger',
            confirmText: 'Á°ÆËÆ§Ë¶ÜÁõñ'
          }
        );

        if (!confirmed) return;

        await db.transaction('rw', db.worldBooks, db.worldBookCategories, async () => {
          await db.worldBooks.clear();
          await db.worldBookCategories.clear();

          if (Array.isArray(data.books)) {
            await db.worldBooks.bulkPut(data.books);
          }
          if (Array.isArray(data.categories)) {
            await db.worldBookCategories.bulkPut(data.categories);
          }
        });


        state.worldBooks = await db.worldBooks.toArray();
        await renderWorldBookScreen();

        await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', '‰∏ñÁïå‰π¶Êï∞ÊçÆÂ∑≤ÊàêÂäüÊÅ¢Â§çÔºÅ');

      } catch (error) {
        console.error("ÂØºÂÖ•‰∏ñÁïå‰π¶Êó∂Âá∫Èîô:", error);
        await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ëß£ÊûêÊàñÂ∫îÁî®Â§±Ë¥•: ${error.message}`);
      }
    }



    const lastActiveTimestamp = localStorage.getItem('ephoneLastActiveTimestamp');
    if (lastActiveTimestamp) {
      const minutesOffline = (Date.now() - parseInt(lastActiveTimestamp)) / (1000 * 60);

      if (minutesOffline > 5) {


        simulateBackgroundActivity(minutesOffline);
      }
    }

    setupCharPlayerControls();

    window.showScreen = showScreen;
    window.openRenderingRulesScreen = openRenderingRulesScreen;
    window.handleListenTogetherClick = handleListenTogetherClick;

    window.openCharacterSelector = openCharacterSelector;
    window.openCharApp = openCharApp;
    window.switchToMyPhone = switchToMyPhone;
    window.openCharWallet = openCharWallet;
    window.switchToCharHomeScreen = switchToCharHomeScreen;
    window.openNpcEditor = openNpcEditor;



    const stickerActionBar = document.createElement('div');
    stickerActionBar.id = 'sticker-action-bar';
    stickerActionBar.innerHTML = `
       <input type="checkbox" id="select-all-stickers-checkbox" style="margin-right: 10px;">
      <button id="delete-selected-stickers-btn" class="form-button-secondary">Âà†Èô§ (0)</button>
   `;
    document.getElementById('sticker-panel').appendChild(stickerActionBar);
   const exportStickersBtn = document.createElement('button');
   exportStickersBtn.id = 'export-selected-stickers-btn';
   exportStickersBtn.textContent = 'ÂØºÂá∫ (0)';
   exportStickersBtn.className = 'form-button'; // ‰ΩøÁî®‰∏ªÊåâÈíÆÊ†∑Âºè
   exportStickersBtn.style.marginLeft = '10px';
   
   stickerActionBar.appendChild(exportStickersBtn);
   
   exportStickersBtn.addEventListener('click', executeBatchExportStickers);
    const globalCssStyleTag = document.createElement('style');
    globalCssStyleTag.id = 'global-custom-style';
    document.head.appendChild(globalCssStyleTag);


    qzoneStickerPanelState.panelEl = document.getElementById('qzone-sticker-panel');
    qzoneStickerPanelState.gridEl = document.getElementById('qzone-sticker-grid');

    const savedTheme = localStorage.getItem('ephone-theme') || 'light';
    applyTheme(savedTheme);



    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);



    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);




    applyScopedCss('', '#chat-messages', 'custom-bubble-style');
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style');

    window.openRenderingRulesScreen = openRenderingRulesScreen;
    window.showScreen = showScreen;
    window.renderChatListProxy = renderChatList;
    window.renderApiSettingsProxy = renderApiSettings;
    window.renderWallpaperScreenProxy = renderWallpaperScreen;
    window.renderWorldBookScreenProxy = renderWorldBookScreen;

    await loadAllDataFromDB();
    await initFunds();
    applyStatusBarVisibility();
    applyPhoneFrame(state.globalSettings.showPhoneFrame);
    applyDetachStatusBarMode(state.globalSettings.detachStatusBar);
    applyMinimalChatUI(state.globalSettings.enableMinimalChatUI);
    await migrateOldRedPacketData();


    applyGlobalCss(state.globalSettings.globalCss);



    const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
    updateUnreadIndicator(storedCount);



    if (state.globalSettings && state.globalSettings.fontUrl) {
      applyCustomFont(state.globalSettings.fontUrl);
    }

    updateClock();
    setInterval(updateClock, 1000 * 30);
    applyGlobalWallpaper();
    initBatteryManager();

    applyAppIcons();
    applyWidgetData();





    document.getElementById('rules-tabs').addEventListener('click', (e) => {
      if (e.target.classList.contains('rules-tab')) {
        switchRuleCategory(e.target.dataset.categoryId);
      }
    });



    document.getElementById('add-new-rule-btn').addEventListener('click', () => openRuleEditor(null));
    document.getElementById('cancel-rule-editor-btn').addEventListener('click', () => {
      document.getElementById('rule-editor-modal').classList.remove('visible');
    });
    document.getElementById('save-rule-btn').addEventListener('click', saveRenderingRule);



    document.getElementById('pat-btn').addEventListener('click', () => {

      if (state.activeChatId && !state.chats[state.activeChatId].isGroup) {
        const chat = state.chats[state.activeChatId];

        handleUserPat(chat.id, chat.originalName);
      }
    });


    let activeAnnouncementId = null;

 
    function showAnnouncementActions(annoId) {
      activeAnnouncementId = annoId;
      const chat = state.chats[state.activeChatId];
      const announcement = chat.announcements.find(a => a.id === annoId);
      if (!announcement) return;

      const pinButton = document.getElementById('announcement-action-pin');

      pinButton.textContent = announcement.isPinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'ÁΩÆÈ°∂ÂÖ¨Âëä';

      document.getElementById('announcement-actions-modal').classList.add('visible');
    }

 
    async function handlePinAnnouncement() {
      if (!activeAnnouncementId) return;
      const chat = state.chats[state.activeChatId];
      const announcement = chat.announcements.find(a => a.id === activeAnnouncementId);
      if (announcement) {
        announcement.isPinned = !announcement.isPinned;
        await db.chats.put(chat);
        showAnnouncementBoard();
      }
      document.getElementById('announcement-actions-modal').classList.remove('visible');
    }

  
    async function handleDeleteAnnouncement() {
      if (!activeAnnouncementId) return;

      const confirmed = await showCustomConfirm("Á°ÆËÆ§Âà†Èô§", "Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ", {
        confirmButtonClass: 'btn-danger'
      });

      if (confirmed) {
        const chat = state.chats[state.activeChatId];

        chat.announcements = chat.announcements.filter(a => a.id !== activeAnnouncementId);
        await db.chats.put(chat);
        showAnnouncementBoard();
      }
      document.getElementById('announcement-actions-modal').classList.remove('visible');
    }

    document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
    document.getElementById('custom-modal-overlay').addEventListener('click', (e) => {
      if (e.target === modalOverlay) hideCustomModal();
    });
    document.getElementById('export-data-btn').addEventListener('click', async () => {

      const choice = await showChoiceModal('ÈÄâÊã©ÂØºÂá∫ÊñπÂºè', [{
          text: 'ÂàÜÁâáÂØºÂá∫ (Êé®ËçêÔºåÊâìÂåÖ‰∏∫ZIPÔºåËß£ÂéãÊØè‰∏™ÂàáÁâáÈÄâÊã©Â¢ûÈáèÂØºÂÖ•)',
          value: 'slice'
        },
        {
          text: 'Êô∫ËÉΩÂØºÂá∫ (Âçï‰∏™Â§ßÊñá‰ª∂ÔºåÂ§™Â§ßÂèØËÉΩ‰ºöÂØºËá¥ÂØºÂÖ•‰∏ç‰∫Ü)',
          value: 'stream'
        },
        {
          text: '‰º†ÁªüÂØºÂá∫ (ÂÖºÂÆπÊóßÁâàÊàñÂÜÖÂ≠òÂ∞èÁöÑÊµèËßàÂô®)',
          value: 'blob'
        }
      ]);


      if (choice === 'slice') {
        exportDataAsSlicedZip();
      } else if (choice === 'stream') {
        exportDataAsStream();
      } else if (choice === 'blob') {
        exportDataAsBlob();
      }

    });



    document.getElementById('cleanup-data-btn').addEventListener('click', cleanupRedundantData);

    document.getElementById('offline-mode-toggle').addEventListener('change', (e) => {

      document.getElementById('offline-mode-options').style.display = e.target.checked ? 'block' : 'none';
    });
    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
    document.getElementById('time-perception-toggle').addEventListener('change', (e) => {
      document.getElementById('time-zone-group').style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('import-data-input').addEventListener('change', e => handleSmartImport(e.target.files[0]));
    document.getElementById('import-card-input').addEventListener('change', handleCardImport);
    // ============================================================
    // ‚ñº‚ñº‚ñº ÂÖ®Â±ÄÂÆâÂÖ®ËøîÂõû‰∏éÂèòÈáèÊ∏ÖÁêÜÁ≥ªÁªü (Èò≤ÁÇ∏Áæ§/Èò≤‰∏≤Âè∞) ‚ñº‚ñº‚ñº
    // ============================================================

    // 1. ÂÆö‰πâÈÄöÁî®Ê∏ÖÁêÜÂáΩÊï∞ (ÊâÄÊúâ‚ÄúÈÄÄÂá∫/ËøîÂõû‚ÄùÊìç‰ΩúÈÉΩÂ∫îËØ•Ë∞ÉÁî®ÂÆÉ)
    function forceGlobalCleanup() {
        console.log("ÊâßË°åÂÖ®Â±ÄÂèòÈáèÊ∏ÖÁêÜ...");
        
        // A. Ê∏ÖÁêÜÂõûÂ§ç/ÂºïÁî®Áä∂ÊÄÅ
        if (typeof cancelReplyMode === 'function') cancelReplyMode();
        currentReplyContext = null;

        // B. Ê∏ÖÁêÜÂ§öÈÄâ/ÁºñËæëÊ®°Âºè
        if (typeof exitSelectionMode === 'function') exitSelectionMode();
        
        // C. Ê∏ÖÁêÜÂÆöÊó∂Âô® (Èò≤Ê≠¢Â§ñÂçñ/Ê∏∏ÊàèÂÄíËÆ°Êó∂Âú®ÂêéÂè∞Êä•Èîô)
        if (typeof cleanupWaimaiTimers === 'function') cleanupWaimaiTimers();
        if (typeof stopAutoBackupTimer === 'function') stopAutoBackupTimer(); // Â¶ÇÊûúÊúâËá™Âä®Â§á‰ªΩ

        // D. Âº∫Âà∂ÂÖ≥Èó≠ÊÇ¨ÊµÆÂ±Ç/Èù¢Êùø
        const gomokuOverlay = document.getElementById('gomoku-overlay');
        if (gomokuOverlay) {
             gomokuOverlay.classList.remove('visible');
             // ÈáçÁΩÆ‰∫îÂ≠êÊ£ãÁä∂ÊÄÅÔºåÈò≤Ê≠¢‰∏ãÊ¨°ÊâìÂºÄÂç°Ê≠ª
             if(state.activeChatId && gomokuState[state.activeChatId]) {
                 gomokuState[state.activeChatId].isActive = false; 
             }
        }
        
        const stickerPanel = document.getElementById('sticker-panel');
        if (stickerPanel) stickerPanel.classList.remove('visible');

        const musicPanel = document.getElementById('music-playlist-panel');
        if (musicPanel) musicPanel.classList.remove('visible');

        // E. Ê∏ÖÁêÜÂÖ®Â±Ä‰∏¥Êó∂ÂèòÈáè (ÊúÄÈáçË¶ÅÁöÑ‰∏ÄÊ≠•ÔºÅ)
        ruleCache = {}; 
        activeMessageTimestamp = null; 
        activeTransferTimestamp = null; 
        //lastRawAiResponse = ''; 
        //lastResponseTimestamps = [];
        
        // F. ÈáçÁΩÆ UI Ê†∑Âºè
        applyScopedCss('', '#chat-messages', 'custom-bubble-style');
        applyScopedCss('', '#settings-preview-area', 'preview-bubble-style');
        
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) typingIndicator.style.display = 'none';
        
        // G. Ê†∏ÂøÉÔºöËß£Èô§ÂΩìÂâçËÅäÂ§©ÁªëÂÆö
        state.activeChatId = null;
    }

    // 2. ÁªëÂÆöÔºöËÅäÂ§©ÁïåÈù¢ -> ËøîÂõûÂàóË°®
    document.getElementById('back-to-list-btn').addEventListener('click', () => {
        forceGlobalCleanup(); // ÊâßË°åÊ∏ÖÁêÜ
        showScreen('chat-list-screen'); // ÂàáÊç¢ÁîªÈù¢
    });

    // 3. ÁªëÂÆöÔºöÁãº‰∫∫ÊùÄ -> ÈÄÄÂá∫Ê∏∏Êàè
    document.getElementById('exit-werewolf-game-btn').addEventListener('click', async () => {
        const confirmed = await showCustomConfirm('ÈÄÄÂá∫Ê∏∏Êàè', 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçËøôÂ±ÄÁãº‰∫∫ÊùÄÂêóÔºüÊ∏∏ÊàèËøõÂ∫¶Â∞Ü‰∏ç‰ºöË¢´‰øùÂ≠ò„ÄÇ', {
            confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
            werewolfGameState.isActive = false;
            
            // Â¶ÇÊûúÊòØÁæ§ËÅäÊ®°ÂºèÔºåËøîÂõûËÅäÂ§©ÁïåÈù¢Ôºà‰∏çÊ∏ÖÁêÜactiveChatIdÔºåÂõ†‰∏∫ËøòÂú®Áæ§ÈáåÔºâ
            if (werewolfGameState.chatId) {
                showScreen('chat-interface-screen');
            } else {
                // Â¶ÇÊûúÊòØÂÖ®Â±ÄÊ®°ÂºèÔºåËøîÂõû‰∏ªÈ°µÔºàÊâßË°åÊ∏ÖÁêÜÔºÅÔºâ
                forceGlobalCleanup();
                showScreen('home-screen');
            }
        }
    });

    // 4. ÁªëÂÆöÔºöÁªøÊ±ü/ÊîØ‰ªòÂÆù/ËÆæÁΩÆ -> ËøîÂõû‰∏ªÈ°µ (Ëá™Âä®Êü•ÊâæÂπ∂ÁªëÂÆö)
    // Âõ†‰∏∫Ëøô‰∫õÊåâÈíÆÂú®HTMLÈáåÊ≤°ÊúâIDÔºåÊàë‰ª¨Áî®ÈÄâÊã©Âô®ÊâπÈáèÁªëÂÆö‚ÄúÂÆâÂÖ®ÈîÅ‚Äù
    const safeBackSelectors = [
        '#green-river-screen .gr-icon-btn', // ÁªøÊ±üËøîÂõû
        '#alipay-screen .back-btn',         // ÊîØ‰ªòÂÆùËøîÂõû
        '#api-settings-screen .back-btn',   // APIËÆæÁΩÆËøîÂõû
        '#wallpaper-screen .back-btn',      // Â§ñËßÇËÆæÁΩÆËøîÂõû
        '#font-settings-screen .back-btn',  // Â≠ó‰ΩìËÆæÁΩÆËøîÂõû
        '#tutorial-screen .back-btn'        // ÊïôÁ®ãËøîÂõû
    ];

    safeBackSelectors.forEach(selector => {
        const btn = document.querySelector(selector);
        if (btn) {
            // ÁßªÈô§ÊóßÁöÑ inline onclick (Â¶ÇÊûúÊúâÂÜ≤Á™ÅÁöÑËØù)ÔºåÊàñËÄÖÁõ¥Êé•ËøΩÂä†
            // ËøôÈáåÊàë‰ª¨ËøΩÂä†‰∏Ä‰∏™Ê∏ÖÁêÜÊìç‰ΩúÔºåÂÆÉ‰ºöÂú® onclick Ë∑≥ËΩ¨‰πãÂâçÊàñÂêåÊó∂ÊâßË°å
            btn.addEventListener('click', () => {
                forceGlobalCleanup();
                // Ê≥®ÊÑèÔºöÂéüÊú¨ÁöÑ showScreen('home-screen') ÂÜôÂú® HTML onclick ÈáåÔºå‰æùÁÑ∂‰ºöÊâßË°å
                // ËøôÈáåÂè™ÊòØÈ¢ùÂ§ñÂä†‰∫Ü‰∏ÄÈÅì‰øùÈô©
            });
        }
    });

    // ============================================================


    document.getElementById('add-chat-btn').addEventListener('click', async () => {

      const choice = await showChoiceModal('ÂàõÂª∫Êñ∞ËÅäÂ§©', [{
          text: 'ÊâãÂä®ÂàõÂª∫ËßíËâ≤',
          value: 'manual'
        },
        {
          text: '‰ªéËßíËâ≤Âç°ÂØºÂÖ• (.json/.png)',
          value: 'import_card'
        }
      ]);

      if (choice === 'manual') {

        const remarkName = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§© (Á¨¨1/2Ê≠•)', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥‰∏∫TaËÆæÁΩÆÁöÑ„ÄêÂ§áÊ≥®Âêç„Äë(‰æãÂ¶Ç: Âì•Âì•)');
        if (!remarkName || !remarkName.trim()) return;

        const originalName = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§© (Á¨¨2/2Ê≠•)', 'ËØ∑ËæìÂÖ•TaÁöÑ„ÄêÊú¨Âêç„Äë(‰æãÂ¶Ç: ÊùéÊòüËæ∞ÔºåËøô‰∏™ÂêçÂ≠óÂ∞ÜÁî®‰∫éAIËØÜÂà´)');
        if (!originalName || !originalName.trim()) return;


        const newChatId = 'chat_' + Date.now();
        const newChat = {
          id: newChatId,
          name: remarkName.trim(),
          originalName: originalName.trim(),
          isGroup: false,
          isPinned: false,
          unreadCount: 0,
          relationship: {
            status: 'friend',
            blockedTimestamp: null,
            applicationReason: ''
          },
          status: {
            text: 'Âú®Á∫ø',
            lastUpdate: Date.now(),
            isBusy: false
          },
          settings: {
            aiPersona: 'ËøôÊòØ‰∏Ä‰∏™ÈÄöËøáÊâãÂä®ÂàõÂª∫ÁöÑËßíËâ≤„ÄÇ',
            myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
            myNickname: 'Êàë',
            maxMemory: 10,
            aiAvatar: defaultAvatar,
            myAvatar: defaultAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
            aiAvatarLibrary: [],
            myAvatarLibrary: [],
            enableBackgroundActivity: true,
            actionCooldownMinutes: 15,
            enableTimePerception: true,
            isOfflineMode: false,
            offlineMinLength: 100,
            offlineMaxLength: 300,
            offlinePresetId: null,
            timeZone: 'Asia/Shanghai'
          },
          history: [],
          musicData: {
            totalTime: 0
          },
          longTermMemory: [],
          thoughtsHistory: []
        };
        state.chats[newChatId] = newChat;
        await db.chats.put(newChat);
        renderChatList();

      } else if (choice === 'import_card') {
     
        try {
          
          await requirePinActivation();

        
          document.getElementById('import-card-input').click();

        } catch (error) {
        
          console.warn("ËßíËâ≤Âç°ÂØºÂÖ•Ë¢´ÂèñÊ∂à:", error.message);
        }
       
      }
    });



    document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);

    document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
    document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

    document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
    document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
    document.getElementById('music-return-btn').addEventListener('click', returnToChat);
    document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
    document.getElementById('music-next-btn').addEventListener('click', playNext);
    document.getElementById('music-prev-btn').addEventListener('click', playPrev);
    document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
    document.getElementById('music-playlist-btn').addEventListener('click', () => {
      updatePlaylistUI();
      document.getElementById('music-playlist-panel').classList.add('visible');
    });
    document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
    document.getElementById('manage-playlist-btn').addEventListener('click', togglePlaylistManagementMode);
    document.getElementById('select-all-playlist-checkbox').addEventListener('change', handleSelectAllPlaylistItems);
    document.getElementById('upload-selected-to-catbox-btn').addEventListener('click', executeBatchUploadToCatbox);
    document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
    document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
    document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);

    document.getElementById('playlist-body').addEventListener('click', (e) => {
      const target = e.target;
      const trackIndex = parseInt(target.dataset.index);

      if (isNaN(trackIndex)) return;

      if (target.classList.contains('album-art-btn')) {
        handleChangeAlbumArt(trackIndex);
      } else if (target.classList.contains('lyrics-btn')) {
        handleManualLrcImport(trackIndex);
      } else if (target.classList.contains('bg-btn')) {
        handleChangeBackground(trackIndex);
      } else if (target.classList.contains('delete-track-btn')) {
        deleteTrack(trackIndex);
      }
    });

    audioPlayer.addEventListener('ended', async () => { // 1. Âú®ËøôÈáåÊ∑ªÂä† async
  document.getElementById('vinyl-view').classList.remove('spinning');
  
  // 2. ‰øùÊåÅ playNext(true) ‰∏çÂèòÔºåËøôÊ†∑ÂÆÉÂ∞±‰∏ç‰ºöÂèëÈÄÅ‚ÄúÁî®Êà∑ÂàáÊ≠å‚ÄùÁöÑÈîôËØØÊèêÁ§∫
  playNext(true); 

  // 3. Á≠âÂæÖ playNext ÊâßË°åÂÆåÊØïÔºåÁ°Æ‰øù musicState.currentIndex Â∑≤ÁªèÊõ¥Êñ∞
  //    (Ê≥®ÊÑèÔºöplayNext ‰∏çÊòØÂºÇÊ≠•ÁöÑÔºå‰ΩÜ playSong ÊòØ„ÄÇ‰∏çËøá playNext ‰ºöÂêåÊ≠•Êõ¥Êñ∞ currentIndex)
  //    ‰∏∫‰∫Ü‰øùÈô©Ëµ∑ËßÅÔºåÊàë‰ª¨Á®çÂæÆÁ≠âÂæÖ‰∏Ä‰∏ãÁ°Æ‰øùÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞„ÄÇ
  await new Promise(resolve => setTimeout(resolve, 50)); 

  // 4. ÊâãÂä®Ê∑ªÂä†‰∏ÄÊù°‚ÄúËá™Âä®Êç¢Ê≠å‚ÄùÁöÑÁ≥ªÁªüÊèêÁ§∫
  const track = musicState.playlist[musicState.currentIndex]; 
  if (track && musicState.isActive && musicState.activeChatId) {
    const chat = state.chats[musicState.activeChatId];
    if (chat) {
      const systemMessage = {
        role: 'system',
        content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰∏ä‰∏ÄÈ¶ñÊ≠åÊõ≤Êí≠ÊîæÂÆåÊØïÔºåÂ∑≤Ëá™Âä®‰∏∫‰Ω†ÂàáÊç¢Âà∞„Ää${track.name}„Äã - ${track.artist}]`,
        timestamp: Date.now(),
        isHidden: true // ËøôÊù°Ê∂àÊÅØÁî®Êà∑Áúã‰∏çËßÅÔºå‰ΩÜAIÂú®‰∏ãÊ¨°ÂõûÂ§çÊó∂‰ºöËØªÂà∞
      };
      chat.history.push(systemMessage);
      await db.chats.put(chat); // ÂºÇÊ≠•‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    }
  }
});





    const chatInput = document.getElementById('chat-input');


    document.getElementById('send-btn').addEventListener('click', () => {
      // ÂêØÂä®ÂêéÂè∞‰øùÊ¥ªÁ≥ªÁªüÔºàÁî®Êà∑ÊâãÂäøËß¶ÂèëÔºâ
      startBackgroundOnce();
      
      playSilentAudio();
      const content = chatInput.value.trim();
      if (!content || !state.activeChatId) return;

      const chat = state.chats[state.activeChatId];
      if (content.startsWith('/n ') || content.startsWith('/ÊóÅÁôΩ ')) {
        const narrationText = content.replace(/^\/n\s+|^\/ÊóÅÁôΩ\s+/, '');
        
        const msg = {
            role: 'system', // ËÆæ‰∏∫ system Â±Ö‰∏≠ÊòæÁ§∫
            type: 'narration',
            content: narrationText,
            timestamp: Date.now()
        };
        
        // ‰øùÂ≠òÂπ∂Ê∏≤Êüì
        chat.history.push(msg);
        db.chats.put(chat);
        appendMessage(msg, chat);
        
        chatInput.value = '';
        chatInput.style.height = 'auto';
        chatInput.focus();
        return; // ÈòªÊ≠¢ÂèëÈÄÅÊôÆÈÄöÊ∂àÊÅØ
    }
      const msg = {
        role: 'user',
        content,
        timestamp: Date.now()
      };

      if (currentReplyContext) {
        msg.quote = currentReplyContext;
      }


      appendMessage(msg, chat);


      (async () => {
        chat.history.push(msg);
        await db.chats.put(chat);
        renderChatList();

      })();


      chatInput.value = '';
      chatInput.style.height = 'auto';
      chatInput.focus();
      cancelReplyMode();
      document.body.classList.remove('chat-actions-expanded');
    });
    document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-btn').click();
      }
    });


    document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => {
  const file = event.target.files[0];
  if (file) {
    
    const base64Url = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = () => rej(reader.error);
      reader.readAsDataURL(file);
    });

   
    newWallpaperBase64 = base64Url;

  
    renderWallpaperScreen(); 

  
    if (state.apiConfig.imgbbEnable && state.apiConfig.imgbbApiKey) {
        
        (async () => {
            try {
                console.log("[ImgBB] ÂêéÂè∞ÂºÄÂßã‰∏ä‰º†Â£ÅÁ∫∏...");
                
                const imageUrl = await uploadImageToImgBB(base64Url);

               
                if (newWallpaperBase64 === base64Url) {
                    newWallpaperBase64 = imageUrl; // ÊÇÑÊÇÑÂú∞Â∞ÜÂèòÈáèÊõ¥Êñ∞‰∏∫ URL
                    console.log("[ImgBB] ÂêéÂè∞Â£ÅÁ∫∏‰∏ä‰º†ÊàêÂäüÔºå‰∏¥Êó∂ÂèòÈáèÂ∑≤Êõ¥Êñ∞‰∏∫ URL„ÄÇ");
                } else {
                    console.log("[ImgBB] ÂêéÂè∞Â£ÅÁ∫∏‰∏ä‰º†ÂÆåÊàêÔºå‰ΩÜÁî®Êà∑Â∑≤Êõ¥ÊîπÈÄâÊã©ÔºåÊîæÂºÉÊõ¥Êñ∞„ÄÇ");
                }
            } catch (uploadError) {
             
                console.error("ÂêéÂè∞Â£ÅÁ∫∏‰∏ä‰º†Â§±Ë¥•:", uploadError.message);
                
            }
        })(); 
    }

  
    event.target.value = null; 
  }
});

    document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {

      if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
      }




      state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
      state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
      state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;

      state.globalSettings.showPhoneFrame = document.getElementById('phone-frame-toggle-switch').checked;
      state.globalSettings.enableMinimalChatUI = document.getElementById('minimal-chat-ui-switch').checked;
      state.globalSettings.alwaysShowMusicIsland = document.getElementById('dynamic-island-music-toggle-switch').checked;
      state.globalSettings.detachStatusBar = document.getElementById('detach-status-bar-switch').checked;
      state.globalSettings.lockScreenEnabled = document.getElementById('lock-screen-toggle').checked;
      state.globalSettings.lockScreenPassword = document.getElementById('lock-screen-password-input').value.trim();
      
      const lockPreview = document.getElementById('lock-wallpaper-preview');
      if (lockPreview.dataset.tempUrl) {
          state.globalSettings.lockScreenWallpaper = lockPreview.dataset.tempUrl;
      }
      await db.globalSettings.put(state.globalSettings);


      applyGlobalWallpaper();
      applyCPhoneWallpaper();
      newWallpaperBase64 = null;

      applyAppIcons();
      applyCPhoneAppIcons();

      applyGlobalCss(state.globalSettings.globalCss);
      applyStatusBarVisibility();
      applyMinimalChatUI(state.globalSettings.enableMinimalChatUI);
      initLockScreen();
      alert('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
      showScreen('home-screen');
    });


    const messagesView = document.getElementById('messages-view');
    messagesView.addEventListener('scroll', () => {

      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = messagesView;



      if (scrollHeight - scrollTop - clientHeight < clientHeight) {

        if (!isLoadingMoreChats) {

          loadMoreChats();
        }
      }
    });


    document.getElementById('save-api-settings-btn').addEventListener('click', async () => {

      state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim();
      state.apiConfig.apiKey = document.getElementById('api-key').value.trim();
      state.apiConfig.model = document.getElementById('model-select').value;
      state.apiConfig.minimaxGroupId = document.getElementById('minimax-group-id').value.trim();
      state.apiConfig.minimaxApiKey = document.getElementById('minimax-api-key').value.trim();
      state.apiConfig.minimaxModel = document.getElementById('minimax-model-select').value;
      const domainSelect = document.getElementById('minimax-domain-select');
      if (domainSelect) {
          state.apiConfig.minimaxDomain = domainSelect.value;
          localStorage.setItem('minimax-domain', domainSelect.value);
      }
      localStorage.setItem('minimax-group-id', state.apiConfig.minimaxGroupId);
      localStorage.setItem('minimax-api-key', state.apiConfig.minimaxApiKey);
      localStorage.setItem('minimax-model', state.apiConfig.minimaxModel);
      state.apiConfig.secondaryProxyUrl = document.getElementById('secondary-proxy-url').value.trim();
      state.apiConfig.secondaryApiKey = document.getElementById('secondary-api-key').value.trim();
      state.apiConfig.secondaryModel = document.getElementById('secondary-model-select').value;
      const imgbbEnable = document.getElementById('imgbb-enable-switch').checked;
      const imgbbApiKey = document.getElementById('imgbb-api-key').value.trim();
      const catboxEnable = document.getElementById('catbox-enable-switch').checked;
      const catboxUserHash = document.getElementById('catbox-userhash').value.trim();

      
      state.apiConfig.imgbbEnable = imgbbEnable;
      state.apiConfig.imgbbApiKey = imgbbApiKey;
      state.apiConfig.catboxEnable = catboxEnable;
      state.apiConfig.catboxUserHash = catboxUserHash;

      
      localStorage.setItem('imgbb-enabled', imgbbEnable);
      localStorage.setItem('imgbb-api-key', imgbbApiKey);
      localStorage.setItem('catbox-enabled', catboxEnable);
      localStorage.setItem('catbox-userhash', catboxUserHash);
      const githubEnable = document.getElementById('github-enable-switch').checked;
      const githubAutoBackup = document.getElementById('github-auto-backup-switch').checked;
      let backupInterval = parseInt(document.getElementById('github-backup-interval').value);
      if (isNaN(backupInterval) || backupInterval < 1) backupInterval = 30;
        state.apiConfig.githubEnable = githubEnable;
       state.apiConfig.githubAutoBackup = githubAutoBackup;
       const githubProxyEnable = document.getElementById('github-proxy-switch').checked;
        const githubProxyUrl = document.getElementById('github-proxy-url').value.trim();
        
        state.apiConfig.githubProxyEnable = githubProxyEnable;
        state.apiConfig.githubProxyUrl = githubProxyUrl;
        
        localStorage.setItem('github-proxy-enabled', githubProxyEnable);
        localStorage.setItem('github-proxy-url', githubProxyUrl);
        state.apiConfig.githubUsername = document.getElementById('github-username').value.trim();
        state.apiConfig.githubRepo = document.getElementById('github-repo').value.trim();
        state.apiConfig.githubToken = document.getElementById('github-token').value.trim();
        state.apiConfig.githubFilename = document.getElementById('github-filename').value.trim() || 'ephone_backup.json';
        localStorage.setItem('github-username', state.apiConfig.githubUsername);
        localStorage.setItem('github-repo', state.apiConfig.githubRepo);
        localStorage.setItem('github-token', state.apiConfig.githubToken);
        localStorage.setItem('github-filename', state.apiConfig.githubFilename);
        state.apiConfig.novelaiApiKey = document.getElementById('novelai-api-key').value.trim();
      state.apiConfig.novelaiModel = document.getElementById('novelai-model').value;
      state.apiConfig.novelaiEnabled = document.getElementById('novelai-switch').checked;
      // ‰øùÂ≠òÂ§á‰ªΩÈó¥Èöî
      state.apiConfig.githubBackupInterval = backupInterval;
        // ‰øùÂ≠òÂºÄÂÖ≥Áä∂ÊÄÅÂà∞ localStorage
        localStorage.setItem('github-enabled', githubEnable);
      localStorage.setItem('github-auto-backup', githubAutoBackup);
      localStorage.setItem('github-backup-interval', backupInterval);

      if (githubEnable && githubAutoBackup) {
        // ‰º†ÂÖ•Âä®ÊÄÅÁöÑÊó∂Èó¥Èó¥Èöî
        startAutoBackupTimer(backupInterval); 
    } else {
        stopAutoBackupTimer();
    }
      await db.apiConfig.put(state.apiConfig);


      const backgroundSwitch = document.getElementById('background-activity-switch');
      const intervalInput = document.getElementById('background-interval-input');
      const cooldownInput = document.getElementById('block-cooldown-input');

      state.globalSettings.enableBackgroundActivity = backgroundSwitch.checked;
      state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
      state.globalSettings.blockCooldownHours = parseFloat(cooldownInput.value) || 1;
      state.globalSettings.enableAiDrawing = document.getElementById('enable-ai-drawing-switch').checked;
      state.globalSettings.chatRenderWindow = parseInt(document.getElementById('chat-render-window-input').value) || 50;
      state.globalSettings.chatListRenderWindow = parseInt(document.getElementById('chat-list-render-window-input').value) || 30;
      state.globalSettings.apiTemperature = parseFloat(document.getElementById('api-temperature-slider').value);
      await db.globalSettings.put(state.globalSettings);

      stopBackgroundSimulation();
      if (state.globalSettings.enableBackgroundActivity) {
        startBackgroundSimulation();
        console.log(`ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂêØÂä®ÔºåÈó¥Èöî: ${state.globalSettings.backgroundActivityInterval}Áßí`);
      } else {
        console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂÅúÊ≠¢„ÄÇ");
      }

      // ‰øùÂ≠òNovelAIÈÖçÁΩÆÂà∞localStorage
      const novelaiEnabled = document.getElementById('novelai-switch').checked;
      const novelaiModel = document.getElementById('novelai-model').value;
      const novelaiApiKey = document.getElementById('novelai-api-key').value.trim();
      localStorage.setItem('novelai-enabled', novelaiEnabled);
      localStorage.setItem('novelai-model', novelaiModel);
      localStorage.setItem('novelai-api-key', novelaiApiKey);

      alert('ÊâÄÊúâAPI‰∏éÂêéÂè∞ËÆæÁΩÆÂ∑≤‰øùÂ≠ò!');
    });



    const ApiKeyInput = document.getElementById('api-key')
    ApiKeyInput.addEventListener('focus', (e) => {
      e.target.setAttribute('type', 'text')
    })
    ApiKeyInput.addEventListener('blur', (e) => {
      e.target.setAttribute('type', 'password')
    })





    async function fetchModels(urlInputId, keyInputId, selectId) {
      const url = document.getElementById(urlInputId).value.trim();
      const key = document.getElementById(keyInputId).value.trim();
      if (!url || !key) return alert('ËØ∑ÂÖàÂ°´ÂÜôÂØπÂ∫îÁöÑÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•');

      try {
        let isGemini = url === GEMINI_API_URL;
        const response = await fetch(isGemini ? `${GEMINI_API_URL}?key=${getRandomValue(key)}` : `${url}/v1/models`, isGemini ? undefined : {
          headers: {
            'Authorization': `Bearer ${key}`
          }
        });
        if (!response.ok) throw new Error('Êó†Ê≥ïËé∑ÂèñÊ®°ÂûãÂàóË°®');
        const data = await response.json();
        let models = isGemini ? data.models.map(model => ({
          id: model.name.split('/')[1] || model.name
        })) : data.data;

        console.log('üì• Ëé∑ÂèñÂà∞', models.length, '‰∏™Ê®°Âûã');

        // Â°´ÂÖÖselect
        const selectElement = document.getElementById(selectId);
        
        if (!selectElement) {
          console.error('‚ùå Êâæ‰∏çÂà∞selectÂÖÉÁ¥†:', selectId);
          return alert('ÈîôËØØÔºöÊâæ‰∏çÂà∞Ê®°Âûã‰∏ãÊãâÂàóË°®');
        }
        
        selectElement.innerHTML = '';
        
        // Ê∑ªÂä†ÈªòËÆ§ÈÄâÈ°π
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- ËØ∑ÈÄâÊã©Ê®°Âûã --';
        selectElement.appendChild(defaultOption);

        const savedModel = selectId === 'model-select' ? state.apiConfig.model : state.apiConfig.secondaryModel;

        // Ê∑ªÂä†ÊâÄÊúâÊ®°Âûã
        models.forEach((model, index) => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = model.id;
          if (model.id === savedModel) {
            option.selected = true;
          }
          selectElement.appendChild(option);
          
          if (index < 5) {
            console.log(`‚úÖ Ê∑ªÂä†Ê®°Âûã:`, model.id);
          }
        });
        
        console.log('‚úÖ Â∑≤Ê∑ªÂä†', models.length, '‰∏™Ê®°ÂûãÂà∞‰∏ãÊãâÂàóË°®');
        console.log('üìã SelectÈÄâÈ°πÊï∞Èáè:', selectElement.options.length);
        
        alert(`Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞ÔºàÂÖ±${models.length}‰∏™Ê®°ÂûãÔºâ`);
      } catch (error) {
        alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`);
      }
    }


    document.getElementById('fetch-models-btn').addEventListener('click', () => {
      fetchModels('proxy-url', 'api-key', 'model-select');
    });


    document.getElementById('fetch-secondary-models-btn').addEventListener('click', () => {
      fetchModels('secondary-proxy-url', 'secondary-api-key', 'secondary-model-select');
    });

    document.getElementById('add-world-book-btn').addEventListener('click', async () => {
      const name = await showCustomPrompt('ÂàõÂª∫‰∏ñÁïå‰π¶', 'ËØ∑ËæìÂÖ•‰π¶Âêç');
      if (name && name.trim()) {
        const newBook = {
          id: 'wb_' + Date.now(),
          name: name.trim(),
          content: ''
        };
        await db.worldBooks.add(newBook);
        state.worldBooks.push(newBook);
        renderWorldBookScreen();
        openWorldBookEditor(newBook.id);
      }
    });

    document.getElementById('save-world-book-btn').addEventListener('click', async () => {
      if (!editingWorldBookId) return;
      const book = state.worldBooks.find(wb => wb.id === editingWorldBookId);
      if (!book) return;


      const newName = document.getElementById('world-book-name-input').value.trim();
      if (!newName) {
        alert('‰π¶Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
        return;
      }
      book.name = newName;
      const categoryId = document.getElementById('world-book-category-select').value;
      book.categoryId = categoryId ? parseInt(categoryId) : null;

      const entriesContainer = document.getElementById('world-book-entries-container');
      const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
      const newEntries = [];

      entryBlocks.forEach(block => {
        const keysInput = block.querySelector('.entry-keys-input').value.trim();
        const content = block.querySelector('.entry-content-textarea').value.trim();
        const isEnabled = block.querySelector('.entry-enabled-switch').checked;
        if (content) {
          newEntries.push({
            comment: block.querySelector('.entry-comment-input').value.trim(),
            keys: keysInput ? keysInput.split(',').map(k => k.trim()).filter(k => k) : [],
            content: content,
            enabled: isEnabled
          });
        }
      });
      book.content = newEntries;


      await db.worldBooks.put(book);
      document.getElementById('world-book-editor-title').textContent = newName;
      editingWorldBookId = null;


      showScreen('world-book-screen');


      await renderWorldBookScreen();
    });


    document.getElementById('chat-messages').addEventListener('click', async (e) => {
             if (e.target.tagName === 'IMG') {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØËÅäÂ§©ÈáåÁöÑÂõæÁâáÁ±ªÂêç
            if (e.target.classList.contains('chat-image') || 
               
                e.target.classList.contains('realimag-image') ||
                e.target.classList.contains('naiimag-image')) {
                
                e.stopPropagation(); // ÈòªÊ≠¢Ê∞îÊ≥°Ë¢´ÈÄâ‰∏≠Á≠âÂÖ∂‰ªñ‰∫ã‰ª∂

                // --- Ê†∏ÂøÉ‰øÆÂ§çÈÄªËæëÔºöÊ£ÄÊµãËøûÂáª ---
                
                // Â¶ÇÊûúËøôÊòØ‰∏Ä‰∏™Âø´ÈÄüÁöÑÁ¨¨‰∫åÊ¨°ÊàñÁ¨¨‰∏âÊ¨°ÁÇπÂáª (detail > 1)Ôºå
                // ËØ¥ÊòéÁî®Êà∑ÂèØËÉΩÂú®Â∞ùËØï‰∏âÂáª‰∏ãËΩΩÔºåÊàñËÄÖÊòØÂèåÂáª„ÄÇ
                // Ê≠§Êó∂Êàë‰ª¨Ë¶ÅÂèñÊ∂àÊéâËøòÊ≤°ÊâßË°åÁöÑ‚ÄúÊîæÂ§ß‚ÄùÊìç‰ΩúÔºåÂπ∂‰∏çÂÅö‰ªª‰ΩïÊîæÂ§ßÂ§ÑÁêÜ„ÄÇ
                if (e.detail > 1) {
                    if (window.simpleZoomTimer) {
                        clearTimeout(window.simpleZoomTimer);
                        window.simpleZoomTimer = null;
                    }
                    return; // Áõ¥Êé•ÈÄÄÂá∫ÔºåÊääËàûÂè∞ÁïôÁªô‰∏âÂáª‰∏ãËΩΩÈÄªËæë
                }

                // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºåÊàë‰ª¨‰∏çË¶ÅÁ´ãÂàªÊîæÂ§ßÔºåËÄåÊòØÁ≠â 250ms
                // Â¶ÇÊûú 250ms ÂÜÖÊ≤°ÊúâÁ¨¨‰∫åÊ¨°ÁÇπÂáªÔºåÊâçÊâßË°åÊîæÂ§ß„ÄÇ
                window.simpleZoomTimer = setTimeout(() => {
                    openSimpleImageZoom(e.target.src);
                    window.simpleZoomTimer = null;
                }, 250); // 250ÊØ´ÁßíÂª∂ËøüÔºåÊó¢‰∏çÂΩ±Âìç‰ΩìÊÑüÔºåÂèàËÉΩÈÅøÂºÄËøûÂáª
                
                return;
            }
        }
     
      // 1. ‰øÆÂ§ç‰∏ãËΩΩÊåâÈíÆ (Â∏¶ËΩ¨ÂúàÂä®Áîª)
      const downloadBtn = e.target.closest('.nai-save-local-btn');
        if (downloadBtn) {
            e.stopPropagation(); 
            
            // --- Êñ∞Â¢ûÔºöËÆ©ÂÆÉËΩ¨Ëµ∑Êù• ---
            downloadBtn.classList.add('loading'); // Ê∑ªÂä†ËΩ¨ÂúàÊ†∑Âºè
            downloadBtn.disabled = true;          // Èò≤Ê≠¢ËøûÁÇπ
            
            const bubble = downloadBtn.closest('.message-bubble');
            const img = bubble ? bubble.querySelector('img.chat-image, img.realimag-image, img.naiimag-image') : null;
            
            if (img && img.src) {
                addVisualFeedback(img); 
                const filename = generateFilename(img);
                downloadImage(img.src, filename);
            }
            
            // --- Êñ∞Â¢ûÔºöËΩ¨‰∏Ä‰ºöÂÑøÂêéÂÅúÊ≠¢ (800ÊØ´ÁßíÂêéÊÅ¢Â§ç) ---
            // Âõ†‰∏∫‰∏ãËΩΩÊòØÊµèËßàÂô®Êé•ÁÆ°ÁöÑÔºåJSÊó†Ê≥ïÁü•ÈÅìÁ°ÆÂàáÁªìÊùüÊó∂Èó¥ÔºåÁªô‰∏™ËßÜËßâÂèçÈ¶àÊó∂Èó¥Âç≥ÂèØ
            setTimeout(() => {
                downloadBtn.classList.remove('loading');
                downloadBtn.disabled = false;
            }, 800);
            
            return;
        }
       // --- ‰øÆÂ§ç‰∏ä‰º†ÂõæÂ∫äÊåâÈíÆ (ÂéüÊú¨ÊºèÊéâ‰∫ÜËøô‰∏™ÁõëÂê¨) ---
      const naiUploadBtn = e.target.closest('.nai-upload-imgbb-btn');
      if (naiUploadBtn) {
        e.stopPropagation();
        const bubble = e.target.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          if (!isNaN(timestamp)) {
            // Ë∞ÉÁî®Â∑≤ÊúâÁöÑ NAI ‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
            await handleSilentUploadNaiImage(timestamp, naiUploadBtn);
          }
        }
        return;
      }
      const regenBtn = e.target.closest('.nai-regenerate-btn');
      if (regenBtn) {
        e.stopPropagation();
        const bubble = e.target.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          if (!isNaN(timestamp)) {
            await handleRegenerateNaiImage(timestamp, regenBtn);
          }
        }
        return;
      }
      const userUploadBtn = e.target.closest('.user-upload-imgbb-btn');
            if (userUploadBtn) {
                e.stopPropagation();
                const bubble = e.target.closest('.message-bubble');
                if (bubble) {
                    const timestamp = parseInt(bubble.dataset.timestamp);
                    if (!isNaN(timestamp)) {
                        await handleSilentUploadUserImage(timestamp, userUploadBtn);
                    }
                }
                return;
            }
      const voiceBody = e.target.closest('.voice-message-body[data-text]');
      if (voiceBody) {

        const chat = state.chats[state.activeChatId];
        if (!chat) return;


        toggleVoiceTranscript(voiceBody);


        const bubble = voiceBody.closest('.message-bubble');
        const transcriptEl = bubble ? bubble.querySelector('.voice-transcript') : null;


        if (voiceBody.dataset.voiceId && transcriptEl && transcriptEl.style.display === 'block') {


          if (chat.isGroup) {
            console.log("ËøôÊòØ‰∏ÄÊù°Áæ§ËÅäËØ≠Èü≥Ê∂àÊÅØÔºåÂ∑≤Á¶ÅÊ≠¢ÂèëËµ∑TTSËØ∑Ê±Ç„ÄÇ");
            return;
          }
          if (chat.settings.enableTts === false) {
            console.log(`‚Äú${chat.name}‚ÄùÁöÑTTSÂäüËÉΩÂ∑≤ÂÖ≥Èó≠ÔºåÂ∑≤Á¶ÅÊ≠¢ÂèëËµ∑TTSËØ∑Ê±Ç„ÄÇ`);
            return;
          }


          playTtsAudio(voiceBody);
        }

        return;
      }

      const detailsBtn = e.target.closest('.waimai-details-btn');
      if (detailsBtn) {
        const bubble = detailsBtn.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          if (!isNaN(timestamp)) {
            showWaimaiDetails(timestamp);
            return;
          }
        }
      }



      const choiceBtn = e.target.closest('.waimai-user-actions button');
      if (choiceBtn) {
        const bubble = choiceBtn.closest('.message-bubble');
        if (bubble) {
          const timestamp = parseInt(bubble.dataset.timestamp);
          const choice = choiceBtn.dataset.choice;
          if (!isNaN(timestamp) && choice) {
            await handleWaimaiResponse(timestamp, choice);
            return;
          }
        }
      }


      const deletedPostPlaceholder = e.target.closest('.post-deleted-placeholder');
      if (deletedPostPlaceholder) {
        const postId = parseInt(deletedPostPlaceholder.dataset.postId);
        if (!isNaN(postId)) {
          const post = await db.qzonePosts.get(postId);
          if (post) {
            let originalContent = '';
            const authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'Êú™Áü•‰ΩúËÄÖ');

            if (post.type === 'shuoshuo') {
              originalContent = post.content;
            } else {
              originalContent = post.publicText || '';
              if (post.imageUrl) originalContent += `\n[ÂõæÁâá]`;
              if (post.hiddenContent) originalContent += `\n[ÊñáÂ≠óÂõæÂÜÖÂÆπ: ${post.hiddenContent}]`;
            }

            showCustomAlert(
              `Êù•Ëá™ ${authorName} ÁöÑÂ∑≤Âà†Èô§Âä®ÊÄÅ`,
              originalContent.replace(/\n/g, '<br>')
            );
          } else {
            showCustomAlert('ÊèêÁ§∫', 'ËøôÊù°Âä®ÊÄÅÁöÑÂéüÂßãÊï∞ÊçÆÂ∑≤Ë¢´ÂΩªÂ∫ïÊ∏ÖÈô§„ÄÇ');
          }
        }
        return;
      }

      const aiImage = e.target.closest('.ai-generated-image');
      if (aiImage) {
        const description = aiImage.dataset.description;
        if (description) showCustomAlert('ÁÖßÁâáÊèèËø∞', description);
        return;
      }

      const quoteBlock = e.target.closest('.quoted-message');
      if (quoteBlock && quoteBlock.dataset.originalTimestamp) {
        const originalTimestamp = parseInt(quoteBlock.dataset.originalTimestamp);
        if (!isNaN(originalTimestamp)) {
          scrollToOriginalMessage(originalTimestamp);
        }
      }

      const giftCard = e.target.closest('.gift-card');
      if (giftCard) {
        const bubble = giftCard.closest('.message-bubble');
        if (bubble) {
          showGiftReceipt(parseInt(bubble.dataset.timestamp));
        }
      }

      const packetCard = e.target.closest('.red-packet-card');
      if (packetCard) {
        const messageBubble = packetCard.closest('.message-bubble');
        if (messageBubble && messageBubble.dataset.timestamp) {
          const timestamp = parseInt(messageBubble.dataset.timestamp);
          handlePacketClick(timestamp);
        }
      }

      const pollCard = e.target.closest('.poll-card');
      if (pollCard) {
        const timestamp = parseInt(pollCard.dataset.pollTimestamp);
        if (isNaN(timestamp)) return;

        const optionItem = e.target.closest('.poll-option-item');
        if (optionItem && !pollCard.classList.contains('closed')) {
          handleUserVote(timestamp, optionItem.dataset.option);
          return;
        }

        const actionBtn = e.target.closest('.poll-action-btn');
        if (actionBtn) {
          if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
          } else {
            endPoll(timestamp);
          }
          return;
        }

        if (pollCard.classList.contains('closed')) {
          showPollResults(timestamp);
        }
      }



      const placeholder = e.target.closest('.recalled-message-placeholder');
      if (placeholder) {
        const chat = state.chats[state.activeChatId];
        const wrapper = placeholder.closest('.message-wrapper');
        if (chat && wrapper) {
          const timestamp = parseInt(wrapper.dataset.timestamp);
          const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

          if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;

            if (recalled.originalType === 'text') {
              originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
            } else {
              originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ`;
            }
            showCustomAlert('Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ', originalContentText);
          }
        }
      }

      const linkCard = e.target.closest('.link-share-card');
      if (linkCard && linkCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(linkCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
      }

      const bubble = e.target.closest('.message-bubble');
      if (bubble && bubble.classList.contains('ai') && bubble.classList.contains('is-transfer') && bubble.dataset.status === 'pending') {
        const timestamp = parseInt(bubble.dataset.timestamp);
        if (!isNaN(timestamp)) {
          showTransferActionModal(timestamp);
        }
      }
    });


    const chatSettingsModal = document.getElementById('chat-settings-modal');
    const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');

    function updateWorldBookSelectionDisplay() {
      const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked');
      const displayText = document.querySelector('.selected-options-text');

      if (checkedBoxes.length === 0) {
        displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --';
      } else if (checkedBoxes.length > 2) {
        displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} Êú¨‰∏ñÁïå‰π¶`;
      } else {
        const displayItems = Array.from(checkedBoxes).map(cb => {
          return cb.parentElement.textContent.trim();
        });
        displayText.textContent = displayItems.join(', ');
      }
    }


    worldBookSelectBox.addEventListener('click', (e) => {
      e.stopPropagation();
      worldBookCheckboxesContainer.classList.toggle('visible');
      worldBookSelectBox.classList.toggle('expanded');
    });
    document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
    window.addEventListener('click', (e) => {
      if (!document.querySelector('.custom-multiselect').contains(e.target)) {
        worldBookCheckboxesContainer.classList.remove('visible');
        worldBookSelectBox.classList.remove('expanded');
      }
    });

    document.getElementById('chat-settings-btn').addEventListener('click', async () => {
      loadThemePresetsDropdown();
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];
      const isGroup = chat.isGroup;

     const weatherSection = document.getElementById('weather-settings-section');
if (isGroup) {
    weatherSection.style.display = 'none';
} else {
    weatherSection.style.display = 'block';
    
    // ËØªÂèñÈÖçÁΩÆ
    const wSettings = chat.settings.weather || {};
    
    const weatherSwitch = document.getElementById('enable-weather-switch');
    const weatherConfigContainer = document.getElementById('weather-config-container');
    
    weatherSwitch.checked = wSettings.enabled || false;
    weatherConfigContainer.style.display = wSettings.enabled ? 'block' : 'none';
    
    // ÁªëÂÆöÂºÄÂÖ≥ÊòæÁ§∫ÈöêËóè
    weatherSwitch.onclick = (e) => {
        weatherConfigContainer.style.display = e.target.checked ? 'block' : 'none';
    };

    // ÂõûÊòæ User Êï∞ÊçÆ
    document.getElementById('user-virtual-city').value = wSettings.userVirtualCity || '';
    document.getElementById('user-city-lat').value = wSettings.userLat || '';
    document.getElementById('user-city-lon').value = wSettings.userLon || '';
    if (wSettings.userRealCity) {
        document.getElementById('user-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.userRealCity} (${wSettings.userLat}, ${wSettings.userLon})`;
        document.getElementById('user-city-result').style.color = 'green';
    } else {
        document.getElementById('user-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
        document.getElementById('user-city-result').style.color = '#007bff';
    }

    // ÂõûÊòæ Char Êï∞ÊçÆ
    document.getElementById('char-virtual-city').value = wSettings.charVirtualCity || '';
    document.getElementById('char-city-lat').value = wSettings.charLat || '';
    document.getElementById('char-city-lon').value = wSettings.charLon || '';
    if (wSettings.charRealCity) {
        document.getElementById('char-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.charRealCity} (${wSettings.charLat}, ${wSettings.charLon})`;
        document.getElementById('char-city-result').style.color = 'green';
    } else {
        document.getElementById('char-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
        document.getElementById('char-city-result').style.color = '#007bff';
    }
}
      const switchGreetingGroup = document.getElementById('switch-greeting-group');
      if (!isGroup && chat.settings.alternateGreetings && chat.settings.alternateGreetings.length > 0) {
        switchGreetingGroup.style.display = 'block';
      } else {
        switchGreetingGroup.style.display = 'none';
      }

      document.getElementById('chat-name-group').style.display = 'block';
      document.getElementById('my-persona-group').style.display = 'block';
      document.getElementById('my-avatar-group').style.display = 'block';
      document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('my-nickname-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-original-name-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-voice-id-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('inject-thought-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('todo-list-setting-group').style.display = isGroup ? 'none' : 'flex';
      document.getElementById('offline-mode-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('ai-cooldown-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('group-cooldown-group').style.display = isGroup ? 'block' : 'none';
      document.getElementById('chat-name-input').value = chat.name;
      document.getElementById('my-persona').value = chat.settings.myPersona;
      document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
      document.getElementById('max-memory').value = chat.settings.maxMemory;
      document.getElementById('linked-memory-count').value = chat.settings.linkedMemoryCount || 10;
      const bgPreview = document.getElementById('bg-preview');
      const removeBgBtn = document.getElementById('remove-bg-btn');
      if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
      } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
      }
      document.getElementById('lyrics-position-group').style.display = 'block';

      document.getElementById('single-char-background-activity-group').style.display = isGroup ? 'none' : 'block';
      document.getElementById('group-background-activity-group').style.display = isGroup ? 'block' : 'none';




      const timePerceptionToggle = document.getElementById('time-perception-toggle');
      const timeZoneGroup = document.getElementById('time-zone-group');
      timePerceptionToggle.checked = chat.settings.enableTimePerception;
      timeZoneGroup.style.display = timePerceptionToggle.checked ? 'block' : 'none';


      const timezoneSelect = document.getElementById('time-zone-select');

      const timezones = Intl.supportedValuesOf('timeZone');
      timezoneSelect.innerHTML = '';
      timezones.forEach(tz => {
        const option = document.createElement('option');
        option.value = tz;
        option.textContent = tz;
        timezoneSelect.appendChild(option);
      });

      timezoneSelect.value = chat.settings.timeZone || 'Asia/Shanghai';
      document.getElementById('enable-synth-music-switch').checked = chat.settings.enableSynthMusic || false;
      document.getElementById('narrator-mode-toggle').checked = chat.settings.enableNarratorMode || false;
      if (isGroup) {

        document.getElementById('group-background-activity-switch').checked = chat.settings.enableBackgroundActivity;
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('group-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;


        document.getElementById('single-char-background-activity-group').style.display = 'none';
        renderGroupMemberSettings(chat.members);
      } else {

        document.getElementById('single-char-background-activity-group').style.display = 'block';
        document.getElementById('enable-todo-list-switch').checked = chat.settings.enableTodoList || false;
        // --- ‰øÆÂ§çÂ§©Ê∞îËÆæÁΩÆÂõûÊòæÈÄªËæë ---
        const weatherSection = document.getElementById('weather-settings-section');
        weatherSection.style.display = 'block';

        // ËØªÂèñÂΩìÂâçËßíËâ≤ÁöÑÈÖçÁΩÆ
        const wSettings = chat.settings.weather || {};

        const weatherSwitch = document.getElementById('enable-weather-switch');
        const weatherConfigContainer = document.getElementById('weather-config-container');

        weatherSwitch.checked = wSettings.enabled || false;
        weatherConfigContainer.style.display = wSettings.enabled ? 'block' : 'none';
        
        // ÁªëÂÆöÂºÄÂÖ≥ÊòæÁ§∫ÈöêËóè (Èò≤Ê≠¢‰∫ã‰ª∂ÈáçÂ§çÁªëÂÆöÔºåÂÖàÁßªÈô§ÂÜçÊ∑ªÂä†ÔºåÊàñËÄÖ‰æùËµñ HTML onclick ÈÄªËæë)
        weatherSwitch.onclick = (e) => {
            weatherConfigContainer.style.display = e.target.checked ? 'block' : 'none';
        };

        // 1. ÂõûÊòæ User Êï∞ÊçÆ
        document.getElementById('user-virtual-city').value = wSettings.userVirtualCity || '';
        
        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë: ÊòæÂºèËÆæÁΩÆÊêúÁ¥¢Ê°ÜÁöÑÂÄº‰∏∫Â∑≤‰øùÂ≠òÁöÑÂüéÂ∏ÇÂêçÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊ∏ÖÁ©∫
        const userRealCityInput = document.getElementById('user-real-city-search');
        userRealCityInput.value = wSettings.userRealCity || ''; 
        userRealCityInput.dataset.realName = wSettings.userRealCity || ''; // ÂêåÊ≠• dataset

        document.getElementById('user-city-lat').value = wSettings.userLat || '';
        document.getElementById('user-city-lon').value = wSettings.userLon || '';

        if (wSettings.userRealCity) {
            document.getElementById('user-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.userRealCity} (${wSettings.userLat}, ${wSettings.userLon})`;
            document.getElementById('user-city-result').style.color = 'green';
        } else {
            document.getElementById('user-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
            document.getElementById('user-city-result').style.color = '#007bff';
        }

        // 2. ÂõûÊòæ Char Êï∞ÊçÆ
        document.getElementById('char-virtual-city').value = wSettings.charVirtualCity || '';

        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë: ÊòæÂºèËÆæÁΩÆÊêúÁ¥¢Ê°ÜÁöÑÂÄº‰∏∫Â∑≤‰øùÂ≠òÁöÑÂüéÂ∏ÇÂêçÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊ∏ÖÁ©∫
        const charRealCityInput = document.getElementById('char-real-city-search');
        charRealCityInput.value = wSettings.charRealCity || '';
        charRealCityInput.dataset.realName = wSettings.charRealCity || ''; // ÂêåÊ≠• dataset

        document.getElementById('char-city-lat').value = wSettings.charLat || '';
        document.getElementById('char-city-lon').value = wSettings.charLon || '';

        if (wSettings.charRealCity) {
            document.getElementById('char-city-result').textContent = `Â∑≤Êò†Â∞Ñ: ${wSettings.charRealCity} (${wSettings.charLat}, ${wSettings.charLon})`;
            document.getElementById('char-city-result').style.color = 'green';
        } else {
            document.getElementById('char-city-result').textContent = 'Êú™ËÆæÁΩÆÊò†Â∞Ñ';
            document.getElementById('char-city-result').style.color = '#007bff';
        }
        document.getElementById('char-background-activity-switch').checked = chat.settings.enableBackgroundActivity;
        document.getElementById('inject-thought-toggle').checked = chat.settings.injectLatestThought;
        
        const offlineModeToggle = document.getElementById('offline-mode-toggle');
        const offlineModeOptions = document.getElementById('offline-mode-options');
        const offlineMinInput = document.getElementById('offline-min-length-input');
        const offlineMaxInput = document.getElementById('offline-max-length-input');
        offlineModeToggle.checked = chat.settings.isOfflineMode || false;
        offlineModeOptions.style.display = offlineModeToggle.checked ? 'block' : 'none';
        offlineMinInput.value = chat.settings.offlineMinLength || 100;
        offlineMaxInput.value = chat.settings.offlineMaxLength || 300;
        await renderOfflinePresetSelector(chat);
        document.getElementById('ai-original-name-input').value = chat.originalName;
        document.getElementById('ai-voice-id-input').value = chat.settings.minimaxVoiceId || '';
        
        document.getElementById('ai-voice-lang-group').style.display = isGroup ? 'none' : 'block';
        document.getElementById('ai-voice-lang-select').value = chat.settings.ttsLanguage || '';
        document.getElementById('enable-tts-switch').checked = chat.settings.enableTts !== false;
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('my-nickname-input').value = chat.settings.myNickname || 'Êàë';
        document.getElementById('ai-action-cooldown-input').value = chat.settings.actionCooldownMinutes || 10;
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">Êú™ÂàÜÁªÑ</option>';
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = group.name;
          if (chat.groupId === group.id) option.selected = true;
          select.appendChild(option);
        });
        const lyricsPos = chat.settings.lyricsPosition || {
          vertical: 'top',
          horizontal: 'center',
          offset: 10
        };
        document.getElementById('lyrics-vertical-pos').value = lyricsPos.vertical;
        document.getElementById('lyrics-horizontal-pos').value = lyricsPos.horizontal;
        document.getElementById('lyrics-offset-input').value = lyricsPos.offset;
      }



      const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
      worldBookCheckboxesContainer.innerHTML = '';

      const [allCategories, allBooks] = await Promise.all([
        db.worldBookCategories.toArray(),
        db.worldBooks.toArray()
      ]);

      const linkedBookIds = new Set(chat.settings.linkedWorldBookIds || []);

      if (allBooks.length === 0) {
        worldBookCheckboxesContainer.innerHTML = '<p style="text-align:center; color: #8a8a8a;">ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰Ωï‰∏ñÁïå‰π¶</p>';
      } else {

        allCategories.forEach(cat => {
          const booksInCategory = allBooks.filter(book => book.categoryId === cat.id);
          if (booksInCategory.length > 0) {
            const categoryHeader = document.createElement('h4');
            categoryHeader.textContent = cat.name;
            categoryHeader.style.cssText = 'margin: 10px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
            worldBookCheckboxesContainer.appendChild(categoryHeader);

            booksInCategory.forEach(book => {
              const isChecked = linkedBookIds.has(book.id);
              const label = document.createElement('label');

              label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
              worldBookCheckboxesContainer.appendChild(label);
            });
          }
        });


        const uncategorizedBooks = allBooks.filter(book => !book.categoryId);
        if (uncategorizedBooks.length > 0) {
          const bookHeader = document.createElement('h4');
          bookHeader.textContent = 'Êú™ÂàÜÁ±ª';
          bookHeader.style.cssText = 'margin: 15px 0 5px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 3px;';
          worldBookCheckboxesContainer.appendChild(bookHeader);

          uncategorizedBooks.forEach(book => {
            const isChecked = linkedBookIds.has(book.id);
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="book_${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
            worldBookCheckboxesContainer.appendChild(label);
          });
        }
      }


      updateWorldBookSelectionDisplay();

      const linkMemoryToggle = document.getElementById('link-memory-toggle');
      const linkedMemorySelection = document.getElementById('linked-memory-selection');
      const linkedChatsContainer = document.getElementById('linked-chats-checkboxes-container');
      const linkedMemoryIds = chat.settings.linkedMemoryChatIds || [];
      linkMemoryToggle.checked = linkedMemoryIds.length > 0;
      linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none';
      linkedChatsContainer.innerHTML = '';
      Object.values(state.chats).forEach(c => {
        if (c.id === chat.id) return;
        const isChecked = linkedMemoryIds.includes(c.id);
        const prefix = c.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${c.id}" ${isChecked ? 'checked' : ''}> ${prefix} ${c.name}`;
        linkedChatsContainer.appendChild(label);
      });

      function updateLinkedMemorySelectionDisplay() {
        const checkedBoxes = linkedChatsContainer.querySelectorAll('input:checked');
        const displayText = linkedMemorySelection.querySelector('.selected-options-text');
        if (checkedBoxes.length === 0) {
          displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --';
        } else if (checkedBoxes.length > 2) {
          displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} È°π`;
        } else {
          displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', ');
        }
      }
      updateLinkedMemorySelectionDisplay();
      linkMemoryToggle.addEventListener('change', () => {
        linkedMemorySelection.style.display = linkMemoryToggle.checked ? 'block' : 'none';
      });
      const linkedMemorySelectBox = linkedMemorySelection.querySelector('.select-box');
      const newLinkedMemorySelectBox = linkedMemorySelectBox.cloneNode(true);
      linkedMemorySelectBox.parentNode.replaceChild(newLinkedMemorySelectBox, linkedMemorySelectBox);
      newLinkedMemorySelectBox.addEventListener('click', (e) => {
        e.stopPropagation();
        linkedChatsContainer.classList.toggle('visible');
        newLinkedMemorySelectBox.classList.toggle('expanded');
      });
      linkedChatsContainer.addEventListener('change', updateLinkedMemorySelectionDisplay);
      const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
      if (themeRadio) themeRadio.checked = true;
      const fontSizeSlider = document.getElementById('font-size-slider');
      fontSizeSlider.value = chat.settings.fontSize || 13;
      document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
      const customCssInput = document.getElementById('custom-css-input');
      customCssInput.value = chat.settings.customCss || '';
      updateSettingsPreview();
      document.getElementById('auto-memory-toggle').checked = chat.settings.enableAutoMemory || false;
      document.getElementById('auto-memory-interval').value = chat.settings.autoMemoryInterval || 20;
      document.getElementById('show-hidden-msg-toggle').checked = chat.settings.showHiddenMessages || false;
      setTimeout(() => {
        updateTokenCountDisplay(); 

        const inputsToWatch = [
          'ai-persona', 'my-persona', 'max-memory',
          'linked-memory-count', 'auto-memory-toggle', 'auto-memory-interval',
          'offline-mode-toggle', 'offline-min-length-input',
          'offline-max-length-input', 'offline-preset-select'
        ];

        inputsToWatch.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('input', updateTokenCountDisplay);
          }
        });

        // ‰∏∫Â§öÈÄâÊ°ÜÂÆπÂô®Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
        document.getElementById('world-book-checkboxes-container').addEventListener('change', updateTokenCountDisplay);
        document.getElementById('linked-chats-checkboxes-container').addEventListener('change', updateTokenCountDisplay);
        document.getElementById('link-memory-toggle').addEventListener('change', updateTokenCountDisplay);
      }, 100);
      showScreen('chat-settings-screen');
    });



    function renderGroupMemberSettings(members) {
      const container = document.getElementById('group-members-settings');
      container.innerHTML = '';
      members.forEach(member => {
        const div = document.createElement('div');
        div.className = 'member-editor';
        div.dataset.memberId = member.id;




        const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);

        div.innerHTML = `<img src="${memberAvatar}" alt="${member.groupNickname}"><div class="member-name">${member.groupNickname}</div>`;
        div.addEventListener('click', () => openMemberEditor(member.id));
        container.appendChild(div);
      });
    }



    document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
      if (!editingMemberId) return;
      const chat = state.chats[state.activeChatId];
      const member = chat.members.find(m => m.id === editingMemberId);
      if (!member) return;

      const newNickname = document.getElementById('member-name-input').value.trim();
      if (!newNickname) {
        alert("Áæ§ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        return;
      }
      member.groupNickname = newNickname;
      member.persona = document.getElementById('member-persona-input').value;

      const newAvatarUrl = document.getElementById('member-avatar-preview').src;



      member.avatar = newAvatarUrl;


      const characterProfile = state.chats[member.id];
      if (characterProfile) {
        characterProfile.settings.aiAvatar = newAvatarUrl;
        await db.chats.put(characterProfile);
      }


      await db.chats.put(chat);


      renderGroupMemberSettings(chat.members);
      document.getElementById('member-settings-modal').classList.remove('visible');
      editingMemberId = null;
    });



    function openMemberEditor(memberId) {
      editingMemberId = memberId;
      const chat = state.chats[state.activeChatId];
      const member = chat.members.find(m => m.id === memberId);
      if (!member) return;

      document.getElementById('member-name-input').value = member.groupNickname;
      document.getElementById('member-persona-input').value = member.persona;



      const memberAvatar = member.avatar || (state.chats[member.id] ? state.chats[member.id].settings.aiAvatar : defaultGroupMemberAvatar);
      document.getElementById('member-avatar-preview').src = memberAvatar;

      document.getElementById('member-settings-modal').classList.add('visible');
    }

    document.getElementById('cancel-member-settings-btn').addEventListener('click', () => {
      document.getElementById('member-settings-modal').classList.remove('visible');
      editingMemberId = null;
    });


    document.getElementById('save-member-settings-btn').addEventListener('click', async () => {
      if (!editingMemberId) return;
      const chat = state.chats[state.activeChatId];
      const member = chat.members.find(m => m.id === editingMemberId);
      if (!member) return;

      const newNickname = document.getElementById('member-name-input').value.trim();
      if (!newNickname) {
        alert("Áæ§ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        return;
      }
      member.groupNickname = newNickname;
      member.persona = document.getElementById('member-persona-input').value;

      const newAvatarUrl = document.getElementById('member-avatar-preview').src;



      member.avatar = newAvatarUrl;


      const characterProfile = state.chats[member.id];
      if (characterProfile) {
        characterProfile.settings.aiAvatar = newAvatarUrl;
        await db.chats.put(characterProfile);
      }


      await db.chats.put(chat);


      renderGroupMemberSettings(chat.members);
      document.getElementById('member-settings-modal').classList.remove('visible');
      editingMemberId = null;
    });

    document.getElementById('reset-theme-btn').addEventListener('click', () => {
      document.getElementById('theme-default').checked = true;
    });



    document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];


      const oldOfflineModeState = chat.settings.isOfflineMode || false;


      const newName = document.getElementById('chat-name-input').value.trim();
      if (!newName) return alert('Â§áÊ≥®Âêç/Áæ§Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
      if (!chat.isGroup && newName !== chat.name) {
        if (!chat.nameHistory) chat.nameHistory = [];
        if (!chat.nameHistory.includes(chat.name)) chat.nameHistory.push(chat.name);
      }
      chat.name = newName;
      const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
      chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';
      chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
      chat.settings.customCss = document.getElementById('custom-css-input').value.trim();
      chat.settings.myPersona = document.getElementById('my-persona').value;
      chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
      chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
      chat.settings.linkedMemoryCount = parseInt(document.getElementById('linked-memory-count').value) || 10;

      const checkedBookItems = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
      const newLinkedBookIds = [];
      checkedBookItems.forEach(cb => {
        if (cb.value.startsWith('book_')) {
          newLinkedBookIds.push(cb.value.replace('book_', ''));
        }
      });
      chat.settings.linkedWorldBookIds = newLinkedBookIds;

      const linkMemoryToggleChecked = document.getElementById('link-memory-toggle').checked;
      if (linkMemoryToggleChecked) {
        const checkedChats = document.querySelectorAll('#linked-chats-checkboxes-container input:checked');
        chat.settings.linkedMemoryChatIds = Array.from(checkedChats).map(cb => cb.value);
      } else {
        chat.settings.linkedMemoryChatIds = [];
      }
      chat.settings.enableAutoMemory = document.getElementById('auto-memory-toggle').checked;
      chat.settings.autoMemoryInterval = parseInt(document.getElementById('auto-memory-interval').value) || 20;
      chat.settings.showHiddenMessages = document.getElementById('show-hidden-msg-toggle').checked;
      chat.settings.enableTimePerception = document.getElementById('time-perception-toggle').checked;
      chat.settings.timeZone = document.getElementById('time-zone-select').value;
      chat.settings.lyricsPosition = {
          vertical: document.getElementById('lyrics-vertical-pos').value,
          horizontal: document.getElementById('lyrics-horizontal-pos').value,
          offset: parseInt(document.getElementById('lyrics-offset-input').value) || 10
        };
      chat.settings.enableSynthMusic = document.getElementById('enable-synth-music-switch').checked;
      chat.settings.enableNarratorMode = document.getElementById('narrator-mode-toggle').checked;
      if (chat.isGroup) {
        chat.settings.enableBackgroundActivity = document.getElementById('group-background-activity-switch').checked;
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
        chat.settings.actionCooldownMinutes = parseInt(document.getElementById('group-action-cooldown-input').value) || 10;
      } else {
        chat.settings.enableBackgroundActivity = document.getElementById('char-background-activity-switch').checked;
        chat.settings.enableTodoList = document.getElementById('enable-todo-list-switch').checked;
        const newOfflineModeState = document.getElementById('offline-mode-toggle').checked;
        chat.settings.isOfflineMode = newOfflineModeState;
        const weatherEnabled = document.getElementById('enable-weather-switch').checked;
    const weatherSettings = {
        enabled: weatherEnabled,
        userVirtualCity: document.getElementById('user-virtual-city').value.trim(),
        userRealCity: document.getElementById('user-real-city-search').dataset.realName || chat.settings.weather?.userRealCity || '',
        userLat: parseFloat(document.getElementById('user-city-lat').value) || null,
        userLon: parseFloat(document.getElementById('user-city-lon').value) || null,
        
        charVirtualCity: document.getElementById('char-virtual-city').value.trim(),
        charRealCity: document.getElementById('char-real-city-search').dataset.realName || chat.settings.weather?.charRealCity || '',
        charLat: parseFloat(document.getElementById('char-city-lat').value) || null,
        charLon: parseFloat(document.getElementById('char-city-lon').value) || null
    };
    
    chat.settings.weather = weatherSettings;





        if (oldOfflineModeState === true && newOfflineModeState === false) {


          const switchInstruction = {
            role: 'system',
            content: '[Á≥ªÁªüÊåá‰ª§ÔºöÊ®°ÂºèÂ∑≤ÂàáÊç¢ÔºÅ‰Ω†Áé∞Âú®ÂõûÂà∞‰∫ÜÁ∫ø‰∏äËÅäÂ§©Ê®°Âºè„ÄÇ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„Äë‰∏•Ê†ºÈÅµÂÆàÁ∫ø‰∏äÊ®°ÂºèÁöÑJSONÊï∞ÁªÑÊ†ºÂºèÔºå‰æãÂ¶Ç [{"type": "text", "content": "‰Ω†Â•Ω"}]]',
            timestamp: Date.now(),
            isHidden: true
          };


          chat.history.push(switchInstruction);
          console.log("Â∑≤ÊàêÂäüÊ≥®ÂÖ•‚ÄúÂàáÊç¢Âà∞Á∫ø‰∏äÊ®°Âºè‚ÄùÁöÑÁ≥ªÁªüÊåá‰ª§„ÄÇ");
        }


        chat.settings.injectLatestThought = document.getElementById('inject-thought-toggle').checked;
        
        chat.settings.offlineMinLength = parseInt(document.getElementById('offline-min-length-input').value) || 100;
        chat.settings.offlineMaxLength = parseInt(document.getElementById('offline-max-length-input').value) || 300;
        chat.settings.offlinePresetId = document.getElementById('offline-preset-select').value || null;

        const newOriginalName = document.getElementById('ai-original-name-input').value.trim();
        if (!newOriginalName) return alert('ÂØπÊñπÊú¨Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
        chat.originalName = newOriginalName;
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.minimaxVoiceId = document.getElementById('ai-voice-id-input').value.trim();
        
        chat.settings.ttsLanguage = document.getElementById('ai-voice-lang-select').value;
        chat.settings.enableTts = document.getElementById('enable-tts-switch').checked;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        chat.settings.myNickname = document.getElementById('my-nickname-input').value.trim() || 'Êàë';
        chat.settings.actionCooldownMinutes = parseInt(document.getElementById('ai-action-cooldown-input').value) || 10;
        
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
      }

      await db.chats.put(chat);
      if (!chat.isGroup) {
        await syncCharacterNameInGroups(chat);
        await syncCharacterAvatarInGroups(chat);
      }
      applyLyricsBarPosition(chat);
      applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
      showScreen('chat-interface-screen');
      renderChatInterface(state.activeChatId);
      renderChatList();
    });








    document.getElementById('chat-settings-screen').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('chat');
      }
    });


    document.getElementById('member-settings-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('member');
      }
    });


    const frameModal = document.getElementById('avatar-frame-modal');
    const aiFrameTab = document.getElementById('ai-frame-tab');
    const myFrameTab = document.getElementById('my-frame-tab');
    const aiFrameContent = document.getElementById('ai-frame-content');
    const myFrameContent = document.getElementById('my-frame-content');


    document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);


    document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
      frameModal.classList.remove('visible');
      editingFrameForMember = false;
    });


    aiFrameTab.addEventListener('click', () => {
      aiFrameTab.classList.add('active');
      myFrameTab.classList.remove('active');
      aiFrameContent.style.display = 'block';
      myFrameContent.style.display = 'none';
    });


    myFrameTab.addEventListener('click', () => {
      myFrameTab.classList.add('active');
      aiFrameTab.classList.remove('active');
      myFrameContent.style.display = 'block';
      aiFrameContent.style.display = 'none';
    });


    document.getElementById('clear-chat-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];
      const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï', 'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂêóÔºü', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        chat.history = [];
        chat.heartfeltVoice = '...';
        chat.randomJottings = '...';
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
        renderChatList();
        chatSettingsModal.classList.remove('visible');
      }
    });

    const setupFileUpload = (inputId, callback) => {
      document.getElementById(inputId).addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (file) {
          const dataUrl = await new Promise((res, rej) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.onerror = () => rej(reader.error);
            reader.readAsDataURL(file);
          });
          callback(dataUrl);
          event.target.value = null;
        }
      });
    };
    setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
    setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
    setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
    setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
    setupFileUpload('bg-input', async (base64) => {
      if (state.activeChatId) {
        const chat = state.chats[state.activeChatId];
        
        // 1. Á´ãÂç≥‰øùÂ≠òÂíåÊòæÁ§∫
        chat.settings.background = base64;
        const bgPreview = document.getElementById('bg-preview');
        bgPreview.src = base64;
        bgPreview.style.display = 'block';
        document.getElementById('remove-bg-btn').style.display = 'inline-block';
        
        await showCustomAlert("ÊàêÂäü", "ËÅäÂ§©ËÉåÊôØÂ∑≤Êõ¥Êñ∞ÔºÅ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä... (‰øùÂ≠òËÆæÁΩÆÂêéÁîüÊïà)");

        // 2. ÂêØÂä®ÈùôÈªò‰∏ä‰º†
        (async () => {
            await silentlyUpdateDbUrl(
                db.chats,
                chat.id,
                'settings.background',
                base64
            );
        })();
      }
    });
    setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
    document.getElementById('remove-bg-btn').addEventListener('click', () => {
      if (state.activeChatId) {
        state.chats[state.activeChatId].settings.background = '';
        const bgPreview = document.getElementById('bg-preview');
        bgPreview.src = '';
        bgPreview.style.display = 'none';
        document.getElementById('remove-bg-btn').style.display = 'none';
      }
    });

    const stickerPanel = document.getElementById('sticker-panel');
    document.getElementById('open-sticker-panel-btn').addEventListener('click', () => {
      const chat = state.chats[state.activeChatId];
      if (chat && chat.settings.stickerCategoryId) {

        activeStickerCategoryId = chat.settings.stickerCategoryId;
      } else {

        activeStickerCategoryId = 'all';
      }
      renderStickerPanel();
      stickerPanel.classList.add('visible');
    });
    document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));



    document.getElementById('add-sticker-batch-btn').addEventListener('click', openBatchStickerImportModal);






    document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
    document.getElementById('sticker-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = async () => {
        let base64Url = reader.result;
        const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂ•ΩËÄ∂„ÄÅÁñëÊÉë)");

        if (name && name.trim()) {
            const trimmedName = name.trim();
            
            const newSticker = {
    id: 'sticker_' + Date.now() + Math.random(), // <-- Add this line
    url: base64Url, 
    name: trimmedName,
    categoryId: (activeStickerCategoryId !== 'all' && activeStickerCategoryId !== 'uncategorized') ? activeStickerCategoryId : null
};
            const newId = await db.userStickers.add(newSticker); // 1. Save to DB
            
            newSticker.id = newId; 
            state.userStickers.push(newSticker); // 2. Update state
            
            renderStickerPanel(); // 3. Render UI
            await showCustomAlert("Ê∑ªÂä†ÊàêÂäüÔºÅ", `Ë°®ÊÉÖ‚Äú${trimmedName}‚ÄùÂ∑≤Ê∑ªÂä†„ÄÇ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä...`);

            // 4. „Äê„Äê„ÄêÂ∑≤‰øÆÂ§çÁöÑË∞ÉÁî®„Äë„Äë„Äë
            (async () => {
                await silentlyUpdateDbUrl(
                    db.userStickers, // table
                    newId, // recordId
                    'url', // pathString (ÊåáÂêëÁÆÄÂçïÂ±ûÊÄß)
                    base64Url // base64ToFind
                    // nameToMatch (‰∏çÈúÄË¶Å)
                );
            })();

        } else if (name !== null) {
             alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
        }
      };
      event.target.value = null;
    });

    document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
   document.getElementById('image-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file || !state.activeChatId) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64Url = e.target.result;
        const chat = state.chats[state.activeChatId];
        const msg = {
          role: 'user',
          content: [{
            type: 'image_url',
            image_url: {
              url: base64Url
            }
          }],
          timestamp: Date.now()
        };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
      };
      reader.readAsDataURL(file);
      event.target.value = null;
    });
    document.getElementById('voice-message-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;

      const text = await showCustomPrompt("ÂèëÈÄÅËØ≠Èü≥", "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö");
      if (text && text.trim()) {
        const chat = state.chats[state.activeChatId];


        const msg = {
          role: 'user',
          type: 'voice_message',
          content: text.trim(),
          timestamp: Date.now()
        };

        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
      }
    });
    document.getElementById('send-photo-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö");
      if (description && description.trim()) {
        const chat = state.chats[state.activeChatId];
        const msg = {
          role: 'user',
          type: 'user_photo',
          content: description.trim(),
          timestamp: Date.now()
        };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        renderChatList();
      }
    });

    const waimaiModal = document.getElementById('waimai-request-modal');


    document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
      waimaiModal.classList.add('visible');
    });


    waimaiModal.addEventListener('click', (e) => {

      if (e.target === waimaiModal) {
        waimaiModal.classList.remove('visible');
      }
    });


    document.getElementById('waimai-order-for-ai-btn').addEventListener('click', sendWaimaiOrderForAI);


    document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;

      const productInfoInput = document.getElementById('waimai-product-info');
      const amountInput = document.getElementById('waimai-amount');

      const productInfo = productInfoInput.value.trim();
      const amount = parseFloat(amountInput.value);

      if (!productInfo || isNaN(amount) || amount <= 0) {
        alert('ËØ∑Â°´ÂÜôÊúâÊïàÁöÑÂïÜÂìÅ‰ø°ÊÅØÂíåÈáëÈ¢ùÔºÅ');
        return;
      }

      const chat = state.chats[state.activeChatId];
      const now = Date.now();
      const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

      const msg = {
        role: 'user',
        senderName: myNickname,
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
      };

      chat.history.push(msg);
      await db.chats.put(chat);
      appendMessage(msg, chat);
      renderChatList();

      productInfoInput.value = '';
      amountInput.value = '';
      waimaiModal.classList.remove('visible');
    });
    document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
    document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
    document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
    document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
    document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
    document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
    document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
    document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);

    document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);




    document.getElementById('selection-soft-delete-btn').addEventListener('click', async () => {
      if (selectedMessages.size === 0) return;
      const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüËøô‰ºöÈÄöÁü•AIËøô‰∫õÊ∂àÊÅØÂ∑≤Ë¢´Âà†Èô§„ÄÇ`, {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        const chat = state.chats[state.activeChatId];
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
          const msg = chat.history.find(m => m.timestamp === timestamp);
          if (msg && msg.type === 'poll') {
            deletedPollsInfo.push(`ÂÖ≥‰∫é‚Äú${msg.question}‚ÄùÁöÑÊäïÁ•®(Êó∂Èó¥Êà≥: ${msg.timestamp})`);
          }
        }
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        let forgetReason = "‰∏Ä‰∫õ‰πãÂâçÁöÑÊ∂àÊÅØÂ∑≤Ë¢´Áî®Êà∑Âà†Èô§„ÄÇ";
        if (deletedPollsInfo.length > 0) {
          forgetReason += ` ÂÖ∂‰∏≠ÂåÖÊã¨‰ª•‰∏ãÊäïÁ•®Ôºö${deletedPollsInfo.join('Ôºõ')}„ÄÇ`;
        }
        forgetReason += " ‰Ω†Â∫îËØ•ÂÉèÂÆÉ‰ª¨‰ªéÊú™Â≠òÂú®Ëøá‰∏ÄÊ†∑ÁªßÁª≠ÂØπËØùÔºåÂπ∂Áõ∏Â∫îÂú∞Ë∞ÉÊï¥‰Ω†ÁöÑËÆ∞ÂøÜÂíåË°å‰∏∫Ôºå‰∏çË¶ÅÂÜçÊèêÂèäËøô‰∫õË¢´Âà†Èô§ÁöÑÂÜÖÂÆπ„ÄÇ";
        const forgetInstruction = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫Ôºö${forgetReason}]`,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(forgetInstruction);
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
        renderChatList();
      }
    });


    document.getElementById('selection-erase-btn').addEventListener('click', async () => {
      if (selectedMessages.size === 0) return;
      const confirmed = await showCustomConfirm(
        'ÂΩªÂ∫ïÂà†Èô§Ê∂àÊÅØ',
        `ËøôÂ∞Ü‰ªéÂéÜÂè≤ËÆ∞ÂΩï‰∏≠„ÄêÊ∞∏‰πÖÊäπÈô§„ÄëËøô ${selectedMessages.size} Êù°Ê∂àÊÅØÔºåAIÂ∞ÜÂÆåÂÖ®ÈÅóÂøòÂÆÉ‰ª¨ÁöÑÂ≠òÂú®„ÄÇÁ°ÆÂÆöÂêóÔºü`, {
          confirmButtonClass: 'btn-danger',
          confirmText: 'Á°ÆËÆ§ÊäπÈô§'
        }
      );
      if (confirmed) {
        const chat = state.chats[state.activeChatId];


        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));


        await db.chats.put(chat);


        renderChatInterface(state.activeChatId);
        renderChatList();
      }
    });


    const fontUrlInput = document.getElementById('font-url-input');
    fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
    document.getElementById('save-font-btn').addEventListener('click', async () => {
      const newFontUrl = fontUrlInput.value.trim();
      if (!newFontUrl) {
        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂ≠ó‰ΩìURL„ÄÇ");
        return;
      }
      applyCustomFont(newFontUrl, false);
      state.globalSettings.fontUrl = newFontUrl;
      await db.globalSettings.put(state.globalSettings);
      alert('Â≠ó‰ΩìÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
    });
    document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

    document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
      item.addEventListener('click', () => switchToChatListView(item.dataset.view));
    });
    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
    document.getElementById('qzone-nickname').addEventListener('click', async () => {
      const newNickname = await showCustomPrompt("‰øÆÊîπÊòµÁß∞", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòµÁß∞", state.qzoneSettings.nickname);
      if (newNickname && newNickname.trim()) {
        state.qzoneSettings.nickname = newNickname.trim();
        await saveQzoneSettings();
        renderQzoneScreen();
      }
    });
    document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
    document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
    document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise(res => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });
        state.qzoneSettings.avatar = dataUrl;
        await saveQzoneSettings();
        renderQzoneScreen();
      }
      event.target.value = null;
    });
    document.getElementById('qzone-banner-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise(res => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });
        state.qzoneSettings.banner = dataUrl;
        await saveQzoneSettings();
        renderQzoneScreen();
      }
      event.target.value = null;
    });


    document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {

      resetCreatePostModal();
      const modal = document.getElementById('create-post-modal');


      modal.dataset.mode = 'shuoshuo';


      modal.querySelector('.post-mode-switcher').style.display = 'none';
      modal.querySelector('#image-mode-content').style.display = 'none';
      modal.querySelector('#text-image-mode-content').style.display = 'none';


      modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...';


      const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
      visibilityGroupsContainer.innerHTML = '';
      const groups = await db.qzoneGroups.toArray();
      if (groups.length > 0) {
        groups.forEach(group => {
          const label = document.createElement('label');
          label.style.display = 'block';
          label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
          visibilityGroupsContainer.appendChild(label);
        });
      } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
      }
      modal.classList.add('visible');
    });


    document.getElementById('create-post-btn').addEventListener('click', async () => {

      resetCreatePostModal();
      const modal = document.getElementById('create-post-modal');


      modal.dataset.mode = 'complex';


      modal.querySelector('.post-mode-switcher').style.display = 'flex';

      modal.querySelector('#image-mode-content').classList.add('active');

      modal.querySelector('#text-image-mode-content').classList.remove('active');


      modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ';


      const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
      visibilityGroupsContainer.innerHTML = '';
      const groups = await db.qzoneGroups.toArray();
      if (groups.length > 0) {
        groups.forEach(group => {
          const label = document.createElement('label');
          label.style.display = 'block';
          label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
          visibilityGroupsContainer.appendChild(label);
        });
      } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
      }
      modal.classList.add('visible');
    });
    document.getElementById('open-album-btn').addEventListener('click', async () => {
      await renderAlbumList();
      showScreen('album-screen');
    });
    document.getElementById('album-back-btn').addEventListener('click', () => {
      showScreen('chat-list-screen');
      switchToChatListView('qzone-screen');
    });



    document.getElementById('album-photos-back-btn').addEventListener('click', () => {
      state.activeAlbumId = null;
      showScreen('album-screen');
    });

    document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

    document.getElementById('album-photo-input').addEventListener('change', async (event) => {
      if (!state.activeAlbumId) return;
      const files = event.target.files;
      if (!files.length) return;

      const album = await db.qzoneAlbums.get(state.activeAlbumId);

      for (const file of files) {
        const dataUrl = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({
          albumId: state.activeAlbumId,
          url: dataUrl,
          createdAt: Date.now()
        });
      }

      const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
      const updateData = {
        photoCount
      };

      if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if (firstPhoto) updateData.coverUrl = firstPhoto.url;
      }

      await db.qzoneAlbums.update(state.activeAlbumId, updateData);
      await renderAlbumPhotosScreen();
      await renderAlbumList();

      event.target.value = null;
      alert('ÁÖßÁâá‰∏ä‰º†ÊàêÂäüÔºÅ');
    });





    document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
      const deleteBtn = e.target.closest('.photo-delete-btn');
      const photoThumb = e.target.closest('.photo-thumb');

      if (deleteBtn) {
        e.stopPropagation();
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
          'Âà†Èô§ÁÖßÁâá',
          'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', {
            confirmButtonClass: 'btn-danger'
          }
        );

        if (confirmed) {
          const deletedPhoto = await db.qzonePhotos.get(photoId);
          if (!deletedPhoto) return;

          await db.qzonePhotos.delete(photoId);

          const album = await db.qzoneAlbums.get(state.activeAlbumId);
          const photoCount = (album.photoCount || 1) - 1;
          const updateData = {
            photoCount
          };

          if (album.coverUrl === deletedPhoto.url) {
            const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
            updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
          }

          await db.qzoneAlbums.update(state.activeAlbumId, updateData);
          await renderAlbumPhotosScreen();
          await renderAlbumList();
          alert('ÁÖßÁâáÂ∑≤Âà†Èô§„ÄÇ');
        }
      } else if (photoThumb) {

        openPhotoViewer(photoThumb.src);
      }
    });


    document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
    document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
    document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);


    document.addEventListener('keydown', (e) => {
      if (!photoViewerState.isOpen) return;

      if (e.key === 'ArrowRight') {
        showNextPhoto();
      } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
      } else if (e.key === 'Escape') {
        closePhotoViewer();
      }
    });



    document.getElementById('create-album-btn-page').addEventListener('click', async () => {
      const albumName = await showCustomPrompt("ÂàõÂª∫Êñ∞Áõ∏ÂÜå", "ËØ∑ËæìÂÖ•Áõ∏ÂÜåÂêçÁß∞");
      if (albumName && albumName.trim()) {
        const newAlbum = {
          name: albumName.trim(),
          coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png',
          photoCount: 0,
          createdAt: Date.now()
        };
        await db.qzoneAlbums.add(newAlbum);
        await renderAlbumList();
        alert(`Áõ∏ÂÜå "${albumName}" ÂàõÂª∫ÊàêÂäüÔºÅ`);
      } else if (albumName !== null) {
        alert("Áõ∏ÂÜåÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
      }
    });

    document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
    document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
    document.getElementById('post-local-image-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('post-image-preview').src = e.target.result;
          document.getElementById('post-image-preview-container').classList.add('visible');
          document.getElementById('post-image-desc-group').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    document.getElementById('post-use-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•ÁΩëÁªúÂõæÁâáÁöÑÈìæÊé•", "", "url");
      if (url) {
        document.getElementById('post-image-preview').src = url;
        document.getElementById('post-image-preview-container').classList.add('visible');
        document.getElementById('post-image-desc-group').style.display = 'block';
      }
    });
    document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
    const imageModeBtn = document.getElementById('switch-to-image-mode');
    const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
    const imageModeContent = document.getElementById('image-mode-content');
    const textImageModeContent = document.getElementById('text-image-mode-content');
    imageModeBtn.addEventListener('click', () => {
      imageModeBtn.classList.add('active');
      textImageModeBtn.classList.remove('active');
      imageModeContent.classList.add('active');
      textImageModeContent.classList.remove('active');
    });
    textImageModeBtn.addEventListener('click', () => {
      textImageModeBtn.classList.add('active');
      imageModeBtn.classList.remove('active');
      textImageModeContent.classList.add('active');
      imageModeContent.classList.remove('active');
    });


    document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
      const modal = document.getElementById('create-post-modal');
      const mode = modal.dataset.mode;


      const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
      let visibleGroupIds = null;

      if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
      }

      let newPost = {};
      const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',

        visibleGroupIds: visibleGroupIds,
      };


      if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
          alert('ËØ¥ËØ¥ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');
          return;
        }
        newPost = {
          ...basePostData,
          type: 'shuoshuo',
          content: content,
        };

      } else {
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

        if (isImageModeActive) {
          const imageUrl = document.getElementById('post-image-preview').src;
          const imageDescription = document.getElementById('post-image-description').value.trim();
          if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
            alert('ËØ∑ÂÖàÊ∑ªÂä†‰∏ÄÂº†ÂõæÁâáÂÜçÂèëÂ∏ÉÂä®ÊÄÅÂì¶ÔºÅ');
            return;
          }
          if (!imageDescription) {
            alert('ËØ∑‰∏∫‰Ω†ÁöÑÂõæÁâáÊ∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊèèËø∞ÔºàÂøÖÂ°´ÔºåÁªôAIÁúãÁöÑÔºâÔºÅ');
            return;
          }
          newPost = {
            ...basePostData,
            type: 'image_post',
            publicText: publicText,
            imageUrl: imageUrl,
            imageDescription: imageDescription,
          };
        } else {
          const hiddenText = document.getElementById('post-hidden-text').value.trim();
          if (!hiddenText) {
            alert('ËØ∑ËæìÂÖ•ÊñáÂ≠óÂõæÊèèËø∞ÔºÅ');
            return;
          }
          newPost = {
            ...basePostData,
            type: 'text_image',
            publicText: publicText,
            hiddenContent: hiddenText,
          };
        }
      }


      const newPostId = await db.qzonePosts.add(newPost);
      let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";
      postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');


      for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue;

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;


        if (!postVisibleGroups || postVisibleGroups.length === 0) {
          shouldNotify = true;
        } else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
          shouldNotify = true;
        }


        if (shouldNotify) {

          const historyMessage = {
            role: 'system',
            content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÂèëÂ∏É‰∫Ü‰∏ÄÊù°Âä®ÊÄÅ(ID: ${newPostId})ÔºåÂÜÖÂÆπÊëòË¶ÅÊòØÔºö‚Äú${postSummary}‚Äù„ÄÇËØ∑‰Ω†„ÄêÁªìÂêàËá™Â∑±ÁöÑËßíËâ≤ËÆæÂÆö„ÄÅ‰∏ñÁïåËßÇÂíå‰Ω†‰ª¨ÁöÑÊúÄËøëËÅäÂ§©ÂÜÖÂÆπ„ÄëÔºåÂØπËøôÊù°Âä®ÊÄÅÂèëË°®‰∏ÄÊù°Ëá™ÁÑ∂ÁöÑËØÑËÆ∫„ÄÇ]`,
            timestamp: Date.now(),
            isHidden: true
          };

          chat.history.push(historyMessage);
          await db.chats.put(chat);
        }
      }


      await renderQzonePosts();
      modal.classList.remove('visible');
      alert('Âä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ');
    });



    const postsList = document.getElementById('qzone-posts-list');
    let swipeState = {
      isDragging: false,
      startX: 0,
      startY: 0,
      currentX: 0,
      activeContainer: null,
      swipeDirection: null,
      isClick: true
    };

    function resetAllSwipes(exceptThisOne = null) {
      document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
          container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
      });
    }

 
    async function handlePostClick(e) {
      e.stopPropagation();
      const target = e.target;


      const deleteBtn = target.closest('.comment-delete-btn');
      if (deleteBtn) {
        const postContainer = deleteBtn.closest('.qzone-post-container');
        const postId = parseInt(postContainer.dataset.postId);
        const commentIndex = parseInt(deleteBtn.dataset.commentIndex);
        if (isNaN(postId) || isNaN(commentIndex)) return;

        const post = qzonePostsCache.find(p => p.id === postId);
        if (!post || !post.comments || !post.comments[commentIndex]) return;



        const deletedComment = post.comments[commentIndex];

        const confirmed = await showCustomConfirm('Âà†Èô§ËØÑËÆ∫', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü', {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {

          post.comments.splice(commentIndex, 1);
          await db.qzonePosts.update(postId, {
            comments: post.comments
          });




          if (deletedComment && deletedComment.commenterName === state.qzoneSettings.nickname) {
            console.log("Áî®Êà∑Âà†Èô§‰∫ÜËá™Â∑±ÁöÑËØÑËÆ∫ÔºåÂºÄÂßãÊ∏ÖÁêÜAIËÆ∞ÂøÜ...");


            const aiToNotifyIds = new Set();
            if (post.authorId !== 'user') {
              aiToNotifyIds.add(post.authorId);
            }
            if (deletedComment.replyTo) {
              const repliedToChat = Object.values(state.chats).find(c => c.originalName === deletedComment.replyTo);
              if (repliedToChat) {
                aiToNotifyIds.add(repliedToChat.id);
              }
            }


            const postSummary = (post.publicText || post.content || '').substring(0, 30);
            const userNickname = state.qzoneSettings.nickname;
            let notificationText;
            const stickerMatch = state.userStickers.find(s => s.url === deletedComment.text);

            if (stickerMatch) {
              notificationText = `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${stickerMatch.name}‚Äù„ÄÇ`;
            } else if (deletedComment.replyTo) {
              const repliedToDisplayName = getDisplayNameByOriginalName(deletedComment.replyTo);
              notificationText = `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂõûÂ§ç‰∫Ü'${repliedToDisplayName}'ÁöÑËØÑËÆ∫ÔºåÂÜÖÂÆπÊòØÔºö‚Äú${deletedComment.text}‚Äù„ÄÇ`;
            } else {
              notificationText = `Áî®Êà∑'${userNickname}'ÂàöÂàöËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚ÄùÔºåÂÜÖÂÆπÊòØÔºö‚Äú${deletedComment.text}‚Äù„ÄÇ`;
            }
            const fullSystemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö${notificationText}ËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`;


            for (const aiId of aiToNotifyIds) {
              const chat = state.chats[aiId];
              if (chat) {
                const originalLength = chat.history.length;

                chat.history = chat.history.filter(msg =>
                  !(msg.isHidden && msg.role === 'system' && msg.content === fullSystemContent)
                );

                if (chat.history.length < originalLength) {
                  console.log(`Âú®ËßíËâ≤ "${chat.name}" ÁöÑËÆ∞ÂøÜ‰∏≠Ê∏ÖÈô§‰∫Ü1Êù°ÂÖ≥‰∫éÂ∑≤Âà†Èô§ËØÑËÆ∫ÁöÑÈÄöÁü•„ÄÇ`);
                  await db.chats.put(chat);
                }
              }
            }
          }


          await updateSinglePostInDOM(postId);
        }

        return;
      }


      const stickerBtn = target.closest('.comment-sticker-btn');
      if (stickerBtn) {
        const postContainer = stickerBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (qzoneStickerPanelState.isOpen && qzoneStickerPanelState.activePostId === postId) {
          closeQzoneStickerPanel();
        } else {
          openQzoneStickerPanel(postId, stickerBtn);
        }
        return;
      }
      const commentItem = target.closest('.comment-item');
      if (commentItem) {
        const postId = parseInt(commentItem.dataset.postId);
        const commenterOriginalName = commentItem.dataset.commenterOriginalName;
        const commenterDisplayName = commentItem.dataset.commenterDisplayName;

        if (!commenterOriginalName || !commenterDisplayName || commenterOriginalName === state.qzoneSettings.nickname) {
          clearQzoneReplyContext(commentItem.closest('.qzone-post-container'));
          return;
        }
        currentQzoneReplyContext = {
          postId,
          replyToName: commenterOriginalName,
          replyToDisplayName: commenterDisplayName
        };
        const postContainer = commentItem.closest('.qzone-post-container');
        const commentInput = postContainer.querySelector('.comment-input');
        commentInput.placeholder = `ÂõûÂ§ç ${commenterDisplayName}:`;
        commentInput.focus();
        return;
      }
      if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) showPostActions(parseInt(container.dataset.postId));
        return;
      }
      if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", target.dataset.hiddenText.replace(/<br>/g, '\n'));
        return;
      }


      const postContainer = target.closest('.qzone-post-container');
      if (!postContainer) return;
      const postId = parseInt(postContainer.dataset.postId);
      if (isNaN(postId)) return;

      if (target.closest('.qzone-post-delete-action')) {
        const confirmed = await showCustomConfirm('Âà†Èô§Âä®ÊÄÅ', 'Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü', {
          confirmButtonClass: 'btn-danger'
        });
        if (confirmed) {
          postContainer.style.transition = 'all 0.3s ease';
          postContainer.style.transform = 'scale(0.8)';
          postContainer.style.opacity = '0';
          setTimeout(async () => {
            await db.qzonePosts.delete(postId);
            const notificationIdentifier = `(ID: ${postId})`;
            for (const chatId in state.chats) {
              const chat = state.chats[chatId];
              const originalHistoryLength = chat.history.length;
              chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
              if (chat.history.length < originalHistoryLength) await db.chats.put(chat);
            }
            await renderQzonePosts();
            alert('Âä®ÊÄÅÂ∑≤Âà†Èô§„ÄÇ');
          }, 300);
        }
        return;
      }

      const icon = target.closest('.action-icon');
      if (icon) {
        if (icon.classList.contains('repost')) {
          openRepostModal(postId);
          return;
        }
        if (icon.classList.contains('like')) {
          const post = qzonePostsCache.find(p => p.id === postId);
          if (!post) return;
          if (!post.likes) post.likes = [];
          const userOriginalName = state.qzoneSettings.nickname;
          const userLikeIndex = post.likes.indexOf(userOriginalName);
          if (userLikeIndex > -1) {
            post.likes.splice(userLikeIndex, 1);
          } else {
            post.likes.push(userOriginalName);
            icon.classList.add('animate-like');
            icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), {
              once: true
            });
          }
          await db.qzonePosts.update(postId, {
            likes: post.likes
          });
          await updateSinglePostInDOM(postId);
        }
        if (icon.classList.contains('favorite')) {
          const existingFavorite = await db.favorites.where({
            type: 'qzone_post',
            'content.id': postId
          }).first();
          if (existingFavorite) {
            await db.favorites.delete(existingFavorite.id);
            await showCustomAlert('ÊèêÁ§∫', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè');
          } else {
            const postToSave = await db.qzonePosts.get(postId);
            if (postToSave) {
              await db.favorites.add({
                type: 'qzone_post',
                content: postToSave,
                timestamp: Date.now()
              });
              await showCustomAlert('ÊèêÁ§∫', 'Êî∂ËóèÊàêÂäüÔºÅ');
            }
          }
          await updateSinglePostInDOM(postId);
        }
        return;
      }

      const sendBtn = target.closest('.comment-send-btn');
      if (sendBtn) {
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');

        const post = qzonePostsCache.find(p => p.id === postId);
        if (!post) return;

        if (!post.comments) post.comments = [];

        const newComment = {
          commenterName: state.qzoneSettings.nickname,
          text: commentText,
          timestamp: Date.now(),
          replyTo: (currentQzoneReplyContext && currentQzoneReplyContext.postId === postId) ? currentQzoneReplyContext.replyToName : null
        };

        post.comments.push(newComment);
        await db.qzonePosts.update(postId, {
          comments: post.comments
        });

        let postSummary = (post.publicText || post.content || '').substring(0, 30);
        const userNickname = state.qzoneSettings.nickname;
        const notifiedAiIds = new Set();
        if (post.authorId !== 'user') notifiedAiIds.add(post.authorId);
        if (newComment.replyTo && newComment.replyTo !== userNickname) {
          const repliedToChat = Object.values(state.chats).find(c => c.originalName === newComment.replyTo);
          if (repliedToChat) notifiedAiIds.add(repliedToChat.id);
        }
        for (const aiId of notifiedAiIds) {
          const chat = state.chats[aiId];
          if (chat && !chat.isGroup) {
            const stickerMatch = state.userStickers.find(s => s.url === commentText);
            let notificationText = stickerMatch ? `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖËØÑËÆ∫ÔºåÊÑèÊÄùÊòØÔºö‚Äú${stickerMatch.name}‚Äù„ÄÇ` :
              newComment.replyTo ? `Áî®Êà∑'${userNickname}'ÂàöÂàöÂú®‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚Äù‰∏ãÔºåÂõûÂ§ç‰∫Ü'${currentQzoneReplyContext.replyToDisplayName}'ÁöÑËØÑËÆ∫ÔºåÂÜÖÂÆπÊòØÔºö‚Äú${commentText}‚Äù„ÄÇ` :
              `Áî®Êà∑'${userNickname}'ÂàöÂàöËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ‚Äú${postSummary}‚ÄùÔºåÂÜÖÂÆπÊòØÔºö‚Äú${commentText}‚Äù„ÄÇ`;
            const historyMessage = {
              role: 'system',
              content: `[Á≥ªÁªüÊèêÁ§∫Ôºö${notificationText}ËØ∑‰Ω†ÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ]`,
              timestamp: Date.now(),
              isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
          }
        }

        commentInput.value = '';
        clearQzoneReplyContext(postContainer);
        await updateSinglePostInDOM(postId);
        return;
      }
    }






    const handleSwipeStart = (e) => {
      const target = e.target;

      if (target.closest('.post-footer, .post-feedback-icons, .post-actions-btn, .post-comments-container, .reposted-content-wrapper')) {
        return;
      }
      const targetContainer = e.target.closest('.qzone-post-container');
      if (!targetContainer) return;

      resetAllSwipes(targetContainer);
      swipeState.activeContainer = targetContainer;
      swipeState.isDragging = true;
      swipeState.isClick = true;
      swipeState.swipeDirection = null;
      swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';


      document.addEventListener('mousemove', handleSwipeMove);
      document.addEventListener('mouseup', handleSwipeEnd);
      document.addEventListener('touchmove', handleSwipeMove, {
        passive: false
      });
      document.addEventListener('touchend', handleSwipeEnd);
    };


    const handleSwipeMove = (e) => {
      if (!swipeState.isDragging || !swipeState.activeContainer) return;

      const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
      const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
      const diffX = currentX - swipeState.startX;
      const diffY = currentY - swipeState.startY;

      if (swipeState.isClick && (Math.abs(diffX) > 5 || Math.abs(diffY) > 5)) {
        swipeState.isClick = false;
      }

      if (!swipeState.swipeDirection) {
        if (Math.abs(diffX) > Math.abs(diffY)) {
          swipeState.swipeDirection = 'horizontal';
        } else {
          swipeState.swipeDirection = 'vertical';
        }
      }

      if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = Math.min(0, Math.max(-90, diffX));
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
      }
    };


    const handleSwipeEnd = (e) => {

      document.removeEventListener('mousemove', handleSwipeMove);
      document.removeEventListener('mouseup', handleSwipeEnd);
      document.removeEventListener('touchmove', handleSwipeMove);
      document.removeEventListener('touchend', handleSwipeEnd);

      if (!swipeState.isDragging || !swipeState.activeContainer) return;

      const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
      postItem.style.transition = 'transform 0.3s ease';

      if (swipeState.swipeDirection === 'horizontal' && !swipeState.isClick) {
        const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
        const diffX = finalX - swipeState.startX;
        if (diffX < -40) {
          postItem.classList.add('swiped');
        } else {
          postItem.classList.remove('swiped');
        }
      }

      postItem.style.transform = '';


      swipeState.isDragging = false;
      swipeState.activeContainer = null;
      swipeState.swipeDirection = null;
      swipeState.isClick = true;
    };











    postsList.addEventListener('click', handlePostClick);
    postsList.addEventListener('mousedown', handleSwipeStart);
    postsList.addEventListener('touchstart', handleSwipeStart, {
      passive: true
    });



    postsList.addEventListener('click', (e) => {

      if (e.target && e.target.id === 'load-more-qzone-btn') {
        loadMoreQzonePosts();
      }
    });


    document.getElementById('refine-memory-btn-header').addEventListener('click', () => {
      if (state.activeChatId) {
        summarizeExistingLongTermMemory(state.activeChatId);
      }
    });

    document.getElementById('api-preset-select').addEventListener('change', handlePresetSelectionChange);
    document.getElementById('save-api-preset-btn').addEventListener('click', saveApiPreset);
    document.getElementById('delete-api-preset-btn').addEventListener('click', deleteApiPreset);


    document.getElementById('add-world-book-entry-btn').addEventListener('click', () => {
      const container = document.getElementById('world-book-entries-container');

      if (container.querySelector('p')) {
        container.innerHTML = '';
      }
      const newBlock = createWorldBookEntryBlock();
      container.appendChild(newBlock);
      newBlock.querySelector('.entry-content-textarea').focus();
    });


    document.getElementById('switch-greeting-btn').addEventListener('click', handleSwitchGreeting);

    document.getElementById('thoughts-history-list').addEventListener('click', (e) => {
      if (e.target && e.target.id === 'load-more-thoughts-btn') {
        loadMoreThoughts();
      }
    });




    document.getElementById('profile-history-icon-btn').addEventListener('click', showThoughtsHistory);

    document.getElementById('history-back-btn').addEventListener('click', hideThoughtsHistory);
    document.getElementById('character-profile-modal').addEventListener('click', (e) => {

      if (e.target.id === 'character-profile-modal') {
        e.target.classList.remove('visible');
      }
    });

    document.getElementById('manage-stickers-btn').addEventListener('click', toggleStickerManagementMode);
    document.getElementById('delete-selected-stickers-btn').addEventListener('click', executeBatchDeleteStickers);
    document.getElementById('export-selected-stickers-btn').addEventListener('click', executeBatchExportStickers);

    document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
    document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));






    const searchInput = document.getElementById('favorites-search-input');
    const searchClearBtn = document.getElementById('favorites-search-clear-btn');

    searchInput.addEventListener('input', () => {
      const searchTerm = searchInput.value.trim().toLowerCase();


      searchClearBtn.style.display = searchTerm ? 'block' : 'none';

      if (!searchTerm) {
        displayFilteredFavorites(allFavoriteItems);
        return;
      }


      const filteredItems = allFavoriteItems.filter(item => {
        let contentToSearch = '';
        let authorToSearch = '';

        if (item.type === 'qzone_post') {
          const post = item.content;
          contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
          if (post.authorId === 'user') {
            authorToSearch = state.qzoneSettings.nickname;
          } else if (state.chats[post.authorId]) {
            authorToSearch = state.chats[post.authorId].name;
          }
        } else if (item.type === 'chat_message') {
          const msg = item.content;
          if (typeof msg.content === 'string') {
            contentToSearch = msg.content;
          }
          const chat = state.chats[item.chatId];
          if (chat) {
            if (msg.role === 'user') {
              authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
            } else {
              authorToSearch = chat.isGroup ? msg.senderName : chat.name;
            }
          }
        }


        return contentToSearch.toLowerCase().includes(searchTerm) ||
          authorToSearch.toLowerCase().includes(searchTerm);
      });

      displayFilteredFavorites(filteredItems);
    });


    searchClearBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchClearBtn.style.display = 'none';
      displayFilteredFavorites(allFavoriteItems);
      searchInput.focus();
    });







    document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
      if (selectedMessages.size === 0) return;
      const chat = state.chats[state.activeChatId];
      if (!chat) return;

      const favoritesToAdd = [];
      const timestampsToFavorite = [...selectedMessages];

      for (const timestamp of timestampsToFavorite) {

        const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();

        if (!existing) {
          const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
          if (messageToSave) {
            favoritesToAdd.push({
              type: 'chat_message',
              content: messageToSave,
              chatId: state.activeChatId,
              timestamp: Date.now(),
              originalTimestamp: messageToSave.timestamp
            });
          }
        }
      }

      if (favoritesToAdd.length > 0) {
        await db.favorites.bulkAdd(favoritesToAdd);
        allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
        await showCustomAlert('Êî∂ËóèÊàêÂäü', `Â∑≤ÊàêÂäüÊî∂Ëóè ${favoritesToAdd.length} Êù°Ê∂àÊÅØ„ÄÇ`);
      } else {
        await showCustomAlert('ÊèêÁ§∫', 'ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÂùáÂ∑≤Êî∂ËóèËøá„ÄÇ');
      }

      exitSelectionMode();
    });


    const favoritesEditBtn = document.getElementById('favorites-edit-btn');
    const favoritesView = document.getElementById('favorites-view');
    const favoritesActionBar = document.getElementById('favorites-action-bar');
    const mainBottomNav = document.getElementById('chat-list-bottom-nav');
    const favoritesList = document.getElementById('favorites-list');

    favoritesEditBtn.addEventListener('click', () => {
      isFavoritesSelectionMode = !isFavoritesSelectionMode;
      favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

      if (isFavoritesSelectionMode) {

        favoritesEditBtn.textContent = 'ÂÆåÊàê';
        favoritesActionBar.style.display = 'block';
        mainBottomNav.style.display = 'none';
        favoritesList.style.paddingBottom = '80px';
      } else {

        favoritesEditBtn.textContent = 'ÁºñËæë';
        favoritesActionBar.style.display = 'none';
        mainBottomNav.style.display = 'flex';
        favoritesList.style.paddingBottom = '';


        selectedFavorites.clear();
        document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
        document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (0)`;
      }
    });



    document.getElementById('favorites-list').addEventListener('click', (e) => {
      const target = e.target;
      const card = target.closest('.favorite-item-card');


      if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", hiddenText.replace(/<br>/g, '\n'));
        return;
      }


      if (!isFavoritesSelectionMode) return;


      if (!card) return;

      const favId = parseInt(card.dataset.favid);
      if (isNaN(favId)) return;


      if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
      } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
      }


      document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (${selectedFavorites.size})`;
    });



    document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
      if (selectedFavorites.size === 0) return;

      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Âà†Èô§',
        `Á°ÆÂÆöË¶Å‰ªéÊî∂ËóèÂ§π‰∏≠ÁßªÈô§Ëøô ${selectedFavorites.size} Êù°ÂÜÖÂÆπÂêóÔºü`, {
          confirmButtonClass: 'btn-danger'
        }
      );

      if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑÊî∂ËóèÂ∑≤Ë¢´ÁßªÈô§„ÄÇ');


        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));


        displayFilteredFavorites(allFavoriteItems);


        favoritesEditBtn.click();
      }
    });


    if (state.globalSettings.enableBackgroundActivity) {
      startBackgroundSimulation();
      console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤Ëá™Âä®ÂêØÂä®„ÄÇ");
    }







    document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
      radio.addEventListener('change', updateSettingsPreview);
    });


    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.addEventListener('input', () => {

      document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;

      updateSettingsPreview();
    });


    const customCssInputForPreview = document.getElementById('custom-css-input');
    customCssInputForPreview.addEventListener('input', updateSettingsPreview);


    document.getElementById('reset-theme-btn').addEventListener('click', () => {
      document.getElementById('theme-default').checked = true;
      updateSettingsPreview();
    });

    document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
      document.getElementById('custom-css-input').value = '';
      updateSettingsPreview();
    });



    document.getElementById('lyrics-vertical-pos').addEventListener('change', updateSettingsPreview);
    document.getElementById('lyrics-horizontal-pos').addEventListener('change', updateSettingsPreview);
    document.getElementById('lyrics-offset-input').addEventListener('input', updateSettingsPreview);

    document.querySelectorAll('input[name="visibility"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
          groupsContainer.style.display = 'block';
        } else {
          groupsContainer.style.display = 'none';
        }
      });
    });



    document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
    document.getElementById('close-group-manager-btn').addEventListener('click', () => {
      document.getElementById('group-management-modal').classList.remove('visible');

      const chatSettingsBtn = document.getElementById('chat-settings-btn');
      if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
        chatSettingsBtn.click();
      }
    });

    document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
    document.getElementById('existing-groups-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
      }
    });




    document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);

    document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);

    document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);


    document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);



    document.getElementById('select-message-btn').addEventListener('click', () => {

      const timestampToSelect = activeMessageTimestamp;
      hideMessageActions();

      if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
      }
    });




    


    document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
    document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
    document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);





    document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
    document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
    document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);




    document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
      showScreen('chat-list-screen');
    });

    document.getElementById('contact-picker-list').addEventListener('click', (e) => {
      const item = e.target.closest('.contact-picker-item');
      if (!item) return;

      const contactId = item.dataset.contactId;
      item.classList.toggle('selected');

      if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
      } else {
        selectedContacts.add(contactId);
      }
      updateContactPickerConfirmButton();
    });


    document.getElementById('manage-members-btn').addEventListener('click', () => {



      openMemberManagementScreen();
    });



    document.getElementById('back-from-member-management').addEventListener('click', () => {

      showScreen('chat-interface-screen');
      document.getElementById('chat-settings-btn').click();
    });


    document.getElementById('member-management-list').addEventListener('click', (e) => {

      if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
      }
    });

    document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {


      const confirmBtn = document.getElementById('confirm-contact-picker-btn');

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      newConfirmBtn.addEventListener('click', handleAddMembersToGroup);

      await openContactPickerForAddMember();
    });

    document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);





    document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
    document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);


    document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);
    document.getElementById('minimize-call-btn').addEventListener('click', minimizeVideoCall);
    document.getElementById('video-call-restore-btn').addEventListener('click', restoreVideoCall);
   
    makeDraggable(document.getElementById('video-call-restore-btn'), document.getElementById('video-call-restore-btn'));

    document.getElementById('cancel-call-btn').addEventListener('click', () => {
      videoCallState.isAwaitingResponse = false;
      showScreen('chat-interface-screen');
    });


    document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);



    document.getElementById('decline-call-btn').addEventListener('click', async () => {
      hideIncomingCallModal();
      const chat = state.chats[videoCallState.activeChatId];
      if (!chat) return;


      if (videoCallState.isGroupCall) {
        videoCallState.isUserParticipating = false;


        const systemNote = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊãíÁªù‰∫ÜÈÄöËØùÈÇÄËØ∑Ôºå‰ΩÜ‰Ω†‰ª¨ÂèØ‰ª•Ëá™Â∑±ÂºÄÂßã„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÊòØÂê¶Âä†ÂÖ•„ÄÇ]`,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);



        await triggerAiResponse();

      } else {
        const declineMessage = {
          role: 'user',
          content: 'ÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ',
          timestamp: Date.now()
        };
        chat.history.push(declineMessage);
        await db.chats.put(chat);


        showScreen('chat-interface-screen');
        appendMessage(declineMessage, chat);


        triggerAiResponse();
      }


      videoCallState.isAwaitingResponse = false;
    });




    document.getElementById('accept-call-btn').addEventListener('click', async () => {
      hideIncomingCallModal();

      videoCallState.initiator = 'ai';
      videoCallState.isUserParticipating = true;
      videoCallState.activeChatId = state.activeChatId;


      if (videoCallState.isGroupCall) {

        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {

          videoCallState.participants = [requester];
        } else {
          videoCallState.participants = [];
        }
      }


      startVideoCall();
    });





    document.getElementById('user-speak-btn').addEventListener('click', async () => {
      if (!videoCallState.isActive) return;


      const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
      if (userAvatar) {
        userAvatar.classList.add('speaking');
      }

      const userInput = await showCustomPrompt('‰Ω†ËØ¥', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...');


      if (userAvatar) {
        userAvatar.classList.remove('speaking');
      }

      if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
      }
    });




    document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {

      if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click();
      }
      switchToChatListView('memories-view');
      renderMemoriesScreen();
    });


    document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));




    document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
      const title = document.getElementById('countdown-title-input').value.trim();
      const dateValue = document.getElementById('countdown-date-input').value;

      if (!title || !dateValue) {
        alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÁ∫¶ÂÆöÊ†áÈ¢òÂíåÊó•ÊúüÔºÅ');
        return;
      }

      const targetDate = new Date(dateValue);
      if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑ„ÄÅÊú™Êù•ÁöÑÊó•ÊúüÔºÅ');
        return;
      }


      const newCountdown = {
        authorId: 'user',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
      };


      await db.memories.add(newCountdown);
      document.getElementById('create-countdown-modal').classList.remove('visible');
      renderMemoriesScreen();
    });


    document.getElementById('block-chat-btn').addEventListener('click', async () => {
      if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

      const chat = state.chats[state.activeChatId];
      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§ÊãâÈªë',
        `Á°ÆÂÆöË¶ÅÊãâÈªë‚Äú${chat.name}‚ÄùÂêóÔºüÊãâÈªëÂêéÊÇ®Â∞ÜÊó†Ê≥ïÂêëÂÖ∂ÂèëÈÄÅÊ∂àÊÅØÔºåÁõ¥Âà∞ÊÇ®Â∞ÜTaÁßªÂá∫ÈªëÂêçÂçïÔºåÊàñÁ≠âÂæÖTaÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ`, {
          confirmButtonClass: 'btn-danger'
        }
      );

      if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();


        const hiddenMessage = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÂàöÂàöË¢´Áî®Êà∑ÊãâÈªë‰∫Ü„ÄÇÂú®ÂØπÊñπËß£Èô§ÊãâÈªë‰πãÂâçÔºå‰Ω†Êó†Ê≥ïÂÜç‰∏ªÂä®ÂèëËµ∑ÂØπËØùÔºå‰πüÊó†Ê≥ïÂõûÂ∫î„ÄÇ]`,
          timestamp: Date.now() + 1,
          isHidden: true
        };
        chat.history.push(hiddenMessage);


        await db.chats.put(chat);


        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);

        renderChatList();
      }
    });

    document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
      const chat = state.chats[state.activeChatId];
      if (!chat) return;

      if (e.target.id === 'force-apply-check-btn') {
        alert("Ê≠£Âú®ÊâãÂä®Ëß¶ÂèëÂ•ΩÂèãÁî≥ËØ∑ÊµÅÁ®ãÔºåËØ∑Á®çÂêé...\nÂ¶ÇÊûúAPIË∞ÉÁî®ÊàêÂäüÔºåÂ∞ÜÂºπÂá∫ÊèêÁ§∫„ÄÇÂ¶ÇÊûúÂ§±Ë¥•Ôºå‰πü‰ºöÊúâÈîôËØØÊèêÁ§∫„ÄÇÂ¶ÇÊûúÈïøÊó∂Èó¥Êó†ÂèçÂ∫îÔºåËØ¥ÊòéAIÂèØËÉΩÂÜ≥ÂÆöÊöÇÊó∂‰∏çÁî≥ËØ∑„ÄÇ");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id);
        return;
      }

      if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;


        const hiddenMessage = {
          role: 'system',
          content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöËß£Èô§‰∫ÜÂØπ‰Ω†ÁöÑÊãâÈªë„ÄÇÁé∞Âú®‰Ω†‰ª¨ÂèØ‰ª•ÈáçÊñ∞ÂºÄÂßãÂØπËØù‰∫Ü„ÄÇ]`,
          timestamp: Date.now(),
          isHidden: true
        };
        chat.history.push(hiddenMessage);


        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        triggerAiResponse();
      } else if (e.target.id === 'accept-friend-btn') {
        // „Äê‰øÆÂ§ç„Äë1. ÂÖàËé∑ÂèñAIÁöÑÁî≥ËØ∑ÁêÜÁî±ÔºåÈò≤Ê≠¢Ë¢´Ê∏ÖÈô§
        const applicationReason = chat.relationship.applicationReason || 'ÔºàÂØπÊñπÊ≤°ÊúâÁïô‰∏ãÁêÜÁî±Ôºå‰ΩÜÊàë‰ª¨ÂíåÂ•Ω‰∫ÜÔºâ'; 

        // 2. Êõ¥Êñ∞Áä∂ÊÄÅ
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = ''; // Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Ê∏ÖÁ©∫‰∫Ü

        // 3. (ÂèØÈÄâ) ‰øùÁïôÁ≥ªÁªüÊ∂àÊÅØ
        const systemMessage = {
          role: 'system',
          type: 'pat_message',
          content: `‰Ω†ÈÄöËøá‰∫Ü‚Äú${chat.name}‚ÄùÁöÑÂ•ΩÂèãËØ∑Ê±Ç`,
          timestamp: Date.now()
        };
        chat.history.push(systemMessage);

        // 4. „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂ∞ÜAIÁöÑ‚ÄúÁî≥ËØ∑ÁêÜÁî±‚Äù‰Ωú‰∏∫ÂÆÉÁöÑÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÊé®ÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
        const applicationMessage = {
          role: 'assistant',
          senderName: chat.name,
          content: applicationReason, // <-- ‰ΩøÁî®AIËá™Â∑±ÁîüÊàêÁöÑÁêÜÁî±
          timestamp: Date.now() + 1
        };
        chat.history.push(applicationMessage);

        // 5. ‰øùÂ≠òÂπ∂Âà∑Êñ∞
        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();

        // 6. (ÂèØÈÄâ) Á´ãÂç≥Ëß¶ÂèëAIÔºåËÆ©ÂÆÉÂØπ‚ÄúË¢´Êé•Âèó‚ÄùËøô‰ª∂‰∫ã‰ΩúÂá∫ÂõûÂ∫î
       
      } else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
      } else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
          'ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑',
          `ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ÂØπ‚Äú${chat.name}‚ÄùËØ¥ÁöÑÁî≥ËØ∑ÁêÜÁî±Ôºö`,
          "Êàë‰ª¨ÂíåÂ•ΩÂêßÔºÅ"
        );

        if (reason !== null) {

          chat.relationship.status = 'pending_ai_approval';
          chat.relationship.applicationReason = reason;
          await db.chats.put(chat);


          renderChatInterface(chat.id);
          renderChatList();


          triggerAiResponse();
        }
      }
    });




    document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);


    document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
      document.getElementById('red-packet-modal').classList.remove('visible');
    });
    document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
    document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);


    const rpTabGroup = document.getElementById('rp-tab-group');
    const rpTabDirect = document.getElementById('rp-tab-direct');
    const rpContentGroup = document.getElementById('rp-content-group');
    const rpContentDirect = document.getElementById('rp-content-direct');

    rpTabGroup.addEventListener('click', () => {
      rpTabGroup.classList.add('active');
      rpTabDirect.classList.remove('active');
      rpContentGroup.style.display = 'block';
      rpContentDirect.style.display = 'none';
    });
    rpTabDirect.addEventListener('click', () => {
      rpTabDirect.classList.add('active');
      rpTabGroup.classList.remove('active');
      rpContentDirect.style.display = 'block';
      rpContentGroup.style.display = 'none';
    });


    document.getElementById('rp-group-amount').addEventListener('input', (e) => {
      const amount = parseFloat(e.target.value) || 0;
      document.getElementById('rp-group-total').textContent = `¬• ${amount.toFixed(2)}`;
    });
    document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
      const amount = parseFloat(e.target.value) || 0;
      document.getElementById('rp-direct-total').textContent = `¬• ${amount.toFixed(2)}`;
    });




    




    document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);


    document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
    document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
      document.getElementById('create-poll-modal').classList.remove('visible');
    });
    document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);


    document.getElementById('chat-messages').addEventListener('click', (e) => {
      const pollCard = e.target.closest('.poll-card');
      if (!pollCard) return;

      const timestamp = parseInt(pollCard.dataset.pollTimestamp);
      if (isNaN(timestamp)) return;


      const optionItem = e.target.closest('.poll-option-item');
      if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
      }


      const actionBtn = e.target.closest('.poll-action-btn');
      if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
          showPollResults(timestamp);
        } else {
          endPoll(timestamp);
        }
        return;
      }


      if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
      }
    });



    document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);


    document.getElementById('add-ai-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('ai'));


    document.getElementById('add-group-avatar-batch-btn').addEventListener('click', () => openBatchImportModal('group'));



    document.getElementById('add-ai-avatar-url-btn').addEventListener('click', addAvatarToLibraryFromURL);


    document.getElementById('add-ai-avatar-upload-btn').addEventListener('click', () => {
      document.getElementById('ai-avatar-upload-input').click();
    });


    document.getElementById('ai-avatar-upload-input').addEventListener('change', handleLocalAvatarUpload);

    document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);


    document.getElementById('manage-group-avatar-library-btn').addEventListener('click', openGroupAvatarLibraryModal);



    document.getElementById('add-group-avatar-url-btn').addEventListener('click', addAvatarToGroupLibraryFromURL);


    document.getElementById('add-group-avatar-upload-btn').addEventListener('click', () => {
      document.getElementById('group-avatar-upload-input').click();
    });


    document.getElementById('group-avatar-upload-input').addEventListener('change', handleLocalGroupAvatarUpload);


    document.getElementById('close-group-avatar-library-btn').addEventListener('click', closeGroupAvatarLibraryModal);



    document.getElementById('icon-settings-grid').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
          handleIconChange(iconId, 'ephone', item);
        }
      }
    });




    document.getElementById('chat-messages').addEventListener('click', (e) => {

      const linkCard = e.target.closest('.link-share-card');
      if (linkCard) {
        const timestamp = parseInt(linkCard.dataset.timestamp);
        if (!isNaN(timestamp)) {
          openBrowser(timestamp);
        }
      }
    });


    document.getElementById('browser-back-btn').addEventListener('click', () => {
      showScreen('chat-interface-screen');
    });



    qzoneStickerPanelState.panelEl.addEventListener('click', async (e) => {
      const stickerItem = e.target.closest('.sticker-item');
      if (stickerItem && qzoneStickerPanelState.activePostId !== null) {

        const stickerUrl = stickerItem.style.backgroundImage.slice(5, -2);


        const stickerObject = state.userStickers.find(s => s.url === stickerUrl);

        if (stickerObject) {

          await sendQzoneStickerComment(qzoneStickerPanelState.activePostId, stickerObject);
        } else {
          console.warn("Âú®Âä®ÊÄÅËØÑËÆ∫Âå∫ÁÇπÂáª‰∫ÜË°®ÊÉÖÔºå‰ΩÜÂú®Ë°®ÊÉÖÂ∫ì‰∏≠Êú™ÊâæÂà∞ÂØπË±°:", stickerUrl);
        }
      }
    });




    document.addEventListener('click', (e) => {
      if (qzoneStickerPanelState.isOpen &&
        !qzoneStickerPanelState.panelEl.contains(e.target) &&
        !e.target.closest('.comment-sticker-btn')) {
        closeQzoneStickerPanel();
      }
    });



    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);


    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
      document.getElementById('share-link-modal').classList.remove('visible');
    });


    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);



    document.getElementById('theme-toggle-switch').addEventListener('change', toggleTheme);
    document.getElementById('detach-status-bar-switch').addEventListener('change', (e) => {
      applyDetachStatusBarMode(e.target.checked);
    });
    document.getElementById('phone-frame-toggle-switch').addEventListener('change', (e) => {
      applyPhoneFrame(e.target.checked);
    });


    document.getElementById('share-location-btn').addEventListener('click', sendLocationShare);





    document.getElementById('chat-list-title').addEventListener('click', renderCallHistoryScreen);


    document.getElementById('call-history-back-btn').addEventListener('click', () => {

      showScreen('chat-list-screen');
    });


    document.getElementById('call-history-list').addEventListener('click', (e) => {
      const card = e.target.closest('.call-record-card');
      if (card && card.dataset.recordId) {
        showCallTranscript(parseInt(card.dataset.recordId));
      }
    });


    document.getElementById('close-call-transcript-btn').addEventListener('click', () => {
      document.getElementById('call-transcript-modal').classList.remove('visible');
    });





    document.getElementById('chat-header-status').addEventListener('click', handleEditStatusClick);


    document.getElementById('selection-share-btn').addEventListener('click', () => {
      if (selectedMessages.size > 0) {
        openShareTargetPicker();
      }
    });
    document.getElementById('selection-screenshot-btn').addEventListener('click', handleLongScreenshot);

    document.getElementById('confirm-share-target-btn').addEventListener('click', async () => {
      const sourceChat = state.chats[state.activeChatId];
      const selectedTargetIds = Array.from(document.querySelectorAll('.share-target-checkbox:checked'))
        .map(cb => cb.dataset.chatId);

      if (selectedTargetIds.length === 0) {
        alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÂàÜ‰∫´ÁöÑËÅäÂ§©„ÄÇ");
        return;
      }


      const sharedHistory = [];
      const sortedTimestamps = [...selectedMessages].sort((a, b) => a - b);
      for (const timestamp of sortedTimestamps) {
        const msg = sourceChat.history.find(m => m.timestamp === timestamp);
        if (msg) {
          sharedHistory.push(msg);
        }
      }


      const shareCardMessage = {
        role: 'user',
        senderName: sourceChat.isGroup ? (sourceChat.settings.myNickname || 'Êàë') : 'Êàë',
        type: 'share_card',
        timestamp: Date.now(),
        payload: {
          sourceChatName: sourceChat.name,
          title: `Êù•Ëá™‚Äú${sourceChat.name}‚ÄùÁöÑËÅäÂ§©ËÆ∞ÂΩï`,
          sharedHistory: sharedHistory
        }
      };


      for (const targetId of selectedTargetIds) {
        const targetChat = state.chats[targetId];
        if (targetChat) {
          targetChat.history.push(shareCardMessage);
          await db.chats.put(targetChat);
        }
      }


      document.getElementById('share-target-modal').classList.remove('visible');
      exitSelectionMode();
      await showCustomAlert("ÂàÜ‰∫´ÊàêÂäü", `ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊàêÂäüÂàÜ‰∫´Âà∞ ${selectedTargetIds.length} ‰∏™‰ºöËØù‰∏≠„ÄÇ`);
      renderChatList();
    });


    document.getElementById('cancel-share-target-btn').addEventListener('click', () => {
      document.getElementById('share-target-modal').classList.remove('visible');
    });


    document.getElementById('chat-messages').addEventListener('click', (e) => {



      const shareCard = e.target.closest('.link-share-card[data-timestamp]');
      if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
        const timestamp = parseInt(shareCard.dataset.timestamp);
        openSharedHistoryViewer(timestamp);
      }
    });


    document.getElementById('close-shared-history-viewer-btn').addEventListener('click', () => {
      document.getElementById('shared-history-viewer-modal').classList.remove('visible');
    });


    async function openSharedHistoryViewer(timestamp) {
      const chat = state.chats[state.activeChatId];
      if (!chat) return;

      const message = chat.history.find(m => m.timestamp === timestamp);

   

      if (!message) {
        console.error("Êó†Ê≥ïÊâæÂà∞ÂàÜ‰∫´ËÆ∞ÂΩï:", timestamp);
        await showCustomAlert("Êü•ÁúãÂ§±Ë¥•", "Êó†Ê≥ïÊâæÂà∞ÂØπÂ∫îÁöÑÂàÜ‰∫´ËÆ∞ÂΩïÊàñËÆ∞ÂΩïÂ∑≤ÊçüÂùè„ÄÇ");
        return;
      }

   
      if (message.type === 'share_link') {
        openBrowser(timestamp);
        return; 
      }

    
      if (message.type === 'share_card') {
        if (!message.payload || !message.payload.sharedHistory) {
          console.error("ËÅäÂ§©ËÆ∞ÂΩïÂàÜ‰∫´Âç°ÁâáÊï∞ÊçÆÊçüÂùè:", message);
          await showCustomAlert("Êü•ÁúãÂ§±Ë¥•", "ÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩïÂ∑≤ÊçüÂùè„ÄÇ");
          return;
        }
      
      } else {
      
        console.error("Êú™Áü•ÁöÑÂàÜ‰∫´Âç°ÁâáÁ±ªÂûã:", message.type);
        await showCustomAlert("Êü•ÁúãÂ§±Ë¥•", "‰∏çÊîØÊåÅÁöÑÂàÜ‰∫´Á±ªÂûã„ÄÇ");
        return;
      }

      const viewerModal = document.getElementById('shared-history-viewer-modal');
      const viewerTitle = document.getElementById('shared-history-viewer-title');
      const viewerContent = document.getElementById('shared-history-viewer-content');

      viewerTitle.textContent = message.payload.title;
      viewerContent.innerHTML = '';

      const fragment = document.createDocumentFragment();
      const sourceChat = Object.values(state.chats).find(c => c.name === message.payload.sourceChatName) || chat;

      for (const sharedMsg of message.payload.sharedHistory) {
        const bubbleEl = await createMessageElement(sharedMsg, sourceChat);
        if (bubbleEl) {
          fragment.appendChild(bubbleEl);
        }
      }

      viewerContent.appendChild(fragment);
      viewerModal.classList.add('visible');
    }

    audioPlayer.addEventListener('timeupdate', updateMusicProgressBar);

    audioPlayer.addEventListener('pause', () => {
      if (musicState.isActive) {
        musicState.isPlaying = false;
        phoneScreenForIsland.classList.remove('dynamic-island-active');
        // --- Êñ∞Â¢ûÔºöÊöÇÂÅúÊó∂ÂÅúÊ≠¢ÊóãËΩ¨ ---
        document.getElementById('vinyl-view').classList.remove('spinning'); 
        updatePlayerUI();
      }
    });
    
    audioPlayer.addEventListener('play', () => {
      if (musicState.isActive) {
        musicState.isPlaying = true;
        // --- Êñ∞Â¢ûÔºöÊí≠ÊîæÊó∂ÂºÄÂßãÊóãËΩ¨ ---
        document.getElementById('vinyl-view').classList.add('spinning');
        updatePlayerUI();
      }
    });



    document.getElementById('playlist-body').addEventListener('click', async (e) => {
      const target = e.target;


      const albumArtBtn = target.closest('.album-art-btn');
      if (albumArtBtn) {
        const index = parseInt(albumArtBtn.dataset.index);
        if (!isNaN(index)) {

          await handleChangeAlbumArt(index);
        }
        return;
      }

      const lyricsBtn = target.closest('.lyrics-btn');
      if (lyricsBtn) {
        const index = parseInt(lyricsBtn.dataset.index);
        if (isNaN(index)) return;



        await handleManualLrcImport(index);

        return;
      }


      const deleteBtn = target.closest('.delete-track-btn');
      if (deleteBtn) {
        const index = parseInt(deleteBtn.dataset.index);
        if (isNaN(index)) return;
        const track = musicState.playlist[index];
        const confirmed = await showCustomConfirm('Âà†Èô§Ê≠åÊõ≤', `Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§„Ää${track.name}„ÄãÂêóÔºü`);
        if (confirmed) {
          deleteTrack(index);
        }
        return;
      }


      const itemInfo = target.closest('.playlist-item-info');
      if (itemInfo) {
        const item = itemInfo.closest('.playlist-item');
        const index = Array.from(item.parentElement.children).indexOf(item);
        if (index > -1) {
          playSong(index);
        }
      }
    });


    document.querySelector('.progress-bar').addEventListener('click', (e) => {
      if (!audioPlayer.duration) return;
      const progressBar = e.currentTarget;
      const barWidth = progressBar.clientWidth;
      const clickX = e.offsetX;
      audioPlayer.currentTime = (clickX / barWidth) * audioPlayer.duration;
    });




    document.getElementById('chat-messages').addEventListener('click', (e) => {

     // „ÄêÊñ∞Â¢û/‰øÆÊîπ„ÄëÁÇπÂáªÈÇÆ‰ª∂Âç°ÁâáÊü•ÁúãËØ¶ÊÉÖ (Âõ∫ÂÆöÂ§ßÂ∞èÂºπÁ™óÁâà)
      const emailCard = e.target.closest('.email-share-card');
      if (emailCard) {
          const jsonStr = decodeURIComponent(emailCard.dataset.emailJson);
          try {
              const data = JSON.parse(jsonStr);
              
              // 1. Ëé∑ÂèñÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂÖÉÁ¥†
              const overlay = document.getElementById('custom-modal-overlay');
              const modal = document.getElementById('custom-modal');
              const titleEl = document.getElementById('custom-modal-title');
              const bodyEl = document.getElementById('custom-modal-body');
              const footerEl = document.querySelector('#custom-modal .custom-modal-footer');

              // 2. „ÄêÊ†∏ÂøÉÊ≠•È™§„Äë‰∏¥Êó∂‰øÆÊîπÊ®°ÊÄÅÊ°ÜÊ†∑Âºè (Âõ∫ÂÆöÂÆΩÈ´ò)
              modal.style.width = '320px';        // ÂÆΩÂ∫¶Âä†ÂÆΩ
              modal.style.height = '500px';       // È´òÂ∫¶Âõ∫ÂÆö
              modal.style.maxHeight = '80vh';     // Èò≤Ê≠¢Ë∂ÖÂá∫Â±èÂπï
              
              // 3. Ë∞ÉÊï¥ Body Ê†∑Âºè‰ª•ÊîØÊåÅÂÜÖÈÉ®ÊªöÂä®
              bodyEl.style.flex = '1';            // ÊíëÊª°Ââ©‰ΩôÁ©∫Èó¥
              bodyEl.style.overflowY = 'auto';    // ÂÖÅËÆ∏ÂûÇÁõ¥ÊªöÂä®
              bodyEl.style.padding = '0';         // Ê∏ÖÈô§ÈªòËÆ§ÂÜÖËæπË∑ùÔºåÁî±ÂÜÖÈÉ®ÂÆπÂô®ÊéßÂà∂

              // 4. ËÆæÁΩÆÊ†áÈ¢ò
              titleEl.textContent = "ÈÇÆ‰ª∂ËØ¶ÊÉÖ";
              
              // 5. ÊûÑÈÄ†ËØ¶ÊÉÖ HTML (‰ºòÂåñÂ∏ÉÂ±Ä)
              const detailHtml = `
                  <div style="padding: 20px; min-height: 100%; box-sizing: border-box; text-align: left;"> <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                          <div style="font-weight: 700; font-size: 18px; color: #111; line-height: 1.4; margin-bottom: 8px; word-break: break-word;">
                              ${escapeHTML(data.subject)}
                          </div>
                          <div style="display: flex; justify-content: space-between; align-items: center; color: #8a8a8a; font-size: 13px;">
                              <span><span style="color:#666;">Âèë‰ª∂‰∫∫:</span> ${escapeHTML(data.sender)}</span>
                              <span>${data.date.split(' ')[0]}</span>
                          </div>
                      </div>
                      <div style="white-space: pre-wrap; color: #333; font-size: 15px; line-height: 1.8; font-family: -apple-system, sans-serif; letter-spacing: 0.5px;">${escapeHTML(data.fullContent)}</div>
                  </div>
              `;
              bodyEl.innerHTML = detailHtml;

              // 6. ÈáçÂÜôÂ∫ïÈÉ®ÊåâÈíÆ (‰ªÖÊòæÁ§∫‰∏Ä‰∏™ÂÖ≥Èó≠ÊåâÈíÆ)
              footerEl.innerHTML = ''; // Ê∏ÖÁ©∫ÂéüÊúâÊåâÈíÆ
              const closeBtn = document.createElement('button');
              closeBtn.textContent = 'ÂÖ≥Èó≠';
              closeBtn.style.cssText = 'width: 100%; border: none; background: transparent; color: var(--accent-color); font-weight: 600; padding: 15px; font-size: 16px; cursor: pointer;';
              
              // 7. ÁªëÂÆöÂÖ≥Èó≠‰∫ã‰ª∂ (ÂÖ≥ÈîÆÔºöÂÖ≥Èó≠Êó∂ÂøÖÈ°ªËøòÂéüÊ†∑ÂºèÔºÅ)
              closeBtn.onclick = () => {
                  overlay.classList.remove('visible');
                  
                  // Âª∂ËøüËøòÂéüÊ†∑ÂºèÔºåÈò≤Ê≠¢ËßÜËßâË∑≥Âä®
                  setTimeout(() => {
                      modal.style.width = '';       // ËøòÂéüÂÆΩÂ∫¶
                      modal.style.height = '';      // ËøòÂéüÈ´òÂ∫¶
                      modal.style.maxHeight = '';
                      bodyEl.style.flex = '';
                      bodyEl.style.overflowY = '';
                      bodyEl.style.padding = '';
                  }, 300);
              };
              footerEl.appendChild(closeBtn);

              // 8. ÊòæÁ§∫ÂºπÁ™ó
              overlay.classList.add('visible');

          } catch(err) {
              console.error("Ëß£ÊûêÈÇÆ‰ª∂Êï∞ÊçÆÂ§±Ë¥•", err);
          }
          return; // ÈòªÊ≠¢ÂêéÁª≠ÈÄªËæë
      }
      const redditCard = e.target.closest('.reddit-share-card');
    if (redditCard) {
        const bubble = redditCard.closest('.message-bubble');
        if (bubble) {
            const timestamp = parseInt(bubble.dataset.timestamp);
            const chat = state.chats[state.activeChatId];
            // Âú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ËøôÊù°Ê∂àÊÅØ
            const msg = chat.history.find(m => m.timestamp === timestamp);
            
            if (msg && msg.type === 'reddit_share' && msg.redditData) {
                // Ë∞ÉÁî®‰Ω†ÂÜôÂ•ΩÁöÑËØ¶ÊÉÖÈ°µÂáΩÊï∞
                openRedditDetail(msg.redditData);
            }
        }
        return; 
    }
      const placeholder = e.target.closest('.recalled-message-placeholder');
      if (placeholder) {
        const chat = state.chats[state.activeChatId];
        const wrapper = placeholder.closest('.message-wrapper');
        if (chat && wrapper) {
          const timestamp = parseInt(wrapper.dataset.timestamp);
          const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

          if (recalledMsg && recalledMsg.recalledData) {
            let originalContentText = '';
            const recalled = recalledMsg.recalledData;


            switch (recalled.originalType) {
              case 'text':
                originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
                break;
              case 'user_photo':
              case 'ai_image':
              case 'text_image':
                originalContentText = `[ÂõæÁâá/ÊñáÂ≠óÂõæ] ÊèèËø∞: "${recalled.originalContent}"`;
                break;
              case 'voice_message':
                originalContentText = `[ËØ≠Èü≥] ÂÜÖÂÆπ: "${recalled.originalContent}"`;
                break;
              case 'sticker':

                originalContentText = `[Ë°®ÊÉÖ] Âê´‰πâ: "${recalled.originalMeaning || '(Êó†)'}" \n URL: ${recalled.originalContent}`;
                break;
              case 'transfer':
                originalContentText = `‰∏ÄÊù°[ËΩ¨Ë¥¶]Ê∂àÊÅØÂ∑≤Ë¢´Êí§Âõû„ÄÇ`;
                break;
              default:

                originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ„ÄÇ\nÂÜÖÂÆπ: ${JSON.stringify(recalled.originalContent)}`;
                break;
            }


            showCustomAlert('Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ', originalContentText);
          }
        }
      }
    });




    document.getElementById('manage-world-book-categories-btn').addEventListener('click', openCategoryManager);
    document.getElementById('close-category-manager-btn').addEventListener('click', () => {
      document.getElementById('world-book-category-manager-modal').classList.remove('visible');
      renderWorldBookScreen();
    });
    document.getElementById('add-new-category-btn').addEventListener('click', addNewCategory);
    document.getElementById('existing-categories-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteCategory(categoryId);
      }
    });

    document.getElementById('repost-cancel-btn').addEventListener('click', hideRepostModal);
    document.getElementById('repost-confirm-btn').addEventListener('click', handleConfirmRepost);





    document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);


    document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);










    document.getElementById('qzone-posts-list').addEventListener('input', (e) => {
      if (!e.target.matches('.comment-input')) return;

      const commentInput = e.target;
      const postContainer = commentInput.closest('.qzone-post-container');
      if (!postContainer) return;

      const popup = postContainer.querySelector('.at-mention-popup');
      const value = commentInput.value;
      const atMatch = value.match(/@([\p{L}\w]*)$/u);

      if (atMatch) {
        const namesToMention = new Set();
        const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
        if (authorNickname) namesToMention.add(authorNickname);
        postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
          namesToMention.add(nameEl.textContent.replace(':', ''));
        });
        namesToMention.delete(state.qzoneSettings.nickname);

        popup.innerHTML = '';
        if (namesToMention.size > 0) {
          const searchTerm = atMatch[1];
          namesToMention.forEach(name => {
            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
              const item = document.createElement('div');
              item.className = 'at-mention-item';
              item.textContent = name;
              item.addEventListener('mousedown', (evt) => {
                evt.preventDefault();
                const newText = value.substring(0, atMatch.index) + `@${name} `;
                commentInput.value = newText;
                popup.style.display = 'none';
                commentInput.focus();
              });
              popup.appendChild(item);
            }
          });
          popup.style.display = popup.children.length > 0 ? 'block' : 'none';
        } else {
          popup.style.display = 'none';
        }
      } else {
        popup.style.display = 'none';
      }
    });

    document.getElementById('qzone-posts-list').addEventListener('focusout', (e) => {
      if (e.target.matches('.comment-input')) {
        const postContainer = e.target.closest('.qzone-post-container');
        if (postContainer) {
          const popup = postContainer.querySelector('.at-mention-popup');
          if (popup) {
            setTimeout(() => {
              popup.style.display = 'none';
            }, 200);
          }
        }
      }
    });





    const chatInputForMention = document.getElementById('chat-input');
    const chatMentionPopup = document.getElementById('chat-at-mention-popup');

    chatInputForMention.addEventListener('input', () => {

      if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) {
        chatMentionPopup.style.display = 'none';
        return;
      }

      const chat = state.chats[state.activeChatId];
      const value = chatInputForMention.value;
      const atMatch = value.match(/@([\p{L}\w]*)$/u);

      if (atMatch) {

        const myNickname = chat.settings.myNickname || 'Êàë';
        const namesToMention = chat.members
          .map(member => member.groupNickname)
          .filter(name => name !== myNickname);

        chatMentionPopup.innerHTML = '';
        if (namesToMention.length > 0) {
          const searchTerm = atMatch[1];

          namesToMention.forEach(name => {
            if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
              const item = document.createElement('div');
              item.className = 'at-mention-item';
              item.textContent = name;

              item.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const newText = value.substring(0, atMatch.index) + `@${name} `;
                chatInputForMention.value = newText;
                chatMentionPopup.style.display = 'none';
                chatInputForMention.focus();
              });
              chatMentionPopup.appendChild(item);
            }
          });

          chatMentionPopup.style.display = chatMentionPopup.children.length > 0 ? 'block' : 'none';
        } else {
          chatMentionPopup.style.display = 'none';
        }
      } else {
        chatMentionPopup.style.display = 'none';
      }
    });


    chatInputForMention.addEventListener('blur', () => {
      setTimeout(() => {
        chatMentionPopup.style.display = 'none';
      }, 200);
    });


    document.getElementById('publish-to-announcement-btn').addEventListener('click', publishToAnnouncementBoard);
    document.getElementById('show-announcement-board-btn').addEventListener('click', showAnnouncementBoard);
    document.getElementById('close-announcement-board-btn').addEventListener('click', () => {
      document.getElementById('announcement-board-modal').classList.remove('visible');
    });


    document.getElementById('announcement-board-content').addEventListener('click', (e) => {
      if (e.target.classList.contains('announcement-item-actions')) {
        const annoId = e.target.dataset.annoId;
        if (annoId) {
          showAnnouncementActions(annoId);
        }
      }
    });

    document.getElementById('announcement-action-pin').addEventListener('click', handlePinAnnouncement);
    document.getElementById('announcement-action-delete').addEventListener('click', handleDeleteAnnouncement);
    document.getElementById('announcement-action-cancel').addEventListener('click', () => {
      document.getElementById('announcement-actions-modal').classList.remove('visible');
    });


    document.getElementById('reset-global-css-btn').addEventListener('click', () => {
      document.getElementById('global-css-input').value = '';


    });


    document.getElementById('open-memory-screen-btn').addEventListener('click', openLongTermMemoryScreen);


    document.getElementById('memory-screen-back-btn').addEventListener('click', () => {
      showScreen('chat-interface-screen');
    });


    document.getElementById('add-manual-memory-btn-header').addEventListener('click', handleAddManualMemory);


    document.getElementById('summarize-recent-btn-header').addEventListener('click', handleManualSummary);


    document.getElementById('memory-list-container').addEventListener('click', (e) => {
      const editBtn = e.target.closest('.edit-memory-btn');
      if (editBtn) {
        handleEditMemory(editBtn.dataset.authorId, parseInt(editBtn.dataset.memoryTimestamp));
        return;
      }
      const deleteBtn = e.target.closest('.delete-memory-btn');
      if (deleteBtn) {
        handleDeleteMemory(deleteBtn.dataset.authorId, parseInt(deleteBtn.dataset.memoryTimestamp));
        return;
      }
    });


    document.getElementById('gomoku-btn').addEventListener('click', toggleGomokuBoard);
    document.getElementById('close-gomoku-btn').addEventListener('click', closeGomokuBoard);

    const gomokuCanvas = document.getElementById('gomoku-board');
    gomokuCanvas.addEventListener('mousemove', handleBoardHover);
    gomokuCanvas.addEventListener('mouseout', () => renderGomokuBoard(state.activeChatId));
    gomokuCanvas.addEventListener('click', handleBoardClick);


    document.getElementById('add-countdown-btn').addEventListener('click', () => {

      document.getElementById('countdown-title-input').value = '';
      document.getElementById('countdown-date-input').value = '';

      document.getElementById('create-countdown-modal').classList.add('visible');
    });


    document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
      document.getElementById('create-countdown-modal').classList.remove('visible');
    });



    document.getElementById('edit-call-message-btn').addEventListener('click', openCallMessageEditor);
    document.getElementById('delete-call-message-btn').addEventListener('click', deleteCallMessage);
    document.getElementById('cancel-call-message-action-btn').addEventListener('click', hideCallMessageActions);


    document.getElementById('edit-last-response-btn').addEventListener('click', openAiResponseEditor);
    document.getElementById('cancel-ai-response-editor-btn').addEventListener('click', () => {
      document.getElementById('ai-response-editor-modal').classList.remove('visible');
    });
    document.getElementById('save-ai-response-editor-btn').addEventListener('click', saveEditedAiResponse);
    document.getElementById('add-ai-response-block-btn').addEventListener('click', () => {

      const container = document.getElementById('ai-response-editor-container');
      const newBlock = createAiResponseEditorBlock('{\n  "type": "text",\n  "content": "Âú®ËøôÈáåËæìÂÖ•Êñ∞Ê∂àÊÅØ..."\n}');
      container.appendChild(newBlock);
      newBlock.querySelector('textarea').focus();
    });


    document.getElementById('manage-my-avatar-library-btn').addEventListener('click', openMyAvatarLibraryModal);
    document.getElementById('close-my-avatar-library-btn').addEventListener('click', closeMyAvatarLibraryModal);
    document.getElementById('add-my-avatar-url-btn').addEventListener('click', addAvatarToMyLibraryFromURL);
    document.getElementById('add-my-avatar-upload-btn').addEventListener('click', () => {
      document.getElementById('my-avatar-upload-input').click();
    });
    document.getElementById('my-avatar-upload-input').addEventListener('change', handleLocalMyAvatarUpload);
    document.getElementById('add-my-avatar-batch-btn').addEventListener('click', async () => {
      const placeholderText = `ËØ∑ÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÁ≤òË¥¥Ôºå‰∏ÄË°å‰∏Ä‰∏™Ôºö\n\nÁÑ¶Ëôë 2a9wte.jpeg\nÂ§ßÊÉäÂ§±Ëâ≤ or8qf4.png\nÊ≤°ÊúâÁÅµÊÑü njwujh.jpeg`;
      const pastedText = await showCustomPrompt('ÊâπÈáèÂØºÂÖ•Â§¥ÂÉè', placeholderText, '', 'textarea');
      if (pastedText && pastedText.trim()) {
        await handleBatchImportForMyAvatar(pastedText);
      }
    });


    document.getElementById('open-shopping-btn').addEventListener('click', openShoppingScreen);
    document.getElementById('shopping-back-btn').addEventListener('click', () => showScreen('chat-interface-screen'));
    document.getElementById('go-to-cart-btn').addEventListener('click', openCartScreen);
    document.getElementById('cart-back-btn').addEventListener('click', openShoppingScreen);
    document.getElementById('checkout-btn').addEventListener('click', handleCheckout);
    document.getElementById('close-receipt-btn').addEventListener('click', () => {
      document.getElementById('gift-receipt-modal').classList.remove('visible');
    });


    document.getElementById('manage-products-btn').addEventListener('click', () => {
      isProductManagementMode = !isProductManagementMode;
      const btn = document.getElementById('manage-products-btn');
      const actionBar = document.getElementById('shopping-action-bar');
      const gridEl = document.getElementById('product-grid');

      btn.style.color = isProductManagementMode ? 'var(--accent-color)' : 'var(--text-primary)';

      if (isProductManagementMode) {
        actionBar.style.display = 'flex';
        gridEl.style.paddingBottom = '80px';
      } else {
        actionBar.style.display = 'none';
        gridEl.style.paddingBottom = '';

        selectedProducts.clear();
        document.querySelectorAll('.product-item.selected').forEach(item => item.classList.remove('selected'));
        document.getElementById('delete-selected-products-btn').textContent = `Âà†Èô§ (0)`;
        document.getElementById('select-all-products-checkbox').checked = false;
      }


      renderShoppingProducts();
      updateDeleteCategoryButtonVisibility();
    });


    document.getElementById('add-new-product-btn').addEventListener('click', () => {
      if (isProductManagementMode) {
        openProductEditor(null);
      } else {
        alert("ËØ∑ÂÖàÁÇπÂáªÊâ≥ÊâãÂõæÊ†áËøõÂÖ•ÁÆ°ÁêÜÊ®°ÂºèÔºåÊâçËÉΩÊ∑ªÂä†Êñ∞ÂïÜÂìÅ„ÄÇ");
      }
    });



    document.getElementById('product-grid').addEventListener('click', async e => {
      const productItem = e.target.closest('.product-item');
      if (!productItem) return;
      const productId = parseInt(productItem.dataset.id);
      if (isNaN(productId)) return;


      if (isProductManagementMode) {

        if (e.target.classList.contains('edit-product-btn')) {
          openProductEditor(productId);
          return;
        }

        if (e.target.classList.contains('delete-product-btn')) {
          const product = await db.shoppingProducts.get(productId);
          if (!product) return;
          const confirmed = await showCustomConfirm('Âà†Èô§ÂïÜÂìÅ', `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÂïÜÂìÅ ‚Äú${product.name}‚Äù ÂêóÔºü`, {
            confirmButtonClass: 'btn-danger'
          });
          if (confirmed) {
            await db.shoppingProducts.delete(productId);
            await renderShoppingProducts();
            alert("ÂïÜÂìÅÂ∑≤Âà†Èô§„ÄÇ");
          }
          return;
        }


        productItem.classList.toggle('selected');
        if (selectedProducts.has(productId)) {
          selectedProducts.delete(productId);
        } else {
          selectedProducts.add(productId);
        }
        document.getElementById('delete-selected-products-btn').textContent = `Âà†Èô§ (${selectedProducts.size})`;
        return;
      }


      if (e.target.classList.contains('add-to-cart-btn')) {
        const product = await db.shoppingProducts.get(productId);
        if (product.variations && product.variations.length > 0) {
          openVariationSelector(productId);
        } else {
          await addToCart(productId);
          await showCustomAlert('ÊàêÂäü', 'Â∑≤ÊàêÂäüÂä†ÂÖ•Ë¥≠Áâ©ËΩ¶ÔºÅ');
        }
        return;
      }


      if (productItem.contains(e.target)) {
        console.log(`ÁÇπÂáª‰∫ÜÂïÜÂìÅÂç°Áâá: ${productId}`);
      }
    });



    document.getElementById('cart-items-list').addEventListener('click', e => {
      const target = e.target;
      if (target.classList.contains('decrease-qty-btn')) {
        updateCartItemQuantity(parseInt(target.dataset.id), -1);
      }
      if (target.classList.contains('increase-qty-btn')) {
        updateCartItemQuantity(parseInt(target.dataset.id), 1);
      }
      if (target.classList.contains('cart-item-checkbox')) {
        updateCartTotal();
      }
    });


    document.getElementById('clear-cart-btn').addEventListener('click', async () => {
      if (shoppingCart.length === 0) return;
      const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶', 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶‰∏≠ÁöÑÊâÄÊúâÂïÜÂìÅÂêóÔºü');
      if (confirmed) {
        shoppingCart = [];
        updateCartCount();
        renderCartItems();
      }
    });


    document.getElementById('select-all-cart-items').addEventListener('change', function(e) {
      document.querySelectorAll('.cart-item-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
      });
      updateCartTotal();
    });


    document.getElementById('cancel-product-editor-btn').addEventListener('click', () => {
      document.getElementById('product-editor-modal').classList.remove('visible');
    });
    document.getElementById('save-product-btn').addEventListener('click', saveProduct);
    document.getElementById('product-image-input').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (re) => {
          document.getElementById('product-image-preview').src = re.target.result;
        };
        reader.readAsDataURL(file);
      }
    });


    document.getElementById('chat-messages').addEventListener('click', e => {
      const giftCard = e.target.closest('.gift-card');
      if (giftCard) {
        const bubble = giftCard.closest('.message-bubble');
        if (bubble) {
          showGiftReceipt(parseInt(bubble.dataset.timestamp));
        }
      }
    });


    document.getElementById('cancel-gift-recipient-btn').addEventListener('click', () => {
      document.getElementById('gift-recipient-modal').classList.remove('visible');
    });


    document.getElementById('confirm-gift-recipient-btn').addEventListener('click', async () => {

      const selectedRecipients = Array.from(document.querySelectorAll('#gift-recipient-list .contact-picker-item.selected'))
        .map(item => item.dataset.recipientName);

      if (selectedRecipients.length === 0) {
        alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰ΩçÊî∂Á§º‰∫∫„ÄÇ");
        return;
      }


      const selectedItems = shoppingCart.filter(item =>
        document.querySelector(`.cart-item-checkbox[data-id="${item.productId}"]:checked`)
      );


      await sendGiftMessage(selectedItems, selectedRecipients);


      document.getElementById('gift-recipient-modal').classList.remove('visible');
    });


    document.getElementById('gift-recipient-list').addEventListener('click', (e) => {
      const item = e.target.closest('.contact-picker-item');
      if (item) {
        item.classList.toggle('selected');
      }
    });

    document.getElementById('select-all-recipients').addEventListener('change', function(e) {
      const isChecked = e.target.checked;
      document.querySelectorAll('#gift-recipient-list .contact-picker-item').forEach(item => {
        item.classList.toggle('selected', isChecked);
      });
    });


    document.getElementById('regenerate-btn').addEventListener('click', handleRegenerateResponse);
    document.getElementById('regenerate-call-btn').addEventListener('click', handleRegenerateCallResponse);


    document.getElementById('propel-btn').addEventListener('click', handlePropelAction);






    document.getElementById('test-sound-btn').addEventListener('click', () => {
      const player = document.getElementById('notification-sound-player');
      const url = document.getElementById('notification-sound-url-input').value.trim() || DEFAULT_NOTIFICATION_SOUND;
      player.src = url;
      player.play().catch(e => alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶Ê≠£Á°ÆÊàñÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËØ•Ê†ºÂºè„ÄÇ'));
    });

    document.getElementById('reset-sound-btn').addEventListener('click', () => {
      document.getElementById('notification-sound-url-input').value = '';
      alert('Â∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÊèêÁ§∫Èü≥ÔºåÁÇπÂáª‚Äú‰øùÂ≠òÊâÄÊúâÂ§ñËßÇËÆæÁΩÆ‚ÄùÂêéÁîüÊïà„ÄÇ');
    });

    document.getElementById('home-screen').addEventListener('click', (e) => {
      const target = e.target;

      if (target.classList.contains('editable-text')) {
        handleEditText(target);
      }

      if (target.classList.contains('editable-image')) {
        handleEditImage(target);
      }
    });

    document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

    document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
      document.getElementById('music-search-results-modal').classList.remove('visible');
    });


    document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);

    document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
      document.getElementById('music-search-results-modal').classList.remove('visible');
    });


    document.getElementById('select-all-music-search').addEventListener('change', function(e) {
      document.querySelectorAll('#search-results-list .music-search-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
      });
    });


    document.getElementById('search-results-list').addEventListener('click', (e) => {
      const item = e.target.closest('.search-result-item');
      if (item) {
        const checkbox = item.querySelector('.music-search-checkbox');
        if (checkbox) {

          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
          }
        }
      }
    });


    document.getElementById('add-selected-music-btn').addEventListener('click', async () => {
      const selectedItems = document.querySelectorAll('.music-search-checkbox:checked');
      if (selectedItems.length === 0) {
        alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊ∑ªÂä†ÁöÑÊ≠åÊõ≤„ÄÇ");
        return;
      }

      document.getElementById('music-search-results-modal').classList.remove('visible');
      await showCustomAlert("ËØ∑Á®çÂÄô...", `Ê≠£Âú®ÊâπÈáèÊ∑ªÂä† ${selectedItems.length} È¶ñÊ≠åÊõ≤...`);

      const songDataList = Array.from(selectedItems).map(cb => JSON.parse(cb.closest('.search-result-item').dataset.songJson));

      let successCount = 0;
      let failedNames = [];


      const songDetailPromises = songDataList.map(songData => getPlayableSongDetails(songData));
      const fullSongObjects = await Promise.all(songDetailPromises);

      fullSongObjects.forEach((songObject, index) => {
        if (songObject) {
          musicState.playlist.push(songObject);
          successCount++;
        } else {
          failedNames.push(songDataList[index].name);
        }
      });

      if (successCount > 0) {
        await saveGlobalPlaylist();
        updatePlaylistUI();
        if (musicState.currentIndex === -1) {
          musicState.currentIndex = musicState.playlist.length - successCount;
          updatePlayerUI();
        }
      }

      let resultMessage = `Ê∑ªÂä†ÂÆåÊàêÔºÅ\n\nÊàêÂäüÊ∑ªÂä† ${successCount} È¶ñÊ≠åÊõ≤„ÄÇ`;
      if (failedNames.length > 0) {
        resultMessage += `\n\n${failedNames.length} È¶ñÊ≠åÊõ≤Ëé∑ÂèñÂ§±Ë¥•:\n- ${failedNames.join('\n- ')}`;
      }
      await showCustomAlert("Êìç‰ΩúÁªìÊûú", resultMessage);
    });



    document.getElementById('music-visual-container').addEventListener('click', () => {
      document.getElementById('music-visual-container').classList.toggle('lyrics-active');
    });



    document.getElementById('add-song-search-btn').addEventListener('click', addSongFromSearch);
    document.getElementById('cancel-music-search-btn').addEventListener('click', () => {
      document.getElementById('music-search-results-modal').classList.remove('visible');
    });

    document.getElementById('search-results-list').addEventListener('click', (e) => {
      const item = e.target.closest('.search-result-item');
      if (item && item.dataset.songJson) {
        const songData = JSON.parse(item.dataset.songJson);
        handleSearchResultClick(songData);
      }
    });



    document.getElementById('cleanup-songs-btn').addEventListener('click', cleanupInvalidSongs);
    document.getElementById('toggle-blur-btn').addEventListener('click', toggleBackgroundBlur);
    document.getElementById('toggle-fullscreen-btn').addEventListener('click', togglePlayerFullscreen);
    document.getElementById('show-avatars-btn').addEventListener('click', toggleMusicPlayerAvatars);


    document.getElementById('status-bar-toggle-switch').addEventListener('change', () => {

      state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
      applyStatusBarVisibility();
    });


    document.getElementById('qzone-more-actions-btn').addEventListener('click', openClearPostsSelectorModal);


    document.getElementById('cancel-clear-posts-btn').addEventListener('click', () => {
      document.getElementById('clear-posts-modal').classList.remove('visible');
    });
    document.getElementById('confirm-clear-posts-btn').addEventListener('click', handleConfirmClearPosts);


    document.getElementById('clear-posts-list').addEventListener('click', (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {
        item.classList.toggle('selected');
      }
    });

    document.getElementById('global-bg-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        // 1. Á´ãÂç≥‰øùÂ≠òÂíåÊòæÁ§∫
        state.globalSettings.globalChatBackground = dataUrl;
        renderWallpaperScreen();
        await showCustomAlert("ÊàêÂäü", "ÂÖ®Â±ÄËÅäÂ§©ËÉåÊôØÂ∑≤Êõ¥Êñ∞ÔºÅ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä... (‰øùÂ≠òËÆæÁΩÆÂêéÁîüÊïà)");

        // 2. ÂêØÂä®ÈùôÈªò‰∏ä‰º†
        (async () => {
            await silentlyUpdateDbUrl(
                db.globalSettings,
                'main',
                'globalChatBackground',
                dataUrl
            );
        })();
      }
      event.target.value = null;
    });

    document.getElementById('remove-global-bg-btn').addEventListener('click', () => {

      state.globalSettings.globalChatBackground = '';
      renderWallpaperScreen();
    });


    document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {

      if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
      }



      state.globalSettings.globalCss = document.getElementById('global-css-input').value.trim();
      state.globalSettings.notificationSoundUrl = document.getElementById('notification-sound-url-input').value.trim();
      state.globalSettings.showStatusBar = document.getElementById('status-bar-toggle-switch').checked;
      state.globalSettings.lockScreenEnabled = document.getElementById('lock-screen-toggle').checked;
      state.globalSettings.lockScreenPassword = document.getElementById('lock-screen-password-input').value.trim();
      
      const lockPreview = document.getElementById('lock-wallpaper-preview');
      if (lockPreview.dataset.tempUrl) {
          state.globalSettings.lockScreenWallpaper = lockPreview.dataset.tempUrl;
      }

      await db.globalSettings.put(state.globalSettings);


      applyGlobalWallpaper();
      newWallpaperBase64 = null;
      applyAppIcons();
      applyGlobalCss(state.globalSettings.globalCss);
      applyStatusBarVisibility();
      initLockScreen();
      alert('Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
      showScreen('home-screen');
    });


    document.getElementById('upload-global-bg-url-btn').addEventListener('click', async () => {

      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá", "ËØ∑ËæìÂÖ•ËÉåÊôØÂõæÁâáÁöÑURL", "", "url");


      if (url && url.trim()) {

        state.globalSettings.globalChatBackground = url.trim();


        renderWallpaperScreen();
      } else if (url !== null) {

        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL„ÄÇ");
      }
    });

    document.getElementById('upload-ephone-bg-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá (EPhone)", "ËØ∑ËæìÂÖ•EPhone‰∏ªÂ±èÂπïÁöÑËÉåÊôØÂõæÁâáURL", "", "url");
      if (url && url.trim()) {

        newWallpaperBase64 = url.trim();

        renderWallpaperScreen();
      } else if (url !== null) {
        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL„ÄÇ");
      }
    });


    document.getElementById('upload-cphone-bg-url-btn').addEventListener('click', async () => {
      const url = await showCustomPrompt("ÁΩëÁªúÂõæÁâá (CPhone)", "ËØ∑ËæìÂÖ•CPhoneÁöÑËÉåÊôØÂõæÁâáURL", "", "url");
      if (url && url.trim()) {

        state.globalSettings.cphoneWallpaper = url.trim();

        renderWallpaperScreen();
      } else if (url !== null) {
        alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL„ÄÇ");
      }
    });



    document.getElementById('remove-ephone-bg-btn').addEventListener('click', () => {

      newWallpaperBase64 = null;
      state.globalSettings.wallpaper = '';

      renderWallpaperScreen();
    });


    document.getElementById('remove-cphone-bg-btn').addEventListener('click', () => {

      state.globalSettings.cphoneWallpaper = '';

      renderWallpaperScreen();
    });



    document.getElementById('css-preset-select').addEventListener('change', handleCssPresetSelectionChange);
    document.getElementById('save-css-preset-btn').addEventListener('click', saveCssPreset);
    document.getElementById('delete-css-preset-btn').addEventListener('click', deleteCssPreset);


    document.getElementById('font-preset-select').addEventListener('change', handleFontPresetSelectionChange);
    document.getElementById('save-font-preset-btn').addEventListener('click', saveFontPreset);
    document.getElementById('delete-font-preset-btn').addEventListener('click', deleteFontPreset);


    document.getElementById('theme-preset-select').addEventListener('change', handleThemePresetSelectionChange);
    document.getElementById('save-theme-preset-btn').addEventListener('click', saveThemePreset);
    document.getElementById('delete-theme-preset-btn').addEventListener('click', deleteThemePreset);




    document.getElementById('manage-sticker-categories-btn').addEventListener('click', openStickerCategoryManager);


    document.getElementById('close-sticker-category-manager-btn').addEventListener('click', () => {
      document.getElementById('sticker-category-manager-modal').classList.remove('visible');
      renderStickerPanel();
    });


    document.getElementById('add-new-sticker-category-btn').addEventListener('click', addNewStickerCategory);


    document.getElementById('existing-sticker-categories-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        const categoryId = parseInt(e.target.dataset.id);
        deleteStickerCategory(categoryId);
      }
    });


    document.getElementById('sticker-category-tabs').addEventListener('click', (e) => {
      if (e.target.classList.contains('sticker-category-tab')) {
        const categoryId = e.target.dataset.categoryId;

        const finalId = (categoryId !== 'all' && categoryId !== 'uncategorized') ? parseInt(categoryId) : categoryId;
        switchStickerCategory(finalId);
      }
    });


    document.getElementById('select-all-stickers-checkbox').addEventListener('change', handleSelectAllStickers);

    document.getElementById('export-single-chat-btn').addEventListener('click', exportSingleChat);

    document.getElementById('import-single-chat-btn').addEventListener('click', () => {
      document.getElementById('import-single-chat-input').click();
    });

    document.getElementById('import-single-chat-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        importSingleChat(file);
      }
      e.target.value = null;
    });


    document.getElementById('add-char-memo-btn').addEventListener('click', () => openMemoEditor());
    document.getElementById('add-char-diary-btn').addEventListener('click', () => openDiaryEditor());
    document.getElementById('favorite-diary-btn').addEventListener('click', toggleDiaryFavorite);
    document.getElementById('favorite-article-btn').addEventListener('click', toggleBrowserArticleFavorite);
    document.getElementById('favorite-memo-btn').addEventListener('click', toggleMemoFavorite);
    document.getElementById('copy-diary-content-btn').addEventListener('click', () => {
      const content = document.getElementById('char-diary-detail-content').innerText; // Use innerText to get formatted text
      copyTextToClipboard(content, 'Êó•ËÆ∞ÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
    });

    document.getElementById('copy-memo-content-btn').addEventListener('click', () => {
      const content = document.getElementById('char-memo-detail-content').value; // It's a textarea
      copyTextToClipboard(content, 'Â§áÂøòÂΩïÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
    });

    document.getElementById('copy-article-content-btn').addEventListener('click', () => {
      const content = document.getElementById('char-article-content').innerText;
      copyTextToClipboard(content, 'ÊñáÁ´†ÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºÅ');
    });


    document.getElementById('regenerate-char-qq-btn').addEventListener('click', async () => {

      showCustomAlert("Ê≠£Âú®ÊâßË°å...", "Ê≠£Âú®ÁîüÊàêÊñ∞ÁöÑÊ®°ÊãüËÅäÂ§©ËÆ∞ÂΩïÔºåÂπ∂ÂêåÊó∂ËÆ©ËßíËâ≤ÊÄùËÄÉÂ¶Ç‰Ωï‰∏é‰Ω†ÁªßÁª≠ÂØπËØù...");

      try {

        await Promise.all([
          handleGenerateSimulatedQQ(),
          handleContinueRealConversationFromCPhone()
        ]);

        console.log("CPhone QQÊ®°ÊãüËÆ∞ÂΩïÁîüÊàê Âíå ‰∏ªËÅäÂ§©Êé®Ëøõ Â∑≤ÂêåÊó∂ÂÆåÊàê„ÄÇ");

      } catch (error) {
        console.error("Âú®ÂêåÊó∂ÊâßË°å‰∏§‰∏™ÂáΩÊï∞Êó∂Âá∫Èîô:", error);
        await showCustomAlert("Êìç‰ΩúÂ§±Ë¥•", `Âú®ÊâßË°åÁªÑÂêàÊìç‰ΩúÊó∂ÈÅáÂà∞ÈîôËØØ: ${error.message}`);
      }
    });


    document.getElementById('char-chat-list').addEventListener('click', (e) => {
      const item = e.target.closest('.chat-list-item');
      if (item && item.dataset.conversationIndex) {
        const index = parseInt(item.dataset.conversationIndex);
        if (!isNaN(index)) {

          openCharSimulatedConversation(index);
        }
      }
    });



    document.getElementById('back-to-char-qq-list-btn').addEventListener('click', () => {
      switchToCharScreen('char-qq-screen');
    });



    const charConversationMessages = document.getElementById('char-conversation-messages');


    const cphoneScrollHandler = () => {

      if (cphoneActiveConversationType !== 'private_user') {
        return;
      }


      if (charConversationMessages.scrollTop < 1 && !isLoadingMoreCphoneMessages) {
        const totalMessages = state.chats[activeCharacterId]?.history.length || 0;

        if (totalMessages > cphoneRenderedCount) {

          loadMoreMirroredMessages();
        }
      }
    };


    charConversationMessages.addEventListener('scroll', cphoneScrollHandler);



    document.getElementById('char-simulated-send-btn').addEventListener('click', () => {
      alert("ËøôÊòØÊ®°ÊãüÂØπËØùÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØÂì¶~");
    });



    document.getElementById('regenerate-char-album-btn').addEventListener('click', handleGenerateSimulatedAlbum);


    document.getElementById('char-album-grid').addEventListener('click', (e) => {

      const photoItem = e.target.closest('.char-photo-item');


      if (photoItem && photoItem.dataset.description) {
        const description = photoItem.dataset.description;


        showCustomAlert("ÁÖßÁâáËØ¶ÊÉÖ", description.replace(/\n/g, '<br>'));
      }
    });
    document.getElementById('regenerate-char-browser-btn').addEventListener('click', handleGenerateBrowserHistory);

    document.getElementById('regenerate-char-taobao-btn').addEventListener('click', handleGenerateTaobaoHistory);



    document.getElementById('char-product-grid').addEventListener('click', (e) => {
      const item = e.target.closest('.char-product-item');
      if (item && item.dataset.reason) {
        const reason = item.dataset.reason;
        showCustomAlert("TAÁöÑÊÉ≥Ê≥ï...", reason.replace(/\n/g, '<br>'));
      }
    });


    window.openCharWallet = openCharWallet;
    document.getElementById('regenerate-char-memo-btn').addEventListener('click', handleGenerateSimulatedMemos);
    document.getElementById('char-memo-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-memo-screen'));

    document.getElementById('regenerate-char-diary-btn').addEventListener('click', handleGenerateSimulatedDiaries);
    document.getElementById('add-char-diary-btn').addEventListener('click', handleWriteNewDiaryEntry);
    document.getElementById('char-diary-detail-back-btn').addEventListener('click', () => switchToCharScreen('char-diary-screen'));
    document.getElementById('regenerate-char-amap-btn').addEventListener('click', handleGenerateAmapHistory);
    document.getElementById('regenerate-char-usage-btn').addEventListener('click', handleGenerateAppUsage);
    document.getElementById('regenerate-char-music-btn').addEventListener('click', handleGenerateSimulatedMusic);
    document.getElementById('close-char-music-player-btn').addEventListener('click', closeCharMusicPlayer);
    document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);
    document.getElementById('regenerate-douban-btn').addEventListener('click', handleGenerateDoubanPosts);
    document.getElementById('douban-detail-back-btn').addEventListener('click', () => showScreen('douban-screen'));
    document.getElementById('douban-send-comment-btn').addEventListener('click', handleSendDoubanComment);
    document.getElementById('douban-wait-reply-btn').addEventListener('click', handleDoubanWaitReply);

    document.getElementById('cphone-wallpaper-upload-input').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const dataUrl = await new Promise((res) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });

        // 1. Á´ãÂç≥‰øùÂ≠òÂíåÊòæÁ§∫
        state.globalSettings.cphoneWallpaper = dataUrl;
        renderWallpaperScreen(); // This will update the preview
        await showCustomAlert("ÊàêÂäü", "CPhone Â£ÅÁ∫∏Â∑≤Êõ¥Êñ∞ÔºÅ\n\nÂõæÁâáÂ∞ÜÂú®ÂêéÂè∞ÈùôÈªò‰∏ä‰º†Âà∞ÂõæÂ∫ä... (‰øùÂ≠òËÆæÁΩÆÂêéÁîüÊïà)");

        // 2. ÂêØÂä®ÈùôÈªò‰∏ä‰º†
        (async () => {
            await silentlyUpdateDbUrl(
                db.globalSettings,
                'main',
                'cphoneWallpaper',
                dataUrl
            );
        })();
      }
      event.target.value = null; // Ê∏ÖÁ©∫ input
    });



    document.getElementById('cphone-icon-settings-grid').addEventListener('click', (e) => {
      if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (iconId) {
          handleIconChange(iconId, 'cphone', item);
        }
      }
    });
    document.getElementById('import-appearance-btn').addEventListener('click', () => {
      document.getElementById('import-appearance-input').click();
    });

    document.getElementById('import-appearance-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        importAppearanceSettings(file);
      }
      e.target.value = null;
    });


 
    document.addEventListener('visibilitychange', () => {

      if (document.visibilityState === 'hidden') {

        localStorage.setItem('ephoneLastActiveTimestamp', Date.now());
        console.log("Â∫îÁî®Â∑≤ÂàáÊç¢Âà∞ÂêéÂè∞ÔºåËÆ∞ÂΩïÂΩìÂâçÊó∂Èó¥„ÄÇ");
      }
    });

    document.getElementById('export-world-book-btn').addEventListener('click', exportWorldBooks);
    document.getElementById('import-world-book-btn').addEventListener('click', () => {
      document.getElementById('import-world-book-input').click();
    });
    document.getElementById('import-world-book-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleWorldBookImport(file);
      }
      e.target.value = null;
    });
    document.getElementById('enable-ai-drawing-switch').addEventListener('change', async (e) => {
      const isEnabled = e.target.checked;
      state.globalSettings.enableAiDrawing = isEnabled;
      await db.globalSettings.put(state.globalSettings);


      const activeScreen = document.querySelector('.screen.active');
      if (activeScreen) {
        switch (activeScreen.id) {
          case 'chat-interface-screen':
            renderChatInterface(state.activeChatId);
            break;
          case 'chat-list-screen':

            if (document.getElementById('qzone-screen').classList.contains('active')) renderQzonePosts();

            if (document.getElementById('favorites-view').classList.contains('active')) renderFavoritesScreen();
            break;
          case 'douban-screen':
            renderDoubanScreen();
            break;
          case 'douban-post-detail-screen':
            openDoubanPostDetail(activeDoubanPostId);
            break;

          case 'character-phone-screen':
            const activeCharScreen = document.querySelector('.char-screen.active');
            if (activeCharScreen) {
              switch (activeCharScreen.id) {
                case 'char-album-screen':
                  renderCharAlbum();
                  break;
                case 'char-taobao-screen':
                  renderCharTaobao();
                  break;
                case 'char-browser-article-screen':
                  const char = state.chats[activeCharacterId];
                  const history = char.simulatedBrowserHistory || [];
                  const lastArticleIndex = history.length > 0 ? history.length - 1 : 0;
                  renderCharArticle(history[lastArticleIndex]);
                  break;
                case 'char-usage-screen':
                  renderCharAppUsage();
                  break;
                case 'char-qq-screen':
                  renderCharSimulatedQQ();
                  break;
                case 'char-qq-conversation-screen':
                  const convoIndex = document.querySelector('#char-chat-list .chat-list-item')?.dataset.conversationIndex || 0;
                  openCharSimulatedConversation(parseInt(convoIndex));
                  break;
              }
            }
            break;
        }
      }
      showCustomAlert('ËÆæÁΩÆÂ∑≤Â∫îÁî®', `AIÁîüÂõæÂäüËÉΩÂ∑≤${isEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}„ÄÇ`);
    });

    document.getElementById('search-history-btn').addEventListener('click', openSearchHistoryScreen);
    document.getElementById('search-history-back-btn').addEventListener('click', () => {
      showScreen('chat-settings-screen');
    });
    document.getElementById('execute-search-btn').addEventListener('click', handleSearchHistory);
    document.getElementById('clear-search-btn').addEventListener('click', clearSearchFilters);




    document.getElementById('upload-custom-frame-btn').addEventListener('click', handleUploadFrame);
    document.getElementById('batch-import-frames-btn').addEventListener('click', handleBatchUploadFrames);


    document.querySelector('#avatar-frame-modal .modal-body').addEventListener('click', (e) => {

      if (e.target.classList.contains('delete-btn')) {
        const frameId = parseInt(e.target.dataset.id);
        if (!isNaN(frameId)) {
          handleDeleteCustomFrame(frameId);
        }
      }
    });





    setupHomeScreenPagination();


    window.openPresetScreen = openPresetScreen;


    document.getElementById('add-preset-btn').addEventListener('click', async () => {
      const name = await showCustomPrompt('ÂàõÂª∫Êñ∞È¢ÑËÆæ', 'ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞');
      if (name && name.trim()) {
        const newPreset = {
          id: 'preset_' + Date.now(),
          name: name.trim(),
          content: []
        };
        await db.presets.add(newPreset);
        await renderPresetScreen();
        openPresetEditor(newPreset.id);
      }
    });

    document.getElementById('manage-preset-categories-btn').addEventListener('click', openPresetCategoryManager);

    document.getElementById('add-preset-entry-btn').addEventListener('click', () => {
      const container = document.getElementById('preset-entries-container');
      if (container.querySelector('p')) {
        container.innerHTML = '';
      }
      const newBlock = createPresetEntryBlock();
      container.appendChild(newBlock);
      newBlock.querySelector('.entry-content-textarea').focus();
    });


    document.getElementById('save-preset-btn').addEventListener('click', async () => {
      if (!editingPresetId) return;
      const preset = await db.presets.get(editingPresetId);
      if (!preset) return;


      const newName = document.getElementById('preset-name-input').value.trim();
      if (!newName) {
        alert('È¢ÑËÆæÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
        return;
      }
      preset.name = newName;
      preset.categoryId = parseInt(document.getElementById('preset-category-select').value) || null;

      const entriesContainer = document.getElementById('preset-entries-container');
      const entryBlocks = entriesContainer.querySelectorAll('.message-editor-block');
      const newEntries = [];
      entryBlocks.forEach(block => {
        const content = block.querySelector('.entry-content-textarea').value.trim();
        if (content) {
          newEntries.push({
            comment: block.querySelector('.entry-comment-input').value.trim(),
            keys: (block.querySelector('.entry-keys-input').value.trim() || '').split(',').map(k => k.trim()).filter(Boolean),
            content: content,
            enabled: block.querySelector('.entry-enabled-switch').checked
          });
        }
      });
      preset.content = newEntries;


      await db.presets.put(preset);
      editingPresetId = null;


      showScreen('preset-screen');



      await renderPresetScreen();
    });




    document.getElementById('import-preset-btn').addEventListener('click', async () => {
      

     
      try {
        
        await requirePinActivation();

        
        document.getElementById('import-preset-input').click();

      } catch (error) {
    
        console.warn("È¢ÑËÆæÂØºÂÖ•Ë¢´ÂèñÊ∂à:", error.message);
      }
    
    });

    document.getElementById('import-preset-input').addEventListener('change', handlePresetImport);

    document.getElementById('reset-button-order-btn').addEventListener('click', resetButtonOrder);

    document.getElementById('clear-specific-data-btn').addEventListener('click', openDataClearWizard);


    document.getElementById('cancel-clear-wizard-btn-step1').addEventListener('click', () => {
      document.getElementById('data-clear-wizard-modal').classList.remove('visible');
    });
    document.getElementById('go-to-clear-step2-btn').addEventListener('click', handleDataClearNext);


    document.getElementById('back-to-clear-step1-btn').addEventListener('click', handleDataClearBack);
    document.getElementById('cancel-clear-wizard-btn-step2').addEventListener('click', () => {
      document.getElementById('data-clear-wizard-modal').classList.remove('visible');
    });
    document.getElementById('confirm-final-clear-btn').addEventListener('click', handleConfirmDataClear);


    document.getElementById('data-clear-wizard-modal').addEventListener('click', (e) => {
      const item = e.target.closest('.clear-posts-item');
      if (item) {

        e.stopPropagation();
        item.classList.toggle('selected');
      }
    });
    document.getElementById('data-clear-wizard-modal').addEventListener('change', (e) => {

      if (e.target.id === 'select-all-chars-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-char-list .clear-posts-item').forEach(item => {
          item.classList.toggle('selected', isChecked);
        });
      } else if (e.target.id === 'select-all-types-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#data-clear-type-list .clear-posts-item').forEach(item => {
          item.classList.toggle('selected', isChecked);
        });
      }
    });

    document.getElementById('compress-images-btn').addEventListener('click', compressAllLocalImages);

    document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);


    document.getElementById('copy-timestamp-btn').addEventListener('click', copyMessageTimestamp);

    document.getElementById('npc-list-back-btn').addEventListener('click', () => {

      switchToChatListView('messages-view');
    });


    document.getElementById('add-npc-btn').addEventListener('click', () => openNpcEditor(null));


    document.getElementById('save-npc-btn').addEventListener('click', saveNpc);
    document.getElementById('npc-editor-modal').addEventListener('click', (e) => {
      if (e.target.id === 'manage-npc-groups-btn') {
        openNpcGroupManager();
      }
    });
    document.getElementById('close-npc-group-manager-btn').addEventListener('click', () => {
      document.getElementById('npc-group-manager-modal').classList.remove('visible');
      // ÈáçÊñ∞Â°´ÂÖÖNPCÁºñËæëÂô®ÈáåÁöÑ‰∏ãÊãâËèúÂçï
      if (document.getElementById('npc-editor-modal').classList.contains('visible')) {
        openNpcEditor(editingNpcId);
      }
    });
    document.getElementById('add-new-npc-group-btn').addEventListener('click', addNewNpcGroup);
    document.getElementById('existing-npc-groups-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        deleteNpcGroup(parseInt(e.target.dataset.id));
      }
    });
    document.getElementById('cancel-npc-editor-btn').addEventListener('click', () => {
      document.getElementById('npc-editor-modal').classList.remove('visible');
    });


    document.getElementById('npc-avatar-input').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('npc-avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    document.getElementById('chat-lock-overlay').addEventListener('click', (e) => {

      if (e.target.id === 'spectator-reroll-btn') {
        handleSpectatorReroll();
      } else if (e.target.id === 'spectator-edit-btn') {

        openAiResponseEditor();
      }

    });
    addLongPressListener(document.getElementById('music-visual-container'), () => {
      if (musicState.currentIndex > -1) {
        handleChangeAlbumArt(musicState.currentIndex);
      }
    });
    document.getElementById('douban-settings-btn').addEventListener('click', openDoubanSettingsModal);
    document.getElementById('save-douban-settings-btn').addEventListener('click', saveDoubanSettings);
    document.getElementById('cancel-douban-settings-btn').addEventListener('click', () => {
      document.getElementById('douban-settings-modal').classList.remove('visible');
    });

    document.getElementById('time-zone-search-input').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const selectEl = document.getElementById('time-zone-select');


      for (const option of selectEl.options) {
        const optionText = option.textContent.toLowerCase();


        if (optionText.includes(searchTerm)) {
          option.style.display = '';
        } else {

          option.style.display = 'none';
        }
      }
    });





    window.openWerewolfLobby = openWerewolfLobby;


    document.getElementById('werewolf-game-btn').addEventListener('click', () => openWerewolfLobby('group'));


    document.getElementById('cancel-werewolf-lobby-btn').addEventListener('click', () => {
      document.getElementById('werewolf-lobby-modal').classList.remove('visible');
    });
    document.getElementById('start-werewolf-game-btn').addEventListener('click', initializeWerewolfGame);


    document.getElementById('werewolf-role-confirm-btn').addEventListener('click', () => {
      document.getElementById('werewolf-role-modal').classList.remove('visible');
      executeNightPhase();
    });

    document.getElementById('exit-werewolf-game-btn').addEventListener('click', async () => {
      const confirmed = await showCustomConfirm('ÈÄÄÂá∫Ê∏∏Êàè', 'Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçËøôÂ±ÄÁãº‰∫∫ÊùÄÂêóÔºüÊ∏∏ÊàèËøõÂ∫¶Â∞Ü‰∏ç‰ºöË¢´‰øùÂ≠ò„ÄÇ', {
        confirmButtonClass: 'btn-danger'
      });
      if (confirmed) {
        werewolfGameState.isActive = false;

        showScreen(werewolfGameState.chatId ? 'chat-interface-screen' : 'home-screen');
      }
    });

    document.getElementById('werewolf-game-over-close-btn').addEventListener('click', () => {
      document.getElementById('werewolf-game-over-modal').classList.remove('visible');
      showScreen(werewolfGameState.chatId ? 'chat-list-screen' : 'home-screen');
    });



    document.getElementById('cancel-wolf-kill-btn').addEventListener('click', () => {
      document.getElementById('werewolf-kill-modal').classList.remove('visible');
    });



    document.getElementById('cancel-werewolf-lobby-btn').addEventListener('click', () => {
      document.getElementById('werewolf-lobby-modal').classList.remove('visible');
    });

    document.getElementById('werewolf-retry-btn').addEventListener('click', handleWerewolfRetry);
    document.getElementById('manual-werewolf-summary-btn').addEventListener('click', handleManualWerewolfSummary);
    document.getElementById('check-and-fix-data-btn').addEventListener('click', checkAndFixData);
    const emergencyResetBtn = document.getElementById('emergency-reset-appearance-btn');
    if (emergencyResetBtn) {
        emergencyResetBtn.addEventListener('click', handleEmergencyAppearanceReset);
    }
    const factoryResetBtn = document.getElementById('factory-reset-btn');
    if (factoryResetBtn) {
        factoryResetBtn.addEventListener('click', handleFactoryReset);
    }
    document.getElementById('dynamic-island-music-toggle-switch').addEventListener('change', (e) => {
      const isEnabled = e.target.checked;
      state.globalSettings.alwaysShowMusicIsland = isEnabled; // Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÁä∂ÊÄÅ

   
      const isFrameMode = document.body.classList.contains('frame-mode-active');

     
      if (musicState.isActive && !isFrameMode) {
        const lyricBar = document.getElementById('global-lyrics-bar');
        const phoneScreenForIsland = document.getElementById('phone-screen');

        if (isEnabled) {
      
          lyricBar.classList.remove('visible');
          phoneScreenForIsland.classList.add('dynamic-island-active');
        } else {
      
          phoneScreenForIsland.classList.remove('dynamic-island-active');
          if (musicState.parsedLyrics && musicState.parsedLyrics.length > 0) {
            lyricBar.classList.add('visible');
          }
        }
      }
    });
    document.getElementById('delete-world-books-btn').addEventListener('click', openWorldBookDeletionModal);


    document.getElementById('cancel-delete-world-books-btn').addEventListener('click', () => {
      document.getElementById('delete-world-books-modal').classList.remove('visible');
    });
    document.getElementById('confirm-delete-world-books-btn').addEventListener('click', handleConfirmWorldBookDeletion);

    document.getElementById('delete-world-books-modal').addEventListener('click', (e) => {

      const item = e.target.closest('.clear-posts-item');
      if (item) {
        item.classList.toggle('selected');
      }

      if (e.target.id === 'select-all-world-books-for-clear') {
        const isChecked = e.target.checked;
        document.querySelectorAll('#delete-world-books-list .clear-posts-item').forEach(el => {
          el.classList.toggle('selected', isChecked);
        });
      }
    });


    document.getElementById('sticker-search-input').addEventListener('input', () => {

      renderStickerPanel(false);
    });


    document.getElementById('sticker-category-tabs').addEventListener('click', (e) => {
      if (e.target.classList.contains('sticker-category-tab')) {
        const categoryId = e.target.dataset.categoryId;
        const finalId = (categoryId !== 'all' && categoryId !== 'uncategorized') ? parseInt(categoryId) : categoryId;


        document.getElementById('sticker-search-input').value = '';


        switchStickerCategory(finalId);
      }
    });




    const chatMessagesContainer = document.getElementById('chat-messages');
    chatMessagesContainer.addEventListener('scroll', () => {

      if (chatMessagesContainer.scrollTop < 1 && !isLoadingMoreMessages) {
        const totalMessages = state.chats[state.activeChatId]?.history.length || 0;

        if (totalMessages > currentRenderedCount) {
          loadMoreMessages();
        }
      }
    });


    const thoughtsHistoryList = document.getElementById('thoughts-history-list');
    thoughtsHistoryList.addEventListener('scroll', () => {
      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = thoughtsHistoryList;

      if (scrollHeight - scrollTop <= clientHeight + 50 && !isLoadingMoreThoughts) {
        const totalItems = state.chats[state.activeChatId]?.thoughtsHistory.length || 0;
        if (totalItems > thoughtsHistoryRenderCount) {
          loadMoreThoughts();
        }
      }
    });


    const qzoneContent = document.querySelector('#qzone-screen .qzone-content');
    qzoneContent.addEventListener('scroll', () => {
      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = qzoneContent;

      if (scrollHeight - scrollTop <= clientHeight + 100 && !isLoadingMorePosts) {
        if (qzonePostsCache.length > qzonePostsRenderCount) {
          loadMoreQzonePosts();
        }
      }
    });

    
    const localGridEl = document.getElementById('nai-gallery-grid-local');
    const cloudGridEl = document.getElementById('nai-gallery-grid-cloud');

    const naiGridScrollHandler = (e) => {
      
      const targetGrid = e.currentTarget;
      const tabId = targetGrid.id.includes('local') ? 'local' : 'cloud';

      
      if (tabId !== activeNaiGalleryTab) {
        return;
      }
      
      const { scrollTop, scrollHeight, clientHeight } = targetGrid;
      
      
      if (scrollHeight - scrollTop <= clientHeight + 100 && !isLoadingMoreNaiImages[tabId]) {
        if (naiGalleryCache[tabId].length > naiGalleryRenderCount[tabId]) {
          loadMoreNaiGalleryImages(); 
        }
      }
    };

    // ÂàÜÂà´‰∏∫‰∏§‰∏™Êñ∞ÁΩëÊ†ºÁªëÂÆö‰∫ã‰ª∂
    if (localGridEl) {
      localGridEl.addEventListener('scroll', naiGridScrollHandler);
    }
    if (cloudGridEl) {
      cloudGridEl.addEventListener('scroll', naiGridScrollHandler);
    }
    

    document.getElementById('read-together-btn').addEventListener('click', openReadingRoom);
    const restoreBtn = document.getElementById('reading-restore-btn');

    makeDraggable(restoreBtn, restoreBtn);
    document.getElementById('close-reading-btn').addEventListener('click', closeReadingRoom);
    document.getElementById('open-reading-library-btn').addEventListener('click', openBookLibrary);
    document.getElementById('next-page-btn').addEventListener('click', showNextPage);
    document.getElementById('prev-page-btn').addEventListener('click', showPrevPage);
    document.getElementById('book-upload-input').addEventListener('change', handleBookFileUpload);


    document.getElementById('minimize-reading-btn').addEventListener('click', minimizeReadingRoom);
    document.getElementById('reading-restore-btn').addEventListener('click', restoreReadingRoom);


    makeDraggable(document.getElementById('reading-window'), document.querySelector('#reading-window .reading-header'));


    document.getElementById('open-reading-library-btn').addEventListener('click', openBookLibrary);

    document.getElementById('close-reading-library-btn-header').addEventListener('click', () => {
      document.getElementById('reading-library-modal').classList.remove('visible');
    });
    document.getElementById('import-new-book-btn-header').addEventListener('click', importBook);



    document.getElementById('reading-library-list').addEventListener('click', (e) => {
      const target = e.target;
      if (target.classList.contains('group-name')) {
        const bookId = parseInt(target.dataset.bookId);
        loadBookFromLibrary(bookId);
      } else if (target.classList.contains('delete-group-btn')) {
        const bookId = parseInt(target.dataset.bookId);
        deleteBookFromLibrary(bookId);
      }
    });

    document.getElementById('page-indicator').addEventListener('click', handlePageJump);
    document.getElementById('reading-library-search-input').addEventListener('input', (e) => {

      renderBookLibrary(e.target.value);
    });
    const debouncedUpdateReadingContext = debounce(updateReadingContextOnScroll, 300);


    document.getElementById('reading-content').addEventListener('scroll', debouncedUpdateReadingContext);
    document.getElementById('api-temperature-slider').addEventListener('input', (e) => {
      document.getElementById('api-temperature-value').textContent = e.target.value;
    });
    const chatListContainer = document.getElementById('messages-view');
    chatListContainer.addEventListener('scroll', () => {
      const {
        scrollTop,
        scrollHeight,
        clientHeight
      } = chatListContainer;

      if (scrollHeight - scrollTop <= clientHeight + 150 && !isLoadingMoreChats) {
        loadMoreChats();
      }
    });



    document.getElementById('manage-product-categories-btn').addEventListener('click', openProductCategoryManager);
    document.getElementById('close-product-category-manager-btn').addEventListener('click', () => {
      document.getElementById('product-category-manager-modal').classList.remove('visible');


      openProductEditor(editingProductId);
    });
    document.getElementById('add-new-product-category-btn').addEventListener('click', addNewProductCategory);
    document.getElementById('existing-product-categories-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-group-btn')) {
        deleteProductCategory(parseInt(e.target.dataset.id));
      }
    });


    document.getElementById('add-product-variation-btn').addEventListener('click', () => addProductVariationInput());


    document.getElementById('cancel-variation-selection-btn').addEventListener('click', () => {
      document.getElementById('variation-selection-modal').classList.remove('visible');
    });
    document.getElementById('variation-decrease-qty').addEventListener('click', () => {
      const display = document.getElementById('variation-quantity-display');
      let qty = parseInt(display.textContent);
      if (qty > 1) display.textContent = qty - 1;
    });
    document.getElementById('variation-increase-qty').addEventListener('click', () => {
      const display = document.getElementById('variation-quantity-display');
      display.textContent = parseInt(display.textContent) + 1;
    });
    document.getElementById('product-category-tabs').addEventListener('click', (e) => {

      if (e.target.classList.contains('product-category-tab')) {

        const categoryId = e.target.dataset.categoryId === 'all' ? 'all' : parseInt(e.target.dataset.categoryId);


        switchShoppingCategory(categoryId);
      }
    });
    document.getElementById('generate-shopping-items-btn').addEventListener('click', handleGenerateShoppingItems);
    document.getElementById('shopping-settings-btn').addEventListener('click', openShoppingSettingsModal);
    document.getElementById('save-shopping-settings-btn').addEventListener('click', saveShoppingSettings);
    document.getElementById('cancel-shopping-settings-btn').addEventListener('click', () => {
      document.getElementById('shopping-settings-modal').classList.remove('visible');
    });
    document.getElementById('select-all-products-checkbox').addEventListener('change', (e) => {
      const isChecked = e.target.checked;

      const visibleItems = document.querySelectorAll('#product-grid .product-item');

      visibleItems.forEach(item => {
        const productId = parseInt(item.dataset.id);
        item.classList.toggle('selected', isChecked);
        if (isChecked) {
          selectedProducts.add(productId);
        } else {
          selectedProducts.delete(productId);
        }
      });
      document.getElementById('delete-selected-products-btn').textContent = `Âà†Èô§ (${selectedProducts.size})`;
    });


    document.getElementById('delete-selected-products-btn').addEventListener('click', async () => {
      if (selectedProducts.size === 0) {
        alert("ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂïÜÂìÅ„ÄÇ");
        return;
      }

      const confirmed = await showCustomConfirm(
        'Á°ÆËÆ§Âà†Èô§',
        `Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedProducts.size} ‰∏™ÂïÜÂìÅÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`, {
          confirmButtonClass: 'btn-danger'
        }
      );

      if (confirmed) {
        await db.shoppingProducts.bulkDelete([...selectedProducts]);


        document.getElementById('manage-products-btn').click();

        await renderShoppingProducts();

        await showCustomAlert("ÊàêÂäü", "ÈÄâ‰∏≠ÁöÑÂïÜÂìÅÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ");
      }
    });

    document.getElementById('appearance-preset-select').addEventListener('change', handleAppearancePresetSelectionChange);
    document.getElementById('save-appearance-preset-btn').addEventListener('click', saveAppearancePreset);
    document.getElementById('delete-appearance-preset-btn').addEventListener('click', deleteAppearancePreset);



    document.getElementById('novelai-switch').addEventListener('change', (e) => {
      const detailsDiv = document.getElementById('novelai-details');
      detailsDiv.style.display = e.target.checked ? 'block' : 'none';
    });


    document.getElementById('novelai-key-toggle').addEventListener('click', function() {
      const input = document.getElementById('novelai-api-key');
      if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'üòå';
      } else {
        input.type = 'password';
        this.textContent = 'üßê';
      }
    });

  
    document.getElementById('novelai-settings-btn').addEventListener('click', () => {
      loadNovelAISettings();
      document.getElementById('novelai-settings-modal').style.display = 'flex';
    });


    document.getElementById('nai-cors-proxy').addEventListener('change', (e) => {
      const customProxyGroup = document.getElementById('nai-custom-proxy-group');
      if (e.target.value === 'custom') {
        customProxyGroup.style.display = 'block';
      } else {
        customProxyGroup.style.display = 'none';
      }
    });

    document.getElementById('close-novelai-settings').addEventListener('click', () => {
      document.getElementById('novelai-settings-modal').style.display = 'none';
    });


    document.getElementById('save-nai-settings-btn').addEventListener('click', () => {
      saveNovelAISettings();
      document.getElementById('novelai-settings-modal').style.display = 'none';
      alert('NovelAIËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
    });

    document.getElementById('reset-nai-settings-btn').addEventListener('click', () => {
      if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆÂêóÔºü')) {
        resetNovelAISettings();
      }
    });


    document.getElementById('novelai-test-btn').addEventListener('click', () => {
      const apiKey = document.getElementById('novelai-api-key').value.trim();
      if (!apiKey) {
        alert('ËØ∑ÂÖàÂ°´ÂÜôNovelAI API KeyÔºÅ');
        return;
      }
      document.getElementById('novelai-test-modal').style.display = 'flex';
      document.getElementById('nai-test-result').style.display = 'none';
      document.getElementById('nai-test-error').style.display = 'none';
    });

 
    document.getElementById('close-novelai-test').addEventListener('click', () => {
      document.getElementById('novelai-test-modal').style.display = 'none';
    });

    document.getElementById('close-nai-test-btn').addEventListener('click', () => {
      document.getElementById('novelai-test-modal').style.display = 'none';
    });

 
    document.getElementById('nai-generate-btn').addEventListener('click', async () => {
      await generateNovelAIImage();
    });



    document.getElementById('nai-download-btn').addEventListener('click', () => {
      const img = document.getElementById('nai-result-image');
      const link = document.createElement('a');
      link.href = img.src;
      link.download = 'novelai-generated-' + Date.now() + '.png';
      link.click();
    });

  
    document.getElementById('character-nai-prompts-btn').addEventListener('click', () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // Âä†ËΩΩÂΩìÂâçËßíËâ≤ÁöÑNAIÊèêÁ§∫ËØçÈÖçÁΩÆ
      const naiSettings = chat.settings.naiSettings || {
        promptSource: 'system',
        characterPositivePrompt: '',
        characterNegativePrompt: ''
      };

  
      document.getElementById('character-nai-positive').value = naiSettings.characterPositivePrompt || '';
      document.getElementById('character-nai-negative').value = naiSettings.characterNegativePrompt || '';

      document.getElementById('character-nai-prompts-modal').style.display = 'flex';
    });

   
    document.getElementById('close-character-nai-prompts').addEventListener('click', () => {
      document.getElementById('character-nai-prompts-modal').style.display = 'none';
    });

    document.getElementById('save-character-nai-prompts-btn').addEventListener('click', async () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      if (!chat.settings.naiSettings) {
        chat.settings.naiSettings = {
          promptSource: 'system'
        };
      }

      chat.settings.naiSettings.characterPositivePrompt = document.getElementById('character-nai-positive').value.trim();
      chat.settings.naiSettings.characterNegativePrompt = document.getElementById('character-nai-negative').value.trim();

      console.log('üíæ [‰∏ìÂ±ûÂºπÁ™ó] ‰øùÂ≠òËßíËâ≤NAIÊèêÁ§∫ËØç');
      console.log('   characterPositivePrompt:', chat.settings.naiSettings.characterPositivePrompt);
      console.log('   characterNegativePrompt:', chat.settings.naiSettings.characterNegativePrompt);
      console.log('   promptSource:', chat.settings.naiSettings.promptSource);

     
      await db.chats.put(chat);

      document.getElementById('character-nai-prompts-modal').style.display = 'none';
      alert('ËßíËâ≤‰∏ìÂ±ûNAIÊèêÁ§∫ËØçÂ∑≤‰øùÂ≠òÔºÅ');
    });

    document.getElementById('reset-character-nai-prompts-btn').addEventListener('click', () => {
      if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂΩìÂâçËßíËâ≤ÁöÑNAIÊèêÁ§∫ËØçÈÖçÁΩÆÂêóÔºü')) {
        document.getElementById('character-nai-positive').value = '';
        document.getElementById('character-nai-negative').value = '';
      }
    });

 
    document.getElementById('group-character-nai-prompts-btn').addEventListener('click', () => {
      if (!state.activeChatId) return;
      const chat = state.chats[state.activeChatId];

      // Âä†ËΩΩÂΩìÂâçËßíËâ≤ÁöÑNAIÊèêÁ§∫ËØçÈÖçÁΩÆ
      const naiSettings = chat.settings.naiSettings || {
        promptSource: 'system',
        characterPositivePrompt: '',
        characterNegativePrompt: ''
      };

    
      document.getElementById('character-nai-positive').value = naiSettings.characterPositivePrompt || '';
      document.getElementById('character-nai-negative').value = naiSettings.characterNegativePrompt || '';

      document.getElementById('character-nai-prompts-modal').style.display = 'flex';
    });
 

    document.getElementById('manage-frames-btn').addEventListener('click', toggleFrameManagementMode);
    document.getElementById('select-all-frames-checkbox').addEventListener('change', handleSelectAllFrames);
    document.getElementById('delete-selected-frames-btn').addEventListener('click', executeBatchDeleteFrames);
    document.getElementById('delete-current-category-btn').addEventListener('click', handleDeleteCurrentCategory);
    document.getElementById('char-wallet-back-btn').addEventListener('click', () => {

      switchToCharScreen('char-taobao-screen');
    });
    document.getElementById('sticker-binding-chat-list').addEventListener('click', (e) => {
      const item = e.target.closest('.contact-picker-item');
      if (item) {
        const checkbox = item.querySelector('.sticker-binding-checkbox');
        if (checkbox && e.target !== checkbox) {
          checkbox.checked = !checkbox.checked;
        }
      }
    });
    const stickerTabsContainer = document.getElementById('sticker-category-tabs');
    addLongPressListener(stickerTabsContainer, (e) => {
      const tab = e.target.closest('.sticker-category-tab');
      if (tab) {
        e.preventDefault();
        const categoryIdStr = tab.dataset.categoryId;
        if (categoryIdStr === 'all') {
          showCustomAlert("ÊèêÁ§∫", "‚ÄúÂÖ®ÈÉ®‚ÄùÂàÜÁ±ªÊó†Ê≥ïË¢´ÁªëÂÆö„ÄÇ");
          return;
        }
        const categoryId = categoryIdStr === 'uncategorized' ? 'uncategorized' : parseInt(categoryIdStr);
        openStickerCategoryBindingModal(categoryId);
      }
    });

    document.getElementById('open-nai-gallery-btn').addEventListener('click', openNaiGallery);
    document.getElementById('nai-gallery-tabs').addEventListener('click', (e) => {
      const tab = e.target.closest('.nai-gallery-tab');
      if (tab && !tab.classList.contains('active')) {
        switchNaiGalleryTab(tab.dataset.tabId);
      }
    });
    document.getElementById('close-nai-gallery-btn').addEventListener('click', () => {
      document.getElementById('nai-gallery-panel').classList.remove('visible');
    });

    document.getElementById('manage-nai-gallery-btn').addEventListener('click', toggleNaiGalleryManagementMode);

    document.getElementById('nai-gallery-grid-local').addEventListener('click', (e) => {
      handleNaiGalleryGridClick(e);
    });
    document.getElementById('nai-gallery-grid-cloud').addEventListener('click', (e) => {
      handleNaiGalleryGridClick(e);
    });

    document.getElementById('select-all-nai-gallery-checkbox').addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      const activeGridId = `nai-gallery-grid-${activeNaiGalleryTab}`;
      
      
      document.querySelectorAll(`#${activeGridId} .nai-gallery-item`).forEach(item => {
        item.classList.toggle('selected', isChecked);
        const key = item.dataset.key;
        if (isChecked) {
          selectedNaiImages.add(key);
        } else {
          selectedNaiImages.delete(key);
        }
      });
      updateNaiGalleryActionButtons();
    });
    document.getElementById('download-selected-nai-gallery-btn').addEventListener('click', () => executeBatchDownloadNaiImages());
    document.getElementById('upload-selected-nai-gallery-btn').addEventListener('click', () => executeBatchUploadNaiImagesToImgBB());
    document.getElementById('export-selected-nai-gallery-btn').addEventListener('click', () => executeBatchExportNaiImages()); 
    document.getElementById('delete-selected-nai-gallery-btn').addEventListener('click', () => executeBatchDeleteNaiImages());
    document.getElementById('delete-selected-nai-gallery-btn').addEventListener('click', () => executeBatchDeleteNaiImages());
    document.getElementById('chat-expand-btn').addEventListener('click', () => {
      document.body.classList.toggle('chat-actions-expanded');
    });
    document.getElementById('profile-edit-btn').addEventListener('click', openThoughtEditor);
    document.getElementById('open-quick-reply-btn').addEventListener('click', openQuickReplyModal);

    document.getElementById('cancel-quick-reply-btn').addEventListener('click', () => {
      document.getElementById('quick-reply-modal').classList.remove('visible');
    });


    document.getElementById('add-quick-reply-btn').addEventListener('click', addNewQuickReply);

  
    
    document.getElementById('minimize-char-music-btn').addEventListener('click', minimizeCharMusicPlayer);
    
    
    document.getElementById('char-music-restore-btn').addEventListener('click', restoreCharMusicPlayer);
    
  
    makeDraggable(document.getElementById('char-music-restore-btn'), document.getElementById('char-music-restore-btn'));

document.getElementById('imgbb-enable-switch').addEventListener('change', (e) => {
    document.getElementById('imgbb-settings-details').style.display = e.target.checked ? 'block' : 'none';
});

document.getElementById('imgbb-key-toggle').addEventListener('click', function() {
    const input = document.getElementById('imgbb-api-key');
    if (input.type === 'password') {
        input.type = 'text';
        this.textContent = 'üòå';
    } else {
        input.type = 'password';
        this.textContent = 'üßê';
    }
});
document.getElementById('catbox-enable-switch').addEventListener('change', (e) => {
        document.getElementById('catbox-settings-details').style.display = e.target.checked ? 'block' : 'none';
    });

    document.getElementById('catbox-key-toggle').addEventListener('click', function() {
        const input = document.getElementById('catbox-userhash');
        if (input.type === 'password') {
            input.type = 'text';
            this.textContent = 'üòå';
        } else {
            input.type = 'password';
            this.textContent = 'üßê';
        }
    });
const biliSearchBtn = document.getElementById('char-bilibili-search-btn');
    if (biliSearchBtn) {
        biliSearchBtn.addEventListener('click', handleCharBilibiliSearch);
        console.log("BÁ´ôÊêúÁ¥¢ÊåâÈíÆÂ∑≤ÁªëÂÆö"); // Ë∞ÉËØïÊó•Âøó
    } else {
        console.error("Êâæ‰∏çÂà∞BÁ´ôÊêúÁ¥¢ÊåâÈíÆ (char-bilibili-search-btn)ÔºåËØ∑Ê£ÄÊü•HTML ID");
    }
  const regenBiliBtn = document.getElementById('regenerate-char-bilibili-btn');
    if (regenBiliBtn) {
        regenBiliBtn.addEventListener('click', handleGenerateSimulatedBilibili);
    }
    // 2. ÁªëÂÆöÂõûËΩ¶ÈîÆÊêúÁ¥¢
    const biliInput = document.getElementById('char-bilibili-search-input');
    if (biliInput) {
        biliInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleCharBilibiliSearch();
        });
    }
const ghSwitch = document.getElementById('github-enable-switch');
    if (ghSwitch) {
        ghSwitch.addEventListener('change', (e) => {
            document.getElementById('github-settings-details').style.display = e.target.checked ? 'block' : 'none';
        });
    }

    // GitHub ÊåâÈíÆÂäüËÉΩÁªëÂÆö
    const ghUploadBtn = document.getElementById('github-upload-btn');
    if (ghUploadBtn) {
        ghUploadBtn.addEventListener('click', () => uploadToGitHub(false));
    }

    const ghDownloadBtn = document.getElementById('github-download-btn');
    if (ghDownloadBtn) {
        ghDownloadBtn.addEventListener('click', restoreFromGitHub);
    }
    const ghTokenToggle = document.getElementById('github-token-toggle');
    if (ghTokenToggle) {
        ghTokenToggle.addEventListener('click', function() {
            const input = document.getElementById('github-token');
            if (input.type === 'password') {
                input.type = 'text';
                this.textContent = 'üòå'; // ÁùÅÁúº
            } else {
                input.type = 'password';
                this.textContent = 'üßê'; // Èó≠Áúº
            }
        });
    }
document.getElementById('toggle-reading-fullscreen-btn').addEventListener('click', toggleReadingFullscreen);   
// 2. ÁªëÂÆöÁ°ÆËÆ§ÂíåÂèñÊ∂àÊåâÈíÆ‰∫ã‰ª∂ (ËØ∑Â∞ÜÊ≠§ÊÆµ‰ª£Á†ÅÊîæÂú® init() ÂáΩÊï∞‰∏≠ÔºåÊàñËÄÖËÑöÊú¨Â∫ïÈÉ®ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âå∫Âüü)
document.addEventListener('DOMContentLoaded', () => {
    // ... ÂÖ∂‰ªñÂàùÂßãÂåñ‰ª£Á†Å ...

    // ÁªëÂÆö‰∫≤Â±ûÂç°ÂºπÁ™óÊåâÈíÆ
    const cancelBtn = document.getElementById('cancel-kinship-creation-btn');
    const confirmBtn = document.getElementById('confirm-kinship-creation-btn');
    const modal = document.getElementById('kinship-creation-modal');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            modal.classList.remove('visible');
        });
    }

    if (confirmBtn) {
        confirmBtn.addEventListener('click', async () => {
            if (!selectedKinshipCharId) {
                return alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÁªëÂÆöÂØπË±°ÔºÅ");
            }

            const limitInput = document.getElementById('kinship-limit-input');
            const limit = parseFloat(limitInput.value);

            if (isNaN(limit) || limit <= 0) {
                return alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈ¢ùÂ∫¶ÔºÅ");
            }

            // Ë∞ÉÁî®ÂéüÊúâÁöÑÂèëÈÄÅÈÄªËæë
            await sendKinshipRequest(selectedKinshipCharId, limit);
            
            // ÂÖ≥Èó≠ÂºπÁ™ó
            modal.classList.remove('visible');
            
            // Â¶ÇÊûúÂΩìÂâç‰∏çÂú®ËØ•ËÅäÂ§©ÔºåÊèêÁ§∫Ë∑≥ËΩ¨
            if (state.activeChatId !== selectedKinshipCharId) {
               // sendKinshipRequest ÂÜÖÈÉ®Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜË∑≥ËΩ¨ÊàñËøΩÂä†Ê∂àÊÅØ
            }
        });
    }
});
const kinshipCancelBtn = document.getElementById('cancel-kinship-creation-btn');
    if (kinshipCancelBtn) {
        // ÂÖàÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§ç
        const newCancelBtn = kinshipCancelBtn.cloneNode(true);
        kinshipCancelBtn.parentNode.replaceChild(newCancelBtn, kinshipCancelBtn);
        
        newCancelBtn.addEventListener('click', () => {
            document.getElementById('kinship-creation-modal').classList.remove('visible');
        });
    }

    // ÁªëÂÆöÁ°ÆËÆ§Ëµ†ÈÄÅ/Áî≥ËØ∑ÊåâÈíÆ
    const kinshipConfirmBtn = document.getElementById('confirm-kinship-creation-btn');
    if (kinshipConfirmBtn) {
        const newConfirmBtn = kinshipConfirmBtn.cloneNode(true);
        kinshipConfirmBtn.parentNode.replaceChild(newConfirmBtn, kinshipConfirmBtn);

        newConfirmBtn.addEventListener('click', async () => {
            if (!selectedKinshipCharId) {
                return alert("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂØπË±°ÔºÅ");
            }

            const limitInput = document.getElementById('kinship-limit-input');
            const limit = parseFloat(limitInput.value);

            if (isNaN(limit) || limit <= 0) {
                return alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈ¢ùÂ∫¶ÔºàÂøÖÈ°ªÂ§ß‰∫é0ÔºâÔºÅ");
            }

            // --- Êñ∞Â¢ûÔºöËé∑ÂèñÈÄâÊã©ÁöÑÁ±ªÂûã ---
            const typeRadio = document.querySelector('input[name="kinship-type"]:checked');
            const type = typeRadio ? typeRadio.value : 'grant'; // ÈªòËÆ§‰∏∫Ëµ†ÈÄÅ

            // Ë∞ÉÁî®ÂèëÈÄÅÈÄªËæëÔºå‰º†ÂÖ• type
            await sendKinshipRequest(selectedKinshipCharId, limit, type);
            
            document.getElementById('kinship-creation-modal').classList.remove('visible');
            
            const actionText = type === 'grant' ? "Ëµ†ÈÄÅ" : "Áî≥ËØ∑";
            await showCustomAlert(`${actionText}ÊàêÂäü`, `‰∫≤Â±ûÂç°${actionText}Â∑≤ÂèëÈÄÅÁªôÂØπÊñπ„ÄÇ`);
        });
    }
document.getElementById('char-wallet-content').addEventListener('click', async (e) => {
    if (e.target.classList.contains('unbind-kinship-btn')) {
        e.stopPropagation();
        const chatId = e.target.dataset.chatId;
        
        // 1. ÂÖàËé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÔºåÂà§Êñ≠ÊòØË∞ÅÁªôË∞ÅÂºÄÁöÑÂç°
        const wallet = await db.userWallet.get('main');
        const card = wallet?.kinshipCards?.find(c => c.chatId === chatId);
        
        if (!card) {
            // Âç°‰∏çÂ≠òÂú®ÔºàÂèØËÉΩÊï∞ÊçÆÈîô‰π±ÔºâÔºåÁªô‰∏™ÈªòËÆ§ÊèêÁ§∫
            alert("Êú™ÊâæÂà∞ËØ•‰∫≤Â±ûÂç°ËÆ∞ÂΩï");
            return;
        }

        // 2. Ê†πÊçÆÁ±ªÂûãÂÜ≥ÂÆöÊñáÊ°à
        // Â¶ÇÊûúÊ≤°Êúâ type Â≠óÊÆµÔºàÊóßÊï∞ÊçÆÔºâÔºåÈªòËÆ§ËÆ§‰∏∫ÊòØ 'out' (ÊàëÈÄÅTA)
        const isMyGift = (card.type === 'out' || !card.type); 
        
        let title = "";
        let message = "";
        let confirmText = "";

        if (isMyGift) {
            title = "Êî∂Âõû‰∫≤Â±ûÂç°";
            message = "Á°ÆÂÆöË¶ÅÂÅúÊ≠¢‰∏∫ TA ‰π∞ÂçïÂêóÔºü\nÊî∂ÂõûÂêéÔºåÂØπÊñπÂ∞ÜÊó†Ê≥ïÂÜç‰ΩøÁî®ÊÇ®ÁöÑÈ¢ùÂ∫¶Ê∂àË¥π„ÄÇ";
            confirmText = "Á°ÆËÆ§Êî∂Âõû";
        } else {
            title = "ÈÄÄËøò‰∫≤Â±ûÂç°";
            message = "Á°ÆÂÆöË¶ÅËß£ÁªëËøôÂº†‰∫≤Â±ûÂç°ÂêóÔºü\nËß£ÁªëÂêéÔºåÊÇ®Â∞ÜÊó†Ê≥ïÂÜç‰ΩøÁî® TA ÁöÑÈ¢ùÂ∫¶Ê∂àË¥π„ÄÇ";
            confirmText = "Á°ÆËÆ§ÈÄÄËøò";
        }
        
        const confirmed = await showCustomConfirm(
            title, 
            message, 
            { confirmButtonClass: 'btn-danger', confirmText: confirmText }
        );

        if (confirmed) {
            try {
                if (wallet && wallet.kinshipCards) {
                    // ËøáÊª§ÊéâÂΩìÂâçËßíËâ≤ÁöÑÂç°
                    wallet.kinshipCards = wallet.kinshipCards.filter(c => c.chatId !== chatId);
                    await db.userWallet.put(wallet);
                    
                    await showCustomAlert("ÊàêÂäü", "‰∫≤Â±ûÂç°Â∑≤Ëß£Áªë„ÄÇ");
                    
                    // Âà∑Êñ∞ÁïåÈù¢
                    renderCharWallet();
                    
                    // 3. ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÈÄöÁü•AI (Ê†πÊçÆÊñπÂêë‰∏çÂêåÔºåÈÄöÁü•ÂÜÖÂÆπ‰πü‰∏çÂêå)
                    const chat = state.chats[chatId];
                    if(chat) {
                        let sysContent = "";
                        if (isMyGift) {
                            sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Â∑≤Êî∂Âõû‰∫ÜÁªô‰Ω†ÁöÑ‰∫≤Â±ûÂç°È¢ùÂ∫¶Ôºå‰Ω†Êó†Ê≥ïÂÜç‰ΩøÁî®‰ª£‰ªòÂäüËÉΩ‰∫Ü„ÄÇ]';
                        } else {
                            sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑‰∏ªÂä®ÈÄÄËøò/Ëß£Áªë‰∫Ü‰Ω†Ëµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°Ôºå‰∏çÂÜç‰ΩøÁî®‰Ω†ÁöÑÈí±‰∫Ü„ÄÇ]';
                        }

                        chat.history.push({
                           role: 'system',
                           content: sysContent,
                           timestamp: Date.now(),
                           isHidden: true
                        });
                        await db.chats.put(chat);
                    }
                }
            } catch (error) {
                console.error(error);
                alert("Ëß£ÁªëÂ§±Ë¥•");
            }
        }
    }
});
const alipayScreen = document.getElementById('alipay-screen');
if (alipayScreen) {
    alipayScreen.addEventListener('click', async (e) => {
        // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØ‰∏çÊòØËß£ÁªëÊåâÈíÆ
        if (e.target.classList.contains('alipay-unbind-btn')) {
            e.stopPropagation(); 
            
            const chatId = e.target.dataset.chatId;
            const chat = state.chats[chatId];
            const charName = chat ? chat.name : 'ËØ•ËßíËâ≤';

            // 1. Ëé∑ÂèñÈí±ÂåÖÊï∞ÊçÆÂà§Êñ≠ÊñπÂêë
            const wallet = await db.userWallet.get('main');
            const card = wallet?.kinshipCards?.find(c => c.chatId === chatId);
            
            if (!card) return;

            // 2. Âä®ÊÄÅÁîüÊàêÊñáÊ°à
            const isMyGift = (card.type === 'out' || !card.type);
            
            let title = "";
            let message = "";
            let confirmText = "";

            if (isMyGift) {
                title = "ÁªàÊ≠¢Ëµ†‰∫à";
                message = `Á°ÆÂÆöË¶ÅÂÅúÊ≠¢Ëµ†‰∫à‚Äú${charName}‚Äù‰∫≤Â±ûÂç°ÂêóÔºü\nËß£ÁªëÂêéÔºåÂØπÊñπÂ∞ÜÊó†Ê≥ïÂÜç‰ΩøÁî®ËØ•È¢ùÂ∫¶„ÄÇ`;
                confirmText = "Á°ÆËÆ§Êî∂Âõû";
            } else {
                title = "Ëß£Áªë‰∫≤Â±ûÂç°";
                message = `Á°ÆÂÆöË¶ÅËß£Áªë‚Äú${charName}‚ÄùËµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°ÂêóÔºü\nËß£ÁªëÂêéÔºåÊÇ®Â∞ÜÂ§±ÂéªËØ•Ê∂àË¥πÈ¢ùÂ∫¶„ÄÇ`;
                confirmText = "Á°ÆËÆ§Ëß£Áªë";
            }

            const confirmed = await showCustomConfirm(
                title, 
                message, 
                { confirmButtonClass: 'btn-danger', confirmText: confirmText }
            );

            if (confirmed) {
                try {
                    if (wallet && wallet.kinshipCards) {
                        // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§ËØ•Âç°Áâá
                        wallet.kinshipCards = wallet.kinshipCards.filter(c => c.chatId !== chatId);
                        await db.userWallet.put(wallet);
                        
                        await showCustomAlert("ÊàêÂäü", "Â∑≤ÊàêÂäüËß£Áªë‰∫≤Â±ûÂç°„ÄÇ");
                        
                        // Âà∑Êñ∞ÊîØ‰ªòÂÆùÁïåÈù¢
                        openAlipayScreen();

                        // 3. ÈÄöÁü• AI
                        if (chat) {
                            let sysContent = "";
                            if (isMyGift) {
                                sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Â∑≤Âú®ÊîØ‰ªòÂÆùÁ´ØÂçïÊñπÈù¢Êî∂Âõû‰∫ÜÁªô‰Ω†ÁöÑ‰∫≤Â±ûÂç°ÊéàÊùÉ„ÄÇ]';
                            } else {
                                sysContent = '[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Â∑≤Âú®ÊîØ‰ªòÂÆùÁ´Ø‰∏ªÂä®ÈÄÄËøò/Ëß£Áªë‰∫Ü‰Ω†Ëµ†ÈÄÅÁöÑ‰∫≤Â±ûÂç°„ÄÇ]';
                            }

                            chat.history.push({
                               role: 'system',
                               content: sysContent,
                               timestamp: Date.now(),
                               isHidden: true
                            });
                            await db.chats.put(chat);
                        }
                    }
                } catch (error) {
                    console.error(error);
                    alert("Ëß£ÁªëÊìç‰ΩúÂ§±Ë¥•");
                }
            }
        }
    });
}
document.getElementById('export-appearance-btn').addEventListener('click', exportAppearanceSettings);
// --- To-Do List Events ---
    const todoBtn = document.getElementById('open-todo-list-btn');
    if(todoBtn) todoBtn.addEventListener('click', openTodoList);
    
    document.getElementById('todo-list-back-btn').addEventListener('click', () => showScreen('chat-interface-screen'));
    
    document.getElementById('todo-prev-day-btn').addEventListener('click', () => changeTodoDate(-1));
    document.getElementById('todo-next-day-btn').addEventListener('click', () => changeTodoDate(1));
    
    document.getElementById('add-todo-btn').addEventListener('click', () => openTodoEditor(null));
    
    document.getElementById('cancel-todo-editor-btn').addEventListener('click', () => {
        document.getElementById('todo-editor-modal').classList.remove('visible');
    });
    
    document.getElementById('save-todo-btn').addEventListener('click', saveTodo);
    const todoDateDisplay = document.getElementById('todo-current-date-display');
    if (todoDateDisplay) {
        // 1. Âä®ÊÄÅÂàõÂª∫‰∏Ä‰∏™ÈöêËóèÁöÑ input[type="date"]
        const datePicker = document.createElement('input');
        datePicker.type = 'date';
        // ÈöêËóèÂÆÉÔºå‰ΩÜ‰øùÊåÅÂèØ‰∫§‰∫íÊÄß
        datePicker.style.cssText = 'position:absolute; visibility:hidden; width:0; height:0; top:0; left:0;';
        todoDateDisplay.parentNode.appendChild(datePicker); // ÊèíÂÖ•Âà∞ÂØºËà™Ê†èÈáå

        // 2. ÁÇπÂáªÊñáÂ≠ó -> Ëß¶ÂèëÈÄâÊã©Âô®
        todoDateDisplay.addEventListener('click', () => {
            // Â∞ÜÂΩìÂâçÊòæÁ§∫ÁöÑÊó•ÊúüÂêåÊ≠•ÁªôÈÄâÊã©Âô®
            datePicker.value = getTodoDateString(currentTodoDate);
            
            // Â∞ùËØïÂºπÂá∫ÂéüÁîüÊó•ÊúüÈù¢Êùø
            try {
                datePicker.showPicker(); // Áé∞‰ª£ÊµèËßàÂô® (Chrome 99+, Safari 15+)
            } catch(e) {
                datePicker.click(); // ÊóßÁâàÂÖºÂÆπ
            }
        });

        // 3. ÁõëÂê¨Êó•ÊúüÊîπÂèò
        datePicker.addEventListener('change', (e) => {
            if (e.target.value) {
                // Ëß£Êûê YYYY-MM-DD (ÈÅøÂÖçÁõ¥Êé• new Date() Â∏¶Êù•ÁöÑÊó∂Âå∫ÂÅèÂ∑ÆÈóÆÈ¢ò)
                const [y, m, d] = e.target.value.split('-').map(Number);
                // ÊûÑÈÄ†Êú¨Âú∞Êó∂Èó¥ÂØπË±°
                currentTodoDate = new Date(y, m - 1, d);
                
                // Âà∑Êñ∞ÁïåÈù¢
                updateTodoDateDisplay();
                renderTodoList();
            }
        });
    }
    // Á±ªÂûãÈÄâÊã©Âô®ÁÇπÂáª‰∫ã‰ª∂
    const typeOptions = document.querySelectorAll('.todo-type-option');
    typeOptions.forEach(opt => {
        opt.addEventListener('click', () => {
            typeOptions.forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
        });
    });
// --- Âú® init() ÂáΩÊï∞ÂÜÖÈÉ®ÁöÑ‰∫ã‰ª∂ÁªëÂÆöÂå∫ÂüüÊ∑ªÂä† ---

    // 1. ÈïøÊúüËÆ∞ÂøÜÂàóË°®ÊªöÂä®ÁõëÂê¨
    const memoryListContainer = document.getElementById('memory-list-container');
    if (memoryListContainer) {
        memoryListContainer.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = memoryListContainer;
            // Ë∑ùÁ¶ªÂ∫ïÈÉ® 50px Êó∂Ëß¶ÂèëÂä†ËΩΩ
            if (scrollHeight - scrollTop <= clientHeight + 50) {
                loadMoreMemories();
            }
        });
    }

    // 2. ÂæÖÂäû‰∫ãÈ°πÂàóË°®ÊªöÂä®ÁõëÂê¨
    const todoListContainer = document.getElementById('todo-list-container');
    if (todoListContainer) {
        todoListContainer.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = todoListContainer;
            if (scrollHeight - scrollTop <= clientHeight + 50) {
                loadMoreTodos();
            }
        });
    }
// ÁªëÂÆöÈÇÆÁÆ±Â∫ïÈÉ®ÊåâÈíÆ‰∫ã‰ª∂
const deleteSelectedBtn = document.getElementById('mail-delete-selected-btn');
if (deleteSelectedBtn) {
    deleteSelectedBtn.addEventListener('click', executeBatchDeleteEmails);
}

const selectAllBtn = document.getElementById('mail-select-all-btn');
if (selectAllBtn) {
    selectAllBtn.addEventListener('click', handleSelectAllEmails);
}
    document.getElementById('manage-rules-btn').addEventListener('click', toggleRuleManagementMode);
    document.getElementById('import-rules-btn').addEventListener('click', () => {
        document.getElementById('import-rules-input').click();
    });
    document.getElementById('import-rules-input').addEventListener('change', handleRulesImport);

    // 2. Â∫ïÈÉ®Êìç‰ΩúÊ†èÊåâÈíÆ
    document.getElementById('select-all-rules-checkbox').addEventListener('change', handleSelectAllRules);
    document.getElementById('export-selected-rules-btn').addEventListener('click', exportSelectedRules);
    document.getElementById('delete-selected-rules-btn').addEventListener('click', deleteSelectedRules);
// ... Âú® init() ÂáΩÊï∞ÂÜÖ ...
const redditSearchBtn = document.getElementById('char-reddit-search-btn');
if (redditSearchBtn) {
    redditSearchBtn.addEventListener('click', () => {
        const query = document.getElementById('char-reddit-search-input').value.trim();
        handleRedditSearch(query);
    });
}

// ÁªëÂÆöÂõûËΩ¶ÊêúÁ¥¢
const redditInput = document.getElementById('char-reddit-search-input');
if (redditInput) {
    redditInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
             const query = e.target.value.trim();
             handleRedditSearch(query);
        }
    });
}
const regenRedditBtn = document.getElementById('regenerate-char-reddit-btn');
if (regenRedditBtn) {
    regenRedditBtn.addEventListener('click', handleGenerateSimulatedReddit);
}
document.getElementById('nai-preset-select').addEventListener('change', handleNaiPresetChange);
    document.getElementById('save-nai-preset-btn').addEventListener('click', () => handleSaveNaiPreset(false));
    document.getElementById('update-nai-preset-btn').addEventListener('click', () => handleSaveNaiPreset(true));
    document.getElementById('delete-nai-preset-btn').addEventListener('click', handleDeleteNaiPreset);
    document.getElementById('bind-nai-preset-btn').addEventListener('click', openNaiBindingModal);
    
    document.getElementById('save-nai-binding-btn').addEventListener('click', saveNaiBinding);
    document.getElementById('cancel-nai-binding-btn').addEventListener('click', () => {
        document.getElementById('nai-binding-modal').classList.remove('visible');
    });
document.getElementById('manage-quick-reply-categories-btn').addEventListener('click', openQuickReplyCategoryManager);
    
    // 2. ÁªëÂÆöÂàÜÁ±ªÁÆ°ÁêÜÂô®ÂÜÖÁöÑÊåâÈíÆ
    document.getElementById('add-new-quick-reply-category-btn').addEventListener('click', addNewQuickReplyCategory);
    document.getElementById('close-quick-reply-category-manager-btn').addEventListener('click', () => {
        document.getElementById('quick-reply-category-manager-modal').classList.remove('visible');
        renderQuickReplyList(true); // ÂÖ≥Èó≠Êó∂Âà∑Êñ∞‰∏ªÂàóË°®ÁöÑTabs
    });
// --- Sticker Batch Move (Ë°®ÊÉÖÂåÖÊâπÈáèÁßªÂä®) ---
const stickerMoveBtn = document.getElementById('move-selected-stickers-btn');
if (stickerMoveBtn) {
    stickerMoveBtn.addEventListener('click', executeBatchMoveStickers);
}

// --- Quick Reply Management (Âø´Êç∑ÂõûÂ§çÁÆ°ÁêÜ) ---
const batchQuickReplyBtn = document.getElementById('batch-quick-reply-btn');
if (batchQuickReplyBtn) {
    batchQuickReplyBtn.addEventListener('click', toggleQuickReplyManagementMode);
}

const selectAllQuickRepliesCb = document.getElementById('select-all-quick-replies-checkbox');
if (selectAllQuickRepliesCb) {
    selectAllQuickRepliesCb.addEventListener('change', handleSelectAllQuickReplies);
}

const moveQuickRepliesBtn = document.getElementById('move-selected-quick-replies-btn');
if (moveQuickRepliesBtn) {
    moveQuickRepliesBtn.addEventListener('click', executeBatchMoveQuickReplies);
}

const deleteQuickRepliesBtn = document.getElementById('delete-selected-quick-replies-btn');
if (deleteQuickRepliesBtn) {
    deleteQuickRepliesBtn.addEventListener('click', executeBatchDeleteQuickReplies);
}


   
    initLockScreen();
    checkForUpdates();
    updateLockedFeatureUI();
    showScreen('home-screen');
  }

    (function preloadLoginResources() {
    if (!document.getElementById('google-fonts-login')) {
        const link = document.createElement('link');
        link.id = 'google-fonts-login';
        link.rel = 'stylesheet';
        link.href = "https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Manrope:wght@200..800&display=swap";
        document.head.appendChild(link);
    }
})();

function renderLoginOverlay() {
    // Èò≤Ê≠¢ÈáçÂ§çÁîüÊàê
    if (document.getElementById('login-overlay')) return;

    // ÈöêËóè‰∏ªÁïåÈù¢ÔºåÈò≤Ê≠¢ÈÄèËßÜ
    const phoneScreen = document.getElementById('phone-screen');
    if (phoneScreen) phoneScreen.style.display = 'none';

    // ------------------------------------------------
    // 1. Ê≥®ÂÖ•ÂéüÁîü CSS Ê†∑Âºè (Êõø‰ª£ Tailwind)
    // ------------------------------------------------
    const cssId = 'login-overlay-css';
    if (!document.getElementById(cssId)) {
        const style = document.createElement('style');
        style.id = cssId;
        style.innerHTML = `
            /* ÂÆπÂô®‰∏éËÉåÊôØ */
            #login-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999;
                display: flex; flex-direction: column;
                background-color: #111121; color: white;
                font-family: 'Manrope', sans-serif; overflow: hidden;
            }
            .login-bg-layer {
                position: absolute; inset: 0; z-index: 0; opacity: 0.4;
                filter: grayscale(100%); pointer-events: none;
            }
            .login-bg-img {
                width: 100%; height: 100%;
                background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAy7HDW6Sj7_PV8DuFLN7iIzQnKa-QOTeZj9ymne8KHPU5oTT2PVaBgaSmbPZVLo1Qh5ZSETw9LO1opxFPK6zklVf4GQoCT6jcMJlNkiv68eVUny606wq_xxMO9ZWeTSIBq3JjD8-szBVkVELYnzrYgi3vxXQb3-GBuVKvjgK01B4F3XgYZe6qgnbkRQS5cSfoFYGmJI-X8MvexmUvNJUYTK7lwo9mWbFKRo0d84VbFSZ29G7N0QkRUBmP4ovtv4TgyYQFkQpzcVJc");
                background-size: cover; background-position: center;
            }
            .login-bg-gradient {
                position: absolute; inset: 0;
                background: linear-gradient(to bottom, rgba(17,17,33,0.8), transparent, #111121);
            }

            /* È°∂ÈÉ®Ë£ÖÈ•∞ */
            .login-top-bar {
                position: relative; z-index: 10; display: flex; justify-content: flex-end; padding: 24px;
            }
            .login-sys-text {
                font-size: 10px; font-weight: 700; letter-spacing: 0.3em; text-transform: uppercase; opacity: 0.6;
            }

            /* ‰∏ªÂÜÖÂÆπÂå∫ */
            .login-main {
                position: relative; z-index: 10; flex: 1; display: flex; flex-direction: column;
                justify-content: center; padding: 16px 32px 48px 32px;
            }

            /* Ê†áÈ¢ò */
            .login-title-area { text-align: center; margin-bottom: 48px; }
            .login-subtitle {
                font-size: 10px; letter-spacing: 0.5em; text-transform: uppercase; color: rgba(255,255,255,0.5); margin-bottom: 16px;
            }
            .login-title {
                font-family: 'Playfair Display', serif; font-size: 72px; font-weight: 300;
                line-height: 1; letter-spacing: -0.05em; text-transform: none; margin: 0;
            }
            .login-divider {
                width: 48px; height: 1px; background-color: rgba(255,255,255,0.3); margin: 24px auto 0 auto;
            }

            /* ÁéªÁíÉÂç°Áâá */
            .login-glass-box {
                padding: 32px; border-radius: 12px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                margin: 0 auto; width: 100%; max-width: 380px;
                background: rgba(17, 17, 33, 0.85);
                backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                box-sizing: border-box;
            }
            .login-box-header {
                font-size: 12px; font-weight: 700; letter-spacing: 0.2em;
                text-transform: uppercase; margin-bottom: 40px; text-align: center;
            }

            /* ËæìÂÖ•Ê°ÜÁªÑ */
            .login-form-group { position: relative; margin-bottom: 32px; }
            .login-label {
                display: block; font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
                text-transform: uppercase; color: rgba(255,255,255,0.4); margin-bottom: 4px;
                transition: color 0.2s;
            }
            .login-form-group:focus-within .login-label { color: white; }
            
            .login-input {
                width: 100%; background: transparent;
                border: none; border-bottom: 1px solid rgba(255,255,255,0.2);
                padding: 12px 0; font-size: 14px; color: white;
                outline: none; transition: border-color 0.2s;
                border-radius: 0; /* ÁßªÈô§iOSÈªòËÆ§ÂúÜËßí */
            }
            .login-input:focus { border-bottom-color: white; }
            .login-input::placeholder { color: rgba(255,255,255,0.1); }

            /* ÁúºÁùõÂõæÊ†á */
            .pwd-toggle {
                position: absolute; right: 0; bottom: 12px;
                color: rgba(255,255,255,0.4); cursor: pointer; transition: color 0.2s;
            }
            .pwd-toggle:hover { color: white; }
            .pwd-toggle span { font-size: 18px; }

            /* ÊåâÈíÆ */
            .login-btn-container { padding-top: 16px; }
            .login-btn {
                position: relative; width: 100%; display: flex; align-items: center; justify-content: center;
                background-color: white; color: black;
                padding: 16px 0; border: none; border-radius: 2px;
                font-size: 11px; font-weight: 700; letter-spacing: 0.3em; text-transform: uppercase;
                cursor: pointer; transition: all 0.2s;
            }
            .login-btn:hover { background-color: #e5e5e5; }
            .login-btn:active { transform: scale(0.98); }
            .login-btn-arrow {
                position: absolute; right: 24px; font-size: 16px; transition: transform 0.2s;
            }
            .login-btn:hover .login-btn-arrow { transform: translateX(4px); }

            /* ÈîôËØØ‰ø°ÊÅØ‰∏éÂ∫ïÈÉ®ÈìæÊé• */
            .login-error-area { margin-top: 24px; text-align: center; min-height: 20px; }
            .login-error-msg { font-size: 11px; letter-spacing: 0.05em; color: #f87171; margin: 0;}
            
            .login-footer-links { margin-top: 48px; text-align: center; }
            .login-footer-text { font-size: 12px; color: rgba(255,255,255,0.5); }
            .login-link {
                color: white; font-weight: 700; letter-spacing: 0.05em; text-decoration: none;
                border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 2px; margin-left: 4px;
                transition: border-color 0.2s;
            }
            .login-link:hover { border-bottom-color: white; }

            /* Â∫ïÈÉ®Ë£ÖÈ•∞ */
            .login-bottom-deco {
                position: relative; z-index: 10; display: flex; justify-content: center; padding-bottom: 32px;
            }
            .login-deco-line { width: 32px; height: 1px; background-color: white; opacity: 0.3; }
            .login-deco-icon {
                font-size: 12px; margin: 0 16px; opacity: 0.3; display: flex; align-items: center;
            }

            /* Âä®Áîª */
            .pulse { animation: pulse-anim 1.5s infinite; }
            @keyframes pulse-anim {
                0%, 100% { opacity: 1; } 50% { opacity: 0.5; }
            }
        `;
        document.head.appendChild(style);
    }

    // 2. ÂàõÂª∫ DOM
    const overlay = document.createElement('div');
    overlay.id = 'login-overlay';

    overlay.innerHTML = `
        <div class="login-bg-layer">
            <div class="login-bg-img"></div>
            <div class="login-bg-gradient"></div>
        </div>

        <div class="login-top-bar">
            <div class="login-sys-text">System Ver. 4.0 / Secure</div>
        </div>

        <div class="login-main">
            <div class="login-title-area">
                <p class="login-subtitle">Virtual Communication Interface</p>
                <h1 class="login-title">EPhone</h1>
                <div class="login-divider"></div>
            </div>

            <div class="login-glass-box">
                <h2 class="login-box-header">Identity Verification</h2>
                
                <div class="login-form-group">
                    <label class="login-label">Account ID</label>
                    <input type="text" id="login-uid" class="login-input" placeholder="Enter your Discord ID" autocomplete="off" />
                </div>

                <div class="login-form-group">
                    <label class="login-label">Passcode</label>
                    <input type="password" id="login-pwd" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    <div class="pwd-toggle" id="toggle-pwd-btn">
                        <span class="material-symbols-outlined">visibility</span>
                    </div>
                </div>

                <div class="login-btn-container">
                    <button id="btn-login-submit" class="login-btn">
                        Connect
                        <span class="material-symbols-outlined login-btn-arrow">arrow_forward</span>
                    </button>
                </div>

                <div class="login-error-area">
                    <p id="login-msg" class="login-error-msg"></p>
                </div>
            </div>

            <div class="login-footer-links">
                <p class="login-footer-text">
                    No access key? 
                    <a class="login-link" href="#" onclick="alert('ËØ∑Âú® Discord ËæìÂÖ• /login Ëé∑ÂèñË¥¶Âè∑ÔºåÂ¶ÇÊûúÊú™ÂºπÂá∫ÔºåÂàôËØ∑Êõ¥Êñ∞DiscordÔºåËØ∑‰∏çË¶ÅÊö¥Èú≤‰Ω†ÁöÑË¥¶Âè∑‰ª•ÂèäÂØÜÁ†Å'); return false;">
                        Get from Discord
                    </a>
                </p>
            </div>
        </div>

        <div class="login-bottom-deco">
            <div style="display:flex; align-items:center;">
                <div class="login-deco-line"></div>
                <div class="login-deco-icon"><span class="material-symbols-outlined" style="font-size:12px;">auto_awesome</span></div>
                <div class="login-deco-line"></div>
            </div>
        </div>
    `;

    document.body.prepend(overlay);

    // 3. ÁªëÂÆöÈÄªËæë
    const tryLoginHandler = () => {
        const btn = document.getElementById('btn-login-submit');
        // ÁÆÄÂçïÁöÑ CSS Âä®ÁîªÂàáÊç¢
        btn.innerHTML = `<span class="pulse">CONNECTING...</span>`;
        setTimeout(tryLogin, 300);
    };

    document.getElementById('btn-login-submit').onclick = tryLoginHandler;
    
    document.getElementById('login-pwd').onkeypress = function(e) {
        if (e.key === 'Enter') tryLoginHandler();
    };
    
    document.getElementById('login-uid').onkeypress = function(e) {
        if (e.key === 'Enter') document.getElementById('login-pwd').focus();
    };

    const toggleBtn = document.getElementById('toggle-pwd-btn');
    const pwdInput = document.getElementById('login-pwd');
    toggleBtn.onclick = () => {
        const type = pwdInput.getAttribute('type') === 'password' ? 'text' : 'password';
        pwdInput.setAttribute('type', type);
        toggleBtn.querySelector('span').textContent = type === 'password' ? 'visibility' : 'visibility_off';
    };

    setTimeout(() => document.getElementById('login-uid').focus(), 100);
}

    // 2. È™åËØÅ‰∏éÂêØÂä®ÂáΩÊï∞
    function tryLogin() {
        // Ëé∑ÂèñÂÖÉÁ¥†
        const uidEl = document.getElementById('login-uid');
        const pwdEl = document.getElementById('login-pwd');
        const msgEl = document.getElementById('login-msg');

        // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÂ¶ÇÊûúÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºàÊØîÂ¶ÇËøòÊ≤°Ê∏≤ÊüìÔºâÔºåÁõ¥Êé•ËøîÂõûÔºåÈò≤Ê≠¢Êä•Èîô
        if (!uidEl || !pwdEl) {
            console.error("Êâæ‰∏çÂà∞ÁôªÂΩïËæìÂÖ•Ê°ÜÔºåËØ∑Âà∑Êñ∞È°µÈù¢");
            return;
        }

        const uid = uidEl.value.trim();
        const pwd = pwdEl.value.trim();

        if (!uid || !pwd) {
            msgEl.textContent = "ËØ∑ËæìÂÖ•ÂÆåÊï¥ÁöÑË¥¶Âè∑ÂíåÂØÜÁ†Å";
            return;
        }

        // È™åËØÅÈÄªËæë
        if (verifyLogin(uid, pwd)) {
            msgEl.style.color = "#32d74b";
            msgEl.textContent = "È™åËØÅÈÄöËøáÔºåÊ≠£Âú®ËøõÂÖ•...";

            try {
                // ‰øùÂ≠òÁôªÂΩïÁä∂ÊÄÅ
                localStorage.setItem('ephone_saved_uid', uid);

                // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„Äë‰ΩøÁî®Âõ∫ÂÆöÊï∞ÊçÆÂ∫ìÂêçÔºåÊâæÂõû‰Ω†ÁöÑÊóßÊï∞ÊçÆ
                // Á°Æ‰øù script.js ‰∏äÊñπÁöÑ initDatabase ÂáΩÊï∞ÈáåÂÜôÁöÑÊòØ db = new Dexie('GeminiChatDB');
                initDatabase(uid);
                
                // ÁßªÈô§ÈÅÆÁΩ©
                const overlay = document.getElementById('login-overlay');
                if (overlay) {
                    overlay.style.transition = 'opacity 0.5s ease';
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.remove(), 500);
                }
 const phoneScreen = document.getElementById('phone-screen');
                if (phoneScreen) phoneScreen.style.display = 'flex'; 
                
                // ÂêØÂä® App
                init(); 
                
            } catch (e) {
                console.error(e);
                msgEl.style.color = "#ff453a";
                msgEl.textContent = "ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï";
            }
        } else {
            msgEl.style.color = "#ff453a";
            msgEl.textContent = "Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØ";
            const btn = document.getElementById('btn-login-submit');
            btn.style.background = "#ff453a";
            setTimeout(() => btn.style.background = "#007aff", 500);
        }
    }

    // ==========================================
    // ‚ñº‚ñº‚ñº Ëá™Âä®ÁôªÂΩïÂà§Êñ≠ (‰∏ªÂÖ•Âè£) ‚ñº‚ñº‚ñº
    // ==========================================
    
    // Ê£ÄÊü•Êú¨Âú∞ÊòØÂê¶Â∑≤ÁôªÂΩï
    const savedUid = localStorage.getItem('ephone_saved_uid');

    if (savedUid) {
        console.log(`[Auto Login] Ê£ÄÊµãÂà∞Â∑≤ÁôªÂΩïË¥¶Âè∑: ${savedUid}`);
        try {
            // Â∑≤ÁôªÂΩïÔºöÁõ¥Êé•ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ìÂπ∂ÂêØÂä®Ôºå‰∏çÊòæÁ§∫ÁôªÂΩïÊ°Ü
            initDatabase(savedUid);
            init(); 
        } catch (e) {
            console.error("Ëá™Âä®ÁôªÂΩïÂá∫ÈîôÔºåÈáçÁΩÆÁä∂ÊÄÅ:", e);
            localStorage.removeItem('ephone_saved_uid');
            renderLoginOverlay();
        }
    } else {
        // Êú™ÁôªÂΩïÔºöÊòæÁ§∫ÁôªÂΩïÊ°Ü
        renderLoginOverlay();
    }
    
    // ==========================================
    // ‚ñº‚ñº‚ñº ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
    // ==========================================
    // ÊîæÂú®‰∏Ä‰∏™ÂÆöÊó∂Âô®ÈáåÔºåÁ°Æ‰øù logout-btn Â∑≤ÁªèÂä†ËΩΩÂá∫Êù•
    setTimeout(() => {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            // ÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô®Èò≤Ê≠¢ÈáçÂ§ç
            const newBtn = logoutBtn.cloneNode(true);
            logoutBtn.parentNode.replaceChild(newBtn, logoutBtn);
            
            newBtn.addEventListener('click', async () => {
                // ‰ΩøÁî®ÂéüÁîüÁöÑ confirmÔºåÈò≤Ê≠¢ showCustomConfirm Ê≤°Âä†ËΩΩ
                if (confirm("Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü")) {
                    localStorage.removeItem('ephone_saved_uid');
                    window.location.reload();
                }
            });
        }
    }, 1000);

}); // DOMContentLoaded ÁªìÊùü



// ==================== Ë°®ÊÉÖÂåÖÂäüËÉΩÁßªÊ§çÂå∫ ====================

// ÊâìÂºÄ/ÂÖ≥Èó≠È°µÈù¢
function openStickerPage() {
    const page = document.getElementById('stickerPage');
    if (page) page.classList.add('active');
}
function closeStickerPage() {
    const page = document.getElementById('stickerPage');
    if (page) page.classList.remove('active');
}

// Ë°®ÊÉÖÂåÖÂ≠òÂÇ®ÁÆÄÊòìÂÆûÁé∞ (Â¶ÇÊûúÁ≥ªÁªüÊú™Êèê‰æõ)
if (typeof window.getMyEmojis === 'undefined') {
    window.getMyEmojis = function() {
        try {
            return JSON.parse(localStorage.getItem('my_emojis') || '[]');
        } catch (e) { return []; }
    };
}
if (typeof window.saveMyEmojis === 'undefined') {
    window.saveMyEmojis = function(emojis) {
        localStorage.setItem('my_emojis', JSON.stringify(emojis));
    };
}

// ========== NovelAI ÂõæÂÉèÁîüÊàêÊ†∏ÂøÉÂáΩÊï∞ (ÈáçÂëΩÂêç‰ª•ÈÅøÂÖçÂÜ≤Á™Å) ==========
async function callNovelAIAPI(userPrompt, rolePrompt = '', isTest = false, referenceImage = null, options = {}) {
    try {
        const apiKey = localStorage.getItem('novelaiApiKey') || '';
        const proxyUrl = localStorage.getItem('novelaiProxyUrl') || 'https://image.novelai.net/ai/generate-image';
        let model = localStorage.getItem('novelai-model') || 'nai-diffusion-4-5-full'; // ‰øÆÂ§çÔºö‰ΩøÁî®Ê≠£Á°ÆÁöÑÈîÆÂêç
        
        if (model === 'nai-diffusion-3-inpainting') model = 'nai-diffusion-3';
        
        const steps = parseInt(localStorage.getItem('novelaiSteps')) || 28;
        const scale = parseFloat(localStorage.getItem('novelaiScale')) || 5;
        const sampler = localStorage.getItem('novelaiSampler') || 'k_euler';
        const size = options.size || localStorage.getItem('novelaiSize') || '832x1216';
        
        let systemPrompt = localStorage.getItem('novelaiSystemPrompt') || 'masterpiece, best quality, highres, 1girl, solo, anime style, detailed, beautiful, cute';
        if (options.skipSystemPrompt) systemPrompt = '';

        let negativePrompt = localStorage.getItem('novelaiNegativePrompt') || 'lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry';
        if (options.extraNegativePrompt) negativePrompt += ', ' + options.extraNegativePrompt;
        
        if (!apiKey) return { success: false, error: 'ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ NovelAI API Key' };
        if (!userPrompt || !userPrompt.trim()) return { success: false, error: 'ËØ∑ËæìÂÖ•ÁîüÊàêÂõæÂÉèÁöÑÊèèËø∞' };
        
        let finalPrompt = systemPrompt.trim();
        if (rolePrompt && rolePrompt.trim()) {
            if (finalPrompt) finalPrompt += ', ';
            finalPrompt += rolePrompt.trim();
        }
        if (userPrompt && userPrompt.trim()) {
            if (finalPrompt) finalPrompt += ', ';
            finalPrompt += userPrompt.trim();
        }
        
        const [width, height] = size.split('x').map(Number);
        const isV4 = model.includes('nai-diffusion-4');
        
        let apiUrl = proxyUrl;
        if (!proxyUrl || proxyUrl.includes('novelai.net')) {
             apiUrl = isV4 ? 'https://image.novelai.net/ai/generate-image-stream' : 'https://image.novelai.net/ai/generate-image';
        }
        
        let requestBody;
        if (isV4) {
            requestBody = {
                input: finalPrompt, model: model, action: 'generate',
                parameters: {
                    params_version: 3, width: width, height: height, scale: scale, sampler: sampler, steps: steps,
                    seed: Math.floor(Math.random() * 9999999999), n_samples: 1, ucPreset: 0, qualityToggle: true,
                    autoSmea: false, dynamic_thresholding: false, controlnet_strength: 1, legacy: false,
                    add_original_image: true, cfg_rescale: 0, noise_schedule: 'karras', legacy_v3_extend: false,
                    skip_cfg_above_sigma: null, use_coords: false, legacy_uc: false,
                    normalize_reference_strength_multiple: true, inpaintImg2ImgStrength: 1, characterPrompts: [],
                    v4_prompt: { caption: { base_caption: finalPrompt, char_captions: [] }, use_coords: false, use_order: true },
                    v4_negative_prompt: { caption: { base_caption: negativePrompt.trim(), char_captions: [] }, legacy_uc: false },
                    negative_prompt: negativePrompt.trim(), deliberate_euler_ancestral_bug: false, prefer_brownian: true
                }
            };
            if (referenceImage) {
                const base64Data = referenceImage.includes(',') ? referenceImage.split(',')[1] : referenceImage;
                requestBody.parameters.reference_image = base64Data;
                requestBody.parameters.reference_strength = options.referenceStrength || 0.6; // ‰ΩøÁî®Ëá™ÂÆö‰πâÂº∫Â∫¶
                requestBody.parameters.reference_information_extracted = 1;
            }
        } else {
            requestBody = {
                input: finalPrompt, model: model, action: 'generate',
                parameters: {
                    width: width, height: height, scale: scale, sampler: sampler, steps: steps,
                    seed: Math.floor(Math.random() * 9999999999), n_samples: 1, ucPreset: 0, qualityToggle: true,
                    sm: false, sm_dyn: false, dynamic_thresholding: false, controlnet_strength: 1, legacy: false,
                    add_original_image: false, cfg_rescale: 0, noise_schedule: 'native', negative_prompt: negativePrompt.trim()
                }
            };
            if (referenceImage) {
                const base64Data = referenceImage.includes(',') ? referenceImage.split(',')[1] : referenceImage;
                requestBody.parameters.reference_image = base64Data;
                requestBody.parameters.reference_strength = options.referenceStrength || 0.6; // ‰ΩøÁî®Ëá™ÂÆö‰πâÂº∫Â∫¶
            }
        }
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify(requestBody)
        });
        
        // --- Ê†∏ÂøÉË∞ÉËØïÊó•Âøó ---
        console.log(`[NovelAI] Response Status: ${response.status}`);
        const responseClone = response.clone(); // ÂÖãÈöÜ‰∏Ä‰ªΩÁî®‰∫éËØªÂèñÊñáÊú¨Ôºå‰∏çÂΩ±ÂìçÂêéÁª≠Â§ÑÁêÜ
        try {
            const rawText = await responseClone.text();
            console.log(`[NovelAI] Raw Response Preview (first 500 chars):`, rawText.substring(0, 500));
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÂÖ∑‰ΩìÁöÑÈîôËØØ‰ø°ÊÅØ
            if (!response.ok) {
                try {
                    const errJson = JSON.parse(rawText);
                    if (errJson.message) return { success: false, error: `API Error: ${errJson.message}` };
                    if (errJson.error) return { success: false, error: `API Error: ${errJson.error}` };
                } catch (e) {
                    return { success: false, error: `HTTP ${response.status}: ${rawText.substring(0, 100)}` };
                }
            }
        } catch (e) {
            console.warn("Êó†Ê≥ïËØªÂèñÂéüÂßãÂìçÂ∫îÊñáÊú¨", e);
        }
        // --------------------
        
        if (!response.ok) {
            const errorText = await response.text();
            return { success: false, error: `HTTP ${response.status}: ${errorText}` };
        }
        
        const contentType = response.headers.get('content-type');
        let imageDataUrl = null;
        
        if (contentType && (contentType.includes('text/event-stream') || contentType.includes('application/x-ndjson'))) {
            const text = await response.text();
            const lines = text.trim().split('\n');
            let base64Data = null;
            let imageUrl = null;

            for (let i = lines.length - 1; i >= 0; i--) {
                const line = lines[i].trim();
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    const dataContent = line.substring(6);
                    try {
                        const jsonData = JSON.parse(dataContent);
                        // 1. ‰ºòÂÖàÊ£ÄÊü• URL
                        if (jsonData.output && Array.isArray(jsonData.output) && jsonData.output[0] && jsonData.output[0].url) {
                             imageUrl = jsonData.output[0].url;
                             break;
                        }
                        if (jsonData.url) {
                            imageUrl = jsonData.url;
                            break;
                        }
                        
                        // 2. Ê£ÄÊü• base64
                        if (jsonData.event_type === 'final' && jsonData.image) { base64Data = jsonData.image; break; }
                        if (jsonData.data) { base64Data = jsonData.data; break; }
                        if (jsonData.image) { base64Data = jsonData.image; break; }
                    } catch (e) { 
                         // Â∞ùËØïÁõ¥Êé•ËØªÂèñÂÜÖÂÆπ
                         base64Data = dataContent; 
                         break; 
                    }
                }
            }
            
            if (imageUrl) {
                 imageDataUrl = imageUrl;
            } else if (base64Data) {
                 if (base64Data.startsWith('http')) {
                    imageDataUrl = base64Data;
                 } else if (base64Data.startsWith('iVBOR') || base64Data.startsWith('/9j/')) {
                    imageDataUrl = `data:image/${base64Data.startsWith('iVBOR') ? 'png' : 'jpeg'};base64,${base64Data}`;
                } else {
                    try {
                        const binaryString = atob(base64Data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                        imageDataUrl = await extractImageFromZip(new Blob([bytes]));
                    } catch(e) {
                         // Â¶ÇÊûúËß£ÂéãÂ§±Ë¥•ÔºåÂèØËÉΩÊòØ raw base64
                         imageDataUrl = `data:image/png;base64,${base64Data}`;
                    }
                }
            } else {
                 return { success: false, error: 'Êó†Ê≥ï‰ªé SSE ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆÊàñURL' };
            }

        } else if (contentType && contentType.includes('application/json')) {
             // Â§ÑÁêÜÈùû SSE ÁöÑ JSON ÂìçÂ∫î
             const jsonData = await response.json();
             if (jsonData.output && Array.isArray(jsonData.output) && jsonData.output[0] && jsonData.output[0].url) {
                 imageDataUrl = jsonData.output[0].url;
             } else if (jsonData.url) {
                 imageDataUrl = jsonData.url;
             } else {
                 // Â∞ùËØïÊü•Êâæ base64
                 let base64Data = jsonData.image || jsonData.data;
                 if (base64Data) {
                    if (base64Data.startsWith('iVBOR') || base64Data.startsWith('/9j/')) {
                        imageDataUrl = `data:image/${base64Data.startsWith('iVBOR') ? 'png' : 'jpeg'};base64,${base64Data}`;
                    } else {
                         // ÂÅáËÆæÊòØ zip base64
                        const binaryString = atob(base64Data);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                        imageDataUrl = await extractImageFromZip(new Blob([bytes]));
                    }
                 } else {
                     return { success: false, error: 'Êó†Ê≥ï‰ªé JSON ÂìçÂ∫î‰∏≠ÊèêÂèñÂõæÁâáÊï∞ÊçÆÊàñURL' };
                 }
             }
        } else {
            // ÈªòËÆ§‰∏∫ Blob (ZIP)
            const zipBlob = await response.blob();
            imageDataUrl = await extractImageFromZip(zipBlob);
        }
        
        return { success: true, imageUrl: imageDataUrl };
    } catch (error) {
        return { success: false, error: error.message || 'ÁΩëÁªúÈîôËØØ' };
    }
}

async function extractImageFromZip(zipBlob) {
    if (typeof JSZip === 'undefined') {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(zipBlob);
        });
    }
    try {
        const zip = await JSZip.loadAsync(zipBlob);
        let imageFile = null;
        for (const filename in zip.files) {
            if (filename.match(/\.(png|jpg|jpeg|webp)$/i)) {
                imageFile = zip.files[filename];
                break;
            }
        }
        if (!imageFile) throw new Error('ZIPÊñá‰ª∂‰∏≠Êú™ÊâæÂà∞ÂõæÁâá');
        const imageBlob = await imageFile.async('blob');
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(imageBlob);
        });
    } catch (error) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(zipBlob);
        });
    }
}

// ========== Ë°®ÊÉÖÂåÖÁîüÊàêÂäüËÉΩ ==========

const STICKER_BUILTIN_PROMPT = 'Q-style LINE sticker pack, hand-drawn texture, soft low-saturation macaron color palette, pure white background. Line features: Clear, smooth black outlines with uniform thickness and rounded edges. Expression design: 3√ó3 grid layout, 9 independent bust stickers with exaggerated, cute movements that match text labels exactly, covering daily high-frequency emotions (happy, surprised, speechless, sleepy, etc.). Text labels: Only use sharp, clear English text (e.g., "OK!", "NO!", "THANKS!", "SORRY!") with a round, cute font. Text must be edge-sharp, no blurring, no garbled characters, no jagged edges. Detail optimization: High contrast, distinct color layers, no noise, consistent healing art style, suitable for chat app stickers.';
let currentStickerImageUrl = null;
async function generateSticker() {
    const btn = document.getElementById('generateStickerBtn');
    const btnText = document.getElementById('generateStickerBtnText');
    const statusDiv = document.getElementById('stickerGenerateStatus');
    const textInput = document.getElementById('stickerTextInput');
    
    const apiKey = localStorage.getItem('novelaiApiKey');
    if (!apiKey) { alert('ËØ∑ÂÖàÂú®Á≥ªÁªüËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ NovelAI API Key'); return; }
    
    const userInstruction = textInput.value.trim();
    const subjectContent = userInstruction || "a cute anime character";
    const subjectDescriptor = `The main subject of the image is exactly the following character description:\n„Äå${subjectContent}„Äç\nThis description defines the character's appearance and identity and must be respected.`;
    const structureDeclaration = "The image consists of exactly 9 panels arranged in a 3x3 grid. Each panel contains the same character but in a DIFFERENT pose and emotion. The grid must showcase a wide range of variety: happy, sad, angry, surprised, sleeping, eating, thinking, holding items, dynamic actions. character sheet, multiple views, chibi, sticker set.";
    const panelMandate = "Every panel must contain a character doing a unique action. No two panels should look the same. Avoid repetitive poses. Avoid portrait only. full body or upper body. textless, no text, no captions, no speech bubbles. The character should have expressive reactions suitable for adding text later.";
    const styleRules = "meme format, expressive reactions, exaggerated facial expressions, reaction-based composition, LINE sticker style, bold outlines, flat colors, simple shapes, clear silhouette, simple background, pure white background, readable at small size";
    const colorRule = "fully colored, clean coloring, anime cel shading, high contrast, consistent color palette";
    const finalPrompt = `${subjectDescriptor}, ${structureDeclaration}, ${panelMandate}, ${styleRules}, ${colorRule}`;
    const extraNegative = "portrait, close up, same pose, repetitive, id photo, passport photo, grid lines, text, caption, speech bubble, word, letter, alphabet, watermark, signature, username, ignore user description, generic character, random appearance, wrong character traits, wrong hairstyle, hairstyle mismatch, missing panel, empty panel, incomplete grid, only eight panels, panel without character, single panel, collage, sketch, lineart, monochrome, greyscale, unfinished, rough drawing, outline only, realistic, photorealistic";
    
    btn.disabled = true;
    btnText.textContent = '‚è≥ ÁîüÊàê‰∏≠...';
    statusDiv.style.color = '#666';
    statusDiv.textContent = 'Ê≠£Âú®ÁîüÊàêË°®ÊÉÖÂåÖÔºåËØ∑Á®çÂÄô...';
    document.getElementById('stickerPreviewArea').style.display = 'none';
    
    try {
        const result = await callNovelAIAPI(finalPrompt, '', true, null, {
            skipSystemPrompt: true,
            extraNegativePrompt: extraNegative,
            size: '1024x1024'
        });
        
        if (result.success && result.imageUrl) {
            currentStickerImageUrl = result.imageUrl;
            const previewDiv = document.getElementById('stickerPreview');
            previewDiv.innerHTML = `<img src="${result.imageUrl}" alt="ÁîüÊàêÁöÑË°®ÊÉÖÂåÖ" style="width: 100%; display: block;">`;
            document.getElementById('stickerPreviewArea').style.display = 'block';
            statusDiv.style.color = '#155724';
            statusDiv.textContent = '‚úÖ Ë°®ÊÉÖÂåÖÁîüÊàêÊàêÂäüÔºÅ';
            btnText.textContent = 'üé® ÁîüÊàêË°®ÊÉÖÂåÖ';
        } else {
            statusDiv.style.color = '#721c24';
            statusDiv.textContent = `‚ùå ÁîüÊàêÂ§±Ë¥•Ôºö${result.error || 'Êú™Áü•ÈîôËØØ'}`;
            btnText.textContent = 'üé® ÁîüÊàêË°®ÊÉÖÂåÖ';
        }
    } catch (error) {
        statusDiv.style.color = '#721c24';
        statusDiv.textContent = `‚ùå ÁîüÊàêÂ§±Ë¥•Ôºö${error.message || 'Êú™Áü•ÈîôËØØ'}`;
        btnText.textContent = 'üé® ÁîüÊàêË°®ÊÉÖÂåÖ';
    } finally {
        btn.disabled = false;
    }
}

async function saveSticker() {
    if (!currentStickerImageUrl) { alert('Ê≤°ÊúâÂèØ‰øùÂ≠òÁöÑË°®ÊÉÖÂåÖ'); return; }
    if (!db || !state) {
        alert('Êï∞ÊçÆÂ∫ìÊú™Â∞±Áª™ÔºåËØ∑Á®çÂêéÈáçËØï');
        return;
    }

    const timestamp = new Date().toLocaleString('zh-CN');
    const emojiName = `Ë°®ÊÉÖÂåÖ_${timestamp}`;
    
    const newSticker = {
        id: 'sticker_' + Date.now() + Math.random(),
        url: currentStickerImageUrl,
        name: emojiName,
        categoryId: null
    };

    try {
        await db.userStickers.add(newSticker);
        
        if (state.userStickers) {
            state.userStickers.push(newSticker);
        }
        
        if (typeof renderStickerPanel === 'function') {
            renderStickerPanel();
        }
        
        alert('Ë°®ÊÉÖÂåÖÂ∑≤‰øùÂ≠òÂà∞Ë°®ÊÉÖÂàóË°®ÔºÅ');
    } catch (e) {
        console.error(e);
        alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + e.message);
    }
}

function regenerateSticker() {
    document.getElementById('stickerPreviewArea').style.display = 'none';
    document.getElementById('splitResultArea').style.display = 'none';
    currentStickerImageUrl = null;
    generateSticker();
}

// ========== ÊãÜÂàÜË°®ÊÉÖÂåÖÈÄªËæë ==========
let splitImages = [];

function splitSticker() {
    if (!currentStickerImageUrl) { alert('Ê≤°ÊúâÂèØÊãÜÂàÜÁöÑÂõæÁâá'); return; }
    const splitResultArea = document.getElementById('splitResultArea');
    const splitGrid = document.getElementById('splitGrid');
    const splitCount = document.getElementById('splitCount');
    
    splitResultArea.style.display = 'block';
    splitGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Ê≠£Âú®ÊãÜÂàÜ‰∏≠...</div>';
    
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = currentStickerImageUrl;
    
    img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const width = canvas.width;
        const height = canvas.height;
        
        // 1. ËÉåÊôØÂéªÈô§ (ÈòàÂÄº 240)
        const backgroundThreshold = 240;
        const pixels = [];
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                const i = (y * width + x) * 4;
                const r = data[i], g = data[i+1], b = data[i+2];
                if (r > backgroundThreshold && g > backgroundThreshold && b > backgroundThreshold) {
                    data[i+3] = 0;
                } else {
                    pixels.push({ x, y });
                }
            }
        }
        
        // 2. ËøûÈÄöÂå∫ÂüüÂàÜÊûê
        const visited = new Array(width * height).fill(false);
        const dirs = [[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];
        let persons = [];
        const minPersonSize = 50;
        
        for (const { x, y } of pixels) {
            const idx = y * width + x;
            if (!visited[idx] && data[idx * 4 + 3] > 0) {
                const queue = [[x, y]];
                visited[idx] = true;
                let minX = x, maxX = x, minY = y, maxY = y;
                
                while (queue.length > 0) {
                    const [cx, cy] = queue.shift();
                    for (const [dx, dy] of dirs) {
                        const nx = cx + dx, ny = cy + dy;
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            const nidx = ny * width + nx;
                            if (!visited[nidx] && data[nidx * 4 + 3] > 0) {
                                visited[nidx] = true;
                                queue.push([nx, ny]);
                                minX = Math.min(minX, nx);
                                maxX = Math.max(maxX, nx);
                                minY = Math.min(minY, ny);
                                maxY = Math.max(maxY, ny);
                            }
                        }
                    }
                }
                
                const pWidth = maxX - minX + 1;
                const pHeight = maxY - minY + 1;
                if (pWidth >= minPersonSize && pHeight >= minPersonSize) {
                    persons.push({ minX, maxX, minY, maxY, width: pWidth, height: pHeight });
                }
            }
        }
        
        splitImages = [];
        splitGrid.innerHTML = '';
        splitCount.textContent = `ÂÖ± ${persons.length} ‰∏™`;
        
        if (persons.length === 0) {
            splitGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999;">Êú™ËÉΩËØÜÂà´Âá∫Áã¨Á´ãÁöÑË°®ÊÉÖÂõæÂÉè„ÄÇ</div>';
            return;
        }
        
        persons.forEach((person, index) => {
            const { minX, maxX, minY, maxY, width: pWidth, height: pHeight } = person;
            const tempCanvas = document.createElement('canvas');
            const padding = 10;
            const textHeight = 40;
            tempCanvas.width = pWidth + padding * 2;
            tempCanvas.height = pHeight + padding * 2 + textHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            const personImageData = ctx.getImageData(minX, minY, pWidth, pHeight);
            tempCtx.putImageData(personImageData, padding, padding);
            
            const imgDataUrl = tempCanvas.toDataURL('image/png');
            splitImages.push(imgDataUrl);
            
            const item = document.createElement('div');
            item.style.cssText = 'background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column;';
            item.innerHTML = `
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; background: #f8f8f8; position: relative;">
                    <img src="${imgDataUrl}" id="stickerImg_${index}" style="max-width: 100%; max-height: 120px; object-fit: contain;">
                </div>
                <div style="padding: 5px; background: #fff; border-top: 1px solid #eee;">
                     <input type="text" placeholder="ËæìÂÖ•‰∏≠ÊñáÊ¢óÊñáÂ≠ó" onchange="addTextToSticker(${index}, this.value)" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; text-align: center;">
                </div>
                <button onclick="downloadSingleSplitImage(${index})" style="width: 100%; padding: 8px; border: none; background: #f0f0f0; border-top: 1px solid #eee; color: #333; cursor: pointer; font-size: 12px;">‚¨áÔ∏è ‰∏ãËΩΩ</button>
            `;
            splitGrid.appendChild(item);
        });
    };
    img.onerror = function() {
        splitGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: red;">ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</div>';
    };
}

function addTextToSticker(index, text) {
    if (!text) return;
    const img = new Image();
    img.src = splitImages[index];
    img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        
        // ÊîæÂ§ßÂ≠ó‰ΩìÂå∫Âüü
        const textHeight = 60; // Increased from 40
        ctx.fillStyle = 'rgba(0,0,0,0)';
        ctx.clearRect(0, canvas.height - textHeight, canvas.width, textHeight);
        
        // ÊîæÂ§ßÂ≠ó‰Ωì
        ctx.font = 'bold 36px "Microsoft YaHei", "Heiti SC", sans-serif'; 
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const x = canvas.width / 2;
        const y = canvas.height - textHeight / 2 - 5; 
        
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 4;
        ctx.lineJoin = 'round';
        ctx.strokeText(text, x, y);
        
        ctx.fillStyle = '#000000';
        ctx.fillText(text, x, y);
        
        const newDataUrl = canvas.toDataURL('image/png');
        splitImages[index] = newDataUrl;
        document.getElementById(`stickerImg_${index}`).src = newDataUrl;
    };
}

function downloadSingleSplitImage(index) {
    const dataUrl = splitImages[index];
    if (dataUrl) {
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = `sticker_${index + 1}.png`;
        link.click();
    }
}

function downloadAllSplitStickers() {
    if (splitImages.length === 0) return;
    splitImages.forEach((dataUrl, index) => {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `sticker_${index + 1}.png`;
            link.click();
        }, index * 200);
    });
}

async function saveSplitStickersToMyEmojis() {
    if (splitImages.length === 0) { alert('Ê≤°ÊúâÂèØ‰øùÂ≠òÁöÑË°®ÊÉÖÔºåËØ∑ÂÖàÊãÜÂàÜÔºÅ'); return; }
    
    if (!db || !state) {
        alert('Êï∞ÊçÆÂ∫ìÊú™Â∞±Áª™ÔºåËØ∑Á®çÂêéÈáçËØï');
        return;
    }

    const packNameInput = document.getElementById('stickerPackName');
    const packName = packNameInput.value.trim() || `Ë°®ÊÉÖÂåÖ_${new Date().toLocaleString('zh-CN')}`;
    
    try {
        // 1. Ëá™Âä®ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÂàÜÁ±ª
        const newCategory = {
            name: packName
        };
        // ‰øùÂ≠òÂàÜÁ±ªÂà∞Êï∞ÊçÆÂ∫ìÔºåËé∑ÂèñÊñ∞ ID
        const newCategoryId = await db.stickerCategories.add(newCategory);
        
        // 2. ÂáÜÂ§áË°®ÊÉÖÊï∞ÊçÆÔºåÂÖ≥ËÅîÂà∞Êñ∞ÂàÜÁ±ª ID
        const newStickers = [];
        for (let i = 0; i < splitImages.length; i++) {
             const url = splitImages[i];
             const newSticker = {
                id: 'sticker_' + Date.now() + Math.random(),
                url: url,
                name: `${packName}_${i + 1}`,
                categoryId: newCategoryId // ÂÖ≥ÈîÆÔºö‰ΩøÁî®Êñ∞ÂàõÂª∫ÁöÑÂàÜÁ±ªID
            };
            newStickers.push(newSticker);
        }
        
        // 3. ÊâπÈáè‰øùÂ≠òË°®ÊÉÖÂà∞ IndexedDB
        await db.userStickers.bulkAdd(newStickers);
        
        // 4. Êõ¥Êñ∞ State (Â¶ÇÊûúÂ≠òÂú®)
        if (state.userStickers) {
            state.userStickers.push(...newStickers);
        }
        
        // 5. Ëá™Âä®ÂàáÊç¢Âà∞Êñ∞ÂàÜÁ±ªÂπ∂Âà∑Êñ∞ UI
        if (typeof activeStickerCategoryId !== 'undefined') {
            activeStickerCategoryId = newCategoryId;
        }

        if (typeof renderStickerPanel === 'function') {
            await renderStickerPanel(); // Âà∑Êñ∞Èù¢Êùø
        }
        
        alert(`ÊàêÂäüÂàõÂª∫ÂàÜÁ±ª‚Äú${packName}‚ÄùÂπ∂‰øùÂ≠ò‰∫Ü ${newStickers.length} ‰∏™Ë°®ÊÉÖÔºÅ\nÂ∑≤Ëá™Âä®ÂàáÊç¢Âà∞ËØ•ÂàÜÁ±ª„ÄÇ`);
        
    } catch (error) {
        console.error(error);
        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÊï∞ÊçÆÂ∫ìÈîôËØØ: ' + error.message);
    }
}

  </script>
  <script>
        // ËßÇÂΩ±ÂÆ§ÂäüËÉΩ
        (function() {
            const playerContainer = document.getElementById('movie-player-container');
            const movieIframe = document.getElementById('movie-iframe');
            const movieVideo = document.getElementById('movie-video');
            const closePlayerBtn = document.getElementById('close-player-btn');
            
            // Ëá™ÂÆö‰πâÊí≠ÊîæÊéß‰ª∂
            const customUrlInput = document.getElementById('custom-movie-url');
            const playCustomBtn = document.getElementById('play-custom-url-btn');
            const fileInput = document.getElementById('custom-movie-file');
            const uploadBtn = document.getElementById('upload-movie-btn');

            // Êí≠ÊîæÈÄöÁî®ËßÜÈ¢ë
            function playMovie(url) {
                if (!url) {
                    return;
                }
                
                // ÈöêËóèÊóßÁâàËÖæËÆØËßÜÈ¢ëÁôªÂΩïÊèêÁ§∫
                const loginHint = document.getElementById('login-hint');
                if (loginHint) loginHint.style.display = 'none';
                
                // Âà§Êñ≠URLÁ±ªÂûãÔºöblob URLÔºàÊú¨Âú∞Êñá‰ª∂Ôºâ‰ΩøÁî®videoÊ†áÁ≠æÔºåÂÖ∂‰ªñ‰ΩøÁî®iframe
                const isBlobUrl = url.startsWith('blob:');
                
                if (isBlobUrl) {
                    // Êú¨Âú∞ËßÜÈ¢ëÊñá‰ª∂Ôºö‰ΩøÁî®videoÊ†áÁ≠æ
                    movieIframe.style.display = 'none';
                    movieVideo.src = url;
                    movieVideo.classList.add('active');
                } else {
                    // Âú®Á∫øËßÜÈ¢ëÔºö‰ΩøÁî®iframe
                    movieVideo.classList.remove('active');
                    movieVideo.src = '';
                    movieIframe.style.display = 'block';
                    movieIframe.src = url;
                }
                
                // ÊòæÁ§∫Êí≠ÊîæÂô®
                playerContainer.classList.add('active');
                
                // ÊòæÁ§∫ÂÖ®Â±èÊåâÈíÆ
                const fullscreenBtn = document.getElementById('fullscreen-toggle-btn');
                if (fullscreenBtn) {
                    fullscreenBtn.style.display = 'flex';
                }
                
                // ÊªöÂä®Âà∞Êí≠ÊîæÂô®‰ΩçÁΩÆ
                playerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // ÂÖ≥Èó≠Êí≠ÊîæÂô®
            function closePlayer() {
                playerContainer.classList.remove('active');
                movieIframe.src = '';
                movieVideo.src = '';
                movieVideo.classList.remove('active');
                movieIframe.style.display = 'block';
                
                // Â¶ÇÊûúÂΩìÂâçÂú®ÂÖ®Â±èÊ®°ÂºèÔºå‰πüË¶ÅÈÄÄÂá∫ÂÖ®Â±è
                const movieScreen = document.getElementById('movie-screen');
                if (movieScreen && movieScreen.classList.contains('fullscreen')) {
                    movieScreen.classList.remove('fullscreen');
                    document.body.classList.remove('fullscreen-active');
                }
                
                // ÈöêËóèÂπ∂ÈáçÁΩÆÂÖ®Â±èÊåâÈíÆ
                const fullscreenBtn = document.getElementById('fullscreen-toggle-btn');
                if (fullscreenBtn) {
                    fullscreenBtn.style.display = 'none';
                    const enterIcon = fullscreenBtn.querySelector('.icon-fullscreen-enter');
                    const exitIcon = fullscreenBtn.querySelector('.icon-fullscreen-exit');
                    if (enterIcon) enterIcon.style.display = 'block';
                    if (exitIcon) exitIcon.style.display = 'none';
                    fullscreenBtn.title = 'ÂÖ®Â±è';
                }
            }

            // Á¶ÅÁî®ËßÜÈ¢ëÂÖ®Â±èÂäüËÉΩ
            if (movieVideo) {
                // ÈòªÊ≠¢ÂèåÂáªÂÖ®Â±è
                movieVideo.addEventListener('dblclick', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });
                
                // ÈòªÊ≠¢Âè≥ÈîÆËèúÂçï‰∏≠ÁöÑÂÖ®Â±èÈÄâÈ°π
                movieVideo.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // ÁõëÂê¨ÂÖ®Â±èËØ∑Ê±ÇÂπ∂ÈòªÊ≠¢
                movieVideo.addEventListener('webkitbeginfullscreen', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                movieVideo.addEventListener('webkitendfullscreen', function(e) {
                    e.preventDefault();
                    return false;
                });
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂
            if (closePlayerBtn) {
                closePlayerBtn.addEventListener('click', closePlayer);
            }

            // Êñ∞Â¢ûÔºöÁªëÂÆöËá™ÂÆö‰πâÊí≠Êîæ‰∫ã‰ª∂
            if (playCustomBtn) {
                playCustomBtn.addEventListener('click', function() {
                    const url = customUrlInput.value.trim();
                    if (url) {
                        playMovie(url);
                    } else {
                        alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑËßÜÈ¢ëÈìæÊé•');
                    }
                });
            }

            if (uploadBtn) {
                uploadBtn.addEventListener('click', function() {
                    if (fileInput) fileInput.click();
                });
            }

            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const url = URL.createObjectURL(file);
                        playMovie(url);
                        // Ê∏ÖÁ©∫ÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©
                        fileInput.value = '';
                    }
                });
            }

            // ÂÖ®Â±èÂàáÊç¢ÂäüËÉΩ
            const fullscreenBtn = document.getElementById('fullscreen-toggle-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', function() {
                    const movieScreen = document.getElementById('movie-screen');
                    if (!movieScreen) return;
                    
                    if (movieScreen.classList.contains('fullscreen')) {
                        // ÈÄÄÂá∫ÂÖ®Â±è
                        movieScreen.classList.remove('fullscreen');
                        document.body.classList.remove('fullscreen-active');
                        const enterIcon = fullscreenBtn.querySelector('.icon-fullscreen-enter');
                        const exitIcon = fullscreenBtn.querySelector('.icon-fullscreen-exit');
                        if (enterIcon) enterIcon.style.display = 'block';
                        if (exitIcon) exitIcon.style.display = 'none';
                        fullscreenBtn.title = 'ÂÖ®Â±è';
                    } else {
                        // ËøõÂÖ•ÂÖ®Â±è
                        movieScreen.classList.add('fullscreen');
                        document.body.classList.add('fullscreen-active');
                        const enterIcon = fullscreenBtn.querySelector('.icon-fullscreen-enter');
                        const exitIcon = fullscreenBtn.querySelector('.icon-fullscreen-exit');
                        if (enterIcon) enterIcon.style.display = 'none';
                        if (exitIcon) exitIcon.style.display = 'block';
                        fullscreenBtn.title = 'ÈÄÄÂá∫ÂÖ®Â±è';
                    }
                });
            }

            // ËßíËâ≤ÂàóË°®ÂíåËßíËâ≤‰ø°ÊÅØÂ≠òÂÇ®
            let characterList = [];
            let characterProfiles = {};
            const aiWatchCharacter = document.getElementById('ai-watch-character');

            // Âä†ËΩΩÁúüÂÆûËßíËâ≤ÂàóË°®ÔºàÊåâÁÖßÁÉ¶.htmlÁöÑÊñπÂºèÔºâ
            async function loadRealCharacterList() {
                try {
                    if (!aiWatchCharacter) {
                        console.warn('ËßÇÂΩ±ÂÆ§ËßíËâ≤ÈÄâÊã©Âô®Êú™ÊâæÂà∞');
                        return;
                    }

                    // Á≠âÂæÖ state Âä†ËΩΩ
                    let retry = 0;
                    while ((!window.state || !window.state.chats) && retry < 20) {
                        await new Promise(r => setTimeout(r, 100));
                        retry++;
                    }

                    if (!window.state || !window.state.chats) {
                        console.warn('stateÂØπË±°Êú™Âä†ËΩΩ');
                        aiWatchCharacter.innerHTML = '<option value="">ËØ∑Á≠âÂæÖÊï∞ÊçÆÂä†ËΩΩ...</option>';
                        return;
                    }

                    const chats = Object.values(window.state.chats).filter(c => c && !c.isGroup);
                    
                    console.log('ÊâæÂà∞ËßíËâ≤Êï∞Èáè:', chats.length);
                    
                    if (chats.length === 0) {
                        aiWatchCharacter.innerHTML = '<option value="">ÊöÇÊó†ËßíËâ≤ÔºåËØ∑ÂÖàÂú®ËÅäÂ§©È°µÈù¢ÂàõÂª∫ËßíËâ≤</option>';
                        return;
                    }

                    aiWatchCharacter.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Èô™ÁúãËßíËâ≤...</option>';
                    chats.forEach(chat => {
                        const option = document.createElement('option');
                        option.value = chat.id;
                        const name = chat.name || chat.originalName || 'Êú™ÂëΩÂêçËßíËâ≤';
                        option.textContent = name;
                        aiWatchCharacter.appendChild(option);
                    });

                    // Â¶ÇÊûú‰πãÂâçÊúâÈÄâ‰∏≠ÁöÑÔºåÂ∞ùËØïÊÅ¢Â§ç
                    if (window.state && window.state.activeChatId && chats.some(c => c.id === window.state.activeChatId)) {
                        aiWatchCharacter.value = window.state.activeChatId;
                    } else if (chats.length > 0) {
                        // ÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™
                        aiWatchCharacter.value = chats[0].id;
                    }
                    
                    // Êõ¥Êñ∞ËßíËâ≤ÊèèËø∞
                    updateCharacterDescription();
                    
                    console.log(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${chats.length} ‰∏™ËßíËâ≤`);
                } catch (e) {
                    console.error('‚ùå Âä†ËΩΩËßíËâ≤ÂàóË°®Â§±Ë¥•', e);
                    if (aiWatchCharacter) {
                        aiWatchCharacter.innerHTML = '<option value="">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢</option>';
                    }
                }
            }

            // Êõ¥Êñ∞ËßíËâ≤ÊèèËø∞
            function updateCharacterDescription() {
                const descEl = document.getElementById('character-description');
                const openBtn = document.getElementById('open-character-window-btn');
                if (!aiWatchCharacter) return;
                
                const selectedCharId = aiWatchCharacter.value;
                if (!selectedCharId) {
                    if (descEl) descEl.style.display = 'none';
                    if (openBtn) openBtn.style.display = 'none';
                    return;
                }

                // ‰ªéstate.chats‰∏≠Ëé∑ÂèñËßíËâ≤‰ø°ÊÅØ
                if (window.state && window.state.chats && window.state.chats[selectedCharId]) {
                    const chat = window.state.chats[selectedCharId];
                    const persona = (chat.settings && chat.settings.aiPersona) || '';
                    const description = persona 
                        ? (persona.length > 60 ? persona.substring(0, 60) + '...' : persona)
                        : `${chat.name || chat.originalName || 'ËßíËâ≤'}ÔºàÊù•Ëá™ËÅäÂ§©È°µÈù¢Ôºâ`;
                    if (descEl) {
                        descEl.textContent = description;
                        descEl.style.display = 'block';
                    }
                    // ÊòæÁ§∫ÊâìÂºÄËßíËâ≤Â∞èÁ™óÊåâÈíÆ
                    if (openBtn) {
                        openBtn.style.display = 'block';
                    }
                } else {
                    if (descEl) descEl.style.display = 'none';
                    if (openBtn) openBtn.style.display = 'none';
                }
            }

            // ÁõëÂê¨ËßíËâ≤ÈÄâÊã©ÂèòÂåñ
            if (aiWatchCharacter) {
                aiWatchCharacter.addEventListener('change', updateCharacterDescription);
            }
            
            // ÁªëÂÆöÊâìÂºÄËßíËâ≤Â∞èÁ™óÊåâÈíÆ‰∫ã‰ª∂
            const openCharacterWindowBtn = document.getElementById('open-character-window-btn');
            if (openCharacterWindowBtn) {
                openCharacterWindowBtn.addEventListener('click', function() {
                    const selectedCharId = aiWatchCharacter ? aiWatchCharacter.value : null;
                    if (selectedCharId && typeof window.switchToCharacterPhone === 'function') {
                        window.switchToCharacterPhone(selectedCharId);
                    } else if (selectedCharId) {
                        console.warn('switchToCharacterPhoneÂáΩÊï∞Êú™ÊâæÂà∞ÔºåËØ∑Á°Æ‰øùÂ∑≤Âä†ËΩΩËßíËâ≤ÊâãÊú∫ÂäüËÉΩ');
                    } else {
                        console.warn('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËßíËâ≤');
                    }
                });
            }

            // Â∞ÜloadRealCharacterListÊö¥Èú≤Âà∞windowÂØπË±°Ôºå‰ª•‰æøÂ§ñÈÉ®Ë∞ÉÁî®
            window.loadCharacterList = loadRealCharacterList;

            // ÁõëÂê¨ËøõÂÖ•ËßÇÂΩ±ÂÆ§Ôºà‰ΩøÁî®MutationObserverÔºåÊåâÁÖßÁÉ¶.htmlÁöÑÊñπÂºèÔºâ
            const movieScreen = document.getElementById('movie-screen');
            if (movieScreen) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (movieScreen.classList.contains('active')) {
                                console.log('Ê£ÄÊµãÂà∞ËøõÂÖ•ËßÇÂΩ±ÂÆ§ÔºåÂä†ËΩΩËßíËâ≤ÂàóË°®...');
                                loadRealCharacterList();
                            }
                        }
                    });
                });
                observer.observe(movieScreen, { attributes: true });
            }
        })();
  </script>
<script>
    // ÊÇ¨ÊµÆËÅäÂ§©Á™óÂè£ÂäüËÉΩ
    (function() {
        let floatingBtn = null;
        let isDraggingBtn = false;
        let btnDragStartX, btnDragStartY, btnStartX, btnStartY;
        const chatScreen = document.getElementById('chat-interface-screen');
        const characterSelector = document.getElementById('ai-watch-character');
        
        // Êö¥Èú≤ÁªôÂÖ®Â±Ä
        window.toggleFloatingChat = toggleFloatingChat;
        window.minimizeFloatingChat = minimizeFloatingChat;
        window.restoreFloatingChat = restoreFloatingChat;

        function createFloatingChatButton() {
            if (document.getElementById('floating-chat-toggle-btn')) {
                return document.getElementById('floating-chat-toggle-btn');
            }
            
            floatingBtn = document.createElement('div');
            floatingBtn.id = 'floating-chat-toggle-btn';
            floatingBtn.innerHTML = '<i class="fas fa-comment-dots" style="font-style: normal;">üí¨</i>'; // ‰ΩøÁî®emoji‰Ωú‰∏∫ÂõæÊ†á
            floatingBtn.title = 'ÊâìÂºÄÊÇ¨ÊµÆËÅäÂ§©';
            
            // ÂàùÂßã‰ΩçÁΩÆ
            floatingBtn.style.top = '100px';
            floatingBtn.style.right = '20px';
            
            // Ê∑ªÂä†Â∞èÁ∫¢ÁÇπÔºàÊú™ËØªÊ∂àÊÅØÊèêÁ§∫Ôºâ
            const badge = document.createElement('div');
            badge.id = 'floating-chat-badge';
            badge.style.display = 'none';
            badge.innerText = '0';
            floatingBtn.appendChild(badge);
            
            document.body.appendChild(floatingBtn);
            
            // ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
            floatingBtn.addEventListener('click', function(e) {
                if (isDraggingBtn) {
                    console.log('ÊãñÊãΩÁªìÊùüËß¶ÂèëÁÇπÂáªÔºåÂøΩÁï•');
                    return;
                }
                console.log('ÊÇ¨ÊµÆÊåâÈíÆË¢´ÁÇπÂáªÔºåÂàáÊç¢ËÅäÂ§©Á™óÂè£');
                toggleFloatingChat();
            });
            
            // Ê∑ªÂä†ÊãñÊãΩÂäüËÉΩ
            floatingBtn.addEventListener('mousedown', startBtnDrag);
            floatingBtn.addEventListener('touchstart', startBtnDrag, { passive: false });
            
            console.log('‚úÖ ÊÇ¨ÊµÆËÅäÂ§©ÊåâÈíÆÂàõÂª∫ÂÆåÊàê');
            return floatingBtn;
        }

        function startBtnDrag(e) {
            // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÂíåÂÜíÊ≥°
            if (e.type === 'mousedown') e.preventDefault();
            // e.stopPropagation();
            
            const touch = e.type === 'touchstart' ? e.touches[0] : e;
            btnDragStartX = touch.clientX;
            btnDragStartY = touch.clientY;
            
            const rect = floatingBtn.getBoundingClientRect();
            btnStartX = rect.left;
            btnStartY = rect.top;
            
            // Ê†áËÆ∞‰∏∫ÂèØËÉΩÊãñÊãΩ
            isDraggingBtn = false; 
            
            floatingBtn.classList.add('dragging');
            
            // ÁõëÂê¨ÁßªÂä®ÂíåÁªìÊùü‰∫ã‰ª∂
            document.addEventListener('mousemove', onBtnDrag, { capture: true });
            document.addEventListener('touchmove', onBtnDrag, { passive: false, capture: true });
            document.addEventListener('mouseup', stopBtnDrag, { capture: true });
            document.addEventListener('touchend', stopBtnDrag, { capture: true });
        }

        function onBtnDrag(e) {
            const touch = e.type === 'touchmove' ? e.touches[0] : e;
            const currentX = touch.clientX;
            const currentY = touch.clientY;
            
            const deltaX = currentX - btnDragStartX;
            const deltaY = currentY - btnDragStartY;
            
            // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøá5pxÔºåËÆ§‰∏∫ÊòØÊãñÊãΩ
            if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                isDraggingBtn = true;
                // ÊãñÊãΩÊó∂Á¶ÅÁî®ËøáÊ∏°Âä®Áîª
                floatingBtn.style.transition = 'none';
            }
            
            if (isDraggingBtn) {
                if (e.cancelable) e.preventDefault();
                e.stopPropagation();

                let newX = btnStartX + deltaX;
                let newY = btnStartY + deltaY;
                
                // ËæπÁïåÈôêÂà∂
                const maxX = window.innerWidth - floatingBtn.offsetWidth;
                const maxY = window.innerHeight - floatingBtn.offsetHeight;
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                // ÂÖàÊ∏ÖÈô§rightÂíåbottom
                floatingBtn.style.right = 'auto';
                floatingBtn.style.bottom = 'auto';
                // ÂÜçËÆæÁΩÆleftÂíåtop
                floatingBtn.style.left = newX + 'px';
                floatingBtn.style.top = newY + 'px';
            }
        }

        function stopBtnDrag(e) {
            floatingBtn.classList.remove('dragging');
            
            // ÊÅ¢Â§çËøáÊ∏°Âä®Áîª
            floatingBtn.style.transition = 'transform 0.2s, box-shadow 0.2s';
            
            // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨
            document.removeEventListener('mousemove', onBtnDrag, { capture: true });
            document.removeEventListener('touchmove', onBtnDrag, { capture: true });
            document.removeEventListener('mouseup', stopBtnDrag, { capture: true });
            document.removeEventListener('touchend', stopBtnDrag, { capture: true });
            
            // Âª∂ËøüÈáçÁΩÆisDraggingBtnÔºåÈò≤Ê≠¢Ëß¶Âèëclick
            setTimeout(() => {
                isDraggingBtn = false;
            }, 50);
        }

        function toggleFloatingChat() {
            // Á°Æ‰øùÊÇ¨ÊµÆÊåâÈíÆÂ≠òÂú®
            if (!floatingBtn) {
                floatingBtn = createFloatingChatButton();
            }
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            if (chatScreen.classList.contains('active') && chatScreen.classList.contains('floating-chat-window')) {
                // ËÅäÂ§©Á™óÂè£Â∞ÜÂÖ≥Èó≠ÔºåÁßªÈô§chat-openÁä∂ÊÄÅ
                floatingBtn.classList.remove('chat-open');
            } else {
                // ËÅäÂ§©Á™óÂè£Â∞ÜÊâìÂºÄÔºåÊ∑ªÂä†chat-openÁä∂ÊÄÅ
                floatingBtn.classList.add('chat-open');
            }
            
            if (chatScreen.classList.contains('active') && chatScreen.classList.contains('floating-chat-window')) {
                // ÂÖ≥Èó≠ÊÇ¨ÊµÆËÅäÂ§©
                chatScreen.classList.remove('active');
                chatScreen.classList.remove('floating-chat-window');
                chatScreen.classList.remove('minimized');
                chatScreen.style.display = 'none';
                
                const closeBtn = document.getElementById('floating-chat-close-btn');
                if (closeBtn) closeBtn.remove();
                
                const minimizeBtn = document.getElementById('floating-chat-minimize-btn');
                if (minimizeBtn) minimizeBtn.remove();
                
                const minBtn = document.getElementById('floating-chat-mini-btn');
                if (minBtn) minBtn.remove();
                
            } else {
                // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑËßíËâ≤
                const selectedChatId = characterSelector ? characterSelector.value : null;
                if (!selectedChatId) {
                    alert('ËØ∑ÂÖàÂú®‰∏ãÊñπÈÄâÊã©‰∏Ä‰∏™Èô™ÁúãËßíËâ≤');
                    return;
                }

                // ÂàáÊç¢Âà∞ÈÄâ‰∏≠ÁöÑËßíËâ≤ËÅäÂ§©
                if (window.state) window.state.activeChatId = selectedChatId;
                if (typeof renderChatInterface === 'function') {
                    renderChatInterface(selectedChatId);
                } else if (window.renderChatInterface) {
                    window.renderChatInterface(selectedChatId);
                }

                // ÊâìÂºÄÊÇ¨ÊµÆËÅäÂ§©
                chatScreen.classList.add('active');
                chatScreen.classList.add('floating-chat-window');
                chatScreen.style.display = 'flex';
                chatScreen.style.zIndex = '9999';
                
                // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆ
                if (!document.getElementById('floating-chat-close-btn')) {
                    const closeBtn = document.createElement('div');
                    closeBtn.id = 'floating-chat-close-btn';
                    closeBtn.innerHTML = '√ó';
                    closeBtn.title = 'ÂÖ≥Èó≠';
                    closeBtn.style.cssText = 'position:absolute; top:5px; left:10px; font-size:24px; cursor:pointer; z-index:10002; color:var(--text-primary); font-weight:bold; width:30px; height:30px; text-align:center; line-height:30px; user-select:none; pointer-events:auto;';
                    
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÈòªÊ≠¢ÂÜíÊ≥°
                    closeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        toggleFloatingChat();
                    });
                    
                    chatScreen.appendChild(closeBtn);
                }
                
                // Ê∑ªÂä†ÊúÄÂ∞èÂåñÊåâÈíÆ
                if (!document.getElementById('floating-chat-minimize-btn')) {
                    const minimizeBtn = document.createElement('div');
                    minimizeBtn.id = 'floating-chat-minimize-btn';
                    minimizeBtn.innerHTML = '‚àí';
                    minimizeBtn.title = 'ÊúÄÂ∞èÂåñ';
                    // Ê†∑ÂºèÂ∑≤Âú®CSS‰∏≠ÂÆö‰πâÔºåËøôÈáåÂè™Ë°•ÂÖÖÂøÖË¶ÅÁöÑ
                    
                    minimizeBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); 
                        e.preventDefault(); 
                        minimizeFloatingChat();
                    });
                    
                    minimizeBtn.addEventListener('touchend', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        minimizeFloatingChat();
                    });
                    
                    chatScreen.appendChild(minimizeBtn);
                }
                
                // ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
                initDraggable();
            }
        }

        function minimizeFloatingChat() {
            // Ê∑ªÂä†ÊúÄÂ∞èÂåñÁä∂ÊÄÅ
            chatScreen.classList.add('minimized');
            
            // ÂàõÂª∫ÊàñËé∑ÂèñÊÇ¨ÊµÆÂ∞èÊåâÈíÆ
            let minBtn = document.getElementById('floating-chat-mini-btn');
            if (!minBtn) {
                minBtn = document.createElement('div'); // ‰ΩøÁî®divÊ®°ÊãüÊåâÈíÆ
                minBtn.id = 'floating-chat-mini-btn';
                minBtn.innerHTML = '<i class="fas fa-comment-dots" style="font-style: normal;">üí¨</i>';
                minBtn.onclick = restoreFloatingChat;
                
                document.body.appendChild(minBtn);
            }
            
            // Ëé∑ÂèñÁ™óÂè£ÂΩìÂâç‰ΩçÁΩÆ
            const rect = chatScreen.getBoundingClientRect();
            // ËÆ°ÁÆóÊÇ¨ÊµÆÁêÉ‰ΩçÁΩÆÔºàÊîæÂú®Á™óÂè£Âè≥‰∏äËßíÔºâ
            const btnLeft = rect.left + rect.width - 56;
            const btnTop = rect.top;
            
            minBtn.style.left = btnLeft + 'px';
            minBtn.style.top = btnTop + 'px';
            minBtn.style.display = 'flex';
        }

        function restoreFloatingChat() {
            const minBtn = document.getElementById('floating-chat-mini-btn');
            if (minBtn) {
                // Ëé∑ÂèñÊÇ¨ÊµÆÁêÉ‰ΩçÁΩÆ
                const rect = minBtn.getBoundingClientRect();
                
                // Â∞ÜÁ™óÂè£‰ΩçÁΩÆËÆæÁΩÆ‰∏∫ÊÇ¨ÊµÆÁêÉ‰ΩçÁΩÆ
                chatScreen.style.left = rect.left + 'px';
                chatScreen.style.top = rect.top + 'px';
                chatScreen.style.right = 'auto';
                chatScreen.style.bottom = 'auto';
                
                minBtn.style.display = 'none';
            }
            
            chatScreen.classList.remove('minimized');
        }

        // Á™óÂè£ÊãñÊãΩÂäüËÉΩ
        let isWindowDragging = false;
        let winDragStartX, winDragStartY, winStartX, winStartY;

        function initDraggable() {
            const header = chatScreen.querySelector('.header');
            if (!header) return;

            header.addEventListener('mousedown', startWindowDrag);
            header.addEventListener('touchstart', startWindowDrag, { passive: false });
        }

        function startWindowDrag(e) {
            const target = e.target;
            if (target.id === 'floating-chat-close-btn' || 
                target.id === 'floating-chat-minimize-btn' ||
                target.closest('#floating-chat-close-btn') ||
                target.closest('#floating-chat-minimize-btn')) {
                return;
            }

            isWindowDragging = true;
            const touch = e.type === 'touchstart' ? e.touches[0] : e;
            winDragStartX = touch.clientX;
            winDragStartY = touch.clientY;

            const rect = chatScreen.getBoundingClientRect();
            winStartX = rect.left;
            winStartY = rect.top;

            document.addEventListener('mousemove', onWindowDrag);
            document.addEventListener('touchmove', onWindowDrag, { passive: false });
            document.addEventListener('mouseup', stopWindowDrag);
            document.addEventListener('touchend', stopWindowDrag);
            
            if (e.type !== 'touchstart') e.preventDefault();
        }

        function onWindowDrag(e) {
            if (!isWindowDragging) return;
            if (e.cancelable) e.preventDefault();

            const touch = e.type === 'touchmove' ? e.touches[0] : e;
            const deltaX = touch.clientX - winDragStartX;
            const deltaY = touch.clientY - winDragStartY;

            let newX = winStartX + deltaX;
            let newY = winStartY + deltaY;

            // ÁÆÄÂçïËæπÁïåÊ£ÄÊü•
            const maxX = window.innerWidth - 50;
            const maxY = window.innerHeight - 50;

            newX = Math.max(-200, Math.min(newX, maxX));
            newY = Math.max(0, Math.min(newY, maxY));

            chatScreen.style.left = newX + 'px';
            chatScreen.style.top = newY + 'px';
            chatScreen.style.right = 'auto';
            chatScreen.style.bottom = 'auto';
        }

        function stopWindowDrag() {
            isWindowDragging = false;
            document.removeEventListener('mousemove', onWindowDrag);
            document.removeEventListener('touchmove', onWindowDrag);
            document.removeEventListener('mouseup', stopWindowDrag);
            document.removeEventListener('touchend', stopWindowDrag);
        }

        // ‰øÆÊîπ open-character-window-btn ÁöÑÁÇπÂáª‰∫ã‰ª∂
        const openBtn = document.getElementById('open-character-window-btn');
        if (openBtn) {
            // ÊõøÊç¢ÂÖÉÁ¥†Êù•Ê∏ÖÈô§ÊóßÁöÑÁõëÂê¨Âô®
            const newOpenBtn = openBtn.cloneNode(true);
            openBtn.parentNode.replaceChild(newOpenBtn, openBtn);
            
            newOpenBtn.addEventListener('click', function() {
                toggleFloatingChat();
            });
        }

        // ÁõëÂê¨ËøõÂÖ•ËßÇÂΩ±ÂÆ§
        const movieScreen = document.getElementById('movie-screen');
        if (movieScreen) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (movieScreen.classList.contains('active')) {
                            createFloatingChatButton();
                            if (floatingBtn) floatingBtn.style.display = 'flex';
                        } else {
                            if (floatingBtn) floatingBtn.style.display = 'none';
                            // Á¶ªÂºÄÊó∂ÂÖ≥Èó≠ÊÇ¨ÊµÆÁ™ó
                            if (chatScreen.classList.contains('floating-chat-window')) {
                                toggleFloatingChat(); 
                            }
                        }
                    }
                });
            });
            observer.observe(movieScreen, { attributes: true });
        }
        
        // ========== ËßÜÈ¢ëÊà™ÂèñÂíå‰∏ä‰∏ãÊñáËé∑ÂèñÂäüËÉΩ ==========
        let isPaused = false;
        let currentVideoTitle = 'ÂΩìÂâçËßÜÈ¢ë';
        
        // Êà™ÂèñËßÜÈ¢ëÁîªÈù¢
        function captureFrame() {
            try {
                const movieVideo = document.getElementById('movie-video');
                // 1. Â∞ùËØï‰ªé video Ê†áÁ≠æÊà™Âõæ
                if (movieVideo && !movieVideo.paused && movieVideo.readyState >= 2) {
                    const canvas = document.createElement('canvas');
                    // ÈôêÂà∂Â∞∫ÂØ∏‰ª•ÂáèÂ∞ë Token Ê∂àËÄóÂíå‰º†ËæìÂª∂Ëøü
                    canvas.width = 480; 
                    const ratio = movieVideo.videoHeight / movieVideo.videoWidth;
                    canvas.height = canvas.width * ratio;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(movieVideo, 0, 0, canvas.width, canvas.height);
                    
                    // ËΩ¨Êç¢‰∏∫ Base64 (JPEG Ê†ºÂºè, 0.7 Ë¥®Èáè)
                    return canvas.toDataURL('image/jpeg', 0.7);
                }
                
                // 2. Â¶ÇÊûúÊòØ iframeÔºåÊöÇÊó∂Êó†Ê≥ïÊà™ÂõæÔºàË∑®ÂüüÈôêÂà∂ÔºâÔºåËøîÂõû null
                return null;
            } catch (e) {
                console.error('Êà™ÂõæÂ§±Ë¥•:', e);
                return null;
            }
        }
        
        // Ëé∑ÂèñËßÜÈ¢ë‰∏ä‰∏ãÊñá‰ø°ÊÅØ
        function getContext() {
            const movieVideo = document.getElementById('movie-video');
            // Ëé∑ÂèñËßÜÈ¢ëÊ†áÈ¢ò
            let title = currentVideoTitle;
            const activeCard = document.querySelector('.movie-card:active, .movie-card:hover');
            if (activeCard) title = activeCard.querySelector('.movie-title')?.textContent.trim() || title;
            
            return {
                title: title,
                isPaused: isPaused,
                currentTime: movieVideo ? movieVideo.currentTime : 0
            };
        }
        
        // ÂàùÂßãÂåñËßÜÈ¢ë‰∫ã‰ª∂ÁõëÂê¨
        function initVideoEventListeners() {
            const movieVideo = document.getElementById('movie-video');
            if (movieVideo) {
                movieVideo.addEventListener('pause', () => isPaused = true);
                movieVideo.addEventListener('play', () => isPaused = false);
            }
        }
        
        // Â∞Ü‰∏ä‰∏ãÊñáÊö¥Èú≤ÁªôÂÖ®Â±Ä window ÂØπË±°
        window.screeningRoomContext = {
            isWatching: false,
            toggleFloatingChat: toggleFloatingChat,
            getContext: getContext,
            captureFrame: captureFrame
        };
        
        // ‰øÆÊîπ toggleFloatingChat ‰ª•ËÆæÁΩÆ isWatching Áä∂ÊÄÅ
        const originalToggleFloatingChat = toggleFloatingChat;
        toggleFloatingChat = function() {
            const willBeOpen = !chatScreen.classList.contains('active') || !chatScreen.classList.contains('floating-chat-window');
            originalToggleFloatingChat();
            
            if (willBeOpen) {
                window.screeningRoomContext.isWatching = true;
                initVideoEventListeners();
            } else {
                window.screeningRoomContext.isWatching = false;
            }
        };
        
        // Êõ¥Êñ∞ÂÖ®Â±ÄÂºïÁî®
        window.screeningRoomContext.toggleFloatingChat = toggleFloatingChat;
    })();
  </script>
</body>
</html>






































